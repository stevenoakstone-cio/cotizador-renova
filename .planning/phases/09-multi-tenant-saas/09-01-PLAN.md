---
phase: 09-multi-tenant-saas
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: true
requirements: [MTNT-01]

must_haves:
  truths:
    - "On first launch with no APP_CONFIG in localStorage, a setup screen appears before the main app"
    - "User can enter company name, monogram, tagline, Supabase URL, Supabase anon key, and upload a logo"
    - "After saving setup, APP_CONFIG is persisted in localStorage and the app loads normally"
    - "On subsequent launches, the setup screen is skipped and APP_CONFIG values override CONFIG defaults"
    - "CONFIG.brand and CONFIG.supabase values are dynamically replaced by APP_CONFIG values at boot"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "APP_CONFIG localStorage persistence, first-run setup screen, CONFIG override logic"
      contains: "APP_CONFIG"
  key_links:
    - from: "setup screen save button"
      to: "localStorage APP_CONFIG"
      via: "JSON.stringify + localStorage.setItem"
      pattern: "localStorage\\.setItem.*APP_CONFIG"
    - from: "APP_CONFIG load on boot"
      to: "CONFIG.brand and CONFIG.supabase"
      via: "Object.assign or property copy at init"
      pattern: "CONFIG\\.brand\\.name.*=.*appConfig"
---

<objective>
Create the APP_CONFIG system and first-run setup screen so the app can be deployed for any carpinteria without code changes.

Purpose: This is the foundation of multi-tenant SaaS — each client gets their own branding and Supabase instance configured at runtime via a setup wizard, persisted in localStorage.
Output: APP_CONFIG localStorage layer + setup screen UI
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@cotizador-template/cotizador-template.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: APP_CONFIG localStorage layer and CONFIG override at boot</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Add an APP_CONFIG system that persists tenant configuration in localStorage and overrides the hardcoded CONFIG values at boot time.

1. Right after the CONFIG object declaration (~line 3056), add a function `loadAppConfig()` that:
   - Reads `localStorage.getItem('cot_app_config')` (using CONFIG.storage.prefix + 'app_config')
   - If found, parses JSON into an `appConfig` object
   - Overrides CONFIG.brand fields: name, mono, tagline, legalTerms (only if present in appConfig)
   - Overrides CONFIG.contact fields: name, city, office, cell, email (only if present in appConfig)
   - Overrides CONFIG.supabase fields: url, key (only if present in appConfig)
   - Returns the parsed appConfig or null if not found

2. Add a function `saveAppConfig(data)` that:
   - Takes an object with keys: companyName, monogram, tagline, supabaseUrl, supabaseKey, contactName, contactCity, contactOffice, contactCell, contactEmail
   - Saves to localStorage as JSON under 'cot_app_config' key
   - Calls loadAppConfig() to apply immediately
   - Returns true

3. Add a function `hasAppConfig()` that returns true if localStorage has 'cot_app_config'

4. Call `loadAppConfig()` immediately after its declaration (before the BRANDS initialization at ~line 4421) so CONFIG values are overridden before any code reads them

5. The APP_CONFIG structure in localStorage should be:
```json
{
  "companyName": "Mi Carpinteria",
  "monogram": "MC",
  "tagline": "Muebles Premium",
  "supabaseUrl": "https://xxx.supabase.co",
  "supabaseKey": "eyJ...",
  "contactName": "Mi Carpinteria",
  "contactCity": "Ciudad",
  "contactOffice": "00 0000-0000",
  "contactCell": "00 0000-0000",
  "contactEmail": "info@micarpinteria.com",
  "logoBase64": "data:image/png;base64,..."
}
```

6. In loadAppConfig(), if appConfig.logoBase64 exists, save it to localStorage under the existing logo key (CONFIG.storage.prefix + 'logo_base64') so the existing S.logoBase64 pickup works without changes.

7. Expose saveAppConfig, hasAppConfig, and loadAppConfig on the APP object so the setup screen and future code can call them.
  </action>
  <verify>
Open the HTML in a browser. In the console, run:
- `APP.hasAppConfig()` should return false (no config yet)
- `APP.saveAppConfig({companyName:'Test', monogram:'TS'})` should return true
- Refresh the page. `CONFIG.brand.name` should be 'Test' and `CONFIG.brand.mono` should be 'TS'
- `APP.hasAppConfig()` should return true
- Clear localStorage and refresh — CONFIG.brand.name should be back to 'Renova'
  </verify>
  <done>APP_CONFIG persists in localStorage, overrides CONFIG.brand/contact/supabase on boot, and survives page refresh</done>
</task>

<task type="auto">
  <name>Task 2: First-run setup screen UI</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Create a setup screen that appears on first launch (when hasAppConfig() returns false).

1. Add a function `showSetupScreen()` that creates a full-screen overlay (z-index: 10000) matching the dark theme (#0d0d0d background, #c49a6c gold accent). The screen should contain:
   - Title: "Configuracion Inicial" with gold text
   - Subtitle: "Configure su instancia del cotizador"
   - Form fields (styled with dark input fields, gold borders on focus):
     * Empresa (text, required) — maps to companyName
     * Monograma (text, 2-4 chars, required) — maps to monogram
     * Lema (text, optional) — maps to tagline, placeholder "Muebles a la Medida"
     * Logo (file input, accepts image/*, optional) — reads as base64 via FileReader
     * Section divider: "Conexion Cloud (Supabase)"
     * URL de Supabase (text, optional) — maps to supabaseUrl, placeholder "https://xxx.supabase.co"
     * Anon Key (text, optional) — maps to supabaseKey, placeholder "eyJ..."
     * Section divider: "Datos de Contacto"
     * Nombre de contacto (text, optional) — maps to contactName
     * Ciudad (text, optional) — maps to contactCity
     * Telefono oficina (text, optional) — maps to contactOffice
     * Celular (text, optional) — maps to contactCell
     * Email (email, optional) — maps to contactEmail
   - "Guardar y Comenzar" button (gold background, dark text, full width)
   - Small text: "Puede modificar estos datos despues en Configuracion"

2. On submit:
   - Validate required fields (empresa, monograma)
   - If logo file selected, read as base64 first
   - Call APP.saveAppConfig() with the form data
   - Remove the overlay
   - Reload the page (location.reload()) so all CONFIG overrides take effect cleanly

3. In the boot/init section of the app (near the end where `document.title` is set, ~line 13798), add a check:
   - If `!hasAppConfig()`, call `showSetupScreen()` and return early (do not render the main app)
   - This prevents the main app from loading until setup is complete

4. Style notes:
   - Dark inputs: background #1a1a2e, border 1px solid #333, color #e0e0e0, border-radius 8px, padding 10px
   - On focus: border-color #c49a6c
   - Section dividers: gold text, small font, uppercase, margin-top 20px
   - Form max-width: 480px, centered on screen
   - Logo preview: small thumbnail (60px height) shown when file selected
  </action>
  <verify>
1. Clear localStorage completely
2. Open the HTML — the setup screen should appear instead of the main app
3. Fill in "Mi Empresa" for company name, "ME" for monogram
4. Click "Guardar y Comenzar"
5. The page should reload and show the main app with "Mi Empresa" as the brand name
6. Refresh again — main app loads directly (no setup screen)
  </verify>
  <done>First-run setup screen appears when no APP_CONFIG exists, collects company info and Supabase credentials, saves to APP_CONFIG, and subsequent launches skip directly to the main app</done>
</task>

</tasks>

<verification>
1. Delete localStorage key 'cot_app_config' — setup screen appears
2. Complete setup with custom company name — app shows custom brand
3. Refresh — app loads directly with custom brand (no setup screen)
4. Check CONFIG.brand.name in console — matches custom value
5. If Supabase URL/key entered, Supabase client initializes with those values
</verification>

<success_criteria>
- First launch shows setup screen; subsequent launches skip it
- CONFIG.brand, CONFIG.contact, CONFIG.supabase are all overridden by APP_CONFIG values
- Logo upload works and appears in the app header
- Supabase connection uses APP_CONFIG credentials when provided
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-tenant-saas/09-01-SUMMARY.md`
</output>
