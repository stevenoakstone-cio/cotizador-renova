---
phase: 09-multi-tenant-saas
plan: "03"
type: execute
wave: 3
depends_on: [09-02]
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: true
requirements: [MTNT-04, MTNT-05]

must_haves:
  truths:
    - "A license info screen is accessible from the app showing version, client name, expiration date, and support contact"
    - "If licenseKey in APP_CONFIG is missing, expired, or fails hash validation, a lock screen prevents app use"
    - "A valid licenseKey allows the app to load normally"
    - "The lock screen shows a message explaining the license is invalid or expired with support contact info"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "License info screen, license validation function, lock screen"
      contains: "validateLicense"
  key_links:
    - from: "boot sequence"
      to: "validateLicense()"
      via: "called before main app renders"
      pattern: "validateLicense"
    - from: "validateLicense()"
      to: "APP_CONFIG.licenseKey"
      via: "reads key from localStorage-backed config"
      pattern: "appConfig\\.licenseKey|licenseKey"
    - from: "lock screen"
      to: "validateLicense() returning false"
      via: "conditional that prevents app rendering"
      pattern: "showLockScreen|license-lock"
---

<objective>
Add license key validation with a lock screen for invalid/expired keys and a license info screen accessible from the app.

Purpose: License protection prevents unauthorized use of deployed instances. Each client gets a license key that encodes their name and expiration date; the app validates it on boot.
Output: License validation logic, lock screen UI, license info screen
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-multi-tenant-saas/09-01-SUMMARY.md
@cotizador-template/cotizador-template.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: License key validation and lock screen</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Implement a simple license key system with hash-based validation.

**License Key Format:**

The license key is a base64-encoded JSON string containing:
```json
{
  "client": "Mi Carpinteria",
  "exp": "2027-01-01",
  "hash": "abc123..."
}
```

The hash is computed as: a simple checksum of `client + exp + SECRET_SALT` where SECRET_SALT is a hardcoded string in the app (e.g., "renova-cotizador-2024"). Use a basic hash function (not crypto-grade, just a deterrent):

```javascript
function simpleHash(str) {
  var hash = 0;
  for (var i = 0; i < str.length; i++) {
    var chr = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + chr;
    hash |= 0;
  }
  return hash.toString(36);
}
```

**Implementation:**

1. Add `licenseKey` field to the APP_CONFIG schema (handled in the setup screen from Plan 01 — add a "Clave de Licencia" text field to the setup screen form in the "Conexion Cloud" section area, or create a new section "Licencia").

2. Add function `validateLicense()`:
   - Read licenseKey from APP_CONFIG (localStorage)
   - If no key exists: return `{valid: false, reason: 'no_key'}`
   - Decode base64, parse JSON
   - Verify hash matches: `simpleHash(decoded.client + decoded.exp + SECRET_SALT)` === `decoded.hash`
   - If hash mismatch: return `{valid: false, reason: 'invalid'}`
   - Check expiration: if `new Date(decoded.exp) < new Date()`, return `{valid: false, reason: 'expired', client: decoded.client, exp: decoded.exp}`
   - Otherwise: return `{valid: true, client: decoded.client, exp: decoded.exp}`

3. Add function `showLockScreen(reason, details)`:
   - Full-screen overlay (z-index: 10001, above setup screen), background #0d0d0d
   - Center content: lock icon (unicode padlock), gold text
   - Message based on reason:
     * 'no_key': "Licencia No Configurada — Ingrese su clave de licencia para utilizar el cotizador"
     * 'invalid': "Licencia Invalida — La clave de licencia no es valida. Contacte soporte."
     * 'expired': "Licencia Expirada — Su licencia expiro el {date}. Contacte soporte para renovar."
   - Show support contact: CONFIG.contact.email or a hardcoded support email "soporte@renova.mx"
   - A text input for entering/updating the license key + "Validar" button
   - On click "Validar": save the entered key to APP_CONFIG.licenseKey, call validateLicense() again, if valid remove overlay and reload

4. In the boot sequence (where the hasAppConfig() check already exists from Plan 01):
   - After APP_CONFIG is loaded and setup screen is passed
   - Call `validateLicense()`
   - If not valid: call `showLockScreen(result.reason, result)` and return (do not render main app)

5. Add a helper function `generateLicenseKey(client, expDate)` that creates a valid key (for the developer/admin to use). This function should:
   - Take client name and expiration date string
   - Compute hash
   - Return base64-encoded JSON
   - Expose on APP object as `APP.generateLicenseKey` so the admin can generate keys from the console

**Boot order should be:**
1. Load APP_CONFIG → override CONFIG
2. If no APP_CONFIG → show setup screen (stop)
3. If APP_CONFIG exists → validateLicense()
4. If license invalid → show lock screen (stop)
5. If license valid → render main app
  </action>
  <verify>
1. Generate a valid license key in the console: `APP.generateLicenseKey('Test Co', '2027-12-31')` — copy the result
2. Add it to APP_CONFIG via the setup screen or console: `APP.saveAppConfig({...existing, licenseKey: 'THE_KEY'})`
3. Refresh — app should load normally
4. Change the key to garbage: `APP.saveAppConfig({...existing, licenseKey: 'invalid'})` — refresh — lock screen appears
5. Remove the key entirely — lock screen appears with "no_key" message
6. On the lock screen, paste the valid key and click Validar — app should load
  </verify>
  <done>Invalid/expired/missing license shows lock screen preventing app use; valid license allows normal app load; license keys can be generated via APP.generateLicenseKey()</done>
</task>

<task type="auto">
  <name>Task 2: License info screen accessible from the app</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Add a license information screen accessible from the app header or settings area.

1. Find the app header/settings area. Add a small "info" or "license" button (e.g., a circled "i" icon or a small text link "Licencia") near the connection indicator or in a settings menu.

2. Create function `showLicenseInfo()` that displays a modal overlay with:
   - Title: "Informacion de Licencia" (gold text on dark background)
   - Fields displayed (read-only):
     * Version: "Cotizador Pro v1.0" (hardcode version string in CONFIG, e.g., CONFIG.version = '1.0')
     * Cliente: the client name from the decoded license key
     * Expiracion: the expiration date formatted as "DD de Mes YYYY" in Spanish
     * Estado: "Activa" (green) or "Expirada" (red) or "Sin licencia" (gray)
     * Soporte: support email/phone
   - A "Cerrar" button to dismiss the modal
   - Style matching the dark theme (#0d0d0d background, #c49a6c accents, rounded corners)

3. Add `CONFIG.version = '1.0'` to the CONFIG object.

4. Wire the button: clicking it calls `showLicenseInfo()`.

5. Expose `showLicenseInfo` on APP object.
  </action>
  <verify>
1. With a valid license configured, click the license info button in the header
2. Modal shows: version "1.0", client name, expiration date, status "Activa" in green
3. Click "Cerrar" — modal dismisses
4. With no license: shows "Sin licencia" in gray
  </verify>
  <done>License info screen is accessible from the app header, showing version, client name, expiration, status, and support contact</done>
</task>

</tasks>

<verification>
1. Full boot flow: no APP_CONFIG → setup screen → save → license check → lock if invalid → app if valid
2. License info screen accessible and displays correct data
3. Expired license shows lock screen
4. APP.generateLicenseKey() produces keys that pass validation
5. Lock screen allows entering a valid key to unlock
</verification>

<success_criteria>
- Lock screen blocks app use when license is missing, invalid, or expired
- Valid license allows normal app operation
- License info screen shows version, client, expiration, status
- Admin can generate license keys via console
</success_criteria>

<output>
After completion, create `.planning/phases/09-multi-tenant-saas/09-03-SUMMARY.md`
</output>
