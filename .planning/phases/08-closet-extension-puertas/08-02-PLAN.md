---
phase: 08-closet-extension-puertas
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: true
requirements: [PTED-01, PTED-02, PTED-03]

must_haves:
  truths:
    - "User can select Puerta as project type and add a puerta interior module"
    - "Puerta despiece shows bastidor pino pieces (2 largueros + 2 travesanos), 2 tapas MDF, and optional marco chambrana + tope"
    - "Bisagra count is 3 for honey-comb or peinazos relleno and 4 for solida relleno"
    - "User can select relleno type (honeycomb, peinazos, solida) in step2() UI"
    - "Selecting Puerta project type in step1 shows only puerta-specific modules in step2"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "Rewritten puerta calculateParts with bastidor despiece, relleno-based bisagra logic, step2 relleno selector"
      contains: "bastidor"
  key_links:
    - from: "calculateParts() puerta branch"
      to: "bastidor despiece pieces"
      via: "moduleType === 'puerta' rewrite"
      pattern: "Larguero.*bastidor|Travesano.*bastidor"
    - from: "assignHardware() puerta branch"
      to: "bisagra count by relleno"
      via: "materials.relleno check"
      pattern: "relleno.*solida.*4|relleno.*3"
    - from: "step2() puerta module card"
      to: "relleno selector buttons"
      via: "m.type === 'puerta' UI block"
      pattern: "relleno.*honeycomb|relleno.*peinazos|relleno.*solida"
    - from: "TYPES.puerta"
      to: "MODS.puerta forType filter"
      via: "step1 type selection filters step2 module picker"
      pattern: "forType.*puerta"
---

<objective>
Rewrite the puerta interior module to generate correct bastidor-based despiece per INSTRUCTIVO Section 7, with relleno type selection driving bisagra count.

Purpose: Currently the puerta calculateParts generates a single "Panel puerta" piece which is incorrect. Real interior doors are a sandwich: bastidor pino frame + 2 tapas MDF + relleno + marco chambrana + tope. The bisagra count depends on the relleno type (weight).
Output: Rewritten calculateParts puerta branch, updated assignHardware puerta branch, step2() relleno selector UI, HW_DEFAULTS keys for puerta-specific hardware.
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@INSTRUCTIVO_TECNICO.md (Section 7 — Puertas de Intercomunicacion)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite puerta calculateParts + assignHardware + HW_DEFAULTS</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
**1. Add new HW_DEFAULTS keys for puerta-specific hardware** (in the guarded conditionals block, around line ~3509):

```javascript
if (!HW_DEFAULTS.bisagra_libro) HW_DEFAULTS.bisagra_libro = { desc: 'Bisagra libro/mariposa puerta', marca: 'DEMO', fallback: 65, cat: 'BISAGRA' };
if (!HW_DEFAULTS.chapa_puerta) HW_DEFAULTS.chapa_puerta = { desc: 'Chapa con manija puerta', marca: 'DEMO', fallback: 350, cat: 'ACC. PUERTA' };
```

Also add in the real-prices conditional block (HW_REAL around line ~3543):
```javascript
bisagra_libro: { desc: 'Bisagra libro/mariposa puerta', marca: 'HERRAXA', fallback: 55.00, cat: 'BISAGRA' },
chapa_puerta: { desc: 'Chapa con manija puerta interior', marca: 'HERRAXA', fallback: 280.00, cat: 'ACC. PUERTA' },
```

Note: Do NOT add `bastidor_pino_ml` as a separate HW_DEFAULTS key. Puerta bastidor pieces use `isBastidor: true` and will be priced via the existing `bastidor_ml` key from Phase 7 (panelFondo). The existing bastidorCost accumulator in calc() picks up all pieces with `isBastidor: true` and prices them per ml using `HW_DEFAULTS.bastidor_ml`.

**2. REPLACE the calculateParts() puerta branch** (around line ~5256-5267).

Remove the current puerta branch that generates "Panel puerta" + optional Jamba/Cabezal, and replace with the proper bastidor sandwich despiece per INSTRUCTIVO 7.1:

```javascript
} else if (moduleType === 'puerta') {
    // Interior door — bastidor sandwich (INSTRUCTIVO 7.1)
    // Anatomy: 2 tapas MDF (exterior faces) + bastidor pino frame + relleno
    // AUDIT: w = door leaf width (typically 800-1000mm), h = door leaf height (2000-2100mm)

    // Bastidor pino frame (the internal wood skeleton)
    // AUDIT: Larguero — 2 vertical pine frame members, full height, 80mm wide
    pieces.push({ n: 'Larguero bastidor',   q: 2, w: 80,  h: h, t: 30, z: 'i', isBastidor: true });
    // AUDIT: Travesano — 2 horizontal pine frame members, inner width (w - 2*80 = w-160), 80mm tall
    pieces.push({ n: 'Travesano bastidor',  q: 2, w: w - 160, h: 80, t: 30, z: 'i', isBastidor: true });

    // Tapas MDF (the visible sandwich faces)
    // AUDIT: Tapa — 2 full-size MDF panels (3-6mm), full w x h; zone='f' (premium visible material)
    pieces.push({ n: 'Tapa MDF',            q: 2, w: w,   h: h, t: 3,  c: 0, z: 'f' });

    // Marco chambrana (frame covering the wall gap)
    if (materials.marco !== false) {
        // AUDIT: Jamba — 2 vertical frame pieces covering vano gap, 70mm wide; zone='f'
        pieces.push({ n: 'Jamba chambrana',  q: 2, w: 70,      h: h,   t: TK, z: 'f' });
        // AUDIT: Cabezal chambrana — horizontal top frame; w + 140mm to overlap both jambas
        pieces.push({ n: 'Cabezal chambrana', q: 1, w: w + 140, h: 70, t: TK, z: 'f' });
        // AUDIT: Tope — the thin stop strip where the door contacts when closing; 3 pieces (2 vertical + 1 horizontal)
        pieces.push({ n: 'Tope',             q: 3, w: 20,      h: h,   t: 10, z: 'f' });
        // Note: Tope q=3 covers 2 vertical + 1 horizontal (cabezal tope); height approximation uses h for all 3
    }
    // Note: bisagra_libro and chapa_puerta are handled in assignHardware()
}
```

**3. REPLACE the assignHardware() puerta branch** (around line ~5507-5514).

Remove the current branch that uses getBisagraCount with height/material weight. Replace with relleno-type-driven bisagra count per INSTRUCTIVO 7.4:

```javascript
} else if (moduleType === 'puerta') {
    // Interior door — bisagra libro count driven by relleno type (INSTRUCTIVO 7.4)
    // AUDIT: honeycomb/peinazos (lighter) = 3 bisagras; solida (heavy) = 4 bisagras
    var relleno = opts.relleno || 'honeycomb';
    var hinges = relleno === 'solida' ? 4 : 3;
    hw.push({ key: 'bisagra_libro', q: hinges });
    // AUDIT: 1 chapa (lock + handle set) per door
    hw.push({ key: 'chapa_puerta', q: 1 });
}
```

**4. Update the calc() function** to pass relleno to assignHardware options for puerta modules.

Find the place in calc() where assignHardware is called (search for `assignHardware(m.type`). Ensure the options object includes `relleno: m.relleno || 'honeycomb'`. The pattern should be similar to how `cajones`, `variant`, `noPuertas` etc. are already passed via the options object.

Also, ensure puerta modules are in the door skip guard in calc() (the block that skips door generation for non-door modules). Puerta modules do NOT generate separate "puerta" frente pieces in the calc() door block — the tapas MDF ARE the door faces. Add `m.type === 'puerta'` to the skip guard alongside repisaFlotante, panelFondo, etc.

**5. Bastidor pricing.** The isBastidor flag on the Larguero and Travesano pieces (set in step 2) will be automatically picked up by the existing bastidorCost accumulator in calc() from Phase 7. This accumulator prices all `isBastidor: true` pieces per ml using `HW_DEFAULTS.bastidor_ml`. No additional pricing code is needed — verify the accumulator exists by searching for `isBastidor` in calc().
  </action>
  <verify>
Open browser. Create a puerta project.
1. Add a puerta 90cm wide, 210cm tall — despiece shows: Larguero bastidor x2, Travesano bastidor x2, Tapa MDF x2, Jamba chambrana x2, Cabezal chambrana x1, Tope x3
2. Hardware shows: bisagra_libro x3 (default honeycomb), chapa_puerta x1
3. Toggle marco OFF — Jamba, Cabezal, Tope disappear from despiece
4. No regression on existing module types
  </verify>
  <done>Puerta calculateParts generates correct bastidor sandwich despiece; assignHardware produces relleno-driven bisagra count; marco toggle works; bastidor pieces priced via ml</done>
</task>

<task type="auto">
  <name>Task 2: step2() UI — puerta relleno type selector + marco toggle fix + PTED-03 verification</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
**1. Add relleno type selector** in the step2() module card rendering section.

Find the existing puerta UI block (around line ~7846):
```javascript
if (m.type === 'puerta') {
    // Puerta-specific: marco toggle and material type
    h += '<div class="module-row"><span>Marco:</span>...
```

Add a relleno type selector BEFORE the marco toggle, using the same setModProp pattern used for repisaFlotante variant selector (Phase 7):

```javascript
if (m.type === 'puerta') {
    // Relleno type selector (drives bisagra count in assignHardware)
    var relleno = m.relleno || 'honeycomb';
    h += '<div class="module-row"><span>Relleno:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
    ['honeycomb', 'peinazos', 'solida'].forEach(function(r) {
        var labels = { honeycomb: 'Honey-comb (ligera)', peinazos: 'Peinazos pino', solida: 'Solida (pesada)' };
        h += '<button class="opt-btn' + (relleno === r ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'relleno\',\'' + r + '\')">' + labels[r] + '</button>';
    });
    h += '</div></div>';
    // Show bisagra count hint based on relleno
    var bisHint = relleno === 'solida' ? '4 bisagras (puerta pesada)' : '3 bisagras';
    h += '<div style="font-size:11px;color:#888;margin:2px 0 4px 0">Bisagras: ' + bisHint + '</div>';
    // Marco chambrana toggle (existing, keep as-is)
    ...existing marco toggle code...
```

**2. Ensure setModProp function exists.** It was added in Phase 7 for repisaFlotante variant selector. Verify it exists by searching for `setModProp`. If it exists, no action needed. If not, it needs to be added (but it should exist from Phase 7).

**3. Verify the marco toggle** already works correctly with the rewritten calculateParts. The existing `togModProp` for `marco` already sets `m.marco = !m.marco`. The rewritten calculateParts checks `materials.marco !== false`. Ensure the calc() function passes `marco: m.marco` in the materials object to calculateParts.

Marco default behavior: when `m.marco` is undefined, calc() passes `marco: undefined` to calculateParts. Since `undefined !== false` evaluates to true, marco pieces are generated by default (correct — most doors include marco). When user toggles marco off, `m.marco` becomes false, and `false !== false` = false, so marco pieces are excluded.

**4. Update the marco toggle UI text** to clearly say "Con marco chambrana" instead of just "Con marco".

**5. Remove the old material type selector** from the puerta UI block if it exists. The current puerta block (around line ~7848-7870) may have material type buttons (like 'tambor', 'solida' etc.) used by the OLD assignHardware that used getBisagraCount. These should be REPLACED by the new relleno selector. The old `materialType` property on the module is no longer used — the new property is `relleno`.

**6. Verify PTED-03: puerta TYPES entry and forType filtering.** After completing the UI changes, verify that:
- `TYPES` object has a `puerta` entry (it already exists at line ~3146 with `id: 'puerta'`)
- `MODS.puerta` has `forType: ['puerta']` (it already exists at line ~3390-3395)
- When user selects "Puerta" as project type in step1, the step2 module picker only shows modules with `forType` containing `'puerta'`
- The puerta module button appears and is clickable

If any of these are missing, add them. They should already exist from previous phases.
  </action>
  <verify>
Open browser.
1. In step1, select "Puerta" as project type — verify the project type is selectable and the UI transitions to step2
2. In step2, verify ONLY puerta-specific modules appear in the module picker (not closet, cocina, etc. modules)
3. Add a puerta 90cm x 210cm — relleno selector shows 3 options: Honey-comb, Peinazos pino, Solida
4. Default is honeycomb — bisagra hint shows "3 bisagras"
5. Select "Solida" — bisagra hint changes to "4 bisagras (puerta pesada)", hardware recalculates to 4 bisagra_libro
6. Toggle marco off — Jamba/Cabezal/Tope disappear from despiece
7. Toggle marco back on — they reappear
8. Verify no regression on TV repisaFlotante variant selector (same setModProp function)
  </verify>
  <done>Puerta UI shows relleno selector with 3 options; selecting solida changes bisagra count to 4; marco toggle works; hint text shows current bisagra count; puerta TYPES entry and forType filtering confirmed working</done>
</task>

</tasks>

<verification>
1. In step1, "Puerta" project type is selectable and filters modules correctly (PTED-03)
2. Create puerta project: add puerta 90x210, verify bastidor despiece (largueros, travesanos, tapas MDF, chambrana, tope)
3. Select relleno "solida" — hardware shows 4 bisagra_libro + 1 chapa_puerta
4. Select relleno "honeycomb" — hardware shows 3 bisagra_libro + 1 chapa_puerta
5. Toggle marco OFF — chambrana and tope pieces removed from despiece
6. Price calculation includes bastidor pieces priced per ml
7. No regressions on closet, cocina, bano, tv module types
</verification>

<success_criteria>
- Puerta project type selectable in step1, shows only puerta modules in step2 (PTED-03)
- Puerta despiece shows bastidor pino (largueros + travesanos), 2 tapas MDF, optional marco chambrana + tope
- Bisagra count: 3 for honeycomb/peinazos, 4 for solida
- Relleno type selectable in step2() UI with visual feedback
- Marco toggle works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-closet-extension-puertas/08-02-SUMMARY.md`
</output>
