---
phase: 04-cocina-extras-ui-output
plan: "02"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: true
requirements: [CUI-03, CUI-04, CUI-05, COUT-01]

must_haves:
  truths:
    - "App warns if horno module has no ventilacion note"
    - "App warns if fregadero uses non-MDF-RH material"
    - "App warns if module width is non-standard"
    - "Cost summary shows subtotals by casco, frente, herrajes, and extras"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "Validation warnings in step2(), cost breakdown categories in step3()"
      contains: "validacion"
  key_links:
    - from: "step2() validation block"
      to: "MODS[m.type].w"
      via: "width check against standard widths array"
      pattern: "MODS.*\\.w\\.indexOf"
    - from: "step3() cost breakdown"
      to: "calc() result"
      via: "c.cascoCost, c.frenteCost, c.herrajesCost, c.extrasCost"
      pattern: "cascoCost|frenteCost"
---

<objective>
Add cocina-specific validations (horno ventilacion, fregadero MDF-RH, non-standard widths) and restructure step3() cost summary to show subtotals by casco, frente, herrajes, and extras.

Purpose: Catch common user mistakes before quoting; give clear cost visibility by category.
Output: Modified cotizador-template.html with validation warnings and categorized cost summary.
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cocina-extras-ui-output/04-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cocina validation warnings in step2()</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Add a validation block at the bottom of each module card in step2() (before the closing `</div>` of the module card, after `renderModulePaint(m)` and before `MODS[m.type].d`). This block checks for cocina-specific issues and renders inline warning badges.

1. **Horno ventilacion warning (CUI-03):** If `m.type === 'hornoBase' || m.type === 'torreHornos'`, check if `m.ventilacion !== false` (default true for new modules). Show a yellow warning if not acknowledged:
```javascript
if (m.type === 'hornoBase' || m.type === 'torreHornos') {
    h += '<div class="module-row"><span>Ventilacion:</span><button class="opt-btn' + (m.ventilacion !== false ? ' sel' : '') + '" onclick="APP.togModProp(\'' + m.id + '\',\'ventilacion\')">' + svg(m.ventilacion !== false ? 'check' : 'plus') + ' Saque trasero 100mm</button></div>';
    if (m.ventilacion === false) {
        h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:#facc15">âš  Horno sin ventilacion trasera â€” riesgo de sobrecalentamiento</div>';
    }
}
```

2. **Fregadero MDF-RH warning (CUI-04):** If `m.type === 'fregadero'`, check if the project material selection includes MDF-RH. Since we don't track material by name directly in the module (it uses project-level matFrentes/matInterior IDs), add a red warning reminding the user:
```javascript
if (m.type === 'fregadero') {
    h += '<div style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:#ef4444">ðŸ”´ Zona humeda â€” usar MDF RH (Resistente a Humedad) obligatorio</div>';
}
```

3. **Non-standard width warning (CUI-05):** If the module's current width is NOT in `MODS[m.type].w` AND the module type does NOT have `custom: 1` (which allows any width), show a yellow warning:
```javascript
if (MODS[m.type] && !MODS[m.type].custom && MODS[m.type].w.indexOf(m.width) === -1) {
    h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:#facc15">âš  Ancho ' + m.width + 'cm no es estandar para ' + MODS[m.type].n + ' (estandar: ' + MODS[m.type].w.join(', ') + 'cm)</div>';
}
```

Place all 3 validation checks in the module rendering loop in step2(), after the existing door/quoteMode toggle block and before the module description line (`MODS[m.type].d`).

4. Add `APP.togModProp` if it doesn't exist already. Check first â€” it may already exist from puerta marco toggle. If it exists, verify it toggles boolean properties correctly. If not, add:
```javascript
togModProp: function(id, prop) {
    var m = S.project.modules.find(function(x) { return x.id === id; });
    if (m) { m[prop] = !m[prop]; S.editedPieces = {}; render(); }
}
```

Use ES5 syntax only. No let/const, no arrow functions, no template literals.
  </action>
  <verify>
Open HTML in browser. Add a hornoBase module â€” verify ventilacion toggle appears with default checked. Uncheck it â€” verify yellow warning appears. Add a fregadero â€” verify red MDF-RH warning always shows. Set a module width to a non-standard value via the custom width input â€” verify yellow non-standard width warning appears. No JS console errors.
  </verify>
  <done>Horno modules show ventilacion toggle with warning if unchecked. Fregadero shows permanent MDF-RH warning. Non-standard widths show yellow warning with standard options listed.</done>
</task>

<task type="auto">
  <name>Task 2: Add categorized cost subtotals (casco/frente/herrajes/extras) to step3()</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Modify calc() to compute and return separate cost subtotals for casco, frente, herrajes, and extras. Then update step3() to display these categories.

1. In calc(), after all pieces are computed and before the final cost aggregation, compute category subtotals:

```javascript
// Category subtotals for cocina display
var cascoPieceCost = 0;
var frentePieceCost = 0;
pieces.forEach(function(p) {
    if (p.isCubierta) return; // cubierta priced separately
    var pArea = (p.w * p.h * p.qty) / 1000000; // m2
    var pAreaWithMerma = pArea * CONFIG.pricing.mermaFactor;
    if (p.z === 'f') {
        frentePieceCost += pAreaWithMerma; // track area for frente
    } else {
        cascoPieceCost += pAreaWithMerma; // track area for casco/interior
    }
});
```

Actually, the existing calc() already computes `matCostF` (frente material cost) and `matCostI` (interior/casco material cost) from the sheet calculations. These are already separated by the `z` zone flag. So instead of recomputing, just expose existing values with clearer names in the return object:

Add to the calc() return object:
```javascript
cascoCost: matCostI + (useDual ? chapCostI : 0),
frenteCost: matCostF + chapCostF,
herrajesCost: hwCostCarpBucket + hwCostPremium,
extrasCost: extraCost
```

2. In step3(), add a "Subtotales por Categoria" section (a new card) between the existing Summary section and the grand total. Only show this when P.type === 'cocina':

```javascript
if (P.type === 'cocina') {
    h += '<div class="card"><div class="card-title">' + svg('layers') + ' Subtotales por Categoria</div>';
    h += '<div class="cost-row"><span>Casco (material interior + canto)</span><strong>' + fmt(c.cascoCost) + '</strong></div>';
    h += '<div class="cost-row"><span>Frente (material visible + canto)</span><strong>' + fmt(c.frenteCost) + '</strong></div>';
    h += '<div class="cost-row"><span>Herrajes (std + premium)</span><strong>' + fmt(c.herrajesCost) + '</strong></div>';
    if (c.extrasCost > 0)
        h += '<div class="cost-row"><span>Extras (LED, vidrio, cubierta, pintura)</span><strong>' + fmt(c.extrasCost) + '</strong></div>';
    h += '</div>';
}
```

Insert this card just before the existing `// Summary` section in step3() (before `h += '<div class="summary">'`).

3. Also add cubierta cost display if any cubierta modules exist. In the existing Extras card in step3(), add a row for cubierta cost if `c.cubiertaCost > 0`:
```javascript
if (c.cubiertaCost > 0)
    h += '<div class="cost-row"><span>Cubierta (' + c.cubiertaM2.toFixed(2) + ' m\u00b2)</span><strong>' + fmt(c.cubiertaCost) + '</strong></div>';
```

Use ES5 syntax only.
  </action>
  <verify>
Open HTML in browser. Create a cocina project with a bajoEstandar, fregadero, and cubierta. Go to Step 3. Verify a "Subtotales por Categoria" card appears showing Casco, Frente, Herrajes, and Extras subtotals. Verify cubierta cost appears in the Extras card. Verify a closet project does NOT show the Subtotales card. No JS console errors.
  </verify>
  <done>Step 3 shows "Subtotales por Categoria" card for cocina projects with casco/frente/herrajes/extras breakdown. Cubierta cost displays with m2 area. Non-cocina projects are unaffected.</done>
</task>

</tasks>

<verification>
1. Open HTML in browser, no JS console errors
2. Cocina project: hornoBase shows ventilacion toggle + warning when unchecked
3. Cocina project: fregadero shows red MDF-RH warning
4. Any module with non-standard width shows yellow warning
5. Cocina step3 shows Subtotales por Categoria card
6. Closet project step3 does NOT show the category card
</verification>

<success_criteria>
- 3 validation warnings implemented and visible for their respective conditions
- Step 3 shows categorized cost subtotals (casco, frente, herrajes, extras) for cocina projects
- No regressions on closet or other project types
</success_criteria>

<output>
After completion, create `.planning/phases/04-cocina-extras-ui-output/04-02-SUMMARY.md`
</output>
