---
phase: 04-cocina-extras-ui-output
plan: "03"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: true
requirements: [COUT-02]

must_haves:
  truths:
    - "Exported cocina PDF includes a module table listing all modules with type, dimensions, and quantity"
    - "Exported cocina PDF includes despiece table showing all pieces per module"
    - "Exported cocina PDF includes hardware summary table"
    - "Exported cocina PDF includes extras list if extras modules exist"
    - "Exported cocina PDF includes a technical note about cocina assembly"
    - "Internal PDF includes module table with cost columns and hardware detail with margins"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "genClientPDF() cocina-specific sections, genInternalPDF() cocina-specific sections"
      contains: "cocina.*PDF"
  key_links:
    - from: "genClientPDF()"
      to: "calc() result"
      via: "c.pieces, c.allHW, c.cubiertaCost"
      pattern: "autoTable"
    - from: "genInternalPDF()"
      to: "calc() result"
      via: "c.pieces, c.allHW, c.cascoCost, c.frenteCost, c.herrajesCost"
      pattern: "autoTable.*interno"
---

<objective>
Extend genClientPDF() and genInternalPDF() with cocina-specific sections: module table, despiece per module, hardware summary, extras list, and technical notes.

Purpose: Professional PDF output for cocina quotations, matching the quality expected for the first real customer sale.
Output: Modified cotizador-template.html with cocina PDF sections.
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cocina-extras-ui-output/04-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cocina module table and despiece sections to genClientPDF()</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Read the existing genClientPDF() function completely (starts ~line 8255). Understand the current structure: Page 1 = quote header + line items + totals. The function uses jsPDF + autoTable for table rendering.

Add cocina-specific sections AFTER the existing quote page content but BEFORE the legal terms. Only render these sections when `P.type === 'cocina'`.

1. **Module Index Table:** A summary table of all modules in the project.

After the existing quote totals section, add:
```javascript
if (P.type === 'cocina') {
    // Module index page
    doc.addPage();
    y = margin;
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 0, 0);
    doc.text('Detalle de Modulos', margin, y + 6);
    y += 12;

    var modRows = P.modules.map(function(m, i) {
        var modDef = MODS[m.type] || {};
        return [
            (i + 1) + '',
            modDef.n || m.name,
            m.width + ' cm',
            (m.height || P.defaultHeight || 200) + ' cm',
            (P.sameDepth ? (P.defaultDepth || 50) : (m.depth || P.defaultDepth || 50)) + ' cm',
            (m.quantity || 1) + ''
        ];
    });

    doc.autoTable({
        startY: y,
        head: [['#', 'Modulo', 'Ancho', 'Alto', 'Prof.', 'Cant.']],
        body: modRows,
        theme: 'grid',
        headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 9 },
        bodyStyles: { fontSize: 8 },
        columnStyles: { 0: { cellWidth: 10 } },
        margin: { left: margin, right: margin }
    });
    y = doc.lastAutoTable.finalY + 8;
```

2. **Despiece Table:** All pieces grouped by module.

```javascript
    // Despiece section
    if (y > ph - 60) { doc.addPage(); y = margin; }
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Despiece Completo', margin, y + 6);
    y += 12;

    var despRows = [];
    c.pieces.forEach(function(p) {
        despRows.push([
            p.mn || '',
            p.n,
            p.qty + '',
            p.w + ' mm',
            p.h + ' mm',
            (p.t || 15) + ' mm',
            p.z === 'f' ? 'Frente' : 'Interior'
        ]);
    });

    doc.autoTable({
        startY: y,
        head: [['Modulo', 'Pieza', 'Cant.', 'Ancho', 'Alto', 'Esp.', 'Material']],
        body: despRows,
        theme: 'grid',
        headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 8 },
        bodyStyles: { fontSize: 7 },
        columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 30 } },
        margin: { left: margin, right: margin }
    });
    y = doc.lastAutoTable.finalY + 8;
```

3. **Hardware Summary Table:**

```javascript
    // Hardware summary
    if (y > ph - 60) { doc.addPage(); y = margin; }
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Resumen de Herrajes', margin, y + 6);
    y += 12;

    var hwRows = [];
    c.allHW.forEach(function(hw) {
        hwRows.push([
            hw.desc,
            hw.marca || '',
            Math.ceil(hw.qty) + '',
            fmtD(hw.price),
            fmtD(Math.ceil(hw.qty) * hw.price)
        ]);
    });

    if (hwRows.length > 0) {
        doc.autoTable({
            startY: y,
            head: [['Herraje', 'Marca', 'Cant.', 'Precio Unit.', 'Total']],
            body: hwRows,
            theme: 'grid',
            headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 8 },
            bodyStyles: { fontSize: 7 },
            margin: { left: margin, right: margin }
        });
        y = doc.lastAutoTable.finalY + 8;
    }
```

4. **Extras List:** Only if extras modules (zoclo, vistaLateral, panelRelleno, cubierta) exist.

```javascript
    // Extras
    var hasExtras = P.modules.some(function(m) {
        return m.type === 'zoclo' || m.type === 'vistaLateral' || m.type === 'panelRelleno' || m.type === 'cubierta';
    });
    if (hasExtras) {
        if (y > ph - 50) { doc.addPage(); y = margin; }
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Extras y Acabados', margin, y + 6);
        y += 12;

        var extRows = [];
        P.modules.forEach(function(m) {
            if (m.type === 'zoclo' || m.type === 'vistaLateral' || m.type === 'panelRelleno' || m.type === 'cubierta') {
                var desc = MODS[m.type] ? MODS[m.type].n : m.name;
                if (m.type === 'cubierta') desc += ' (' + (m.cubiertaType || 'postformado') + ')';
                extRows.push([desc, m.width + ' cm', (m.quantity || 1) + '']);
            }
        });

        doc.autoTable({
            startY: y,
            head: [['Extra', 'Medida', 'Cant.']],
            body: extRows,
            theme: 'grid',
            headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 9 },
            bodyStyles: { fontSize: 8 },
            margin: { left: margin, right: margin }
        });
        y = doc.lastAutoTable.finalY + 8;
    }
```

5. **Technical Note:** A brief text block about cocina assembly, always at the end.

```javascript
    // Technical note
    if (y > ph - 40) { doc.addPage(); y = margin; }
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('Nota Tecnica', margin, y + 5);
    y += 8;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    var techNote = 'Modulos fabricados en melamina 15mm con cantos sellados. Herrajes Blum importados con garantia. Instalacion incluye nivelacion con patas regulables, anclaje de alacenas a muro, y verificacion de escuadra. Cubierta cotizada por separado segun material seleccionado. Saque trasero de 100mm obligatorio en modulos de horno para ventilacion.';
    var splitNote = doc.splitTextToSize(techNote, cw);
    doc.text(splitNote, margin, y);
    y += splitNote.length * 4 + 4;

} // end if cocina
```

Make sure all this code uses ES5 syntax (var, function expressions, no arrow functions, no template literals). The `c.pieces` and `c.allHW` arrays already exist in the calc() return. Verify that `fmtD` and `fmt` formatting functions are accessible within genClientPDF scope.
  </action>
  <verify>
Open HTML in browser. Create a cocina project with at least 1 bajo, 1 alacena, and 1 cubierta. Go to Step 4. Click "PDF Cliente". Verify the exported PDF has: (1) quote page with totals, (2) module index table, (3) despiece table, (4) hardware summary, (5) extras list, (6) technical note. Verify closet projects do NOT get these extra pages. No JS console errors.
  </verify>
  <done>Cocina client PDF includes module table, despiece table, hardware summary, extras list (when extras exist), and technical note. Closet PDFs are unaffected.</done>
</task>

<task type="auto">
  <name>Task 2: Add cocina-specific sections to genInternalPDF()</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Read the existing genInternalPDF() function completely. It uses jsPDF + autoTable and has a more detailed format than the client PDF (includes cost breakdowns, margins, internal pricing).

Add cocina-specific sections to genInternalPDF() AFTER the existing internal summary content, gated by `P.type === 'cocina'`. These mirror the client PDF sections but include cost/margin columns for internal use.

1. **Module Index Table with Costs:** Same as client PDF but with additional cost columns.

```javascript
if (P.type === 'cocina') {
    doc.addPage();
    y = margin;
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Detalle de Modulos (Interno)', margin, y + 6);
    y += 12;

    var modRowsInt = P.modules.map(function(m, i) {
        var modDef = MODS[m.type] || {};
        // Find this module's cost from calc result
        var modCost = 0;
        if (c.perModule && c.perModule[m.id]) {
            modCost = c.perModule[m.id].total || 0;
        }
        return [
            (i + 1) + '',
            modDef.n || m.name,
            m.width + ' cm',
            (m.height || P.defaultHeight || 200) + ' cm',
            (m.quantity || 1) + '',
            fmtD(modCost),
            fmtD(modCost * (CONFIG.pricing.margin || 0.30))
        ];
    });

    doc.autoTable({
        startY: y,
        head: [['#', 'Modulo', 'Ancho', 'Alto', 'Cant.', 'Costo', 'Margen']],
        body: modRowsInt,
        theme: 'grid',
        headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 8 },
        bodyStyles: { fontSize: 7 },
        columnStyles: { 0: { cellWidth: 8 }, 5: { halign: 'right' }, 6: { halign: 'right' } },
        margin: { left: margin, right: margin }
    });
    y = doc.lastAutoTable.finalY + 8;
```

Note: If `c.perModule` does not exist in the calc() return, fall back to showing only the module list without cost columns. Check the calc() return object structure first — if per-module costs are not tracked, use the simpler client-PDF style columns instead (without Costo/Margen).

2. **Hardware Detail Table with Pricing:** Full hardware breakdown including unit cost, total cost, and margin category (carpentry bucket vs premium).

```javascript
    // Hardware detail (internal)
    if (y > ph - 60) { doc.addPage(); y = margin; }
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Herrajes Detalle (Interno)', margin, y + 6);
    y += 12;

    var hwRowsInt = [];
    var hwTotalCost = 0;
    c.allHW.forEach(function(hw) {
        var qty = Math.ceil(hw.qty);
        var unitP = hw.price || 0;
        var total = qty * unitP;
        var bucket = (unitP <= (CONFIG.pricing.hwPremiumThreshold || 500)) ? 'Carpinteria' : 'Premium';
        hwTotalCost += total;
        hwRowsInt.push([
            hw.desc,
            hw.marca || '',
            qty + '',
            fmtD(unitP),
            fmtD(total),
            bucket
        ]);
    });

    if (hwRowsInt.length > 0) {
        doc.autoTable({
            startY: y,
            head: [['Herraje', 'Marca', 'Cant.', 'P. Unit.', 'Total', 'Tipo']],
            body: hwRowsInt,
            theme: 'grid',
            headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 8 },
            bodyStyles: { fontSize: 7 },
            columnStyles: { 3: { halign: 'right' }, 4: { halign: 'right' } },
            margin: { left: margin, right: margin }
        });
        y = doc.lastAutoTable.finalY + 4;

        // Hardware total row
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.text('Total Herrajes: ' + fmtD(hwTotalCost), margin, y + 4);
        y += 10;
    }
```

3. **Category Cost Summary:** A compact table showing the cost breakdown by category (casco, frente, herrajes, extras) with margins. Uses the `cascoCost`, `frenteCost`, `herrajesCost`, `extrasCost` fields added to calc() return in Plan 02.

```javascript
    // Category cost summary (internal)
    if (y > ph - 50) { doc.addPage(); y = margin; }
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Resumen por Categoria (Interno)', margin, y + 6);
    y += 12;

    var catRows = [
        ['Casco (interior + canto)', fmtD(c.cascoCost || 0)],
        ['Frente (visible + canto)', fmtD(c.frenteCost || 0)],
        ['Herrajes', fmtD(c.herrajesCost || 0)],
        ['Extras', fmtD(c.extrasCost || 0)]
    ];

    doc.autoTable({
        startY: y,
        head: [['Categoria', 'Costo']],
        body: catRows,
        theme: 'grid',
        headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 9 },
        bodyStyles: { fontSize: 8 },
        columnStyles: { 1: { halign: 'right' } },
        margin: { left: margin, right: margin }
    });
    y = doc.lastAutoTable.finalY + 8;

} // end if cocina (internal PDF)
```

Use ES5 syntax only. Verify that `fmtD` is accessible in genInternalPDF scope (it should be — check existing usage). If `c.perModule` is not available, simplify the module table to omit cost columns and just show dimensions.
  </action>
  <verify>
Open HTML in browser. Create a cocina project with multiple module types. Go to Step 4. Click "PDF Interno" (or the internal PDF button). Verify the internal PDF has: (1) existing internal summary, (2) module index table (with cost columns if available), (3) hardware detail with unit prices and bucket classification, (4) category cost summary table. Verify closet internal PDFs do NOT get cocina sections. No JS console errors.
  </verify>
  <done>Internal PDF for cocina includes module table (with costs if per-module data available), hardware detail with pricing and bucket classification (Carpinteria/Premium), and category cost summary. Closet internal PDFs are unaffected.</done>
</task>

</tasks>

<verification>
1. Open HTML in browser, no JS console errors
2. Create cocina project with multiple module types + cubierta
3. Generate client PDF — verify 5 cocina-specific sections present
4. Generate internal PDF — verify module table, hardware detail with pricing/bucket, and category summary present
5. Create closet project — verify neither PDF has cocina sections
</verification>

<success_criteria>
- Client PDF for cocina has: module table, despiece, hardware summary, extras list, technical note
- Internal PDF for cocina has: module table (with costs), hardware detail (with unit prices + bucket type), category cost summary
- Non-cocina PDFs are completely unaffected
- All tables render correctly with autoTable
</success_criteria>

<output>
After completion, create `.planning/phases/04-cocina-extras-ui-output/04-03-SUMMARY.md`
</output>
