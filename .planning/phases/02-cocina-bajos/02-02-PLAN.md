---
phase: 02-cocina-bajos
plan: "02"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: true
requirements:
  - CBAJ-01
  - CBAJ-02
  - CBAJ-03
  - CBAJ-04
  - CBAJ-05
  - CBAJ-06

must_haves:
  truths:
    - "assignHardware('bajoEstandar', ...) returns pata x4 and zoclo_clip x4"
    - "assignHardware('fregadero', ...) returns pata x4 and zoclo_clip x4"
    - "assignHardware('cajonera', ...) returns corr_tandem per cajón count, pata x4, and zoclo_clip x4"
    - "assignHardware('esquineroCiego', ...) returns pata x4 and zoclo_clip x4"
    - "assignHardware('hornoBase', ...) returns corr_tandem x1 (cajón inferior), pata x4, and zoclo_clip x4"
    - "calc() door block auto-selects 1 puerta for bajoEstandar <=500mm and 2 puertas for >500mm"
    - "calc() door block uses bisagra_165 key for esquineroCiego type"
    - "fregadero always gets 2 puertas regardless of width"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "assignHardware blocks for 5 bajo types + calc() door logic for cocina"
      contains: "bajoEstandar|fregadero|cajonera|esquineroCiego|hornoBase"
  key_links:
    - from: "assignHardware()"
      to: "HW_DEFAULTS keys"
      via: "hw.push({ key: 'pata' }) and hw.push({ key: 'zoclo_clip' })"
      pattern: "key: 'pata'.*key: 'zoclo_clip'"
    - from: "calc() door block"
      to: "assignHardware()"
      via: "moduleType check for cocina bajos"
      pattern: "esquineroCiego.*bisagra_165"
---

<objective>
Implement hardware auto-assignment for all 5 cocina bajo module types and update the calc() door logic to handle cocina-specific door count rules and 165-degree bisagras for esquineros.

Purpose: Hardware totals (patas, zoclo clips, bisagras, correderas) are required for accurate cocina quotations. The door count auto-selection by width and special bisagra types are domain rules from INSTRUCTIVO_TECNICO.md.

Output: 5 new `else if` blocks in assignHardware(), updated door block in calc() for cocina bajos.
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cocina-bajos/02-01-SUMMARY.md
@INSTRUCTIVO_TECNICO.md
@cotizador-template/cotizador-template.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement assignHardware() blocks for all 5 cocina bajo types</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Add 5 new `else if` blocks to `assignHardware()` (before the closing `return hw;` and after the existing `puerta` block). Each bajo module gets patas and zoclo clips as base hardware per INSTRUCTIVO_TECNICO.md section 3.8.

**Hardware rules per INSTRUCTIVO table 3.8:**
- ALL bajo modules: 4 patas regulables + 4 zoclo clips (1 clip per pata)
- Base 1 puerta: 2 bisagras (handled in calc() door block)
- Base 2 puertas: 4 bisagras (handled in calc() door block)
- Cajonera: N correderas Blum Tandem (1 par per cajón)
- Fregadero: 4 bisagras for 2 puertas (handled in calc() door block)
- Horno base: 1 par corredera for cajón inferior
- Esquinero L: 2 bisagras 165° (handled in calc() door block update)
- Esquinero ciego: standard bisagras (handled in calc() door block)

```javascript
} else if (moduleType === 'bajoEstandar') {
    // Cocina: standard base cabinet — patas + zoclo only (door hardware in calc())
    // AUDIT: 4 adjustable legs per INSTRUCTIVO 3.8 (shared between adjacent modules in real install, but quoted per module)
    hw.push({ key: 'pata', q: 4 });
    // AUDIT: 4 zoclo clips (1 per leg) for attaching the decorative zoclo strip
    hw.push({ key: 'zoclo_clip', q: 4 });

} else if (moduleType === 'fregadero') {
    // Cocina: sink module — patas + zoclo only (always 2 puertas, bisagras in calc())
    // AUDIT: 4 patas + 4 clips per INSTRUCTIVO 3.8
    hw.push({ key: 'pata', q: 4 });
    hw.push({ key: 'zoclo_clip', q: 4 });

} else if (moduleType === 'cajonera') {
    // Cocina: drawer module — Blum Tandem correderas + patas + zoclo
    var caj = typeof opts.cajones === 'number' ? opts.cajones : 3;
    if (caj > 0) {
        // AUDIT: 1 pair Blum Tandem soft-close per cajón per INSTRUCTIVO 3.3
        hw.push({ key: 'corr_tandem', q: caj });
        // AUDIT: 1 jaladera per cajón (drawer pulls)
        hw.push({ key: 'jaladera', q: caj });
    }
    // AUDIT: 4 patas + 4 clips
    hw.push({ key: 'pata', q: 4 });
    hw.push({ key: 'zoclo_clip', q: 4 });

} else if (moduleType === 'esquineroCiego') {
    // Cocina: blind corner or L-corner — patas + zoclo (door bisagras in calc())
    // AUDIT: 4 patas + 4 clips per INSTRUCTIVO 3.8
    hw.push({ key: 'pata', q: 4 });
    hw.push({ key: 'zoclo_clip', q: 4 });

} else if (moduleType === 'hornoBase') {
    // Cocina: oven base — 1 pair Tandem for cajón inferior + patas + zoclo
    // AUDIT: 1 corredera Tandem for the single inferior drawer per INSTRUCTIVO 3.8
    hw.push({ key: 'corr_tandem', q: 1 });
    // AUDIT: 1 jaladera for the inferior drawer
    hw.push({ key: 'jaladera', q: 1 });
    // AUDIT: 4 patas + 4 clips
    hw.push({ key: 'pata', q: 4 });
    hw.push({ key: 'zoclo_clip', q: 4 });
}
```

**IMPORTANT:** The cajonera module does NOT have doors, so it should NOT enter the door block in calc(). The door block already checks `if (m.doors || qm === 'solo_puertas')` — cajonera modules should have `m.doors = false` by default. The jaladeras for cajones are assigned here in assignHardware, NOT in the door block.
  </action>
  <verify>
Open browser DevTools console and test:
```javascript
// Test bajoEstandar hardware
var h1 = assignHardware('bajoEstandar', {w:600,h:720,d:580}, {});
console.log('bajoEstandar hw:', h1); // pata x4, zoclo_clip x4

// Test fregadero hardware
var h2 = assignHardware('fregadero', {w:600,h:720,d:580}, {});
console.log('fregadero hw:', h2); // pata x4, zoclo_clip x4

// Test cajonera hardware with 3 drawers
var h3 = assignHardware('cajonera', {w:600,h:720,d:580}, {cajones:3});
console.log('cajonera hw:', h3); // corr_tandem x3, jaladera x3, pata x4, zoclo_clip x4

// Test esquineroCiego hardware
var h4 = assignHardware('esquineroCiego', {w:900,h:720,d:580}, {});
console.log('esquineroCiego hw:', h4); // pata x4, zoclo_clip x4

// Test hornoBase hardware
var h5 = assignHardware('hornoBase', {w:600,h:720,d:580}, {});
console.log('hornoBase hw:', h5); // corr_tandem x1, jaladera x1, pata x4, zoclo_clip x4
```
  </verify>
  <done>assignHardware() returns correct hardware lists for all 5 bajo types: patas x4, zoclo_clip x4 on every bajo, corr_tandem on cajonera and hornoBase, jaladeras on drawer modules.</done>
</task>

<task type="auto">
  <name>Task 2: Update calc() door block for cocina bajo door count and 165-degree bisagras</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Update the door piece generation block in `calc()` (around line 4926) to handle cocina bajo-specific door rules. Currently the door count logic is:

```javascript
var doorCnt = m.type === 'esquinero' ? 2 : Math.ceil(m.width / 50);
```

This needs to be extended for cocina bajos per INSTRUCTIVO_TECNICO.md:

1. **bajoEstandar:** 1 puerta if width <= 500mm, 2 puertas if > 500mm (per INSTRUCTIVO 3.3 table)
2. **fregadero:** Always 2 puertas (per INSTRUCTIVO 3.3 — "Siempre 2 puertas")
3. **esquineroCiego:** 1 puerta for esquinero ciego type, 2 for esquinero en L (use `m.esquineroTipo` property; default to 'ciego' = 1 puerta)
4. **hornoBase:** 0 puertas at the oven niche level (oven has its own door); optional puerta above if space remains — skip door generation for hornoBase entirely (the cajón frente is already in calculateParts)
5. **cajonera:** 0 puertas (drawers only, no doors)

Replace the `doorCnt` calculation with an extended version. Find the line:
```javascript
var doorCnt = m.type === 'esquinero' ? 2 : Math.ceil(m.width / 50);
```

Replace it with:
```javascript
var doorCnt;
if (m.type === 'fregadero') {
    // AUDIT: Fregadero always has 2 puertas per INSTRUCTIVO_TECNICO
    doorCnt = 2;
} else if (m.type === 'bajoEstandar') {
    // AUDIT: 1 puerta for <=500mm width, 2 puertas for >500mm per INSTRUCTIVO_TECNICO 3.3
    doorCnt = m.width <= 50 ? 1 : 2;
} else if (m.type === 'esquineroCiego') {
    // AUDIT: Ciego = 1 puerta, en L = 2 puertas with 165° bisagras
    doorCnt = (m.esquineroTipo === 'enL') ? 2 : 1;
} else if (m.type === 'esquinero') {
    doorCnt = 2;
} else {
    doorCnt = Math.ceil(m.width / 50);
}
```

Note: `m.width` is in centimeters, so the threshold is 50 (= 500mm).

Also, update the bisagra assignment inside the door block to use `bisagra_165` for esquineroCiego en L and for esquineroGiratorio. Find the section where bisagras are pushed (around line 4946-4954) and wrap it:

After the `var bisPerDoor = getBisagraCount(doorHeightCm, doorMatType);` line, add a conditional for the bisagra key:

```javascript
var bisKey = (m.type === 'esquineroCiego' && m.esquineroTipo === 'enL') ? 'bisagra_165' : 'bisagra';
```

Then replace the two `autoHW.push` calls for bisagra and base_clip to use `bisKey`:
```javascript
autoHW.push({ key: bisKey,     q: doorCnt * bisPerDoor, modId: m.id });
autoHW.push({ key: 'base_clip', q: doorCnt * bisPerDoor, modId: m.id });
```

Also, ensure that `hornoBase` and `cajonera` types do NOT enter the door block. These modules should have `m.doors` as `false` by default. Add a guard at the top of the door block — right after `if (m.doors || qm === 'solo_puertas') {`:

```javascript
// Skip door generation for module types that have no doors (drawers/oven use their own frentes)
if (m.type === 'cajonera' || m.type === 'hornoBase') {
    // cajonera: frentes are in calculateParts(); hornoBase: oven has its own door
    // Do nothing — skip door generation
} else {
```

And close the else bracket at the end of the door block (before the closing `}` of the `if (m.doors || qm === 'solo_puertas')` block).

**IMPORTANT ES5 conventions:**
- No `let`/`const` — use `var`
- No arrow functions
- No template literals
- Comment with `// AUDIT:` prefix for domain rules
  </action>
  <verify>
Test the full calc() flow by creating a project with cocina bajo modules in the app UI:
1. Create new project, select type "Cocina"
2. Add a "Bajo Estandar" module at 60cm width — verify 2 puertas in the despiece, bisagra x4, base_clip x4, pata x4, zoclo_clip x4
3. Add a "Bajo Estandar" module at 40cm width — verify 1 puerta, bisagra x2
4. Add a "Fregadero" module at 60cm — verify 2 puertas always, no techo in despiece, 2 amarres visible
5. Add a "Cajonera" module at 60cm with 3 cajones — verify NO puertas, corr_tandem x3, jaladera x3
6. Add an "Esquinero Ciego" module at 90cm — verify 1 puerta
7. Add a "Horno Base" module at 60cm — verify NO puertas in door block, 1 corr_tandem for cajón

Also verify DevTools console has no errors during calc().
  </verify>
  <done>calc() correctly auto-selects door count for all 5 cocina bajo types (1-2 by width for bajoEstandar, always-2 for fregadero, 0 for cajonera/hornoBase), uses bisagra_165 for esquineroCiego en L, and all hardware totals show correct patas/zoclo_clip/bisagra/corredera counts.</done>
</task>

</tasks>

<verification>
1. assignHardware() returns pata x4 and zoclo_clip x4 for every bajo module type
2. assignHardware('cajonera') returns corr_tandem per cajón count
3. assignHardware('hornoBase') returns corr_tandem x1 for cajón inferior
4. calc() door block gives 1 puerta for bajoEstandar <=500mm, 2 for >500mm
5. calc() door block gives 2 puertas for fregadero always
6. calc() door block skips cajonera and hornoBase (no doors)
7. calc() uses bisagra_165 key for esquineroCiego en L
8. All existing closet/TV door logic still works unchanged
9. No JavaScript errors in browser console
</verification>

<success_criteria>
- Hardware totals for any bajo module show patas, zoclo clips, and correct bisagra/corredera assignments
- bajoEstandar auto-selects 1 or 2 puertas by width threshold
- fregadero always gets 2 puertas
- cajonera gets Blum Tandem correderas with jaladeras, no doors
- esquineroCiego supports both ciego (1 puerta) and en L (2 puertas, 165° bisagras)
- hornoBase gets 1 corredera for cajón inferior, no doors
- Zero regressions in existing closet/TV module types
</success_criteria>

<output>
After completion, create `.planning/phases/02-cocina-bajos/02-02-SUMMARY.md`
</output>
