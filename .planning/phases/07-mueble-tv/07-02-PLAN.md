---
phase: 07-mueble-tv
plan: "02"
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: true
requirements: [MTV-01, MTV-02, MTV-03, MTV-04, MTV-05]
must_haves:
  truths:
    - "User can select TV as project type in Step 1 and see only TV modules in Step 2"
    - "User can add consolaPatas or consolaFlotante and see correct despiece with 1 or 2 puertas auto-calculated"
    - "User can add torreLateralTV and choose between open shelves or door option"
    - "User can add repisaFlotante and choose between hollow-box or hidden-bracket variant"
    - "User can add panelFondo and see bastidor pieces in despiece with linear-meter pricing"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "TYPES entry for tv, calc() door logic, step2() variant selectors"
      contains: "id: 'tv'"
  key_links:
    - from: "TYPES array"
      to: "step2() module filter"
      via: "forType matching"
      pattern: "id:\\s*'tv'"
    - from: "calc() door block"
      to: "consolaPatas/consolaFlotante/torreLateralTV"
      via: "door count by width threshold"
      pattern: "consolaPatas|consolaFlotante|torreLateralTV"
    - from: "step2() variant selector"
      to: "calculateParts()"
      via: "m.variant property"
      pattern: "variant.*hueca|herraje"
    - from: "calc() area loop"
      to: "bastidorCost"
      via: "isBastidor flag pricing"
      pattern: "isBastidor"
---

<objective>
Wire TV modules into the UI and pricing engine: TYPES entry for 'tv', calc() door logic for consola/torre types, variant selectors in step2() for repisaFlotante, bastidor pricing in calc() area loop, and skip guards for modules without doors.

Purpose: Complete the TV quotation flow so users can select TV, add modules, configure variants, and get accurate pricing.
Output: Fully functional TV project type with all 5 module types quotable end-to-end.
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mueble-tv/07-01-SUMMARY.md
@cotizador-template/cotizador-template.html
@INSTRUCTIVO_TECNICO.md (Section 5: Muebles de TV)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TYPES entry + calc() door logic + door skip guards</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
**1. Add TYPES entry for TV:**
Add `{ id: 'tv', n: 'Mueble de TV', i: '&#x1f4fa;' }` to the TYPES array (after bano entry, before librero). This follows the exact same pattern as closet, cocina, bano entries.

**2. calc() door skip guard:**
Extend the existing door skip guard (the condition that prevents calc() from generating puertas for modules where calculateParts already handles them or they have no doors). Add these to the skip list:
- `repisaFlotante` — open shelf, no doors ever
- `panelFondo` — flat panel, no doors

These skip the door block entirely. Do NOT skip consolaPatas, consolaFlotante, or torreLateralTV — they get doors from the calc() door block.

**3. calc() door logic for consola types (consolaPatas + consolaFlotante):**
Add to the calc() door block (same pattern as bajoEstandar):
- `consolaPatas` and `consolaFlotante`: 1 puerta if m.width <= 500mm (50cm), 2 puertas if > 500mm
- doorH = h - 10 // AUDIT: 10mm juego total (same as standard bajo)
- doorW for 1 puerta: innerW - 4; for 2 puertas: (innerW / 2) - 2
- bisKey: 'bisagra' (standard cup 35mm)

**4. calc() door logic for torreLateralTV:**
- If module has m.noPuertas === true (open shelf config), skip door generation for this module (add to skip guard conditionally, or check inside the door block)
- If doors: 1 puerta (torre is narrow, 300-500mm, always single door)
- doorH = h - 10
- doorW = innerW - 4
- bisKey: 'bisagra'

Implementation approach for torreLateralTV open/closed: Check `m.noPuertas` flag. If truthy, skip door generation. The selector in Task 2 will set this flag. Add `(m.type === 'torreLateralTV' && m.noPuertas)` to the door skip guard alongside repisaFlotante and panelFondo.

**5. calc() bastidor pricing (isBastidor):**
In the calc() area/pricing loop where pieces are iterated, add handling for `isBastidor` flag (parallel to existing isCubrecanto pattern):
- If `p.isBastidor`: calculate total linear meters from piece dimensions (p.w is length in mm, sum all bastidor pieces: total_mm / 1000 = ml)
- bastidorCost += ml * HW_DEFAULTS.bastidor_ml
- Exclude bastidor pieces from sheet area calculation (they are pine, not melamina)
- Add bastidorCost to extraCost accumulator
- Return bastidorCost in calc() result object (alongside cubrecantoCost, cubiertaCost)
  </action>
  <verify>
- grep for `id: 'tv'` in TYPES array — found
- grep for `repisaFlotante` in door skip guard — found
- grep for `panelFondo` in door skip guard — found
- grep for `consolaPatas` in calc() door block — found with width threshold logic
- grep for `consolaFlotante` in calc() door block — found
- grep for `torreLateralTV` in calc() door block — found with noPuertas check
- grep for `isBastidor` in calc() area loop — found with ml pricing
- grep for `bastidorCost` in calc() return — found
  </verify>
  <done>TV selectable as project type in Step 1. calc() generates correct door pieces for consolaPatas/consolaFlotante (1 or 2 by width), torreLateralTV (1 or 0 by noPuertas flag). repisaFlotante and panelFondo correctly skipped. bastidorCost priced per linear meter and included in extraCost.</done>
</task>

<task type="auto">
  <name>Task 2: step2() variant selectors and module configuration UI</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Add step2() UI selectors for TV modules that need user configuration. Follow the existing patterns (cajones selector uses APP.setModC, shelves use APP.setModShelves, toggles use APP.togModProp).

**1. repisaFlotante variant selector:**
In step2() where module-specific controls are rendered (the section with cajones selectors, aventos model, etc.), add for repisaFlotante:
- Label: "Tipo de Repisa"
- Options: `[{v:'hueca', n:'Caja hueca'}, {v:'herraje', n:'Herraje oculto'}]`
- Default: 'hueca'
- Store in: `m.variant` (set via a function call, e.g., inline onchange that sets `APP.P.modules[idx].variant = value` then re-renders)
- Use pattern: create a select dropdown with onchange that updates m.variant and calls APP.renderStep2() or the relevant re-render function. Follow existing selector patterns in step2().

**2. torreLateralTV door toggle:**
- Label: "Configuracion"
- Options: toggle or select between "Abierta (nichos)" and "Con puerta"
- Default: false (has door by default — noPuertas = false)
- Store in: `m.noPuertas` using `APP.togModProp(id, 'noPuertas')` (existing toggle pattern from ventilacion toggle on horno modules)
- Display: checkbox or toggle labeled "Sin puerta (nichos abiertos)"

**3. repisaFlotante height note:**
When variant === 'herraje', show a small note/hint: "Minimo 38mm de grosor para herraje oculto" (informational only, the calculateParts already handles this).

**4. panelFondo — no special selectors needed.** Just the standard w/h/d inputs.

**5. consolaPatas / consolaFlotante — no special selectors needed.** Standard w/h/d inputs + material selectors. Door count auto-calculated by width.

Ensure all selectors only render when `m.type` matches the TV module type (use the same conditional rendering pattern as cajones selectors for cajonera/bajoLavabo).
  </action>
  <verify>
- Open the HTML file in browser, select "Mueble de TV" as project type
- Verify only TV modules appear in step2() module picker (5 types in TV category)
- Add a repisaFlotante: variant selector shows "Caja hueca" / "Herraje oculto"
- Add a torreLateralTV: "Sin puerta" toggle appears
- Add a consolaPatas: no special selectors, standard w/h/d
- Verify switching repisaFlotante variant changes the despiece (2 pieces for herraje vs 4+ for hueca)
  </verify>
  <done>step2() shows variant selector for repisaFlotante (hueca/herraje), door toggle for torreLateralTV (noPuertas), and all 5 TV module types appear when TV project type is selected. Variant/toggle values flow through to calculateParts and calc() correctly.</done>
</task>

</tasks>

<verification>
- Select "Mueble de TV" in Step 1 — only TV modules visible in Step 2
- Add consolaPatas 120cm: despiece shows costado x2, piso, techo, fondo, amarre, entrepaño + 2 puertas (>50cm). Hardware: pata x4, zoclo_clip x4, bisagra x4
- Add consolaFlotante 120cm: same despiece as consolaPatas. Hardware: soporte_flotante x2, bisagra x4
- Add torreLateralTV 40cm: despiece shows costado x2, piso, techo, fondo, entrepaño x2 + 1 puerta. Toggle "sin puerta": puerta disappears from despiece
- Add repisaFlotante 100cm variant=hueca: despiece shows tapa_superior, tapa_inferior, costado_caja x2, fondo. Hardware: soporte_flotante x2
- Add repisaFlotante 100cm variant=herraje: despiece shows tablero_repisa x1. Hardware: herraje_repisa x1
- Add panelFondo 180cm: despiece shows panel x1 + 5 bastidor pieces. bastidorCost appears in pricing
- No closet/cocina/bano functionality broken
</verification>

<success_criteria>
- TV project type selectable and filters modules correctly
- All 5 TV module types produce correct despiece + hardware + pricing
- Variant selector for repisaFlotante changes despiece between hueca/herraje
- Door toggle for torreLateralTV enables/disables puerta generation
- bastidorCost for panelFondo flows through extraCost to final pricing
</success_criteria>

<output>
After completion, create `.planning/phases/07-mueble-tv/07-02-SUMMARY.md`
</output>
