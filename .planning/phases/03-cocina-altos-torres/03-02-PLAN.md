---
phase: 03-cocina-altos-torres
plan: "02"
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: true
requirements: [CALT-01, CALT-02, CALT-03, CTOR-01, CTOR-02]

must_haves:
  truths:
    - "assignHardware('alacenaEstandar') returns soporte_alacena x2 (wall-mount brackets)"
    - "assignHardware('alacenaAventos') returns the selected aventos model (HK/HL/HS) x1 plus soporte_alacena x2"
    - "assignHardware('alacenaSobreCampana') returns soporte_alacena x2 (same as alacenaEstandar)"
    - "assignHardware('torreHornos') returns corr_tandem x1 + jaladera x1 + pata x4 + zoclo_clip x4"
    - "assignHardware('torreDespensa') returns pata x4 + zoclo_clip x4"
    - "calc() door block generates 1 puerta for alacenaEstandar <=50cm, 2 for >50cm"
    - "calc() door block generates 1 puerta elevable for alacenaAventos (full width)"
    - "calc() door block generates 2 puertas (sup+inf) for torreDespensa"
    - "calc() door block skips torreHornos (like hornoBase — oven has its own door)"
    - "step2() shows aventos model selector (HK/HL/HS) for alacenaAventos modules"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "5 assignHardware blocks, calc() door extensions, step2() UI selectors"
      contains: "alacenaEstandar"
  key_links:
    - from: "assignHardware('alacenaAventos')"
      to: "HW_DEFAULTS.aventos_hk"
      via: "opts.aventosModel key lookup"
      pattern: "aventos_"
    - from: "calc() door block"
      to: "alacenaEstandar doorCnt"
      via: "m.type === 'alacenaEstandar'"
      pattern: "alacenaEstandar"
    - from: "step2() aventos selector"
      to: "m.aventosModel"
      via: "APP.setModAventos()"
      pattern: "aventosModel"
---

<objective>
Wire assignHardware() for all 5 new module types, extend calc() door block with alacena/torre door count rules, and add step2() UI selectors for aventos model and torre-specific options.

Purpose: Complete the hardware auto-assignment and door logic so cost calculations work correctly for altos + torres. Add UI controls for user-selectable options (aventos model, entrepaño count).
Output: 5 new assignHardware() blocks, calc() door extensions, step2() UI selectors, APP methods for new properties.
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cocina-bajos/02-02-SUMMARY.md
@.planning/phases/03-cocina-altos-torres/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement assignHardware() blocks and calc() door logic for altos + torres</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
**assignHardware() — add 5 new else-if blocks** after the `hornoBase` block (line ~5038) and before the closing comment (line ~5041). Follow the exact same pattern: ES5, AUDIT comments, push to hw[].

alacenaEstandar:
```javascript
} else if (moduleType === 'alacenaEstandar') {
    // Cocina: standard wall cabinet — wall-mount brackets only (door bisagras in calc())
    // AUDIT: 2 soporte colgante brackets for wall mounting per INSTRUCTIVO
    hw.push({ key: 'soporte_alacena', q: 2 });
```

alacenaAventos:
```javascript
} else if (moduleType === 'alacenaAventos') {
    // Cocina: aventos wall cabinet — specific aventos model + wall-mount brackets
    // AUDIT: 1 Aventos mechanism set (opts.aventosModel selects HK/HL/HS), default HK-S
    var aventosKey = 'aventos_' + (opts.aventosModel || 'hk');
    hw.push({ key: aventosKey, q: 1 });
    // AUDIT: 2 soporte colgante brackets for wall mounting
    hw.push({ key: 'soporte_alacena', q: 2 });
```

alacenaSobreCampana:
```javascript
} else if (moduleType === 'alacenaSobreCampana') {
    // Cocina: over-hood/fridge wall cabinet — wall-mount brackets only (same as standard alacena)
    // AUDIT: 2 soporte colgante brackets for wall mounting
    hw.push({ key: 'soporte_alacena', q: 2 });
```

torreHornos:
```javascript
} else if (moduleType === 'torreHornos') {
    // Cocina: tower with microwave + oven niches — 1 Tandem for cajón inferior + patas + zoclo
    // AUDIT: 1 corredera Tandem for the single inferior drawer (same pattern as hornoBase)
    hw.push({ key: 'corr_tandem', q: 1 });
    // AUDIT: 1 jaladera for the inferior drawer
    hw.push({ key: 'jaladera', q: 1 });
    // AUDIT: 4 patas + 4 clips (tower is floor-standing)
    hw.push({ key: 'pata', q: 4 });
    hw.push({ key: 'zoclo_clip', q: 4 });
```

torreDespensa:
```javascript
} else if (moduleType === 'torreDespensa') {
    // Cocina: tall pantry tower — patas + zoclo (door bisagras in calc())
    // AUDIT: 4 patas + 4 clips (tower is floor-standing)
    hw.push({ key: 'pata', q: 4 });
    hw.push({ key: 'zoclo_clip', q: 4 });
```

**calc() door block — extend door count rules.** In the calc() door block (around line ~5104), add new conditions:

1. Add `|| m.type === 'torreHornos'` to the existing cajonera/hornoBase skip guard:
   Change: `if (m.type === 'cajonera' || m.type === 'hornoBase')`
   To: `if (m.type === 'cajonera' || m.type === 'hornoBase' || m.type === 'torreHornos')`
   Comment: `// torreHornos: oven has its own door, cajón frente in calculateParts()`

2. Add alacenaAventos BEFORE the generic doorCnt calculation. Aventos has a single full-width elevating door:
   ```javascript
   } else if (m.type === 'alacenaAventos') {
       // AUDIT: Aventos has 1 single elevating door (full width)
       doorCnt = 1;
   ```

3. Add alacenaEstandar and alacenaSobreCampana door rules — same pattern as bajoEstandar (1 if <=50cm, 2 if >50cm):
   ```javascript
   } else if (m.type === 'alacenaEstandar' || m.type === 'alacenaSobreCampana') {
       // AUDIT: 1 puerta for <=500mm width, 2 puertas for >500mm (same threshold as bajoEstandar)
       doorCnt = m.width <= 50 ? 1 : 2;
   ```

4. Add torreDespensa — always 2 puertas (superior + inferior):
   ```javascript
   } else if (m.type === 'torreDespensa') {
       // AUDIT: 2 puertas always — 1 superior + 1 inferior per INSTRUCTIVO torre despensa
       doorCnt = 2;
   ```
   Note: The torreDespensa door height should use half the tower height per door. After the doorCnt assignment for torreDespensa, override doorH:
   ```javascript
   // For torreDespensa, doorH is half the tower (2 stacked doors)
   if (m.type === 'torreDespensa') {
       doorH = Math.round(h / 2) - 3;
   }
   ```
   Place this override right after the `var doorH = h - 3;` line (~5125), as a conditional override.

5. For alacenaAventos, bisagras should NOT be pushed (aventos replaces bisagras). Add aventos guard around the bisagra push block:
   ```javascript
   if (m.type !== 'alacenaAventos') {
       // Standard bisagra + base_clip push (existing code)
       ...
   }
   // Aventos hardware is already in assignHardware() — no bisagras needed
   ```
   BUT the jaladera/tipon block should also be skipped for alacenaAventos (aventos doors have integrated handles). Add `&& m.type !== 'alacenaAventos'` to the jaladera/tipon section too.

Use ES5 only. Use AUDIT comment convention. Use unicode escapes for accented characters.
  </action>
  <verify>
- grep for `alacenaEstandar` in assignHardware section — must find the block
- grep for `alacenaAventos` in assignHardware section — must find aventosKey logic
- grep for `torreHornos` in door skip guard — must appear alongside cajonera/hornoBase
- grep for `torreDespensa` doorCnt — must find `doorCnt = 2`
- grep for `alacenaAventos` bisagra guard — must find the aventos guard preventing bisagra push
  </verify>
  <done>
- assignHardware() returns correct hardware for all 5 new types
- calc() door block: torreHornos skipped, alacenaAventos gets 1 door (no bisagras), alacenaEstandar/alacenaSobreCampana get 1-2 doors by width, torreDespensa gets 2 half-height doors
- No regressions to existing bajos or closet door logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Add step2() UI selectors for aventos model and torre options</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
In step2() (line ~6965), after the existing cajonera cajones selector block (line ~7043), add UI selectors for the new module types.

**Aventos model selector** for alacenaAventos:
```javascript
if (m.type === 'alacenaAventos') {
    var aventosM = m.aventosModel || 'hk';
    h += '<div class="module-row"><span>Aventos:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
    [['hk', 'HK-S'], ['hl', 'HL'], ['hs', 'HS']].forEach(function(opt) {
        h += '<button class="opt-btn' + (aventosM === opt[0] ? ' sel' : '') + '" onclick="APP.setModAventos(\'' + m.id + '\',\'' + opt[0] + '\')">' + opt[1] + '</button>';
    });
    h += '</div></div>';
}
```

**Entrepaño count selector** for alacenaEstandar and alacenaSobreCampana (default 1, range 0-3):
```javascript
if (m.type === 'alacenaEstandar' || m.type === 'alacenaSobreCampana') {
    var entCnt = typeof m.shelves === 'number' ? m.shelves : 1;
    h += '<div class="module-row"><span>Entrepa\u00f1os:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
    [0, 1, 2, 3].forEach(function(n) {
        h += '<button class="opt-btn' + (entCnt === n ? ' sel' : '') + '" onclick="APP.setModShelves(\'' + m.id + '\',' + n + ')">' + n + '</button>';
    });
    h += '</div></div>';
}
```

**Entrepaño count selector** for torreDespensa (default 4, range 2-6):
```javascript
if (m.type === 'torreDespensa') {
    var entCnt = typeof m.shelves === 'number' ? m.shelves : 4;
    h += '<div class="module-row"><span>Entrepa\u00f1os:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
    [2, 3, 4, 5, 6].forEach(function(n) {
        h += '<button class="opt-btn' + (entCnt === n ? ' sel' : '') + '" onclick="APP.setModShelves(\'' + m.id + '\',' + n + ')">' + n + '</button>';
    });
    h += '</div></div>';
}
```

**APP methods** — add to the `window.APP` object:

setModAventos: (if it doesn't already exist)
```javascript
setModAventos: function(id, model) {
    var m = S.project.modules.find(function(x) { return x.id === id; });
    if (m) { m.aventosModel = model; S.editedPieces = {}; render(); }
},
```

setModShelves: (if it doesn't already exist — check first, it might exist from closet code)
```javascript
setModShelves: function(id, n) {
    var m = S.project.modules.find(function(x) { return x.id === id; });
    if (m) { m.shelves = n; S.editedPieces = {}; render(); }
},
```

Check if `setModShelves` or equivalent already exists. If a `setModC`-like pattern handles shelves differently, adapt. The key is that `m.shelves` gets set to the selected number, which calculateParts() reads.

Use ES5 only. Follow existing step2() code patterns exactly — same class names, same onclick patterns.
  </action>
  <verify>
- grep for `alacenaAventos` in step2 function — must find the aventos selector
- grep for `setModAventos` in APP — must find the method
- grep for `setModShelves` in APP — must find the method
- grep for `torreDespensa` in step2 — must find the entrepaño selector
  </verify>
  <done>
- alacenaAventos modules show HK-S/HL/HS selector buttons in step2()
- alacenaEstandar and alacenaSobreCampana modules show entrepaño count (0-3) in step2()
- torreDespensa modules show entrepaño count (2-6) in step2()
- APP.setModAventos() and APP.setModShelves() exist and trigger re-render
  </done>
</task>

</tasks>

<verification>
- All 5 new module types have assignHardware() blocks returning correct hardware
- calc() door block handles all 5 types correctly (skip torreHornos, aventos single door, standard alacena 1-2, despensa 2 half-height)
- step2() shows appropriate selectors for aventos model and entrepaño counts
- No regressions: all existing module types (closet, TV, bajos) work unchanged
- ES5 only: no let/const/arrow/template literals
</verification>

<success_criteria>
User can add any of the 5 new module types in step2(), configure type-specific options (aventos model, shelf count), and the cost breakdown in step3() shows correct despiece and hardware assignments.
</success_criteria>

<output>
After completion, create `.planning/phases/03-cocina-altos-torres/03-02-SUMMARY.md`
</output>
