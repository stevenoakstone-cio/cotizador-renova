---
phase: 10-quality-polish
plan: "03"
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - cotizador-template/cotizador-template.html
autonomous: false
requirements: [QUAL-01]

must_haves:
  truths:
    - "A complete cocina project (add modules, view despiece, view costs, save to Supabase, export PDF) completes without JavaScript errors"
    - "All cocina module types (bajoEstandar, fregadero, cajonera, esquineroCiego, esquineroL, hornoBase, alacenaEstandar, alacenaAventos, alacenaSobreCampana, alacenaSobreRefri, torreHornos, torreDespensa, zoclo, vistaLateral, panelRelleno, cubierta) can be added and calculated"
    - "The cost summary shows correct subtotals for casco, frente, herrajes, extras"
    - "Both client and internal PDF export without errors for a multi-module cocina project"
  artifacts:
    - path: "cotizador-template/cotizador-template.html"
      provides: "Bug-free cocina workflow end to end"
  key_links:
    - from: "step1() type selection"
      to: "step2() module picker"
      via: "P.type = 'cocina' filters MODS by forType"
      pattern: "forType.*cocina"
    - from: "step2() addMod()"
      to: "calc() per-module calculation"
      via: "calculateParts + assignHardware + pricing"
      pattern: "calculateParts|assignHardware"
    - from: "calc() output"
      to: "step3() cost display"
      via: "c.cascoCost, c.frenteCost, c.herrajesCost, c.extrasCost"
      pattern: "cascoCost|frenteCost"
    - from: "step3() PDF buttons"
      to: "genClientPDF() + genInternalPDF()"
      via: "onclick handlers"
      pattern: "genClientPDF|genInternalPDF"
---

<objective>
End-to-end verification and bug fix pass for the complete cocina workflow.

Purpose: QUAL-01 requires that a complete cocina project flows from module addition through despiece, costs, Supabase save, and PDF export without errors. This plan performs a systematic code review of the cocina data path and fixes any issues found.
Output: A verified, bug-free cocina workflow from project creation to PDF export.
</objective>

<execution_context>
@C:/Users/Steven PC/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Steven PC/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-quality-polish/10-01-SUMMARY.md
@.planning/phases/10-quality-polish/10-02-SUMMARY.md
@CONTEXT.md
@cotizador-template/cotizador-template.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Systematic cocina data-path code review and fix</name>
  <files>cotizador-template/cotizador-template.html</files>
  <action>
Perform a systematic code review of the entire cocina data flow, checking each link in the chain for correctness. Fix any bugs found.

**Review checklist (read each section of code and verify):**

1. **TYPES array** — Verify cocina entry exists with correct id, icon, and name
2. **MODS entries** — Verify all 16 cocina module types have forType: ['cocina'] and correct cat values:
   - Bajos: bajoEstandar, fregadero, cajonera, esquineroCiego, esquineroL, hornoBase
   - Altos: alacenaEstandar, alacenaAventos, alacenaSobreCampana, alacenaSobreRefri
   - Torres: torreHornos, torreDespensa
   - Extras: zoclo, vistaLateral, panelRelleno, cubierta
3. **calculateParts()** — Verify each cocina module type has a case/branch and produces pieces with correct fields (n, w, h, q, z, tk)
4. **assignHardware()** — Verify each cocina module type has hardware assignment (bisagras, correderas, patas, zoclo_clip, soportes as applicable)
5. **calc()** — Verify:
   - Door logic: bajoEstandar (1 or 2 by width), fregadero (always 2), cajonera/hornoBase (no doors), esquineros (165deg bisagras), alacenas (1-2 doors), aventos (single lift), torres (2 doors)
   - Pricing: cascoCost, frenteCost, herrajesCost, extrasCost all computed correctly
   - perModule cost tracking works for cocina modules
6. **step2()** — Verify cocina module picker shows correct categories (Bajos, Alacenas, Torres, Extras) and all module-specific UI selectors work (cajones for cajonera, aventos model for alacenaAventos, etc.)
7. **step3()** — Verify cost summary shows categorized subtotals for cocina projects
8. **Validations** — Verify horno ventilacion warning, fregadero MDF-RH warning, non-standard width warning all trigger correctly
9. **genClientPDF()** — Verify cocina gate (`if (P.type === 'cocina')`) correctly renders all sections
10. **genInternalPDF()** — Verify cocina gate (`if (intP.type === 'cocina')`) correctly renders all sections
11. **cloudSaveProject()** — Verify cocina project data serializes correctly to localStorage/Supabase (no circular refs, no missing fields)

**For each issue found:** Fix it inline, add a `// FIX(QUAL-01):` comment explaining what was wrong and why.

**Common bug patterns to check:**
- Undefined variable references (typos in property names)
- Missing `|| 0` guards on numeric calculations that could produce NaN
- `p.qty` vs `p.q` inconsistency (the codebase uses `p.q`)
- Missing `break` statements in switch cases
- Door count logic edge cases (width = exactly 500mm)
- Hardware assignment missing for specific module types
- PDF autoTable column count mismatches
  </action>
  <verify>After review, open the HTML in a browser. Open browser console (F12). Create a new cocina project. Add one module of EACH cocina type (all 16 types). For each: verify no console errors, verify despiece appears in step3(), verify cost is non-zero. Then export client PDF and internal PDF — both should complete without errors and show all sections.</verify>
  <done>All cocina module types can be added, calculated, displayed, and exported to PDF without JavaScript errors. Any bugs found during review are fixed with FIX(QUAL-01) comments.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete cocina end-to-end workflow including tooltips (Plan 01), PDF cover page (Plan 02), and code review fixes (this plan Task 1). The full Phase 10 quality pass is complete.</what-built>
  <how-to-verify>
    1. Open cotizador-template.html in a browser
    2. Create a new project, select "Cocina" as type
    3. Hover over module buttons — verify tooltips show description + standard widths
    4. Add at least: 1 bajoEstandar (60cm), 1 fregadero (80cm), 1 cajonera (60cm), 1 alacenaEstandar (60cm), 1 cubierta
    5. Go to Step 3 — verify cost summary shows casco/frente/herrajes/extras subtotals
    6. Verify "Laminas Necesarias" box shows sheet counts below totals
    7. Export Client PDF — verify cover page appears first, then quote, then module index/despiece/hardware/extras/technical note
    8. Export Internal PDF — verify cover page appears, then detailed cost breakdown
    9. Check browser console (F12) — should show NO errors throughout the entire flow
    10. Save the project (cloud or local) and reload — verify it loads correctly
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- All 16 cocina module types add and calculate without errors
- Cost summary shows categorized subtotals
- Client PDF has: cover page + quote + module index + despiece + hardware + extras + technical note
- Internal PDF has: cover page + cost breakdown + module detail + hardware detail + category summary
- Browser console shows no errors during entire cocina workflow
- Tooltips visible on hover (from Plan 01)
- Sheet optimizer shows counts (from Plan 01)
</verification>

<success_criteria>
- Complete cocina project (add modules -> view despiece -> view costs -> save -> export PDF) completes without errors
- User verifies the full flow works correctly in the human checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/10-quality-polish/10-03-SUMMARY.md`
</output>
