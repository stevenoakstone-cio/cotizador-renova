<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Cotizador v1.2</title>
    <meta name="theme-color" content="#c49a6c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cotizador">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" id="dynamic-favicon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='%23c49a6c'>COT</text></svg>">
    <script src="jspdf.umd.min.js"></script>
    <script src="jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
    * {
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;
        margin: 0;
        padding: 0
    }

    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        background: #0d0d0d;
        color: #ffffff;
        font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif
    }

    #app {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden
    }

    .hdr {
        background: #1a1a1a;
        border-bottom: 1px solid #2a2a2a;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between
    }

    .hdr-logo {
        width: 40px;
        height: 40px;
        background: #ffffff;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #000;
        cursor: pointer
    }

    .hdr-txt {
        margin-left: 12px;
        flex: 1
    }

    .hdr-txt h1 {
        font-size: 18px;
        line-height: 1.2
    }

    .hdr-txt p {
        font-size: 11px;
        color: #bbbbbb
    }

    .hdr-btn {
        padding: 8px;
        border-radius: 8px;
        background: none;
        border: none;
        color: #ffffff;
        cursor: pointer
    }

    .hdr-actions {
        display: flex;
        gap: 4px
    }

    .steps {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px;
        background: rgba(13, 13, 13, 0.5)
    }

    .step-dot {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all .15s
    }

    .step-dot.active {
        background: #ffffff;
        color: #000;
        transform: scale(1.1)
    }

    .step-dot.done {
        background: rgba(255, 255, 255, 0.15);
        color: #ffffff
    }

    .step-dot.future {
        background: #2a2a2a;
        color: #999999;
        cursor: default
    }

    .step-line {
        width: 32px;
        height: 4px;
        border-radius: 2px;
        background: #2a2a2a
    }

    .step-line.done {
        background: rgba(255, 255, 255, 0.15)
    }

    .content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 16px
    }

    .nav {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: rgba(13, 13, 13, 0.8);
        border-top: 1px solid #2a2a2a
    }

    .nav-btn {
        flex: 1;
        padding: 16px;
        border-radius: 12px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 16px
    }

    .nav-btn.back {
        background: #2a2a2a;
        color: #ffffff
    }

    .nav-btn.next {
        background: #ffffff;
        color: #000
    }

    .nav-btn:disabled {
        background: #2a2a2a;
        color: #999999;
        cursor: not-allowed
    }

    .title {
        text-align: center;
        padding: 16px 0
    }

    .title h2 {
        font-size: 24px;
        color: #ffffff
    }

    .title p {
        color: #bbbbbb;
        margin-top: 4px
    }

    .field {
        margin-bottom: 20px
    }

    .field label {
        display: block;
        font-size: 14px;
        color: #ffffff;
        margin-bottom: 8px
    }

    .field input, .field select {
        width: 100%;
        padding: 16px;
        background: rgba(40, 40, 40, 0.5);
        border: 1px solid #3a3a3a;
        border-radius: 12px;
        color: #ffffff;
        font-size: 16px
    }

    .field input:focus, .field select:focus {
        outline: none;
        border-color: #ffffff
    }

    .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px
    }

    .type-btn {
        padding: 16px;
        border-radius: 12px;
        border: 2px solid #3a3a3a;
        background: rgba(40, 40, 40, 0.3);
        cursor: pointer;
        text-align: center;
        color: #ffffff
    }

    .type-btn.sel {
        border-color: #ffffff;
        background: rgba(255, 255, 255, 0.1)
    }

    .type-btn span {
        display: block;
        font-size: 24px;
        margin-bottom: 8px
    }

    .thick-btn {
        padding: 16px;
        border-radius: 12px;
        border: 2px solid #3a3a3a;
        background: rgba(40, 40, 40, 0.3);
        cursor: pointer;
        font-weight: 700;
        font-size: 18px;
        color: #ffffff
    }

    .thick-btn.sel {
        border-color: #ffffff;
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff
    }

    .hint {
        font-size: 13px;
        color: #999999;
        margin-top: 8px
    }

    .add-btns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 16px
    }

    .add-btn {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #3a3a3a;
        background: rgba(40, 40, 40, 0.5);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #ffffff
    }

    .module {
        padding: 16px;
        background: rgba(40, 40, 40, 0.3);
        border: 1px solid #3a3a3a;
        border-radius: 12px;
        margin-bottom: 12px
    }

    .module-hdr {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px
    }

    .module-num {
        width: 28px;
        height: 28px;
        background: #ffffff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        color: #000
    }

    .module-del {
        padding: 8px;
        color: #f87171;
        background: none;
        border: none;
        cursor: pointer;
        border-radius: 8px
    }

    .module-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px
    }

    .module-row span {
        font-size: 14px;
        color: #bbbbbb;
        width: 60px
    }

    .opt-btn {
        padding: 6px 12px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background: #3a3a3a;
        color: #ffffff
    }

    .opt-btn.sel {
        background: #ffffff;
        color: #000
    }

    .module-desc {
        font-size: 12px;
        color: #999999
    }

    .empty {
        padding: 32px;
        border: 2px dashed #3a3a3a;
        border-radius: 12px;
        text-align: center;
        color: #999999
    }

    .total-w {
        padding: 12px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 16px 0
    }

    .total-w span {
        color: #ffffff;
        font-weight: 500
    }

    .total-w strong {
        font-size: 20px;
        color: #ffffff
    }

    .extra-section {
        padding-top: 16px;
        border-top: 1px solid #2a2a2a;
        margin-top: 16px
    }

    .extra-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 12px;
        margin-bottom: 12px
    }

    .toggle {
        width: 56px;
        height: 32px;
        border-radius: 16px;
        background: #3a3a3a;
        position: relative;
        cursor: pointer;
        border: none;
        flex-shrink: 0
    }

    .toggle.on {
        background: #ffffff
    }

    .toggle::after {
        content: '';
        position: absolute;
        width: 24px;
        height: 24px;
        background: #fff;
        border-radius: 50%;
        top: 4px;
        left: 4px;
        transition: transform .15s
    }

    .toggle.on::after {
        transform: translateX(24px);
        background: #000
    }

    .extra-input {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-left: 32px;
        margin-bottom: 12px
    }

    .extra-input span {
        font-size: 14px;
        color: #bbbbbb
    }

    .extra-input input {
        width: 80px;
        padding: 8px 12px;
        background: #3a3a3a;
        border: 1px solid #3a3a3a;
        border-radius: 8px;
        color: #ffffff;
        text-align: center
    }

    .card {
        padding: 16px;
        background: rgba(40, 40, 40, 0.3);
        border: 1px solid #3a3a3a;
        border-radius: 12px;
        margin-bottom: 16px
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px
    }

    .cost-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 14px
    }

    .cost-row span {
        color: #bbbbbb
    }

    .cost-row strong {
        font-family: monospace
    }

    .cost-total {
        display: flex;
        justify-content: space-between;
        padding-top: 8px;
        border-top: 1px solid #3a3a3a;
        font-weight: 700
    }

    .cost-total strong {
        color: #ffffff;
        font-family: monospace
    }

    .summary {
        padding: 16px;
        background: #1a1a1a;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        margin-bottom: 16px
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px
    }

    .summary-row span {
        color: #bbbbbb
    }

    .summary-row strong {
        font-family: monospace
    }

    .grand-total {
        display: flex;
        justify-content: space-between;
        padding-top: 8px;
        border-top: 1px solid #3a3a3a
    }

    .grand-total span {
        font-size: 20px;
        font-weight: 700
    }

    .grand-total strong {
        font-size: 24px;
        color: #ffffff;
        font-family: monospace
    }

    .profit-box {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        margin-top: 12px
    }

    .profit-box span {
        color: #ffffff;
        font-size: 14px
    }

    .profit-box strong {
        color: #ffffff;
        font-family: monospace;
        font-size: 14px
    }

    .tabs {
        display: flex;
        background: rgba(40, 40, 40, 0.5);
        border-radius: 12px;
        padding: 4px;
        margin-bottom: 16px
    }

    .tab {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: none;
        color: #bbbbbb
    }

    .tab.sel {
        background: #ffffff;
        color: #000
    }

    .quote {
        background: #1a1a1a;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #3a3a3a
    }

    .quote-hdr {
        background: #222222;
        padding: 24px;
        text-align: center
    }

    .quote-hdr h2 {
        font-size: 24px
    }

    .quote-hdr p {
        color: #ffffff;
        font-size: 14px
    }

    .quote-body {
        padding: 16px
    }

    .quote-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px
    }

    .quote-info div span {
        font-size: 12px;
        color: #bbbbbb
    }

    .quote-info div p {
        font-weight: 500
    }

    .quote-project {
        padding: 12px;
        background: rgba(40, 40, 40, 0.5);
        border-radius: 8px;
        margin-bottom: 16px
    }

    .quote-project span {
        font-size: 12px;
        color: #bbbbbb
    }

    .quote-project h3 {
        font-size: 18px
    }

    .quote-project p {
        color: #ffffff;
        font-size: 14px
    }

    .quote-mods h4 {
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 8px
    }

    .quote-mod {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 8px;
        margin-bottom: 4px;
        font-size: 14px
    }

    .quote-extras {
        margin: 16px 0
    }

    .quote-extras h4 {
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 8px
    }

    .quote-extras p {
        font-size: 14px;
        color: #bbbbbb
    }

    .quote-price {
        border-top: 1px solid #3a3a3a;
        padding-top: 16px;
        margin-top: 16px
    }

    .quote-price-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px
    }

    .quote-price-row span {
        color: #bbbbbb
    }

    .quote-price-row strong {
        font-family: monospace
    }

    .quote-total {
        display: flex;
        justify-content: space-between;
        padding-top: 8px;
        border-top: 1px solid #3a3a3a;
        font-size: 20px;
        font-weight: 700
    }

    .quote-total strong {
        color: #ffffff
    }

    .quote-terms {
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 8px;
        margin: 16px 0
    }

    .quote-terms h4 {
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 8px
    }

    .quote-terms p {
        font-size: 14px;
        color: #bbbbbb;
        margin-bottom: 4px
    }

    .quote-contact {
        text-align: center;
        font-size: 14px;
        color: #bbbbbb;
        padding-top: 8px
    }

    .cut-hdr {
        background: #2a2a2a;
        padding: 16px
    }

    .cut-hdr h2 {
        font-size: 18px
    }

    .cut-body {
        padding: 16px
    }

    .cut-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px
    }

    .cut-box {
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        background: rgba(255, 255, 255, 0.08)
    }

    .cut-box strong {
        font-size: 24px;
        display: block;
        color: #ffffff
    }

    .cut-box span {
        font-size: 12px;
        color: #bbbbbb
    }

    .cut-module {
        background: rgba(40, 40, 40, 0.3);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px
    }

    .cut-module-hdr {
        background: #2a2a2a;
        padding: 8px 12px;
        font-weight: 700;
        font-size: 14px
    }

    .cut-module-body {
        padding: 8px
    }

    .cut-piece {
        display: flex;
        align-items: center;
        font-size: 12px;
        padding: 8px;
        background: rgba(26, 26, 26, 0.5);
        border-radius: 4px;
        margin-bottom: 4px
    }

    .cut-piece span:first-child {
        flex: 1
    }

    .cut-piece .qty {
        width: 32px;
        text-align: center;
        color: #ffffff
    }

    .cut-piece .dims {
        width: 80px;
        text-align: right;
        font-family: monospace
    }

    .cut-piece .thk {
        width: 48px;
        text-align: right;
        color: #999999
    }

    .cut-piece .zone {
        width: 48px;
        text-align: center;
        font-size: 10px;
        border-radius: 4px;
        padding: 2px 4px
    }

    .cut-piece .zone.f {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa
    }

    .cut-piece .zone.i {
        background: rgba(156, 163, 175, 0.2);
        color: #9ca3af
    }

    .copy-btn {
        width: 100%;
        padding: 16px;
        background: #ffffff;
        border: none;
        border-radius: 12px;
        color: #000;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 16px
    }

    .copy-btn.copied {
        background: #888888
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: 100
    }

    .modal-content {
        background: #1a1a1a;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        border-radius: 24px 24px 0 0;
        overflow: hidden
    }

    .modal-hdr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid #2a2a2a
    }

    .modal-hdr h2 {
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 8px
    }

    .modal-close {
        padding: 8px;
        background: none;
        border: none;
        color: #ffffff;
        cursor: pointer
    }

    .modal-body {
        overflow-y: auto;
        max-height: 70vh;
        padding: 16px
    }

    svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none
    }/* Templates */

    .tpl-grid {
        padding: 16px
    }

    .tpl-card {
        background: #1a1a1a;
        border: 1px solid #3a3a3a;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 16px
    }

    .tpl-card-img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        display: block;
        cursor: pointer
    }

    .tpl-card-body {
        padding: 16px
    }

    .tpl-card-name {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 4px
    }

    .tpl-card-type {
        display: inline-block;
        font-size: 11px;
        background: #2a2a2a;
        color: #bbb;
        padding: 2px 8px;
        border-radius: 4px;
        margin-bottom: 8px
    }

    .tpl-card-desc {
        font-size: 13px;
        color: #bbbbbb;
        margin-bottom: 8px
    }

    .tpl-card-dims {
        font-size: 14px;
        color: #bbbbbb;
        margin-bottom: 4px
    }

    .tpl-card-price {
        font-size: 22px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 12px
    }

    .tpl-card-btn {
        width: 100%;
        padding: 14px;
        background: #ffffff;
        color: #000;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer
    }

    .tpl-new {
        width: 100%;
        padding: 16px;
        background: none;
        border: 2px dashed #3a3a3a;
        border-radius: 12px;
        color: #bbbbbb;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 16px
    }

    .qq-back {
        display: flex;
        align-items: center;
        gap: 8px;
        background: none;
        border: none;
        color: #ffffff;
        cursor: pointer;
        padding: 12px 16px;
        font-size: 15px
    }

    .qq-img {
        width: 100%;
        max-height: 220px;
        object-fit: cover;
        display: block
    }

    .qq-body {
        padding: 16px
    }

    .qq-name {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 4px
    }

    .qq-desc {
        font-size: 14px;
        color: #bbbbbb;
        margin-bottom: 16px
    }

    .qq-section {
        padding: 16px;
        background: rgba(40, 40, 40, 0.3);
        border: 1px solid #3a3a3a;
        border-radius: 12px;
        margin-bottom: 16px
    }

    .qq-section-title {
        font-size: 14px;
        color: #bbbbbb;
        margin-bottom: 12px
    }

    .qq-dim-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px
    }

    .qq-dim-row label {
        font-size: 14px;
        color: #bbbbbb;
        width: 50px
    }

    .qq-dim-input {
        flex: 1;
        padding: 12px;
        background: #3a3a3a;
        border: 1px solid #3a3a3a;
        border-radius: 8px;
        color: #ffffff;
        font-size: 18px;
        font-weight: 700;
        text-align: center
    }

    .qq-dim-input:focus {
        border-color: #ffffff;
        outline: none
    }

    .qq-price-box {
        padding: 20px;
        background: #1a1a1a;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        text-align: center;
        margin-bottom: 16px
    }

    .qq-price-label {
        font-size: 14px;
        color: #bbbbbb;
        margin-bottom: 4px
    }

    .qq-price {
        font-size: 32px;
        font-weight: 700;
        color: #ffffff
    }

    .qq-price-iva {
        font-size: 14px;
        color: #bbbbbb;
        margin-top: 4px
    }

    .qq-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px
    }

    .qq-info-item {
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 8px
    }

    .qq-info-item span {
        font-size: 12px;
        color: #bbbbbb;
        display: block
    }

    .qq-info-item strong {
        font-size: 15px
    }

    .wa-btn {
        width: 100%;
        padding: 16px;
        background: #ffffff;
        border: none;
        border-radius: 12px;
        color: #000;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 12px
    }

    .wa-btn.copied {
        background: #888888
    }

    .qq-full-btn {
        width: 100%;
        padding: 14px;
        background: none;
        border: 2px solid #3a3a3a;
        border-radius: 12px;
        color: #ffffff;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 16px
    }

    .qq-mat-select {
        width: 100%;
        padding: 12px;
        background: #3a3a3a;
        border: 1px solid #3a3a3a;
        border-radius: 8px;
        color: #ffffff;
        font-size: 15px
    }

    .qq-mat-select:focus {
        border-color: #ffffff;
        outline: none
    }

    .img-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center
    }

    .img-modal img {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
        touch-action: pinch-zoom
    }

    .img-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        border-radius: 50%;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center
    }/* V2: Dual Material */

    .mat-dual {
        margin-bottom: 20px
    }

    .mat-toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 12px;
        margin-bottom: 16px
    }

    .mat-toggle-row span {
        font-size: 14px;
        color: #ffffff
    }

    .mat-section {
        margin-bottom: 16px
    }

    .mat-section-label {
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px
    }

    .mat-section-label .badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px
    }

    .mat-section-label .badge.vis {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa
    }

    .mat-section-label .badge.hid {
        background: rgba(156, 163, 175, 0.2);
        color: #9ca3af
    }

    .mat-select {
        width: 100%;
        padding: 12px;
        background: rgba(40, 40, 40, 0.5);
        border: 1px solid #3a3a3a;
        border-radius: 10px;
        color: #ffffff;
        font-size: 14px
    }

    .mat-select:focus {
        outline: none;
        border-color: #ffffff
    }

    .mat-info {
        font-size: 12px;
        color: #999;
        margin-top: 4px;
        padding-left: 4px
    }/* V2: Hardware Picker */

    .hw-picker {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 150;
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding-top: 5vh
    }

    .hw-picker-content {
        background: #1a1a1a;
        width: 100%;
        max-width: 500px;
        border-radius: 24px 24px 0 0;
        display: flex;
        flex-direction: column;
        overflow: hidden
    }

    .hw-picker-hdr {
        padding: 16px;
        border-bottom: 1px solid #2a2a2a;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0
    }

    .hw-picker-hdr h3 {
        font-size: 18px
    }

    .hw-search {
        padding: 12px;
        background: #2a2a2a;
        border: 1px solid #3a3a3a;
        border-radius: 8px;
        color: #ffffff;
        font-size: 14px;
        margin: 12px 16px;
        flex-shrink: 0;
        box-sizing: border-box;
        width: calc(100% - 32px)
    }

    .hw-search:focus {
        outline: none;
        border-color: #ffffff
    }

    .hw-filters {
        display: flex;
        gap: 6px;
        padding: 0 16px 10px;
        overflow-x: auto;
        flex-wrap: wrap;
        flex-shrink: 0
    }

    .hw-chip {
        padding: 6px 12px;
        border-radius: 16px;
        border: 1px solid #3a3a3a;
        background: none;
        color: #bbb;
        font-size: 12px;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0
    }

    .hw-chip.sel {
        background: #ffffff;
        color: #000;
        border-color: #ffffff
    }

    .hw-list {
        overflow-y: auto;
        flex: 1;
        padding: 0 16px 16px
    }

    .hw-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 10px;
        margin-bottom: 8px;
        gap: 12px
    }

    .hw-item-info {
        flex: 1;
        min-width: 0
    }

    .hw-item-name {
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
    }

    .hw-item-meta {
        font-size: 11px;
        color: #999
    }

    .hw-item-price {
        font-family: monospace;
        font-size: 14px;
        font-weight: 700;
        white-space: nowrap
    }

    .hw-item-qty {
        display: flex;
        align-items: center;
        gap: 6px
    }

    .hw-item-qty button {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: #3a3a3a;
        color: #fff;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer
    }

    .hw-item-qty strong {
        width: 24px;
        text-align: center;
        font-size: 14px
    }

    .hw-cat-hdr {
        font-size: 12px;
        color: #999;
        text-transform: uppercase;
        padding: 8px 0;
        border-bottom: 1px solid #2a2a2a;
        margin-bottom: 8px;
        margin-top: 8px
    }/* V2: Hardware selected in step 2 */

    .hw-selected {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #2a2a2a
    }

    .hw-selected h4 {
        font-size: 14px;
        color: #ffffff;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px
    }

    .hw-sel-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 13px
    }

    .hw-sel-item .hw-sel-name {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 8px
    }

    .hw-sel-item .hw-sel-qty {
        display: flex;
        align-items: center;
        gap: 4px
    }

    .hw-sel-item .hw-sel-qty button {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        background: #3a3a3a;
        color: #fff;
        cursor: pointer;
        font-weight: 700
    }

    .hw-sel-item .hw-sel-price {
        font-family: monospace;
        font-weight: 600;
        width: 70px;
        text-align: right
    }

    .hw-sel-item .hw-sel-marca {
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 3px;
        margin-right: 4px
    }

    .marca-herraxa {
        background: rgba(234, 179, 8, 0.15);
        color: #fbbf24
    }

    .marca-blum {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171
    }

    .marca-hafele {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa
    }

    .marca-arauco {
        background: rgba(34, 197, 94, 0.15);
        color: #4ade80
    }

    .hw-add-btn {
        width: 100%;
        padding: 12px;
        border: 1px dashed #3a3a3a;
        border-radius: 10px;
        background: none;
        color: #bbb;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 8px
    }/* V2: Settings Panel */

    .settings-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 160;
        display: flex;
        align-items: center;
        justify-content: center
    }

    .settings-panel {
        background: #1a1a1a;
        width: 90%;
        max-width: 420px;
        border-radius: 16px;
        overflow: hidden;
        max-height: 85vh;
        display: flex;
        flex-direction: column
    }

    .settings-hdr {
        padding: 16px;
        border-bottom: 1px solid #2a2a2a;
        display: flex;
        justify-content: space-between;
        align-items: center
    }

    .settings-hdr h3 {
        font-size: 18px
    }

    .settings-body {
        overflow-y: auto;
        padding: 16px
    }

    .settings-section {
        margin-bottom: 20px
    }

    .settings-section h4 {
        font-size: 14px;
        color: #bbbbbb;
        margin-bottom: 12px
    }

    .margin-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 8px;
        margin-bottom: 8px
    }

    .margin-row label {
        font-size: 14px;
        flex: 1
    }

    .margin-row input {
        width: 70px;
        padding: 8px;
        background: #3a3a3a;
        border: 1px solid #3a3a3a;
        border-radius: 6px;
        color: #fff;
        text-align: center;
        font-size: 14px
    }

    .margin-row input:focus {
        outline: none;
        border-color: #fff
    }

    .margin-row .lock {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        color: #999;
        padding: 8px 12px;
        background: #2a2a2a;
        border-radius: 6px
    }

    .margin-presets {
        display: flex;
        gap: 8px;
        margin-bottom: 16px
    }

    .margin-preset {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid #3a3a3a;
        background: none;
        color: #bbb;
        cursor: pointer;
        font-size: 13px
    }

    .margin-preset.sel {
        background: #ffffff;
        color: #000;
        border-color: #ffffff
    }

    .supplier-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 8px;
        margin-bottom: 6px
    }

    .supplier-row span {
        font-size: 14px
    }

    .supplier-row input {
        width: 60px;
        padding: 6px;
        background: #3a3a3a;
        border: 1px solid #3a3a3a;
        border-radius: 6px;
        color: #fff;
        text-align: center;
        font-size: 13px
    }/* V2: Cost Breakdown */

    .cost-bd {
        margin-top: 16px;
        border: 1px solid #3a3a3a;
        border-radius: 12px;
        overflow: hidden
    }

    .cost-bd-lock {
        padding: 12px 16px;
        background: #2a2a2a;
        font-size: 12px;
        color: #999;
        display: flex;
        align-items: center;
        gap: 8px
    }

    .cost-bd-toggle {
        padding: 12px 16px;
        background: rgba(40, 40, 40, 0.3);
        border: none;
        color: #ffffff;
        width: 100%;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between
    }

    .cost-bd-body {
        padding: 16px
    }

    .cost-bd-section {
        margin-bottom: 16px
    }

    .cost-bd-section h5 {
        font-size: 13px;
        color: #bbbbbb;
        margin-bottom: 8px;
        text-transform: uppercase
    }

    .cost-bd-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        font-size: 13px;
        font-family: monospace
    }

    .cost-bd-row span {
        color: #bbbbbb
    }

    .cost-bd-row strong {
        color: #ffffff
    }

    .cost-bd-subtotal {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-top: 1px solid #2a2a2a;
        font-size: 13px;
        font-weight: 700;
        margin-top: 4px
    }

    .cost-bd-grand {
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        margin-top: 8px
    }

    .cost-bd-grand-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 14px;
        font-family: monospace
    }

    .cost-bd-grand-row.total {
        font-size: 18px;
        font-weight: 700
    }/* V2: Suggest panel */

    .hw-suggest {
        padding: 12px;
        background: rgba(40, 40, 40, 0.2);
        border: 1px dashed #3a3a3a;
        border-radius: 8px;
        margin-top: 8px
    }

    .hw-suggest-title {
        font-size: 12px;
        color: #999;
        margin-bottom: 8px
    }

    .hw-suggest-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 13px
    }

    .hw-suggest-item button {
        padding: 4px 10px;
        border-radius: 6px;
        border: none;
        background: #3a3a3a;
        color: #fff;
        font-size: 12px;
        cursor: pointer
    }

    .hw-suggest-item button.added {
        background: rgba(255, 255, 255, 0.15);
        color: #999
    }/* V2: Labor input */

    .labor-input {
        display: flex;
        align-items: center;
        gap: 8px
    }

    .labor-input input {
        width: 120px;
        padding: 10px;
        background: #3a3a3a;
        border: 1px solid #3a3a3a;
        border-radius: 8px;
        color: #fff;
        font-size: 16px;
        text-align: right;
        font-family: monospace
    }

    .labor-input input:focus {
        outline: none;
        border-color: #fff
    }

    .labor-input span {
        color: #bbb;
        font-size: 14px
    }

    .labor-presets {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        flex-wrap: wrap
    }

    .labor-preset {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #3a3a3a;
        background: none;
        color: #bbb;
        font-size: 12px;
        cursor: pointer
    }

    .labor-preset.sel {
        background: #fff;
        color: #000;
        border-color: #fff
    }/* V2.1: PDF Screen */

    .pdf-screen {
        padding: 16px
    }

    .pdf-field {
        margin-bottom: 16px
    }

    .pdf-field label {
        display: block;
        font-size: 13px;
        color: #bbbbbb;
        margin-bottom: 6px
    }

    .pdf-field input, .pdf-field textarea {
        width: 100%;
        padding: 12px;
        background: rgba(40, 40, 40, 0.5);
        border: 1px solid #3a3a3a;
        border-radius: 10px;
        color: #ffffff;
        font-size: 15px
    }

    .pdf-field input:focus, .pdf-field textarea:focus {
        outline: none;
        border-color: #c49a6c
    }

    .pdf-field textarea {
        min-height: 60px;
        resize: vertical
    }

    .pdf-items {
        margin-bottom: 16px
    }

    .pdf-item {
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border: 1px solid #3a3a3a;
        border-radius: 10px;
        margin-bottom: 8px
    }

    .pdf-item-hdr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px
    }

    .pdf-item-hdr strong {
        font-size: 14px
    }

    .pdf-item-price {
        width: 120px;
        padding: 8px;
        background: #3a3a3a;
        border: 1px solid #3a3a3a;
        border-radius: 6px;
        color: #fff;
        font-size: 16px;
        text-align: right;
        font-family: monospace
    }

    .pdf-item-price:focus {
        border-color: #c49a6c;
        outline: none
    }

    .pdf-item-desc {
        width: 100%;
        padding: 8px;
        background: #2a2a2a;
        border: 1px solid #3a3a3a;
        border-radius: 6px;
        color: #bbb;
        font-size: 13px;
        resize: none;
        min-height: 40px
    }

    .pdf-item-desc:focus {
        border-color: #c49a6c;
        outline: none;
        color: #fff
    }

    .pdf-totals {
        padding: 16px;
        background: #1a1a1a;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        margin-bottom: 16px
    }

    .pdf-totals-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 15px
    }

    .pdf-totals-row.grand {
        font-size: 20px;
        font-weight: 700;
        padding-top: 8px;
        border-top: 1px solid #3a3a3a
    }

    .pdf-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px
    }

    .pdf-btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px
    }

    .pdf-btn.client {
        background: #c49a6c;
        color: #1a1a2e
    }

    .pdf-btn.internal {
        background: #2a2a2a;
        color: #ffffff;
        border: 1px solid #3a3a3a
    }

    .pdf-btn.despiece {
        background: #1e3a5f;
        color: #ffffff;
        border: 1px solid #2a5080
    }/* V2.1: Brand Selector */

    .brand-toggle {
        display: flex;
        gap: 8px;
        margin-bottom: 16px
    }

    .brand-btn {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #3a3a3a;
        background: none;
        color: #bbb;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-align: center
    }

    .brand-btn.sel {
        border-color: #c49a6c;
        background: rgba(196, 154, 108, 0.1);
        color: #c49a6c
    }

    .brand-btn .mono {
        font-size: 20px;
        font-weight: 700;
        display: block;
        margin-bottom: 4px
    }/* V2.1: Logo Upload */

    .logo-section {
        margin-bottom: 16px
    }

    .logo-preview {
        width: 160px;
        height: 80px;
        border-radius: 8px;
        background: #2a2a2a;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 8px
    }

    .logo-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain
    }

    .logo-btns {
        display: flex;
        gap: 8px
    }

    .logo-btns button {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        font-size: 13px;
        cursor: pointer
    }

    .logo-btns .upload {
        background: #c49a6c;
        color: #1a1a2e;
        font-weight: 600
    }

    .logo-btns .remove {
        background: #3a3a3a;
        color: #f87171
    }/* V2.2: LED Configurator */

    .led-section {
        margin-top: 12px;
        padding: 12px;
        background: rgba(251, 191, 36, 0.05);
        border: 1px solid rgba(251, 191, 36, 0.2);
        border-radius: 10px
    }

    .led-toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0
    }

    .led-toggle-row span {
        font-size: 13px;
        color: #fbbf24;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px
    }

    .led-edges {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 10px 0
    }

    .led-edge-box {
        position: relative;
        width: 120px;
        height: 80px;
        border: 2px solid #3a3a3a;
        border-radius: 4px;
        flex-shrink: 0
    }

    .led-edge {
        position: absolute;
        background: #3a3a3a;
        border: none;
        cursor: pointer;
        border-radius: 3px;
        transition: background .15s
    }

    .led-edge.on {
        background: #fbbf24
    }

    .led-edge.top {
        top: -4px;
        left: 10px;
        right: 10px;
        height: 6px
    }

    .led-edge.bottom {
        bottom: -4px;
        left: 10px;
        right: 10px;
        height: 6px
    }

    .led-edge.left {
        left: -4px;
        top: 10px;
        bottom: 10px;
        width: 6px
    }

    .led-edge.right {
        right: -4px;
        top: 10px;
        bottom: 10px;
        width: 6px
    }

    .led-edge-label {
        position: absolute;
        font-size: 9px;
        color: #666;
        pointer-events: none
    }

    .led-edge-label.top {
        top: -16px;
        left: 50%;
        transform: translateX(-50%)
    }

    .led-edge-label.bottom {
        bottom: -16px;
        left: 50%;
        transform: translateX(-50%)
    }

    .led-edge-label.left {
        left: -30px;
        top: 50%;
        transform: translateY(-50%)
    }

    .led-edge-label.right {
        right: -30px;
        top: 50%;
        transform: translateY(-50%)
    }

    .led-opts {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 0
    }

    .led-shelf-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #bbb
    }

    .led-shelf-row input {
        width: 48px;
        padding: 4px;
        background: #3a3a3a;
        border: 1px solid #3a3a3a;
        border-radius: 6px;
        color: #fff;
        text-align: center;
        font-size: 12px
    }

    .led-shelf-row button {
        padding: 2px 8px;
        border-radius: 6px;
        border: 1px solid #3a3a3a;
        background: none;
        color: #bbb;
        font-size: 11px;
        cursor: pointer
    }

    .led-shelf-row button.on {
        background: #fbbf24;
        color: #000;
        border-color: #fbbf24
    }

    .led-meters {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: #999;
        margin: 6px 0;
        flex-wrap: wrap
    }

    .led-meters input {
        width: 56px;
        padding: 3px;
        background: #2a2a2a;
        border: 1px solid #3a3a3a;
        border-radius: 4px;
        color: #fff;
        text-align: center;
        font-size: 11px;
        font-family: monospace
    }

    .led-meters strong {
        color: #fbbf24
    }

    .led-radio {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 6px 0
    }

    .led-radio button {
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #3a3a3a;
        background: none;
        color: #bbb;
        font-size: 11px;
        cursor: pointer
    }

    .led-radio button.sel {
        background: #fbbf24;
        color: #000;
        border-color: #fbbf24
    }

    .led-bom-preview {
        margin-top: 8px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 11px
    }

    .led-bom-preview .led-bom-row {
        display: flex;
        justify-content: space-between;
        padding: 1px 0;
        color: #bbb
    }

    .led-bom-preview .led-bom-row strong {
        color: #fbbf24;
        font-family: monospace
    }

    .led-bom-total {
        display: flex;
        justify-content: space-between;
        padding-top: 4px;
        border-top: 1px solid #3a3a3a;
        font-weight: 700;
        color: #fbbf24;
        margin-top: 4px
    }/* V2.3: Closet Estandarizado */

    .est-modules-row {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 12px 0;
        -webkit-overflow-scrolling: touch
    }

    .est-mod-card {
        min-width: 100px;
        flex-shrink: 0;
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border: 2px solid #3a3a3a;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        position: relative
    }

    .est-mod-card.sel {
        border-color: #c49a6c;
        background: rgba(196, 154, 108, 0.1)
    }

    .est-mod-card .est-mod-num {
        width: 24px;
        height: 24px;
        background: #c49a6c;
        color: #000;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 6px
    }

    .est-mod-card .est-mod-w {
        font-size: 14px;
        font-weight: 700;
        color: #fff;
        margin-top: 4px
    }

    .est-mod-card .est-mod-type {
        font-size: 10px;
        color: #bbb;
        margin-top: 2px
    }

    .est-mod-card .est-mod-arrows {
        display: flex;
        justify-content: center;
        gap: 4px;
        margin-top: 6px
    }

    .est-mod-card .est-mod-arrows button {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: none;
        background: #2a2a2a;
        color: #fff;
        font-size: 12px;
        cursor: pointer
    }

    .est-mod-del {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        background: rgba(248, 113, 113, 0.2);
        color: #f87171;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center
    }

    .est-add-btn {
        min-width: 80px;
        flex-shrink: 0;
        padding: 12px;
        border: 2px dashed #c49a6c;
        border-radius: 12px;
        background: none;
        color: #c49a6c;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        font-size: 13px;
        font-weight: 600
    }

    .est-zone {
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border: 1px solid #3a3a3a;
        border-radius: 10px;
        margin-bottom: 8px
    }

    .est-zone-hdr {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px
    }

    .est-zone-hdr strong {
        font-size: 14px;
        color: #c49a6c
    }

    .est-zone-actions {
        display: flex;
        gap: 4px
    }

    .est-zone-actions button {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: #2a2a2a;
        color: #fff;
        font-size: 14px;
        cursor: pointer
    }

    .est-zone-actions button.del {
        background: rgba(248, 113, 113, 0.2);
        color: #f87171
    }

    .est-zone-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
        flex-wrap: wrap
    }

    .est-zone-row span {
        font-size: 13px;
        color: #bbb;
        min-width: 60px
    }

    .est-height-bar {
        margin: 12px 0;
        padding: 12px;
        background: rgba(40, 40, 40, 0.3);
        border-radius: 10px
    }

    .est-vbar-wrap {
        display: flex;
        gap: 12px;
        align-items: stretch
    }

    .est-vbar {
        width: 60px;
        min-height: 220px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #3a3a3a;
        display: flex;
        flex-direction: column;
        background: #1a1a1a
    }

    .est-vbar-seg {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        color: #fff;
        overflow: hidden;
        min-height: 2px;
        position: relative;
        box-sizing: border-box
    }

    .est-vbar-seg.techo, .est-vbar-seg.piso {
        background: #333;
        color: #888
    }

    .est-vbar-seg.cajones {
        background: #c49a6c
    }

    .est-vbar-seg.colgador {
        background: rgba(96, 165, 250, 0.35);
        border: 1px dashed rgba(96, 165, 250, 0.5)
    }

    .est-vbar-seg.zapatero {
        background: #8b5cf6
    }

    .est-vbar-seg.entrepa {
        background: #666;
        min-height: 3px
    }

    .est-vbar-seg.entrepa_esp {
        background: #555;
        min-height: 3px;
        border: 1px dashed #888
    }

    .est-vbar-seg.libre {
        background: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(255, 255, 255, 0.04) 3px, rgba(255, 255, 255, 0.04) 6px)
    }

    .est-vbar-seg.exceso {
        background: rgba(248, 113, 113, 0.4);
        border: 1px solid #f87171
    }

    .est-vbar-seg.fijo {
        background: rgba(107, 114, 128, 0.5);
        border: 1px solid rgba(156, 163, 175, 0.5)
    }

    .est-vbar-seg.maletero {
        background: rgba(234, 179, 8, 0.4);
        border: 1px solid rgba(234, 179, 8, 0.5)
    }

    .est-vbar-seg.zoclo {
        background: rgba(139, 92, 60, 0.5);
        border: 1px solid rgba(196, 154, 108, 0.4);
        font-size: 8px;
        color: #c49a6c
    }

    .est-vbar-info {
        flex: 1;
        font-size: 12px;
        display: flex;
        flex-direction: column;
        gap: 2px
    }

    .est-vbar-row {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        color: #bbb
    }

    .est-vbar-row strong {
        color: #fff
    }

    .est-vbar-warn {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 6px;
        margin-top: 4px
    }

    .est-vbar-warn.yellow {
        background: rgba(251, 191, 36, 0.1);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.2)
    }

    .est-vbar-warn.red {
        background: rgba(248, 113, 113, 0.1);
        color: #f87171;
        border: 1px solid rgba(248, 113, 113, 0.2)
    }

    .est-vbar-warn.blue {
        background: rgba(96, 165, 250, 0.1);
        color: #60a5fa;
        border: 1px solid rgba(96, 165, 250, 0.2)
    }

    .est-chap-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px
    }

    .est-chap-edge {
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid #3a3a3a;
        background: none;
        color: #bbb;
        font-size: 12px;
        cursor: pointer
    }

    .est-chap-edge.on {
        background: rgba(196, 154, 108, 0.2);
        border-color: #c49a6c;
        color: #c49a6c
    }

    .est-total-bar {
        padding: 12px;
        background: rgba(196, 154, 108, 0.08);
        border: 1px solid rgba(196, 154, 108, 0.2);
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 12px 0
    }

    .est-total-bar span {
        color: #c49a6c;
        font-weight: 500;
        font-size: 14px
    }

    .est-total-bar strong {
        font-size: 20px;
        color: #c49a6c
    }

    .est-silhouette {
        width: 60px;
        height: 80px;
        margin: 0 auto 4px;
        display: flex;
        flex-direction: column;
        gap: 1px;
        padding: 2px;
        background: #2a2a2a;
        border-radius: 4px
    }

    .est-silhouette.est-sil-esq {
        clip-path: polygon(0 0, 100% 0, 100% 40%, 50% 40%, 50% 100%, 0 100%);
        width: 70px
    }

    .est-sil-zone {
        border-radius: 2px;
        width: 100%
    }

    .est-sil-cajones {
        background: rgba(196, 154, 108, 0.4)
    }

    .est-sil-colgador {
        background: rgba(96, 165, 250, 0.4)
    }

    .est-sil-zapatero {
        background: rgba(251, 191, 36, 0.4)
    }

    .est-sil-entrepa {
        background: rgba(156, 163, 175, 0.4)
    }

    .est-sil-entrepa_esp {
        background: rgba(156, 163, 175, 0.25);
        border: 1px dashed rgba(156, 163, 175, 0.5)
    }

    .est-sil-fijo {
        background: rgba(107, 114, 128, 0.4);
        border: 1px dashed rgba(156, 163, 175, 0.4)
    }

    .est-sil-maletero {
        background: rgba(234, 179, 8, 0.4)
    }

    .est-sil-zoclo {
        background: rgba(139, 92, 60, 0.5);
        border-top: 1px solid rgba(196, 154, 108, 0.4)
    }

    .est-mod-card.especial {
        border-color: #9ca3af
    }

    .est-home-btn {
        width: 100%;
        padding: 20px;
        background: rgba(196, 154, 108, 0.08);
        border: 2px solid #c49a6c;
        border-radius: 12px;
        color: #c49a6c;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 16px
    }

    .est-step-dots {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px
    }

    .est-step-dot {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 13px;
        border: none;
        cursor: pointer;
        transition: all .15s
    }

    .est-step-dot.active {
        background: #c49a6c;
        color: #000;
        transform: scale(1.1)
    }

    .est-step-dot.done {
        background: rgba(196, 154, 108, 0.25);
        color: #c49a6c
    }

    .est-step-dot.future {
        background: #2a2a2a;
        color: #999;
        cursor: default
    }

    .est-step-line {
        width: 28px;
        height: 3px;
        border-radius: 2px;
        background: #2a2a2a
    }

    .est-step-line.done {
        background: rgba(196, 154, 108, 0.3)
    }

    .saved-projects-section {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #2a2a2a
    }

    .saved-projects-title {
        font-size: 14px;
        font-weight: 600;
        color: #999;
        text-transform: uppercase;
        margin-bottom: 12px
    }

    .saved-project-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px;
        background: #1a1a1a;
        border: 1px solid #2a2a2a;
        border-radius: 10px;
        margin-bottom: 8px;
        position: relative
    }

    .saved-project-card:hover {
        border-color: #3a3a3a
    }

    .saved-project-info {
        flex: 1;
        min-width: 0
    }

    .saved-project-info .sp-client {
        font-size: 15px;
        font-weight: 600;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
    }

    .saved-project-info .sp-meta {
        font-size: 12px;
        color: #888;
        margin-top: 2px
    }

    .saved-project-actions {
        display: flex;
        gap: 6px;
        flex-shrink: 0
    }

    .saved-project-actions button {
        padding: 6px 14px;
        border-radius: 6px;
        border: 1px solid #3a3a3a;
        background: none;
        color: #bbb;
        font-size: 12px;
        cursor: pointer
    }

    .saved-project-actions .sp-load {
        border-color: #c49a6c;
        color: #c49a6c
    }

    .saved-project-actions .sp-del {
        border-color: #f87171;
        color: #f87171
    }

    .est-dup-btn {
        width: 100%;
        padding: 12px;
        margin-top: 12px;
        background: rgba(96, 165, 250, 0.08);
        border: 2px dashed rgba(96, 165, 250, 0.3);
        border-radius: 10px;
        color: #60a5fa;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px
    }

    .est-dup-btn:hover {
        background: rgba(96, 165, 250, 0.15);
        border-color: rgba(96, 165, 250, 0.5)
    }

    .est-save-btn {
        width: 100%;
        padding: 14px;
        margin-top: 16px;
        background: rgba(74, 222, 128, 0.08);
        border: 2px solid rgba(74, 222, 128, 0.3);
        border-radius: 10px;
        color: #4ade80;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px
    }

    .est-save-btn:hover {
        background: rgba(74, 222, 128, 0.15);
        border-color: rgba(74, 222, 128, 0.5)
    }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="supplier-catalog-data.js"></script>
    <script>
    (function() {
        // 
        //   CONFIG  Edit this section to customize for your business  
        // 
        var CONFIG = {
            brand: {
                name: 'Renova',
                mono: 'RN',
                tagline: 'Muebles a la Medida',
                altBrand: null, // e.g. { id:'alt', mono:'ALT', name:'OTRA MARCA', tagline:'Subtitulo' }
                // CUSTOMIZE: Legal terms for client PDF  edit these to match your business terms
                legalTerms: [
                    'ACUERDO:',
                    'Vigencia de cotizacion 15 dias naturales a partir de la fecha.',
                    'Tiempo de entrega de 6-8 semanas a partir de aprobacion del diseno y anticipo del 60%.',
                    'Se inicia el proyecto con anticipo del 60% y el saldo del 40% con muebles fabricados en taller previo a la instalacion.',
                    'Una vez realizado el pago del anticipo, no se podra realizar cancelacion de trabajos.',
                    'Cualquier alteracion y/o solicitud nueva al proyecto se cobrara aparte.',
                    '',
                    'INSTALACION:',
                    'El presupuesto incluye traslado en la ubicacion acordada, dentro de la Zona Metropolitana de Monterrey.',
                    'La instalacion NO incluye ajustes o cambios en trabajos que no se incluyan o que no correspondan al giro de la empresa previamente solicitado (instalaciones Electricas, Hidraulicas, Gas).',
                    'El horario de instalacion es de 9:00 am a 5:00 pm de Lunes a Viernes.',
                    'El espacio debe estar adecuado y libre para instalacion.',
                    '',
                    'MATERIALES:',
                    'La sobreexposicion al sol y rayos UV generan un deterioro indebido el cual no sera objeto de garantia. De igual manera la exposicion a exceso de humedad o fugas dentro del espacio.'
                ]
            },
            contact: {
                name: 'Renova',
                office: '00 0000-0000',
                cell: '00 0000-0000',
                email: 'contacto@miempresa.com',
                city: 'Tu Ciudad'
            },
            quoting: {
                prefix: 'COT',
                defaultDelivery: '6-8 semanas',
                defaultAnticipo: 60,
                terms: [
                    '{anticipo}% de anticipo, resto al programar la instalacion',
                    'El pago total debera estar cubierto al llegar a la obra',
                    'Tiempo de entrega: {deliveryTime} habiles a partir del anticipo',
                    'Incluye: fabricacion, transporte, instalacion y regulador',
                    'No incluye: instalaciones electricas, obra civil, plomeria',
                    'Instalaciones: Lun-Vie 9AM-5PM / Sab 9AM-1PM',
                    'Cotizacion vigente por 15 dias'
                ],
                htmlTerms: [
                    '{anticipo}% anticipo para iniciar',
                    'Resto al programar instalacion',
                    'Tiempo: {deliveryTime}',
                    'Incluye instalacion',
                    'NO incluye instalaciones electricas'
                ]
            },
            storage: {
                prefix: 'cot_'
            },
            pwa: {
                cacheName: 'cotizador-v5'
            },
            pricing: {
                iva: 0.16,
                marginCarp: 66,
                marginHwStd: 66,
                marginBlum: 0.30,
                // CUSTOMIZE: Material merma (waste) factor  1.20 = 20% extra material
                mermaFactor: 1.20,
                // CUSTOMIZE: Hardware pricing  items with total cost <= threshold go into carpentry bucket (3x multiplier), above threshold get premium margin (30%)
                carpentryMultiplier: 3,
                hardwareThreshold: 500,
                premiumHardwareMargin: 0.30,
                extrasMultiplier: 4,
                cuttingCostPerSheet: 75,
                glassCostPerM2: 800,
                defaultLaborCost: 5000,
                defaultFreightCost: 2000,
                defaultChapPrice: 13.10,
                defaultEnchapPrice: 13,
                defaultChapSpec: '1mm x 19mm ABS para refilar',
                saleMultiplierPresets: [1.5, 2, 2.5, 3],
                defaultSaleMultiplier: 2
            },
            // CUSTOMIZE: Bisagra auto-assignment rules  adjust count by door height and material
            hardware: {
                autoAssignRules: {
                    puertas: {
                        bisagras: [
                            { maxHeight: 100, count: 3 },
                            { maxHeight: 200, count: 4 },
                            { maxHeight: Infinity, count: 5 }
                        ],
                        heavyMaterialBonus: 1
                    }
                }
            },
            supabase: {
                url: '',
                key: ''
            },
            bundledProjects: []
        };

        // Helper: get bisagra count based on door height (cm) and material type
        function getBisagraCount(heightCm, materialType) {
            var rules = CONFIG.hardware.autoAssignRules.puertas;
            var count = 3; // default
            for (var i = 0; i < rules.bisagras.length; i++) {
                if (heightCm <= rules.bisagras[i].maxHeight) {
                    count = rules.bisagras[i].count;
                    break;
                }
            }
            if (materialType === 'vidrio' || materialType === 'metal') {
                count += rules.heavyMaterialBonus;
            }
            return count;
        }

        // 
        //   DEMO MATERIALS  Replace with real COLORS array when ready  
        //   To restore: delete this block and uncomment REAL block below
        // 
        var COLORS = [
            { c: 'D01', n: 'Roble Natural', f: 'Demo' },
            { c: 'D02', n: 'Nogal Oscuro', f: 'Demo' },
            { c: 'D03', n: 'Encino Blanco', f: 'Demo' },
            { c: 'D04', n: 'Cerezo Clasico', f: 'Demo' },
            { c: 'D05', n: 'Gris Cemento', f: 'Demo' },
            { c: 'D06', n: 'Negro Mate', f: 'Demo' },
            { c: 'D07', n: 'Blanco Polar', f: 'Demo' },
            { c: 'D08', n: 'Fresno Humo', f: 'Demo' },
            { c: 'D09', n: 'Olmo Toscano', f: 'Demo' },
            { c: 'D10', n: 'Maple Dorado', f: 'Demo' }
        ];
        var FINSA_PRICES = {
            16: 1200,
            25: 1700
        };
        /*  REAL COLORS (uncomment to restore) 
        var COLORS = [
        { c: '74V', n: 'Roble Stella', f: 'Atlas' },
        { c: '98V', n: 'Roble Aurora', f: 'Atlas' },
        { c: '42B', n: 'Roble Trigo', f: 'Atlas' },
        { c: '95Q', n: 'Roble Trufa', f: 'Atlas' },
        { c: '97V', n: 'Roble Colorado', f: 'Atlas' },
        { c: '4AE', n: 'Roble Eternity', f: 'Atlas' },
        { c: '04R', n: 'Olmo Volga', f: 'Atlas' },
        { c: '16N', n: 'Fresno Glacial', f: 'Atlas' },
        { c: '91B', n: 'Roble Renovales', f: 'Atlas' },
        { c: '10C', n: 'Cambridge Walnut', f: 'Atlas' },
        { c: '75V', n: 'Roble Azabache', f: 'Atlas' },
        { c: '20N', n: 'Roble Sinatra', f: 'Atlas' },
        { c: '9AR', n: 'Hickory Frida', f: 'Boreal' },
        { c: '4AR', n: 'Olmo Sabi', f: 'Boreal' },
        { c: '1AS', n: 'Nogal Valentina', f: 'Mesura' },
        { c: '451B', n: 'Roble Newman', f: 'Mesura' },
        { c: '07R', n: 'Olmo Ontario', f: 'Poro' },
        { c: '12G', n: 'Lino Cancun', f: 'Textil' },
        { c: '890', n: 'Aluminio', f: 'Soft' },
        { c: 'U12', n: 'Natural Grey', f: 'Soft' },
        { c: '197', n: 'Gris Rioja', f: 'Soft' },
        { c: '71A', n: 'Gris Gu', f: 'Soft' },
        { c: '231', n: 'Negro', f: 'Soft' },
        { c: '465B', n: 'Verde Plomo', f: 'Soft' },
        { c: '3AU', n: 'Verde Arcilla', f: 'Soft' }
        ];
        var FINSA_PRICES = { 16: 1000, 25: 1400 };
         END REAL COLORS  */
        // CUSTOMIZE: Project types  add/remove project categories for custom mode
        var TYPES = [{
            id: 'tv',
            n: 'Mueble de TV',
            i: '&#x1f4fa;'
        }, {
            id: 'credenza',
            n: 'Credenza',
            i: '&#x1f5c4;'
        }, {
            id: 'closet',
            n: 'Closet',
            i: '&#x1f454;'
        }, {
            id: 'cocina',
            n: 'Cocina',
            i: '&#x1f373;'
        }, {
            id: 'puerta',
            n: 'Puertas',
            i: '&#x1f6aa;'
        }, {
            id: 'otro',
            n: 'Otro',
            i: '&#x1f4e6;'
        }];
        // CUSTOMIZE: Module types  add new module types here (id, name, available widths, description)
        // Standard dimensions based on Mexico market
        var MODS = {
            // Closet modules  Prof: 55-60cm
            modulo: {
                n: 'Modulo',
                w: [70, 80, 90],
                d: 'Corredera oculta | Prof: 55-60cm'
            },
            colgador: {
                n: 'Colgador',
                w: [90],
                d: 'Tubo sencillo | Min 110cm alto (largo), 90cm (corto)'
            },
            zapatero: {
                n: 'Zapatero',
                w: [90],
                d: 'Extraible | 15-20cm por nivel'
            },
            esquinero: {
                n: 'Esquinero',
                w: [90],
                d: '90x90 L-shape'
            },
            entrepa: {
                n: 'Entrepaneras',
                w: [30, 40, 50, 60, 70, 80, 90, 100],
                d: 'Ajuste a medida',
                custom: 1
            },
            // TV modules  Prof: 40-50cm, Alto base: 45-55cm
            torreLateral: {
                n: 'Torre Lateral',
                w: [30, 40, 50, 60],
                d: 'Torre lateral | Prof: 40-50cm'
            },
            panelTV: {
                n: 'Panel para TV',
                w: [140, 170, 200, 240],
                d: 'Panel decorativo para TV'
            },
            moduloCentral: {
                n: 'Modulo Central',
                w: [80, 100, 120, 140],
                d: 'Modulo central TV | Prof: 40-50cm, Alto: 45-55cm'
            },
            lateralAbierto: {
                n: 'Lateral Abierto',
                w: [30, 40, 50, 60],
                d: 'Lateral abierto | 30-40cm ancho tipico'
            },
            // Cocina modules  Base: 60cm prof x 85-90cm alto | Alacena: 30-35cm prof x 70-90cm alto
            alacenaAlta: {
                n: 'Alacena Alta',
                w: [30, 45, 60, 90],
                d: 'Gabinete superior | Prof: 30-35cm, Alto: 70-90cm'
            },
            gabineteBase: {
                n: 'Gabinete Base',
                w: [30, 45, 60, 90],
                d: 'Gabinete inferior | Prof: 60cm, Alto: 85-90cm'
            },
            cajonBase: {
                n: 'Cajon Base',
                w: [30, 45, 60, 90],
                d: 'Base con cajones | Prof: 60cm, Alto: 85-90cm'
            },
            despensa: {
                n: 'Despensa',
                w: [40, 50, 60],
                d: 'Mueble despensa alto | Prof: 60cm'
            },
            espacioCampana: {
                n: 'Espacio Campana',
                w: [60, 70, 80, 90],
                d: 'Espacio campana | Min 60cm ancho, Prof: 50-65cm'
            },
            esquineroGiratorio: {
                n: 'Esquinero Giratorio',
                w: [90],
                d: 'Esquinero con charola giratoria'
            },
            // Cocina Bajos  Prof: 58cm, Alto casco: 72cm, Alto total: 85-90cm con patas y cubierta
            bajoEstandar: {
                n: 'Bajo Estandar',
                w: [30, 40, 45, 50, 60, 75, 80, 90, 100],
                d: 'Gabinete base 1-2 puertas | Prof: 58cm, Alto: 72cm'
            },
            fregadero: {
                n: 'Fregadero',
                w: [60, 75, 80, 90],
                d: 'Sin techo, 2 amarres, saque trasero | Prof: 58cm'
            },
            cajonera: {
                n: 'Cajonera',
                w: [30, 40, 45, 50, 60, 75, 80, 90],
                d: '2-4 cajones Blum Tandem | Prof: 58cm'
            },
            esquineroCiego: {
                n: 'Esquinero Ciego',
                w: [90],
                d: 'Esquinero 90x90 ciego o en L (165\u00b0)'
            },
            hornoBase: {
                n: 'Horno Base',
                w: [60, 75, 90],
                d: 'Nicho horno 595mm + caj\u00f3n inferior'
            },
            // Puertas  Ancho: 80-90cm (int), 100cm (principal) | Alto: 200, 210, 240cm
            puerta: {
                n: 'Puerta',
                w: [80, 90, 100],
                d: 'Puerta individual | >100cm ancho = doble',
                panel: true
            }
        };

        // 
        //   DEMO HARDWARE  Replace with real HW_DEFAULTS when ready       
        //   To restore: delete this block and uncomment REAL block below    
        //   Demo prices are round numbers, ~15-35% above typical cost      
        // 
        var HW_DEFAULTS = {
            corr_oculta: {
                desc: 'Corredera oculta soft-close',
                marca: 'DEMO',
                fallback: 300,
                cat: 'CORREDERA'
            },
            bisagra: {
                desc: 'Bisagra de cierre suave',
                marca: 'DEMO',
                fallback: 20,
                cat: 'BISAGRA'
            },
            base_clip: {
                desc: 'Base clip para bisagra',
                marca: 'DEMO',
                fallback: 5,
                cat: 'BISAGRA'
            },
            tipon: {
                desc: 'Sistema push-to-open',
                marca: 'DEMO',
                fallback: 110,
                cat: 'TIP-ON'
            },
            jaladera: {
                desc: 'Jaladera moderna',
                marca: 'DEMO',
                fallback: 20,
                cat: 'JALADERA'
            }
        };
        // Keys needed by auto-assignment but not in demo  add minimal fallbacks
        if (!HW_DEFAULTS.corr_eco) HW_DEFAULTS.corr_eco = { desc: 'Corredera economica', marca: 'DEMO', fallback: 60, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.corr_prem) HW_DEFAULTS.corr_prem = { desc: 'Corredera premium', marca: 'DEMO', fallback: 120, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.corr_basica) HW_DEFAULTS.corr_basica = { desc: 'Corredera basica', marca: 'DEMO', fallback: 25, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.placa_tipon) HW_DEFAULTS.placa_tipon = { desc: 'Placa tip-on', marca: 'DEMO', fallback: 25, cat: 'TIP-ON' };
        if (!HW_DEFAULTS.tubo) HW_DEFAULTS.tubo = { desc: 'Tubo colgador', marca: 'DEMO', fallback: 150, cat: 'ACC. CLOSET' };
        if (!HW_DEFAULTS.soporte) HW_DEFAULTS.soporte = { desc: 'Soporte tubo', marca: 'DEMO', fallback: 45, cat: 'ACC. CLOSET' };
        if (!HW_DEFAULTS.nivelador) HW_DEFAULTS.nivelador = { desc: 'Nivelador', marca: 'DEMO', fallback: 6, cat: 'NIVELADOR' };
        // Cocina bajo hardware  patas, zoclo, Blum Tandem, bisagra 165 para esquinero
        if (!HW_DEFAULTS.pata) HW_DEFAULTS.pata = { desc: 'Pata regulable cocina', marca: 'DEMO', fallback: 35, cat: 'ACC. COCINA' };
        if (!HW_DEFAULTS.zoclo_clip) HW_DEFAULTS.zoclo_clip = { desc: 'Clip zoclo cocina', marca: 'DEMO', fallback: 8, cat: 'ACC. COCINA' };
        if (!HW_DEFAULTS.corr_tandem) HW_DEFAULTS.corr_tandem = { desc: 'Corredera Blum Tandem soft-close', marca: 'DEMO', fallback: 350, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.bisagra_165) HW_DEFAULTS.bisagra_165 = { desc: 'Bisagra 165\u00b0 esquinero', marca: 'DEMO', fallback: 45, cat: 'BISAGRA' };
        /*  REAL HW_DEFAULTS (uncomment to restore) 
        var HW_DEFAULTS = {
            corr_eco: { desc: 'Corredera ext total ecoline', marca: 'HERRAXA', fallback: 49.90, cat: 'CORREDERA' },
            corr_prem: { desc: 'Corredera ext total soft close', marca: 'HERRAXA', fallback: 99.90, cat: 'CORREDERA' },
            corr_oculta: { desc: 'Guia TDM oculta soft', marca: 'HERRAXA', fallback: 249.90, cat: 'CORREDERA' },
            corr_basica: { desc: 'Corredera ext lateral basica', marca: 'HERRAXA', fallback: 20.90, cat: 'CORREDERA' },
            bisagra: { desc: 'Bisagra bastidor', marca: 'HERRAXA', fallback: 16.90, cat: 'BISAGRA' },
            base_clip: { desc: 'Base clip', marca: 'HERRAXA', fallback: 4.18, cat: 'BISAGRA' },
            tipon: { desc: 'Tip on corto gris', marca: 'HERRAXA', fallback: 88.38, cat: 'TIP-ON' },
            placa_tipon: { desc: 'Placa para tip on recta', marca: 'HERRAXA', fallback: 20.18, cat: 'TIP-ON' },
            jaladera: { desc: 'Jaladera', marca: 'HERRAXA', fallback: 15.00, cat: 'JALADERA' },
            tubo: { desc: 'Tubo colgador', marca: 'HERRAXA', fallback: 120.00, cat: 'ACC. CLOSET' },
            soporte: { desc: 'Soporte tubo', marca: 'HERRAXA', fallback: 35.00, cat: 'ACC. CLOSET' },
            nivelador: { desc: 'Nivelador', marca: 'HERRAXA', fallback: 5.00, cat: 'NIVELADOR' },
            pata: { desc: 'Pata regulable cocina 100-150mm', marca: 'HERRAXA', fallback: 28.00, cat: 'ACC. COCINA' },
            zoclo_clip: { desc: 'Clip fijacion zoclo', marca: 'HERRAXA', fallback: 6.50, cat: 'ACC. COCINA' },
            corr_tandem: { desc: 'Blum Tandem cierre suave', marca: 'HERRAXA', fallback: 289.00, cat: 'CORREDERA' },
            bisagra_165: { desc: 'Bisagra 165 grados esquinero', marca: 'HERRAXA', fallback: 38.00, cat: 'BISAGRA' }
        };
         END REAL HW_DEFAULTS  */

        // V2.3: Closet Estandarizado constants
        var EST_HEIGHT = 200,
            EST_DEPTH = 60,
            EST_WIDTHS = [60, 70, 80, 90];
        var EST_CAJON_HEIGHTS = [10, 15, 20, 25, 30, 35, 40, 45, 50];
        var EST_ZAPATERO_HEIGHTS = [10, 12, 15, 18, 20, 25];
        // CUSTOMIZE: Zone types for estandarizado mode  add new zone types here
        var EST_ZONE_TYPES = [
        {
            id: 'cajones',
            n: 'Cajones',
            icon: '&#x1f4e6;'
        },
        {
            id: 'colgador',
            n: 'Colgador',
            icon: '&#x1f455;'
        },
        {
            id: 'zapatero',
            n: 'Zapatero',
            icon: '&#x1f45f;',
            sub: 'Caj\u00f3n extra\u00edble'
        },
        {
            id: 'entrepa',
            n: 'Entrepa\u00f1os',
            icon: '&#x1f4da;'
        },
        {
            id: 'maletero',
            n: 'Maleteros',
            icon: '&#x1f9f3;',
            hidden: true
        },
        // Cocina zone types
        {
            id: 'alacenaAlta',
            n: 'Alacena Alta',
            icon: '&#x1f3e0;'
        },
        {
            id: 'gabineteBase',
            n: 'Gabinete Base',
            icon: '&#x1f3e0;'
        },
        {
            id: 'cajonBase',
            n: 'Cajon Base',
            icon: '&#x1f4e6;'
        },
        {
            id: 'despensa',
            n: 'Despensa',
            icon: '&#x1f3e0;'
        },
        {
            id: 'espacioCampana',
            n: 'Espacio Campana',
            icon: '&#x1f32c;'
        },
        {
            id: 'esquineroGiratorio',
            n: 'Esquinero Giratorio',
            icon: '&#x1f504;'
        }
        ];
        var EST_ZONE_DEFAULTS = {
            colgador_single: 100,
            colgador_double: 190,
            entrepa_h: 3,
            zapatero_repisa: 15,
            structure_overhead: 3.2
        };

        // CUSTOMIZE: Estandarizado module defaults  adjust default widths, zones per module type
        function defaultEstModule(modType) {
            if (modType === 'esquinero')
                return {
                    id: uid(),
                    type: 'esquinero',
                    width: 90,
                    width2: 90,
                    height: 200,
                    zones: [{
                        id: uid(),
                        type: 'colgador',
                        tubos: 1
                    }, {
                        id: uid(),
                        type: 'entrepa',
                        count: 2
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            if (modType === 'especial')
                return {
                    id: uid(),
                    type: 'especial',
                    width: 40,
                    height: 200,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 3
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            if (modType === 'fijo')
                return {
                    id: uid(),
                    type: 'fijo',
                    width: 30,
                    height: 20,
                    zones: [],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            if (modType === 'panelTV')
                return {
                    id: uid(),
                    type: 'panelTV',
                    width: 180,
                    height: 200,
                    zones: [],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            if (modType === 'torreLateral')
                return {
                    id: uid(),
                    type: 'torreLateral',
                    width: 50,
                    height: 200,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 3
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            // Cocina: Alacena Alta (upper cabinet)
            if (modType === 'alacenaAlta')
                return {
                    id: uid(),
                    type: 'alacenaAlta',
                    width: 60,
                    height: 70,
                    depth: 35,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 2
                    }],
                    doors: true,
                    doorMode: 'completo',
                    doorType: 'bisagra',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: false, height: 10 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            // Cocina: Gabinete Base (lower cabinet)
            if (modType === 'gabineteBase')
                return {
                    id: uid(),
                    type: 'gabineteBase',
                    width: 60,
                    height: 85,
                    depth: 60,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 1
                    }],
                    doors: true,
                    doorMode: 'completo',
                    doorType: 'bisagra',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: true, height: 10 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            // Cocina: Cajon Base (drawer base)
            if (modType === 'cajonBase')
                return {
                    id: uid(),
                    type: 'cajonBase',
                    width: 60,
                    height: 85,
                    depth: 60,
                    zones: [{
                        id: uid(),
                        type: 'cajones',
                        count: 4
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 0,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: true, height: 10 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            // Cocina: Despensa (tall pantry)
            if (modType === 'despensa')
                return {
                    id: uid(),
                    type: 'despensa',
                    width: 60,
                    height: 200,
                    depth: 60,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 5
                    }],
                    doors: true,
                    doorMode: 'completo',
                    doorType: 'bisagra',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: true, height: 10 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            // Puerta (standalone door)
            if (modType === 'puerta')
                return {
                    id: uid(),
                    type: 'puerta',
                    width: 90,
                    height: 210,
                    depth: 4,
                    zones: [],
                    doors: true,
                    doorMode: 'completo',
                    doorType: 'bisagra',
                    doorCount: 1,
                    doorMaterial: 'melamina',
                    marco: true,
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: false, height: 0 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            return {
                id: uid(),
                type: 'normal',
                width: 80,
                height: 200,
                zones: [{
                    id: uid(),
                    type: 'colgador',
                    tubos: 1
                }],
                doors: false,
                doorMode: 'por_zona',
                doorType: 'tipon',
                doorCount: 2,
                doorMaterial: 'melamina',
                chap: {
                    mode: 'perimetrico',
                    edges: {
                        latIzq: true,
                        latDer: true,
                        techo: true,
                        piso: true,
                        fondo: false
                    }
                },
                led: null,
                zoclo: {
                    enabled: false,
                    height: 10
                },
                maletero: {
                    enabled: false,
                    height: 30
                },
                quoteMode: 'completo',
                paint: {
                    enabled: false,
                    name: '',
                    pricePerLiter: 0,
                    coats: 2,
                    scope: 'doors'
                }
            };
        }
        function defaultEstProject() {
            return {
                mode: 'estandarizado',
                projectDepth: 60,
                sameDepth: true,
                projectType: '',
                client: '',
                sameMaterial: true,
                matFrentes: defaultMat(),
                matInterior: defaultMat(),
                chapFrentesPrice: CONFIG.pricing.defaultChapPrice,
                chapInteriorPrice: CONFIG.pricing.defaultChapPrice,
                enchapPrice: CONFIG.pricing.defaultEnchapPrice,
                thickness: 16,
                modules: [],
                hardware: [],
                hwOverrides: {},
                planoImage: null,
                ledConfig: {
                    activation: 'dimmer',
                    lightTemp: 'calida'
                },
                saleMultiplier: CONFIG.pricing.defaultSaleMultiplier,
                laborCost: CONFIG.pricing.defaultLaborCost,
                freight: true,
                freightCost: CONFIG.pricing.defaultFreightCost,
                chapSpec: CONFIG.pricing.defaultChapSpec
            };
        }

        // LED component catalog (Hfele LOOX5 system)
        var LED_CATALOG = {
            alimentadores: [
            {
                w: 20,
                desc: 'Alimentador LOOX5 24V 20W',
                price: 412.27
            },
            {
                w: 40,
                desc: 'Alimentador LOOX5 24V 40W',
                price: 1026.17
            },
            {
                w: 60,
                desc: 'Alimentador LOOX5 24V 60W',
                price: 1371.96
            },
            {
                w: 90,
                desc: 'Alimentador LOOX5 24V 90W',
                price: 1681.19
            }
            ],
            fixed: {
                cable_primario: {
                    desc: 'Cable primario US/Csa 250V 2000mm',
                    price: 150.00
                },
                distribuidor: {
                    desc: 'Distribuidor 6 vias 24V c/conmutacion',
                    price: 205.01
                },
                cable_interruptor: {
                    desc: 'Cable alim interruptor modular',
                    price: 113.96
                },
                placa_montaje: {
                    desc: 'Placa montaje interruptor',
                    price: 26.41
                }
            },
            switches: {
                presion: {
                    desc: 'Interruptor presion embutir negro 2000mm',
                    price: 109.63
                },
                dimmer: {
                    desc: 'Interruptor dimmer sin contacto',
                    price: 142.64
                },
                movimiento: {
                    desc: 'Interruptor sensor movimiento',
                    price: 98.24
                },
                puerta: {
                    desc: 'Interruptor puerta embutir/montar gris',
                    price: 410.44
                }
            },
            variable: {
                tira_calida: {
                    desc: 'Tira LED 3103 24V 5m Calida 3000K',
                    price: 1332.27,
                    length: 5
                },
                tira_fria: {
                    desc: 'Tira LED 3103 24V 5m Fria 5000K',
                    price: 1332.28,
                    length: 5
                },
                cable_alim_tira: {
                    desc: 'Cable alimentador 24V 2000mm tira 8mm',
                    price: 110.07
                },
                perfil_embutir: {
                    desc: 'Perfil embutir 1103 AL 11.5mm 3000mm',
                    price: 521.12,
                    length: 3
                },
                cable_extension: {
                    desc: 'Cable extension LOOX5 24V 2000mm',
                    price: 129.94
                },
                regleta_extra: {
                    desc: 'Regleta LOOX5 6 puertos 24V',
                    price: 115.26
                }
            },
            wattsPerMeter: 4.8,
            headroom: 1.2
        };

        // CUSTOMIZE: Templates  add/modify quick-quote templates (base price, dimensions, modules)
        var TEMPLATES = [
        {
            id: 'tv-panel-credenza',
            name: 'Muro TV con Credenza Nogal',
            photo: 'data-closets/pic38-closet.jpeg',
            type: 'tv',
            desc: 'Panel liso con ranuras decorativas y credenza',
            baseWidth: 360,
            baseHeight: 260,
            material: 'Nogal Claro Alto Brillo',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 24500,
            weeks: 5,
            laborCost: 4000,
            preModules: [{
                type: 'panelTV',
                width: 240
            }, {
                type: 'entrepa',
                width: 100,
                shelves: 4,
                doors: true
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'cocina-loft',
            name: 'Cocina Loft',
            photo: 'data-closets/pic37-closet.jpeg',
            type: 'cocina',
            desc: 'Diseno moderno negro mate + nogal con cubierta de cuarzo',
            baseWidth: 320,
            baseHeight: 240,
            material: 'Negro mate + Nogal',
            matCode: '231',
            matName: 'Negro',
            matFinish: 'Soft',
            basePrice: 95000,
            weeks: 4,
            laborCost: 12000,
            preModules: [{
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'entrepa',
                width: 80,
                shelves: 5,
                doors: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'closet-europeo',
            name: 'Closet Europeo con Espejo',
            photo: 'data-closets/pic40-closet.jpeg',
            type: 'closet',
            desc: 'Closet con espejo ahumado, color personalizable',
            baseWidth: 240,
            baseHeight: 240,
            material: 'Nogal + Espejo ahumado',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 38000,
            weeks: 4,
            laborCost: 6000,
            preModules: [{
                type: 'colgador',
                width: 90
            }, {
                type: 'modulo',
                width: 80,
                cajones: 4
            }, {
                type: 'entrepa',
                width: 70,
                shelves: 5
            }]
        },
        {
            id: 'tv-nogal-torres',
            name: 'Mueble TV Nogal con Torres',
            photo: 'data-closets/pic41-closet.jpeg',
            type: 'tv',
            desc: 'Panel TV central, 2 torres laterales, credenza base',
            baseWidth: 300,
            baseHeight: 240,
            material: 'Nogal melamina europea',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 42000,
            weeks: 5,
            laborCost: 6000,
            preModules: [{
                type: 'panelTV',
                width: 200
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 3
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 3
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'tv-premium-led',
            name: 'Mueble TV Premium LED + Vidrio',
            photo: 'data-closets/pic11-closet.jpeg',
            type: 'tv',
            desc: '2 torres con vidrio templado, credenza 6 puertas, panel TV, LED',
            baseWidth: 295,
            baseHeight: 240,
            material: 'Melamina europea cedro/nogal',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 55500,
            weeks: 5,
            laborCost: 8000,
            hasLed: true,
            hasGlass: true,
            preModules: [{
                type: 'panelTV',
                width: 200
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 4,
                doors: true
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 4,
                doors: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true,
                tipon: true
            }]
        }
        ];

        // Catalog helpers
        function getCatalog() {
            return typeof CATALOG !== 'undefined' ? CATALOG : [];
        }
        function getAraucoTableros() {
            return getCatalog().filter(function(i) {
                return i.categoria === 'TABLERO' && i.marca === 'ARAUCO';
            });
        }
        function getChapacanto() {
            return getCatalog().filter(function(i) {
                return i.categoria === 'CHAPACANTO';
            });
        }
        function findCatItem(searchDesc, marca) {
            var cat = getCatalog(),
                best = null,
                bestScore = 0;
            var terms = searchDesc.toLowerCase().split(/\s+/);
            cat.forEach(function(item) {
                if (marca && item.marca !== marca)
                    return;
                var d = item.descripcion.toLowerCase(),
                    score = 0;
                terms.forEach(function(t) {
                    if (d.indexOf(t) >= 0)
                        score++;
                });
                if (score > bestScore) {
                    bestScore = score;
                    best = item;
                }
            });
            return best;
        }
        function adjPrice(item) {
            if (!item)
                return 0;
            var adj = S.settings.supplierAdj[item.marca] || 0;
            return item.precio * (1 + adj / 100);
        }
        function getHWCats() {
            var cats = {};
            getCatalog().forEach(function(i) {
                if (i.categoria !== 'TABLERO' && i.categoria !== 'CHAPACANTO')
                    cats[i.categoria] = 1;
            });
            return Object.keys(cats).sort();
        }
        function getHWMarcas() {
            var m = {};
            getCatalog().forEach(function(i) {
                if (i.categoria !== 'TABLERO' && i.categoria !== 'CHAPACANTO')
                    m[i.marca] = 1;
            });
            return Object.keys(m).sort();
        }
        function filterHW() {
            var f = S.hwFilter,
                items = getCatalog().filter(function(i) {
                    if (i.categoria === 'TABLERO' || i.categoria === 'CHAPACANTO')
                        return false;
                    if (f.marca && i.marca !== f.marca)
                        return false;
                    if (f.cat && i.categoria !== f.cat)
                        return false;
                    if (f.q) {
                        var q = f.q.toLowerCase();
                        if (i.descripcion.toLowerCase().indexOf(q) < 0 && i.codigo.toLowerCase().indexOf(q) < 0)
                            return false;
                    }
                    return true;
                });
            return items.slice(0, 60);
        }

        function defaultMat() {
            return {
                brand: 'FINSA',
                code: COLORS[0].c,
                name: COLORS[0].n,
                finish: COLORS[0].f,
                precio: FINSA_PRICES[16],
                thickness: 16
            };
        }

        // Brands (derived from CONFIG)
        var BRANDS = {};
        BRANDS.primary = { id:'primary', mono:CONFIG.brand.mono, name:CONFIG.brand.name, tagline:CONFIG.brand.tagline };
        if (CONFIG.brand.altBrand) { var a = CONFIG.brand.altBrand; BRANDS[a.id] = a; }
        var CONTACT = {
            name: CONFIG.contact.name,
            office: CONFIG.contact.office,
            cell: CONFIG.contact.cell,
            email: CONFIG.contact.email,
            city: CONFIG.contact.city
        };

        // Load persisted data
        var savedLogo = null;
        try {
            savedLogo = localStorage.getItem(CONFIG.storage.prefix + 'logo_base64');
        } catch (e) {}
        var savedCounter = 1;
        try {
            var sc = localStorage.getItem(CONFIG.storage.prefix + 'quote_counter');
            if (sc)
                savedCounter = parseInt(sc) || 1;
        } catch (e) {}
        var savedBrand = 'primary';
        try {
            var sb = localStorage.getItem(CONFIG.storage.prefix + 'brand');
            if (sb && BRANDS[sb])
                savedBrand = sb;
        } catch (e) {}

        // State
        var S = {
            screen: 'templates',
            selTemplate: null,
            quickWidth: 0,
            quickHeight: 0,
            quickMat: '',
            quickMatName: '',
            quickMatFinish: '',
            waCopied: false,
            imgModal: null,
            step: 1,
            view: 'quote',
            copied: false,
            showHWPicker: false,
            hwFilter: {
                marca: '',
                cat: '',
                q: ''
            },
            showSettings: false,
            showCostBreakdown: false,
            brand: savedBrand,
            logoBase64: savedLogo,
            quoteCounter: savedCounter,
            pdfData: null,
            settings: {
                marginCarp: CONFIG.pricing.marginCarp,
                marginHwStd: CONFIG.pricing.marginHwStd,
                marginBlum: CONFIG.pricing.marginBlum * 100,
                marginPreset: 'estandar',
                supplierAdj: {
                    ARAUCO: 0,
                    HERRAXA: 0,
                    BLUM: 0,
                    HAFELE: 0,
                    DEMO: 0
                }
            },
            project: {
                client: '',
                type: '',
                sameMaterial: true,
                matFrentes: defaultMat(),
                matInterior: defaultMat(),
                chapFrentesPrice: CONFIG.pricing.defaultChapPrice,
                chapInteriorPrice: CONFIG.pricing.defaultChapPrice,
                thickness: 16,
                modules: [],
                hardware: [],
                ledConfig: {
                    activation: 'dimmer',
                    lightTemp: 'calida'
                },
                glass: false,
                glassM2: 0,
                laborCost: CONFIG.pricing.defaultLaborCost,
                freight: true,
                freightCost: CONFIG.pricing.defaultFreightCost,
                defaultHeight: 200,
                defaultDepth: 50,
                sameDepth: true,
                chapSpec: CONFIG.pricing.defaultChapSpec
            },
            editedPieces: {},
            // V2.3: Estandarizado state
            estScreen: 'builder',
            estEditIdx: -1,
            estProject: defaultEstProject(),
            estPdfData: null,
            estHwSwapKey: null
        };
        var scrollY = 0;

        // Utilities
        function $(id) {
            return document.getElementById(id);
        }
        function fmt(n) {
            return '$' + Math.round(n).toLocaleString('es-MX');
        }
        function fmtD(n) {
            return '$' + n.toLocaleString('es-MX', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        function uid() {
            return Math.random().toString(36).substr(2, 9);
        }
        function date() {
            return new Date().toLocaleDateString('es-MX', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }
        var BUNDLED_PROJECTS = CONFIG.bundledProjects;
        /* BUNDLED_PROJECTS_REMOVED: Original demo project data was here.
           To bundle demo projects, add them to CONFIG.bundledProjects array. */
        // === SUPABASE CLOUD STORAGE ===
        var SB_URL = CONFIG.supabase.url;
        var SB_KEY = CONFIG.supabase.key;
        var sb = null;
        try {
            if (SB_URL && SB_KEY) sb = window.supabase.createClient(SB_URL, SB_KEY);
        } catch (e) {
            console.warn('Supabase not available, using localStorage only');
        }
        var cloudProjects = null; // null=not loaded yet, []=loaded

        function loadSavedProjects() {
            // Return cached cloud data if available, else localStorage fallback
            if (cloudProjects !== null) {
                var merged = cloudProjects.slice();
                BUNDLED_PROJECTS.forEach(function(bp) {
                    var exists = merged.some(function(p) {
                        return p.id === bp.id;
                    });
                    if (!exists)
                        merged.push(bp);
                });
                return merged;
            }
            try {
                var local = JSON.parse(localStorage.getItem(CONFIG.storage.prefix + 'saved_projects') || '[]');
                BUNDLED_PROJECTS.forEach(function(bp) {
                    var exists = local.some(function(lp) {
                        return lp.id === bp.id;
                    });
                    if (!exists)
                        local.push(bp);
                });
                return local;
            } catch (e) {
                return BUNDLED_PROJECTS.slice();
            }
        }
        function saveSavedProjects(arr) {
            try {
                localStorage.setItem(CONFIG.storage.prefix + 'saved_projects', JSON.stringify(arr));
            } catch (e) {}
        }

        // Fetch all projects from Supabase
        function cloudFetchProjects() {
            if (!sb)
                return;
            sb.from('projects').select('*').order('updated_at', {
                ascending: false
            }).then(function(res) {
                if (res.error) {
                    console.error('Supabase fetch error:', res.error);
                    return;
                }
                cloudProjects = (res.data || []).map(function(row) {
                    var d = row.data || {};
                    return {
                        id: row.id,
                        savedAt: row.updated_at,
                        client: row.client || d.client || '',
                        label: (d.mode === 'custom' ? 'Proyecto Personalizado' : 'Closet Estandarizado') + ' - ' + (d.modules ? d.modules.length : 0) + ' modulo' + (d.modules && d.modules.length !== 1 ? 's' : ''),
                        moduleCount: d.modules ? d.modules.length : 0,
                        project: d
                    };
                });
                // Also cache to localStorage
                saveSavedProjects(cloudProjects);
                render();
            });
        }

        // Save one project to Supabase (upsert)
        function cloudSaveProject(entry) {
            if (!sb)
                return;
            var row = {
                id: entry.id,
                name: entry.label || '',
                client: entry.client || '',
                type: entry.project ? entry.project.projectType || '' : '',
                mode: entry.project ? entry.project.mode || 'est' : '',
                data: entry.project,
                updated_at: new Date().toISOString()
            };
            sb.from('projects').upsert(row, {
                onConflict: 'id'
            }).then(function(res) {
                if (res.error)
                    console.error('Supabase save error:', res.error);
                else
                    cloudFetchProjects(); // refresh list
            });
        }

        // Delete one project from Supabase
        function cloudDeleteProject(id) {
            if (!sb)
                return;
            sb.from('projects').delete().eq('id', id).then(function(res) {
                if (res.error)
                    console.error('Supabase delete error:', res.error);
                else
                    cloudFetchProjects();
            });
        }

        // Initial load from cloud
        cloudFetchProjects();
        function isDualType(t) {
            return t === 'closet' || t === 'cocina';
        }

        function svg(name) {
            var paths = {
                plus: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
                trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
                left: '<polyline points="15 18 9 12 15 6"/>',
                right: '<polyline points="9 18 15 12 9 6"/>',
                file: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>',
                clip: '<path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>',
                copy: '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>',
                check: '<polyline points="20 6 9 17 4 12"/>',
                x: '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
                dollar: '<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
                layers: '<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
                users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>',
                zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
                settings: '<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>',
                pkg: '<line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>',
                edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>',
                lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
                search: '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
                chevDown: '<polyline points="6 9 12 15 18 9"/>'
            };
            return '<svg viewBox="0 0 24 24">' + (paths[name] || '') + '</svg>';
        }

        function marcaClass(m) {
            return 'marca-' + (m || '').toLowerCase();
        }
        function anchoLargo(w, h) {
            return {
                ancho: Math.min(w, h),
                largo: Math.max(w, h)
            };
        }

        // Get material price per sheet
        function getMatPrice(mat, thickness) {
            if (!mat)
                return FINSA_PRICES[thickness] || FINSA_PRICES[16] || 850;
            if (mat.brand === 'CUSTOM')
                return mat.customPrice || 0;
            if (mat.brand === 'FINSA')
                return FINSA_PRICES[thickness] || (thickness > 20 ? FINSA_PRICES[25] : FINSA_PRICES[16]) || 850;
            if (mat.brand === 'ARAUCO' && mat.catItem)
                return adjPrice(mat.catItem);
            return mat.precio || 850;
        }

        // === LED BOM Calculator ===
        function calcModuleLedMeters(m) {
            var P = S.project,
                led = m.led;
            if (!led || !led.enabled)
                return {
                    meters: 0,
                    segments: 0
                };
            var w = m.width / 100,
                h = (m.height || P.defaultHeight || 200) / 100;
            var meters = 0,
                segments = 0;
            if (led.edges.top) {
                meters += w;
                segments++;
            }
            if (led.edges.bottom) {
                meters += w;
                segments++;
            }
            if (led.edges.left) {
                meters += h;
                segments++;
            }
            if (led.edges.right) {
                meters += h;
                segments++;
            }
            if (led.edges.shelves && led.shelfCount > 0) {
                meters += led.shelfCount * w;
                segments += led.shelfCount;
            }
            return {
                meters: Math.round(meters * 100) / 100,
                segments: segments
            };
        }

        function calcLedBOM() {
            var P = S.project,
                totalMeters = 0,
                totalSegments = 0,
                hasLed = false;
            P.modules.forEach(function(m) {
                if (!m.led || !m.led.enabled)
                    return;
                hasLed = true;
                var auto = calcModuleLedMeters(m);
                m.led.ledMeters = auto.meters;
                m.led.segments = auto.segments;
                var usedMeters = (m.led.metersOverride !== null && m.led.metersOverride >= 0) ? m.led.metersOverride : auto.meters;
                var usedSegments = (m.led.segmentsOverride !== null && m.led.segmentsOverride >= 0) ? m.led.segmentsOverride : auto.segments;
                totalMeters += usedMeters;
                totalSegments += usedSegments;
            });
            if (!hasLed)
                return null;
            var LC = LED_CATALOG,
                items = [];
            // Variable components
            var tiraKey = P.ledConfig.lightTemp === 'fria' ? 'tira_fria' : 'tira_calida';
            var tiraInfo = LC.variable[tiraKey];
            var tiraQty = Math.max(1, Math.ceil(totalMeters / tiraInfo.length));
            items.push({
                desc: tiraInfo.desc,
                qty: tiraQty,
                unitPrice: tiraInfo.price,
                total: tiraQty * tiraInfo.price,
                type: 'variable'
            });
            var cableAlimQty = Math.max(1, totalSegments);
            items.push({
                desc: LC.variable.cable_alim_tira.desc,
                qty: cableAlimQty,
                unitPrice: LC.variable.cable_alim_tira.price,
                total: cableAlimQty * LC.variable.cable_alim_tira.price,
                type: 'variable'
            });
            var perfilQty = Math.max(1, Math.ceil(totalMeters / LC.variable.perfil_embutir.length));
            items.push({
                desc: LC.variable.perfil_embutir.desc,
                qty: perfilQty,
                unitPrice: LC.variable.perfil_embutir.price,
                total: perfilQty * LC.variable.perfil_embutir.price,
                type: 'variable'
            });
            var extQty = Math.max(1, Math.ceil(totalMeters / 4));
            items.push({
                desc: LC.variable.cable_extension.desc,
                qty: extQty,
                unitPrice: LC.variable.cable_extension.price,
                total: extQty * LC.variable.cable_extension.price,
                type: 'variable'
            });
            // Extra distributors if >6 segments
            if (totalSegments > 6) {
                var extraDist = Math.ceil((totalSegments - 6) / 6);
                items.push({
                    desc: LC.variable.regleta_extra.desc,
                    qty: extraDist,
                    unitPrice: LC.variable.regleta_extra.price,
                    total: extraDist * LC.variable.regleta_extra.price,
                    type: 'variable'
                });
            }
            // Fixed kit
            items.push({
                desc: LC.fixed.distribuidor.desc,
                qty: 1,
                unitPrice: LC.fixed.distribuidor.price,
                total: LC.fixed.distribuidor.price,
                type: 'fixed'
            });
            // Alimentador sizing
            var totalWatts = totalMeters * LC.wattsPerMeter * LC.headroom;
            var alim = LC.alimentadores[LC.alimentadores.length - 1];
            for (var i = 0; i < LC.alimentadores.length; i++) {
                if (totalWatts <= LC.alimentadores[i].w) {
                    alim = LC.alimentadores[i];
                    break;
                }
            }
            items.push({
                desc: alim.desc,
                qty: 1,
                unitPrice: alim.price,
                total: alim.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_primario.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_primario.price,
                total: LC.fixed.cable_primario.price,
                type: 'fixed'
            });
            // Switch
            var sw = LC.switches[P.ledConfig.activation] || LC.switches.dimmer;
            items.push({
                desc: sw.desc,
                qty: 1,
                unitPrice: sw.price,
                total: sw.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_interruptor.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_interruptor.price,
                total: LC.fixed.cable_interruptor.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.placa_montaje.desc,
                qty: 1,
                unitPrice: LC.fixed.placa_montaje.price,
                total: LC.fixed.placa_montaje.price,
                type: 'fixed'
            });
            var totalCost = items.reduce(function(a, it) {
                return a + it.total;
            }, 0);
            return {
                items: items,
                totalCost: totalCost,
                totalMeters: totalMeters,
                totalSegments: totalSegments,
                totalWatts: totalWatts,
                alimentadorW: alim.w
            };
        }

        // === calculateParts: Generic piece-generation engine ===
        // Called by calc() and future calc engines to generate cut pieces for any module type.
        // moduleType: string matching MODS keys (e.g. 'modulo', 'colgador', 'zapatero', 'esquinero', 'entrepa', etc.)
        // dimensions: { w: mm, h: mm, d: mm, w2: mm (optional, for esquinero/esquineroGiratorio) }
        // materials: { thickness: number (16 or 25), cajones: number, shelves: number,
        //              quoteMode: string, corrTier: string, marco: bool, materialType: string }
        // Returns: array of { n, q, w, h, t, c, z }   (no mid/mn/mw  caller stamps those)
        function calculateParts(moduleType, dimensions, materials) {
            var w  = dimensions.w;
            var h  = dimensions.h;
            var d  = dimensions.d;
            var w2 = dimensions.w2 !== undefined ? dimensions.w2 : w;
            var TK = materials.thickness || 16;
            var pieces  = [];

            if (moduleType === 'modulo') {
                // Closet drawer/shelf module
                var caj = typeof materials.cajones === 'number' ? materials.cajones : 4;
                // AUDIT: Lateral  full depth, full height  no deductions (outer structural panels)
                pieces.push({ n: 'Lateral',   q: 2, w: d,       h: h,        t: TK, z: 'i' });
                // AUDIT: Techo/Piso  deduct 2x panel thickness from width (w - 2*TK = w - 32 at 16mm) so they fit between laterales
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32, h: d,        t: TK, z: 'i' });
                // AUDIT: Fondo  inset by 1x TK on all sides so it fits inside the box (w - 2*TK, h - 2*TK)
                pieces.push({ n: 'Fondo',      q: 1, w: w - 2 * TK, h: h - 2 * TK, t: TK, z: 'i' });
                if (caj > 0) {
                    // AUDIT: ch = usable height (h minus 100mm structure allowance) divided evenly by drawer count
                    var ch = Math.floor((h - 100) / caj);
                    // AUDIT: Frente cajon  6mm gap on all sides for alignment tolerance (w-6, ch-6); 4 edges chapacanto; zone='f' (frente)
                    pieces.push({ n: 'Frente cajon', q: caj,     w: w - 6,     h: ch - 6,  t: TK, c: 4, z: 'f' });
                    // AUDIT: Costado cajon  50mm deducted from depth for slide mechanism clearance; 80mm deducted from height for slide height
                    pieces.push({ n: 'Costado cajon', q: caj * 2, w: d - 50,   h: ch - 80, t: TK, c: 1, z: 'i' });
                    // AUDIT: Int. cajon  100mm deducted from width for slide + structure on both sides; 80mm height clearance for slide
                    pieces.push({ n: 'Int. cajon',    q: caj * 2, w: w - 100,  h: ch - 80, t: TK, c: 1, z: 'i' });
                    // AUDIT: Fondo cajon  same 100mm width deduction; 50mm depth deduction for slide stop
                    pieces.push({ n: 'Fondo cajon',   q: caj,     w: w - 100,  h: d - 50,  t: TK, z: 'i' });
                } else {
                    var msh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                    if (msh > 0) {
                        // AUDIT: Entrepano  same width deduction as Techo/Piso (fits between laterales)
                        pieces.push({ n: 'Entrepano', q: msh, w: w - 32, h: d, t: TK, z: 'i' });
                    }
                }

            } else if (moduleType === 'colgador') {
                // Closet hanging-bar module
                // AUDIT: Lateral  full depth, full height (outer structural panels)
                pieces.push({ n: 'Lateral',   q: 2, w: d,       h: h,             t: TK, z: 'i' });
                // AUDIT: Techo/Piso  w - 2*TK (= w - 32 at 16mm), fits between laterales
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32, h: d,             t: TK, z: 'i' });
                // AUDIT: Entrepano  single shelf, same width deduction as Techo/Piso (single shelf at mid-height)
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32, h: d,             t: TK, z: 'i' });
                // AUDIT: Fondo  inset by TK on all sides (w - 2*TK, h - 2*TK)
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK, t: TK, z: 'i' });

            } else if (moduleType === 'zapatero') {
                // Closet shoe-rack module with pull-out trays
                // AUDIT: Lateral  full depth, full height (outer structural panels)
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                // AUDIT: Techo/Piso  w - 2*TK (= w - 32 at 16mm)
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                // AUDIT: Charola  pull-out tray; 100mm inset on width for slide mechanism on both sides; 100mm inset on depth for slide stop
                pieces.push({ n: 'Charola',   q: 6, w: w - 100,     h: d - 100,       t: TK, z: 'i' });
                // AUDIT: Fondo  inset by TK on all sides
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'esquinero') {
                // Closet L-shape corner module
                // AUDIT: Lateral A  full width A, full height (one outer panel of the L)
                pieces.push({ n: 'Lateral A', q: 1, w: w,  h: h,            t: TK, z: 'i' });
                // AUDIT: Lateral B  uses w2 (second leg of L), full height
                pieces.push({ n: 'Lateral B', q: 1, w: w2, h: h,            t: TK, z: 'i' });
                // AUDIT: Diagonal  hypotenuse face panel; width = half hypotenuse (sqrt(w^2+w2^2)*0.5) rounded; 2 edges chapacanto; zone='f'
                pieces.push({ n: 'Diagonal',  q: 1, w: Math.round(Math.sqrt(w * w + w2 * w2) * 0.5), h: h, t: TK, c: 2, z: 'f' });
                // AUDIT: Techo/Piso  horizontal panels; deduct TK from both w and w2 (fit inside both laterales)
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 2 * TK, h: w2 - 2 * TK, t: TK, z: 'i' });
                // AUDIT: Entrepano  same deductions as Techo/Piso (fits inside the L-box)
                pieces.push({ n: 'Entrepano', q: 1, w: w - 2 * TK, h: w2 - 2 * TK,  t: TK, z: 'i' });

            } else if (moduleType === 'entrepa') {
                // Closet open shelving unit
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 5;
                // AUDIT: Lateral  full depth, full height (outer structural panels)
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                // AUDIT: Techo/Piso  w - 2*TK (= w - 32 at 16mm), fits between laterales
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                // AUDIT: Entrepano  same width deduction as Techo/Piso; shelves||5 count
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                // AUDIT: Fondo  inset by TK on all sides
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'torreLateral') {
                // TV: lateral tower unit with shelves
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                // AUDIT: Lateral  zone='f' (visible front material) for TV towers
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'panelTV') {
                // TV: decorative TV background panel with crossbars
                // AUDIT: Panel  fixed 1200mm height regardless of module height (standard TV back panel)
                pieces.push({ n: 'Panel',     q: 1, w: w,       h: 1200,  t: TK, c: 4, z: 'f' });
                // AUDIT: Travesano  horizontal cross-member; 100mm tall; w - 2*TK width
                pieces.push({ n: 'Travesano', q: 2, w: w - 32,  h: 100,   t: TK,       z: 'i' });

            } else if (moduleType === 'moduloCentral') {
                // TV: central base module with single shelf
                // AUDIT: Lateral  zone='f' (visible front material) for TV modules
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'lateralAbierto') {
                // TV: open lateral unit with shelves
                // AUDIT: Lateral  zone='f' (visible front material) for TV laterals
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'alacenaAlta') {
                // Cocina: upper wall cabinet
                // AUDIT: alacH uses module h directly (already resolved by caller in mm)
                var alacH = h;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: alacH,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,                 t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32,     h: d,                 t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: alacH - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'gabineteBase') {
                // Cocina: base cabinet with single shelf
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'cajonBase') {
                // Cocina: base cabinet with drawers
                var caj = typeof materials.cajones === 'number' ? materials.cajones : 3;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });
                if (caj > 0) {
                    // AUDIT: ch = usable height divided by drawer count (100mm structure allowance)
                    var ch = Math.floor((h - 100) / caj);
                    // AUDIT: Frente cajon  6mm gap; 4 edges chapacanto; zone='f'
                    pieces.push({ n: 'Frente cajon', q: caj,     w: w - 6,    h: ch - 6,  t: TK, c: 4, z: 'f' });
                    // AUDIT: Lat. cajon  80mm deducted from depth for kitchen drawer slide; 30mm height clearance
                    pieces.push({ n: 'Lat. cajon',   q: caj * 2, w: d - 80,   h: ch - 30, t: TK, z: 'i' });
                    // AUDIT: Resp. cajon  80mm deducted from width for kitchen slide; 30mm height clearance
                    pieces.push({ n: 'Resp. cajon',  q: caj * 2, w: w - 80,   h: ch - 30, t: TK, z: 'i' });
                    // AUDIT: Base cajon  80mm deducted from both w and d for slide clearance
                    pieces.push({ n: 'Base cajon',   q: caj,     w: w - 80,   h: d - 80,  t: TK, z: 'i' });
                }

            } else if (moduleType === 'despensa') {
                // Cocina: tall pantry with adjustable shelves
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 4;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'espacioCampana') {
                // Cocina: open frame for range hood  no back, fixed 400mm lateral height
                // AUDIT: Lateral  fixed 400mm height (standard hood clearance frame)
                pieces.push({ n: 'Lateral',   q: 2, w: d,      h: 400, t: TK, z: 'i' });
                // AUDIT: Travesano  100mm tall horizontal cross-member; w - 2*TK width
                pieces.push({ n: 'Travesano', q: 2, w: w - 32, h: 100, t: TK, z: 'i' });

            } else if (moduleType === 'esquineroGiratorio') {
                // Cocina: corner unit with lazy-susan hardware
                var w2g = dimensions.w2 !== undefined ? dimensions.w2 : w;
                pieces.push({ n: 'Lateral A', q: 1, w: w,           h: h,              t: TK, z: 'i' });
                pieces.push({ n: 'Lateral B', q: 1, w: w2g,          h: h,              t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 2 * TK, h: w2g - 2 * TK,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,    t: TK, z: 'i' });

            } else if (moduleType === 'puerta') {
                // Individual door panel with optional marco (frame)
                // AUDIT: Panel puerta  full w x h; 4 edges chapacanto; zone='f'
                pieces.push({ n: 'Panel puerta', q: 1, w: w, h: h, t: TK, c: 4, z: 'f' });
                if (materials.marco) {
                    // AUDIT: Jamba  100mm wide vertical frame members; zone='f'
                    pieces.push({ n: 'Jamba',   q: 2, w: 100,      h: h,   t: TK, z: 'f' });
                    // AUDIT: Cabezal  horizontal top frame; w + 200mm to overlap both jambas
                    pieces.push({ n: 'Cabezal', q: 1, w: w + 200,  h: 100, t: TK, z: 'f' });
                }
                // Note: bisagra/base_clip for puerta type are handled in assignHardware()
                // because they require getBisagraCount() with heightCm + materialType options.
            }

            return pieces;
        }

        // === assignHardware: Generic hardware auto-assignment engine ===
        // Called by calc() to get hardware items for any module type.
        // moduleType: string matching MODS keys
        // dimensions: { w: mm, h: mm, d: mm }
        // options: { cajones, corrTier, doors, tipon, doorCount, doorMaterial, materialType, shelves, heightCm, marco }
        // Returns: array of { key: string (HW_DEFAULTS key), q: number }
        function assignHardware(moduleType, dimensions, options) {
            var hw = [];
            var opts = options || {};

            if (moduleType === 'modulo') {
                // Closet drawer/shelf module
                var caj = typeof opts.cajones === 'number' ? opts.cajones : 0;
                if (caj > 0) {
                    // AUDIT: Default slide type is economica; user can upgrade via corrTier property
                    var corrKey = opts.corrTier || 'corr_eco';
                    hw.push({ key: corrKey, q: caj });
                    // AUDIT: Jaladera only when no doors  if doors present, jaladera goes on door not drawer
                    if (!opts.doors) {
                        hw.push({ key: 'jaladera', q: caj });
                    }
                }

            } else if (moduleType === 'colgador') {
                // Closet hanging-bar module
                // AUDIT: One tube per module, two brackets (left + right support)
                hw.push({ key: 'tubo',    q: 1 });
                hw.push({ key: 'soporte', q: 2 });

            } else if (moduleType === 'zapatero') {
                // Closet shoe-rack module with pull-out trays
                // AUDIT: 6 pull-out shoe trays, each needs one pair of slides
                hw.push({ key: 'corr_eco', q: 6 });

            } else if (moduleType === 'esquinero') {
                // Closet L-shape corner module with hanging bar
                // AUDIT: Corner module gets a hanging bar like colgador
                hw.push({ key: 'tubo',    q: 1 });
                hw.push({ key: 'soporte', q: 2 });

            } else if (moduleType === 'cajonBase') {
                // Cocina base cabinet with drawers
                var caj = typeof opts.cajones === 'number' ? opts.cajones : 0;
                if (caj > 0) {
                    // AUDIT: Cocina base drawers use premium soft-close concealed slides
                    hw.push({ key: 'corr_oculta', q: caj });
                }

            } else if (moduleType === 'puerta') {
                // Individual door panel  bisagra count driven by height + material weight
                // AUDIT: Hinge count driven by CONFIG rules based on door height and material weight
                var heightCm = opts.heightCm || 200;
                var matType  = opts.materialType;
                var hinges   = getBisagraCount(heightCm, matType);
                hw.push({ key: 'bisagra',   q: hinges });
                hw.push({ key: 'base_clip', q: hinges });

            }
            // All other module types (entrepa, torreLateral, panelTV, moduloCentral, lateralAbierto,
            // alacenaAlta, gabineteBase, despensa, espacioCampana, esquineroGiratorio):
            // AUDIT: These types get hardware only through doors (handled separately in calc) or manual assignment

            return hw;
        }

        // === CALC: Cost-based pricing engine ===
        function calc() {
            var P = S.project,
                pieces = [],
                autoHW = [];
            var useDual = isDualType(P.type) && !P.sameMaterial;

            // Generate pieces from modules
            var TK = P.thickness;
            P.modules.forEach(function(m) {
                var w = m.width * 10,
                    d = (P.sameDepth ? (P.defaultDepth || 50) : (m.depth || P.defaultDepth || 50)) * 10,
                    h = (m.height || P.defaultHeight || 200) * 10;
                var qm = m.quoteMode || 'completo';
                if (qm !== 'solo_puertas') {
                    // Delegate piece generation to calculateParts()
                    var cPieces = calculateParts(m.type, {
                        w: w,
                        h: h,
                        d: d,
                        w2: m.width2 ? m.width2 * 10 : undefined
                    }, {
                        thickness: TK,
                        cajones: typeof m.cajones === 'number' ? m.cajones : undefined,
                        shelves: m.shelves,
                        quoteMode: qm,
                        corrTier: m.corrTier,
                        marco: m.marco,
                        materialType: m.materialType,
                        doors: m.doors
                    });
                    // Stamp module context onto each piece and push into the pieces array
                    cPieces.forEach(function(p) {
                        p.mid = m.id;
                        p.mn  = m.name;
                        p.mw  = m.width;
                        pieces.push(p);
                    });
                    // Delegate hardware assignment to assignHardware()
                    var modHW = assignHardware(m.type, { w: w, h: h, d: d }, {
                        cajones: typeof m.cajones === 'number' ? m.cajones : undefined,
                        corrTier: m.corrTier,
                        doors: m.doors,
                        tipon: m.tipon,
                        shelves: m.shelves,
                        heightCm: m.height || P.defaultHeight || 200,
                        materialType: m.materialType,
                        marco: m.marco
                    });
                    modHW.forEach(function(hw) {
                        autoHW.push({ key: hw.key, q: hw.q, modId: m.id });
                    });
                } // end qm!=='solo_puertas'
                // Door pieces
                if (m.doors || qm === 'solo_puertas') {
                    var doorCnt = m.type === 'esquinero' ? 2 : Math.ceil(m.width / 50);
                    var doorW = Math.round(w / doorCnt) - 3;
                    var doorH = h - 3;
                    if (m.doorMaterial !== 'vidrio')
                        pieces.push({
                            mid: m.id,
                            mn: m.name,
                            mw: m.width,
                            n: 'Puerta',
                            q: doorCnt,
                            w: doorW,
                            h: doorH,
                            t: TK,
                            c: 4,
                            z: 'f'
                        });
                    var doorHeightCm = (m.height || P.defaultHeight || 200);
                    var doorMatType = m.doorMaterial || 'melamina';
                    var bisPerDoor = getBisagraCount(doorHeightCm, doorMatType);
                    autoHW.push({
                        key: 'bisagra',
                        q: doorCnt * bisPerDoor,
                        modId: m.id
                    });
                    autoHW.push({
                        key: 'base_clip',
                        q: doorCnt * bisPerDoor,
                        modId: m.id
                    });
                    if (m.tipon) {
                        autoHW.push({
                            key: 'tipon',
                            q: doorCnt,
                            modId: m.id
                        });
                        autoHW.push({
                            key: 'placa_tipon',
                            q: doorCnt,
                            modId: m.id
                        });
                    } else {
                        autoHW.push({
                            key: 'jaladera',
                            q: doorCnt,
                            modId: m.id
                        });
                    }
                }
            });

            // Calculate areas by zone  all pieces use project thickness
            var areaF = 0, areaI = 0, cantoF = 0, cantoI = 0;
            pieces.forEach(function(p) {
                var a = (p.w / 1000) * (p.h / 1000) * p.q;
                if (useDual && p.z === 'i') areaI += a;
                else areaF += a;
                var ml = 0;
                if (p.c) {
                    if (p.c === 4)
                        ml = ((p.w + p.h) * 2 / 1000) * p.q;
                    else if (p.c === 2)
                        ml = ((p.w + p.h) / 1000) * p.q;
                    else
                        ml = (Math.max(p.w, p.h) / 1000) * p.q;
                } else {
                    ml = (Math.max(p.w, p.h) / 1000) * p.q;
                }
                if (useDual && p.z === 'i')
                    cantoI += ml;
                else
                    cantoF += ml;
            });

            var SHEET = 1.22 * 2.44;
            var merma = CONFIG.pricing.mermaFactor;
            var totalSheetsF = Math.ceil(areaF * merma / SHEET);
            var totalSheetsI = Math.ceil(areaI * merma / SHEET);
            // sheetsF/sheetsI keyed by actual thickness for UI display
            var sheetsF = { 16: 0, 25: 0 }; sheetsF[TK] = totalSheetsF;
            var sheetsI = { 16: 0, 25: 0 }; sheetsI[TK] = totalSheetsI;
            cantoF = Math.ceil(cantoF);
            cantoI = Math.ceil(cantoI);
            var totalSheets = totalSheetsF + totalSheetsI;
            var totalCanto = cantoF + cantoI;

            // Material costs  use actual project thickness for price lookup
            var matPriceF = getMatPrice(P.matFrentes, TK);
            var matPriceI = getMatPrice(P.matInterior, TK);
            var matCostF = totalSheetsF * matPriceF;
            var matCostI = totalSheetsI * matPriceI;
            var chapCostF = cantoF * P.chapFrentesPrice;
            var chapCostI = cantoI * P.chapInteriorPrice;
            var corteCost = totalSheets * CONFIG.pricing.cuttingCostPerSheet;
            var enchapPrice = typeof P.enchapPrice === 'number' ? P.enchapPrice : 13;
            var enchapCost = totalCanto * enchapPrice;

            // Carpinteria total cost
            var carpCost = matCostF + matCostI + chapCostF + chapCostI + corteCost + enchapCost + P.laborCost + (P.freight ? P.freightCost : 0);

            // Hardware costs - combine auto + manual
            var hwConsolidated = {};
            autoHW.forEach(function(ah) {
                var def = HW_DEFAULTS[ah.key];
                if (!def)
                    return;
                var catItem = findCatItem(def.desc, def.marca);
                var price = catItem ? adjPrice(catItem) : def.fallback;
                var k = ah.key;
                if (!hwConsolidated[k])
                    hwConsolidated[k] = {
                        desc: def.desc,
                        marca: def.marca,
                        price: price,
                        qty: 0,
                        cat: def.cat,
                        catItem: catItem
                    };
                hwConsolidated[k].qty += ah.q;
            });
            // Manual hardware from project.hardware
            var manualHW = [];
            P.hardware.forEach(function(h) {
                manualHW.push({
                    desc: h.descripcion,
                    marca: h.marca,
                    price: adjPrice(h),
                    qty: h.qty,
                    cat: h.categoria,
                    codigo: h.codigo
                });
            });

            var hwCostCarpBucket = 0,
                hwCostPremium = 0;
            // Legacy brand-based accumulators (kept for backward compat in return object)
            var hwCostHerraxa = 0,
                hwCostHafele = 0,
                hwCostBlum = 0;
            var allHW = [];
            var hwThreshold = CONFIG.pricing.hardwareThreshold;
            for (var k in hwConsolidated) {
                var h = hwConsolidated[k];
                allHW.push(h);
                var cost = Math.ceil(h.qty) * h.price;
                // Threshold-based split: line item total <= threshold goes to carpentry bucket
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h._bucket = 'premium';
                }
                // Legacy brand tracking
                if (h.marca === 'BLUM') hwCostBlum += cost;
                else if (h.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            }
            manualHW.forEach(function(h) {
                allHW.push(h);
                var cost = Math.ceil(h.qty) * h.price;
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h._bucket = 'premium';
                }
                if (h.marca === 'BLUM') hwCostBlum += cost;
                else if (h.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            });

            var hwStdCost = hwCostHerraxa + hwCostHafele;

            // Extras
            var extraCost = 0;
            var ledBOM = calcLedBOM();
            if (ledBOM)
                extraCost += ledBOM.totalCost;
            if (P.glass && P.glassM2 > 0)
                extraCost += P.glassM2 * CONFIG.pricing.glassCostPerM2;
            // CUSTOMIZE: Paint calc  adjust coverage rates and paint cost logic here
            var paintCost = 0;
            P.modules.forEach(function(m2) {
                if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                    var pm2 = calcPaintM2(m2, {
                        mode: 'custom',
                        defaultHeight: P.defaultHeight,
                        defaultDepth: P.defaultDepth
                    });
                    var liters = calcPaintLiters(pm2, m2.paint.coats);
                    paintCost += liters * m2.paint.pricePerLiter;
                }
            });
            extraCost += paintCost;

            // Apply margins  threshold-based hardware pricing
            var carpMultiplier = CONFIG.pricing.carpentryMultiplier;
            var premiumMargin = CONFIG.pricing.premiumHardwareMargin;
            // Carpentry cost now includes the carpentry-bucket hardware (low-cost items)
            var carpSale = (carpCost + hwCostCarpBucket) * carpMultiplier;
            // Premium hardware (above threshold) gets margin-based pricing
            var hwPremiumSale = hwCostPremium / (1 - premiumMargin);
            // Legacy aliases for backward compat
            var hwStdSale = hwPremiumSale;
            var hwBlumSale = 0;
            var extrasSale = extraCost * CONFIG.pricing.extrasMultiplier;

            var subtotal = carpSale + hwPremiumSale + extrasSale;
            var iva = subtotal * CONFIG.pricing.iva;
            var total = subtotal + iva;
            var totalCost = carpCost + hwCostCarpBucket + hwCostPremium + extraCost;
            var profit = subtotal - totalCost;
            var margin = subtotal > 0 ? ((profit / subtotal) * 100).toFixed(1) : 0;

            return {
                pieces: pieces,
                autoHW: autoHW,
                allHW: allHW,
                hwConsolidated: hwConsolidated,
                manualHW: manualHW,
                sheetsF: sheetsF,
                sheetsI: sheetsI,
                cantoF: cantoF,
                cantoI: cantoI,
                totalSheetsF: totalSheetsF,
                totalSheetsI: totalSheetsI,
                totalSheets: totalSheets,
                totalCanto: totalCanto,
                matCostF: matCostF,
                matCostI: matCostI,
                chapCostF: chapCostF,
                chapCostI: chapCostI,
                corteCost: corteCost,
                enchapCost: enchapCost,
                carpCost: carpCost,
                hwCostCarpBucket: hwCostCarpBucket,
                hwCostPremium: hwCostPremium,
                hwCostHerraxa: hwCostHerraxa,
                hwCostHafele: hwCostHafele,
                hwCostBlum: hwCostBlum,
                hwStdCost: hwStdCost,
                extraCost: extraCost,
                ledBOM: ledBOM,
                paintCost: paintCost,
                carpSale: carpSale,
                hwPremiumSale: hwPremiumSale,
                hwStdSale: hwStdSale,
                hwBlumSale: hwBlumSale,
                extrasSale: extrasSale,
                subtotal: subtotal,
                iva: iva,
                total: total,
                totalCost: totalCost,
                profit: profit,
                margin: margin,
                useDual: useDual
            };
        }

        // === V2.3: Estandarizado calc ===
        // Height/depth helpers  use per-module height in custom mode, fixed in estandarizado
        function estModHeight(m) {
            var EP = S.estProject;
            return EP.mode === 'custom' ? (m && m.height || 200) : EST_HEIGHT;
        }
        function estProjDepth(mod) {
            var EP = S.estProject;
            if (EP.mode === 'custom') {
                if (mod && !EP.sameDepth && mod.depth) return mod.depth;
                return EP.projectDepth || 60;
            }
            return EST_DEPTH;
        }
        // Calculate fixed zone heights (everything except colgador)
        // Espacio til = height minus techo+piso panel thickness
        function estEspacioUtil(m) {
            var tk = S.estProject.thickness || 16;
            return estModHeight(m) - (2 * tk / 10);
        }
        // Sum of all fixed-height zones (everything except colgador and entrepa which fill free space)
        function calcEstFixedHeight(m) {
            var tk = (S.estProject.thickness || 16) / 10; // espesor in cm
            var h = 0;
            var numZones = m.zones.length;
            // Especial modules: entrepaos auto-fill entire space (unless colgador present)
            var espHasColg = m.type === 'especial' && m.zones.some(function(z) {
                return z.type === 'colgador';
            });
            if (m.type === 'especial' && !espHasColg) {
                return estEspacioUtil(m);
            }
            m.zones.forEach(function(z) {
                if (z.type === 'cajones') {
                    h += (z.count || 1) * (z.cajonHeight || 20);
                }
                else if (z.type === 'zapatero') {
                    h += (z.repisas || 3) * (z.repisaHeight || 15);
                }

                else // maletero is module-level (outside height), not a zone
                if (z.type === 'entrepa') {
                    h += (z.count || 2) * tk;
                }


            });
            // colgador is flexible  not counted here
            // entrepa fills free space  only the shelf thickness counts (already above)
            // Add divisiones internas between zones (espesor each, numZones-1 dividers)
            if (numZones > 1)
                h += (numZones - 1) * tk;
            return h;
        }
        // Get effective height of a colgador zone (fills remaining space)
        function calcEstColgadorHeight(m, z) {
            var eu = estEspacioUtil(m);
            var fixed = calcEstFixedHeight(m);
            var numColg = m.zones.filter(function(x) {
                return x.type === 'colgador';
            }).length;
            var remaining = eu - fixed;
            if (numColg <= 0)
                return 0;
            return Math.max(0, Math.round(remaining / numColg));
        }
        // Free space remaining when no colgador
        function calcEstFreeSpace(m) {
            var eu = estEspacioUtil(m);
            var fixed = calcEstFixedHeight(m);
            return eu - fixed;
        }
        // Total height used (should always = espacio_util if colgador present)
        function calcEstZoneHeight(m) {
            var eu = estEspacioUtil(m);
            var fixed = calcEstFixedHeight(m);
            var hasColg = m.zones.some(function(z) {
                return z.type === 'colgador';
            });
            if (hasColg)
                return eu;
            return fixed;
        }
        // Get display height for any zone
        function getEstZoneDisplayHeight(m, z) {
            if (z.type === 'cajones')
                return (z.count || 1) * (z.cajonHeight || 20);
            if (z.type === 'colgador')
                return calcEstColgadorHeight(m, z);
            if (z.type === 'zapatero')
                return (z.repisas || 3) * (z.repisaHeight || 15);
            if (z.type === 'entrepa') {
                // Especial modules without colgador: entrepaos divide the full space evenly
                var espColg = m.type === 'especial' && m.zones.some(function(x) {
                    return x.type === 'colgador';
                });
                if (m.type === 'especial' && !espColg) {
                    var eu = estEspacioUtil(m);
                    var cnt = z.count || 2;
                    return eu / cnt;
                }
                // Regular modules: entrepaos divide the free space evenly
                var freeEnt = calcEstFreeSpace(m);
                if (freeEnt > 0) {
                    var cntEnt = z.count || 2;
                    return freeEnt / (cntEnt + 1);
                }
                return (z.count || 2) * ((S.estProject.thickness || 16) / 10);
            }
            return 0;
        }

        function calcEstChapML(m, TK) {
            var W = m.width * 10,
                H = estModHeight(m) * 10,
                D = estProjDepth(m) * 10;
            var ml = 0;
            var ch = m.chap;
            if (!ch)
                return 0;
            if (ch.edges.latIzq)
                ml += (H / 1000) * 2;
            if (ch.edges.latDer)
                ml += (H / 1000) * 2;
            if (ch.edges.techo)
                ml += ((W - 2 * TK) / 1000) * 2 + (D / 1000) * 2;
            if (ch.edges.piso)
                ml += ((W - 2 * TK) / 1000) * 2 + (D / 1000) * 2;
            if (ch.edges.fondo)
                ml += (W / 1000) * 2 + (H / 1000) * 2;
            return ml;
        }

        function calcPaintLiters(m2, coats) {
            return (m2 * (coats || 2)) / 10;
        }

        function calcPaintM2(m, projConfig) {
            var paint = m.paint;
            if (!paint || !paint.enabled)
                return 0;
            var scope = paint.scope || 'doors';
            var qm = m.quoteMode || 'completo';
            var doorsM2 = 0,
                structM2 = 0;
            var w = m.width * 10,
                h,
                d;
            if (projConfig.mode === 'est') {
                h = estModHeight(m) * 10;
                d = estProjDepth(m) * 10;
            } else {
                h = (m.height || projConfig.defaultHeight || 200) * 10;
                d = (projConfig.defaultDepth || 50) * 10;
            }
            if (scope === 'doors' || scope === 'all') {
                if (m.doors || qm === 'solo_puertas') {
                    if (projConfig.mode === 'est') {
                        var doorMode = m.doorMode || 'por_zona';
                        if (doorMode === 'completa') {
                            var cnt = m.doorCount || 2;
                            var dw = Math.round(w / cnt) - 3,
                                dh = h - 3;
                            if ((m.doorMaterial || 'melamina') === 'melamina')
                                doorsM2 += (dw / 1000) * (dh / 1000) * cnt;
                        } else {
                            (m.zones || []).forEach(function(z) {
                                if (!z.doors)
                                    return;
                                var zH = Math.round(getEstZoneDisplayHeight(m, z) * 10);
                                var pw2 = Math.round(w / 2) - 3;
                                if ((z.doorMaterial || 'melamina') === 'melamina')
                                    doorsM2 += (pw2 / 1000) * ((zH - 3) / 1000) * 2;
                            });
                        }
                    } else {
                        var doorCnt = m.type === 'esquinero' ? 2 : Math.ceil(m.width / 50);
                        var dw2 = Math.round(w / doorCnt) - 3,
                            dh2 = h - 3;
                        if (m.doorMaterial !== 'vidrio')
                            doorsM2 += (dw2 / 1000) * (dh2 / 1000) * doorCnt;
                    }
                }
            }
            if ((scope === 'structure' || scope === 'all') && qm !== 'solo_puertas') {
                structM2 += 2 * (d / 1000) * (h / 1000);
                structM2 += 2 * (w / 1000) * (d / 1000);
            }
            return doorsM2 + structM2;
        }

        function calcEstLedBOM() {
            var EP = S.estProject,
                totalMeters = 0,
                totalSegments = 0,
                hasLed = false;
            EP.modules.forEach(function(m) {
                if (!m.led || !m.led.enabled)
                    return;
                hasLed = true;
                var auto = calcEstModuleLedMeters(m);
                var usedMeters = (m.led.metersOverride !== null && m.led.metersOverride >= 0) ? m.led.metersOverride : auto.meters;
                var usedSegments = (m.led.segmentsOverride !== null && m.led.segmentsOverride >= 0) ? m.led.segmentsOverride : auto.segments;
                totalMeters += usedMeters;
                totalSegments += usedSegments;
            });
            if (!hasLed)
                return null;
            var LC = LED_CATALOG,
                items = [];
            var tiraKey = EP.ledConfig.lightTemp === 'fria' ? 'tira_fria' : 'tira_calida';
            var tiraInfo = LC.variable[tiraKey];
            var tiraQty = Math.max(1, Math.ceil(totalMeters / tiraInfo.length));
            items.push({
                desc: tiraInfo.desc,
                qty: tiraQty,
                unitPrice: tiraInfo.price,
                total: tiraQty * tiraInfo.price,
                type: 'variable'
            });
            var cableAlimQty = Math.max(1, totalSegments);
            items.push({
                desc: LC.variable.cable_alim_tira.desc,
                qty: cableAlimQty,
                unitPrice: LC.variable.cable_alim_tira.price,
                total: cableAlimQty * LC.variable.cable_alim_tira.price,
                type: 'variable'
            });
            var perfilQty = Math.max(1, Math.ceil(totalMeters / LC.variable.perfil_embutir.length));
            items.push({
                desc: LC.variable.perfil_embutir.desc,
                qty: perfilQty,
                unitPrice: LC.variable.perfil_embutir.price,
                total: perfilQty * LC.variable.perfil_embutir.price,
                type: 'variable'
            });
            var extQty = Math.max(1, Math.ceil(totalMeters / 4));
            items.push({
                desc: LC.variable.cable_extension.desc,
                qty: extQty,
                unitPrice: LC.variable.cable_extension.price,
                total: extQty * LC.variable.cable_extension.price,
                type: 'variable'
            });
            if (totalSegments > 6) {
                var extraDist = Math.ceil((totalSegments - 6) / 6);
                items.push({
                    desc: LC.variable.regleta_extra.desc,
                    qty: extraDist,
                    unitPrice: LC.variable.regleta_extra.price,
                    total: extraDist * LC.variable.regleta_extra.price,
                    type: 'variable'
                });
            }
            items.push({
                desc: LC.fixed.distribuidor.desc,
                qty: 1,
                unitPrice: LC.fixed.distribuidor.price,
                total: LC.fixed.distribuidor.price,
                type: 'fixed'
            });
            var totalWatts = totalMeters * LC.wattsPerMeter * LC.headroom;
            var alim = LC.alimentadores[LC.alimentadores.length - 1];
            for (var i = 0; i < LC.alimentadores.length; i++) {
                if (totalWatts <= LC.alimentadores[i].w) {
                    alim = LC.alimentadores[i];
                    break;
                }
            }
            items.push({
                desc: alim.desc,
                qty: 1,
                unitPrice: alim.price,
                total: alim.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_primario.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_primario.price,
                total: LC.fixed.cable_primario.price,
                type: 'fixed'
            });
            var sw = LC.switches[EP.ledConfig.activation] || LC.switches.dimmer;
            items.push({
                desc: sw.desc,
                qty: 1,
                unitPrice: sw.price,
                total: sw.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_interruptor.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_interruptor.price,
                total: LC.fixed.cable_interruptor.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.placa_montaje.desc,
                qty: 1,
                unitPrice: LC.fixed.placa_montaje.price,
                total: LC.fixed.placa_montaje.price,
                type: 'fixed'
            });
            var totalCost = items.reduce(function(a, it) {
                return a + it.total;
            }, 0);
            return {
                items: items,
                totalCost: totalCost,
                totalMeters: totalMeters,
                totalSegments: totalSegments,
                totalWatts: totalWatts,
                alimentadorW: alim.w
            };
        }

        function calcEstandarizado() {
            var EP = S.estProject,
                pieces = [],
                autoHW = [];
            var TK = EP.thickness,
                useDual = !EP.sameMaterial;

            EP.modules.forEach(function(m, mi) {
                var D = estProjDepth(m) * 10;
                var W = m.width * 10;
                var H = estModHeight(m) * 10;
                var mname = 'Mod ' + (mi + 1);
                var mid = m.id;
                var qm = m.quoteMode || 'completo';
                // Structure: 2 laterales, techo, piso, fondo
                if (qm !== 'solo_puertas') {
                    if (m.type === 'fijo') {
                        // Fijo: single sheet
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Fijo)',
                            mw: m.width,
                            n: 'Fijo',
                            q: 1,
                            w: W,
                            h: H,
                            t: TK,
                            c: 4,
                            z: 'i'
                        });
                    } else if (m.type === 'panelTV') {
                        // Panel TV: flat panel + 2 travesaos horizontales
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (PanelTV)',
                            mw: m.width,
                            n: 'Panel frontal',
                            q: 1,
                            w: W,
                            h: H,
                            t: TK,
                            c: 4,
                            z: 'f'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (PanelTV)',
                            mw: m.width,
                            n: 'Travesa\u00f1o',
                            q: 2,
                            w: W - 2 * TK,
                            h: D,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (PanelTV)',
                            mw: m.width,
                            n: 'Fondo',
                            q: 1,
                            w: W - 2 * TK,
                            h: H - 2 * TK,
                            t: TK,
                            z: 'i'
                        });
                    } else if (m.type === 'esquinero') {
                        var W2 = (m.width2 || m.width) * 10;
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Lateral A',
                            q: 1,
                            w: W,
                            h: H,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Lateral B',
                            q: 1,
                            w: W2,
                            h: H,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Techo',
                            q: 1,
                            w: W - TK,
                            h: W2 - TK,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Piso',
                            q: 1,
                            w: W - TK,
                            h: W2 - TK,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Fondo',
                            q: 1,
                            w: W - 2 * TK,
                            h: H - 2 * TK,
                            t: TK,
                            z: 'i'
                        });
                    } else {
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Lateral izq',
                            q: 1,
                            w: D,
                            h: H,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Lateral der',
                            q: 1,
                            w: D,
                            h: H,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Techo',
                            q: 1,
                            w: W - 2 * TK,
                            h: D,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Piso',
                            q: 1,
                            w: W - 2 * TK,
                            h: D,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Fondo',
                            q: 1,
                            w: W - 2 * TK,
                            h: H - 2 * TK,
                            t: TK,
                            z: 'i'
                        });
                    }

                    // Zones
                    m.zones.forEach(function(z) {
                        if (z.type === 'entrepa') {
                            var cnt = z.count || 2;
                            var eW = W - 2 * TK;
                            var eD = m.type === 'esquinero' ? D : D - 20;
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Entrepa\u00f1o',
                                q: cnt,
                                w: eW,
                                h: eD,
                                t: TK,
                                z: 'i'
                            });
                        } else if (z.type === 'cajones') {
                            var cnt = z.count || 3;
                            var ch = (z.cajonHeight || 20) * 10;
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Frente caj\u00f3n',
                                q: cnt,
                                w: W - 2 * TK - 3,
                                h: ch,
                                t: TK,
                                c: 4,
                                z: 'f'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Lateral caj\u00f3n',
                                q: cnt * 2,
                                w: D - 50,
                                h: ch - 30,
                                t: TK,
                                z: 'i'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Trasera caj\u00f3n',
                                q: cnt,
                                w: W - 2 * TK - 40,
                                h: ch - 30,
                                t: TK,
                                z: 'i'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Fondo caj\u00f3n',
                                q: cnt,
                                w: W - 2 * TK - 20,
                                h: D - 50,
                                t: TK,
                                z: 'i'
                            });
                            autoHW.push({
                                key: 'corr_eco',
                                q: cnt,
                                modId: mid
                            });
                            if (m.doors) {
                                if (m.doorType === 'tipon') {
                                    autoHW.push({
                                        key: 'tipon',
                                        q: cnt,
                                        modId: mid
                                    });
                                    autoHW.push({
                                        key: 'placa_tipon',
                                        q: cnt,
                                        modId: mid
                                    });
                                }
                                else {
                                    autoHW.push({
                                        key: 'jaladera',
                                        q: cnt,
                                        modId: mid
                                    });
                                }
                            } else {
                                autoHW.push({
                                    key: 'jaladera',
                                    q: cnt,
                                    modId: mid
                                });
                            }
                        } else if (z.type === 'colgador') {
                            autoHW.push({
                                key: 'tubo',
                                q: 1,
                                modId: mid
                            });
                            autoHW.push({
                                key: 'soporte',
                                q: 2,
                                modId: mid
                            });
                        } else if (z.type === 'zapatero') {
                            var reps = z.repisas || 3;
                            var zapH = (z.repisaHeight || 15) * 10; // full height per cajn extrable in mm
                            var zapFrH = 50; // 5cm visible front height
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Frente zapatero',
                                q: reps,
                                w: W - 2 * TK - 3,
                                h: zapFrH,
                                t: TK,
                                c: 4,
                                z: 'f'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Lateral zapatero',
                                q: reps * 2,
                                w: D - 50,
                                h: zapFrH,
                                t: TK,
                                z: 'i'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Trasera zapatero',
                                q: reps,
                                w: W - 2 * TK - 40,
                                h: zapFrH,
                                t: TK,
                                z: 'i'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Fondo zapatero',
                                q: reps,
                                w: W - 2 * TK - 20,
                                h: D - 50,
                                t: TK,
                                z: 'i'
                            });
                            autoHW.push({
                                key: 'corr_eco',
                                q: reps,
                                modId: mid
                            });
                        }
                    });
                } // end qm!=='solo_puertas' (structure+zones)

                // Doors
                var doorMode = m.doorMode || 'por_zona';
                if (m.doors && doorMode === 'completa') {
                    // Full-height doors spanning entire module
                    var fullDoorCnt = m.doorCount || 2;
                    var fullDoorMat = m.doorMaterial || 'melamina';
                    var fullDoorType = m.doorType || 'tipon';
                    var fullDoorW = Math.round(W / fullDoorCnt) - 3;
                    var fullDoorH = H - 3; // full espacio util height minus gap
                    if (fullDoorMat === 'melamina') {
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Puerta completa',
                            q: fullDoorCnt,
                            w: fullDoorW,
                            h: fullDoorH,
                            t: TK,
                            c: 4,
                            z: 'f'
                        });
                    }
                    // Bisagra count from CONFIG rules based on door height
                    var fullDoorHeightCm = estModHeight(m);
                    var fullDoorMat = m.doorMaterial || 'melamina';
                    var hingasPerDoor = getBisagraCount(fullDoorHeightCm, fullDoorMat);
                    autoHW.push({
                        key: 'bisagra',
                        q: hingasPerDoor * fullDoorCnt,
                        modId: mid
                    });
                    autoHW.push({
                        key: 'base_clip',
                        q: hingasPerDoor * fullDoorCnt,
                        modId: mid
                    });
                    if (fullDoorType === 'tipon') {
                        autoHW.push({
                            key: 'tipon',
                            q: fullDoorCnt,
                            modId: mid
                        });
                        autoHW.push({
                            key: 'placa_tipon',
                            q: fullDoorCnt,
                            modId: mid
                        });
                    }
                    else if (fullDoorType === 'jaladera') {
                        autoHW.push({
                            key: 'jaladera',
                            q: fullDoorCnt,
                            modId: mid
                        });
                    }
                } else if (doorMode === 'por_zona') {
                    // Per-zone doors
                    m.zones.forEach(function(z) {
                        if (!z.doors)
                            return;
                        var zH = Math.round(getEstZoneDisplayHeight(m, z) * 10); // zone height in mm
                        var pw2 = Math.round(W / 2) - 3;
                        var dMat = z.doorMaterial || 'melamina';
                        var dType = z.doorType || 'tipon';
                        var zLabel = EST_ZONE_TYPES.find(function(x) {
                            return x.id === z.type;
                        });
                        var doorName = 'Puerta ' + (zLabel ? zLabel.n : z.type);
                        if (dMat === 'melamina') {
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: doorName,
                                q: 2,
                                w: pw2,
                                h: zH - 3,
                                t: TK,
                                c: 4,
                                z: 'f'
                            });
                        }
                        // Hardware: bisagras per door from CONFIG rules
                        var zoneDoorHeightCm = Math.round(getEstZoneDisplayHeight(m, z));
                        var zoneBisCount = getBisagraCount(zoneDoorHeightCm, dMat);
                        autoHW.push({
                            key: 'bisagra',
                            q: zoneBisCount * 2,
                            modId: mid
                        });
                        autoHW.push({
                            key: 'base_clip',
                            q: zoneBisCount * 2,
                            modId: mid
                        });
                        if (dType === 'tipon') {
                            autoHW.push({
                                key: 'tipon',
                                q: 2,
                                modId: mid
                            });
                            autoHW.push({
                                key: 'placa_tipon',
                                q: 2,
                                modId: mid
                            });
                        }
                        else if (dType === 'jaladera') {
                            autoHW.push({
                                key: 'jaladera',
                                q: 2,
                                modId: mid
                            });
                        }

                    });
                }
                // jaladera_int: fresada, no additional hardware

                // Zoclo (baseboard - outside 2m, 55cm depth, arremetido)
                if (qm !== 'solo_puertas') {
                    var zoc = m.zoclo || {
                        enabled: false,
                        height: 10
                    };
                    if (zoc.enabled) {
                        var zocH = (zoc.height || 10) * 10; // height in mm
                        var zocD = 550; // 55cm depth
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Zoclo frente',
                            q: 1,
                            w: W,
                            h: zocH,
                            t: TK,
                            c: 1,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Zoclo trasera',
                            q: 1,
                            w: W,
                            h: zocH,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Zoclo lateral',
                            q: 2,
                            w: zocD,
                            h: zocH,
                            t: TK,
                            c: 1,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Zoclo larguero',
                            q: 2,
                            w: zocD - 2 * TK,
                            h: zocH,
                            t: TK,
                            z: 'i'
                        });
                    }

                    // Maletero (on top of module, outside height)
                    var mal = m.maletero || {
                        enabled: false,
                        height: 30
                    };
                    if (mal.enabled) {
                        var malH = (mal.height || 30) * 10;
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Lateral maletero',
                            q: 2,
                            w: D - 50,
                            h: malH - 30,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Trasera maletero',
                            q: 1,
                            w: W - 2 * TK - 40,
                            h: malH - 30,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Fondo maletero',
                            q: 1,
                            w: W - 2 * TK - 20,
                            h: D - 50,
                            t: TK,
                            z: 'i'
                        });
                        autoHW.push({
                            key: 'corr_eco',
                            q: 1,
                            modId: mid
                        });
                        // Maletero doors
                        if (mal.doors) {
                            var malDoorH = malH - 3;
                            var malPw2 = Math.round(W / 2) - 3;
                            var malDMat = mal.doorMaterial || 'melamina';
                            var malDType = mal.doorType || 'tipon';
                            if (malDMat === 'melamina') {
                                pieces.push({
                                    mid: mid,
                                    mn: mname,
                                    mw: m.width,
                                    n: 'Puerta maletero',
                                    q: 2,
                                    w: malPw2,
                                    h: malDoorH,
                                    t: TK,
                                    c: 4,
                                    z: 'f'
                                });
                            }
                            var malHeightCm = mal.height || 30;
                            var malBisCount = getBisagraCount(malHeightCm, malDMat);
                            autoHW.push({
                                key: 'bisagra',
                                q: malBisCount * 2,
                                modId: mid
                            });
                            autoHW.push({
                                key: 'base_clip',
                                q: malBisCount * 2,
                                modId: mid
                            });
                            if (malDType === 'tipon') {
                                autoHW.push({
                                    key: 'tipon',
                                    q: 2,
                                    modId: mid
                                });
                                autoHW.push({
                                    key: 'placa_tipon',
                                    q: 2,
                                    modId: mid
                                });
                            }
                            else if (malDType === 'jaladera') {
                                autoHW.push({
                                    key: 'jaladera',
                                    q: 2,
                                    modId: mid
                                });
                            }
                        }
                    }

                    // Niveladores per module
                    autoHW.push({
                        key: 'nivelador',
                        q: 4,
                        modId: mid
                    });
                } // end qm!=='solo_puertas' (zoclo+maletero+niveladores)
            });

            // Calculate areas, sheets, canto  all pieces use project thickness
            var TK_EST = EP.thickness || 16;
            var areaF = 0, areaI = 0, cantoF = 0, cantoI = 0;
            pieces.forEach(function(p) {
                var a = (p.w / 1000) * (p.h / 1000) * p.q;
                if (useDual && p.z === 'i') areaI += a;
                else areaF += a;
                var ml = 0;
                if (p.c) {
                    if (p.c === 4)
                        ml = ((p.w + p.h) * 2 / 1000) * p.q;
                    else if (p.c === 2)
                        ml = ((p.w + p.h) / 1000) * p.q;
                    else
                        ml = (Math.max(p.w, p.h) / 1000) * p.q;
                } else {
                    ml = (Math.max(p.w, p.h) / 1000) * p.q;
                }
                if (useDual && p.z === 'i')
                    cantoI += ml;
                else
                    cantoF += ml;
            });

            // Add chapacanto from module edge selections
            EP.modules.forEach(function(m) {
                var chapML = calcEstChapML(m, EP.thickness);
                cantoF += chapML;
            });

            var SHEET = 1.22 * 2.44;
            var merma = CONFIG.pricing.mermaFactor;
            var totalSheetsF = Math.ceil(areaF * merma / SHEET);
            var totalSheetsI = Math.ceil(areaI * merma / SHEET);
            var sheetsF = { 16: 0, 25: 0 }; sheetsF[TK_EST] = totalSheetsF;
            var sheetsI = { 16: 0, 25: 0 }; sheetsI[TK_EST] = totalSheetsI;
            cantoF = Math.ceil(cantoF);
            cantoI = Math.ceil(cantoI);
            var totalSheets = totalSheetsF + totalSheetsI;
            var totalCanto = cantoF + cantoI;

            var matPriceF = getMatPrice(EP.matFrentes, TK_EST);
            var matPriceI = getMatPrice(EP.matInterior, TK_EST);
            var matCostF = totalSheetsF * matPriceF;
            var matCostI = totalSheetsI * matPriceI;
            var chapCostF = cantoF * EP.chapFrentesPrice;
            var chapCostI = cantoI * EP.chapInteriorPrice;
            var corteCost = totalSheets * CONFIG.pricing.cuttingCostPerSheet;
            var enchapPrice = typeof EP.enchapPrice === 'number' ? EP.enchapPrice : 13;
            var enchapCost = totalCanto * enchapPrice;
            var carpCost = matCostF + matCostI + chapCostF + chapCostI + corteCost + enchapCost + EP.laborCost + (EP.freight ? EP.freightCost : 0);

            // Apply module-level hwOverrides: adjust autoHW quantities before consolidation
            var modAutoHW = autoHW.map(function(ah) {
                return {
                    key: ah.key,
                    q: ah.q,
                    modId: ah.modId
                };
            });
            EP.modules.forEach(function(m) {
                if (!m.hwOverrides)
                    return;
                // Consolidate auto quantities per key for this module
                var modTotals = {};
                modAutoHW.forEach(function(ah) {
                    if (ah.modId !== m.id)
                        return;
                    if (!modTotals[ah.key])
                        modTotals[ah.key] = 0;
                    modTotals[ah.key] += ah.q;
                });
                for (var ok in m.hwOverrides) {
                    if (typeof modTotals[ok] === 'undefined')
                        continue;
                    var autoTotal = modTotals[ok];
                    var overrideQty = m.hwOverrides[ok];
                    if (overrideQty === autoTotal)
                        continue;
                    // Distribute the override: scale each entry proportionally or set the first and zero others
                    var entries = modAutoHW.filter(function(ah) {
                        return ah.modId === m.id && ah.key === ok;
                    });
                    if (entries.length === 1) {
                        entries[0].q = overrideQty;
                    } else if (entries.length > 1) {
                        entries[0].q = overrideQty;
                        for (var ei = 1; ei < entries.length; ei++)
                            entries[ei].q = 0;
                    }
                }
            });

            var hwConsolidated = {};
            // First pass: compute true autoQty from original autoHW
            autoHW.forEach(function(ah) {
                var def = HW_DEFAULTS[ah.key];
                if (!def)
                    return;
                var catItem = findCatItem(def.desc, def.marca);
                var price = catItem ? adjPrice(catItem) : def.fallback;
                var k = ah.key;
                if (!hwConsolidated[k])
                    hwConsolidated[k] = {
                        key: k,
                        desc: def.desc,
                        marca: def.marca,
                        price: price,
                        qty: 0,
                        autoQty: 0,
                        cat: def.cat,
                        catItem: catItem
                    };
                hwConsolidated[k].autoQty += ah.q;
            });
            // Second pass: compute effective qty from overridden modAutoHW
            modAutoHW.forEach(function(ah) {
                var k = ah.key;
                if (!hwConsolidated[k])
                    return;
                hwConsolidated[k].qty += ah.q;
            });
            // Apply hardware overrides (qty changes and item swaps)
            var ov = EP.hwOverrides || {};
            for (var ok in ov) {
                if (!hwConsolidated[ok])
                    continue;
                var o = ov[ok];
                if (typeof o.qty === 'number')
                    hwConsolidated[ok].qty = Math.max(0, o.qty);
                if (o.swap) {
                    hwConsolidated[ok].desc = o.swap.desc;
                    hwConsolidated[ok].marca = o.swap.marca;
                    hwConsolidated[ok].price = o.swap.price;
                    hwConsolidated[ok].catItem = o.swap.catItem || null;
                }
            }
            var manualHW = [];
            EP.hardware.forEach(function(h2) {
                manualHW.push({
                    desc: h2.descripcion,
                    marca: h2.marca,
                    price: adjPrice(h2),
                    qty: h2.qty,
                    cat: h2.categoria,
                    codigo: h2.codigo
                });
            });

            var hwCostCarpBucket = 0,
                hwCostPremium = 0;
            var hwCostHerraxa = 0,
                hwCostHafele = 0,
                hwCostBlum = 0;
            var allHW = [];
            var hwThreshold = CONFIG.pricing.hardwareThreshold;
            for (var k in hwConsolidated) {
                var h2 = hwConsolidated[k];
                allHW.push(h2);
                var cost = Math.ceil(h2.qty) * h2.price;
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h2._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h2._bucket = 'premium';
                }
                if (h2.marca === 'BLUM') hwCostBlum += cost;
                else if (h2.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            }
            manualHW.forEach(function(h2) {
                allHW.push(h2);
                var cost = Math.ceil(h2.qty) * h2.price;
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h2._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h2._bucket = 'premium';
                }
                if (h2.marca === 'BLUM') hwCostBlum += cost;
                else if (h2.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            });
            var hwStdCost = hwCostHerraxa + hwCostHafele;

            var extraCost = 0;
            var ledBOM = calcEstLedBOM();
            if (ledBOM)
                extraCost += ledBOM.totalCost;

            // Vidrio cost: accumulate from zones, full-height doors, and maletero doors
            var vidrioCost = 0;
            EP.modules.forEach(function(m) {
                var doorMode = m.doorMode || 'por_zona';
                if (m.doors && doorMode === 'completa' && (m.doorMaterial || 'melamina') === 'vidrio') {
                    vidrioCost += (m.vidrioPrice || 0);
                }
                if (m.doors && doorMode === 'por_zona') {
                    m.zones.forEach(function(z) {
                        if (z.doors && (z.doorMaterial || 'melamina') === 'vidrio') {
                            vidrioCost += (z.vidrioPrice || 0);
                        }
                    });
                }
                var mal = m.maletero || {
                    enabled: false
                };
                if (mal.enabled && mal.doors && (mal.doorMaterial || 'melamina') === 'vidrio') {
                    vidrioCost += (mal.vidrioPrice || 0);
                }
            });
            if (vidrioCost > 0)
                extraCost += vidrioCost;
            var paintCost = 0;
            EP.modules.forEach(function(m2) {
                if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                    var pm2 = calcPaintM2(m2, {
                        mode: 'est'
                    });
                    var liters = calcPaintLiters(pm2, m2.paint.coats);
                    paintCost += liters * m2.paint.pricePerLiter;
                }
            });
            if (paintCost > 0)
                extraCost += paintCost;

            var mult = EP.saleMultiplier || CONFIG.pricing.defaultSaleMultiplier;
            var carpMultiplier = CONFIG.pricing.carpentryMultiplier;
            var premiumMargin = CONFIG.pricing.premiumHardwareMargin;
            // Carpentry + low-cost hardware ( threshold)  carpentry multiplier (3x)
            var carpSale = (carpCost + hwCostCarpBucket) * carpMultiplier;
            // Premium hardware (> threshold)  margin-based (cost / 0.70 = 30% margin)
            var hwPremiumSale = hwCostPremium > 0 ? hwCostPremium / (1 - premiumMargin) : 0;
            // Extras
            var extrasSale = extraCost * CONFIG.pricing.extrasMultiplier;
            var totalCostAll = carpCost + hwCostCarpBucket + hwCostPremium + extraCost;
            var subtotal = carpSale + hwPremiumSale + extrasSale;
            var iva = subtotal * CONFIG.pricing.iva;
            var total = subtotal + iva;
            var profit = subtotal - totalCostAll;
            var margin = subtotal > 0 ? ((profit / subtotal) * 100).toFixed(1) : 0;

            return {
                pieces: pieces,
                autoHW: autoHW,
                allHW: allHW,
                hwConsolidated: hwConsolidated,
                manualHW: manualHW,
                sheetsF: sheetsF,
                sheetsI: sheetsI,
                cantoF: cantoF,
                cantoI: cantoI,
                totalSheetsF: totalSheetsF,
                totalSheetsI: totalSheetsI,
                totalSheets: totalSheets,
                totalCanto: totalCanto,
                matCostF: matCostF,
                matCostI: matCostI,
                chapCostF: chapCostF,
                chapCostI: chapCostI,
                corteCost: corteCost,
                enchapCost: enchapCost,
                carpCost: carpCost,
                hwCostCarpBucket: hwCostCarpBucket,
                hwCostPremium: hwCostPremium,
                hwCostHerraxa: hwCostHerraxa,
                hwCostHafele: hwCostHafele,
                hwCostBlum: hwCostBlum,
                hwStdCost: hwStdCost,
                extraCost: extraCost,
                vidrioCost: vidrioCost,
                ledBOM: ledBOM,
                paintCost: paintCost,
                carpSale: carpSale,
                hwPremiumSale: hwPremiumSale,
                extrasSale: extrasSale,
                subtotal: subtotal,
                iva: iva,
                total: total,
                totalCost: totalCostAll,
                profit: profit,
                margin: margin,
                useDual: useDual,
                saleMultiplier: mult,
                projThickness: TK_EST,
                matPriceF: matPriceF,
                matPriceI: matPriceI
            };
        }

        // === RENDER FUNCTIONS ===
        function renderTemplates() {
            var h = '<div class="tpl-grid">';
            h += '<div class="title"><h2>Plantillas</h2><p>Selecciona un diseno para cotizar</p></div>';
            h += '<button class="tpl-new" onclick="APP.newProject()">' + svg('plus') + 'Nuevo proyecto desde cero</button>';
            h += '<button class="est-home-btn" onclick="APP.newEstandarizado()">&#x1f5c4;&#xfe0f; Closet Estandarizado</button>';
            // Saved projects
            var saved = loadSavedProjects();
            if (saved.length > 0) {
                h += '<div class="saved-projects-section">';
                var cloudIcon = cloudProjects !== null ? '<span style="color:#4ade80;font-size:11px;margin-left:8px">&#9729; En la nube</span>' : '<span style="color:#fbbf24;font-size:11px;margin-left:8px">&#9729; Sincronizando...</span>';
                h += '<div class="saved-projects-title">Proyectos Guardados (' + saved.length + ')' + cloudIcon + '</div>';
                saved.forEach(function(sp, idx) {
                    h += '<div class="saved-project-card">';
                    h += '<div class="saved-project-info">';
                    h += '<div class="sp-client">' + (sp.client || 'Sin nombre') + '</div>';
                    h += '<div class="sp-meta">' + sp.label + ' &middot; ' + (sp.savedAt ? new Date(sp.savedAt).toLocaleDateString('es-MX', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                    }) : '') + '</div>';
                    h += '</div>';
                    h += '<div class="saved-project-actions">';
                    h += '<button class="sp-load" onclick="APP.loadSavedProject(' + idx + ')">Cargar</button>';
                    h += '<button class="sp-del" onclick="APP.deleteSavedProject(' + idx + ')">&times;</button>';
                    h += '</div></div>';
                });
                h += '</div>';
            }
            /* TEMPLATES hidden
            TEMPLATES.forEach(function(t) {
                var typeName = TYPES.find(function(x) {
                    return x.id === t.type;
                });
                h += '<div class="tpl-card">';
                h += '<img class="tpl-card-img" src="' + t.photo + '" alt="' + t.name + '" onclick="APP.openImg(\'' + t.photo + '\')" onerror="this.outerHTML=\'<div style=height:180px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;font-size:48px>&#x1f4f7;</div>\'">';
                h += '<div class="tpl-card-body">';
                h += '<div class="tpl-card-name">' + t.name + '</div>';
                if (typeName)
                    h += '<span class="tpl-card-type">' + typeName.n + '</span>';
                h += '<div class="tpl-card-desc">' + t.desc + '</div>';
                h += '<div class="tpl-card-dims">' + (t.baseWidth / 100) + 'm ancho x ' + (t.baseHeight / 100) + 'm alto</div>';
                h += '<div class="tpl-card-price">' + fmt(t.basePrice) + '</div>';
                h += '<button class="tpl-card-btn" onclick="APP.selectTpl(\'' + t.id + '\')">Usar plantilla</button>';
                h += '</div></div>';
            });
            */
            h += '</div>';
            return h;
        }

        function renderQuickQuote() {
            var t = TEMPLATES.find(function(x) {
                return x.id === S.selTemplate;
            });
            if (!t)
                return '';
            var nw = S.quickWidth,
                nh = S.quickHeight;
            // CUSTOMIZE: Quick quote ratio logic  adjust pricing formula here
            var ratio = (nw * nh) / (t.baseWidth * t.baseHeight);
            var newPrice = Math.round(t.basePrice * ratio / 500) * 500;
            var iva = newPrice * CONFIG.pricing.iva;
            var total = newPrice + iva;
            var matName = S.quickMatName || t.matName;
            var matFinish = S.quickMatFinish || t.matFinish;
            var matDisplay = S.quickMatName ? matName + ' (' + matFinish + ')' : t.material;
            var h = '<img class="qq-img" src="' + t.photo + '" alt="' + t.name + '" onclick="APP.openImg(\'' + t.photo + '\')" style="cursor:pointer" onerror="this.style.display=\'none\'">';
            h += '<div class="qq-body">';
            h += '<div class="qq-name">' + t.name + '</div>';
            h += '<div class="qq-desc">' + t.desc + '</div>';
            h += '<div class="qq-section"><div class="qq-section-title">Ajustar medidas</div>';
            h += '<div class="qq-dim-row"><label>Ancho:</label><input class="qq-dim-input" type="number" value="' + (nw / 100) + '" step="0.1" min="0.5" max="8" onchange="APP.setQW(parseFloat(this.value)*100)"><span>m</span></div>';
            h += '<div class="qq-dim-row"><label>Alto:</label><input class="qq-dim-input" type="number" value="' + (nh / 100) + '" step="0.1" min="0.5" max="4" onchange="APP.setQH(parseFloat(this.value)*100)"><span>m</span></div>';
            h += '<div class="qq-base-ref" style="font-size:12px;color:#999;text-align:center;margin-top:4px">Base: ' + (t.baseWidth / 100) + 'm x ' + (t.baseHeight / 100) + 'm = ' + fmt(t.basePrice) + '</div></div>';
            h += '<div class="qq-section"><div class="qq-section-title">Material</div>';
            h += '<select class="qq-mat-select" onchange="APP.setQMat(this.value)">';
            h += '<option value=""' + (S.quickMat === '' ? ' selected' : '') + '>' + t.material + ' (original)</option>';
            COLORS.forEach(function(c) {
                h += '<option value="' + c.c + '"' + (S.quickMat === c.c ? ' selected' : '') + '>' + c.c + ' - ' + c.n + ' (' + c.f + ')</option>';
            });
            h += '</select></div>';
            h += '<div class="qq-price-box"><div class="qq-price-label">Precio estimado</div><div class="qq-price">' + fmt(newPrice) + '</div><div class="qq-price-iva">+ IVA = ' + fmt(total) + '</div></div>';
            h += '<div class="qq-info"><div class="qq-info-item"><span>Material</span><strong>' + matDisplay + '</strong></div><div class="qq-info-item"><span>Entrega</span><strong>' + t.weeks + ' semanas</strong></div><div class="qq-info-item"><span>Anticipo</span><strong>60%</strong></div><div class="qq-info-item"><span>Medida</span><strong>' + (nw / 100) + 'm x ' + (nh / 100) + 'm</strong></div></div>';
            h += '<div class="pdf-actions" style="margin-top:16px">';
            h += '<button class="pdf-btn client" onclick="APP.genQuickPDF(\'client\')">&#x1f4c4; PDF Cliente</button>';
            h += '<button class="pdf-btn internal" onclick="APP.genQuickPDF(\'internal\')">&#x1f512; PDF Interno</button>';
            h += '<button class="pdf-btn despiece" onclick="APP.genQuickPDF(\'despiece\')">&#x1f4cb; PDF Despiece</button>';
            h += '</div>';
            h += '<button class="qq-full-btn" onclick="APP.fullQuote()">' + svg('edit') + 'Editar en cotizador completo</button></div>';
            return h;
        }

        function renderMaterialSelect(label, mat, onChange, badgeClass) {
            var araucoTabs = getAraucoTableros();
            var h = '<div class="mat-section">';
            h += '<div class="mat-section-label">' + label;
            if (badgeClass)
                h += ' <span class="badge ' + badgeClass + '">' + (badgeClass === 'vis' ? 'visible' : 'oculto') + '</span>';
            h += '</div>';
            h += '<select class="mat-select" onchange="' + onChange + '(this.value)">';
            h += '<optgroup label="FINSA (Melamina)">';
            COLORS.forEach(function(c) {
                var sel = (mat.brand === 'FINSA' && mat.code === c.c) ? ' selected' : '';
                h += '<option value="FINSA:' + c.c + '"' + sel + '>' + c.c + ' - ' + c.n + ' (' + c.f + ') - ' + fmt(FINSA_PRICES[16]) + '/hoja</option>';
            });
            h += '</optgroup>';
            if (araucoTabs.length > 0) {
                h += '<optgroup label="ARAUCO (Tableros)">';
                araucoTabs.forEach(function(item, idx) {
                    var sel = (mat.brand === 'ARAUCO' && mat.catItem && mat.catItem.codigo === item.codigo) ? ' selected' : '';
                    h += '<option value="ARAUCO:' + idx + '"' + sel + '>' + item.descripcion + ' - ' + fmtD(item.precio) + '</option>';
                });
                h += '</optgroup>';
            }
            var customSel = mat.brand === 'CUSTOM' ? ' selected' : '';
            h += '<option value="CUSTOM:0"' + customSel + '>\u2014 Material personalizado \u2014</option>';
            h += '</select>';
            if (mat.brand === 'CUSTOM') {
                h += '<div style="display:flex;gap:12px;margin-top:8px">';
                h += '<div style="flex:2"><span style="font-size:12px;color:#bbb">Nombre</span><input type="text" value="' + (mat.name || '') + '" placeholder="Ej: MDF Nogal" onchange="' + onChange + '(\'CUSTOM_NAME:\'+this.value)" style="margin-top:4px"></div>';
                h += '<div style="flex:1"><span style="font-size:12px;color:#bbb">Precio/hoja</span><input type="number" value="' + (mat.customPrice || 0) + '" min="0" step="50" onchange="' + onChange + '(\'CUSTOM_PRICE:\'+this.value)" style="margin-top:4px"></div>';
                h += '</div>';
            }
            var matInfoStr = mat.brand === 'CUSTOM' ? (mat.name || 'Personalizado') + ' - ' + fmt(mat.customPrice || 0) + '/hoja' : mat.brand + ': ' + (mat.brand === 'FINSA' ? mat.name + ' (' + mat.finish + ')' : mat.catItem ? mat.catItem.descripcion : '');
            h += '<div class="mat-info">' + matInfoStr + '</div>';
            h += '</div>';
            return h;
        }

        function renderModuleLed(m) {
            var P = S.project;
            if (!m.led)
                m.led = {
                    enabled: false,
                    edges: {
                        top: false,
                        bottom: false,
                        left: false,
                        right: false,
                        shelves: false
                    },
                    shelfCount: 0,
                    ledMeters: 0,
                    segments: 0,
                    metersOverride: null,
                    segmentsOverride: null
                };
            var led = m.led;
            var h = '<div class="led-section">';
            h += '<div class="led-toggle-row"><span>&#x1f4a1; Iluminacion LED</span><button class="toggle' + (led.enabled ? ' on' : '') + '" onclick="APP.togModLed(\'' + m.id + '\')"></button></div>';
            if (!led.enabled) {
                h += '</div>';
                return h;
            }
            // Edge selector
            h += '<div class="led-edges">';
            h += '<div style="position:relative;padding:18px 34px">';
            h += '<div class="led-edge-box">';
            h += '<button class="led-edge top' + (led.edges.top ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'top\')"></button>';
            h += '<button class="led-edge bottom' + (led.edges.bottom ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'bottom\')"></button>';
            h += '<button class="led-edge left' + (led.edges.left ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'left\')"></button>';
            h += '<button class="led-edge right' + (led.edges.right ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'right\')"></button>';
            h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;color:#666;pointer-events:none;text-align:center;white-space:nowrap">' + m.width + 'x' + (m.height || P.defaultHeight || 200) + '</div>';
            h += '</div></div>';
            h += '<div class="led-opts">';
            // Shelf LED toggle + count
            h += '<div class="led-shelf-row"><button class="' + (led.edges.shelves ? 'on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'shelves\')">' + (led.edges.shelves ? '&#10003;' : '') + ' Entrepaos</button>';
            if (led.edges.shelves)
                h += '<input type="number" value="' + led.shelfCount + '" min="0" max="10" onchange="APP.setLedShelves(\'' + m.id + '\',parseInt(this.value))">';
            h += '</div>';
            // Auto-calc display
            var auto = calcModuleLedMeters(m);
            var usedM = (led.metersOverride !== null && led.metersOverride >= 0) ? led.metersOverride : auto.meters;
            var usedS = (led.segmentsOverride !== null && led.segmentsOverride >= 0) ? led.segmentsOverride : auto.segments;
            h += '<div class="led-meters"><span>Metros:</span><input type="number" value="' + usedM.toFixed(2) + '" min="0" step="0.1" onchange="APP.setLedMeters(\'' + m.id + '\',parseFloat(this.value))">';
            h += '<span>Segmentos:</span><input type="number" value="' + usedS + '" min="0" step="1" onchange="APP.setLedSegments(\'' + m.id + '\',parseInt(this.value))">';
            if (led.metersOverride !== null || led.segmentsOverride !== null)
                h += '<button style="padding:2px 6px;border-radius:4px;border:1px solid #fbbf24;background:none;color:#fbbf24;font-size:10px;cursor:pointer" onclick="APP.resetLedOverride(\'' + m.id + '\')">Auto</button>';
            h += '</div>';
            h += '</div></div>';
            // Activation type (project-level)
            h += '<div style="font-size:11px;color:#999;margin-bottom:4px">Activacion:</div>';
            h += '<div class="led-radio">';
            [{
                k: 'presion',
                l: 'Presion',
                p: LED_CATALOG.switches.presion.price
            }, {
                k: 'dimmer',
                l: 'Dimmer',
                p: LED_CATALOG.switches.dimmer.price
            }, {
                k: 'movimiento',
                l: 'Movimiento',
                p: LED_CATALOG.switches.movimiento.price
            }, {
                k: 'puerta',
                l: 'Puerta',
                p: LED_CATALOG.switches.puerta.price
            }].forEach(function(sw) {
                h += '<button class="' + (P.ledConfig.activation === sw.k ? 'sel' : '') + '" onclick="APP.setLedActivation(\'' + sw.k + '\')">' + sw.l + ' ' + fmtD(sw.p) + '</button>';
            });
            h += '</div>';
            // Light temperature (project-level)
            h += '<div style="font-size:11px;color:#999;margin:4px 0">Temperatura:</div>';
            h += '<div class="led-radio">';
            h += '<button class="' + (P.ledConfig.lightTemp === 'calida' ? 'sel' : '') + '" onclick="APP.setLedTemp(\'calida\')">Calida 3000K</button>';
            h += '<button class="' + (P.ledConfig.lightTemp === 'fria' ? 'sel' : '') + '" onclick="APP.setLedTemp(\'fria\')">Fria 5000K</button>';
            h += '</div>';
            // Mini BOM preview (project-level, shown on first module with LED)
            var ledBOM = calcLedBOM();
            if (ledBOM) {
                h += '<div class="led-bom-preview">';
                h += '<div style="font-size:10px;color:#999;margin-bottom:4px">Lista de Material LED (auto)</div>';
                ledBOM.items.forEach(function(it) {
                    h += '<div class="led-bom-row"><span>' + it.qty + 'x ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                });
                h += '<div class="led-bom-total"><span>Costo LED</span><strong>' + fmtD(ledBOM.totalCost) + '</strong></div>';
                h += '<div class="led-bom-total" style="border:none;padding-top:0;margin-top:0;font-size:11px"><span>Venta LED (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong>' + fmtD(ledBOM.totalCost * CONFIG.pricing.extrasMultiplier) + '</strong></div>';
                h += '</div>';
            }
            h += '</div>';
            return h;
        }

        function renderModulePaint(m) {
            var P = S.project;
            if (!m.paint)
                m.paint = {
                    enabled: false,
                    name: '',
                    pricePerLiter: 0,
                    coats: 2,
                    scope: 'doors'
                };
            var paint = m.paint;
            var h = '<div style="margin-top:8px;padding:8px;background:#1a1a2e;border-radius:8px;border:1px solid #2a2a3a">';
            h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:13px;color:#e0e0e0">&#x1f3a8; Pintura</span><button class="toggle' + (paint.enabled ? ' on' : '') + '" onclick="APP.togPaint(\'' + m.id + '\')"></button></div>';
            if (!paint.enabled) {
                h += '</div>';
                return h;
            }
            var qm = m.quoteMode || 'completo';
            h += '<div style="display:flex;flex-direction:column;gap:6px">';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:#999;min-width:60px">Nombre:</span><input type="text" value="' + (paint.name || '') + '" placeholder="Ej: Laqueado blanco" style="flex:1;font-size:12px;padding:4px 8px;background:#111;border:1px solid #3a3a3a;border-radius:4px;color:#fff" onchange="APP.setPaintName(\'' + m.id + '\',this.value)"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:#999;min-width:60px">$/Litro:</span><input type="number" value="' + paint.pricePerLiter + '" min="0" step="50" style="width:90px;font-size:12px;padding:4px 8px;background:#111;border:1px solid #3a3a3a;border-radius:4px;color:#fff" onchange="APP.setPaintPrice(\'' + m.id + '\',parseFloat(this.value))"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:#999;min-width:60px">Manos:</span><input type="number" value="' + (paint.coats || 2) + '" min="1" max="5" step="1" style="width:60px;font-size:12px;padding:4px 8px;background:#111;border:1px solid #3a3a3a;border-radius:4px;color:#fff" onchange="APP.setPaintCoats(\'' + m.id + '\',parseInt(this.value))"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:#999;min-width:60px">Alcance:</span>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'doors' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'doors\')">Puertas</button>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'structure' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'structure\')">Estructura</button>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'all' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'all\')">Todo</button>';
            h += '</div>';
            var coats = paint.coats || 2;
            var pm2 = calcPaintM2(m, {
                mode: 'custom',
                defaultHeight: P.defaultHeight,
                defaultDepth: P.defaultDepth
            });
            var liters = calcPaintLiters(pm2, coats);
            var buyLiters = Math.ceil(liters);
            var cost = liters * paint.pricePerLiter;
            h += '<div style="font-size:12px;color:#60a5fa;padding:2px 0">' + pm2.toFixed(2) + ' m\u00b2 \u00d7 ' + coats + ' manos \u00f7 10 m\u00b2/L = ' + liters.toFixed(2) + ' L &rarr; ' + fmtD(Math.round(cost)) + '</div>';
            h += '<div style="font-size:11px;color:#999;padding:1px 0">Comprar: ' + buyLiters + ' L</div>';
            if (pm2 === 0 && paint.scope === 'doors' && !m.doors && qm !== 'solo_puertas')
                h += '<div style="font-size:11px;color:#f87171">Sin puertas \u2014 0 m\u00b2</div>';
            if (pm2 === 0 && paint.scope === 'structure' && qm === 'solo_puertas')
                h += '<div style="font-size:11px;color:#f87171">Solo puertas \u2014 sin estructura</div>';
            h += '</div></div>';
            return h;
        }

        function step1() {
            var P = S.project;
            var h = '<div class="title"><h2>Nuevo Proyecto</h2><p>Informacion basica</p></div>';
            h += '<div class="field"><label>Nombre del Cliente</label><input type="text" id="client" value="' + P.client + '" placeholder="Ej: Juan Perez" oninput="APP.setClient(this.value)"></div>';
            h += '<div class="field"><label>Tipo de Proyecto</label><div class="grid2">';
            TYPES.forEach(function(t) {
                h += '<button class="type-btn' + (P.type === t.id ? ' sel' : '') + '" onclick="APP.setType(\'' + t.id + '\')"><span>' + t.i + '</span>' + t.n + '</button>';
            });
            h += '</div></div>';
            // Dual material toggle
            if (isDualType(P.type)) {
                h += '<div class="mat-toggle-row"><span>Usar mismo material para todo</span><button class="toggle' + (P.sameMaterial ? ' on' : '') + '" onclick="APP.togSameMat()"></button></div>';
            }
            // Material selection
            if (P.sameMaterial || !isDualType(P.type)) {
                h += renderMaterialSelect('Material', 'matFrentes' in P ? P.matFrentes : defaultMat(), 'APP.setMatFrentes', '');
            } else {
                h += renderMaterialSelect('Material Frentes', 'matFrentes' in P ? P.matFrentes : defaultMat(), 'APP.setMatFrentes', 'vis');
                h += renderMaterialSelect('Material Interior', 'matInterior' in P ? P.matInterior : defaultMat(), 'APP.setMatInterior', 'hid');
            }
            // Thickness
            var qqStdThicks = [16, 18, 25];
            var qqCustomThk = qqStdThicks.indexOf(P.thickness) === -1;
            h += '<div class="field"><label>Espesor Principal</label><div style="display:flex;gap:8px;flex-wrap:wrap">';
            qqStdThicks.forEach(function(t) {
                h += '<button class="thick-btn' + (P.thickness === t ? ' sel' : '') + '" onclick="APP.setThick(' + t + ')">' + t + 'mm</button>';
            });
            h += '<button class="thick-btn' + (qqCustomThk ? ' sel' : '') + '" onclick="APP.setCustomThick()">Otro</button>';
            h += '</div>';
            if (qqCustomThk) {
                h += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input type="number" value="' + P.thickness + '" min="3" max="50" step="1" style="width:80px" onchange="APP.setThick(parseInt(this.value))"><span style="color:#bbb">mm</span></div>';
            }
            h += '<p class="hint">Todas las piezas usan el espesor seleccionado</p></div>';
            // Chapacanto
            h += '<div class="field"><label>Chapacanto ($/ml)</label>';
            if (P.sameMaterial || !isDualType(P.type)) {
                h += '<input type="number" value="' + P.chapFrentesPrice + '" step="0.1" onchange="APP.setChapF(parseFloat(this.value))" style="width:120px">';
            } else {
                h += '<div style="display:flex;gap:12px;margin-bottom:8px"><div style="flex:1"><span style="font-size:12px;color:#60a5fa">Frentes</span><input type="number" value="' + P.chapFrentesPrice + '" step="0.1" onchange="APP.setChapF(parseFloat(this.value))"></div>';
                h += '<div style="flex:1"><span style="font-size:12px;color:#9ca3af">Interior</span><input type="number" value="' + P.chapInteriorPrice + '" step="0.1" onchange="APP.setChapI(parseFloat(this.value))"></div></div>';
            }
            h += '<div style="margin-top:8px"><span style="font-size:12px;color:#bbb">Especificacion del canto</span><input type="text" value="' + (P.chapSpec || '') + '" placeholder="Ej: 1mm x 19mm ABS para refilar" oninput="APP.setChapSpec(this.value)" style="margin-top:4px"></div>';
            h += '</div>';
            // Enchapado price
            h += '<div class="field"><label>Enchapado ($/ml)</label>';
            h += '<input type="number" value="' + (typeof P.enchapPrice === 'number' ? P.enchapPrice : 13) + '" step="0.5" min="0" onchange="APP.setEnchapPrice(parseFloat(this.value))" style="width:120px">';
            h += '<p class="hint">Costo por metro lineal de enchapado</p></div>';
            // Default Height
            h += '<div class="field"><label>Alto por defecto (cm)</label>';
            h += '<input type="number" value="' + P.defaultHeight + '" min="50" max="400" step="1" onchange="APP.setDefaultHeight(parseInt(this.value))" placeholder="200" style="width:120px">';
            h += '<p class="hint">Aplica a todos los modulos sin alto propio</p></div>';
            // Depth  same for all or per-module
            h += '<div class="field"><label>Profundidad</label>';
            h += '<div class="mat-toggle-row" style="margin-bottom:8px"><span>Misma profundidad para todos</span><button class="toggle' + (P.sameDepth ? ' on' : '') + '" onclick="APP.togSameDepth()"></button></div>';
            if (P.sameDepth) {
                h += '<input type="number" value="' + P.defaultDepth + '" min="20" max="100" step="1" onchange="APP.setDefaultDepth(parseInt(this.value))" placeholder="50" style="width:120px">';
                h += '<span style="font-size:12px;color:#999;margin-left:8px">cm  general para todo el proyecto</span>';
            } else {
                h += '<p class="hint">Cada modulo tendra su propia profundidad editable</p>';
            }
            h += '</div>';
            return h;
        }

        // CUSTOMIZE: Module type buttons  controls which module types appear in the add-module panel
        function step2() {
            var P = S.project;
            var typeObj = TYPES.find(function(t) { return t.id === P.type; });
            var typeName = typeObj ? typeObj.i + ' ' + typeObj.n : 'Proyecto';
            var h = '<div class="title"><h2>' + typeName + '</h2><p>Configurar modulos del proyecto</p></div>';
            h += '<div class="add-btns">';
            for (var k in MODS) {
                h += '<button class="add-btn" onclick="APP.addMod(\'' + k + '\')">' + svg('plus') + MODS[k].n + '</button>';
            }
            h += '</div>';
            if (P.modules.length === 0) {
                h += '<div class="empty">' + svg('pkg') + '<p>No hay modulos</p></div>';
            } else {
                P.modules.forEach(function(m, i) {
                    h += '<div class="module"><div class="module-hdr"><div style="display:flex;align-items:center;gap:8px"><span class="module-num">' + (i + 1) + '</span><strong>' + m.name + '</strong></div><button class="module-del" onclick="APP.delMod(\'' + m.id + '\')">' + svg('trash') + '</button></div>';
                    h += '<div class="module-row"><span>Ancho:</span><div style="display:flex;gap:8px;flex-wrap:wrap">';
                    MODS[m.type].w.forEach(function(w) {
                        h += '<button class="opt-btn' + (m.width === w ? ' sel' : '') + '" onclick="APP.setModW(\'' + m.id + '\',' + w + ')">' + w + 'cm</button>';
                    });
                    if (MODS[m.type].custom)
                        h += '<input type="number" value="' + m.width + '" style="width:64px;padding:6px;background:#3a3a3a;border:none;border-radius:8px;color:#fff;text-align:center" onchange="APP.setModW(\'' + m.id + '\',parseInt(this.value))">';
                    h += '</div></div>';
                    // Per-module height
                    h += '<div class="module-row"><span>Alto:</span><input type="number" value="' + (m.height || '') + '" placeholder="' + (P.defaultHeight || 200) + 'cm" style="width:100px;padding:6px;background:#3a3a3a;border:none;border-radius:8px;color:#fff;text-align:center" onchange="APP.setModH(\'' + m.id + '\',this.value?parseInt(this.value):0)"><span style="font-size:12px;color:#999;margin-left:4px">cm (vacio = ' + P.defaultHeight + 'cm)</span></div>';
                    // Per-module depth (only when sameDepth is false)
                    if (!P.sameDepth) {
                        h += '<div class="module-row"><span>Prof.:</span><input type="number" value="' + (m.depth || P.defaultDepth || 50) + '" min="20" max="120" step="1" style="width:100px;padding:6px;background:#3a3a3a;border:none;border-radius:8px;color:#fff;text-align:center" onchange="APP.setModDepth(\'' + m.id + '\',parseInt(this.value))"><span style="font-size:12px;color:#999;margin-left:4px">cm</span></div>';
                    }
                    if (m.type === 'modulo') {
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : 4;
                        h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [0, 1, 2, 3, 4, 5, 6].forEach(function(n) {
                            h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                        if (mcaj === 0) {
                            // Shelves selector for 0-cajones modulo
                            var msh = typeof m.shelves === 'number' ? m.shelves : 3;
                            h += '<div class="module-row"><span>Estantes:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                            [0, 1, 2, 3, 4, 5, 6, 7].forEach(function(n) {
                                h += '<button class="opt-btn' + (msh === n ? ' sel' : '') + '" onclick="APP.setModS(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                            });
                            h += '</div></div>';
                        }
                        if (mcaj > 0) {
                            // Corredera tier
                            h += '<div class="module-row"><span>Corredera:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                            [{
                                k: 'corr_eco',
                                l: 'Ecoline'
                            }, {
                                k: 'corr_prem',
                                l: 'Premium'
                            }, {
                                k: 'corr_oculta',
                                l: 'TDM Oculta'
                            }].forEach(function(tier) {
                                var sel = (m.corrTier || 'corr_eco') === tier.k ? ' sel' : '';
                                h += '<button class="opt-btn' + sel + '" onclick="APP.setModCorr(\'' + m.id + '\',\'' + tier.k + '\')">' + tier.l + '</button>';
                            });
                            h += '</div></div>';
                        }
                    }
                    if (m.type === 'entrepa' || m.type === 'torreLateral' || m.type === 'lateralAbierto' || m.type === 'despensa') {
                        h += '<div class="module-row"><span>Estantes:</span><div style="display:flex;gap:8px">';
                        [2, 3, 4, 5, 6, 7].forEach(function(n) {
                            h += '<button class="opt-btn' + ((m.shelves || 3) === n ? ' sel' : '') + '" onclick="APP.setModS(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (m.type === 'cajonBase') {
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : 3;
                        h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [1, 2, 3, 4, 5].forEach(function(n) {
                            h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (m.type === 'esquineroGiratorio') {
                        h += '<div class="module-row"><span>Ancho 2:</span><input type="number" value="' + (m.width2 || m.width) + '" min="30" max="120" step="10" style="width:80px;padding:6px;background:#3a3a3a;border:none;border-radius:8px;color:#fff;text-align:center" onchange="APP.setModW2(\'' + m.id + '\',parseInt(this.value))"><span style="font-size:12px;color:#999;margin-left:4px">cm (segundo lado)</span></div>';
                    }
                    if (m.type === 'puerta') {
                        // Puerta-specific: marco toggle and material type
                        h += '<div class="module-row"><span>Marco:</span><button class="opt-btn' + (m.marco ? ' sel' : '') + '" onclick="APP.togModProp(\'' + m.id + '\',\'marco\')">' + svg(m.marco ? 'check' : 'plus') + ' Con marco</button></div>';
                        h += '<div class="module-row"><span>Material:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [{k:'standard',l:'Melamina'},{k:'vidrio',l:'Vidrio'},{k:'metal',l:'Metal'}].forEach(function(mt) {
                            h += '<button class="opt-btn' + ((m.materialType || 'standard') === mt.k ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'materialType\',\'' + mt.k + '\')">' + mt.l + '</button>';
                        });
                        h += '</div></div>';
                    }
                    // Puerta type doesn't need quote mode or door toggles  it IS a door
                    if (m.type !== 'puerta') {
                        var qmC = m.quoteMode || 'completo';
                        h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">';
                        h += '<button class="opt-btn' + (qmC === 'completo' ? ' sel' : '') + '" onclick="APP.setQuoteMode(\'' + m.id + '\',\'completo\')">Completo</button>';
                        h += '<button class="opt-btn' + (qmC === 'solo_puertas' ? ' sel' : '') + '" style="' + (qmC === 'solo_puertas' ? 'background:#fbbf24;color:#1a1a1a;border-color:#fbbf24' : '') + '" onclick="APP.setQuoteMode(\'' + m.id + '\',\'solo_puertas\')">Solo puertas</button>';
                        h += '</div>';
                        if (qmC === 'solo_puertas') {
                            h += '<div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:6px;padding:6px 10px;margin-bottom:6px;font-size:12px;color:#fbbf24">Solo puertas: la estructura no se cotiza</div>';
                        }
                        h += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
                        if (qmC !== 'solo_puertas') {
                            h += '<button class="opt-btn' + (m.doors ? ' sel' : '') + '" onclick="APP.togDoor(\'' + m.id + '\')">' + svg(m.doors ? 'check' : 'plus') + ' Puertas</button>';
                            if (m.doors)
                                h += '<button class="opt-btn' + (m.tipon ? ' sel' : '') + '" onclick="APP.togTipon(\'' + m.id + '\')">' + svg(m.tipon ? 'check' : 'plus') + ' Tip-On</button>';
                        } else {
                            h += '<button class="opt-btn' + (m.tipon ? ' sel' : '') + '" onclick="APP.togTipon(\'' + m.id + '\')">' + svg(m.tipon ? 'check' : 'plus') + ' Tip-On</button>';
                        }
                        h += '</div>';
                    }
                    h += renderModuleLed(m);
                    h += renderModulePaint(m);
                    h += '<p class="module-desc">' + MODS[m.type].d + '</p></div>';
                });
                var tw = P.modules.reduce(function(a, m) {
                    return a + m.width;
                }, 0);
                h += '<div class="total-w"><span>Ancho Total:</span><strong>' + tw + ' cm</strong></div>';
            }
            // Hardware section
            h += '<div class="hw-selected"><h4>' + svg('settings') + ' Herrajes <span style="font-size:12px;color:#999;font-weight:400">(auto + manual)</span></h4>';
            var c = P.modules.length > 0 ? calc() : null;
            if (c) {
                for (var k in c.hwConsolidated) {
                    var hw = c.hwConsolidated[k];
                    h += '<div class="hw-sel-item"><span class="hw-sel-marca ' + marcaClass(hw.marca) + '">' + hw.marca + '</span><span class="hw-sel-name">' + hw.desc + '</span><span style="color:#999;font-size:12px">x' + Math.ceil(hw.qty) + '</span><span class="hw-sel-price">' + fmtD(Math.ceil(hw.qty) * hw.price) + '</span></div>';
                }
            }
            if (P.hardware.length > 0) {
                P.hardware.forEach(function(h2, idx) {
                    h += '<div class="hw-sel-item"><span class="hw-sel-marca ' + marcaClass(h2.marca) + '">' + h2.marca + '</span><span class="hw-sel-name">' + h2.descripcion + '</span>';
                    h += '<div class="hw-sel-qty"><button onclick="APP.hwQty(' + idx + ',-1)">-</button><strong>' + h2.qty + '</strong><button onclick="APP.hwQty(' + idx + ',1)">+</button></div>';
                    h += '<span class="hw-sel-price">' + fmtD(h2.qty * adjPrice(h2)) + '</span></div>';
                });
            }
            h += '<button class="hw-add-btn" onclick="APP.openHWPicker()">' + svg('plus') + ' Agregar herraje del catalogo</button>';
            h += '</div>';
            // Extras
            h += '<div class="extra-section"><label style="font-size:14px;color:#ffffff;display:block;margin-bottom:12px">Extras</label>';
            h += '<div class="extra-row"><div style="display:flex;align-items:center">' + svg('layers') + ' Vidrio Templado</div><button class="toggle' + (P.glass ? ' on' : '') + '" onclick="APP.togGlass()"></button></div>';
            if (P.glass)
                h += '<div class="extra-input"><span>Metros2 vidrio:</span><input type="number" value="' + P.glassM2 + '" min="0" step="0.1" onchange="APP.setGlassM2(parseFloat(this.value))"></div>';
            h += '</div>';
            return h;
        }

        function step3(c) {
            var P = S.project;
            var h = '<div class="title"><h2>Resumen de Costeo</h2><p>Carpinter\u00eda x' + CONFIG.pricing.carpentryMultiplier + ' | Herrajes premium ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%</p></div>';
            // Carpinteria card
            h += '<div class="card"><div class="card-title">' + svg('layers') + ' Carpinteria</div>';
            if (c.totalSheetsF > 0) {
                h += '<div class="cost-row"><span>Material Frentes (' + c.totalSheetsF + ' hojas)</span><strong>' + fmt(c.matCostF) + '</strong></div>';
            }
            if (c.useDual && c.totalSheetsI > 0) {
                h += '<div class="cost-row"><span>Material Interior (' + c.totalSheetsI + ' hojas)</span><strong>' + fmt(c.matCostI) + '</strong></div>';
            }
            if (c.cantoF > 0)
                h += '<div class="cost-row"><span>Chapacanto' + (c.useDual ? ' Frentes' : '') + ' (' + c.cantoF + ' ml)</span><strong>' + fmt(c.chapCostF) + '</strong></div>';
            if (c.useDual && c.cantoI > 0)
                h += '<div class="cost-row"><span>Chapacanto Interior (' + c.cantoI + ' ml)</span><strong>' + fmt(c.chapCostI) + '</strong></div>';
            h += '<div class="cost-row"><span>Corte (' + c.totalSheets + ' hojas x $75)</span><strong>' + fmt(c.corteCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Enchapado (' + c.totalCanto + ' ml x $' + (typeof P.enchapPrice === 'number' ? P.enchapPrice : 13) + ')</span><strong>' + fmt(c.enchapCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Mano de obra</span><strong>' + fmt(P.laborCost) + '</strong></div>';
            if (P.freight)
                h += '<div class="cost-row"><span>Flete</span><strong>' + fmt(P.freightCost) + '</strong></div>';
            h += '<div class="cost-total"><span>Costo Carpinteria</span><strong>' + fmt(c.carpCost) + '</strong></div>';
            h += '<div class="cost-row" style="margin-top:4px"><span>Venta (carp + hw std) x' + CONFIG.pricing.carpentryMultiplier + '</span><strong style="color:#ffffff">' + fmt(c.carpSale) + '</strong></div></div>';
            // Labor config
            h += '<div class="card"><div class="card-title">' + svg('users') + ' Mano de Obra</div>';
            h += '<div style="margin-bottom:12px"><span style="font-size:14px;color:#bbb">Costo mano de obra:</span>';
            h += '<div class="labor-input"><span>$</span><input type="number" value="' + P.laborCost + '" min="0" step="500" onchange="APP.setLabor(parseFloat(this.value))"></div>';
            h += '<div class="labor-presets">';
            [{
                l: '$3,000',
                v: 3000
            }, {
                l: '$5,000',
                v: 5000
            }, {
                l: '$8,000',
                v: 8000
            }, {
                l: '$12,000',
                v: 12000
            }, {
                l: '$15,000',
                v: 15000
            }].forEach(function(p) {
                h += '<button class="labor-preset' + (P.laborCost === p.v ? ' sel' : '') + '" onclick="APP.setLabor(' + p.v + ')">' + p.l + '</button>';
            });
            h += '</div></div>';
            h += '<div style="display:flex;align-items:center;justify-content:space-between"><span style="color:#bbb">Flete:</span><button class="toggle' + (P.freight ? ' on' : '') + '" onclick="APP.togFreight()"></button></div></div>';
            // Herrajes card  carpentry bucket (low-cost, included in carpentry x multiplier)
            if (c.hwCostCarpBucket > 0) {
                h += '<div class="card"><div class="card-title">' + svg('settings') + ' Herrajes (incluidos en carpinter\u00eda x' + CONFIG.pricing.carpentryMultiplier + ')</div>';
                h += '<div style="font-size:11px;color:#999;margin-bottom:6px">Costo unitario \u2264 $' + CONFIG.pricing.hardwareThreshold + '</div>';
                c.allHW.forEach(function(hw) {
                    if (hw._bucket !== 'carp') return;
                    h += '<div class="cost-row"><span class="' + marcaClass(hw.marca) + '">' + hw.desc + ' x' + Math.ceil(hw.qty) + '</span><strong>' + fmtD(Math.ceil(hw.qty) * hw.price) + '</strong></div>';
                });
                h += '<div class="cost-total"><span>Subtotal herrajes (en carp.)</span><strong>' + fmt(c.hwCostCarpBucket) + '</strong></div></div>';
            }
            // Premium hardware card (above threshold)
            if (c.hwCostPremium > 0) {
                h += '<div class="card"><div class="card-title">' + svg('lock') + ' Herrajes Premium <span style="font-size:11px;color:#999;font-weight:400">Margen ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%</span></div>';
                h += '<div style="font-size:11px;color:#999;margin-bottom:6px">Costo unitario > $' + CONFIG.pricing.hardwareThreshold + '</div>';
                c.allHW.forEach(function(hw) {
                    if (hw._bucket !== 'premium') return;
                    h += '<div class="cost-row"><span class="' + marcaClass(hw.marca) + '">' + hw.desc + ' x' + Math.ceil(hw.qty) + '</span><strong>' + fmtD(Math.ceil(hw.qty) * hw.price) + '</strong></div>';
                });
                h += '<div class="cost-total"><span>Costo Premium</span><strong>' + fmt(c.hwCostPremium) + '</strong></div>';
                h += '<div class="cost-row" style="margin-top:4px"><span>Venta (' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong style="color:#ffffff">' + fmt(c.hwPremiumSale) + '</strong></div></div>';
            }
            // Extras
            if (c.extraCost > 0) {
                h += '<div class="card"><div class="card-title">' + svg('zap') + ' Extras (x' + CONFIG.pricing.extrasMultiplier + ')</div>';
                if (c.ledBOM) {
                    h += '<div style="font-size:12px;color:#fbbf24;font-weight:600;margin-bottom:4px">LED (' + c.ledBOM.totalMeters.toFixed(1) + 'm | ' + c.ledBOM.totalSegments + ' seg | ' + c.ledBOM.alimentadorW + 'W)</div>';
                    c.ledBOM.items.forEach(function(it) {
                        h += '<div class="cost-row"><span style="font-size:12px">' + it.qty + 'x ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                    });
                    h += '<div class="cost-row" style="border-top:1px solid #3a3a3a;padding-top:4px;margin-top:4px"><span style="color:#fbbf24">Subtotal LED</span><strong style="color:#fbbf24">' + fmtD(c.ledBOM.totalCost) + '</strong></div>';
                }
                if (P.glass)
                    h += '<div class="cost-row"><span>Vidrio (' + P.glassM2 + 'm2)</span><strong>' + fmt(P.glassM2 * CONFIG.pricing.glassCostPerM2) + '</strong></div>';
                if (c.paintCost > 0) {
                    P.modules.forEach(function(m2, mi2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'custom',
                                defaultHeight: P.defaultHeight,
                                defaultDepth: P.defaultDepth
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                h += '<div class="cost-row"><span>Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' ' + m2.name + ' (' + lit.toFixed(1) + 'L)</span><strong>' + fmtD(Math.round(lit * m2.paint.pricePerLiter)) + '</strong></div>';
                        }
                    });
                }
                h += '<div class="cost-total"><span>Costo Extras</span><strong>' + fmt(c.extraCost) + '</strong></div>';
                h += '<div class="cost-row" style="margin-top:4px"><span>Venta (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong style="color:#ffffff">' + fmt(c.extrasSale) + '</strong></div></div>';
            }
            // Summary
            h += '<div class="summary">';
            h += '<div class="summary-row"><span>Carpinter\u00eda (incl. herrajes std)</span><strong>' + fmt(c.carpSale) + '</strong></div>';
            if (c.hwCostPremium > 0)
                h += '<div class="summary-row"><span>Herrajes Premium</span><strong>' + fmt(c.hwPremiumSale) + '</strong></div>';
            if (c.extrasSale > 0)
                h += '<div class="summary-row"><span>Extras</span><strong>' + fmt(c.extrasSale) + '</strong></div>';
            h += '<div class="grand-total"><span>SUBTOTAL</span><strong>' + fmt(c.subtotal) + '</strong></div>';
            h += '<div class="summary-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
            h += '<div class="grand-total" style="margin-top:8px"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div>';
            h += '<div class="profit-box"><span>Costo real: ' + fmt(c.totalCost) + '</span><strong>Utilidad: ' + fmt(c.profit) + ' (' + c.margin + '%)</strong></div></div>';
            // Cost Breakdown (internal)
            h += '<div class="cost-bd">';
            h += '<button class="cost-bd-toggle" onclick="APP.togCostBD()">&#x1f512; Desglose de Costos (Interno) ' + svg(S.showCostBreakdown ? 'chevDown' : 'right') + '</button>';
            if (S.showCostBreakdown) {
                h += '<div class="cost-bd-lock">Solo para uso interno - no se comparte con el cliente</div>';
                h += '<div class="cost-bd-body">';
                h += '<div class="cost-bd-section"><h5>Carpinteria</h5>';
                if (c.totalSheetsF > 0)
                    h += '<div class="cost-bd-row"><span>Mat. Frentes ' + c.totalSheetsF + ' hojas</span><strong>' + fmt(c.matCostF) + '</strong></div>';
                if (c.useDual && c.totalSheetsI > 0)
                    h += '<div class="cost-bd-row"><span>Mat. Interior ' + c.totalSheetsI + ' hojas</span><strong>' + fmt(c.matCostI) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Chapacanto</span><strong>' + fmt(c.chapCostF + c.chapCostI) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Corte + Enchapado</span><strong>' + fmt(c.corteCost + c.enchapCost) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Mano de obra</span><strong>' + fmt(P.laborCost) + '</strong></div>';
                if (P.freight)
                    h += '<div class="cost-bd-row"><span>Flete</span><strong>' + fmt(P.freightCost) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Costo carp.</span><strong>' + fmt(c.carpCost) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Venta (carp + hw std) x' + CONFIG.pricing.carpentryMultiplier + '</span><strong>' + fmt(c.carpSale) + '</strong></div></div>';
                h += '<div class="cost-bd-section"><h5>Herrajes</h5>';
                h += '<div class="cost-bd-row"><span>En carpinter\u00eda (\u2264$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostCarpBucket) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Premium (>$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostPremium) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Venta premium (' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong>' + fmt(c.hwPremiumSale) + '</strong></div></div>';
                if (c.extraCost > 0) {
                    h += '<div class="cost-bd-section"><h5>Extras</h5>';
                    if (c.ledBOM)
                        h += '<div class="cost-bd-row"><span>LED (' + c.ledBOM.totalMeters.toFixed(1) + 'm)</span><strong>' + fmtD(c.ledBOM.totalCost) + '</strong></div>';
                    if (P.glass)
                        h += '<div class="cost-bd-row"><span>Vidrio (' + P.glassM2 + 'm2)</span><strong>' + fmt(P.glassM2 * CONFIG.pricing.glassCostPerM2) + '</strong></div>';
                    if (c.paintCost > 0)
                        h += '<div class="cost-bd-row"><span>Pintura</span><strong>' + fmtD(c.paintCost) + '</strong></div>';
                    h += '<div class="cost-bd-subtotal"><span>Costo extras</span><strong>' + fmt(c.extraCost) + '</strong></div>';
                    h += '<div class="cost-bd-subtotal"><span>Venta (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong>' + fmt(c.extrasSale) + '</strong></div></div>';
                }
                h += '<div class="cost-bd-grand">';
                h += '<div class="cost-bd-grand-row"><span>Subtotal</span><strong>' + fmt(c.subtotal) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
                h += '<div class="cost-bd-grand-row total"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div>';
                h += '<div class="cost-bd-grand-row" style="margin-top:8px;border-top:1px solid #3a3a3a;padding-top:8px"><span>Costo real</span><strong>' + fmt(c.totalCost) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>Utilidad real</span><strong>' + fmt(c.profit) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>Margen real</span><strong>' + c.margin + '%</strong></div>';
                h += '</div></div>';
            }
            h += '</div>';
            return h;
        }

        function step4(c) {
            var P = S.project,
                v = S.view;
            var h = '<div class="title"><h2>' + (v === 'quote' ? 'Cotizacion' : 'Despiece') + '</h2></div>';
            h += '<div class="tabs"><button class="tab' + (v === 'quote' ? ' sel' : '') + '" onclick="APP.setView(\'quote\')">' + svg('file') + ' Cotizacion</button>';
            h += '<button class="tab' + (v === 'cutlist' ? ' sel' : '') + '" onclick="APP.setView(\'cutlist\')">' + svg('clip') + ' Despiece</button></div>';
            if (v === 'quote') {
                var type = TYPES.find(function(t) {
                    return t.id === P.type;
                });
                h += '<div class="quote"><div class="quote-hdr"><h2>' + (BRANDS[S.brand] || BRANDS.primary).name + '</h2><p>' + (BRANDS[S.brand] || BRANDS.primary).tagline + '</p></div><div class="quote-body">';
                h += '<div class="quote-info"><div><span>Cliente:</span><p>' + (P.client || 'Sin nombre') + '</p></div><div><span>Fecha:</span><p>' + date() + '</p></div></div>';
                var matDesc = P.matFrentes.brand + ' ' + P.matFrentes.name;
                if (c.useDual)
                    matDesc += ' (frentes) + ' + P.matInterior.brand + ' ' + P.matInterior.name + ' (interior)';
                h += '<div class="quote-project"><span>Proyecto:</span><h3>' + (type ? type.n : '') + '</h3><p>Material: ' + matDesc + '</p></div>';
                h += '<div class="quote-mods"><h4>Modulos:</h4>';
                P.modules.forEach(function(m, i) {
                    var mInfo = m.width + 'cm';
                    if (m.height)
                        mInfo += ' x ' + m.height + 'cm';
                    var mcaj = typeof m.cajones === 'number' ? m.cajones : (m.type === 'modulo' ? 4 : 0);
                    if (m.type === 'modulo' && mcaj === 0)
                        mInfo += ' (' + (typeof m.shelves === 'number' ? m.shelves : 3) + ' ent.)';
                    else if (mcaj > 0)
                        mInfo += ' (' + mcaj + ' caj.)';
                    h += '<div class="quote-mod"><span>' + (i + 1) + '. ' + m.name + '</span><span>' + mInfo + '</span></div>';
                });
                h += '</div>';
                if (c.ledBOM || P.glass) {
                    h += '<div class="quote-extras"><h4>Extras:</h4>';
                    if (c.ledBOM)
                        h += '<p>- Iluminacion LED perimetral completa</p>';
                    if (P.glass)
                        h += '<p>- Vidrio templado 6mm</p>';
                    h += '</div>';
                }
                h += '<div class="quote-price"><div class="quote-price-row"><span>Subtotal</span><strong>' + fmt(c.subtotal) + '</strong></div>';
                h += '<div class="quote-price-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
                h += '<div class="quote-total"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div></div>';
                var _ht = CONFIG.quoting.htmlTerms.map(function(t) { return t.replace('{anticipo}', CONFIG.quoting.defaultAnticipo).replace('{deliveryTime}', CONFIG.quoting.defaultDelivery); });
                h += '<div class="quote-terms"><h4>Condiciones:</h4>' + _ht.map(function(t) { return '<p>- ' + t + '</p>'; }).join('') + '</div>';
                h += '<div class="quote-contact"><p>&#x1f4de; ' + CONTACT.cell + '</p><p>&#x1f4e7; ' + CONTACT.email + '</p></div>';
                h += '</div></div>';
            } else {
                h += '<div class="quote"><div class="cut-hdr"><h2>DESPIECE PARA COMSA</h2><p>' + (P.client || 'Sin nombre') + ' - ' + date() + '</p>';
                h += '<p style="color:#fff;font-size:14px">Frentes: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '</p>';
                if (c.useDual)
                    h += '<p style="color:#9ca3af;font-size:14px">Interior: ' + P.matInterior.brand + ' ' + P.matInterior.name + '</p>';
                if (P.chapSpec)
                    h += '<p style="color:#c49a6c;font-size:13px">Chapacanto: ' + P.chapSpec + '</p>';
                h += '</div><div class="cut-body">';
                h += '<div class="cut-summary"><div class="cut-box"><strong>' + c.totalSheets + '</strong><span>Hojas Total</span></div><div class="cut-box"><strong>' + c.totalCanto + '</strong><span>ML Canto</span></div></div>';
                var tk = c.projThickness || 16;
                h += '<div style="padding:12px;background:rgba(40,40,40,0.5);border-radius:8px;margin-bottom:16px"><h4 style="font-weight:700;margin-bottom:8px">Hojas (' + tk + 'mm):</h4>';
                if (c.useDual) {
                    h += '<p style="font-size:12px;color:#60a5fa;margin-bottom:4px">FRENTES:</p>';
                    if (c.totalSheetsF > 0)
                        h += '<p style="font-size:14px;color:#bbb">  ' + tk + 'mm: ' + c.totalSheetsF + ' hojas</p>';
                    h += '<p style="font-size:12px;color:#9ca3af;margin:8px 0 4px">INTERIOR:</p>';
                    if (c.totalSheetsI > 0)
                        h += '<p style="font-size:14px;color:#bbb">  ' + tk + 'mm: ' + c.totalSheetsI + ' hojas</p>';
                } else {
                    var sAll = c.totalSheetsF + c.totalSheetsI;
                    if (sAll > 0)
                        h += '<p style="font-size:14px;color:#bbb">' + tk + 'mm: ' + sAll + ' hojas</p>';
                }
                h += '</div>';
                P.modules.forEach(function(m) {
                    var pcs = c.pieces.filter(function(p) {
                        return p.mid === m.id;
                    });
                    pcs.sort(function(a, b) {
                        var alA = anchoLargo(a.w, a.h),
                            alB = anchoLargo(b.w, b.h);
                        return alB.largo - alA.largo;
                    });
                    var mHdr = m.name + ' ' + m.width + 'cm';
                    if (m.height)
                        mHdr += ' x ' + m.height + 'cm';
                    h += '<div class="cut-module"><div class="cut-module-hdr">' + mHdr + '</div><div class="cut-module-body">';
                    // Column headers
                    h += '<div class="cut-piece" style="border-bottom:1px solid #3a3a3a;padding-bottom:4px;margin-bottom:4px;font-weight:700;color:#bbb"><span>Pieza</span><span class="qty">Cant</span><span class="dims" style="width:50px">Ancho</span><span class="dims" style="width:50px">Largo</span><span class="thk">Esp.</span>';
                    if (c.useDual)
                        h += '<span class="zone" style="width:48px">Zona</span>';
                    h += '</div>';
                    pcs.forEach(function(p) {
                        var al = anchoLargo(p.w, p.h);
                        var eKey = m.id + ':' + p.n;
                        var ep = S.editedPieces[eKey] || {};
                        var eq = typeof ep.q === 'number' ? ep.q : p.q;
                        var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                        var el = typeof ep.largo === 'number' ? ep.largo : al.largo;
                        var edited = S.editedPieces[eKey] ? 'border-left:3px solid #c49a6c;' : '';
                        h += '<div class="cut-piece" style="' + edited + '">';
                        h += '<span>' + p.n + '</span>';
                        h += '<span class="qty"><input type="number" value="' + eq + '" min="0" style="width:36px;padding:2px;background:#2a2a2a;border:1px solid #3a3a3a;border-radius:4px;color:#fff;text-align:center;font-size:12px" onchange="APP.editPiece(\'' + eKey + '\',\'q\',parseInt(this.value))"></span>';
                        h += '<span class="dims" style="width:50px"><input type="number" value="' + ea + '" min="0" style="width:46px;padding:2px;background:#2a2a2a;border:1px solid #3a3a3a;border-radius:4px;color:#fff;text-align:center;font-size:12px;font-family:monospace" onchange="APP.editPiece(\'' + eKey + '\',\'ancho\',parseInt(this.value))"></span>';
                        h += '<span class="dims" style="width:50px"><input type="number" value="' + el + '" min="0" style="width:46px;padding:2px;background:#2a2a2a;border:1px solid #3a3a3a;border-radius:4px;color:#fff;text-align:center;font-size:12px;font-family:monospace" onchange="APP.editPiece(\'' + eKey + '\',\'largo\',parseInt(this.value))"></span>';
                        h += '<span class="thk">' + p.t + 'mm</span>';
                        if (c.useDual)
                            h += '<span class="zone ' + (p.z === 'f' ? 'f' : 'i') + '">' + (p.z === 'f' ? 'F' : 'I') + '</span>';
                        h += '</div>';
                    });
                    h += '</div></div>';
                });
                // Reset edits button
                if (Object.keys(S.editedPieces).length > 0) {
                    h += '<button onclick="APP.resetEdits()" style="width:100%;padding:10px;background:#2a2a2a;border:1px solid #c49a6c;border-radius:8px;color:#c49a6c;font-size:13px;font-weight:600;cursor:pointer;margin-bottom:12px">Restaurar medidas calculadas</button>';
                }
                h += '<div style="padding:12px;background:rgba(40,40,40,0.5);border-radius:8px"><h4 style="font-weight:700;margin-bottom:8px">Herrajes:</h4>';
                c.allHW.forEach(function(hw) {
                    h += '<p style="font-size:14px;color:#bbb">- ' + hw.desc + ': ' + Math.ceil(hw.qty) + ' (' + hw.marca + ')</p>';
                });
                h += '</div></div></div>';
            }
            h += '';
            return h;
        }

        function buildHWListHTML(items, isSwap) {
            var h = '';
            if (items.length === 0) {
                h += '<div style="text-align:center;padding:32px;color:#999">Sin resultados</div>';
            } else {
                var lastCat = '';
                items.forEach(function(item) {
                    if (item.categoria !== lastCat) {
                        lastCat = item.categoria;
                        h += '<div class="hw-cat-hdr">' + item.categoria + '</div>';
                    }
                    var hwArr = S.screen === 'estandarizado' ? S.estProject.hardware : S.project.hardware;
                    var inCart = hwArr.find(function(x) {
                        return x.codigo === item.codigo;
                    });
                    h += '<div class="hw-item"' + (isSwap ? ' style="flex-wrap:wrap"' : '') + '>';
                    h += '<div class="hw-item-info"><div class="hw-item-name">' + item.descripcion + '</div><div class="hw-item-meta"><span class="hw-sel-marca ' + marcaClass(item.marca) + '">' + item.marca + '</span> ' + item.codigo + ' | ' + item.unidad + '</div></div>';
                    h += '<div class="hw-item-price">' + fmtD(adjPrice(item)) + '</div>';
                    if (isSwap) {
                        h += '<button style="width:100%;margin-top:6px;padding:10px 12px;border-radius:8px;border:none;background:#c49a6c;color:#1a1a2e;font-weight:700;cursor:pointer;font-size:14px" onclick="APP.hwCartAdd(\'' + item.codigo + '\')">Seleccionar</button>';
                    } else if (inCart) {
                        h += '<div class="hw-item-qty"><button onclick="APP.hwCartQty(\'' + item.codigo + '\',-1)">-</button><strong>' + inCart.qty + '</strong><button onclick="APP.hwCartQty(\'' + item.codigo + '\',1)">+</button></div>';
                    } else {
                        h += '<button style="padding:6px 12px;border-radius:6px;border:none;background:#ffffff;color:#000;font-weight:600;cursor:pointer;font-size:12px" onclick="APP.hwCartAdd(\'' + item.codigo + '\')">+ Agregar</button>';
                    }
                    h += '</div>';
                });
                if (items.length >= 60)
                    h += '<div style="text-align:center;padding:16px;color:#999;font-size:13px">Mostrando primeros 60 resultados. Usa filtros para refinar.</div>';
            }
            return h;
        }

        function renderHWPicker() {
            if (!S.showHWPicker)
                return '';
            var items = filterHW();
            var cats = getHWCats();
            var marcas = getHWMarcas();
            var h = '<div class="hw-picker" onclick="APP.closeHWPicker(event)">';
            h += '<div class="hw-picker-content" onclick="event.stopPropagation()">';
            var isSwap = !!S.estHwSwapKey;
            h += '<div class="hw-picker-hdr"><h3>' + svg('search') + (isSwap ? ' Cambiar Herraje' : ' Catalogo de Herrajes') + '</h3><button class="modal-close" onclick="APP.closeHWPicker()">' + svg('x') + '</button></div>';
            if (isSwap) {
                var swDef = HW_DEFAULTS[S.estHwSwapKey];
                h += '<div style="padding:10px 16px;background:rgba(196,154,108,0.1);border-bottom:1px solid #3a3a3a;font-size:13px;color:#c49a6c;display:flex;align-items:center;gap:8px"><strong>Reemplazando:</strong> ' + (swDef ? swDef.desc : S.estHwSwapKey) + '</div>';
            }
            h += '<input class="hw-search" type="text" placeholder="Buscar por nombre o codigo..." value="' + (S.hwFilter.q || '') + '" oninput="APP.hwSearch(this.value)" id="hwSearchInput">';
            // Marca filters (collapsed when selected)
            h += '<div class="hw-filters">';
            if (S.hwFilter.marca) {
                h += '<button class="hw-chip sel" onclick="APP.hwFilterMarca(\'\')">' + S.hwFilter.marca + ' &times;</button>';
            } else {
                h += '<span style="font-size:11px;color:#666;white-space:nowrap">Marca:</span>';
                marcas.forEach(function(m) {
                    h += '<button class="hw-chip" onclick="APP.hwFilterMarca(\'' + m + '\')">' + m + '</button>';
                });
            }
            h += '</div>';
            // Category filters (collapsed when selected)
            h += '<div class="hw-filters">';
            if (S.hwFilter.cat) {
                h += '<button class="hw-chip sel" onclick="APP.hwFilterCat(\'\')">' + S.hwFilter.cat + ' &times;</button>';
            } else {
                h += '<span style="font-size:11px;color:#666;white-space:nowrap">Categor\u00eda:</span>';
                cats.forEach(function(c2) {
                    h += '<button class="hw-chip" onclick="APP.hwFilterCat(\'' + c2 + '\')">' + c2 + '</button>';
                });
            }
            h += '</div>';
            h += '<div class="hw-list" id="hwListContainer">' + buildHWListHTML(items, isSwap) + '</div></div></div>';
            return h;
        }

        function renderSettings() {
            if (!S.showSettings)
                return '';
            var s = S.settings;
            var h = '<div class="settings-overlay" onclick="APP.closeSettings(event)">';
            h += '<div class="settings-panel" onclick="event.stopPropagation()">';
            h += '<div class="settings-hdr"><h3>' + svg('settings') + ' Configuracion</h3><button class="modal-close" onclick="APP.closeSettings()">' + svg('x') + '</button></div>';
            h += '<div class="settings-body">';
            h += '<div class="settings-section"><h4>Ajuste Precio Proveedores</h4>';
            ['ARAUCO', 'HERRAXA', 'BLUM', 'HAFELE'].forEach(function(m) {
                h += '<div class="supplier-row"><span class="' + marcaClass(m) + '">' + m + '</span><input type="number" value="' + (s.supplierAdj[m] || 0) + '" onchange="APP.setSupplierAdj(\'' + m + '\',parseFloat(this.value))">%</div>';
            });
            h += '</div>';
            // Brand selector
            h += '<div class="settings-section"><h4>Marca Activa</h4>';
            h += '<div class="brand-toggle">';
            for (var bk in BRANDS) {
                var b = BRANDS[bk];
                h += '<button class="brand-btn' + (S.brand === bk ? ' sel' : '') + '" onclick="APP.setBrand(\'' + bk + '\')"><span class="mono">' + b.mono + '</span>' + b.name + '</button>';
            }
            h += '</div></div>';
            // Logo upload
            h += '<div class="settings-section"><h4>Logo de Empresa</h4>';
            h += '<div class="logo-section">';
            h += '<div class="logo-preview">';
            if (S.logoBase64)
                h += '<img src="' + S.logoBase64 + '">';
            else {
                var abr = BRANDS[S.brand] || BRANDS.primary;
                h += '<div style="font-size:24px;font-weight:700;color:#c49a6c">' + abr.mono + '</div>';
            }
            h += '</div>';
            h += '<div class="logo-btns"><button class="upload" onclick="APP.uploadLogo()">Subir logo</button>';
            if (S.logoBase64)
                h += '<button class="remove" onclick="APP.removeLogo()">Quitar</button>';
            h += '</div></div></div>';
            // Quote counter
            h += '<div class="settings-section"><h4>Numero de Cotizacion</h4>';
            h += '<div class="margin-row"><label>Siguiente #</label><input type="number" value="' + S.quoteCounter + '" min="1" onchange="APP.setQuoteCounter(parseInt(this.value))"></div>';
            h += '<p style="font-size:12px;color:#999;margin-top:4px">El mismo n\u00famero se usa en PDF Cliente e Interno</p>';
            h += '</div>';
            h += '</div></div></div>';
            return h;
        }

        function nav() {
            var canNext = S.step === 1 ? S.project.type !== '' : S.step === 2 ? S.project.modules.length > 0 : true;
            var h = '<div class="nav">';
            if (S.step === 1)
                h += '<button class="nav-btn back" onclick="APP.goHome()">' + svg('left') + ' Plantillas</button>';
            else if (S.step > 1)
                h += '<button class="nav-btn back" onclick="APP.goStep(' + (S.step - 1) + ')">' + svg('left') + ' Atras</button>';
            if (S.step < 4)
                h += '<button class="nav-btn next" onclick="APP.next()"' + (canNext ? '' : ' disabled') + '>' + (S.step === 3 ? 'Ver Cotizacion' : 'Siguiente') + svg('right') + '</button>';
            if (S.step === 4)
                h += '<button class="nav-btn next" style="background:#c49a6c;color:#1a1a2e" onclick="APP.next()">Generar PDF ' + svg('right') + '</button>';
            h += '</div>';
            return h;
        }

        function step5(c) {
            var P = S.project,
                d = S.pdfData;
            if (!d) {
                APP.initPdfData();
                d = S.pdfData;
            }
            var br = BRANDS[S.brand] || BRANDS.primary;
            var h = '<div class="title"><h2>Generar Cotizacion</h2><p>Revisa y edita antes de generar</p></div>';
            // Brand selector
            h += '<div class="brand-toggle">';
            for (var bk in BRANDS) {
                var b = BRANDS[bk];
                h += '<button class="brand-btn' + (S.brand === bk ? ' sel' : '') + '" onclick="APP.setBrand(\'' + bk + '\')"><span class="mono">' + b.mono + '</span>' + b.name + '</button>';
            }
            h += '</div>';
            // Editable fields
            h += '<div class="pdf-field"><label>Cliente</label><input type="text" value="' + (d.client || '') + '" oninput="APP.setPdfField(\'client\',this.value)"></div>';
            h += '<div class="pdf-field"><label>Proyecto</label><input type="text" value="' + (d.projectName || '') + '" oninput="APP.setPdfField(\'projectName\',this.value)"></div>';
            h += '<div class="pdf-field"><label>Ubicacion</label><input type="text" value="' + (d.location || '') + '" placeholder="Ciudad, Estado" oninput="APP.setPdfField(\'location\',this.value)"></div>';
            h += '<div style="display:flex;gap:12px">';
            h += '<div class="pdf-field" style="flex:1"><label>No. Cotizacion</label><input type="text" value="' + (d.quoteNum || '') + '" oninput="APP.setPdfField(\'quoteNum\',this.value)"></div>';
            h += '<div class="pdf-field" style="flex:1"><label>Entrega</label><input type="text" value="' + (d.deliveryTime || '') + '" oninput="APP.setPdfField(\'deliveryTime\',this.value)"></div>';
            h += '</div>';
            h += '<div class="pdf-field"><label>Anticipo %</label><input type="number" value="' + (d.anticipo || CONFIG.quoting.defaultAnticipo) + '" min="0" max="100" onchange="APP.setPdfField(\'anticipo\',parseInt(this.value))"></div>';
            // Line items  one per module
            h += '<div class="pdf-items"><label style="font-size:14px;color:#fff;display:block;margin-bottom:4px">Modulos del proyecto (aparecen en el PDF)</label>';
            h += '<p style="font-size:12px;color:#999;margin-bottom:12px">Cada modulo es una linea en la tabla de cotizacion. Edita descripcion y precio.</p>';
            d.items.forEach(function(item, i) {
                h += '<div class="pdf-item">';
                h += '<div class="pdf-item-hdr" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
                h += '<strong style="color:#60a5fa;font-size:13px">' + (item.name || 'Modulo ' + (i + 1)) + '</strong>';
                h += '<div style="display:flex;align-items:center;gap:4px"><span style="color:#bbb;font-size:12px">Precio:</span><span style="color:#bbb">$</span><input class="pdf-item-price" type="number" value="' + item.price + '" onchange="APP.setPdfItemPrice(' + i + ',parseFloat(this.value))" style="width:100px"></div>';
                h += '</div>';
                h += '<textarea class="pdf-item-desc" oninput="APP.setPdfItemDesc(' + i + ',this.value)" rows="5">' + item.desc + '</textarea>';
                h += '<div style="font-size:12px;color:#999;margin-top:4px">Medidas: ' + item.dims + '</div>';
                h += '</div>';
            });
            h += '</div>';
            // Totals
            var itemTotal = d.items.reduce(function(a, it) {
                return a + it.price;
            }, 0);
            var iva = itemTotal * CONFIG.pricing.iva;
            var total = itemTotal + iva;
            h += '<div class="pdf-totals">';
            h += '<div class="pdf-totals-row"><span>Subtotal</span><strong style="font-family:monospace">' + fmt(itemTotal) + '</strong></div>';
            h += '<div class="pdf-totals-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong style="font-family:monospace">' + fmt(iva) + '</strong></div>';
            h += '<div class="pdf-totals-row grand"><span>TOTAL</span><strong style="font-family:monospace">' + fmt(total) + '</strong></div>';
            h += '</div>';
            // Notes
            h += '<div class="pdf-field"><label>Notas especiales</label><textarea oninput="APP.setPdfField(\'notes\',this.value)">' + (d.notes || '') + '</textarea></div>';
            // Action buttons
            h += '<div class="pdf-actions">';
            h += '<button class="pdf-btn client" onclick="APP.genClientPDF()">&#x1f4c4; PDF Cliente</button>';
            h += '<button class="pdf-btn internal" onclick="APP.genInternalPDF()">&#x1f512; PDF Interno</button>';
            h += '<button class="pdf-btn despiece" onclick="APP.genDespiece()">&#x1f4cb; PDF Despiece</button>';
            h += '</div>';
            return h;
        }

        // PDF generation helpers
        function getBrandSvgDataUrl(brandId) {
            var b = BRANDS[brandId] || BRANDS.primary;
            var svgStr = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 80"><rect width="200" height="80" rx="12" fill="#1a1a2e"/><text x="100" y="52" font-size="36" font-weight="bold" text-anchor="middle" font-family="Helvetica,Arial,sans-serif" fill="#c49a6c">' + b.mono + '</text></svg>';
            return 'data:image/svg+xml;base64,' + btoa(svgStr);
        }

        function getQuoteNum() {
            var yr = new Date().getFullYear();
            var num = S.pdfData ? S.pdfData.quoteNum : CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
            return num;
        }

        function fmtDatePDF() {
            var d = new Date();
            var months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return d.getDate() + '/' + months[d.getMonth()] + '/' + d.getFullYear();
        }

        function sanitize(s) {
            return (s || '').replace(/[<>&"']/g, '');
        }

        function addPlanoPage(doc, margin) {
            var EP = S.estProject;
            if (!EP || !EP.modules || EP.modules.length === 0)
                return;
            var plano = EP.planoImage;
            doc.addPage('letter', 'l'); // landscape for more horizontal space
            var pw = 279.4,
                ph = 215.9; // letter landscape mm
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            // Header
            doc.setFillColor(accent[0], accent[1], accent[2]);
            doc.rect(0, 0, pw, 12, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('PLANO DEL PROYECTO', margin, 9);

            if (plano) {
                // User-uploaded image
                var maxW = pw - 2 * margin,
                    maxH = ph - 28;
                try {
                    var img = new Image();
                    img.src = plano;
                    var iw = img.naturalWidth || 1,
                        ih = img.naturalHeight || 1;
                    var ratio = Math.min(maxW / iw, maxH / ih);
                    var drawW = iw * ratio,
                        drawH = ih * ratio;
                    var cx = margin + (maxW - drawW) / 2;
                    var imgFmt = plano.indexOf('data:image/png') === 0 ? 'PNG' : 'JPEG';
                    doc.addImage(plano, imgFmt, cx, 18, drawW, drawH);
                } catch (e) {
                    doc.setFontSize(10);
                    doc.setTextColor(180, 0, 0);
                    doc.text('Error al cargar imagen del plano', margin, 30);
                }
            } else {
                // Draw module visuals
                var tk = (EP.thickness || 16) / 10;
                var modules = EP.modules;
                var totalW = 0;
                modules.forEach(function(m) {
                    totalW += m.width;
                });
                var nMods = modules.length;
                // Dynamic gap: smaller when many modules
                var modGap = nMods <= 3 ? 10 : nMods <= 5 ? 6 : 4;
                var totalGap = (nMods - 1) * modGap;
                var availW = pw - 2 * margin - totalGap;
                // Reserve space at bottom: module details list + legend + specs line
                var detailLines = nMods + 3; // nMods lines + header + legend + specs
                var reservedBottom = detailLines * 3.5 + 16;
                var availH = ph - 24 - reservedBottom; // 24 = top header area
                var maxModH = 0;
                modules.forEach(function(m) {
                    var mH = estModHeight(m);
                    if (mH > maxModH)
                        maxModH = mH;
                });
                // Account for maletero/zoclo in max visual height
                var maxVisH = maxModH;
                modules.forEach(function(m) {
                    var vH = estModHeight(m);
                    if (m.maletero && m.maletero.enabled)
                        vH += (m.maletero.height || 30);
                    if (m.zoclo && m.zoclo.enabled)
                        vH += (m.zoclo.height || 10);
                    if (vH > maxVisH)
                        maxVisH = vH;
                });
                var scale = Math.min(availW / totalW, availH / maxVisH);
                if (scale > 1.2)
                    scale = 1.2;

                // Check if we need 2 rows (very small scale)
                var useRows = 1;
                if (scale < 0.3 && nMods > 3) {
                    useRows = 2;
                    // Recalculate for 2 rows
                    var modsPerRow = Math.ceil(nMods / 2);
                    var row1W = 0,
                        row2W = 0;
                    modules.forEach(function(m, i) {
                        if (i < modsPerRow)
                            row1W += m.width;
                        else
                            row2W += m.width;
                    });
                    var maxRowW = Math.max(row1W, row2W);
                    var rowGaps = (modsPerRow - 1) * modGap;
                    var rowAvailW = pw - 2 * margin - rowGaps;
                    var rowAvailH = (availH - 15) / 2; // 15mm gap between rows
                    scale = Math.min(rowAvailW / maxRowW, rowAvailH / maxVisH);
                    if (scale > 1.2)
                        scale = 1.2;
                }

                var rowStartY = 24; // leave room for module number labels above visuals
                var modsPerRow = useRows > 1 ? Math.ceil(nMods / 2) : nMods;
                // Zone colors (RGB) for PDF
                var zColors = {
                    techo: [80, 80, 80],
                    piso: [80, 80, 80],
                    cajones: [196, 154, 108],
                    colgador: [96, 165, 250],
                    zapatero: [139, 92, 246],
                    entrepa: [120, 120, 120],
                    libre: [200, 200, 200],
                    maletero: [234, 179, 8],
                    zoclo: [139, 92, 60]
                };
                // Center modules horizontally: calculate total drawn width per row
                var row1W = 0,
                    row2W = 0;
                modules.forEach(function(m, i) {
                    var w = m.width * scale;
                    if (i < modsPerRow)
                        row1W += w;
                    else
                        row2W += w;
                });
                row1W += (Math.min(nMods, modsPerRow) - 1) * modGap;
                if (useRows > 1 && nMods > modsPerRow)
                    row2W += (nMods - modsPerRow - 1) * modGap;
                var contentArea = pw - 2 * margin;
                var curX = margin + (contentArea - row1W) / 2;
                // Track the bottom-most Y for legend placement
                var maxBottomY = 0;
                doc.setFontSize(8);
                modules.forEach(function(m, mi) {
                    // Row management
                    if (useRows > 1 && mi === modsPerRow) {
                        curX = margin + (contentArea - row2W) / 2;
                        rowStartY = rowStartY + maxVisH * scale + 25;
                    }
                    var mH = estModHeight(m);
                    var W = m.width * scale;
                    var H = mH * scale;
                    var eu = estEspacioUtil(m);
                    var fixed = calcEstFixedHeight(m);
                    var hasColg = m.zones.some(function(z) {
                        return z.type === 'colgador';
                    });
                    var isEsp = m.type === 'especial';
                    var freeSpace = eu - fixed;
                    var barX = curX;
                    var barW = W;
                    var barH = H;
                    // Maletero above module body
                    var malObj = m.maletero || {
                        enabled: false,
                        height: 30
                    };
                    var malH2 = malObj.enabled ? (malObj.height || 30) * scale : 0;
                    // Module body starts after maletero
                    var bodyY = rowStartY + malH2;
                    // Draw maletero above the body
                    if (malObj.enabled) {
                        doc.setFillColor(zColors.maletero[0], zColors.maletero[1], zColors.maletero[2]);
                        doc.rect(barX, rowStartY, barW, malH2, 'F');
                        doc.setDrawColor(180, 150, 0);
                        doc.rect(barX, rowStartY, barW, malH2);
                        doc.setTextColor(80, 60, 0);
                        doc.setFontSize(6);
                        doc.text((malObj.height || 30) + 'cm', barX + barW / 2, rowStartY + malH2 / 2 + 1, {
                            align: 'center'
                        });
                    }
                    // Module body outline
                    doc.setDrawColor(150, 150, 150);
                    doc.setLineWidth(0.3);
                    if (m.type !== 'esquinero')
                        doc.rect(barX, bodyY, barW, barH);
                    // Techo (skip for fijo)
                    var segY = bodyY;
                    var tkH = tk * scale;
                    if (m.type !== 'fijo') {
                        doc.setFillColor(zColors.techo[0], zColors.techo[1], zColors.techo[2]);
                        doc.rect(barX, segY, barW, tkH, 'F');
                        doc.setFontSize(6);
                        doc.setTextColor(180, 180, 180);
                        doc.text('T', barX + barW / 2, segY + tkH - 0.5, {
                            align: 'center'
                        });
                        segY += tkH;
                    }
                    // Zones  array is already topbottom, draw in order
                    var hasDoors = false;
                    m.zones.forEach(function(z) {
                        var zh = getEstZoneDisplayHeight(m, z);
                        var segH2 = zh * scale;
                        var col = zColors[z.type] || [160, 160, 160];
                        var zoneStartY = segY; // track start for door lines
                        if (z.type === 'entrepa' && (isEsp || (!hasColg && freeSpace > 0))) {
                            var cnt = z.count || 2;
                            var spaceForEnt = isEsp ? eu : freeSpace;
                            var totalSegH = spaceForEnt * scale;
                            var entLineH = tk * scale * 0.5;
                            var sectionH = (totalSegH - cnt * entLineH) / (cnt + 1);
                            for (var si = 0; si < cnt + 1; si++) {
                                doc.setFillColor(240, 240, 240);
                                doc.rect(barX + 0.5, segY, barW - 1, Math.max(1, sectionH), 'F');
                                segY += Math.max(1, sectionH);
                                if (si < cnt) {
                                    doc.setFillColor(col[0], col[1], col[2]);
                                    doc.rect(barX + 0.5, segY, barW - 1, Math.max(0.5, entLineH), 'F');
                                    segY += Math.max(0.5, entLineH);
                                }
                            }
                        } else if (z.type === 'colgador') {
                            doc.setFillColor(col[0], col[1], col[2]);
                            doc.setGState(new doc.GState({
                                opacity: 0.3
                            }));
                            doc.rect(barX + 0.5, segY, barW - 1, segH2, 'F');
                            doc.setGState(new doc.GState({
                                opacity: 1
                            }));
                            doc.setDrawColor(col[0], col[1], col[2]);
                            doc.setLineDashPattern([1, 1], 0);
                            doc.rect(barX + 0.5, segY, barW - 1, segH2);
                            doc.setLineDashPattern([], 0);
                            var tuboY2 = segY + Math.min(4, segH2 * 0.3);
                            doc.setDrawColor(col[0], col[1], col[2]);
                            doc.setLineWidth(0.5);
                            doc.line(barX + 3, tuboY2, barX + barW - 3, tuboY2);
                            doc.setLineWidth(0.3);
                            doc.setFontSize(6);
                            doc.setTextColor(col[0], col[1], col[2]);
                            doc.text(Math.round(zh) + 'cm', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else if (z.type === 'cajones') {
                            var cCnt = z.count || 3;
                            var cUnitH = segH2 / cCnt;
                            for (var ci = 0; ci < cCnt; ci++) {
                                doc.setFillColor(col[0], col[1], col[2]);
                                doc.rect(barX + 0.5, segY + ci * cUnitH, barW - 1, Math.max(1, cUnitH - 0.5), 'F');
                            }
                            doc.setFontSize(6);
                            doc.setTextColor(255, 255, 255);
                            doc.text(cCnt + 'C', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else if (z.type === 'zapatero') {
                            var zCnt = z.repisas || 3;
                            var zUnitH = segH2 / zCnt;
                            for (var zzi = 0; zzi < zCnt; zzi++) {
                                doc.setFillColor(col[0], col[1], col[2]);
                                doc.rect(barX + 0.5, segY + zzi * zUnitH, barW - 1, Math.max(1, zUnitH - 0.5), 'F');
                            }
                            doc.setFontSize(6);
                            doc.setTextColor(255, 255, 255);
                            doc.text(zCnt + 'Z', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else {
                            doc.setFillColor(col[0], col[1], col[2]);
                            doc.rect(barX + 0.5, segY, barW - 1, segH2, 'F');
                            segY += segH2;
                        }
                        if (z.doors)
                            hasDoors = true;
                    });
                    // Check for completa door mode
                    var pdfDoorMode = m.doorMode || 'por_zona';
                    if (m.doors && pdfDoorMode === 'completa')
                        hasDoors = true;
                    // Piso (skip for fijo)
                    if (m.type !== 'fijo') {
                        doc.setFillColor(zColors.piso[0], zColors.piso[1], zColors.piso[2]);
                        doc.rect(barX, segY, barW, tkH, 'F');
                        doc.setFontSize(6);
                        doc.setTextColor(180, 180, 180);
                        doc.text('P', barX + barW / 2, segY + tkH - 0.5, {
                            align: 'center'
                        });
                        segY += tkH;
                    }
                    // Zoclo (below module body)
                    var zoc2 = m.zoclo || {
                        enabled: false,
                        height: 10
                    };
                    if (zoc2.enabled) {
                        var zocH2 = (zoc2.height || 10) * scale;
                        doc.setFillColor(zColors.zoclo[0], zColors.zoclo[1], zColors.zoclo[2]);
                        doc.rect(barX, segY, barW, zocH2, 'F');
                        doc.setFontSize(5);
                        doc.setTextColor(255, 255, 255);
                        doc.text('Z', barX + barW / 2, segY + zocH2 / 2 + 1, {
                            align: 'center'
                        });
                        segY += zocH2;
                    }
                    // Door indicator  spans full module body
                    if (hasDoors) {
                        var pdfDoorCnt = (m.doors && pdfDoorMode === 'completa') ? (m.doorCount || 2) : 2;
                        doc.setDrawColor(196, 154, 108);
                        doc.setLineWidth(0.4);
                        doc.line(barX, bodyY, barX, bodyY + barH);
                        doc.line(barX + barW, bodyY, barX + barW, bodyY + barH);
                        if (pdfDoorCnt >= 2) {
                            doc.line(barX + barW / 2, bodyY, barX + barW / 2, bodyY + barH);
                        }
                        doc.setLineWidth(0.3);
                    }
                    // Esquinero L-shape visual
                    if (m.type === 'esquinero') {
                        var esqArmW = Math.max(barW * 0.45, 6);
                        var esqTopH = Math.max(barH * 0.38, 6);
                        var esqMaskBot = Math.max(segY, bodyY + barH);
                        // Mask bottom-right notch area with white
                        doc.setFillColor(255, 255, 255);
                        doc.rect(barX + esqArmW, bodyY + esqTopH, barW - esqArmW + 1, esqMaskBot - bodyY - esqTopH + 1, 'F');
                        // Draw L-shaped outline
                        doc.setDrawColor(150, 150, 150);
                        doc.setLineWidth(0.3);
                        doc.lines([
                        [barW, 0], [0, esqTopH], [-(barW - esqArmW), 0], [0, barH - esqTopH], [-esqArmW, 0], [0, -barH]
                        ], barX, bodyY, [1, 1], 'S', true);
                        // Lado A / Lado B labels
                        doc.setFontSize(5);
                        doc.setTextColor(120, 120, 120);
                        doc.setFont('helvetica', 'normal');
                        doc.text('A:' + m.width + 'cm', barX + barW / 2, bodyY + esqTopH * 0.6, {
                            align: 'center'
                        });
                        doc.text('B:' + (m.width2 || m.width) + 'cm', barX + esqArmW / 2, bodyY + esqTopH + (barH - esqTopH) * 0.5, {
                            align: 'center'
                        });
                    }
                    // Module number label above the visual
                    var labelTopY = malObj.enabled ? rowStartY : bodyY;
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(60, 60, 60);
                    doc.text('M' + (mi + 1), barX + barW / 2, labelTopY - 1.5, {
                        align: 'center'
                    });
                    var thisBottom = segY + 2;
                    if (thisBottom > maxBottomY)
                        maxBottomY = thisBottom;
                    doc.setFontSize(8);
                    curX += W + modGap;
                });
                // Module names listed at the bottom of the sheet  always in reserved area
                var bottomY = ph - reservedBottom + 4;
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(60, 60, 60);
                doc.text('Detalle de M\u00f3dulos:', margin, bottomY);
                bottomY += 4;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6.5);
                modules.forEach(function(m, mi) {
                    var mLabel = m.width + 'cm';
                    if (m.type === 'esquinero')
                        mLabel = m.width + 'x' + (m.width2 || m.width) + 'cm';
                    else if (m.type === 'fijo')
                        mLabel = m.width + 'x' + m.height + 'cm';
                    var typeName = m.type === 'esquinero' ? 'Esquinero' : m.type === 'fijo' ? 'Fijo' : m.type === 'panelTV' ? 'Panel TV' : m.type === 'especial' ? 'Especial' : m.type === 'torreLateral' ? 'Torre Lat.' : 'M\u00f3dulo';
                    var zoneSummary = [];
                    m.zones.forEach(function(z2) {
                        if (z2.type === 'cajones')
                            zoneSummary.push((z2.count || 3) + ' cajones');
                        else if (z2.type === 'colgador')
                            zoneSummary.push('colgador');
                        else if (z2.type === 'zapatero')
                            zoneSummary.push((z2.repisas || 3) + ' zapatero');
                        else if (z2.type === 'entrepa')
                            zoneSummary.push((z2.count || 2) + ' entrepa\u00f1os');
                    });
                    if (m.doors) {
                        var dm = m.doorMode || 'por_zona';
                        if (dm === 'completa')
                            zoneSummary.push((m.doorCount || 2) + ' puertas completas');
                        else
                            zoneSummary.push('puertas por zona');
                    }
                    var line = (mi + 1) + '. ' + typeName + ' \u2014 ' + mLabel;
                    if (zoneSummary.length > 0)
                        line += ' (' + zoneSummary.join(', ') + ')';
                    doc.setTextColor(40, 40, 40);
                    doc.setFont('helvetica', 'bold');
                    doc.text((mi + 1) + '. ' + typeName, margin, bottomY);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(80, 80, 80);
                    doc.text(' \u2014 ' + mLabel + (zoneSummary.length > 0 ? ' (' + zoneSummary.join(', ') + ')' : ''), margin + doc.getTextWidth((mi + 1) + '. ' + typeName), bottomY);
                    bottomY += 3.5;
                });
                // Legend
                bottomY += 2;
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);
                var legItems = [
                {
                    c: zColors.cajones,
                    l: 'Cajones'
                }, {
                    c: zColors.colgador,
                    l: 'Colgador'
                },
                {
                    c: zColors.zapatero,
                    l: 'Zapatero'
                }, {
                    c: zColors.entrepa,
                    l: 'Entrepa\u00f1os'
                },
                {
                    c: zColors.techo,
                    l: 'Techo/Piso'
                }, {
                    c: zColors.maletero,
                    l: 'Maletero'
                },
                {
                    c: zColors.zoclo,
                    l: 'Zoclo'
                }
                ];
                var legX = margin;
                legItems.forEach(function(li) {
                    doc.setFillColor(li.c[0], li.c[1], li.c[2]);
                    doc.rect(legX, bottomY - 2, 3, 2.5, 'F');
                    doc.text(li.l, legX + 4, bottomY);
                    legX += 25;
                });
                doc.text('Espesor: ' + EP.thickness + 'mm \u00b7 Prof: ' + estProjDepth() + 'cm \u00b7 Total: ' + modules.length + ' m\u00f3dulo' + (modules.length > 1 ? 's' : ''), margin, bottomY + 4);
            }
        }

        // CUSTOMIZE: Client PDF  black & white Excel-style layout
        function genClientPDF(optProject, optCalc) {
            if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado. Verifica tu conexion a internet.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                P = optProject || S.project,
                c = optCalc || calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var black = [0, 0, 0];
            var white = [255, 255, 255];
            var pw = 215.9, ph = 279.4, margin = 15, cw = pw - margin * 2;
            var y = margin;

            // === PAGE 1: QUOTE ===

            // 1. Title bar  full-width black rect with RENOVA
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 14, 'F');
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            if (S.logoBase64) {
                try { doc.addImage(S.logoBase64, 'PNG', margin + 2, y + 1, 30, 12); } catch (e) {}
                doc.text(br.name.toUpperCase(), margin + 35, y + 10);
            } else {
                doc.text(br.name.toUpperCase(), margin + 6, y + 10);
            }
            y += 14;

            // 2. Info row  black bg: Fecha left, Cotizacion right
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('Fecha: ' + fmtDatePDF(), margin + 4, y + 5.5);
            doc.text('Cotizacion: ' + d.quoteNum, margin + cw - 4, y + 5.5, { align: 'right' });
            y += 8;

            // 3. Cliente row  white bg
            doc.setFillColor(white[0], white[1], white[2]);
            doc.setDrawColor(black[0], black[1], black[2]);
            doc.setLineWidth(0.3);
            doc.rect(margin, y, cw, 8, 'FD');
            doc.setFontSize(10);
            doc.setTextColor(black[0], black[1], black[2]);
            doc.setFont('helvetica', 'normal');
            doc.text('Cliente:', margin + 4, y + 5.5);
            doc.setFont('helvetica', 'bold');
            doc.text(d.client || '', margin + 28, y + 5.5);
            y += 8;

            // 4. Proyecto row  black bg
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(10);
            doc.setTextColor(white[0], white[1], white[2]);
            doc.setFont('helvetica', 'normal');
            doc.text('Proyecto:', margin + 4, y + 5.5);
            doc.setFont('helvetica', 'bold');
            doc.text(d.projectName || '', margin + 30, y + 5.5);
            y += 8;

            // 5. Intro text  black bg
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('A continuacion remito la propuesta economica para su proyecto de muebles a la medida.', margin + 4, y + 5.5);
            y += 10;

            // 6. Item table using autoTable
            var itemTotal = d.items.reduce(function(a, it) { return a + (it.price * (it.qty || 1)); }, 0);
            var tableBody = d.items.map(function(it) {
                var total = (it.price || 0) * (it.qty || 1);
                return [
                    it.desc || it.name || '',
                    '$' + Math.round(it.price || 0).toLocaleString('es-MX'),
                    String(it.qty || 1),
                    '$' + Math.round(total).toLocaleString('es-MX')
                ];
            });

            doc.autoTable({
                startY: y,
                margin: { left: margin, right: margin },
                head: [['DESCRIPCION', 'PRECIO', 'CANT.', 'TOTAL']],
                body: tableBody,
                foot: [['TOTAL', '', '', '$' + Math.round(itemTotal).toLocaleString('es-MX')]],
                theme: 'plain',
                styles: {
                    fontSize: 8.5,
                    cellPadding: 3,
                    lineColor: black,
                    lineWidth: 0.3,
                    textColor: black
                },
                headStyles: {
                    fillColor: black,
                    textColor: white,
                    fontStyle: 'bold',
                    fontSize: 9
                },
                footStyles: {
                    fillColor: black,
                    textColor: white,
                    fontStyle: 'bold',
                    fontSize: 9
                },
                columnStyles: {
                    0: { cellWidth: cw * 0.50 },
                    1: { cellWidth: cw * 0.18, halign: 'right' },
                    2: { cellWidth: cw * 0.10, halign: 'center' },
                    3: { cellWidth: cw * 0.22, halign: 'right' }
                },
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });
            y = doc.lastAutoTable.finalY + 4;

            // 7. Totals section  right-aligned
            var roundedTotal = Math.round(itemTotal / 100) * 100;
            var iva = Math.round(roundedTotal * CONFIG.pricing.iva);
            var grandTotal = roundedTotal + iva;
            var totalsW = 80;
            var totalsX = margin + cw - totalsW;
            // Subtotal row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('SUBTOTAL', totalsX + 4, y + 5);
            doc.text('$' + roundedTotal.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 5, { align: 'right' });
            y += 7;
            // IVA row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 7, 'F');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%', totalsX + 4, y + 5);
            doc.text('$' + iva.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 5, { align: 'right' });
            y += 7;
            // Grand total row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 9, 'F');
            doc.setFontSize(11);
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('TOTAL', totalsX + 4, y + 6.5);
            doc.text('$' + grandTotal.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 6.5, { align: 'right' });
            y += 13;

            // 8. Legal terms
            if (y > 210) { doc.addPage(); y = margin; }
            var legalTerms = CONFIG.brand.legalTerms || CONFIG.quoting.terms.map(function(t) {
                return t.replace('{anticipo}', d.anticipo).replace('{deliveryTime}', d.deliveryTime);
            });
            doc.setTextColor(black[0], black[1], black[2]);
            legalTerms.forEach(function(t) {
                if (y > ph - 20) { doc.addPage(); y = margin; }
                if (!t || t.trim() === '') { y += 3; return; }
                if (t.trim().slice(-1) === ':') {
                    // Section header bar
                    y += 2;
                    doc.setFillColor(black[0], black[1], black[2]);
                    doc.rect(margin, y, cw, 7, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.setTextColor(white[0], white[1], white[2]);
                    doc.text(t, margin + 4, y + 5);
                    doc.setTextColor(black[0], black[1], black[2]);
                    y += 10;
                } else {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    var tLines = doc.splitTextToSize(t, cw - 8);
                    doc.text(tLines, margin + 4, y);
                    y += tLines.length * 3.8 + 2;
                }
            });
            if (d.notes) {
                y += 3;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('Nota: ' + d.notes, margin + 4, y);
                y += 6;
            }
            y += 6;

            // 9. Contact footer
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 0.5, 'F');
            y += 4;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(black[0], black[1], black[2]);
            doc.text('Encargado del proyecto: ' + CONTACT.name, margin + 4, y);
            y += 3.5;
            doc.text('Contacto: ' + CONTACT.cell + '  |  ' + CONTACT.email, margin + 4, y);

            // === PAGE 2: MATERIALES ===
            doc.addPage();
            y = margin;
            var matMargin = margin;

            // Header
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 12, 'F');
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('MATERIALES', matMargin + 6, y + 8.5);
            y += 12;

            // Project/Vendedor info row
            doc.setFillColor(white[0], white[1], white[2]);
            doc.setDrawColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'FD');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(black[0], black[1], black[2]);
            doc.text('Proyecto: ' + (d.projectName || '') + '  |  Cliente: ' + (d.client || '') + '  |  ' + d.quoteNum, matMargin + 4, y + 4.8);
            y += 9;

            // CARPINTERIA section
            var carpMultiplier = CONFIG.pricing.carpentryMultiplier;
            var carpBody = [];
            if (c.totalSheetsF > 0) {
                var sheetSaleF = Math.round(getMatPrice(P.matFrentes, P.thickness) * carpMultiplier);
                carpBody.push([
                    String(c.totalSheetsF),
                    'Hoja',
                    'Melamina ' + P.matFrentes.name + (P.matFrentes.finish ? ' ' + P.matFrentes.finish : '') + ' ' + P.thickness + 'mm',
                    P.matFrentes.brand || 'FINSA',
                    '$' + Math.round(c.totalSheetsF * sheetSaleF).toLocaleString('es-MX')
                ]);
            }
            if (c.useDual && c.totalSheetsI > 0) {
                var sheetSaleI = Math.round(getMatPrice(P.matInterior, P.thickness) * carpMultiplier);
                carpBody.push([
                    String(c.totalSheetsI),
                    'Hoja',
                    'Melamina ' + P.matInterior.name + (P.matInterior.finish ? ' ' + P.matInterior.finish : '') + ' ' + P.thickness + 'mm (Interior)',
                    P.matInterior.brand || 'FINSA',
                    '$' + Math.round(c.totalSheetsI * sheetSaleI).toLocaleString('es-MX')
                ]);
            }
            if (c.totalCanto > 0) {
                var chapSale = Math.round((c.chapCostF + c.chapCostI) * carpMultiplier);
                carpBody.push([
                    String(c.totalCanto),
                    'ML',
                    'Chapacanto ' + (CONFIG.pricing.defaultChapSpec || ''),
                    '',
                    '$' + chapSale.toLocaleString('es-MX')
                ]);
            }
            if (c.totalSheets > 0) {
                carpBody.push([
                    String(c.totalSheets),
                    'Hoja',
                    'Corte CNC',
                    '',
                    '$' + Math.round(c.corteCost * carpMultiplier).toLocaleString('es-MX')
                ]);
            }
            if (c.totalCanto > 0) {
                carpBody.push([
                    String(c.totalCanto),
                    'ML',
                    'Enchapado',
                    '',
                    '$' + Math.round(c.enchapCost * carpMultiplier).toLocaleString('es-MX')
                ]);
            }

            // Section header for CARPINTERIA
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('CARPINTERIA', matMargin + 4, y + 4.8);
            y += 8;

            if (carpBody.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: { left: matMargin, right: margin },
                    tableWidth: cw,
                    head: [['CANT.', 'UNIDAD', 'DESCRIPCION', 'MARCA', 'TOTAL']],
                    body: carpBody,
                    foot: [['TOTAL CARPINTERIA', '', '', '', '$' + Math.round(c.carpSale).toLocaleString('es-MX')]],
                    theme: 'plain',
                    styles: { fontSize: 8, cellPadding: 2.5, lineColor: black, lineWidth: 0.2, textColor: black },
                    headStyles: { fillColor: [220, 220, 220], textColor: black, fontStyle: 'bold' },
                    footStyles: { fillColor: black, textColor: white, fontStyle: 'bold', fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 14, halign: 'center' },
                        1: { cellWidth: 16, halign: 'center' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 24 },
                        4: { cellWidth: 35, halign: 'right' }
                    },
                    didParseCell: function(data) {
                        if (data.section === 'foot' && data.column.index === 0) {
                            data.cell.colSpan = 4;
                        }
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            }

            // Check if HERRAJES section fits, otherwise new page
            if (y > ph - 50) { doc.addPage(); y = margin; }

            // HERRAJES section
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('HERRAJES', matMargin + 4, y + 4.8);
            y += 8;

            var hwBody = [];
            c.allHW.forEach(function(hw) {
                var qty = Math.ceil(hw.qty);
                if (qty <= 0) return;
                var salePrice;
                if (hw._bucket === 'carp') {
                    salePrice = Math.round(hw.price * carpMultiplier);
                } else {
                    salePrice = Math.round(hw.price / (1 - CONFIG.pricing.premiumHardwareMargin));
                }
                hwBody.push([
                    String(qty),
                    'Pza',
                    hw.desc,
                    hw.marca || '',
                    '$' + Math.round(qty * salePrice).toLocaleString('es-MX')
                ]);
            });

            var hwSaleTotal = c.hwPremiumSale + (c.hwCostCarpBucket * carpMultiplier);
            if (hwBody.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: { left: matMargin, right: margin },
                    tableWidth: cw,
                    head: [['CANT.', 'UNIDAD', 'DESCRIPCION', 'MARCA', 'TOTAL']],
                    body: hwBody,
                    foot: [['TOTAL HERRAJES', '', '', '', '$' + Math.round(hwSaleTotal).toLocaleString('es-MX')]],
                    theme: 'plain',
                    styles: { fontSize: 8, cellPadding: 2.5, lineColor: black, lineWidth: 0.2, textColor: black },
                    headStyles: { fillColor: [220, 220, 220], textColor: black, fontStyle: 'bold' },
                    footStyles: { fillColor: black, textColor: white, fontStyle: 'bold', fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 14, halign: 'center' },
                        1: { cellWidth: 16, halign: 'center' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 24 },
                        4: { cellWidth: 35, halign: 'right' }
                    },
                    didParseCell: function(data) {
                        if (data.section === 'foot' && data.column.index === 0) {
                            data.cell.colSpan = 4;
                        }
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            } else {
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('(Sin herrajes)', matMargin + 4, y + 4);
                y += 10;
            }


            // Plano page
            addPlanoPage(doc, margin);

            // Save
            var fname = d.quoteNum + '-Cotizacion-' + (d.client || 'Cliente').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
            // Increment counter
            S.quoteCounter++;
            try {
                localStorage.setItem(CONFIG.storage.prefix + 'quote_counter', S.quoteCounter);
            } catch (e) {}
        }

        function genInternalPDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                c = calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            var red = [220, 38, 38];
            var pw = 215.9,
                margin = 20;
            var y = margin;
            // Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text(br.name + ' - DESGLOSE DE COSTOS', margin, y + 6);
            y += 12;
            // Red banner
            doc.setFillColor(red[0], red[1], red[2]);
            doc.rect(margin, y, pw - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('CONFIDENCIAL - NO COMPARTIR CON CLIENTE', pw / 2, y + 5.5, {
                align: 'center'
            });
            y += 12;
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(d.quoteNum + ' | ' + fmtDatePDF() + ' | Cliente: ' + (d.client || ''), margin, y);
            y += 8;
            // Cost breakdown table
            var tableData = [];
            // Carpinteria section
            tableData.push([{
                content: 'CARPINTERIA (x' + CONFIG.pricing.carpentryMultiplier + ')',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            if (c.totalSheetsF > 0)
                tableData.push(['Mat. Frentes (' + c.totalSheetsF + ' hojas)', '', '$' + Math.round(c.matCostF).toLocaleString('es-MX'), '']);
            if (c.useDual && c.totalSheetsI > 0)
                tableData.push(['Mat. Interior (' + c.totalSheetsI + ' hojas)', '', '$' + Math.round(c.matCostI).toLocaleString('es-MX'), '']);
            tableData.push(['Chapacanto', c.totalCanto + ' ml', '$' + Math.round(c.chapCostF + c.chapCostI).toLocaleString('es-MX'), '']);
            tableData.push(['Corte', c.totalSheets + ' hojas', '$' + Math.round(c.corteCost).toLocaleString('es-MX'), '']);
            tableData.push(['Enchapado', c.totalCanto + ' ml', '$' + Math.round(c.enchapCost).toLocaleString('es-MX'), '']);
            tableData.push(['Mano de obra', '', '$' + Math.round(S.project.laborCost).toLocaleString('es-MX'), '']);
            tableData.push([{
                content: 'Subtotal carpinteria',
                styles: {
                    fontStyle: 'bold'
                }
            }, '', '$' + Math.round(c.carpCost).toLocaleString('es-MX'), '$' + Math.round(c.carpSale).toLocaleString('es-MX')]);
            // Herrajes  carpentry bucket
            tableData.push([{
                content: 'HERRAJES EN CARPINTERIA (\u2264$' + CONFIG.pricing.hardwareThreshold + ')',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            var hasCarpHW = false;
            c.allHW.forEach(function(hw) {
                if (hw._bucket !== 'carp') return;
                hasCarpHW = true;
                tableData.push([hw.desc + ' (' + hw.marca + ')', Math.ceil(hw.qty), '$' + Math.round(Math.ceil(hw.qty) * hw.price).toLocaleString('es-MX'), '']);
            });
            if (!hasCarpHW)
                tableData.push(['(ninguno)', '', '$0', '']);
            tableData.push([{
                content: 'Subtotal herrajes (en carp.)',
                styles: { fontStyle: 'bold' }
            }, '', '$' + Math.round(c.hwCostCarpBucket).toLocaleString('es-MX'), '(incl. en carp.)']);
            // Premium hardware
            tableData.push([{
                content: 'HERRAJES PREMIUM (>$' + CONFIG.pricing.hardwareThreshold + ', ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            var hasPremHW = false;
            c.allHW.forEach(function(hw) {
                if (hw._bucket !== 'premium') return;
                hasPremHW = true;
                tableData.push([hw.desc + ' (' + hw.marca + ')', Math.ceil(hw.qty), '$' + Math.round(Math.ceil(hw.qty) * hw.price).toLocaleString('es-MX'), '']);
            });
            if (!hasPremHW)
                tableData.push(['(ninguno)', '', '$0', '$0']);
            tableData.push([{
                content: 'Subtotal premium',
                styles: { fontStyle: 'bold' }
            }, '', '$' + Math.round(c.hwCostPremium).toLocaleString('es-MX'), '$' + Math.round(c.hwPremiumSale).toLocaleString('es-MX')]);
            // Extras
            if (c.extraCost > 0) {
                tableData.push([{
                    content: 'EXTRAS (x' + CONFIG.pricing.extrasMultiplier + ')',
                    colSpan: 4,
                    styles: {
                        fillColor: [200, 200, 200],
                        fontStyle: 'bold',
                        fontSize: 9
                    }
                }]);
                if (c.ledBOM) {
                    tableData.push([{
                        content: 'LED BOM (' + c.ledBOM.totalMeters.toFixed(1) + 'm, ' + c.ledBOM.totalSegments + ' seg, ' + c.ledBOM.alimentadorW + 'W)',
                        colSpan: 4,
                        styles: {
                            fontStyle: 'bold',
                            fontSize: 8,
                            textColor: [180, 140, 50]
                        }
                    }]);
                    c.ledBOM.items.forEach(function(it) {
                        tableData.push([it.desc, it.qty, '$' + Math.round(it.total).toLocaleString('es-MX'), '']);
                    });
                    tableData.push([{
                        content: 'Subtotal LED',
                        styles: {
                            fontStyle: 'bold'
                        }
                    }, '', '$' + Math.round(c.ledBOM.totalCost).toLocaleString('es-MX'), '']);
                }
                if (S.project.glass)
                    tableData.push(['Vidrio ' + S.project.glassM2 + 'm2', '', '$' + Math.round(S.project.glassM2 * CONFIG.pricing.glassCostPerM2).toLocaleString('es-MX'), '']);
                if (c.paintCost > 0) {
                    S.project.modules.forEach(function(m2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'custom',
                                defaultHeight: S.project.defaultHeight,
                                defaultDepth: S.project.defaultDepth
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                tableData.push(['Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' (' + lit.toFixed(1) + 'L)', '', '$' + Math.round(lit * m2.paint.pricePerLiter).toLocaleString('es-MX'), '']);
                        }
                    });
                }
                tableData.push([{
                    content: 'Subtotal extras',
                    styles: {
                        fontStyle: 'bold'
                    }
                }, '', '$' + Math.round(c.extraCost).toLocaleString('es-MX'), '$' + Math.round(c.extrasSale).toLocaleString('es-MX')]);
            }
            doc.autoTable({
                startY: y,
                margin: {
                    left: margin,
                    right: margin
                },
                head: [['Concepto', 'Cant.', 'Costo', 'Venta']],
                body: tableData,
                headStyles: {
                    fillColor: dark,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                bodyStyles: {
                    fontSize: 8,
                    textColor: dark
                },
                columnStyles: {
                    0: {
                        cellWidth: 80
                    },
                    1: {
                        cellWidth: 25
                    },
                    2: {
                        cellWidth: 35,
                        halign: 'right'
                    },
                    3: {
                        cellWidth: 35,
                        halign: 'right'
                    }
                },
                alternateRowStyles: {
                    fillColor: [250, 248, 245]
                }
            });
            y = doc.lastAutoTable.finalY + 8;
            // Summary box
            if (y > 230) {
                doc.addPage();
                y = margin;
            }
            doc.setFillColor(245, 240, 235);
            doc.rect(margin, y, pw - margin * 2, 40, 'F');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('RESUMEN DE RENTABILIDAD', margin + 5, y + 7);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Costo total:', margin + 5, y + 15);
            doc.text('$' + Math.round(c.totalCost).toLocaleString('es-MX'), margin + 70, y + 15);
            doc.text('Precio venta:', margin + 5, y + 21);
            doc.text('$' + Math.round(c.subtotal).toLocaleString('es-MX'), margin + 70, y + 21);
            doc.text('Utilidad bruta:', margin + 5, y + 27);
            doc.text('$' + Math.round(c.profit).toLocaleString('es-MX'), margin + 70, y + 27);
            doc.setFont('helvetica', 'bold');
            doc.text('Margen real:', margin + 5, y + 33);
            doc.text(c.margin + '%', margin + 70, y + 33);
            // Save
            var fname = d.quoteNum + '-Desglose-' + (d.client || 'Interno').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
        }

        function genEstInternalPDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var EP = S.estProject,
                c = calcEstandarizado(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var d = S.estPdfData || {
                quoteNum: '',
                client: EP.client
            };
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            var red = [220, 38, 38];
            var pw = 215.9,
                margin = 20;
            var y = margin;
            // Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text(br.name + ' - DESGLOSE DE COSTOS', margin, y + 6);
            y += 12;
            // Red banner
            doc.setFillColor(red[0], red[1], red[2]);
            doc.rect(margin, y, pw - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('CONFIDENCIAL - NO COMPARTIR CON CLIENTE', pw / 2, y + 5.5, {
                align: 'center'
            });
            y += 12;
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text((d.quoteNum || '') + ' | ' + fmtDatePDF() + ' | Cliente: ' + (d.client || EP.client || ''), margin, y);
            y += 5;
            var pdfProjName = EP.mode === 'custom' ? 'Proyecto Personalizado' : 'Closet Estandarizado';
            doc.text(pdfProjName + ' | ' + c.totalSheets + ' hojas | ' + c.totalCanto + ' ml chapacanto', margin, y);
            y += 8;
            // Despiece table  merge pieces with same name + dimensions
            var merged = {};
            c.pieces.forEach(function(p) {
                var al = anchoLargo(p.w, p.h);
                var key = p.n + '|' + al.ancho + 'x' + al.largo + '|' + p.t;
                if (!merged[key])
                    merged[key] = {
                        n: p.n,
                        q: 0,
                        medida: al.ancho + 'x' + al.largo,
                        t: p.t
                    };
                merged[key].q += p.q;
            });
            var despData = [];
            Object.keys(merged).forEach(function(k) {
                var m2 = merged[k];
                despData.push([m2.n, m2.q, m2.medida, m2.t + 'mm']);
            });
            doc.autoTable({
                startY: y,
                margin: {
                    left: margin,
                    right: margin
                },
                head: [['Pieza', 'Qty', 'Medida (mm)', 'Esp.']],
                body: despData,
                headStyles: {
                    fillColor: dark,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 8
                },
                bodyStyles: {
                    fontSize: 7,
                    textColor: dark
                },
                columnStyles: {
                    0: {
                        cellWidth: 65
                    },
                    1: {
                        cellWidth: 15,
                        halign: 'center'
                    },
                    2: {
                        cellWidth: 40
                    },
                    3: {
                        cellWidth: 18,
                        halign: 'center'
                    }
                },
                alternateRowStyles: {
                    fillColor: [250, 248, 245]
                }
            });
            y = doc.lastAutoTable.finalY + 6;
            // Cost breakdown table
            if (y > 200) {
                doc.addPage();
                y = margin;
            }
            var tableData = [];
            var pdfMatF = EP.matFrentes.brand === 'CUSTOM' ? (EP.matFrentes.name || 'Personalizado') : EP.matFrentes.brand + ' ' + EP.matFrentes.name;
            var pdfMatI = EP.matInterior.brand === 'CUSTOM' ? (EP.matInterior.name || 'Personalizado') : EP.matInterior.brand + ' ' + EP.matInterior.name;
            tableData.push([{
                content: 'CARPINTERIA',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            var pdfTK = c.projThickness || 16;
            if (c.totalSheetsF > 0)
                tableData.push([pdfMatF + ' ' + pdfTK + 'mm (' + c.totalSheetsF + ' hojas x $' + Math.round(c.matPriceF).toLocaleString('es-MX') + ')', c.totalSheetsF, '$' + Math.round(c.totalSheetsF * c.matPriceF).toLocaleString('es-MX'), '']);
            if (c.useDual && c.totalSheetsI > 0)
                tableData.push([pdfMatI + ' ' + pdfTK + 'mm (' + c.totalSheetsI + ' hojas x $' + Math.round(c.matPriceI).toLocaleString('es-MX') + ')', c.totalSheetsI, '$' + Math.round(c.totalSheetsI * c.matPriceI).toLocaleString('es-MX'), '']);
            tableData.push(['Chapacanto', c.totalCanto + ' ml', '$' + Math.round(c.chapCostF + c.chapCostI).toLocaleString('es-MX'), '']);
            tableData.push(['Corte', c.totalSheets + ' hojas', '$' + Math.round(c.corteCost).toLocaleString('es-MX'), '']);
            tableData.push(['Enchapado', c.totalCanto + ' ml', '$' + Math.round(c.enchapCost).toLocaleString('es-MX'), '']);
            tableData.push(['Mano de obra', '', '$' + Math.round(EP.laborCost).toLocaleString('es-MX'), '']);
            tableData.push([{
                content: 'Subtotal carpinteria',
                styles: {
                    fontStyle: 'bold'
                }
            }, '', '$' + Math.round(c.carpCost).toLocaleString('es-MX'), '']);
            tableData.push([{
                content: 'HERRAJES',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            c.allHW.forEach(function(hw) {
                tableData.push([hw.desc + ' (' + hw.marca + ')', Math.ceil(hw.qty), '$' + Math.round(Math.ceil(hw.qty) * hw.price).toLocaleString('es-MX'), '']);
            });
            tableData.push([{
                content: 'Subtotal herrajes',
                styles: {
                    fontStyle: 'bold'
                }
            }, '', '$' + Math.round(c.hwCostCarpBucket + c.hwCostPremium).toLocaleString('es-MX'), '']);
            if (c.extraCost > 0) {
                tableData.push([{
                    content: 'EXTRAS',
                    colSpan: 4,
                    styles: {
                        fillColor: [200, 200, 200],
                        fontStyle: 'bold',
                        fontSize: 9
                    }
                }]);
                if (c.ledBOM) {
                    c.ledBOM.items.forEach(function(it) {
                        tableData.push([it.desc, it.qty, '$' + Math.round(it.total).toLocaleString('es-MX'), '']);
                    });
                }
                if (c.vidrioCost > 0) {
                    tableData.push(['Vidrio (cotizacion externa)', '', '$' + Math.round(c.vidrioCost).toLocaleString('es-MX'), '']);
                }
                if (c.paintCost > 0) {
                    EP.modules.forEach(function(m2, mi2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'est'
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                tableData.push(['Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' Mod ' + (mi2 + 1) + ' (' + lit.toFixed(1) + 'L)', '', '$' + Math.round(lit * m2.paint.pricePerLiter).toLocaleString('es-MX'), '']);
                        }
                    });
                }
                tableData.push([{
                    content: 'Subtotal extras',
                    styles: {
                        fontStyle: 'bold'
                    }
                }, '', '$' + Math.round(c.extraCost).toLocaleString('es-MX'), '']);
            }
            doc.autoTable({
                startY: y,
                margin: {
                    left: margin,
                    right: margin
                },
                head: [['Concepto', 'Cant.', 'Costo', '']],
                body: tableData,
                headStyles: {
                    fillColor: dark,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                bodyStyles: {
                    fontSize: 8,
                    textColor: dark
                },
                columnStyles: {
                    0: {
                        cellWidth: 80
                    },
                    1: {
                        cellWidth: 25
                    },
                    2: {
                        cellWidth: 35,
                        halign: 'right'
                    },
                    3: {
                        cellWidth: 35,
                        halign: 'right'
                    }
                },
                alternateRowStyles: {
                    fillColor: [250, 248, 245]
                }
            });
            y = doc.lastAutoTable.finalY + 8;
            // Summary box
            if (y > 230) {
                doc.addPage();
                y = margin;
            }
            doc.setFillColor(245, 240, 235);
            doc.rect(margin, y, pw - margin * 2, 46, 'F');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('RESUMEN DE RENTABILIDAD', margin + 5, y + 7);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Costo total:', margin + 5, y + 15);
            doc.text('$' + Math.round(c.totalCost).toLocaleString('es-MX'), margin + 70, y + 15);
            doc.text('Carp. x' + CONFIG.pricing.carpentryMultiplier + ' + HW ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%:', margin + 5, y + 21);
            doc.text('$' + Math.round(c.carpSale).toLocaleString('es-MX') + ' + $' + Math.round(c.hwPremiumSale || 0).toLocaleString('es-MX'), margin + 70, y + 21);
            doc.text('Precio venta:', margin + 5, y + 27);
            doc.text('$' + Math.round(c.subtotal).toLocaleString('es-MX'), margin + 70, y + 27);
            doc.text('Utilidad bruta:', margin + 5, y + 33);
            doc.text('$' + Math.round(c.profit).toLocaleString('es-MX'), margin + 70, y + 33);
            doc.setFont('helvetica', 'bold');
            doc.text('Margen real:', margin + 5, y + 39);
            doc.text(c.margin + '%', margin + 70, y + 39);
            // Plano page
            addPlanoPage(doc, margin);
            var fname = (d.quoteNum || CONFIG.quoting.prefix) + '-Desglose-' + (d.client || EP.client || 'Interno').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
        }

        function genDespiece() {
            if (typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                P = S.project,
                c = calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            var blue = [30, 58, 95];
            var pw = 215.9,
                margin = 15;
            var y = margin;
            // Header
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text(br.name + ' - DESPIECE / LISTA DE CORTE', margin, y + 5);
            y += 10;
            // Blue banner
            doc.setFillColor(blue[0], blue[1], blue[2]);
            doc.rect(margin, y, pw - margin * 2, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('DOCUMENTO PARA PROVEEDOR / TALLER  NO INCLUYE PRECIOS DE VENTA', pw / 2, y + 5, {
                align: 'center'
            });
            y += 11;
            doc.setTextColor(dark[0], dark[1], dark[2]);
            // Info row
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            var qnum = d ? d.quoteNum : getQuoteNum();
            doc.text(qnum + ' | ' + fmtDatePDF() + ' | Cliente: ' + (d && d.client ? d.client : P.client || ''), margin, y);
            y += 5;
            doc.text('Proyecto: ' + (d && d.projectName ? d.projectName : ''), margin, y);
            y += 6;
            // Material info
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('MATERIALES', margin, y);
            y += 5;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Frentes: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + (P.matFrentes.finish ? ' (' + P.matFrentes.finish + ')' : ''), margin, y);
            y += 4;
            if (c.useDual) {
                doc.text('Interior: ' + P.matInterior.brand + ' ' + P.matInterior.name + (P.matInterior.finish ? ' (' + P.matInterior.finish + ')' : ''), margin, y);
                y += 4;
            }
            if (P.chapSpec) {
                doc.text('Chapacanto: ' + P.chapSpec, margin, y);
                y += 4;
            }
            y += 2;
            // Sheet summary
            doc.setFillColor(240, 238, 233);
            doc.rect(margin, y, pw - margin * 2, c.useDual ? 22 : 14, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            var sx = margin + 3;
            doc.text('RESUMEN HOJAS: ' + c.totalSheets + ' hojas | CANTO: ' + c.totalCanto + ' ml', sx, y + 5);
            if (c.useDual) {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var pTK = c.projThickness || 16;
                var fLine = 'FRENTES: ' + pTK + 'mm=' + c.totalSheetsF + ' | Canto: ' + c.cantoF + ' ml';
                doc.text(fLine, sx, y + 10);
                var iLine = 'INTERIOR: ' + pTK + 'mm=' + c.totalSheetsI + ' | Canto: ' + c.cantoI + ' ml';
                doc.text(iLine, sx, y + 15);
                y += 25;
            } else {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var pTK2 = c.projThickness || 16;
                var sAllSheets = c.totalSheetsF + c.totalSheetsI;
                var aLine = pTK2 + 'mm: ' + sAllSheets + ' hojas  ';
                doc.text(aLine, sx, y + 10);
                y += 17;
            }
            // Cut list table per module
            P.modules.forEach(function(m) {
                var pcs = c.pieces.filter(function(p) {
                    return p.mid === m.id;
                });
                if (pcs.length === 0)
                    return;
                // Check page space
                if (y > 240) {
                    doc.addPage();
                    y = margin;
                }
                // Module header
                doc.setFillColor(accent[0], accent[1], accent[2]);
                doc.rect(margin, y, pw - margin * 2, 6, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                var mHdr = m.name + '  ' + m.width + ' cm';
                if (m.height)
                    mHdr += ' x ' + m.height + ' cm';
                doc.text(mHdr, margin + 3, y + 4.3);
                y += 8;
                doc.setTextColor(dark[0], dark[1], dark[2]);
                // Pieces table  ancho x largo format with edits applied
                var tData = [];
                pcs.sort(function(a, b) {
                    var alA = anchoLargo(a.w, a.h),
                        alB = anchoLargo(b.w, b.h);
                    return alB.largo - alA.largo;
                });
                pcs.forEach(function(p) {
                    var al = anchoLargo(p.w, p.h);
                    var eKey = m.id + ':' + p.n;
                    var ep = S.editedPieces[eKey] || {};
                    var eq = typeof ep.q === 'number' ? ep.q : p.q;
                    var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                    var el2 = typeof ep.largo === 'number' ? ep.largo : al.largo;
                    var row = [p.n, String(eq), String(ea), String(el2), p.t + 'mm'];
                    if (c.useDual)
                        row.push(p.z === 'f' ? 'FRENTE' : 'INTERIOR');
                    tData.push(row);
                });
                var cols = c.useDual ? ['Pieza', 'Cant.', 'Ancho (mm)', 'Largo (mm)', 'Espesor', 'Zona'] : ['Pieza', 'Cant.', 'Ancho (mm)', 'Largo (mm)', 'Espesor'];
                doc.autoTable({
                    startY: y,
                    margin: {
                        left: margin,
                        right: margin
                    },
                    head: [cols],
                    body: tData,
                    headStyles: {
                        fillColor: [80, 80, 80],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: dark
                    },
                    alternateRowStyles: {
                        fillColor: [250, 248, 245]
                    },
                    columnStyles: c.useDual ? {
                        0: {
                            cellWidth: 40
                        },
                        1: {
                            cellWidth: 13
                        },
                        2: {
                            cellWidth: 25
                        },
                        3: {
                            cellWidth: 25
                        },
                        4: {
                            cellWidth: 18
                        },
                        5: {
                            cellWidth: 22
                        }
                    } : {
                        0: {
                            cellWidth: 50
                        },
                        1: {
                            cellWidth: 15
                        },
                        2: {
                            cellWidth: 28
                        },
                        3: {
                            cellWidth: 28
                        },
                        4: {
                            cellWidth: 20
                        }
                    },
                    theme: 'grid',
                    styles: {
                        cellPadding: 1.5,
                        lineWidth: 0.2,
                        lineColor: [180, 180, 180]
                    }
                });
                y = doc.lastAutoTable.finalY + 4;
            });
            // Hardware list
            if (y > 230) {
                doc.addPage();
                y = margin;
            }
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('HERRAJES', margin, y + 4);
            y += 7;
            var hwData = [];
            c.allHW.forEach(function(hw) {
                hwData.push([hw.desc, hw.marca, String(Math.ceil(hw.qty))]);
            });
            if (hwData.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: {
                        left: margin,
                        right: margin
                    },
                    head: [['Herraje', 'Marca', 'Cantidad']],
                    body: hwData,
                    headStyles: {
                        fillColor: [80, 80, 80],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: dark
                    },
                    alternateRowStyles: {
                        fillColor: [250, 248, 245]
                    },
                    columnStyles: {
                        0: {
                            cellWidth: 90
                        },
                        1: {
                            cellWidth: 30
                        },
                        2: {
                            cellWidth: 20
                        }
                    },
                    theme: 'grid',
                    styles: {
                        cellPadding: 1.5,
                        lineWidth: 0.2,
                        lineColor: [180, 180, 180]
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            } else {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('(Sin herrajes registrados)', margin, y);
                y += 6;
            }
            // Extras
            var dLedBOM = calcLedBOM();
            if (dLedBOM || P.glass) {
                if (y > 250) {
                    doc.addPage();
                    y = margin;
                }
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('EXTRAS', margin, y);
                y += 5;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                if (dLedBOM) {
                    doc.text('LED - ' + dLedBOM.totalMeters.toFixed(1) + 'm total, ' + dLedBOM.totalSegments + ' segmentos, ' + dLedBOM.alimentadorW + 'W', margin, y);
                    y += 4;
                    dLedBOM.items.forEach(function(it) {
                        doc.text('  ' + it.qty + 'x ' + it.desc, margin, y);
                        y += 3.5;
                    });
                    y += 1;
                }
                if (P.glass) {
                    doc.text('- Vidrio templado: ' + P.glassM2 + ' m2', margin, y);
                    y += 4;
                }
            }
            // Footer
            if (y > 255) {
                doc.addPage();
                y = margin;
            }
            y += 4;
            doc.setDrawColor(180, 180, 180);
            doc.line(margin, y, pw - margin, y);
            y += 5;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(120, 120, 120);
            doc.text('Generado por ' + br.name + ' | ' + CONTACT.name + ' | ' + CONTACT.cell + ' | ' + CONTACT.email, margin, y);
            // Save
            var fname = qnum + '-Despiece-' + (d && d.client ? d.client : 'Proveedor').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
        }

        // === V2.3: Estandarizado Render Functions ===
        function renderEstStepDots() {
            var steps = ['builder', 'editor', 'material', 'summary'];
            var labels = ['1', '2', '3', '4'];
            var ci = steps.indexOf(S.estScreen);
            var h = '<div class="est-step-dots">';
            steps.forEach(function(s, i) {
                var cls = i === ci ? 'active' : i < ci ? 'done' : 'future';
                h += '<button class="est-step-dot ' + cls + '" onclick="APP.estGoStep(\'' + s + '\')">' + labels[i] + '</button>';
                if (i < steps.length - 1)
                    h += '<div class="est-step-line' + (i < ci ? ' done' : '') + '"></div>';
            });
            h += '</div>';
            return h;
        }

        function renderEstSilhouette(m) {
            var mH = estModHeight(m);
            var h = '<div class="est-silhouette' + (m.type === 'esquinero' ? ' est-sil-esq' : '') + '">';
            var malS = m.maletero || {
                enabled: false
            };
            if (malS.enabled)
                h += '<div class="est-sil-zone est-sil-maletero" style="height:6px"></div>';
            if (m.type === 'panelTV') {
                h += '<div class="est-sil-zone" style="height:60px;background:linear-gradient(180deg,#555,#333);display:flex;align-items:center;justify-content:center;font-size:10px;color:#aaa">TV</div>';
            } else {
                m.zones.forEach(function(z) {
                    var zh = getEstZoneDisplayHeight(m, z);
                    var pct = mH > 0 ? Math.max(4, Math.round(zh / mH * 70)) : 10;
                    h += '<div class="est-sil-zone est-sil-' + z.type + '" style="height:' + pct + 'px"></div>';
                });
            }
            var zoc = m.zoclo || {
                enabled: false
            };
            if (zoc.enabled)
                h += '<div class="est-sil-zone est-sil-zoclo" style="height:6px"></div>';
            h += '</div>';
            return h;
        }

        function renderEstBuilder() {
            var EP = S.estProject;
            var isCustom = EP.mode === 'custom';
            var titleText = isCustom ? 'Nuevo Proyecto' : 'Closet Estandarizado';
            var subtitleText = isCustom ? 'Configura los m\u00f3dulos del proyecto' : 'Configura los m\u00f3dulos del closet';
            var h = '<div class="title"><h2>' + titleText + '</h2><p>' + subtitleText + '</p></div>';
            h += '<div class="field"><label>Nombre del Cliente</label><input type="text" id="estClient" value="' + EP.client + '" placeholder="Ej: Juan P\u00e9rez" oninput="APP.estSetClient(this.value)"></div>';
            if (isCustom) {
                // Project type selector
                h += '<div class="field"><label>Tipo de Proyecto</label><div style="display:flex;gap:8px;flex-wrap:wrap">';
                TYPES.forEach(function(t) {
                    var sel = EP.projectType === t.id;
                    h += '<button style="flex:1;min-width:80px;padding:10px 8px;border-radius:12px;border:2px solid ' + (sel ? '#c49a6c' : '#3a3a3a') + ';background:' + (sel ? '#c49a6c22' : '#2a2a2a') + ';color:' + (sel ? '#c49a6c' : '#999') + ';cursor:pointer;font-size:13px;text-align:center" onclick="APP.estSetProjectType(\'' + t.id + '\')">' + t.i + '<br>' + t.n + '</button>';
                });
                h += '</div></div>';
                // Depth toggle
                h += '<div class="field"><label>Profundidad</label>';
                h += '<div class="mat-toggle-row" style="margin-bottom:8px"><span>Misma profundidad para todos</span><button class="toggle' + (EP.sameDepth ? ' on' : '') + '" onclick="APP.estTogSameDepth()"></button></div>';
                if (EP.sameDepth) {
                    h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + EP.projectDepth + '" min="20" max="120" step="1" style="width:100px" onchange="APP.estSetProjectDepth(parseInt(this.value))"><span style="color:#bbb">cm  general para todo el proyecto</span></div>';
                } else {
                    h += '<p class="hint">Cada m\u00f3dulo tendr\u00e1 su propia profundidad editable</p>';
                }
                h += '</div>';
            }
            if (EP.modules.length === 0) {
                h += '<div class="empty" style="margin:16px 0">' + svg('pkg') + '<p>Agrega m\u00f3dulos para comenzar</p></div>';
            } else {
                h += '<div class="est-modules-row">';
                EP.modules.forEach(function(m, i) {
                    var typeLabel = m.type === 'esquinero' ? 'Esquinero' : m.type === 'especial' ? 'Especial' : m.type === 'fijo' ? 'Fijo' : m.type === 'panelTV' ? 'Panel TV' : m.type === 'torreLateral' ? 'Torre Lat.' : m.type === 'alacenaAlta' ? 'Alacena' : m.type === 'gabineteBase' ? 'Gab. Base' : m.type === 'cajonBase' ? 'Caj\u00f3n Base' : m.type === 'despensa' ? 'Despensa' : m.type === 'puerta' ? 'Puerta' : m.zones.length + ' zona' + (m.zones.length !== 1 ? 's' : '');
                    h += '<div class="est-mod-card" onclick="APP.estEditMod(' + i + ')">';
                    h += '<button class="est-mod-del" onclick="event.stopPropagation();APP.estDelMod(' + i + ')">&times;</button>';
                    h += '<div class="est-mod-num">' + (i + 1) + '</div>';
                    h += renderEstSilhouette(m);
                    h += '<div class="est-mod-w">' + (m.type === 'esquinero' ? m.width + '\u00d7' + (m.width2 || m.width) : m.width) + 'cm</div>';
                    if (isCustom) {
                        h += '<div class="est-mod-type" style="font-size:11px;color:#60a5fa">' + m.height + 'cm alto</div>';
                        if (!EP.sameDepth)
                            h += '<div class="est-mod-type" style="font-size:11px;color:#9ca3af">' + (m.depth || EP.projectDepth) + 'cm prof</div>';
                    }
                    h += '<div class="est-mod-type">' + typeLabel + '</div>';
                    h += '<div class="est-mod-arrows">';
                    if (i > 0)
                        h += '<button onclick="event.stopPropagation();APP.estMoveMod(' + i + ',-1)">&larr;</button>';
                    if (i < EP.modules.length - 1)
                        h += '<button onclick="event.stopPropagation();APP.estMoveMod(' + i + ',1)">&rarr;</button>';
                    h += '</div></div>';
                });
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'normal\')">' + svg('plus') + 'M\u00f3dulo</button>';
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'esquinero\')">' + svg('plus') + 'Esquinero</button>';
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'especial\')">' + svg('plus') + 'Especial</button>';
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'fijo\')">' + svg('plus') + 'Fijo</button>';
                if (isCustom) {
                    h += '<button class="est-add-btn" onclick="APP.estAddMod(\'panelTV\')">' + svg('plus') + 'Panel TV</button>';
                    h += '<button class="est-add-btn" onclick="APP.estAddMod(\'torreLateral\')">' + svg('plus') + 'Torre Lat.</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'alacenaAlta\')">' + svg('plus') + 'Alacena Alta</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'gabineteBase\')">' + svg('plus') + 'Gab. Base</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'cajonBase\')">' + svg('plus') + 'Caj\u00f3n Base</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'despensa\')">' + svg('plus') + 'Despensa</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'puerta\')">' + svg('plus') + 'Puerta</button>';
                }
                h += '</div>';
                var tw = EP.modules.reduce(function(a, m2) {
                    return a + m2.width;
                }, 0);
                h += '<div class="est-total-bar"><span>Ancho Total:</span><strong>' + tw + ' cm (' + (tw / 100).toFixed(2) + 'm)</strong></div>';
                h += '<button class="est-dup-btn" onclick="APP.estDuplicateModules()">' + svg('copy') + ' Duplicar Closet (x2)</button>';
            }
            if (EP.modules.length === 0) {
                h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin:16px 0">';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'normal\')">' + svg('plus') + 'M\u00f3dulo</button>';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'esquinero\')">' + svg('plus') + 'Esquinero</button>';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'especial\')">' + svg('plus') + 'Especial</button>';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'fijo\')">' + svg('plus') + 'Fijo</button>';
                if (isCustom) {
                    h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'panelTV\')">' + svg('plus') + 'Panel TV</button>';
                    h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'torreLateral\')">' + svg('plus') + 'Torre Lat.</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'alacenaAlta\')">' + svg('plus') + 'Alacena Alta</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'gabineteBase\')">' + svg('plus') + 'Gab. Base</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'cajonBase\')">' + svg('plus') + 'Caj\u00f3n Base</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'despensa\')">' + svg('plus') + 'Despensa</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'puerta\')">' + svg('plus') + 'Puerta</button>';
                }
                h += '</div>';
            }
            return h;
        }

        function renderEstEditor() {
            var EP = S.estProject,
                idx = S.estEditIdx;
            if (idx < 0 || idx >= EP.modules.length)
                return '<p>Error: m\u00f3dulo no encontrado</p>';
            var m = EP.modules[idx];
            var isEsq = m.type === 'esquinero';
            var isEsp = m.type === 'especial';
            var isFijo = m.type === 'fijo';
            var isPanelTV = m.type === 'panelTV';
            var isTorre = m.type === 'torreLateral';
            var isAlacena = m.type === 'alacenaAlta';
            var isGabBase = m.type === 'gabineteBase';
            var isCajBase = m.type === 'cajonBase';
            var isDespensa = m.type === 'despensa';
            var isPuerta = m.type === 'puerta';
            var isCustom = EP.mode === 'custom';
            var typeNames = { esquinero: 'Esquinero', especial: 'Especial', fijo: 'Fijo', panelTV: 'Panel TV', torreLateral: 'Torre Lateral', alacenaAlta: 'Alacena Alta', gabineteBase: 'Gabinete Base', cajonBase: 'Caj\u00f3n Base', despensa: 'Despensa', puerta: 'Puerta' };
            var typeSuffix = typeNames[m.type] ? ' (' + typeNames[m.type] + ')' : '';
            var h = '<div class="title"><h2>M\u00f3dulo ' + (idx + 1) + typeSuffix + '</h2></div>';
            // fijo: just ancho + alto, nothing else
            if (isFijo) {
                h += '<div class="field"><label>Ancho</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + m.width + '" min="5" max="300" step="1" style="width:80px" onchange="APP.estSetWidth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div></div>';
                h += '<div class="field"><label>Alto</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + m.height + '" min="5" max="300" step="1" style="width:80px" onchange="APP.estSetModHeight(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div></div>';
                h += '<div class="field"><p style="color:#999;font-size:14px">L\u00e1mina para tapar pijas \u2014 ' + m.width + 'cm \u00d7 ' + m.height + 'cm</p></div>';
                return h;
            }
            // Height selector (custom mode only)
            if (isCustom) {
                h += '<div class="field"><label>Alto del m\u00f3dulo</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + m.height + '" min="50" max="300" step="1" style="width:80px" onchange="APP.estSetModHeight(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div></div>';
            }
            // Per-module depth (when sameDepth is off)
            if (isCustom && !EP.sameDepth) {
                h += '<div class="field"><label>Profundidad</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + (m.depth || EP.projectDepth) + '" min="20" max="120" step="1" style="width:80px" onchange="APP.estSetModDepth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div></div>';
            }
            // Width selector
            if (isPanelTV || isTorre || isEsp || isAlacena || isGabBase || isCajBase || isDespensa || isPuerta) {
                h += '<div class="field"><label>Ancho (libre)</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + m.width + '" min="10" max="300" step="1" style="width:80px" onchange="APP.estSetWidth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div>';
                if (isPanelTV)
                    h += '<p class="hint">Panel decorativo para TV</p>';
                else if (isTorre)
                    h += '<p class="hint">Torre lateral angosta</p>';
                else
                    h += '<p class="hint">Medida libre para espacios no est\u00e1ndar</p>';
                h += '</div>';
            } else if (!isEsq && !isFijo) {
                var isCustomW = EST_WIDTHS.indexOf(m.width) === -1;
                h += '<div class="field"><label>Ancho</label><div style="display:flex;gap:8px;flex-wrap:wrap">';
                EST_WIDTHS.forEach(function(w) {
                    h += '<button class="opt-btn' + (m.width === w ? ' sel' : '') + '" onclick="APP.estSetWidth(' + idx + ',' + w + ')">' + w + 'cm</button>';
                });
                h += '<button class="opt-btn' + (isCustomW ? ' sel' : '') + '" onclick="APP.estSetCustomWidth(' + idx + ')">Otro</button>';
                h += '</div>';
                if (isCustomW) {
                    h += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input type="number" value="' + m.width + '" min="30" max="120" step="1" style="width:80px" onchange="APP.estSetWidth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div>';
                }
                h += '</div>';
            } else {
                var w2 = m.width2 || m.width;
                h += '<div class="field"><label>Dimensiones (L-shape)</label>';
                h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="color:#bbb;min-width:50px">Lado A:</span><input type="number" value="' + m.width + '" min="30" max="150" step="5" style="width:80px" onchange="APP.estSetWidth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div>';
                h += '<div style="display:flex;align-items:center;gap:8px"><span style="color:#bbb;min-width:50px">Lado B:</span><input type="number" value="' + w2 + '" min="30" max="150" step="5" style="width:80px" onchange="APP.estSetWidth2(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div>';
                h += '<p class="hint">Esquinero en L &mdash; ' + m.width + 'cm &times; ' + w2 + 'cm &times; ' + estProjDepth() + 'cm prof.</p></div>';
            }
            // panelTV has no zones
            if (isPanelTV) {
                h += '<div class="field"><p style="color:#999;font-size:14px">Panel plano \u2014 sin zonas internas. Incluye panel, travesa\u00f1os y fondo.</p></div>';
                h += renderEstHeightBar(m, idx);
                return h;
            }
            // puerta has no zones  just panel + optional marco
            if (isPuerta) {
                h += '<div class="field"><label>Marco</label>';
                h += '<div class="mat-toggle-row"><span>Incluir marco</span><button class="toggle' + (m.marco ? ' on' : '') + '" onclick="APP.estTogMarco(' + idx + ')"></button></div>';
                h += '<p class="hint">Puerta: ' + m.width + 'cm \u00d7 ' + m.height + 'cm' + (m.marco ? ' + marco' : '') + '</p></div>';
                h += renderEstHeightBar(m, idx);
                return h;
            }
            // Zone stack (rendered bottom to top)
            h += '<div class="field"><label>Zonas (de abajo a arriba)</label>';
            for (var ri = m.zones.length - 1; ri >= 0; ri--) {
                var z = m.zones[ri],
                    zi = ri;
                var zt = EST_ZONE_TYPES.find(function(x) {
                    return x.id === z.type;
                });
                h += '<div class="est-zone">';
                h += '<div class="est-zone-hdr"><strong>' + (zt ? zt.n : z.type) + '</strong>';
                h += '<div class="est-zone-actions">';
                if (zi < m.zones.length - 1)
                    h += '<button onclick="APP.estMoveZone(' + idx + ',' + zi + ',1)">&uarr;</button>';
                if (zi > 0)
                    h += '<button onclick="APP.estMoveZone(' + idx + ',' + zi + ',-1)">&darr;</button>';
                h += '<button class="del" onclick="APP.estDelZone(' + idx + ',' + zi + ')">&times;</button>';
                h += '</div></div>';
                if (z.type === 'cajones') {
                    h += '<div class="est-zone-row"><span>Cantidad:</span><div style="display:flex;gap:6px">';
                    for (var n = 1; n <= 7; n++) {
                        h += '<button class="opt-btn' + ((z.count || 3) === n ? ' sel' : '') + '" onclick="APP.estSetZoneCount(' + idx + ',' + zi + ',' + n + ')">' + n + '</button>';
                    }
                    h += '</div></div>';
                    h += '<div class="est-zone-row"><span>Alto c/u:</span><select class="mat-select" style="width:auto;padding:8px" onchange="APP.estSetZoneHeight(' + idx + ',' + zi + ',parseInt(this.value))">';
                    EST_CAJON_HEIGHTS.forEach(function(ch) {
                        h += '<option value="' + ch + '"' + ((z.cajonHeight || 20) === ch ? ' selected' : '') + '>' + ch + ' cm</option>';
                    });
                    h += '</select></div>';
                } else if (z.type === 'colgador') {
                    var colgH = calcEstColgadorHeight(m, z);
                    h += '<div class="est-zone-row"><span>Tubo:</span><span style="color:#60a5fa">1 (sencillo)</span></div>';
                    h += '<div style="font-size:12px;color:#60a5fa;padding:4px 0">Altura auto: ' + colgH + ' cm (llena espacio restante)</div>';
                } else if (z.type === 'zapatero') {
                    h += '<div class="est-zone-row"><span>Cajones extra\u00edbles:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                    for (var n = 1; n <= 12; n++) {
                        h += '<button class="opt-btn' + ((z.repisas || 3) === n ? ' sel' : '') + '" onclick="APP.estSetZoneRepisas(' + idx + ',' + zi + ',' + n + ')">' + n + '</button>';
                    }
                    h += '</div></div>';
                    h += '<div class="est-zone-row"><span>Alto c/u:</span><select class="mat-select" style="width:auto;padding:8px" onchange="APP.estSetZoneRepisaHeight(' + idx + ',' + zi + ',parseInt(this.value))">';
                    EST_ZAPATERO_HEIGHTS.forEach(function(rh) {
                        h += '<option value="' + rh + '"' + ((z.repisaHeight || 15) === rh ? ' selected' : '') + '>' + rh + ' cm</option>';
                    });
                    h += '</select></div>';
                    h += '<div style="font-size:11px;color:#999;padding:2px 0">Frente visible: 5cm \u00b7 Resto abierto para zapatos</div>';
                } else if (z.type === 'entrepa') {
                    var maxE = isEsp ? 12 : 12;
                    h += '<div class="est-zone-row"><span>Cantidad:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                    for (var n = 1; n <= maxE; n++) {
                        h += '<button class="opt-btn' + ((z.count || 2) === n ? ' sel' : '') + '" onclick="APP.estSetZoneCount(' + idx + ',' + zi + ',' + n + ')">' + n + '</button>';
                    }
                    h += '</div></div>';
                    if (!isEsp) {
                        var entFree = calcEstFreeSpace(m);
                        if (entFree > 0) {
                            var entSecH = entFree / ((z.count || 2) + 1);
                            h += '<div style="font-size:12px;color:#60a5fa;padding:4px 0">Espacio libre: ' + entFree.toFixed(1) + ' cm \u00f7 ' + ((z.count || 2) + 1) + ' secciones = ' + entSecH.toFixed(1) + ' cm c/u (auto)</div>';
                        }
                    }
                }
                // Per-zone door toggle (only in por_zona mode)
                if ((m.doorMode || 'por_zona') === 'por_zona') {
                    h += '<div class="est-zone-row" style="margin-top:6px;border-top:1px solid #2a2a2a;padding-top:6px"><span>Puerta:</span>';
                    h += '<button class="opt-btn' + (z.doors ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoor(' + idx + ',' + zi + ',' + (!z.doors) + ')">' + svg(z.doors ? 'check' : 'plus') + ' Con puerta</button>';
                    h += '<button class="opt-btn' + (!z.doors ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoor(' + idx + ',' + zi + ',false)">Sin</button>';
                    h += '</div>';
                    if (z.doors) {
                        h += '<div class="est-zone-row"><span>Material:</span><div style="display:flex;gap:6px">';
                        h += '<button class="opt-btn' + ((z.doorMaterial || 'melamina') === 'melamina' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorMat(' + idx + ',' + zi + ',\'melamina\')">Melamina</button>';
                        h += '<button class="opt-btn' + ((z.doorMaterial || 'melamina') === 'vidrio' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorMat(' + idx + ',' + zi + ',\'vidrio\')">Vidrio</button>';
                        h += '</div></div>';
                        if ((z.doorMaterial || 'melamina') === 'vidrio') {
                            h += '<div class="est-zone-row"><span>Precio vidrio (cot. externa):</span><div style="display:flex;align-items:center;gap:6px">';
                            h += '<span style="color:#bbb">$</span><input type="number" value="' + (z.vidrioPrice || 0) + '" min="0" step="100" style="width:100px;font-size:13px" onchange="APP.estSetZoneVidrioPrice(' + idx + ',' + zi + ',parseFloat(this.value)||0)">';
                            h += '</div></div>';
                        }
                        h += '<div class="est-zone-row"><span>Apertura:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        h += '<button class="opt-btn' + ((z.doorType || 'tipon') === 'tipon' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorType(' + idx + ',' + zi + ',\'tipon\')">Push Tip-On</button>';
                        h += '<button class="opt-btn' + ((z.doorType || 'tipon') === 'jaladera' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorType(' + idx + ',' + zi + ',\'jaladera\')">Jaladera</button>';
                        h += '<button class="opt-btn' + ((z.doorType || 'tipon') === 'jaladera_int' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorType(' + idx + ',' + zi + ',\'jaladera_int\')">Jaladera Integrada</button>';
                        h += '</div></div>';
                    }
                }
                h += '</div>';
            }
            // Add zone buttons
            h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">';
            if (isEsp) {
                h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'entrepa\')">' + svg('plus') + ' Entrepa\u00f1os</button>';
                h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'colgador\')">' + svg('plus') + ' Colgador</button>';
            } else if (isEsq) {
                h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'entrepa\')">' + svg('plus') + ' Entrepa\u00f1os</button>';
                h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'colgador\')">' + svg('plus') + ' Colgador</button>';
            } else {
                EST_ZONE_TYPES.forEach(function(zt2) {
                    if (zt2.hidden)
                        return;
                    h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'' + zt2.id + '\')">' + svg('plus') + ' ' + zt2.n + '</button>';
                });
            }
            h += '</div></div>';
            // Height validation bar
            h += renderEstHeightBar(m, idx);
            // Puertas
            var dm = m.doorMode || 'por_zona';
            var qm = m.quoteMode || 'completo';
            h += '<div class="field"><label>Puertas</label>';
            h += '<div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">';
            h += '<button class="opt-btn' + (!m.doors && qm !== 'solo_puertas' ? ' sel' : '') + '" onclick="APP.estTogDoors(' + idx + ',false)">Sin puertas</button>';
            h += '<button class="opt-btn' + (m.doors && dm === 'completa' && qm !== 'solo_puertas' ? ' sel' : '') + '" onclick="APP.estSetQuoteMode(' + idx + ',\'completo\');APP.estTogDoors(' + idx + ',true,\'completa\')">Puerta completa</button>';
            h += '<button class="opt-btn' + (m.doors && dm === 'por_zona' && qm !== 'solo_puertas' ? ' sel' : '') + '" onclick="APP.estSetQuoteMode(' + idx + ',\'completo\');APP.estTogDoors(' + idx + ',true,\'por_zona\')">Puertas por zona</button>';
            h += '<button class="opt-btn' + (qm === 'solo_puertas' ? ' sel' : '') + '" style="' + (qm === 'solo_puertas' ? 'background:#fbbf24;color:#1a1a1a;border-color:#fbbf24' : '') + '" onclick="APP.estSetQuoteMode(' + idx + ',\'solo_puertas\')">Solo puertas</button>';
            h += '</div>';
            if (qm === 'solo_puertas') {
                h += '<div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:6px;padding:8px 12px;margin-bottom:8px;font-size:12px;color:#fbbf24">Solo puertas: la estructura no se cotiza</div>';
            }
            if (m.doors && dm === 'completa') {
                // Full-height door config
                var dCnt = m.doorCount || 2;
                var dMat = m.doorMaterial || 'melamina';
                var dType = m.doorType || 'tipon';
                var eu2 = estEspacioUtil();
                var doorH = Math.round(eu2);
                var doorW = Math.round((m.width / dCnt) * 10 - 3) / 10;
                h += '<div class="est-zone-row"><span>Cantidad:</span><div style="display:flex;gap:8px">';
                h += '<button class="opt-btn' + (dCnt === 1 ? ' sel' : '') + '" onclick="APP.estSetDoorCount(' + idx + ',1)">1 puerta</button>';
                h += '<button class="opt-btn' + (dCnt === 2 ? ' sel' : '') + '" onclick="APP.estSetDoorCount(' + idx + ',2)">2 puertas</button>';
                h += '</div></div>';
                h += '<div class="est-zone-row"><span>Material:</span><div style="display:flex;gap:6px">';
                h += '<button class="opt-btn' + (dMat === 'melamina' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorMat(' + idx + ',\'melamina\')">Melamina</button>';
                h += '<button class="opt-btn' + (dMat === 'vidrio' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorMat(' + idx + ',\'vidrio\')">Vidrio</button>';
                h += '</div></div>';
                if (dMat === 'vidrio') {
                    h += '<div class="est-zone-row"><span>Precio vidrio (cot. externa):</span><div style="display:flex;align-items:center;gap:6px">';
                    h += '<span style="color:#bbb">$</span><input type="number" value="' + (m.vidrioPrice || 0) + '" min="0" step="100" style="width:100px;font-size:13px" onchange="APP.estSetVidrioPrice(' + idx + ',parseFloat(this.value)||0)">';
                    h += '</div></div>';
                }
                h += '<div class="est-zone-row"><span>Apertura:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                h += '<button class="opt-btn' + (dType === 'tipon' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorType2(' + idx + ',\'tipon\')">Push Tip-On</button>';
                h += '<button class="opt-btn' + (dType === 'jaladera' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorType2(' + idx + ',\'jaladera\')">Jaladera</button>';
                h += '<button class="opt-btn' + (dType === 'jaladera_int' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorType2(' + idx + ',\'jaladera_int\')">Jaladera Integrada</button>';
                h += '</div></div>';
                h += '<div style="font-size:12px;color:#60a5fa;padding:4px 0">' + dCnt + ' puerta' + (dCnt > 1 ? 's' : '') + ' de ' + doorW + 'cm \u00d7 ' + doorH + 'cm (alto completo)</div>';
            } else if (m.doors && dm === 'por_zona') {
                h += '<div style="font-size:12px;color:#999;padding:4px 0">Configura las puertas en cada zona arriba</div>';
            }
            h += '</div>';
            // Chapacanto
            h += '<div class="field"><label>Enchapado</label>';
            var ch = m.chap || {
                mode: 'perimetrico',
                edges: {
                    latIzq: true,
                    latDer: true,
                    techo: true,
                    piso: true,
                    fondo: false
                }
            };
            h += '<div style="margin-bottom:8px"><button class="opt-btn' + (ch.mode === 'perimetrico' ? ' sel' : '') + '" onclick="APP.estSetChapMode(' + idx + ',\'perimetrico\')">' + svg(ch.mode === 'perimetrico' ? 'check' : 'plus') + ' Perim\u00e9trico (4 lados)</button></div>';
            h += '<div class="est-chap-grid">';
            [{
                k: 'latIzq',
                l: 'Lat. izq'
            }, {
                k: 'latDer',
                l: 'Lat. der'
            }, {
                k: 'techo',
                l: 'Techo'
            }, {
                k: 'piso',
                l: 'Piso'
            }, {
                k: 'fondo',
                l: 'Fondo'
            }].forEach(function(e) {
                h += '<button class="est-chap-edge' + (ch.edges[e.k] ? ' on' : '') + '" onclick="APP.estTogChapEdge(' + idx + ',\'' + e.k + '\')">' + e.l + '</button>';
            });
            h += '</div></div>';
            // Zoclo (baseboard)
            if (!m.zoclo)
                m.zoclo = {
                    enabled: false,
                    height: 10
                };
            var zoc = m.zoclo;
            h += '<div class="field"><label>Zoclo (z\u00f3calo)</label>';
            h += '<div style="display:flex;gap:8px;margin-bottom:8px">';
            h += '<button class="opt-btn' + (zoc.enabled ? ' sel' : '') + '" onclick="APP.estTogZoclo(' + idx + ')">' + svg(zoc.enabled ? 'check' : 'plus') + ' Con zoclo</button>';
            h += '<button class="opt-btn' + (!zoc.enabled ? ' sel' : '') + '" onclick="APP.estTogZoclo(' + idx + ')">Sin zoclo</button>';
            h += '</div>';
            if (zoc.enabled) {
                h += '<div class="est-zone-row"><span>Altura:</span><div style="display:flex;align-items:center;gap:6px">';
                h += '<input type="number" value="' + zoc.height + '" min="5" max="25" step="1" style="width:70px" onchange="APP.estSetZocloHeight(' + idx + ',parseInt(this.value))">';
                h += '<span style="color:#bbb">cm</span></div></div>';
                h += '<p class="hint">Prof. 55cm (arremetido 5cm) \u00b7 Ancho: ' + m.width + 'cm \u00b7 No consume espacio interior</p>';
            }
            h += '</div>';
            // Maletero (on top of module, outside height)
            if (!m.maletero)
                m.maletero = {
                    enabled: false,
                    height: 30
                };
            var mal = m.maletero;
            h += '<div class="field"><label>Maletero (encima del m\u00f3dulo)</label>';
            h += '<div style="display:flex;gap:8px;margin-bottom:8px">';
            h += '<button class="opt-btn' + (mal.enabled ? ' sel' : '') + '" onclick="APP.estTogMaletero(' + idx + ')">' + svg(mal.enabled ? 'check' : 'plus') + ' Con maletero</button>';
            h += '<button class="opt-btn' + (!mal.enabled ? ' sel' : '') + '" onclick="APP.estTogMaletero(' + idx + ')">Sin maletero</button>';
            h += '</div>';
            if (mal.enabled) {
                h += '<div class="est-zone-row"><span>Altura:</span><div style="display:flex;align-items:center;gap:6px">';
                h += '<input type="number" value="' + mal.height + '" min="10" max="100" step="5" style="width:70px" onchange="APP.estSetMaleteroHeight(' + idx + ',parseInt(this.value))">';
                h += '<span style="color:#bbb">cm</span></div></div>';
                h += '<p class="hint">Encima del m\u00f3dulo \u00b7 No consume altura interior \u00b7 Ajustar seg\u00fan distancia al techo</p>';
                // Maletero door
                h += '<div class="est-zone-row" style="margin-top:6px;border-top:1px solid #2a2a2a;padding-top:6px"><span>Puerta:</span>';
                h += '<button class="opt-btn' + (mal.doors ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoor(' + idx + ',' + (!mal.doors) + ')">' + svg(mal.doors ? 'check' : 'plus') + ' Con puerta</button>';
                h += '<button class="opt-btn' + (!mal.doors ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoor(' + idx + ',false)">Sin</button>';
                h += '</div>';
                if (mal.doors) {
                    h += '<div class="est-zone-row"><span>Material:</span><div style="display:flex;gap:6px">';
                    h += '<button class="opt-btn' + ((mal.doorMaterial || 'melamina') === 'melamina' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorMat(' + idx + ',\'melamina\')">Melamina</button>';
                    h += '<button class="opt-btn' + ((mal.doorMaterial || 'melamina') === 'vidrio' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorMat(' + idx + ',\'vidrio\')">Vidrio</button>';
                    h += '</div></div>';
                    if ((mal.doorMaterial || 'melamina') === 'vidrio') {
                        h += '<div class="est-zone-row"><span>Precio vidrio (cot. externa):</span><div style="display:flex;align-items:center;gap:6px">';
                        h += '<span style="color:#bbb">$</span><input type="number" value="' + (mal.vidrioPrice || 0) + '" min="0" step="100" style="width:100px;font-size:13px" onchange="APP.estSetMaleteroVidrioPrice(' + idx + ',parseFloat(this.value)||0)">';
                        h += '</div></div>';
                    }
                    h += '<div class="est-zone-row"><span>Apertura:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                    h += '<button class="opt-btn' + ((mal.doorType || 'tipon') === 'tipon' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorType(' + idx + ',\'tipon\')">Push Tip-On</button>';
                    h += '<button class="opt-btn' + ((mal.doorType || 'tipon') === 'jaladera' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorType(' + idx + ',\'jaladera\')">Jaladera</button>';
                    h += '<button class="opt-btn' + ((mal.doorType || 'tipon') === 'jaladera_int' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorType(' + idx + ',\'jaladera_int\')">Jaladera Integrada</button>';
                    h += '</div></div>';
                }
            }
            h += '</div>';
            // LED
            h += renderEstModuleLed(m, idx);
            h += renderEstModulePaint(m, idx);
            // Hardware preview (editable per-module)
            h += '<div class="field"><label>Herrajes (por m\u00f3dulo)</label>';
            var tempC = calcEstandarizado();
            var modHW = tempC.autoHW.filter(function(ah) {
                return ah.modId === m.id;
            });
            if (modHW.length > 0) {
                // Consolidate by key for this module
                var modHWConsol = {};
                modHW.forEach(function(ah) {
                    var def = HW_DEFAULTS[ah.key];
                    if (!def)
                        return;
                    if (!modHWConsol[ah.key])
                        modHWConsol[ah.key] = {
                            key: ah.key,
                            desc: def.desc,
                            autoQty: 0
                        };
                    modHWConsol[ah.key].autoQty += ah.q;
                });
                var mhwOv = m.hwOverrides || {};
                for (var hwk in modHWConsol) {
                    var mhw = modHWConsol[hwk];
                    var hasOv = typeof mhwOv[hwk] === 'number';
                    var dispQty = hasOv ? mhwOv[hwk] : mhw.autoQty;
                    h += '<div style="display:flex;align-items:center;gap:6px;padding:3px 0">';
                    h += '<span style="flex:1;font-size:13px;color:#bbb">' + mhw.desc + '</span>';
                    h += '<button style="width:24px;height:24px;border-radius:4px;border:1px solid #3a3a3a;background:#1a1a1a;color:#fff;font-size:14px;cursor:pointer" onclick="APP.estModHwQty(' + idx + ',\'' + hwk + '\',-1)">\u2212</button>';
                    h += '<input type="number" value="' + dispQty + '" min="0" style="width:48px;text-align:center;font-size:13px;color:#c49a6c;background:#1a1a1a;border:1px solid #3a3a3a;border-radius:4px;padding:2px" onchange="APP.estModHwQty(' + idx + ',\'' + hwk + '\',0,parseInt(this.value))">';
                    h += '<button style="width:24px;height:24px;border-radius:4px;border:1px solid #3a3a3a;background:#1a1a1a;color:#fff;font-size:14px;cursor:pointer" onclick="APP.estModHwQty(' + idx + ',\'' + hwk + '\',1)">+</button>';
                    if (hasOv) {
                        h += ' <span style="font-size:10px;color:#fbbf24">(editado)</span>';
                        h += ' <button style="font-size:10px;padding:1px 6px;border-radius:3px;border:1px solid #c49a6c;background:none;color:#c49a6c;cursor:pointer" onclick="APP.estModHwReset(' + idx + ',\'' + hwk + '\')">Restaurar</button>';
                    }
                    h += '</div>';
                }
            } else {
                h += '<p style="color:#999;font-size:13px">Sin herrajes autom\u00e1ticos</p>';
            }
            h += '<button class="hw-add-btn" onclick="APP.openHWPicker()" style="margin-top:6px;font-size:12px">' + svg('plus') + ' Agregar herraje</button>';
            h += '</div>';
            return h;
        }

        function renderEstHeightBar(m, idx) {
            var eu = estEspacioUtil(m);
            var mH = estModHeight(m);
            var tk = (S.estProject.thickness || 16) / 10;
            var fixed = calcEstFixedHeight(m);
            var hasColg = m.zones.some(function(z) {
                return z.type === 'colgador';
            });
            var freeSpace = eu - fixed;
            var barH = 220; // total bar height in px
            var h = '<div class="est-height-bar"><div class="est-vbar-wrap">';
            // === Vertical bar ===
            h += '<div class="est-vbar">';
            // Fijo: not shown in height bar (just a cover panel, not spatial)
            // Maletero segment (above techo, outside 2m)
            var malObj = m.maletero || {
                enabled: false,
                height: 30
            };
            if (malObj.enabled) {
                var malH = Math.max(6, (malObj.height || 30) / mH * barH);
                h += '<div class="est-vbar-seg maletero" style="height:' + malH + 'px" title="Maletero ' + (malObj.height || 30) + 'cm (encima)">&#x1f9f3;</div>';
            }
            // Techo segment
            var techoPct = tk / mH * barH;
            h += '<div class="est-vbar-seg techo" style="height:' + Math.max(6, techoPct) + 'px" title="Techo ' + tk + 'cm">T</div>';
            // Free space at top (if no colgador, no entrepa to distribute it, and positive)
            var isEsp = m.type === 'especial';
            var espHasColg2 = isEsp && hasColg;
            var isEspNoColg = isEsp && !hasColg;
            var hasEntrepa = m.zones.some(function(z) {
                return z.type === 'entrepa';
            });
            if (!isEspNoColg && !hasColg && !hasEntrepa && freeSpace > 0) {
                var freeH = Math.max(3, freeSpace / mH * barH);
                h += '<div class="est-vbar-seg libre" style="height:' + freeH + 'px;flex:1" title="Libre ' + freeSpace.toFixed(1) + 'cm"></div>';
            } else if (!isEspNoColg && !hasColg && !hasEntrepa && freeSpace < 0) {
                h += '<div class="est-vbar-seg exceso" style="height:12px" title="Excede"></div>';
            }
            // Zone segments (top to bottom)
            m.zones.forEach(function(z) {
                if (z.type === 'entrepa' && (isEspNoColg || (!hasColg && freeSpace > 0))) {
                    // Entrepaos divide free space (or full space for especial w/o colgador) into cnt+1 equal sections
                    var cnt = z.count || 2;
                    var sections = cnt + 1;
                    var spaceForEnt = isEspNoColg ? eu : freeSpace;
                    var totalBarSpace = (spaceForEnt / mH) * barH;
                    var entH = 3; // entrepao line height in px
                    var sectionPx = Math.max(4, (totalBarSpace - cnt * entH) / sections);
                    for (var si = 0; si < sections; si++) {
                        h += '<div class="est-vbar-seg libre" style="height:' + Math.round(sectionPx) + 'px" title="Secci\u00f3n ' + (si + 1) + '"></div>';
                        if (si < sections - 1) {
                            h += '<div class="est-vbar-seg entrepa" style="height:' + entH + 'px" title="Entrepa\u00f1o ' + (si + 1) + '"></div>';
                        }
                    }
                } else if (z.type === 'zapatero') {
                    // Zapatero: show individual cajn extrable divisions
                    var zapCnt = z.repisas || 3;
                    var zapUnitH = (z.repisaHeight || 15);
                    var zapTotalH = zapCnt * zapUnitH;
                    var zapBarH = Math.max(8, zapTotalH / mH * barH);
                    var zapUnitPx = Math.max(6, zapBarH / zapCnt);
                    var zapGap = 1;
                    for (var zi2 = 0; zi2 < zapCnt; zi2++) {
                        h += '<div class="est-vbar-seg zapatero" style="height:' + Math.max(4, zapUnitPx - zapGap) + 'px;margin-bottom:' + zapGap + 'px;font-size:8px" title="Caj\u00f3n ext. ' + (zi2 + 1) + ' (' + zapUnitH + 'cm)">Z</div>';
                    }
                } else {
                    var zh = getEstZoneDisplayHeight(m, z);
                    var segH = Math.max(3, zh / mH * barH);
                    var cls = z.type;
                    var label = '';
                    if (z.type === 'cajones')
                        label = (z.count || 1) + 'C';
                    else if (z.type === 'colgador')
                        label = '1T';
                    else if (z.type === 'zapatero')
                        label = (z.repisas || 3) + 'Z';
                    else if (z.type === 'entrepa')
                        label = (z.count || 2) + 'E';
                    h += '<div class="est-vbar-seg ' + cls + '" style="height:' + segH + 'px" title="' + zh.toFixed(1) + 'cm">' + label + '</div>';
                }
            });
            // Piso segment
            h += '<div class="est-vbar-seg piso" style="height:' + Math.max(6, techoPct) + 'px" title="Piso ' + tk + 'cm">P</div>';
            // Zoclo segment (below piso, outside 2m interior)
            var zoc = m.zoclo || {
                enabled: false,
                height: 10
            };
            if (zoc.enabled) {
                var zocH = Math.max(6, (zoc.height || 10) / mH * barH);
                h += '<div class="est-vbar-seg zoclo" style="height:' + zocH + 'px" title="Zoclo ' + (zoc.height || 10) + 'cm (arremetido)">Z</div>';
            }
            h += '</div>';
            // === Info panel ===
            h += '<div class="est-vbar-info">';
            h += '<div class="est-vbar-row"><span>Espacio \u00fatil:</span><strong>' + eu.toFixed(1) + ' cm</strong></div>';
            h += '<div class="est-vbar-row"><span>Estructura (techo+piso):</span><span>' + ((tk * 2).toFixed(1)) + ' cm</span></div>';
            m.zones.forEach(function(z) {
                var zt = EST_ZONE_TYPES.find(function(x) {
                    return x.id === z.type;
                });
                var zh = getEstZoneDisplayHeight(m, z);
                var label = (zt ? zt.n : z.type) + ': ';
                if (z.type === 'colgador')
                    label += zh.toFixed(0) + ' cm (auto)';
                else if (z.type === 'zapatero')
                    label += (z.repisas || 3) + ' cajones ext. \u00d7 ' + (z.repisaHeight || 15) + 'cm = ' + zh.toFixed(1) + ' cm (frente 5cm)';
                else if (z.type === 'entrepa') {
                    var entCnt2 = z.count || 2;
                    var entSpace = (isEsp && !hasColg) ? eu : freeSpace;
                    if (entSpace > 0) {
                        var secH2 = entSpace / (entCnt2 + 1);
                        label += entCnt2 + ' entrepa\u00f1os \u00f7 ' + entSpace.toFixed(1) + ' cm' + ((isEsp && !hasColg) ? '' : ' libre') + ' = ' + secH2.toFixed(1) + ' cm c/secci\u00f3n';
                    } else {
                        label += zh.toFixed(1) + ' cm';
                    }
                }
                else
                    label += zh.toFixed(1) + ' cm';
                h += '<div class="est-vbar-row"><span>' + label + '</span><span>' + Math.round(zh / eu * 100) + '%</span></div>';
            });
            if (!isEsp && m.zones.length > 1) {
                var divH = (m.zones.length - 1) * tk;
                h += '<div class="est-vbar-row" style="color:#666"><span>Divisiones internas:</span><span>' + divH.toFixed(1) + ' cm</span></div>';
            }
            if (isEsp || hasEntrepa) {
                h += '<div class="est-vbar-row" style="color:#4ade80"><span>Estado:</span><strong>Auto-distribuido</strong></div>';
            } else if (hasColg) {
                var colgH = calcEstColgadorHeight(m, m.zones.find(function(z) {
                    return z.type === 'colgador';
                }));
                h += '<div class="est-vbar-row" style="color:#4ade80"><span>Estado:</span><strong>Auto-ajustado</strong></div>';
                // Colgador warnings
                if (colgH < 50)
                    h += '<div class="est-vbar-warn red">\u26a0\ufe0f Espacio insuficiente para colgador (' + colgH + ' cm)</div>';
                else if (colgH < 80)
                    h += '<div class="est-vbar-warn yellow">\u26a0\ufe0f Colgador corto (' + colgH + ' cm)</div>';
            } else {
                if (freeSpace > 0) {
                    h += '<div class="est-vbar-row" style="color:#fbbf24"><span>Espacio libre:</span><strong>' + freeSpace.toFixed(1) + ' cm</strong></div>';
                } else if (freeSpace < 0) {
                    h += '<div class="est-vbar-warn red">\ud83d\udd34 Las zonas exceden el espacio disponible por ' + (-freeSpace).toFixed(1) + ' cm</div>';
                } else {
                    h += '<div class="est-vbar-row" style="color:#4ade80"><span>Estado:</span><strong>Ajuste perfecto</strong></div>';
                }
            }
            if (zoc.enabled) {
                h += '<div class="est-vbar-row" style="color:#8b5c3c"><span>Zoclo (fuera del m\u00f3dulo):</span><span>' + (zoc.height || 10) + ' cm \u00b7 55cm prof.</span></div>';
            }
            var malInfo = m.maletero || {
                enabled: false,
                height: 30
            };
            if (malInfo.enabled) {
                h += '<div class="est-vbar-row" style="color:#eab308"><span>Maletero (encima):</span><span>' + (malInfo.height || 30) + ' cm \u00b7 sin frente</span></div>';
            }
            h += '</div></div></div>';
            return h;
        }

        function calcEstModuleLedMeters(m) {
            var led = m.led;
            if (!led || !led.enabled)
                return {
                    meters: 0,
                    segments: 0
                };
            var w = m.width / 100,
                h2 = estModHeight(m) / 100;
            var meters = 0,
                segments = 0;
            if (led.edges.top) {
                meters += w;
                segments++;
            }
            if (led.edges.bottom) {
                meters += w;
                segments++;
            }
            if (led.edges.left) {
                meters += h2;
                segments++;
            }
            if (led.edges.right) {
                meters += h2;
                segments++;
            }
            if (led.edges.shelves && led.shelfCount > 0) {
                meters += led.shelfCount * w;
                segments += led.shelfCount;
            }
            return {
                meters: Math.round(meters * 100) / 100,
                segments: segments
            };
        }

        function renderEstModuleLed(m, idx) {
            if (!m.led)
                m.led = {
                    enabled: false,
                    edges: {
                        top: false,
                        bottom: false,
                        left: false,
                        right: false,
                        shelves: false
                    },
                    shelfCount: 0,
                    metersOverride: null,
                    segmentsOverride: null
                };
            var EP = S.estProject,
                led = m.led;
            var h = '<div class="led-section">';
            h += '<div class="led-toggle-row"><span>&#x1f4a1; Iluminaci\u00f3n LED</span><button class="toggle' + (led.enabled ? ' on' : '') + '" onclick="APP.estTogModLed(' + idx + ')"></button></div>';
            if (!led.enabled) {
                h += '</div>';
                return h;
            }
            // Edge selector
            h += '<div class="led-edges"><div style="position:relative;padding:18px 34px"><div class="led-edge-box">';
            ['top', 'bottom', 'left', 'right'].forEach(function(e) {
                h += '<button class="led-edge ' + e + (led.edges[e] ? ' on' : '') + '" onclick="APP.estTogLedEdge(' + idx + ',\'' + e + '\')"></button>';
            });
            h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;color:#666;pointer-events:none">' + m.width + '\u00d7' + estModHeight(m) + '</div>';
            h += '</div></div>';
            // Shelf LED + meters/segments
            h += '<div class="led-opts">';
            h += '<div class="led-shelf-row"><button class="' + (led.edges.shelves ? 'on' : '') + '" onclick="APP.estTogLedShelves(' + idx + ')">' + (led.edges.shelves ? '&#10003;' : '') + ' Entrepa\u00f1os</button>';
            if (led.edges.shelves)
                h += '<input type="number" value="' + led.shelfCount + '" min="0" max="10" onchange="APP.estSetLedShelves(' + idx + ',parseInt(this.value))">';
            h += '</div>';
            var auto = calcEstModuleLedMeters(m);
            var usedM = (led.metersOverride !== null && led.metersOverride >= 0) ? led.metersOverride : auto.meters;
            var usedS = (led.segmentsOverride !== null && led.segmentsOverride >= 0) ? led.segmentsOverride : auto.segments;
            h += '<div class="led-meters"><span>Metros:</span><input type="number" value="' + usedM.toFixed(2) + '" min="0" step="0.1" onchange="APP.estSetLedMeters(' + idx + ',parseFloat(this.value))">';
            h += '<span>Segmentos:</span><input type="number" value="' + usedS + '" min="0" step="1" onchange="APP.estSetLedSegments(' + idx + ',parseInt(this.value))">';
            if (led.metersOverride !== null || led.segmentsOverride !== null)
                h += '<button style="padding:2px 6px;border-radius:4px;border:1px solid #fbbf24;background:none;color:#fbbf24;font-size:10px;cursor:pointer" onclick="APP.estResetLedOverride(' + idx + ')">Auto</button>';
            h += '</div></div></div>';
            // Activation type (project-level)
            h += '<div style="font-size:11px;color:#999;margin-bottom:4px">Activaci\u00f3n:</div>';
            h += '<div class="led-radio">';
            [{
                k: 'presion',
                l: 'Presi\u00f3n',
                p: LED_CATALOG.switches.presion.price
            }, {
                k: 'dimmer',
                l: 'Dimmer',
                p: LED_CATALOG.switches.dimmer.price
            }, {
                k: 'movimiento',
                l: 'Movimiento',
                p: LED_CATALOG.switches.movimiento.price
            }, {
                k: 'puerta',
                l: 'Puerta',
                p: LED_CATALOG.switches.puerta.price
            }].forEach(function(sw) {
                h += '<button class="' + (EP.ledConfig.activation === sw.k ? 'sel' : '') + '" onclick="APP.estSetLedActivation(\'' + sw.k + '\')">' + sw.l + ' ' + fmtD(sw.p) + '</button>';
            });
            h += '</div>';
            // Light temperature (project-level)
            h += '<div style="font-size:11px;color:#999;margin:4px 0">Temperatura:</div>';
            h += '<div class="led-radio">';
            h += '<button class="' + (EP.ledConfig.lightTemp === 'calida' ? 'sel' : '') + '" onclick="APP.estSetLedTemp(\'calida\')">C\u00e1lida 3000K</button>';
            h += '<button class="' + (EP.ledConfig.lightTemp === 'fria' ? 'sel' : '') + '" onclick="APP.estSetLedTemp(\'fria\')">Fr\u00eda 5000K</button>';
            h += '</div>';
            // Mini BOM preview
            var ledBOM = calcEstLedBOM();
            if (ledBOM) {
                h += '<div class="led-bom-preview">';
                h += '<div style="font-size:10px;color:#999;margin-bottom:4px">Lista de Material LED (auto)</div>';
                ledBOM.items.forEach(function(it) {
                    h += '<div class="led-bom-row"><span>' + it.qty + 'x ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                });
                h += '<div class="led-bom-total"><span>Costo LED</span><strong>' + fmtD(ledBOM.totalCost) + '</strong></div>';
                h += '<div class="led-bom-total" style="border:none;padding-top:0;margin-top:0;font-size:11px"><span>Venta LED (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong>' + fmtD(ledBOM.totalCost * CONFIG.pricing.extrasMultiplier) + '</strong></div>';
                h += '</div>';
            }
            h += '</div>';
            return h;
        }

        function renderEstModulePaint(m, idx) {
            if (!m.paint)
                m.paint = {
                    enabled: false,
                    name: '',
                    pricePerLiter: 0,
                    coats: 2,
                    scope: 'doors'
                };
            var paint = m.paint;
            var qm = m.quoteMode || 'completo';
            var h = '<div class="field"><label>&#x1f3a8; Pintura</label>';
            h += '<div style="display:flex;gap:8px;margin-bottom:8px">';
            h += '<button class="opt-btn' + (paint.enabled ? ' sel' : '') + '" onclick="APP.estTogPaint(' + idx + ')">' + svg(paint.enabled ? 'check' : 'plus') + ' Con pintura</button>';
            h += '<button class="opt-btn' + (!paint.enabled ? ' sel' : '') + '" onclick="APP.estTogPaint(' + idx + ')">Sin pintura</button>';
            h += '</div>';
            if (paint.enabled) {
                h += '<div style="display:flex;flex-direction:column;gap:6px">';
                h += '<div class="est-zone-row"><span>Nombre:</span><input type="text" value="' + (paint.name || '') + '" placeholder="Ej: Laqueado blanco" style="flex:1;font-size:13px" onchange="APP.estSetPaintName(' + idx + ',this.value)"></div>';
                h += '<div class="est-zone-row"><span>Precio/Litro:</span><div style="display:flex;align-items:center;gap:6px"><span style="color:#bbb">$</span><input type="number" value="' + paint.pricePerLiter + '" min="0" step="50" style="width:100px;font-size:13px" onchange="APP.estSetPaintPrice(' + idx + ',parseFloat(this.value))"></div></div>';
                h += '<div class="est-zone-row"><span>Manos:</span><div style="display:flex;align-items:center;gap:6px"><input type="number" value="' + (paint.coats || 2) + '" min="1" max="5" step="1" style="width:60px;font-size:13px" onchange="APP.estSetPaintCoats(' + idx + ',parseInt(this.value))"></div></div>';
                h += '<div class="est-zone-row"><span>Alcance:</span><div style="display:flex;gap:6px">';
                h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'doors' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetPaintScope(' + idx + ',\'doors\')">Puertas</button>';
                h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'structure' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetPaintScope(' + idx + ',\'structure\')">Estructura</button>';
                h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'all' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetPaintScope(' + idx + ',\'all\')">Todo</button>';
                h += '</div></div>';
                var coats = paint.coats || 2;
                var pm2 = calcPaintM2(m, {
                    mode: 'est'
                });
                var liters = calcPaintLiters(pm2, coats);
                var buyLiters = Math.ceil(liters);
                var cost = liters * paint.pricePerLiter;
                h += '<div style="font-size:12px;color:#60a5fa;padding:4px 0">' + pm2.toFixed(2) + ' m\u00b2 \u00d7 ' + coats + ' manos \u00f7 10 m\u00b2/L = ' + liters.toFixed(2) + ' L &rarr; ' + fmtD(Math.round(cost)) + '</div>';
                h += '<div style="font-size:11px;color:#999;padding:1px 0">Comprar: ' + buyLiters + ' L</div>';
                if (pm2 === 0 && paint.scope === 'doors' && !m.doors && qm !== 'solo_puertas')
                    h += '<div style="font-size:11px;color:#f87171;padding:2px 0">Sin puertas \u2014 0 m\u00b2</div>';
                if (pm2 === 0 && paint.scope === 'structure' && qm === 'solo_puertas')
                    h += '<div style="font-size:11px;color:#f87171;padding:2px 0">Solo puertas \u2014 sin estructura</div>';
                h += '</div>';
            }
            h += '</div>';
            return h;
        }

        function renderEstMaterial() {
            var EP = S.estProject;
            var h = '<div class="title"><h2>Material y Espesor</h2><p>Selecciona los materiales</p></div>';
            // Same material toggle
            h += '<div class="mat-toggle-row"><span>Usar mismo material para todo</span><button class="toggle' + (EP.sameMaterial ? ' on' : '') + '" onclick="APP.estTogSameMat()"></button></div>';
            if (EP.sameMaterial) {
                h += renderMaterialSelect('Material', EP.matFrentes, 'APP.estSetMatFrentes', '');
            } else {
                h += renderMaterialSelect('Material Frentes', EP.matFrentes, 'APP.estSetMatFrentes', 'vis');
                h += renderMaterialSelect('Material Interior', EP.matInterior, 'APP.estSetMatInterior', 'hid');
            }
            // Thickness
            var stdThicks = [16, 18, 25];
            var isCustomThk = stdThicks.indexOf(EP.thickness) === -1;
            h += '<div class="field"><label>Espesor Principal</label><div style="display:flex;gap:8px;flex-wrap:wrap">';
            stdThicks.forEach(function(t) {
                h += '<button class="thick-btn' + (EP.thickness === t ? ' sel' : '') + '" onclick="APP.estSetThick(' + t + ')">' + t + 'mm</button>';
            });
            h += '<button class="thick-btn' + (isCustomThk ? ' sel' : '') + '" onclick="APP.estSetCustomThick()">Otro</button>';
            h += '</div>';
            if (isCustomThk) {
                h += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input type="number" value="' + EP.thickness + '" min="3" max="50" step="1" style="width:80px" onchange="APP.estSetThick(parseInt(this.value))"><span style="color:#bbb">mm</span></div>';
            }
            h += '<p class="hint">Todas las piezas usan el espesor seleccionado</p></div>';
            // Chapacanto price
            h += '<div class="field"><label>Chapacanto ($/ml)</label>';
            if (EP.sameMaterial) {
                h += '<input type="number" value="' + EP.chapFrentesPrice + '" step="0.1" onchange="APP.estSetChapPrice(parseFloat(this.value))" style="width:120px">';
            } else {
                h += '<div style="display:flex;gap:12px"><div style="flex:1"><span style="font-size:12px;color:#60a5fa">Frentes</span><input type="number" value="' + EP.chapFrentesPrice + '" step="0.1" onchange="APP.estSetChapPrice(parseFloat(this.value))"></div>';
                h += '<div style="flex:1"><span style="font-size:12px;color:#9ca3af">Interior</span><input type="number" value="' + EP.chapInteriorPrice + '" step="0.1" onchange="APP.estSetChapPriceI(parseFloat(this.value))"></div></div>';
            }
            h += '</div>';
            // Enchapado price
            h += '<div class="field"><label>Enchapado ($/ml)</label>';
            h += '<input type="number" value="' + (typeof EP.enchapPrice === 'number' ? EP.enchapPrice : 13) + '" step="0.5" min="0" onchange="APP.estSetEnchapPrice(parseFloat(this.value))" style="width:120px">';
            h += '<p class="hint">Costo por metro lineal de enchapado</p></div>';
            // Labor
            h += '<div class="field"><label>Mano de Obra</label>';
            h += '<div class="labor-input"><span>$</span><input type="number" value="' + EP.laborCost + '" min="0" step="500" onchange="APP.estSetLabor(parseFloat(this.value))"></div>';
            h += '<div class="labor-presets">';
            [{
                l: '$3,000',
                v: 3000
            }, {
                l: '$5,000',
                v: 5000
            }, {
                l: '$8,000',
                v: 8000
            }, {
                l: '$12,000',
                v: 12000
            }].forEach(function(p) {
                h += '<button class="labor-preset' + (EP.laborCost === p.v ? ' sel' : '') + '" onclick="APP.estSetLabor(' + p.v + ')">' + p.l + '</button>';
            });
            h += '</div></div>';
            return h;
        }

        function renderEstSummary() {
            var EP = S.estProject;
            if (EP.modules.length === 0)
                return '<div class="empty">No hay m\u00f3dulos configurados</div>';
            var c = calcEstandarizado();
            var ov = EP.hwOverrides || {};
            var isCustom = EP.mode === 'custom';
            var h = '<div class="title"><h2>Resumen de Cotizaci\u00f3n</h2><p>' + (isCustom ? 'Proyecto Personalizado' : 'Closet Estandarizado') + '</p></div>';
            // Despiece per module  grouped by section
            EP.modules.forEach(function(m, mi) {
                var pcs = c.pieces.filter(function(p) {
                    return p.mid === m.id;
                });
                var mTypeStr = m.type === 'esquinero' ? ' \u2014 Esquinero ' + m.width + '\u00d7' + (m.width2 || m.width) + 'cm' : m.type === 'fijo' ? ' \u2014 Fijo ' + m.width + '\u00d7' + m.height + 'cm' : m.type === 'panelTV' ? ' \u2014 Panel TV ' + m.width + 'cm' : m.type === 'torreLateral' ? ' \u2014 Torre Lat. ' + m.width + 'cm' : ' \u2014 ' + m.width + 'cm';
                if (isCustom)
                    mTypeStr += ' \u00d7 ' + m.height + 'cm alto';
                var mLabel = 'M\u00f3dulo ' + (mi + 1) + mTypeStr;
                h += '<div class="card" style="border-left:3px solid #c49a6c">';
                h += '<div style="font-size:16px;font-weight:700;color:#c49a6c;margin-bottom:12px">' + mLabel + '</div>';
                // Group: structure
                var struct = pcs.filter(function(p) {
                    return p.n.indexOf('caj') < 0 && p.n.indexOf('Puerta') < 0 && p.n.indexOf('Repisa') < 0 && p.n.indexOf('Entrepa') < 0 && p.n.indexOf('maletero') < 0 && p.n !== 'Fijo';
                });
                var cajones = pcs.filter(function(p) {
                    return p.n.indexOf('caj') >= 0 || p.n.indexOf('Caj') >= 0;
                });
                var entrepa = pcs.filter(function(p) {
                    return p.n.indexOf('Entrepa') >= 0;
                });
                var repisas = pcs.filter(function(p) {
                    return p.n.indexOf('Repisa') >= 0;
                });
                var fijos = pcs.filter(function(p) {
                    return p.n === 'Fijo';
                });
                var puertas = pcs.filter(function(p) {
                    return p.n.indexOf('Puerta') >= 0;
                });
                var maleteros = pcs.filter(function(p) {
                    return p.n.indexOf('maletero') >= 0;
                });
                function renderPieceGroup(label, items) {
                    if (items.length === 0)
                        return '';
                    var g = '<div style="margin-bottom:10px"><div style="font-size:13px;font-weight:600;color:#999;text-transform:uppercase;margin-bottom:4px;border-bottom:1px solid #2a2a2a;padding-bottom:3px">' + label + '</div>';
                    items.forEach(function(p) {
                        var al = anchoLargo(p.w, p.h);
                        g += '<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:15px"><span style="color:#fff">' + p.n + ' <span style="color:#c49a6c;font-weight:700">\u00d7' + p.q + '</span></span><strong style="font-family:monospace;color:#bbb">' + al.ancho + ' \u00d7 ' + al.largo + ' <span style="color:#666">' + p.t + 'mm</span></strong></div>';
                    });
                    g += '</div>';
                    return g;
                }
                h += renderPieceGroup('Estructura', struct);
                h += renderPieceGroup('Cajones', cajones);
                h += renderPieceGroup('Entrepa\u00f1os', entrepa);
                h += renderPieceGroup('Zapatero', repisas);
                h += renderPieceGroup('Fijos', fijos);
                h += renderPieceGroup('Maletero', maleteros);
                h += renderPieceGroup('Puertas', puertas);
                // Zone summary for this module
                h += '<div style="font-size:12px;color:#666;margin-top:4px">';
                m.zones.forEach(function(z) {
                    var zt = EST_ZONE_TYPES.find(function(x) {
                        return x.id === z.type;
                    });
                    var zh = getEstZoneDisplayHeight(m, z);
                    h += (zt ? zt.n : z.type) + ' ' + zh + 'cm';
                    if (z.type === 'cajones')
                        h += ' (' + (z.count || 3) + '\u00d7' + (z.cajonHeight || 20) + 'cm)';
                    if (z.type === 'zapatero')
                        h += ' (' + (z.repisas || 3) + ' cajones ext.)';
                    h += '&nbsp;&nbsp;';
                });
                var malSum = m.maletero || {
                    enabled: false
                };
                if (malSum.enabled)
                    h += '&#x1f9f3; Maletero ' + (malSum.height || 30) + 'cm (encima)&nbsp;&nbsp;';
                h += '</div>';
                h += '</div>';
            });
            // Sheets + Canto
            h += '<div class="card"><div class="card-title">' + svg('layers') + ' Material</div>';
            h += '<div class="cost-row"><span>Hojas totales (' + (c.projThickness || 16) + 'mm)</span><strong>' + c.totalSheets + '</strong></div>';
            h += '<div class="cost-row"><span>Chapacanto total</span><strong>' + c.totalCanto + ' ml</strong></div>';
            h += '</div>';
            // Hardware (editable)
            h += '<div class="card"><div class="card-title">' + svg('settings') + ' Herrajes</div>';
            h += '<div style="font-size:11px;color:#999;margin-bottom:8px">Autom\u00e1ticos (editable)</div>';
            c.allHW.forEach(function(hw) {
                if (!hw.key)
                    return; // skip manual HW here, shown below
                var isOverridden = ov[hw.key];
                var qtyVal = Math.ceil(hw.qty);
                h += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #2a2a2a">';
                h += '<div style="flex:1;min-width:0">';
                h += '<span class="hw-sel-marca ' + marcaClass(hw.marca) + '">' + hw.marca + '</span> ';
                h += '<span style="font-size:13px;color:#ddd">' + hw.desc + '</span>';
                if (isOverridden)
                    h += ' <span style="font-size:10px;color:#fbbf24">(editado)</span>';
                h += '</div>';
                h += '<div style="display:flex;align-items:center;gap:4px">';
                h += '<button style="width:28px;height:28px;border-radius:6px;border:1px solid #3a3a3a;background:#1a1a1a;color:#fff;font-size:16px;cursor:pointer" onclick="APP.estHwQty(\'' + hw.key + '\',-1)">\u2212</button>';
                h += '<input type="number" value="' + qtyVal + '" min="0" style="width:48px;text-align:center;font-size:15px;font-weight:700;color:#c49a6c;background:#1a1a1a;border:1px solid #3a3a3a;border-radius:6px;padding:2px" onchange="APP.estHwQtySet(\'' + hw.key + '\',parseInt(this.value))">';
                h += '<button style="width:28px;height:28px;border-radius:6px;border:1px solid #3a3a3a;background:#1a1a1a;color:#fff;font-size:16px;cursor:pointer" onclick="APP.estHwQty(\'' + hw.key + '\',1)">+</button>';
                h += '</div>';
                h += '<strong style="min-width:70px;text-align:right;font-family:monospace;font-size:13px;color:#bbb">' + fmtD(qtyVal * hw.price) + '</strong>';
                h += '</div>';
                // Swap button row
                h += '<div style="display:flex;gap:6px;padding:2px 0 4px">';
                h += '<button style="font-size:10px;padding:2px 8px;border-radius:4px;border:1px solid #3a3a3a;background:none;color:#999;cursor:pointer" onclick="APP.estHwSwap(\'' + hw.key + '\')">Cambiar tipo</button>';
                if (isOverridden)
                    h += '<button style="font-size:10px;padding:2px 8px;border-radius:4px;border:1px solid #c49a6c;background:none;color:#c49a6c;cursor:pointer" onclick="APP.estHwReset(\'' + hw.key + '\')">Restaurar</button>';
                h += '</div>';
            });
            // Manual hardware
            if (EP.hardware.length > 0) {
                h += '<div style="margin-top:8px;padding-top:8px;border-top:1px solid #3a3a3a"><div style="font-size:11px;color:#999;margin-bottom:4px">Manual:</div>';
                EP.hardware.forEach(function(h2, hi) {
                    h += '<div class="hw-sel-item"><span class="hw-sel-marca ' + marcaClass(h2.marca) + '">' + h2.marca + '</span><span class="hw-sel-name">' + h2.descripcion + '</span>';
                    h += '<div class="hw-sel-qty"><button onclick="APP.hwCartQty(\'' + h2.codigo + '\',-1)">-</button><strong>' + h2.qty + '</strong><button onclick="APP.hwCartQty(\'' + h2.codigo + '\',1)">+</button></div>';
                    h += '<span class="hw-sel-price">' + fmtD(h2.qty * adjPrice(h2)) + '</span></div>';
                });
                h += '</div>';
            }
            h += '<button class="hw-add-btn" onclick="APP.openHWPicker()" style="margin-top:8px">' + svg('plus') + ' Agregar herraje</button>';
            h += '</div>';
            // LED
            if (c.ledBOM) {
                h += '<div class="card"><div class="card-title" style="color:#fbbf24">&#x1f4a1; LED</div>';
                c.ledBOM.items.forEach(function(it) {
                    h += '<div class="cost-row"><span style="font-size:12px">' + it.qty + '\u00d7 ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                });
                h += '<div class="cost-total"><span>Costo LED</span><strong>' + fmtD(c.ledBOM.totalCost) + '</strong></div>';
                h += '</div>';
            }
            // Cost breakdown
            h += '<div class="card"><div class="card-title">' + svg('dollar') + ' Costos</div>';
            // --- CARPINTERIA ---
            h += '<div style="font-size:13px;font-weight:600;color:#999;text-transform:uppercase;margin-bottom:6px;border-bottom:1px solid #2a2a2a;padding-bottom:3px">Carpinter\u00eda</div>';
            var matNameF = EP.matFrentes.brand === 'CUSTOM' ? (EP.matFrentes.name || 'Personalizado') : EP.matFrentes.brand + ' ' + EP.matFrentes.name + (EP.matFrentes.finish ? ' ' + EP.matFrentes.finish : '');
            var matNameI = EP.matInterior.brand === 'CUSTOM' ? (EP.matInterior.name || 'Personalizado') : EP.matInterior.brand + ' ' + EP.matInterior.name + (EP.matInterior.finish ? ' ' + EP.matInterior.finish : '');
            var csTK = c.projThickness || 16;
            if (c.totalSheetsF > 0)
                h += '<div class="cost-row"><span>' + matNameF + ' ' + csTK + 'mm (' + c.totalSheetsF + ' hojas \u00d7 ' + fmtD(c.matPriceF) + ')</span><strong>' + fmt(c.totalSheetsF * c.matPriceF) + '</strong></div>';
            if (c.useDual && c.totalSheetsI > 0)
                h += '<div class="cost-row"><span>' + matNameI + ' ' + csTK + 'mm (' + c.totalSheetsI + ' hojas \u00d7 ' + fmtD(c.matPriceI) + ')</span><strong>' + fmt(c.totalSheetsI * c.matPriceI) + '</strong></div>';
            h += '<div class="cost-row"><span>Chapacanto (' + c.totalCanto + ' ml)</span><strong>' + fmt(c.chapCostF + c.chapCostI) + '</strong></div>';
            h += '<div class="cost-row"><span>Corte (' + c.totalSheets + ' hojas)</span><strong>' + fmt(c.corteCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Enchapado (' + c.totalCanto + ' ml x $' + (typeof EP.enchapPrice === 'number' ? EP.enchapPrice : 13) + ')</span><strong>' + fmt(c.enchapCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Mano de obra</span><strong>' + fmt(EP.laborCost) + '</strong></div>';
            h += '<div class="cost-total"><span>Costo Carpinter\u00eda</span><strong>' + fmt(c.carpCost) + '</strong></div>';
            h += '<div class="cost-row" style="font-size:12px;color:#c49a6c"><span>Carpinter\u00eda x' + CONFIG.pricing.carpentryMultiplier + '</span><strong>' + fmt(c.carpSale) + '</strong></div>';
            // --- HERRAJES ---
            h += '<div style="font-size:13px;font-weight:600;color:#999;text-transform:uppercase;margin:10px 0 6px;border-bottom:1px solid #2a2a2a;padding-bottom:3px">Herrajes</div>';
            var hwTotalCost = c.hwCostCarpBucket + c.hwCostPremium;
            if (c.hwCostCarpBucket > 0)
                h += '<div class="cost-row"><span>Herrajes est\u00e1ndar (\u2264$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostCarpBucket) + '</strong></div>';
            if (c.hwCostPremium > 0)
                h += '<div class="cost-row"><span>Herrajes premium (>$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostPremium) + '</strong></div>';
            h += '<div class="cost-total"><span>Costo Herrajes</span><strong>' + fmt(hwTotalCost) + '</strong></div>';
            var hwSaleTotal = (c.hwCostCarpBucket * CONFIG.pricing.carpentryMultiplier) + c.hwPremiumSale;
            h += '<div class="cost-row" style="font-size:12px;color:#c49a6c"><span>Herrajes (margen ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong>' + fmt(hwSaleTotal) + '</strong></div>';
            // --- SUBTOTAL CARP + HERRAJES ---
            h += '<div class="cost-total" style="margin-top:8px;border-top:2px solid #c49a6c;padding-top:8px"><span>Subtotal Carpinter\u00eda + Herrajes</span><strong style="color:#c49a6c">' + fmt(c.carpSale + hwSaleTotal) + '</strong></div>';
            if (c.extraCost > 0) {
                h += '<div style="font-size:13px;font-weight:600;color:#999;text-transform:uppercase;margin:10px 0 6px;border-bottom:1px solid #2a2a2a;padding-bottom:3px">Extras</div>';
                if (c.ledBOM)
                    h += '<div class="cost-row"><span>LED</span><strong>' + fmt(c.ledBOM.totalCost) + '</strong></div>';
                if (c.vidrioCost > 0)
                    h += '<div class="cost-row"><span>Vidrio (cot. externa)</span><strong>' + fmt(c.vidrioCost) + '</strong></div>';
                if (c.paintCost > 0) {
                    EP.modules.forEach(function(m2, mi2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'est'
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                h += '<div class="cost-row"><span>Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' Mod ' + (mi2 + 1) + ' (' + lit.toFixed(1) + 'L)</span><strong>' + fmtD(Math.round(lit * m2.paint.pricePerLiter)) + '</strong></div>';
                        }
                    });
                }
                h += '<div class="cost-total"><span>Subtotal Extras</span><strong>' + fmt(c.extraCost) + '</strong></div>';
            }
            h += '</div>';
            // Totals
            h += '<div class="summary">';
            h += '<div class="grand-total"><span>COSTO TOTAL</span><strong>' + fmt(c.totalCost) + '</strong></div>';
            h += '<div class="summary-row"><span>Carpinter\u00eda (carp + herrajes \u2264$' + CONFIG.pricing.hardwareThreshold + ') x' + CONFIG.pricing.carpentryMultiplier + '</span><strong>' + fmt(c.carpSale) + '</strong></div>';
            if (c.hwPremiumSale > 0)
                h += '<div class="summary-row"><span>Herrajes Premium (margen ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong>' + fmt(c.hwPremiumSale) + '</strong></div>';
            if (c.extrasSale > 0)
                h += '<div class="summary-row"><span>Extras</span><strong>' + fmt(c.extrasSale) + '</strong></div>';
            h += '<div class="grand-total"><span>PRECIO VENTA</span><strong>' + fmt(c.subtotal) + '</strong></div>';
            h += '<div class="summary-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
            h += '<div class="grand-total" style="margin-top:8px"><span>TOTAL CON IVA</span><strong>' + fmt(c.total) + '</strong></div>';
            h += '<div class="profit-box"><span>Costo: ' + fmt(c.totalCost) + '</span><strong>Utilidad: ' + fmt(c.profit) + ' (' + c.margin + '%)</strong></div></div>';
            // Plano upload
            h += '<div class="card" style="margin-top:16px"><div class="card-title">' + svg('layers') + ' Plano</div>';
            h += '<input type="file" id="plano-upload" accept="image/jpeg,image/png,image/jpg" style="display:none" onchange="APP.estUploadPlano(this)">';
            if (EP.planoImage) {
                h += '<div style="position:relative;margin-bottom:12px">';
                h += '<img src="' + EP.planoImage + '" style="max-width:100%;max-height:300px;border-radius:8px;border:1px solid #3a3a3a">';
                h += '<button onclick="APP.estRemovePlano()" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:#f87171;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:16px">&times;</button>';
                h += '</div>';
                h += '<p style="color:#4ade80;font-size:13px">Plano adjunto - se incluir\u00e1 en PDF Cliente e Interno</p>';
            } else {
                h += '<button class="opt-btn" onclick="document.getElementById(\'plano-upload\').click()" style="margin-bottom:8px">' + svg('plus') + ' Adjuntar plano (JPG/PNG)</button>';
                h += '<p class="hint">Imagen del plano final del proyecto. Se agrega como p\u00e1gina al final del PDF.</p>';
            }
            h += '</div>';
            // PDF buttons
            h += '<div class="pdf-actions" style="margin-top:16px">';
            h += '<button class="pdf-btn client" onclick="APP.estGenClientPDF()">&#x1f4c4; PDF Cliente</button>';
            h += '<button class="pdf-btn internal" onclick="APP.estGenInternalPDF()">&#x1f512; PDF Interno</button>';
            h += '</div>';
            // Save project button
            h += '<button class="est-save-btn" onclick="APP.saveProject()">' + svg('check') + ' Guardar Proyecto</button>';
            return h;
        }

        function renderEstandarizado() {
            var br = BRANDS[S.brand] || BRANDS.primary;
            var isCustom = S.estProject && S.estProject.mode === 'custom';
            var hdrTitle = isCustom ? 'Nuevo Proyecto' : 'Closet Estandarizado';
            var h = '<div class="hdr"><div style="display:flex;align-items:center"><div class="hdr-logo" onclick="APP.goHome()" style="background:#1a1a2e;color:#c49a6c;font-size:12px;cursor:pointer">' + br.mono + '</div><div class="hdr-txt"><h1>' + hdrTitle + '</h1><p>' + br.name + '</p></div></div>';
            h += '<div class="hdr-actions"><button class="hdr-btn" onclick="APP.openSettings()">' + svg('settings') + '</button></div></div>';
            h += renderEstStepDots();
            h += '<div class="content" id="content">';
            if (S.estScreen === 'builder')
                h += renderEstBuilder();
            else if (S.estScreen === 'editor')
                h += renderEstEditor();
            else if (S.estScreen === 'material')
                h += renderEstMaterial();
            else if (S.estScreen === 'summary')
                h += renderEstSummary();
            h += '</div>';
            // Nav
            h += '<div class="nav">';
            if (S.estScreen === 'builder') {
                h += '<button class="nav-btn back" onclick="APP.goHome()">' + svg('left') + ' Inicio</button>';
                h += '<button class="nav-btn next" onclick="APP.estNext()"' + (S.estProject.modules.length > 0 ? '' : ' disabled') + '>Siguiente ' + svg('right') + '</button>';
            } else if (S.estScreen === 'editor') {
                h += '<button class="nav-btn back" onclick="APP.estBackToBuilder()">' + svg('left') + ' M\u00f3dulos</button>';
                h += '<button class="nav-btn next" onclick="APP.estNext()">Siguiente ' + svg('right') + '</button>';
            } else if (S.estScreen === 'material') {
                h += '<button class="nav-btn back" onclick="APP.estPrev()">' + svg('left') + ' Atr\u00e1s</button>';
                h += '<button class="nav-btn next" onclick="APP.estNext()">Ver Cotizaci\u00f3n ' + svg('right') + '</button>';
            } else {
                h += '<button class="nav-btn back" onclick="APP.estPrev()">' + svg('left') + ' Atr\u00e1s</button>';
                h += '<button class="nav-btn next" style="background:#c49a6c;color:#1a1a2e" onclick="APP.estGenClientPDF()">Generar PDF ' + svg('right') + '</button>';
            }
            h += '</div>';
            h += renderHWPicker();
            h += renderSettings();
            return h;
        }

        function render() {
            var el = $('content');
            if (el)
                scrollY = el.scrollTop;
            var br = BRANDS[S.brand] || BRANDS.primary;
            if (S.screen === 'estandarizado') {
                $('app').innerHTML = renderEstandarizado();
                var el2 = $('content');
                if (el2)
                    el2.scrollTop = scrollY;
                return;
            }
            if (S.screen === 'templates') {
                var h = '<div class="hdr"><div style="display:flex;align-items:center"><div class="hdr-logo" style="background:#1a1a2e;color:#c49a6c;font-size:12px">' + br.mono + '</div><div class="hdr-txt"><h1>' + br.name + '</h1><p>Cotizador V2</p></div></div></div>';
                h += '<div class="content" id="content">' + renderTemplates() + '</div>';
                if (S.imgModal)
                    h += '<div class="img-modal" onclick="APP.closeImg()"><button class="img-modal-close" onclick="APP.closeImg()">' + svg('x') + '</button><img src="' + S.imgModal + '" onclick="event.stopPropagation()"></div>';
                $('app').innerHTML = h;
                return;
            }
            var c = calc();
            var h = '<div class="hdr"><div style="display:flex;align-items:center"><div class="hdr-logo" onclick="APP.goHome()" style="background:#1a1a2e;color:#c49a6c;font-size:12px">' + br.mono + '</div><div class="hdr-txt"><h1>' + br.name + '</h1><p>Cotizador V2</p></div></div>';
            h += '<div class="hdr-actions"><button class="hdr-btn" onclick="APP.openSettings()">' + svg('settings') + '</button></div></div>';
            h += '<div class="steps">';
            for (var i = 1; i <= 5; i++) {
                var cls = i === S.step ? 'active' : i < S.step ? 'done' : 'future';
                h += '<button class="step-dot ' + cls + '" onclick="APP.goStep(' + i + ')">' + i + '</button>';
                if (i < 5)
                    h += '<div class="step-line' + (i < S.step ? ' done' : '') + '"></div>';
            }
            h += '</div><div class="content" id="content">';
            if (S.step === 1)
                h += step1();
            else if (S.step === 2)
                h += step2();
            else if (S.step === 3)
                h += step3(c);
            else if (S.step === 4)
                h += step4(c);
            else
                h += step5(c);
            h += '</div>' + nav();
            h += renderHWPicker();
            h += renderSettings();
            $('app').innerHTML = h;
            var el2 = $('content');
            if (el2)
                el2.scrollTop = scrollY;
        }

        // === APP METHODS ===
        window.APP = {
            goHome: function() {
                S.screen = 'templates';
                S.selTemplate = null;
                scrollY = 0;
                render();
            },
            selectTpl: function(id) {
                var t = TEMPLATES.find(function(x) {
                    return x.id === id;
                });
                if (!t)
                    return;
                // Convert template to estandarizado project
                var ep = defaultEstProject();
                ep.mode = 'custom';
                ep.projectType = t.type || '';
                // Material from template
                var matCode = t.matCode || '1AS';
                var matName = t.matName || 'Nogal Valentina';
                var matFinish = t.matFinish || 'Mesura';
                var matObj = {
                    brand: 'FINSA',
                    code: matCode,
                    name: matName,
                    finish: matFinish,
                    precio: FINSA_PRICES[16],
                    thickness: 16
                };
                ep.matFrentes = matObj;
                ep.matInterior = JSON.parse(JSON.stringify(matObj));
                ep.sameMaterial = true;
                ep.laborCost = t.laborCost || 5000;
                ep.ledConfig = {
                    activation: 'dimmer',
                    lightTemp: 'calida'
                };
                // Convert preModules to estandarizado modules
                ep.modules = [];
                if (t.preModules) {
                    t.preModules.forEach(function(pm) {
                        var modType = pm.type;
                        // Map old types to estandarizado types
                        if (modType === 'modulo' || modType === 'colgador' || modType === 'entrepa' || modType === 'zapatero')
                            modType = 'normal';
                        var mod = defaultEstModule(modType === 'panelTV' ? 'panelTV' : modType === 'torreLateral' ? 'torreLateral' : modType === 'esquinero' ? 'esquinero' : modType === 'especial' ? 'especial' : 'normal');
                        mod.width = pm.width;
                        mod.height = t.baseHeight ? Math.min(t.baseHeight, 300) : 200;
                        // Build zones from preModule fields
                        mod.zones = [];
                        if (pm.type === 'colgador') {
                            mod.zones.push({
                                id: uid(),
                                type: 'colgador',
                                tubos: 1
                            });
                        } else if (pm.type === 'modulo') {
                            var caj = pm.cajones || 4;
                            if (caj > 0)
                                mod.zones.push({
                                    id: uid(),
                                    type: 'cajones',
                                    count: caj,
                                    cajonHeight: 20
                                });
                        } else if (pm.type === 'entrepa' || pm.type === 'torreLateral') {
                            var sh = pm.shelves || 3;
                            mod.zones.push({
                                id: uid(),
                                type: 'entrepa',
                                count: sh
                            });
                        } else if (pm.type === 'zapatero') {
                            mod.zones.push({
                                id: uid(),
                                type: 'zapatero',
                                repisas: 3,
                                repisaHeight: 15
                            });
                        }
                        // If no zones set, add default colgador
                        if (mod.zones.length === 0 && modType !== 'panelTV') {
                            mod.zones.push({
                                id: uid(),
                                type: 'colgador',
                                tubos: 1
                            });
                        }
                        // Doors
                        if (pm.doors) {
                            mod.doors = true;
                            mod.doorMode = 'por_zona';
                            mod.zones.forEach(function(z) {
                                z.doors = true;
                                z.doorMaterial = 'melamina';
                                z.doorType = pm.tipon ? 'tipon' : 'jaladera';
                            });
                        }
                        // LED
                        if (t.hasLed) {
                            mod.led = {
                                enabled: true,
                                edges: {
                                    top: true,
                                    bottom: false,
                                    left: false,
                                    right: false,
                                    shelves: false
                                },
                                shelfCount: 0,
                                metersOverride: null,
                                segmentsOverride: null
                            };
                        }
                        ep.modules.push(mod);
                    });
                }
                // Enter estandarizado flow
                S.screen = 'estandarizado';
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                S.estProject = ep;
                S.estPdfData = null;
                scrollY = 0;
                render();
            },
            openImg: function(src) {
                S.imgModal = src;
                render();
            },
            closeImg: function() {
                S.imgModal = null;
                render();
            },
            newProject: function() {
                S.screen = 'estandarizado';
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                S.estProject = defaultEstProject();
                S.estProject.mode = 'custom';
                S.estPdfData = null;
                scrollY = 0;
                render();
            },
            // Step navigation
            goStep: function(s) {
                if (s <= S.step) {
                    S.step = s;
                    scrollY = 0;
                    render();
                }
            },
            next: function() {
                var can = S.step === 1 ? S.project.type !== '' : S.step === 2 ? S.project.modules.length > 0 : true;
                if (can && S.step < 5) {
                    if (S.step === 4)
                        APP.initPdfData();
                    S.step++;
                    scrollY = 0;
                    render();
                }
            },
            // Step 1
            setClient: function(v) {
                S.project.client = v;
            },
            setType: function(t) {
                S.project.type = t;
                if (isDualType(t))
                    S.project.sameMaterial = false;
                else
                    S.project.sameMaterial = true;
                render();
            },
            togSameMat: function() {
                S.project.sameMaterial = !S.project.sameMaterial;
                if (S.project.sameMaterial)
                    S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                render();
            },
            setMatFrentes: function(val) {
                var parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    S.project.matFrentes.name = rest;
                    if (S.project.sameMaterial)
                        S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    S.project.matFrentes.customPrice = parseFloat(rest) || 0;
                    if (S.project.sameMaterial)
                        S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    S.project.matFrentes = {
                        brand: 'CUSTOM',
                        code: '',
                        name: S.project.matFrentes.brand === 'CUSTOM' ? S.project.matFrentes.name : '',
                        finish: '',
                        customPrice: S.project.matFrentes.brand === 'CUSTOM' ? S.project.matFrentes.customPrice : 0,
                        thickness: S.project.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        S.project.matFrentes = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[S.project.thickness],
                            thickness: S.project.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        S.project.matFrentes = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: S.project.thickness
                        };
                }
                if (S.project.sameMaterial)
                    S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                render();
            },
            setMatInterior: function(val) {
                var parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    S.project.matInterior.name = rest;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    S.project.matInterior.customPrice = parseFloat(rest) || 0;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    S.project.matInterior = {
                        brand: 'CUSTOM',
                        code: '',
                        name: S.project.matInterior.brand === 'CUSTOM' ? S.project.matInterior.name : '',
                        finish: '',
                        customPrice: S.project.matInterior.brand === 'CUSTOM' ? S.project.matInterior.customPrice : 0,
                        thickness: S.project.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        S.project.matInterior = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[S.project.thickness],
                            thickness: S.project.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        S.project.matInterior = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: S.project.thickness
                        };
                }
                render();
            },
            setThick: function(t) {
                S.project.thickness = t;
                render();
            },
            setCustomThick: function() {
                if ([16, 18, 25].indexOf(S.project.thickness) !== -1)
                    S.project.thickness = 12;
                render();
            },
            setChapF: function(v) {
                S.project.chapFrentesPrice = v || 0;
                if (S.project.sameMaterial)
                    S.project.chapInteriorPrice = v || 0;
                render();
            },
            setEnchapPrice: function(v) {
                S.project.enchapPrice = Math.max(0, v || 0);
                render();
            },
            setChapI: function(v) {
                S.project.chapInteriorPrice = v || 0;
                render();
            },
            setChapSpec: function(v) {
                S.project.chapSpec = v;
            },
            // Step 2 - Modules
            addMod: function(t) {
                var m = MODS[t];
                S.project.modules.push({
                    id: uid(),
                    type: t,
                    name: m.n,
                    width: m.w[m.w.length > 1 ? 1 : 0],
                    doors: false,
                    tipon: false,
                    cajones: t === 'modulo' ? 4 : undefined,
                    shelves: t === 'entrepa' ? 5 : t === 'torreLateral' ? 3 : undefined,
                    corrTier: 'corr_eco',
                    led: {
                        enabled: false,
                        edges: {
                            top: false,
                            bottom: false,
                            left: false,
                            right: false,
                            shelves: false
                        },
                        shelfCount: 0,
                        ledMeters: 0,
                        segments: 0,
                        metersOverride: null,
                        segmentsOverride: null
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                });
                S.editedPieces = {};
                render();
            },
            delMod: function(id) {
                S.project.modules = S.project.modules.filter(function(m) {
                    return m.id !== id;
                });
                S.editedPieces = {};
                render();
            },
            setDefaultHeight: function(v) {
                S.project.defaultHeight = Math.max(50, Math.min(400, v || 200));
                S.editedPieces = {};
                render();
            },
            setDefaultDepth: function(v) {
                S.project.defaultDepth = Math.max(20, Math.min(100, v || 50));
                S.editedPieces = {};
                render();
            },
            togSameDepth: function() {
                S.project.sameDepth = !S.project.sameDepth;
                S.editedPieces = {};
                render();
            },
            setModDepth: function(id, v) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) {
                    m.depth = Math.max(20, Math.min(120, v || 50));
                    S.editedPieces = {};
                    render();
                }
            },
            setModW: function(id, w) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.width = w;
                    S.editedPieces = {};
                    render();
                }
            },
            setModH: function(id, h) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.height = h || 0;
                    S.editedPieces = {};
                    render();
                }
            },
            setModC: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.cajones = n;
                    if (n === 0 && typeof m.shelves !== 'number')
                        m.shelves = 3;
                    S.editedPieces = {};
                    render();
                }
            },
            setModS: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.shelves = n;
                    S.editedPieces = {};
                    render();
                }
            },
            setModCorr: function(id, tier) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.corrTier = tier;
                    S.editedPieces = {};
                    render();
                }
            },
            setModW2: function(id, w) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m.width2 = w; S.editedPieces = {}; render(); }
            },
            togModProp: function(id, prop) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m[prop] = !m[prop]; S.editedPieces = {}; render(); }
            },
            setModProp: function(id, prop, val) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m[prop] = val; S.editedPieces = {}; render(); }
            },
            togDoor: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.doors = !m.doors;
                    if (!m.doors) {
                        m.tipon = false;
                        m.quoteMode = 'completo';
                    }
                    S.editedPieces = {};
                    render();
                }
            },
            togTipon: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.tipon = !m.tipon;
                    S.editedPieces = {};
                    render();
                }
            },
            setQuoteMode: function(id, mode) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.quoteMode = mode;
                    if (mode === 'solo_puertas') {
                        m.doors = true;
                    }
                    S.editedPieces = {};
                    render();
                }
            },
            // Paint (custom mode)
            togPaint: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    if (!m.paint)
                        m.paint = {
                            enabled: false,
                            name: '',
                            pricePerLiter: 0,
                            coats: 2,
                            scope: 'doors'
                        };
                    m.paint.enabled = !m.paint.enabled;
                    render();
                }
            },
            setPaintName: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.name = v;
                }
            },
            setPaintPrice: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.pricePerLiter = Math.max(0, v || 0);
                    render();
                }
            },
            setPaintCoats: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.coats = Math.max(1, Math.min(5, v || 2));
                    render();
                }
            },
            setPaintScope: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.scope = v;
                    render();
                }
            },
            // Hardware picker
            openHWPicker: function() {
                S.showHWPicker = true;
                S.hwFilter = {
                    marca: '',
                    cat: '',
                    q: ''
                };
                render();
                setTimeout(function() {
                    var i = $('hwSearchInput');
                    if (i)
                        i.focus();
                }, 100);
            },
            closeHWPicker: function(e) {
                if (!e || e.target.classList.contains('hw-picker')) {
                    S.showHWPicker = false;
                    S.estHwSwapKey = null;
                    render();
                }
            },
            hwSearch: function(q) {
                S.hwFilter.q = q;
                var listEl = $('hwListContainer');
                if (listEl) {
                    listEl.innerHTML = buildHWListHTML(filterHW(), !!S.estHwSwapKey);
                } else {
                    render();
                }
            },
            hwFilterMarca: function(m) {
                S.hwFilter.marca = m;
                render();
            },
            hwFilterCat: function(c) {
                S.hwFilter.cat = c;
                render();
            },
            hwCartAdd: function(codigo) {
                var item = getCatalog().find(function(x) {
                    return x.codigo === codigo;
                });
                if (!item)
                    return;
                // Check if in swap mode for estandarizado auto-HW
                if (S.estHwSwapKey) {
                    var EP = S.estProject;
                    if (!EP.hwOverrides)
                        EP.hwOverrides = {};
                    if (!EP.hwOverrides[S.estHwSwapKey])
                        EP.hwOverrides[S.estHwSwapKey] = {};
                    EP.hwOverrides[S.estHwSwapKey].swap = {
                        desc: item.descripcion,
                        marca: item.marca,
                        price: adjPrice(item),
                        catItem: item
                    };
                    S.estHwSwapKey = null;
                    S.showHWPicker = false;
                    render();
                    return;
                }
                var hwArr = S.screen === 'estandarizado' ? S.estProject.hardware : S.project.hardware;
                hwArr.push({
                    codigo: item.codigo,
                    descripcion: item.descripcion,
                    unidad: item.unidad,
                    precio: item.precio,
                    marca: item.marca,
                    categoria: item.categoria,
                    qty: 1
                });
                render();
            },
            hwCartQty: function(codigo, delta) {
                var hwArr = S.screen === 'estandarizado' ? S.estProject.hardware : S.project.hardware;
                var idx = hwArr.findIndex(function(x) {
                    return x.codigo === codigo;
                });
                if (idx >= 0) {
                    hwArr[idx].qty += delta;
                    if (hwArr[idx].qty <= 0)
                        hwArr.splice(idx, 1);
                }
                render();
            },
            hwQty: function(idx, delta) {
                if (S.project.hardware[idx]) {
                    S.project.hardware[idx].qty += delta;
                    if (S.project.hardware[idx].qty <= 0)
                        S.project.hardware.splice(idx, 1);
                }
                render();
            },
            // LED per-module
            togModLed: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    if (!m.led)
                        m.led = {
                            enabled: false,
                            edges: {
                                top: false,
                                bottom: false,
                                left: false,
                                right: false,
                                shelves: false
                            },
                            shelfCount: 0,
                            ledMeters: 0,
                            segments: 0,
                            metersOverride: null,
                            segmentsOverride: null
                        };
                    m.led.enabled = !m.led.enabled;
                    render();
                }
            },
            togLedEdge: function(id, edge) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.edges[edge] = !m.led.edges[edge];
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedShelves: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.shelfCount = Math.max(0, n || 0);
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedMeters: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.metersOverride = Math.max(0, v || 0);
                    render();
                }
            },
            setLedSegments: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.segmentsOverride = Math.max(0, v || 0);
                    render();
                }
            },
            resetLedOverride: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedActivation: function(type) {
                S.project.ledConfig.activation = type;
                render();
            },
            setLedTemp: function(temp) {
                S.project.ledConfig.lightTemp = temp;
                render();
            },
            // Extras
            togGlass: function() {
                S.project.glass = !S.project.glass;
                render();
            },
            setGlassM2: function(v) {
                S.project.glassM2 = v || 0;
                render();
            },
            // Step 3
            setLabor: function(v) {
                S.project.laborCost = Math.max(0, v || 0);
                render();
            },
            togFreight: function() {
                S.project.freight = !S.project.freight;
                render();
            },
            togCostBD: function() {
                S.showCostBreakdown = !S.showCostBreakdown;
                render();
            },
            setView: function(v) {
                S.view = v;
                render();
            },
            // Settings
            openSettings: function() {
                S.showSettings = true;
                render();
            },
            closeSettings: function(e) {
                if (!e || e.target.classList.contains('settings-overlay')) {
                    S.showSettings = false;
                    render();
                }
            },
            setMarginPreset: function(p) {
                S.settings.marginPreset = p;
                if (p === 'estandar') {
                    S.settings.marginCarp = CONFIG.pricing.marginCarp;
                    S.settings.marginHwStd = CONFIG.pricing.marginHwStd;
                }
                else if (p === 'conservador') {
                    S.settings.marginCarp = 60;
                    S.settings.marginHwStd = 60;
                }
                render();
            },
            setMarginCarp: function(v) {
                S.settings.marginCarp = Math.max(0, Math.min(90, v || 0));
                S.settings.marginPreset = 'custom';
                render();
            },
            setMarginHwStd: function(v) {
                S.settings.marginHwStd = Math.max(0, Math.min(90, v || 0));
                S.settings.marginPreset = 'custom';
                render();
            },
            setSupplierAdj: function(marca, val) {
                S.settings.supplierAdj[marca] = val || 0;
                render();
            },
            // Brand
            setBrand: function(b) {
                S.brand = b;
                try {
                    localStorage.setItem(CONFIG.storage.prefix + 'brand', b);
                } catch (e) {}
                render();
            },
            // Logo
            uploadLogo: function() {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    var file = e.target.files[0];
                    if (!file)
                        return;
                    var reader = new FileReader();
                    reader.onload = function(ev) {
                        var img = new Image();
                        img.onload = function() {
                            var canvas = document.createElement('canvas');
                            var maxW = 300,
                                scale = Math.min(maxW / img.width, 1);
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            var ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            var b64 = canvas.toDataURL('image/png');
                            S.logoBase64 = b64;
                            try {
                                localStorage.setItem(CONFIG.storage.prefix + 'logo_base64', b64);
                            } catch (e2) {}
                            render();
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                };
                input.click();
            },
            removeLogo: function() {
                S.logoBase64 = null;
                try {
                    localStorage.removeItem(CONFIG.storage.prefix + 'logo_base64');
                } catch (e) {}
                render();
            },
            setQuoteCounter: function(v) {
                S.quoteCounter = Math.max(1, v || 1);
                try {
                    localStorage.setItem(CONFIG.storage.prefix + 'quote_counter', S.quoteCounter);
                } catch (e) {}
                render();
            },
            // PDF
            initPdfData: function() {
                var P = S.project,
                    c = calc(),
                    type = TYPES.find(function(t) {
                        return t.id === P.type;
                    });
                var yr = new Date().getFullYear();
                var qnum = CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
                // Round total price to nearest 500
                var totalPrice = Math.round(c.subtotal / 500) * 500;
                // Build one item per module with proportional price allocation
                var tw = P.modules.reduce(function(a, x) { return a + x.width; }, 0);
                var items = [];
                var priceAllocated = 0;
                P.modules.forEach(function(m, idx) {
                    var mh = (m.height || P.defaultHeight || 200);
                    // Proportional price by width
                    var proportion = tw > 0 ? m.width / tw : 1 / P.modules.length;
                    var mPrice;
                    if (idx === P.modules.length - 1) {
                        mPrice = totalPrice - priceAllocated; // last module gets remainder
                    } else {
                        mPrice = Math.round(totalPrice * proportion / 100) * 100;
                        priceAllocated += mPrice;
                    }
                    // Build description
                    var desc = m.name;
                    var matLine = P.matFrentes.name;
                    if (c.useDual) matLine += ' (frentes) / ' + P.matInterior.name + ' (interior)';
                    desc += '\nMaterial: ' + matLine;
                    var mcaj = typeof m.cajones === 'number' ? m.cajones : (m.type === 'modulo' ? 4 : 0);
                    if (mcaj > 0) desc += '\n' + mcaj + ' cajones';
                    else if (m.type === 'modulo') desc += '\n' + (typeof m.shelves === 'number' ? m.shelves : 3) + ' entrepaos';
                    if (m.doors) desc += m.tipon ? '\nPuertas con tip-on' : '\nCon puertas';
                    if (m.led && m.led.enabled) desc += '\nIluminacion LED';
                    desc += '\nHerrajes incluidos';
                    desc += '\nInstalacion incluida';
                    items.push({
                        name: m.name,
                        desc: desc,
                        dims: m.width + 'cm x ' + mh + 'cm',
                        price: mPrice,
                        qty: 1
                    });
                });
                S.pdfData = {
                    client: P.client || '',
                    projectName: (type ? type.n : 'Proyecto'),
                    location: '',
                    quoteNum: qnum,
                    deliveryTime: CONFIG.quoting.defaultDelivery,
                    anticipo: CONFIG.quoting.defaultAnticipo,
                    notes: '',
                    items: items
                };
            },
            setPdfField: function(key, val) {
                if (S.pdfData)
                    S.pdfData[key] = val;
            },
            setPdfItemPrice: function(idx, val) {
                if (S.pdfData && S.pdfData.items[idx])
                    S.pdfData.items[idx].price = val || 0;
                render();
            },
            setPdfItemDesc: function(idx, val) {
                if (S.pdfData && S.pdfData.items[idx])
                    S.pdfData.items[idx].desc = val;
            },
            editPiece: function(key, field, val) {
                if (!S.editedPieces[key])
                    S.editedPieces[key] = {};
                S.editedPieces[key][field] = val;
                render();
            },
            resetEdits: function() {
                S.editedPieces = {};
                render();
            },
            genClientPDF: function() {
                genClientPDF();
            },
            genInternalPDF: function() {
                genInternalPDF();
            },
            genDespiece: function() {
                genDespiece();
            },
            genQuickPDF: function(pdfType) {
                var t = TEMPLATES.find(function(x) {
                    return x.id === S.selTemplate;
                });
                if (!t)
                    return;
                var nw = S.quickWidth,
                    nh = S.quickHeight;
                var ratio = (nw * nh) / (t.baseWidth * t.baseHeight);
                var newPrice = Math.round(t.basePrice * ratio / 500) * 500;
                var matName = S.quickMatName || t.matName;
                var yr = new Date().getFullYear();
                var qnum = CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
                var desc = t.name + '\nMaterial: Melamina ' + matName + ' 16mm\nMedida: ' + (nw / 100) + 'm x ' + (nh / 100) + 'm';
                if (t.preModules) {
                    desc += '\n\nIncluye:';
                    t.preModules.forEach(function(pm) {
                        var mod = MODS[pm.type];
                        desc += '\n- ' + mod.n + ' ' + pm.width + 'cm';
                        if (pm.doors)
                            desc += pm.tipon ? ' con puertas tip-on' : ' con puertas';
                    });
                }
                if (t.hasLed)
                    desc += '\n- Iluminacion LED perimetral completa';
                if (t.hasGlass)
                    desc += '\n- Vidrio templado';
                desc += '\n- Herrajes incluidos\n- Instalacion incluida';
                S.pdfData = {
                    client: '',
                    projectName: t.name,
                    location: '',
                    quoteNum: qnum,
                    deliveryTime: t.weeks + ' semanas',
                    anticipo: CONFIG.quoting.defaultAnticipo,
                    notes: '',
                    items: [{
                        desc: desc,
                        dims: (nw / 100) + 'm x ' + (nh / 100) + 'm',
                        price: newPrice
                    }]
                };
                if (pdfType === 'client') {
                    genClientPDF();
                    return;
                }
                // For internal/despiece PDF, populate S.project from template so calc() works
                var savedProject = JSON.parse(JSON.stringify(S.project));
                try {
                    var widthRatio = nw / t.baseWidth;
                    var mat = {
                        brand: 'FINSA',
                        code: t.matCode || '74V',
                        name: matName,
                        finish: t.matFinish || 'Atlas',
                        precio: FINSA_PRICES[16],
                        thickness: 16
                    };
                    S.project.type = t.type || 'tv';
                    S.project.sameMaterial = true;
                    S.project.matFrentes = mat;
                    S.project.matInterior = mat;
                    S.project.defaultHeight = Math.round(nh / 10) * 10 || 200;
                    S.project.defaultDepth = 50;
                    S.project.laborCost = Math.round((t.laborCost || 5000) * ratio);
                    S.project.ledConfig = {
                        activation: 'dimmer',
                        lightTemp: 'calida'
                    };
                    S.project.glass = !!t.hasGlass;
                    S.project.glassM2 = t.hasGlass ? Math.round((nw / 100) * (nh / 100) * 0.3 * 10) / 10 : 0;
                    S.project.hardware = [];
                    S.project.modules = [];
                    if (t.preModules) {
                        t.preModules.forEach(function(pm) {
                            var scaledW = Math.round(pm.width * widthRatio / 10) * 10;
                            if (scaledW < 30)
                                scaledW = 30;
                            if (scaledW > 300)
                                scaledW = 300;
                            var ledObj = {
                                enabled: false,
                                edges: {
                                    top: false,
                                    bottom: false,
                                    left: false,
                                    right: false,
                                    shelves: false
                                },
                                shelfCount: 0,
                                ledMeters: 0,
                                segments: 0,
                                metersOverride: null,
                                segmentsOverride: null
                            };
                            if (t.hasLed) {
                                ledObj.enabled = true;
                                ledObj.edges.top = true;
                            }
                            S.project.modules.push({
                                id: uid(),
                                type: pm.type,
                                name: MODS[pm.type].n,
                                width: scaledW,
                                cajones: pm.cajones || 4,
                                doors: !!pm.doors,
                                tipon: !!pm.tipon,
                                shelves: pm.shelves || 3,
                                corrTier: pm.corrTier || 'corr_eco',
                                led: ledObj
                            });
                        });
                    }
                    if (pdfType === 'despiece')
                        genDespiece();
                    else
                        genInternalPDF();
                } catch (e) {
                    alert('Error generando PDF: ' + e.message);
                }
                S.project = savedProject;
            },
            // Copy
            copy: function() {
                var P = S.project,
                    c = calc(),
                    type = TYPES.find(function(t) {
                        return t.id === P.type;
                    }),
                    br = BRANDS[S.brand] || BRANDS.primary,
                    txt = '';
                if (S.view === 'quote') {
                    txt = br.name + '\n' + br.tagline + '\n\n';
                    txt += 'Fecha: ' + date() + '\nCliente: ' + (P.client || 'Sin nombre') + '\nProyecto: ' + (type ? type.n : '') + '\n\n';
                    txt += 'MODULOS:\n';
                    P.modules.forEach(function(m, i) {
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : (m.type === 'modulo' ? 4 : 0);
                        var extra = mcaj > 0 ? ' (' + mcaj + ' cajones)' : (m.type === 'modulo' ? ' (' + (typeof m.shelves === 'number' ? m.shelves : 3) + ' entrepaos)' : '');
                        txt += (i + 1) + '. ' + m.name + ' ' + m.width + 'cm' + (m.height ? ' x ' + m.height + 'cm' : '') + extra + (m.doors ? ' con puertas' : '') + '\n';
                    });
                    txt += '\nMaterial: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '\n';
                    if (c.ledBOM || P.glass) {
                        txt += '\nExtras:\n';
                        if (c.ledBOM)
                            txt += '- Iluminacion LED perimetral completa\n';
                        if (P.glass)
                            txt += '- Vidrio templado\n';
                    }
                    txt += '\nSubtotal: ' + fmt(c.subtotal) + '\nIVA ' + Math.round(CONFIG.pricing.iva * 100) + '%: ' + fmt(c.iva) + '\nTOTAL: ' + fmt(c.total) + '\n\n';
                    txt += CONFIG.quoting.defaultAnticipo + '% anticipo | Entrega ' + CONFIG.quoting.defaultDelivery + '\nIncluye instalacion\n\n' + CONTACT.cell + '\n' + CONTACT.email;
                } else {
                    txt = 'DESPIECE - ' + (BRANDS[S.brand] || BRANDS.primary).name + '\n\nFecha: ' + date() + '\nCliente: ' + (P.client || 'Sin nombre') + '\nMaterial: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '\n';
                    if (P.chapSpec)
                        txt += 'Chapacanto: ' + P.chapSpec + '\n';
                    txt += '\nHojas: ' + c.totalSheets + ' | Canto: ' + c.totalCanto + ' ml\n\n';
                    P.modules.forEach(function(m) {
                        var pcs = c.pieces.filter(function(p) {
                            return p.mid === m.id;
                        });
                        pcs.sort(function(a, b) {
                            var alA = anchoLargo(a.w, a.h),
                                alB = anchoLargo(b.w, b.h);
                            return alB.largo - alA.largo;
                        });
                        var mHdr = m.name + ' ' + m.width + 'cm';
                        if (m.height)
                            mHdr += ' x ' + m.height + 'cm';
                        txt += mHdr + '\n';
                        pcs.forEach(function(p) {
                            var al = anchoLargo(p.w, p.h);
                            var eKey = m.id + ':' + p.n;
                            var ep = S.editedPieces[eKey] || {};
                            var eq = typeof ep.q === 'number' ? ep.q : p.q;
                            var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                            var el2 = typeof ep.largo === 'number' ? ep.largo : al.largo;
                            txt += '  ' + p.n + ': ' + eq + 'x  Ancho:' + ea + ' Largo:' + el2 + 'mm (' + p.t + 'mm)\n';
                        });
                        txt += '\n';
                    });
                    txt += 'HERRAJES:\n';
                    c.allHW.forEach(function(hw) {
                        txt += '- ' + hw.desc + ': ' + Math.ceil(hw.qty) + ' (' + hw.marca + ')\n';
                    });
                }
                navigator.clipboard.writeText(txt).then(function() {
                    S.copied = true;
                    render();
                    setTimeout(function() {
                        S.copied = false;
                        render();
                    }, 2000);
                });
            },
            // === V2.3: Closet Estandarizado Methods ===
            newEstandarizado: function() {
                S.screen = 'estandarizado';
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                S.estProject = defaultEstProject();
                S.estPdfData = null;
                scrollY = 0;
                render();
            },
            estGoStep: function(step) {
                var steps = ['builder', 'editor', 'material', 'summary'];
                var ci = steps.indexOf(S.estScreen);
                var ti = steps.indexOf(step);
                if (ti <= ci) {
                    S.estScreen = step;
                    if (step === 'builder')
                        S.estEditIdx = -1;
                    scrollY = 0;
                    render();
                }
            },
            estNext: function() {
                var steps = ['builder', 'editor', 'material', 'summary'];
                var ci = steps.indexOf(S.estScreen);
                if (S.estScreen === 'builder' && S.estProject.modules.length === 0)
                    return;
                if (S.estScreen === 'builder') {
                    // If haven't edited any module, go to editor of first module
                    S.estEditIdx = 0;
                    S.estScreen = 'editor';
                } else if (ci < steps.length - 1) {
                    S.estScreen = steps[ci + 1];
                }
                scrollY = 0;
                render();
            },
            estPrev: function() {
                var steps = ['builder', 'editor', 'material', 'summary'];
                var ci = steps.indexOf(S.estScreen);
                if (ci > 0) {
                    S.estScreen = steps[ci - 1];
                    if (S.estScreen === 'builder')
                        S.estEditIdx = -1;
                    scrollY = 0;
                    render();
                }
            },
            estSetClient: function(v) {
                S.estProject.client = v;
            },
            // Modules
            estAddMod: function(modType) {
                S.estProject.modules.push(defaultEstModule(modType));
                scrollY = 0;
                render();
            },
            estDuplicateModules: function() {
                var EP = S.estProject;
                if (EP.modules.length === 0)
                    return;
                var clones = JSON.parse(JSON.stringify(EP.modules));
                clones.forEach(function(m) {
                    m.id = uid();
                    if (m.name)
                        m.name = m.name + ' (Copia)';
                    if (m.zones)
                        m.zones.forEach(function(z) {
                            z.id = uid();
                        });
                });
                EP.modules = EP.modules.concat(clones);
                scrollY = 0;
                render();
            },
            estDelMod: function(idx) {
                S.estProject.modules.splice(idx, 1);
                if (S.estEditIdx >= S.estProject.modules.length)
                    S.estEditIdx = S.estProject.modules.length - 1;
                render();
            },
            estMoveMod: function(idx, dir) {
                var mods = S.estProject.modules;
                var ni = idx + dir;
                if (ni < 0 || ni >= mods.length)
                    return;
                var tmp = mods[idx];
                mods[idx] = mods[ni];
                mods[ni] = tmp;
                render();
            },
            estEditMod: function(idx) {
                S.estEditIdx = idx;
                S.estScreen = 'editor';
                scrollY = 0;
                render();
            },
            estBackToBuilder: function() {
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                scrollY = 0;
                render();
            },
            estSetWidth: function(idx, w) {
                var m = S.estProject.modules[idx];
                if (m) {
                    m.width = w;
                    render();
                }
            },
            estSetCustomWidth: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (EST_WIDTHS.indexOf(m.width) !== -1)
                    m.width = 45;
                render();
            },
            estSetModHeight: function(idx, h) {
                var m = S.estProject.modules[idx];
                var minH = m && m.type === 'fijo' ? 5 : 50;
                if (m) {
                    m.height = Math.max(minH, Math.min(300, h || 200));
                    render();
                }
            },
            estSetProjectDepth: function(d) {
                S.estProject.projectDepth = Math.max(30, Math.min(120, d || 60));
                render();
            },
            estSetProjectType: function(typeId) {
                S.estProject.projectType = typeId;
                render();
            },
            estTogSameDepth: function() {
                S.estProject.sameDepth = !S.estProject.sameDepth;
                render();
            },
            estSetModDepth: function(idx, d) {
                var m = S.estProject.modules[idx];
                if (m) { m.depth = Math.max(20, Math.min(120, d || 60)); render(); }
            },
            estTogMarco: function(idx) {
                var m = S.estProject.modules[idx];
                if (m) { m.marco = !m.marco; render(); }
            },
            // Zones
            estAddZone: function(idx, type) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                // panelTV has no zones
                if (m.type === 'panelTV')
                    return;
                // Especial modules: entrepaos and colgador allowed
                if (m.type === 'especial' && type !== 'entrepa' && type !== 'colgador')
                    return;
                var z = {
                    id: uid(),
                    type: type
                };
                if (type === 'cajones') {
                    z.count = 3;
                    z.cajonHeight = 20;
                }
                else if (type === 'colgador') {
                    z.tubos = 1;
                }
                else if (type === 'zapatero') {
                    z.repisas = 3;
                    z.repisaHeight = 15;
                }
                else if (type === 'entrepa') {
                    z.count = 2;
                }
                m.zones.push(z);
                render();
            },
            estDelZone: function(idx, zi) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones.splice(zi, 1);
                render();
            },
            estMoveZone: function(idx, zi, dir) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                var ni = zi + dir;
                if (ni < 0 || ni >= m.zones.length)
                    return;
                var tmp = m.zones[zi];
                m.zones[zi] = m.zones[ni];
                m.zones[ni] = tmp;
                render();
            },
            estSetZoneCount: function(idx, zi, n) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].count = n;
                render();
            },
            estSetZoneHeight: function(idx, zi, h) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].cajonHeight = h;
                render();
            },
            estSetZoneTubos: function(idx, zi, n) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].tubos = n;
                render();
            },
            estSetZoneRepisas: function(idx, zi, n) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].repisas = n;
                render();
            },
            estSetZoneRepisaHeight: function(idx, zi, h) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].repisaHeight = h;
                render();
            },
            estSetWidth2: function(idx, w) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.width2 = w;
                render();
            },
            // Module-level door controls
            estTogDoors: function(idx, enabled, mode) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.doors = enabled;
                if (mode)
                    m.doorMode = mode;
                if (!enabled)
                    m.quoteMode = 'completo';
                if (enabled && !m.doorMaterial)
                    m.doorMaterial = 'melamina';
                if (enabled && !m.doorType)
                    m.doorType = 'tipon';
                if (enabled && !m.doorCount)
                    m.doorCount = 2;
                // When switching to completa, clear per-zone doors
                if (mode === 'completa') {
                    m.zones.forEach(function(z) {
                        z.doors = false;
                    });
                }
                render();
            },
            estSetQuoteMode: function(idx, mode) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.quoteMode = mode;
                if (mode === 'solo_puertas') {
                    m.doors = true;
                    if (!m.doorMode)
                        m.doorMode = 'completa';
                    if (!m.doorMaterial)
                        m.doorMaterial = 'melamina';
                    if (!m.doorType)
                        m.doorType = 'tipon';
                    if (!m.doorCount)
                        m.doorCount = 2;
                }
                render();
            },
            estSetDoorCount: function(idx, cnt) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.doorCount = cnt;
                render();
            },
            estSetDoorMat: function(idx, mat) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.doorMaterial = mat;
                render();
            },
            estSetDoorType2: function(idx, type) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.doorType = type;
                render();
            },
            // Zone doors
            estSetZoneDoor: function(idx, zi, bool) {
                var m = S.estProject.modules[idx];
                if (!m || !m.zones[zi])
                    return;
                m.zones[zi].doors = bool;
                if (bool && !m.zones[zi].doorMaterial)
                    m.zones[zi].doorMaterial = 'melamina';
                if (bool && !m.zones[zi].doorType)
                    m.zones[zi].doorType = 'tipon';
                render();
            },
            estSetZoneDoorMat: function(idx, zi, mat) {
                var m = S.estProject.modules[idx];
                if (!m || !m.zones[zi])
                    return;
                m.zones[zi].doorMaterial = mat;
                render();
            },
            estSetZoneDoorType: function(idx, zi, type) {
                var m = S.estProject.modules[idx];
                if (!m || !m.zones[zi])
                    return;
                m.zones[zi].doorType = type;
                render();
            },
            // Maletero doors
            estSetMaleteroDoor: function(idx, bool) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.maletero)
                    m.maletero = {
                        enabled: true,
                        height: 30
                    };
                m.maletero.doors = bool;
                if (bool && !m.maletero.doorMaterial)
                    m.maletero.doorMaterial = 'melamina';
                if (bool && !m.maletero.doorType)
                    m.maletero.doorType = 'tipon';
                render();
            },
            estSetMaleteroDoorMat: function(idx, mat) {
                var m = S.estProject.modules[idx];
                if (!m || !m.maletero)
                    return;
                m.maletero.doorMaterial = mat;
                render();
            },
            estSetMaleteroDoorType: function(idx, type) {
                var m = S.estProject.modules[idx];
                if (!m || !m.maletero)
                    return;
                m.maletero.doorType = type;
                render();
            },
            // Zoclo
            estTogZoclo: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.zoclo)
                    m.zoclo = {
                        enabled: false,
                        height: 10
                    };
                m.zoclo.enabled = !m.zoclo.enabled;
                render();
            },
            estSetZocloHeight: function(idx, h) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.zoclo)
                    m.zoclo = {
                        enabled: true,
                        height: 10
                    };
                m.zoclo.height = Math.max(5, Math.min(25, h || 10));
                render();
            },
            // Maletero
            estTogMaletero: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.maletero)
                    m.maletero = {
                        enabled: false,
                        height: 30
                    };
                m.maletero.enabled = !m.maletero.enabled;
                render();
            },
            estSetMaleteroHeight: function(idx, h) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.maletero)
                    m.maletero = {
                        enabled: true,
                        height: 30
                    };
                m.maletero.height = Math.max(10, Math.min(100, h || 30));
                render();
            },
            // Paint (estandarizado)
            estTogPaint: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.paint)
                    m.paint = {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    };
                m.paint.enabled = !m.paint.enabled;
                render();
            },
            estSetPaintName: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.paint)
                    return;
                m.paint.name = v;
            },
            estSetPaintPrice: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.paint)
                    return;
                m.paint.pricePerLiter = Math.max(0, v || 0);
                render();
            },
            estSetPaintCoats: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.paint)
                    return;
                m.paint.coats = Math.max(1, Math.min(5, v || 2));
                render();
            },
            estSetPaintScope: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.paint)
                    return;
                m.paint.scope = v;
                render();
            },
            // Chapacanto
            estSetChapMode: function(idx, mode) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.chap)
                    m.chap = {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    };
                if (mode === 'perimetrico') {
                    m.chap.mode = 'perimetrico';
                    m.chap.edges = {
                        latIzq: true,
                        latDer: true,
                        techo: true,
                        piso: true,
                        fondo: false
                    };
                } else {
                    m.chap.mode = 'individual';
                }
                render();
            },
            estTogChapEdge: function(idx, edge) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.chap)
                    m.chap = {
                        mode: 'individual',
                        edges: {
                            latIzq: false,
                            latDer: false,
                            techo: false,
                            piso: false,
                            fondo: false
                        }
                    };
                m.chap.edges[edge] = !m.chap.edges[edge];
                m.chap.mode = 'individual';
                // Check if all 4 perimetric are on
                var e = m.chap.edges;
                if (e.latIzq && e.latDer && e.techo && e.piso)
                    m.chap.mode = 'perimetrico';
                render();
            },
            // Material
            estTogSameMat: function() {
                var EP = S.estProject;
                EP.sameMaterial = !EP.sameMaterial;
                if (EP.sameMaterial)
                    EP.matInterior = JSON.parse(JSON.stringify(EP.matFrentes));
                render();
            },
            estSetMatFrentes: function(val) {
                var EP = S.estProject,
                    parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    EP.matFrentes.name = rest;
                    if (EP.sameMaterial)
                        EP.matInterior = JSON.parse(JSON.stringify(EP.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    EP.matFrentes.customPrice = parseFloat(rest) || 0;
                    if (EP.sameMaterial)
                        EP.matInterior = JSON.parse(JSON.stringify(EP.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    EP.matFrentes = {
                        brand: 'CUSTOM',
                        code: '',
                        name: EP.matFrentes.brand === 'CUSTOM' ? EP.matFrentes.name : '',
                        finish: '',
                        customPrice: EP.matFrentes.brand === 'CUSTOM' ? EP.matFrentes.customPrice : 0,
                        thickness: EP.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        EP.matFrentes = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[EP.thickness],
                            thickness: EP.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        EP.matFrentes = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: EP.thickness
                        };
                }
                if (EP.sameMaterial)
                    EP.matInterior = JSON.parse(JSON.stringify(EP.matFrentes));
                render();
            },
            estSetMatInterior: function(val) {
                var EP = S.estProject,
                    parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    EP.matInterior.name = rest;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    EP.matInterior.customPrice = parseFloat(rest) || 0;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    EP.matInterior = {
                        brand: 'CUSTOM',
                        code: '',
                        name: EP.matInterior.brand === 'CUSTOM' ? EP.matInterior.name : '',
                        finish: '',
                        customPrice: EP.matInterior.brand === 'CUSTOM' ? EP.matInterior.customPrice : 0,
                        thickness: EP.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        EP.matInterior = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[EP.thickness],
                            thickness: EP.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        EP.matInterior = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: EP.thickness
                        };
                }
                render();
            },
            estSetThick: function(t) {
                S.estProject.thickness = t;
                render();
            },
            estSetCustomThick: function() {
                if ([16, 18, 25].indexOf(S.estProject.thickness) !== -1)
                    S.estProject.thickness = 12;
                render();
            },
            estSetChapPrice: function(v) {
                S.estProject.chapFrentesPrice = v || 0;
                if (S.estProject.sameMaterial)
                    S.estProject.chapInteriorPrice = v || 0;
                render();
            },
            estSetChapPriceI: function(v) {
                S.estProject.chapInteriorPrice = v || 0;
                render();
            },
            estSetEnchapPrice: function(v) {
                S.estProject.enchapPrice = Math.max(0, v || 0);
                render();
            },
            estSetLabor: function(v) {
                S.estProject.laborCost = Math.max(0, v || 0);
                render();
            },
            estSetMultiplier: function(v) {
                S.estProject.saleMultiplier = Math.max(1, Math.min(10, Math.round((v || CONFIG.pricing.defaultSaleMultiplier) * 10) / 10));
                render();
            },
            // LED
            estTogModLed: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.led)
                    m.led = {
                        enabled: false,
                        edges: {
                            top: false,
                            bottom: false,
                            left: false,
                            right: false,
                            shelves: false
                        },
                        shelfCount: 0,
                        metersOverride: null,
                        segmentsOverride: null
                    };
                m.led.enabled = !m.led.enabled;
                render();
            },
            estTogLedEdge: function(idx, edge) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.edges[edge] = !m.led.edges[edge];
                render();
            },
            estTogLedShelves: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.edges.shelves = !m.led.edges.shelves;
                if (!m.led.edges.shelves)
                    m.led.shelfCount = 0;
                else if (m.led.shelfCount === 0)
                    m.led.shelfCount = 1;
                render();
            },
            estSetLedShelves: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.shelfCount = Math.max(0, Math.min(10, v || 0));
                render();
            },
            estSetLedMeters: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.metersOverride = Math.max(0, v || 0);
                render();
            },
            estSetLedSegments: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.segmentsOverride = Math.max(0, v || 0);
                render();
            },
            estResetLedOverride: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.metersOverride = null;
                m.led.segmentsOverride = null;
                render();
            },
            estSetLedActivation: function(k) {
                S.estProject.ledConfig.activation = k;
                render();
            },
            estSetLedTemp: function(k) {
                S.estProject.ledConfig.lightTemp = k;
                render();
            },
            // HW overrides
            estHwQty: function(key, delta) {
                var EP = S.estProject;
                if (!EP.hwOverrides)
                    EP.hwOverrides = {};
                // Run calc to get auto qty
                var c = calcEstandarizado();
                var hw = c.hwConsolidated[key];
                if (!hw)
                    return;
                var currentQty = Math.ceil(hw.qty);
                var newQty = Math.max(0, currentQty + delta);
                if (!EP.hwOverrides[key])
                    EP.hwOverrides[key] = {};
                EP.hwOverrides[key].qty = newQty;
                render();
            },
            estHwSwap: function(key) {
                var def = HW_DEFAULTS[key];
                if (!def)
                    return;
                S.estHwSwapKey = key;
                S.showHWPicker = true;
                S.hwFilter = {
                    marca: '',
                    cat: def.cat,
                    q: ''
                };
                render();
                setTimeout(function() {
                    var i = $('hwSearchInput');
                    if (i)
                        i.focus();
                }, 100);
            },
            estHwReset: function(key) {
                var EP = S.estProject;
                if (!EP.hwOverrides)
                    return;
                delete EP.hwOverrides[key];
                render();
            },
            estHwQtySet: function(key, qty) {
                var EP = S.estProject;
                if (!EP.hwOverrides)
                    EP.hwOverrides = {};
                if (isNaN(qty) || qty < 0)
                    qty = 0;
                if (!EP.hwOverrides[key])
                    EP.hwOverrides[key] = {};
                EP.hwOverrides[key].qty = qty;
                render();
            },
            // Per-module HW overrides
            estModHwQty: function(idx, key, delta, absVal) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.hwOverrides)
                    m.hwOverrides = {};
                // Get current auto qty for this module+key
                var c = calcEstandarizado();
                var modEntries = c.autoHW.filter(function(ah) {
                    return ah.modId === m.id && ah.key === key;
                });
                var autoTotal = modEntries.reduce(function(a, e) {
                    return a + e.q;
                }, 0);
                var current = typeof m.hwOverrides[key] === 'number' ? m.hwOverrides[key] : autoTotal;
                var newQty;
                if (typeof absVal === 'number') {
                    newQty = Math.max(0, absVal);
                }
                else {
                    newQty = Math.max(0, current + delta);
                }
                m.hwOverrides[key] = newQty;
                render();
            },
            estModHwReset: function(idx, key) {
                var m = S.estProject.modules[idx];
                if (!m || !m.hwOverrides)
                    return;
                delete m.hwOverrides[key];
                if (Object.keys(m.hwOverrides).length === 0)
                    delete m.hwOverrides;
                render();
            },
            // Vidrio price setters
            estSetZoneVidrioPrice: function(idx, zi, price) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                var z = m.zones[zi];
                if (!z)
                    return;
                z.vidrioPrice = price;
                render();
            },
            estSetVidrioPrice: function(idx, price) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.vidrioPrice = price;
                render();
            },
            estSetMaleteroVidrioPrice: function(idx, price) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.maletero)
                    return;
                m.maletero.vidrioPrice = price;
                render();
            },
            // PDF Generation
            estInitPdfData: function() {
                var EP = S.estProject,
                    c = calcEstandarizado();
                var isCustom = EP.mode === 'custom';
                var projName = isCustom ? 'Proyecto Personalizado' : 'Closet Estandarizado';
                var yr = new Date().getFullYear();
                var qnum = CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
                var tw = EP.modules.reduce(function(a, m2) {
                    return a + m2.width;
                }, 0);
                var desc = projName + '\nMaterial: ' + EP.matFrentes.name;
                if (!EP.sameMaterial)
                    desc += ' (frentes) / ' + EP.matInterior.name + ' (interior)';
                desc += '\n\nIncluye:';
                EP.modules.forEach(function(m, i) {
                    var line = '\n- M\u00f3dulo ' + (i + 1);
                    if (m.type === 'esquinero')
                        line += ' Esquinero ' + m.width + '\u00d7' + (m.width2 || m.width) + 'cm';
                    else if (m.type === 'fijo')
                        line += ' Fijo ' + m.width + '\u00d7' + m.height + 'cm';
                    else if (m.type === 'panelTV')
                        line += ' Panel TV ' + m.width + 'cm';
                    else if (m.type === 'torreLateral')
                        line += ' Torre Lat. ' + m.width + 'cm';
                    else
                        line += ' ' + m.width + 'cm';
                    if (isCustom)
                        line += ' \u00d7 ' + m.height + 'cm alto';
                    m.zones.forEach(function(z) {
                        if (z.type === 'cajones')
                            line += ', ' + (z.count || 3) + ' cajones';
                        else if (z.type === 'colgador')
                            line += ', colgador sencillo';
                        else if (z.type === 'zapatero')
                            line += ', ' + (z.repisas || 3) + ' cajones ext. ' + (z.repisaHeight || 15) + 'cm';
                        else if (z.type === 'entrepa')
                            line += ', ' + (z.count || 2) + ' entrepa\u00f1os';
                    });
                    if (m.doors) {
                        var dMode = m.doorMode || 'por_zona';
                        if (dMode === 'completa')
                            line += ', ' + (m.doorCount || 2) + ' puerta' + ((m.doorCount || 2) > 1 ? 's' : '') + ' completa' + ((m.doorCount || 2) > 1 ? 's' : '');
                        else
                            line += ', puertas por zona';
                    }
                    var malWa = m.maletero || {
                        enabled: false
                    };
                    if (malWa.enabled)
                        line += ', maletero ' + (malWa.height || 30) + 'cm';
                    desc += line;
                });
                desc += '\n- Herrajes incluidos\n- Instalaci\u00f3n incluida';
                var totalPrice = Math.round(c.subtotal / 500) * 500;
                var dimsStr = isCustom ? (tw / 100) + 'm ancho (alturas variables)' : (tw / 100) + 'm ancho \u00d7 2.00m alto';
                S.estPdfData = {
                    client: EP.client || '',
                    projectName: projName,
                    location: '',
                    quoteNum: qnum,
                    deliveryTime: CONFIG.quoting.defaultDelivery,
                    anticipo: CONFIG.quoting.defaultAnticipo,
                    notes: '',
                    items: [{
                        desc: desc,
                        dims: dimsStr,
                        price: totalPrice
                    }]
                };
            },
            estUploadPlano: function(input) {
                if (!input.files || !input.files[0])
                    return;
                var file = input.files[0];
                if (!file.type.match(/image\/(jpeg|png|jpg)/)) {
                    alert('Solo se aceptan im\u00e1genes JPG o PNG');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    alert('La imagen es muy grande (m\u00e1x 10MB)');
                    return;
                }
                var reader = new FileReader();
                reader.onload = function(e) {
                    S.estProject.planoImage = e.target.result;
                    render();
                };
                reader.readAsDataURL(file);
            },
            estRemovePlano: function() {
                S.estProject.planoImage = null;
                render();
            },
            // Saved Projects
            saveProject: function(silent) {
                var EP = S.estProject;
                var saved = loadSavedProjects();
                var clone = JSON.parse(JSON.stringify(EP));
                clone.planoImage = null;
                delete clone._saveId;
                var isCustom = EP.mode === 'custom';
                var entry = {
                    id: EP._saveId || uid(),
                    savedAt: new Date().toISOString(),
                    client: EP.client || 'Sin nombre',
                    label: (isCustom ? 'Proyecto Personalizado' : 'Closet Estandarizado') + ' - ' + EP.modules.length + ' m\u00f3dulo' + (EP.modules.length !== 1 ? 's' : ''),
                    moduleCount: EP.modules.length,
                    project: clone
                };
                EP._saveId = entry.id;
                // Update local list
                var existIdx = -1;
                for (var i = 0; i < saved.length; i++) {
                    if (saved[i].id === entry.id) {
                        existIdx = i;
                        break;
                    }
                }
                if (existIdx >= 0) {
                    saved[existIdx] = entry;
                } else {
                    saved.unshift(entry);
                }
                if (saved.length > 20)
                    saved = saved.slice(0, 20);
                saveSavedProjects(saved);
                // Sync to cloud
                cloudSaveProject(entry);
                if (!silent)
                    alert('Proyecto guardado en la nube');
            },
            loadSavedProject: function(idx) {
                var saved = loadSavedProjects();
                if (!saved[idx])
                    return;
                var proj = JSON.parse(JSON.stringify(saved[idx].project));
                proj.planoImage = null;
                proj._saveId = saved[idx].id;
                S.estProject = proj;
                S.screen = 'estandarizado';
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                S.estPdfData = null;
                scrollY = 0;
                render();
            },
            deleteSavedProject: function(idx) {
                var saved = loadSavedProjects();
                if (!saved[idx])
                    return;
                if (!confirm('\u00bfEliminar proyecto "' + saved[idx].client + '"?'))
                    return;
                var deletedId = saved[idx].id;
                saved.splice(idx, 1);
                saveSavedProjects(saved);
                cloudDeleteProject(deletedId);
                render();
            },
            estGenClientPDF: function() {
                APP.estInitPdfData();
                var savedPdf = S.pdfData;
                S.pdfData = S.estPdfData;
                genClientPDF(S.estProject, calcEstandarizado());
                S.pdfData = savedPdf;
                APP.saveProject(true);
            },
            estGenInternalPDF: function() {
                APP.estInitPdfData();
                genEstInternalPDF();
                APP.saveProject(true);
            }
        };

        render();

        // Dynamic title and favicon from CONFIG
        document.title = CONFIG.brand.name + ' - Cotizador';
        try {
            var fav = document.getElementById('dynamic-favicon');
            if (fav) fav.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text x='50' y='65' font-size='" + (CONFIG.brand.mono.length > 3 ? '30' : '40') + "' text-anchor='middle' fill='%23c49a6c'>" + encodeURIComponent(CONFIG.brand.mono) + "</text></svg>";
        } catch (e) {}

        // PWA: Inline manifest
        try {
            var manifest = {
                name: CONFIG.brand.name + ' Cotizador',
                short_name: CONFIG.brand.mono + ' Cotizador',
                start_url: window.location.href,
                display: 'standalone',
                background_color: '#1a1a2e',
                theme_color: '#c49a6c',
                icons: [{
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text x='50' y='65' font-size='" + (CONFIG.brand.mono.length > 3 ? '30' : '40') + "' text-anchor='middle' fill='%23c49a6c'>" + encodeURIComponent(CONFIG.brand.mono) + "</text></svg>",
                    sizes: '192x192',
                    type: 'image/svg+xml'
                }]
            };
            var mBlob = new Blob([JSON.stringify(manifest)], {
                type: 'application/json'
            });
            var mLink = document.createElement('link');
            mLink.rel = 'manifest';
            mLink.href = URL.createObjectURL(mBlob);
            document.head.appendChild(mLink);
        } catch (e) {}

        // PWA: Service Worker
        if ('serviceWorker' in navigator) {
            try {
                var swCode = "var CACHE='" + CONFIG.pwa.cacheName + "';self.addEventListener('install',function(e){self.skipWaiting();e.waitUntil(caches.open(CACHE).then(function(c){return c.addAll([self.location.origin+self.location.pathname])}))});self.addEventListener('activate',function(e){e.waitUntil(caches.keys().then(function(ks){return Promise.all(ks.filter(function(k){return k!==CACHE}).map(function(k){return caches.delete(k)}))}));self.clients.claim()});self.addEventListener('fetch',function(e){e.respondWith(fetch(e.request).catch(function(){return caches.match(e.request)}))});";
                var swBlob = new Blob([swCode], {
                    type: 'application/javascript'
                });
                navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(function() {});
            } catch (e) {}
        }
    })();
    </script>
</body>
</html>
