<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Cotizador v2.0 — Iteration 3</title>
    <meta name="theme-color" content="#0F172A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cotizador">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" id="dynamic-favicon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230F172A'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='%23E2E8F0'>COT</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="jspdf.umd.min.js"></script>
    <script src="jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <style>
    /* ═══════════════════════════════════════════════════════════════
       RENOVA DESIGN SYSTEM v2.0 — Premium Architectural B2B SaaS
       Target: Architects, Contractors, Furniture Business Owners
       Style: Minimalism + Flat Design | WCAG AAA
       Font: Plus Jakarta Sans + JetBrains Mono (data)
       ═══════════════════════════════════════════════════════════════ */

    :root {
        /* ── Core Palette ── */
        --color-bg:             #F8FAFC;
        --color-bg-elevated:    #FFFFFF;
        --color-bg-sunken:      #F1F5F9;
        --color-bg-overlay:     rgba(15, 23, 42, 0.60);

        /* Surface layers */
        --color-surface-1:      #FFFFFF;
        --color-surface-2:      #F8FAFC;
        --color-surface-3:      #F1F5F9;
        --color-surface-hover:  #E2E8F0;

        /* Text hierarchy */
        --color-text-primary:   #0F172A;
        --color-text-secondary: #475569;
        --color-text-tertiary:  #94A3B8;
        --color-text-inverse:   #F8FAFC;
        --color-text-on-accent: #FFFFFF;

        /* Accent — high-visibility electric blue */
        --color-accent:         #0369A1;
        --color-accent-hover:   #0284C7;
        --color-accent-subtle:  rgba(3, 105, 161, 0.08);
        --color-accent-border:  rgba(3, 105, 161, 0.25);

        /* Borders */
        --color-border:         #E2E8F0;
        --color-border-strong:  #CBD5E1;
        --color-border-subtle:  #F1F5F9;

        /* Semantic */
        --color-success:        #059669;
        --color-success-subtle: rgba(5, 150, 105, 0.08);
        --color-warning:        #D97706;
        --color-warning-subtle: rgba(217, 119, 6, 0.08);
        --color-danger:         #DC2626;
        --color-danger-subtle:  rgba(220, 38, 38, 0.08);
        --color-info:           #0284C7;
        --color-info-subtle:    rgba(2, 132, 199, 0.08);

        /* ── Typography ── */
        --font-sans:   'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        --font-mono:   'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;

        --text-xs:     0.6875rem;   /* 11px */
        --text-sm:     0.8125rem;   /* 13px */
        --text-base:   0.875rem;    /* 14px */
        --text-md:     0.9375rem;   /* 15px */
        --text-lg:     1.125rem;    /* 18px */
        --text-xl:     1.25rem;     /* 20px */
        --text-2xl:    1.5rem;      /* 24px */
        --text-3xl:    2rem;        /* 32px */

        --leading-tight:  1.25;
        --leading-normal: 1.5;
        --leading-relaxed:1.625;

        --weight-normal:  400;
        --weight-medium:  500;
        --weight-semi:    600;
        --weight-bold:    700;
        --weight-extra:   800;

        /* ── Spacing (4px base) ── */
        --space-1:  4px;
        --space-2:  8px;
        --space-3:  12px;
        --space-4:  16px;
        --space-5:  20px;
        --space-6:  24px;
        --space-8:  32px;
        --space-10: 40px;

        /* ── Radii ── */
        --radius-sm:  4px;
        --radius-md:  6px;
        --radius-lg:  8px;
        --radius-xl:  12px;
        --radius-2xl: 16px;
        --radius-full:9999px;

        /* ── Shadows ── */
        --shadow-xs:  0 1px 2px rgba(15,23,42,0.05);
        --shadow-sm:  0 1px 3px rgba(15,23,42,0.08), 0 1px 2px rgba(15,23,42,0.04);
        --shadow-md:  0 4px 6px -1px rgba(15,23,42,0.08), 0 2px 4px -2px rgba(15,23,42,0.04);
        --shadow-lg:  0 10px 15px -3px rgba(15,23,42,0.08), 0 4px 6px -4px rgba(15,23,42,0.04);
        --shadow-xl:  0 20px 25px -5px rgba(15,23,42,0.10), 0 8px 10px -6px rgba(15,23,42,0.04);

        /* ── Transitions ── */
        --ease-default: cubic-bezier(0.4, 0, 0.2, 1);
        --duration-fast: 150ms;
        --duration-base: 200ms;
        --duration-slow: 300ms;

        /* ── Z-index scale ── */
        --z-dropdown: 50;
        --z-sticky:   60;
        --z-modal:    100;
        --z-picker:   150;
        --z-settings: 160;
        --z-imgmodal:  200;
        --z-setup:    10000;

        /* ── Focus ring ── */
        --focus-ring: 0 0 0 2px var(--color-bg), 0 0 0 4px var(--color-accent);
    }

    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* ═══ RESET ═══ */
    * {
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;
        margin: 0;
        padding: 0
    }

    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        background: var(--color-bg);
        color: var(--color-text-primary);
        font-family: var(--font-sans);
        font-size: var(--text-base);
        line-height: var(--leading-normal);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale
    }
    /* ═══ APP SHELL ═══ */
    #app {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden
    }

    .hdr {
        background: var(--color-bg-elevated);
        border-bottom: 1px solid var(--color-border);
        padding: var(--space-3) var(--space-4);
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow-xs)
    }

    .hdr-logo {
        width: 40px;
        height: 40px;
        background: var(--color-accent);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--weight-bold);
        color: var(--color-text-on-accent);
        cursor: pointer;
        font-size: var(--text-sm)
    }

    .hdr-txt {
        margin-left: var(--space-3);
        flex: 1
    }

    .hdr-txt h1 {
        font-size: var(--text-lg);
        font-weight: var(--weight-bold);
        line-height: var(--leading-tight);
        color: var(--color-text-primary)
    }

    .hdr-txt p {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary)
    }

    .hdr-btn {
        padding: var(--space-2);
        border-radius: var(--radius-lg);
        background: none;
        border: none;
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: color var(--duration-fast) var(--ease-default), background var(--duration-fast) var(--ease-default)
    }

    .hdr-btn:hover {
        color: var(--color-text-primary);
        background: var(--color-surface-hover)
    }

    .hdr-btn:focus-visible {
        outline: none;
        box-shadow: var(--focus-ring)
    }

    .hdr-actions {
        display: flex;
        gap: var(--space-1)
    }

    /* ═══ STEP INDICATOR ═══ */
    .steps {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-4);
        background: var(--color-bg-elevated);
        border-bottom: 1px solid var(--color-border)
    }

    .step-dot {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--weight-bold);
        font-size: var(--text-base);
        border: none;
        cursor: pointer;
        transition: all var(--duration-fast) var(--ease-default)
    }

    .step-dot.active {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        transform: scale(1.1);
        box-shadow: 0 0 0 3px var(--color-accent-subtle)
    }

    .step-dot.done {
        background: var(--color-accent-subtle);
        color: var(--color-accent)
    }

    .step-dot.future {
        background: var(--color-surface-3);
        color: var(--color-text-tertiary);
        cursor: default
    }

    .step-line {
        width: 32px;
        height: 3px;
        border-radius: 2px;
        background: var(--color-border)
    }

    .step-line.done {
        background: var(--color-accent-subtle)
    }

    /* ═══ CONTENT AREA ═══ */
    .content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: var(--space-4);
        background: var(--color-bg)
    }

    /* ═══ NAV FOOTER ═══ */
    .nav {
        display: flex;
        gap: var(--space-3);
        padding: var(--space-4);
        background: var(--color-bg-elevated);
        border-top: 1px solid var(--color-border);
        box-shadow: 0 -1px 3px rgba(15,23,42,0.04)
    }

    .nav-btn {
        flex: 1;
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        font-weight: var(--weight-semi);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        font-size: 1rem;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .nav-btn:focus-visible {
        outline: none;
        box-shadow: var(--focus-ring)
    }

    .nav-btn.back {
        background: var(--color-surface-3);
        color: var(--color-text-primary)
    }

    .nav-btn.back:hover {
        background: var(--color-surface-hover)
    }

    .nav-btn.next {
        background: var(--color-accent);
        color: var(--color-text-on-accent)
    }

    .nav-btn.next:hover {
        background: var(--color-accent-hover)
    }

    .nav-btn:disabled {
        background: var(--color-surface-3);
        color: var(--color-text-tertiary);
        cursor: not-allowed
    }
    /* ═══ TITLES & FIELDS ═══ */
    .title {
        text-align: center;
        padding: var(--space-4) 0
    }

    .title h2 {
        font-size: var(--text-2xl);
        font-weight: var(--weight-bold);
        color: var(--color-text-primary)
    }

    .title p {
        color: var(--color-text-secondary);
        margin-top: var(--space-1);
        font-size: var(--text-base)
    }

    .field {
        margin-bottom: var(--space-5)
    }

    .field label {
        display: block;
        font-size: var(--text-sm);
        font-weight: var(--weight-medium);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-2);
        letter-spacing: 0.01em
    }

    .field input, .field select {
        width: 100%;
        padding: 12px var(--space-4);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        font-size: var(--text-md);
        font-family: var(--font-sans);
        transition: border-color var(--duration-fast) var(--ease-default), box-shadow var(--duration-fast) var(--ease-default)
    }

    .field input:hover, .field select:hover {
        border-color: var(--color-border-strong)
    }

    .field input:focus, .field select:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    .field input::placeholder {
        color: var(--color-text-tertiary)
    }

    .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-3)
    }

    /* ═══ TYPE & THICKNESS BUTTONS ═══ */
    .type-btn {
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        border: 1px solid var(--color-border);
        background: var(--color-bg-elevated);
        cursor: pointer;
        text-align: center;
        color: var(--color-text-primary);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .type-btn:hover {
        border-color: var(--color-border-strong);
        background: var(--color-surface-hover)
    }

    .type-btn.sel {
        border-color: var(--color-accent);
        background: var(--color-accent-subtle);
        box-shadow: 0 0 0 1px var(--color-accent)
    }

    .type-btn span {
        display: block;
        font-size: var(--text-2xl);
        margin-bottom: var(--space-2)
    }

    .thick-btn {
        padding: var(--space-4);
        border-radius: var(--radius-xl);
        border: 1px solid var(--color-border);
        background: var(--color-bg-elevated);
        cursor: pointer;
        font-weight: var(--weight-bold);
        font-size: var(--text-lg);
        color: var(--color-text-primary);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .thick-btn:hover {
        border-color: var(--color-border-strong)
    }

    .thick-btn.sel {
        border-color: var(--color-accent);
        background: var(--color-accent-subtle);
        color: var(--color-accent);
        box-shadow: 0 0 0 1px var(--color-accent)
    }

    .hint {
        font-size: var(--text-sm);
        color: var(--color-text-tertiary);
        margin-top: var(--space-2)
    }

    /* ═══ ADD BUTTONS ═══ */
    .add-btns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-2);
        margin-bottom: var(--space-4)
    }

    .add-btn {
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        border: 1px dashed var(--color-border-strong);
        background: var(--color-bg-elevated);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .add-btn:hover {
        border-color: var(--color-accent);
        color: var(--color-accent);
        background: var(--color-accent-subtle)
    }

    /* ═══ MODULE CARDS ═══ */
    .module {
        padding: var(--space-4);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-3);
        box-shadow: var(--shadow-xs)
    }

    .module-hdr {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-3)
    }

    .module-num {
        width: 28px;
        height: 28px;
        background: var(--color-accent);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-base);
        font-weight: var(--weight-bold);
        color: var(--color-text-on-accent)
    }

    .module-del {
        padding: var(--space-2);
        color: var(--color-danger);
        background: var(--color-danger-subtle);
        border: none;
        cursor: pointer;
        border-radius: var(--radius-md);
        transition: background var(--duration-fast) var(--ease-default)
    }

    .module-del:hover {
        background: rgba(220, 38, 38, 0.15)
    }

    .module-row {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-3)
    }

    .module-row span {
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        width: 60px
    }

    .opt-btn {
        padding: 6px 12px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        font-size: var(--text-base);
        font-weight: var(--weight-medium);
        cursor: pointer;
        background: var(--color-bg-elevated);
        color: var(--color-text-primary);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .opt-btn:hover {
        background: var(--color-surface-hover)
    }

    .opt-btn.sel {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border-color: var(--color-accent)
    }

    .module-desc {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary)
    }

    .empty {
        padding: var(--space-8);
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-xl);
        text-align: center;
        color: var(--color-text-tertiary)
    }
    /* ═══ TOTALS & COST DISPLAY ═══ */
    .total-w {
        padding: var(--space-3);
        background: var(--color-accent-subtle);
        border: 1px solid var(--color-accent-border);
        border-radius: var(--radius-xl);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: var(--space-4) 0
    }

    .total-w span {
        color: var(--color-accent);
        font-weight: var(--weight-medium)
    }

    .total-w strong {
        font-size: var(--text-xl);
        color: var(--color-accent);
        font-family: var(--font-mono)
    }

    /* ═══ EXTRAS ═══ */
    .extra-section {
        padding-top: var(--space-4);
        border-top: 1px solid var(--color-border);
        margin-top: var(--space-4)
    }

    .extra-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-3);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-3)
    }

    .toggle {
        width: 48px;
        height: 28px;
        border-radius: 14px;
        background: var(--color-border-strong);
        position: relative;
        cursor: pointer;
        border: none;
        flex-shrink: 0;
        transition: background var(--duration-fast) var(--ease-default)
    }

    .toggle.on {
        background: var(--color-accent)
    }

    .toggle::after {
        content: '';
        position: absolute;
        width: 22px;
        height: 22px;
        background: #fff;
        border-radius: var(--radius-full);
        top: 3px;
        left: 3px;
        transition: transform var(--duration-fast) var(--ease-default);
        box-shadow: var(--shadow-xs)
    }

    .toggle.on::after {
        transform: translateX(20px)
    }

    .extra-input {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding-left: var(--space-8);
        margin-bottom: var(--space-3)
    }

    .extra-input span {
        font-size: var(--text-base);
        color: var(--color-text-secondary)
    }

    .extra-input input {
        width: 80px;
        padding: var(--space-2) var(--space-3);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        text-align: center;
        font-family: var(--font-mono);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .extra-input input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    /* ═══ CARDS & COST ROWS ═══ */
    .card {
        padding: var(--space-4);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-4);
        box-shadow: var(--shadow-sm)
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-lg);
        font-weight: var(--weight-bold);
        margin-bottom: var(--space-3);
        color: var(--color-text-primary)
    }

    .cost-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: var(--text-base)
    }

    .cost-row span {
        color: var(--color-text-secondary)
    }

    .cost-row strong {
        font-family: var(--font-mono);
        color: var(--color-text-primary)
    }

    .cost-total {
        display: flex;
        justify-content: space-between;
        padding-top: var(--space-2);
        border-top: 1px solid var(--color-border);
        font-weight: var(--weight-bold)
    }

    .cost-total strong {
        color: var(--color-text-primary);
        font-family: var(--font-mono)
    }

    /* ═══ SUMMARY & GRAND TOTAL ═══ */
    .summary {
        padding: var(--space-4);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-4);
        box-shadow: var(--shadow-sm)
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--space-2)
    }

    .summary-row span {
        color: var(--color-text-secondary)
    }

    .summary-row strong {
        font-family: var(--font-mono)
    }

    .grand-total {
        display: flex;
        justify-content: space-between;
        padding-top: var(--space-2);
        border-top: 2px solid var(--color-text-primary)
    }

    .grand-total span {
        font-size: var(--text-xl);
        font-weight: var(--weight-bold)
    }

    .grand-total strong {
        font-size: var(--text-2xl);
        color: var(--color-accent);
        font-family: var(--font-mono)
    }

    .profit-box {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
        padding: var(--space-3);
        background: var(--color-success-subtle);
        border: 1px solid rgba(5, 150, 105, 0.2);
        border-radius: var(--radius-lg);
        margin-top: var(--space-3)
    }

    .profit-box span {
        color: var(--color-text-secondary);
        font-size: var(--text-base)
    }

    .profit-box strong {
        color: var(--color-success);
        font-family: var(--font-mono);
        font-size: var(--text-base)
    }

    /* ═══ TABS ═══ */
    .tabs {
        display: flex;
        background: var(--color-surface-3);
        border-radius: var(--radius-xl);
        padding: var(--space-1);
        margin-bottom: var(--space-4)
    }

    .tab {
        flex: 1;
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        border: none;
        font-weight: var(--weight-semi);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        background: none;
        color: var(--color-text-tertiary);
        font-family: var(--font-sans);
        font-size: var(--text-base);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .tab:hover {
        color: var(--color-text-primary)
    }

    .tab.sel {
        background: var(--color-bg-elevated);
        color: var(--color-text-primary);
        box-shadow: var(--shadow-sm)
    }
    /* ═══ QUOTE PREVIEW ═══ */
    .quote {
        background: var(--color-bg-elevated);
        border-radius: var(--radius-xl);
        overflow: hidden;
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-sm)
    }

    .quote-hdr {
        background: var(--color-text-primary);
        padding: var(--space-6);
        text-align: center
    }

    .quote-hdr h2 {
        font-size: var(--text-2xl);
        color: var(--color-text-inverse)
    }

    .quote-hdr p {
        color: var(--color-text-inverse);
        opacity: 0.7;
        font-size: var(--text-base)
    }

    .quote-body {
        padding: var(--space-4)
    }

    .quote-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-4);
        margin-bottom: var(--space-4)
    }

    .quote-info div span {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: var(--weight-medium)
    }

    .quote-info div p {
        font-weight: var(--weight-medium);
        color: var(--color-text-primary)
    }

    .quote-project {
        padding: var(--space-3);
        background: var(--color-surface-3);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-4)
    }

    .quote-project span {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em
    }

    .quote-project h3 {
        font-size: var(--text-lg);
        color: var(--color-text-primary)
    }

    .quote-project p {
        color: var(--color-text-secondary);
        font-size: var(--text-base)
    }

    .quote-mods h4 {
        font-weight: var(--weight-bold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2)
    }

    .quote-mod {
        display: flex;
        justify-content: space-between;
        padding: var(--space-2);
        background: var(--color-surface-3);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-1);
        font-size: var(--text-base)
    }

    .quote-extras {
        margin: var(--space-4) 0
    }

    .quote-extras h4 {
        font-weight: var(--weight-bold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2)
    }

    .quote-extras p {
        font-size: var(--text-base);
        color: var(--color-text-secondary)
    }

    .quote-price {
        border-top: 1px solid var(--color-border);
        padding-top: var(--space-4);
        margin-top: var(--space-4)
    }

    .quote-price-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--space-2)
    }

    .quote-price-row span {
        color: var(--color-text-secondary)
    }

    .quote-price-row strong {
        font-family: var(--font-mono)
    }

    .quote-total {
        display: flex;
        justify-content: space-between;
        padding-top: var(--space-2);
        border-top: 2px solid var(--color-text-primary);
        font-size: var(--text-xl);
        font-weight: var(--weight-bold)
    }

    .quote-total strong {
        color: var(--color-accent);
        font-family: var(--font-mono)
    }

    .quote-terms {
        padding: var(--space-3);
        background: var(--color-surface-3);
        border-radius: var(--radius-lg);
        margin: var(--space-4) 0
    }

    .quote-terms h4 {
        font-weight: var(--weight-bold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2)
    }

    .quote-terms p {
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-1)
    }

    .quote-contact {
        text-align: center;
        font-size: var(--text-base);
        color: var(--color-text-tertiary);
        padding-top: var(--space-2)
    }

    /* ═══ CUT / DESPIECE — Data-Heavy B2B Table ═══ */
    .cut-hdr {
        background: var(--color-text-primary);
        padding: var(--space-4) var(--space-5);
        color: var(--color-text-inverse)
    }

    .cut-hdr h2 {
        font-size: var(--text-lg);
        font-weight: var(--weight-bold);
        color: var(--color-text-inverse)
    }

    .cut-hdr p {
        color: var(--color-text-inverse);
        opacity: 0.7
    }

    .cut-body {
        padding: var(--space-4)
    }

    .cut-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-3);
        margin-bottom: var(--space-4)
    }

    .cut-box {
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        text-align: center;
        background: var(--color-accent-subtle);
        border: 1px solid var(--color-accent-border)
    }

    .cut-box strong {
        font-size: var(--text-2xl);
        display: block;
        color: var(--color-accent);
        font-family: var(--font-mono)
    }

    .cut-box span {
        font-size: var(--text-xs);
        color: var(--color-text-secondary)
    }

    .cut-module {
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        margin-bottom: var(--space-3)
    }

    .cut-module-hdr {
        background: var(--color-surface-3);
        padding: var(--space-2) var(--space-3);
        font-weight: var(--weight-bold);
        font-size: var(--text-base);
        color: var(--color-text-primary);
        border-bottom: 1px solid var(--color-border)
    }

    .cut-module-body {
        padding: 0
    }

    /* Data table */
    .cut-table {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--text-sm)
    }

    .cut-table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--color-surface-3);
        padding: var(--space-2) var(--space-2);
        font-weight: var(--weight-semi);
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        text-align: left;
        border-bottom: 2px solid var(--color-border);
        white-space: nowrap
    }

    .cut-table thead th.col-num {
        text-align: right;
        font-family: var(--font-mono)
    }

    .cut-table thead th.col-zone {
        text-align: center
    }

    .cut-table tbody tr {
        border-bottom: 1px solid var(--color-border-subtle);
        transition: background var(--duration-fast) var(--ease-default)
    }

    .cut-table tbody tr:hover {
        background: var(--color-surface-hover)
    }

    .cut-table tbody tr.cut-row-edited {
        border-left: 3px solid var(--color-warning);
        background: rgba(217, 119, 6, 0.03)
    }

    .cut-table td {
        padding: 6px var(--space-2);
        vertical-align: middle;
        color: var(--color-text-primary)
    }

    .cut-table td.col-name {
        font-weight: var(--weight-medium);
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap
    }

    .cut-table td.col-num {
        text-align: right;
        font-family: var(--font-mono);
        font-variant-numeric: tabular-nums;
        white-space: nowrap
    }

    .cut-table td.col-zone {
        text-align: center
    }

    /* Editable inputs inside table cells */
    .cut-table .cut-input {
        width: 52px;
        padding: 4px 6px;
        background: var(--color-surface-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        text-align: right;
        font-size: var(--text-xs);
        font-family: var(--font-mono);
        font-variant-numeric: tabular-nums;
        transition: border-color var(--duration-fast) var(--ease-default),
                    background var(--duration-fast) var(--ease-default)
    }

    .cut-table .cut-input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    .cut-table .cut-input.cut-input-edited {
        background: rgba(217, 119, 6, 0.08);
        border-color: rgba(217, 119, 6, 0.3)
    }

    .cut-table .cut-input-qty {
        width: 40px;
        text-align: center
    }

    /* Zone badges */
    .cut-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--weight-semi);
        letter-spacing: 0.03em
    }

    .cut-badge-f {
        background: rgba(2, 132, 199, 0.10);
        color: var(--color-info);
        border: 1px solid rgba(2, 132, 199, 0.2)
    }

    .cut-badge-i {
        background: var(--color-surface-3);
        color: var(--color-text-tertiary);
        border: 1px solid var(--color-border)
    }

    /* Reset edits button */
    .cut-reset-btn {
        width: 100%;
        padding: 10px;
        background: var(--color-warning-subtle);
        border: 1px solid rgba(217, 119, 6, 0.3);
        border-radius: var(--radius-lg);
        color: var(--color-warning);
        font-size: var(--text-sm);
        font-weight: var(--weight-semi);
        cursor: pointer;
        margin-bottom: var(--space-3);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .cut-reset-btn:hover {
        background: rgba(217, 119, 6, 0.12);
        border-color: rgba(217, 119, 6, 0.5)
    }

    /* Backward compat: keep old class names functional */
    .cut-piece {
        display: flex;
        align-items: center;
        font-size: var(--text-xs);
        padding: var(--space-2);
        background: var(--color-surface-2);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-1)
    }

    .cut-piece span:first-child {
        flex: 1
    }

    .cut-piece .qty {
        width: 32px;
        text-align: center;
        color: var(--color-text-primary);
        font-weight: var(--weight-semi)
    }

    .cut-piece .dims {
        width: 80px;
        text-align: right;
        font-family: var(--font-mono)
    }

    .cut-piece .thk {
        width: 48px;
        text-align: right;
        color: var(--color-text-tertiary)
    }

    .cut-piece .zone {
        width: 48px;
        text-align: center;
        font-size: var(--text-xs);
        border-radius: var(--radius-sm);
        padding: 2px 4px;
        font-weight: var(--weight-medium)
    }

    .cut-piece .zone.f {
        background: var(--color-info-subtle);
        color: var(--color-info)
    }

    .cut-piece .zone.i {
        background: var(--color-surface-3);
        color: var(--color-text-tertiary)
    }

    .copy-btn {
        width: 100%;
        padding: var(--space-4);
        background: var(--color-accent);
        border: none;
        border-radius: var(--radius-xl);
        color: var(--color-text-on-accent);
        font-weight: var(--weight-bold);
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        margin-top: var(--space-4);
        font-family: var(--font-sans);
        transition: background var(--duration-fast) var(--ease-default)
    }

    .copy-btn:hover {
        background: var(--color-accent-hover)
    }

    .copy-btn.copied {
        background: var(--color-success)
    }
    /* ═══ MODALS ═══ */
    .modal {
        position: fixed;
        inset: 0;
        background: var(--color-bg-overlay);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: var(--z-modal);
        backdrop-filter: blur(4px)
    }

    .modal-content {
        background: var(--color-bg-elevated);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
        overflow: hidden;
        box-shadow: var(--shadow-xl)
    }

    .modal-hdr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4);
        border-bottom: 1px solid var(--color-border)
    }

    .modal-hdr h2 {
        font-size: var(--text-xl);
        display: flex;
        align-items: center;
        gap: var(--space-2);
        color: var(--color-text-primary)
    }

    .modal-close {
        padding: var(--space-2);
        background: var(--color-surface-3);
        border: none;
        color: var(--color-text-secondary);
        cursor: pointer;
        border-radius: var(--radius-md);
        transition: background var(--duration-fast) var(--ease-default)
    }

    .modal-close:hover {
        background: var(--color-surface-hover)
    }

    .modal-body {
        overflow-y: auto;
        max-height: 70vh;
        padding: var(--space-4)
    }

    svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none
    }

    /* ═══ TEMPLATES ═══ */
    .tpl-grid {
        padding: var(--space-4)
    }

    .tpl-card {
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        overflow: hidden;
        margin-bottom: var(--space-4);
        box-shadow: var(--shadow-sm);
        transition: box-shadow var(--duration-fast) var(--ease-default)
    }

    .tpl-card:hover {
        box-shadow: var(--shadow-md)
    }

    .tpl-card-img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        display: block;
        cursor: pointer
    }

    .tpl-card-body {
        padding: var(--space-4)
    }

    .tpl-card-name {
        font-size: var(--text-lg);
        font-weight: var(--weight-bold);
        margin-bottom: var(--space-1);
        color: var(--color-text-primary)
    }

    .tpl-card-type {
        display: inline-block;
        font-size: var(--text-xs);
        background: var(--color-surface-3);
        color: var(--color-text-secondary);
        padding: 2px var(--space-2);
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-2);
        font-weight: var(--weight-medium)
    }

    .tpl-card-desc {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-2)
    }

    .tpl-card-dims {
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-1)
    }

    .tpl-card-price {
        font-size: 1.375rem;
        font-weight: var(--weight-bold);
        color: var(--color-accent);
        margin-bottom: var(--space-3);
        font-family: var(--font-mono)
    }

    .tpl-card-btn {
        width: 100%;
        padding: 14px;
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border: none;
        border-radius: var(--radius-lg);
        font-weight: var(--weight-bold);
        font-size: var(--text-md);
        cursor: pointer;
        font-family: var(--font-sans);
        transition: background var(--duration-fast) var(--ease-default)
    }

    .tpl-card-btn:hover {
        background: var(--color-accent-hover)
    }

    .tpl-new {
        width: 100%;
        padding: var(--space-4);
        background: none;
        border: 2px dashed var(--color-border-strong);
        border-radius: var(--radius-xl);
        color: var(--color-text-tertiary);
        font-size: var(--text-md);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        margin-bottom: var(--space-4);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .tpl-new:hover {
        border-color: var(--color-accent);
        color: var(--color-accent)
    }

    /* ═══ QUICK QUOTE ═══ */
    .qq-back {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        background: none;
        border: none;
        color: var(--color-text-secondary);
        cursor: pointer;
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-md);
        font-family: var(--font-sans);
        transition: color var(--duration-fast) var(--ease-default)
    }

    .qq-back:hover {
        color: var(--color-text-primary)
    }

    .qq-img {
        width: 100%;
        max-height: 220px;
        object-fit: cover;
        display: block
    }

    .qq-body {
        padding: var(--space-4)
    }

    .qq-name {
        font-size: 1.375rem;
        font-weight: var(--weight-bold);
        margin-bottom: var(--space-1);
        color: var(--color-text-primary)
    }

    .qq-desc {
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-4)
    }

    .qq-section {
        padding: var(--space-4);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-4)
    }

    .qq-section-title {
        font-size: var(--text-sm);
        color: var(--color-text-tertiary);
        margin-bottom: var(--space-3);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: var(--weight-medium)
    }

    .qq-dim-row {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-3)
    }

    .qq-dim-row label {
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        width: 50px
    }

    .qq-dim-input {
        flex: 1;
        padding: var(--space-3);
        background: var(--color-surface-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        font-size: var(--text-lg);
        font-weight: var(--weight-bold);
        text-align: center;
        font-family: var(--font-mono);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .qq-dim-input:focus {
        border-color: var(--color-accent);
        outline: none;
        box-shadow: var(--focus-ring)
    }

    .qq-price-box {
        padding: var(--space-5);
        background: var(--color-accent-subtle);
        border: 1px solid var(--color-accent-border);
        border-radius: var(--radius-xl);
        text-align: center;
        margin-bottom: var(--space-4)
    }

    .qq-price-label {
        font-size: var(--text-base);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-1)
    }

    .qq-price {
        font-size: var(--text-3xl);
        font-weight: var(--weight-extra);
        color: var(--color-accent);
        font-family: var(--font-mono)
    }

    .qq-price-iva {
        font-size: var(--text-base);
        color: var(--color-text-tertiary);
        margin-top: var(--space-1)
    }

    .qq-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-3);
        margin-bottom: var(--space-4)
    }

    .qq-info-item {
        padding: var(--space-3);
        background: var(--color-surface-3);
        border-radius: var(--radius-lg)
    }

    .qq-info-item span {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        display: block;
        text-transform: uppercase;
        letter-spacing: 0.05em
    }

    .qq-info-item strong {
        font-size: var(--text-md);
        color: var(--color-text-primary)
    }

    .wa-btn {
        width: 100%;
        padding: var(--space-4);
        background: var(--color-accent);
        border: none;
        border-radius: var(--radius-xl);
        color: var(--color-text-on-accent);
        font-weight: var(--weight-bold);
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
        font-family: var(--font-sans);
        transition: background var(--duration-fast) var(--ease-default)
    }

    .wa-btn:hover {
        background: var(--color-accent-hover)
    }

    .wa-btn.copied {
        background: var(--color-success)
    }

    .qq-full-btn {
        width: 100%;
        padding: 14px;
        background: none;
        border: 1px solid var(--color-border-strong);
        border-radius: var(--radius-xl);
        color: var(--color-text-primary);
        font-weight: var(--weight-semi);
        font-size: var(--text-md);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        margin-bottom: var(--space-4);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .qq-full-btn:hover {
        border-color: var(--color-accent);
        color: var(--color-accent)
    }

    .qq-mat-select {
        width: 100%;
        padding: var(--space-3);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        font-size: var(--text-md);
        font-family: var(--font-sans);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .qq-mat-select:focus {
        border-color: var(--color-accent);
        outline: none;
        box-shadow: var(--focus-ring)
    }

    /* ═══ IMAGE MODAL ═══ */
    .img-modal {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.95);
        z-index: var(--z-imgmodal);
        display: flex;
        align-items: center;
        justify-content: center
    }

    .img-modal img {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
        touch-action: pinch-zoom
    }

    .img-modal-close {
        position: absolute;
        top: var(--space-4);
        right: var(--space-4);
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        border-radius: var(--radius-full);
        color: #fff;
        font-size: var(--text-2xl);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center
    }
    /* ═══ DUAL MATERIAL ═══ */
    .mat-dual {
        margin-bottom: var(--space-5)
    }

    .mat-toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-3);
        background: var(--color-surface-3);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-4)
    }

    .mat-toggle-row span {
        font-size: var(--text-base);
        color: var(--color-text-primary)
    }

    .mat-section {
        margin-bottom: var(--space-4)
    }

    .mat-section-label {
        font-size: var(--text-base);
        font-weight: var(--weight-semi);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2);
        display: flex;
        align-items: center;
        gap: var(--space-2)
    }

    .mat-section-label .badge {
        font-size: var(--text-xs);
        padding: 2px var(--space-2);
        border-radius: var(--radius-sm);
        font-weight: var(--weight-medium)
    }

    .mat-section-label .badge.vis {
        background: var(--color-info-subtle);
        color: var(--color-info)
    }

    .mat-section-label .badge.hid {
        background: var(--color-surface-3);
        color: var(--color-text-tertiary)
    }

    .mat-select {
        width: 100%;
        padding: var(--space-3);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        font-size: var(--text-base);
        font-family: var(--font-sans);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .mat-select:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    .mat-info {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        margin-top: var(--space-1);
        padding-left: var(--space-1)
    }

    /* ═══ HARDWARE PICKER — Right-Side Drawer ═══ */
    .hw-picker {
        position: fixed;
        inset: 0;
        background: var(--color-bg-overlay);
        z-index: var(--z-picker);
        display: flex;
        justify-content: flex-end;
        backdrop-filter: blur(4px);
        animation: hw-overlay-in var(--duration-base) var(--ease-default)
    }

    @keyframes hw-overlay-in {
        from { opacity: 0 }
        to   { opacity: 1 }
    }

    @keyframes hw-drawer-slide {
        from { transform: translateX(100%) }
        to   { transform: translateX(0) }
    }

    .hw-picker-content {
        background: var(--color-bg-elevated);
        width: 38%;
        min-width: 380px;
        max-width: 520px;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: var(--shadow-xl);
        border-left: 1px solid var(--color-border);
        animation: hw-drawer-slide var(--duration-slow) var(--ease-default)
    }

    /* Mobile: full-width bottom sheet */
    @media (max-width: 640px) {
        .hw-picker {
            align-items: flex-end;
            justify-content: center
        }
        .hw-picker-content {
            width: 100%;
            min-width: unset;
            max-width: unset;
            height: 92vh;
            border-left: none;
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
            animation: none
        }
    }

    .hw-picker-hdr {
        padding: var(--space-4);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0
    }

    .hw-picker-hdr h3 {
        font-size: var(--text-lg);
        color: var(--color-text-primary)
    }

    /* Sticky search + filters area */
    .hw-search-area {
        position: sticky;
        top: 0;
        z-index: 3;
        background: var(--color-bg-elevated);
        flex-shrink: 0;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: var(--space-2)
    }

    .hw-search {
        padding: var(--space-3);
        background: var(--color-surface-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        font-size: var(--text-base);
        margin: var(--space-3) var(--space-4) var(--space-2);
        flex-shrink: 0;
        box-sizing: border-box;
        width: calc(100% - 32px);
        font-family: var(--font-sans);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .hw-search:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    .hw-filters {
        display: flex;
        gap: 6px;
        padding: 0 var(--space-4) var(--space-2);
        overflow-x: auto;
        flex-wrap: wrap;
        flex-shrink: 0
    }

    .hw-chip {
        padding: 6px var(--space-3);
        border-radius: var(--radius-full);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: var(--text-xs);
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .hw-chip:hover {
        border-color: var(--color-border-strong);
        background: var(--color-surface-hover)
    }

    .hw-chip.sel {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border-color: var(--color-accent)
    }

    .hw-list {
        overflow-y: auto;
        flex: 1;
        padding: 0 var(--space-4) var(--space-4)
    }

    .hw-item {
        display: flex;
        align-items: center;
        padding: var(--space-3);
        background: var(--color-surface-2);
        border: 1px solid var(--color-border-subtle);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-2);
        gap: var(--space-3);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .hw-item:hover {
        border-color: var(--color-border)
    }

    .hw-item-info {
        flex: 1;
        min-width: 0
    }

    .hw-item-name {
        font-size: var(--text-sm);
        font-weight: var(--weight-medium);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--color-text-primary)
    }

    .hw-item-meta {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary)
    }

    .hw-item-price {
        font-family: var(--font-mono);
        font-size: var(--text-base);
        font-weight: var(--weight-bold);
        white-space: nowrap;
        color: var(--color-text-primary)
    }

    .hw-item-qty {
        display: flex;
        align-items: center;
        gap: 6px
    }

    .hw-item-qty button {
        width: 28px;
        height: 28px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background: var(--color-bg-elevated);
        color: var(--color-text-primary);
        font-size: 1rem;
        font-weight: var(--weight-bold);
        cursor: pointer;
        transition: all var(--duration-fast) var(--ease-default)
    }

    .hw-item-qty button:hover {
        background: var(--color-surface-hover);
        border-color: var(--color-border-strong)
    }

    .hw-item-qty strong {
        width: 24px;
        text-align: center;
        font-size: var(--text-base);
        font-family: var(--font-mono)
    }

    .hw-cat-hdr {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: var(--space-2) 0;
        border-bottom: 1px solid var(--color-border);
        margin-bottom: var(--space-2);
        margin-top: var(--space-2);
        font-weight: var(--weight-medium)
    }

    /* ═══ HARDWARE SELECTED ═══ */
    .hw-selected {
        margin-top: var(--space-4);
        padding-top: var(--space-4);
        border-top: 1px solid var(--color-border)
    }

    .hw-selected h4 {
        font-size: var(--text-base);
        color: var(--color-text-primary);
        margin-bottom: var(--space-3);
        display: flex;
        align-items: center;
        gap: var(--space-2)
    }

    .hw-sel-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-2) var(--space-3);
        background: var(--color-surface-2);
        border: 1px solid var(--color-border-subtle);
        border-radius: var(--radius-lg);
        margin-bottom: 6px;
        font-size: var(--text-sm)
    }

    .hw-sel-item .hw-sel-name {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: var(--space-2);
        color: var(--color-text-primary)
    }

    .hw-sel-item .hw-sel-qty {
        display: flex;
        align-items: center;
        gap: var(--space-1)
    }

    .hw-sel-item .hw-sel-qty button {
        width: 24px;
        height: 24px;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        background: var(--color-bg-elevated);
        color: var(--color-text-primary);
        cursor: pointer;
        font-weight: var(--weight-bold);
        transition: background var(--duration-fast) var(--ease-default)
    }

    .hw-sel-item .hw-sel-qty button:hover {
        background: var(--color-surface-hover)
    }

    .hw-sel-item .hw-sel-price {
        font-family: var(--font-mono);
        font-weight: var(--weight-semi);
        width: 70px;
        text-align: right;
        color: var(--color-text-primary)
    }

    .hw-sel-item .hw-sel-marca {
        font-size: var(--text-xs);
        padding: 1px 6px;
        border-radius: 3px;
        margin-right: var(--space-1);
        font-weight: var(--weight-medium)
    }

    .marca-herraxa {
        background: var(--color-warning-subtle);
        color: var(--color-warning)
    }

    .marca-blum {
        background: var(--color-danger-subtle);
        color: var(--color-danger)
    }

    .marca-hafele {
        background: var(--color-info-subtle);
        color: var(--color-info)
    }

    .marca-arauco {
        background: var(--color-success-subtle);
        color: var(--color-success)
    }

    .hw-add-btn {
        width: 100%;
        padding: var(--space-3);
        border: 1px dashed var(--color-border-strong);
        border-radius: var(--radius-lg);
        background: none;
        color: var(--color-text-tertiary);
        font-size: var(--text-base);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        margin-top: var(--space-2);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .hw-add-btn:hover {
        border-color: var(--color-accent);
        color: var(--color-accent)
    }

    /* ═══ SETTINGS PANEL ═══ */
    .settings-overlay {
        position: fixed;
        inset: 0;
        background: var(--color-bg-overlay);
        z-index: var(--z-settings);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px)
    }

    .settings-panel {
        background: var(--color-bg-elevated);
        width: 90%;
        max-width: 420px;
        border-radius: var(--radius-2xl);
        overflow: hidden;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-xl)
    }

    .settings-hdr {
        padding: var(--space-4);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center
    }

    .settings-hdr h3 {
        font-size: var(--text-lg);
        color: var(--color-text-primary)
    }

    .settings-body {
        overflow-y: auto;
        padding: var(--space-4)
    }

    .settings-section {
        margin-bottom: var(--space-5)
    }

    .settings-section h4 {
        font-size: var(--text-sm);
        color: var(--color-text-tertiary);
        margin-bottom: var(--space-3);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: var(--weight-medium)
    }

    .margin-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px var(--space-3);
        background: var(--color-surface-2);
        border: 1px solid var(--color-border-subtle);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-2)
    }

    .margin-row label {
        font-size: var(--text-base);
        flex: 1;
        color: var(--color-text-primary)
    }

    .margin-row input {
        width: 70px;
        padding: var(--space-2);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        color: var(--color-text-primary);
        text-align: center;
        font-size: var(--text-base);
        font-family: var(--font-mono);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .margin-row input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    .margin-row .lock {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        font-size: var(--text-base);
        color: var(--color-text-tertiary);
        padding: var(--space-2) var(--space-3);
        background: var(--color-surface-3);
        border-radius: var(--radius-md)
    }

    .margin-presets {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-4)
    }

    .margin-preset {
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        cursor: pointer;
        font-size: var(--text-sm);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .margin-preset:hover {
        border-color: var(--color-border-strong)
    }

    .margin-preset.sel {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border-color: var(--color-accent)
    }

    .supplier-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-2) var(--space-3);
        background: var(--color-surface-2);
        border: 1px solid var(--color-border-subtle);
        border-radius: var(--radius-lg);
        margin-bottom: 6px
    }

    .supplier-row span {
        font-size: var(--text-base);
        color: var(--color-text-primary)
    }

    .supplier-row input {
        width: 60px;
        padding: 6px;
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        color: var(--color-text-primary);
        text-align: center;
        font-size: var(--text-sm);
        font-family: var(--font-mono)
    }
    /* ═══ COST BREAKDOWN ═══ */
    .cost-bd {
        margin-top: var(--space-4);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        overflow: hidden
    }

    .cost-bd-lock {
        padding: var(--space-3) var(--space-4);
        background: var(--color-surface-3);
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        display: flex;
        align-items: center;
        gap: var(--space-2)
    }

    .cost-bd-toggle {
        padding: var(--space-3) var(--space-4);
        background: var(--color-surface-2);
        border: none;
        color: var(--color-text-primary);
        width: 100%;
        text-align: left;
        font-size: var(--text-base);
        font-weight: var(--weight-semi);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: var(--font-sans);
        transition: background var(--duration-fast) var(--ease-default)
    }

    .cost-bd-toggle:hover {
        background: var(--color-surface-hover)
    }

    .cost-bd-body {
        padding: var(--space-4)
    }

    .cost-bd-section {
        margin-bottom: var(--space-4)
    }

    .cost-bd-section h5 {
        font-size: var(--text-sm);
        color: var(--color-text-tertiary);
        margin-bottom: var(--space-2);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: var(--weight-medium)
    }

    .cost-bd-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        font-size: var(--text-sm);
        font-family: var(--font-mono)
    }

    .cost-bd-row span {
        color: var(--color-text-secondary)
    }

    .cost-bd-row strong {
        color: var(--color-text-primary)
    }

    .cost-bd-subtotal {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-top: 1px solid var(--color-border);
        font-size: var(--text-sm);
        font-weight: var(--weight-bold);
        margin-top: var(--space-1)
    }

    .cost-bd-grand {
        padding: var(--space-3);
        background: var(--color-accent-subtle);
        border-radius: var(--radius-lg);
        margin-top: var(--space-2)
    }

    .cost-bd-grand-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: var(--text-base);
        font-family: var(--font-mono)
    }

    .cost-bd-grand-row.total {
        font-size: var(--text-lg);
        font-weight: var(--weight-bold);
        color: var(--color-accent)
    }

    /* ═══ SUGGEST PANEL ═══ */
    .hw-suggest {
        padding: var(--space-3);
        background: var(--color-surface-3);
        border: 1px dashed var(--color-border);
        border-radius: var(--radius-lg);
        margin-top: var(--space-2)
    }

    .hw-suggest-title {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        margin-bottom: var(--space-2);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: var(--weight-medium)
    }

    .hw-suggest-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 0;
        font-size: var(--text-sm)
    }

    .hw-suggest-item button {
        padding: var(--space-1) 10px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background: var(--color-bg-elevated);
        color: var(--color-text-primary);
        font-size: var(--text-xs);
        cursor: pointer;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .hw-suggest-item button:hover {
        border-color: var(--color-accent);
        color: var(--color-accent)
    }

    .hw-suggest-item button.added {
        background: var(--color-surface-3);
        color: var(--color-text-tertiary);
        border-color: var(--color-border-subtle)
    }

    /* ═══ LABOR INPUT ═══ */
    .labor-input {
        display: flex;
        align-items: center;
        gap: var(--space-2)
    }

    .labor-input input {
        width: 120px;
        padding: 10px;
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        font-size: 1rem;
        text-align: right;
        font-family: var(--font-mono);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .labor-input input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    .labor-input span {
        color: var(--color-text-secondary);
        font-size: var(--text-base)
    }

    .labor-presets {
        display: flex;
        gap: 6px;
        margin-top: var(--space-2);
        flex-wrap: wrap
    }

    .labor-preset {
        padding: 6px 10px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: var(--text-xs);
        cursor: pointer;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .labor-preset:hover {
        border-color: var(--color-border-strong)
    }

    .labor-preset.sel {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border-color: var(--color-accent)
    }

    /* ═══ STEP 2 REDESIGN: TABBED CATEGORIES + TILE GRID ═══ */
    .cat-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: var(--space-4);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 2px
    }

    .cat-tab {
        padding: 8px 16px;
        border-radius: var(--radius-full);
        border: 1px solid var(--color-border);
        background: var(--color-bg-elevated);
        color: var(--color-text-secondary);
        font-size: var(--text-sm);
        font-weight: var(--weight-medium);
        cursor: pointer;
        white-space: nowrap;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .cat-tab:hover {
        border-color: var(--color-accent);
        color: var(--color-accent)
    }

    .cat-tab.sel {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border-color: var(--color-accent)
    }

    .mod-tile-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-2);
        margin-bottom: var(--space-4)
    }

    .mod-tile {
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        background: var(--color-bg-elevated);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        font-family: var(--font-sans);
        text-align: center;
        transition: all var(--duration-fast) var(--ease-default);
        position: relative
    }

    .mod-tile:hover {
        border-color: var(--color-accent);
        color: var(--color-accent);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3)
    }

    .mod-tile .tile-icon {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-md);
        background: var(--color-accent-subtle);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-accent)
    }

    /* Compact module cards */
    .module-compact {
        padding: var(--space-3);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-2);
        box-shadow: var(--shadow-xs)
    }

    .module-compact .module-hdr {
        margin-bottom: var(--space-2)
    }

    .dim-row {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
        margin-bottom: var(--space-2)
    }

    .dim-group {
        display: flex;
        align-items: center;
        gap: 4px;
        flex: 1;
        min-width: 100px
    }

    .dim-group label {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        width: 38px;
        flex-shrink: 0
    }

    .dim-group input {
        width: 60px;
        padding: 5px 6px;
        background: var(--color-surface-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        color: var(--color-text-primary);
        text-align: center;
        font-size: var(--text-sm);
        font-family: var(--font-mono)
    }

    .dim-group input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    @media (max-width: 640px) {
        .mod-tile-grid {
            grid-template-columns: 1fr 1fr
        }
        .dim-row {
            flex-direction: column;
            gap: 6px
        }
        .dim-group {
            min-width: unset
        }
    }

    /* ═══ STEP 3 REDESIGN: BENTO DASHBOARD ═══ */
    .bento-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-3);
        margin-bottom: var(--space-3)
    }

    .bento-grid .card {
        margin-bottom: 0
    }

    .bento-grid .card.span-2 {
        grid-column: 1 / -1
    }

    @media (max-width: 640px) {
        .bento-grid {
            grid-template-columns: 1fr
        }
    }

    /* Labor pill buttons */
    .labor-pills {
        display: flex;
        gap: 6px;
        margin-top: var(--space-2);
        flex-wrap: wrap
    }

    .labor-pill {
        padding: 6px 14px;
        border-radius: var(--radius-full);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: var(--text-xs);
        font-weight: var(--weight-medium);
        cursor: pointer;
        font-family: var(--font-mono);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .labor-pill:hover {
        border-color: var(--color-accent);
        color: var(--color-accent)
    }

    .labor-pill.sel {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border-color: var(--color-accent)
    }

    /* Sheet optimizer gauge */
    .sheet-gauge {
        margin-top: var(--space-3);
        padding: var(--space-3) var(--space-4);
        background: linear-gradient(135deg, #152e1f 0%, #1f3528 100%);
        border: 1px solid #3a6a4a;
        border-radius: var(--radius-xl);
        overflow: hidden
    }

    .sheet-gauge-title {
        font-size: var(--text-sm);
        color: #6edba0;
        font-weight: var(--weight-semi);
        margin-bottom: var(--space-2);
        display: flex;
        align-items: center;
        gap: var(--space-2)
    }

    .sheet-gauge-bar {
        display: flex;
        height: 28px;
        border-radius: var(--radius-md);
        overflow: hidden;
        background: rgba(255,255,255,0.05);
        margin-bottom: var(--space-2)
    }

    .sheet-gauge-seg {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: var(--weight-semi);
        font-family: var(--font-mono);
        transition: width 0.4s ease
    }

    .sheet-gauge-seg.casco {
        background: linear-gradient(135deg, #059669, #047857);
        color: #d1fae5
    }

    .sheet-gauge-seg.frente {
        background: linear-gradient(135deg, #0d9488, #0f766e);
        color: #ccfbf1
    }

    .sheet-gauge-legend {
        display: flex;
        gap: var(--space-4);
        font-size: var(--text-sm)
    }

    .sheet-gauge-legend span {
        display: flex;
        align-items: center;
        gap: 6px;
        color: #c8d8d0
    }

    .sheet-gauge-legend .dot {
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        flex-shrink: 0
    }

    .sheet-gauge-legend strong {
        color: var(--color-text-primary);
        font-family: var(--font-mono)
    }

    /* Profit hero card */
    .profit-hero {
        padding: var(--space-4) var(--space-4) var(--space-3);
        background: linear-gradient(145deg, #222236 0%, #2a2a44 50%, #222236 100%);
        border: 1px solid rgba(196,154,108,0.4);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-3);
        box-shadow: 0 8px 32px rgba(0,0,0,0.3)
    }

    .profit-hero .hero-label {
        font-size: var(--text-xs);
        color: #b0b0c0;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 2px
    }

    .profit-hero .hero-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 6px 0
    }

    .profit-hero .hero-row span {
        font-size: var(--text-base);
        color: #d0d0dd
    }

    .profit-hero .hero-row strong {
        font-family: var(--font-mono);
        font-size: var(--text-base);
        text-align: right;
        color: #e8e8f0
    }

    .profit-hero .hero-row.cost strong {
        color: #a0a0b0
    }

    .profit-hero .hero-row.profit strong {
        color: #5eeaab;
        font-size: var(--text-lg)
    }

    .profit-hero .hero-row.total {
        padding-top: var(--space-2);
        border-top: 2px solid rgba(196,154,108,0.3);
        margin-top: var(--space-1)
    }

    .profit-hero .hero-row.total span {
        font-size: var(--text-xl);
        font-weight: var(--weight-bold);
        color: var(--color-text-primary)
    }

    .profit-hero .hero-row.total strong {
        font-size: var(--text-2xl);
        color: var(--color-accent);
        font-weight: var(--weight-bold)
    }

    .profit-hero .hero-margin {
        display: inline-block;
        padding: 3px 10px;
        border-radius: var(--radius-full);
        background: rgba(52,211,153,0.15);
        color: #34d399;
        font-size: var(--text-xs);
        font-weight: var(--weight-semi);
        font-family: var(--font-mono);
        margin-top: 4px
    }

    /* Accordion overrides for internal breakdown */
    .cost-bd-accordion {
        margin-top: var(--space-3);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: var(--radius-xl);
        overflow: hidden;
        background: var(--color-surface-2)
    }

    .cost-bd-accordion .cost-bd-toggle {
        background: var(--color-surface-2);
        padding: var(--space-3) var(--space-4);
        gap: var(--space-2)
    }

    .cost-bd-accordion .cost-bd-toggle:hover {
        background: var(--color-surface-3)
    }

    .cost-bd-accordion .lock-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: var(--radius-sm);
        background: rgba(255,255,255,0.06);
        font-size: 11px;
        margin-right: 6px
    }

    /* Right-align monetary values */
    .cost-row strong,
    .cost-total strong,
    .cost-bd-row strong,
    .cost-bd-subtotal strong {
        text-align: right;
        min-width: 90px
    }

    /* ═══ PDF SCREEN ═══ */
    .pdf-screen {
        padding: var(--space-4)
    }

    .pdf-field {
        margin-bottom: var(--space-4)
    }

    .pdf-field label {
        display: block;
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        margin-bottom: 6px;
        font-weight: var(--weight-medium)
    }

    .pdf-field input, .pdf-field textarea {
        width: 100%;
        padding: var(--space-3);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        font-size: var(--text-md);
        font-family: var(--font-sans);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .pdf-field input:focus, .pdf-field textarea:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring)
    }

    .pdf-field textarea {
        min-height: 60px;
        resize: vertical
    }

    .pdf-items {
        margin-bottom: var(--space-4)
    }

    .pdf-item {
        padding: var(--space-3);
        background: var(--color-surface-2);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-2)
    }

    .pdf-item-hdr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-2)
    }

    .pdf-item-hdr strong {
        font-size: var(--text-base);
        color: var(--color-text-primary)
    }

    .pdf-item-price {
        width: 120px;
        padding: var(--space-2);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        color: var(--color-text-primary);
        font-size: 1rem;
        text-align: right;
        font-family: var(--font-mono);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .pdf-item-price:focus {
        border-color: var(--color-accent);
        outline: none;
        box-shadow: var(--focus-ring)
    }

    .pdf-item-desc {
        width: 100%;
        padding: var(--space-2);
        background: var(--color-surface-3);
        border: 1px solid var(--color-border-subtle);
        border-radius: var(--radius-md);
        color: var(--color-text-secondary);
        font-size: var(--text-sm);
        resize: none;
        min-height: 40px;
        font-family: var(--font-sans);
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .pdf-item-desc:focus {
        border-color: var(--color-accent);
        outline: none;
        color: var(--color-text-primary)
    }

    .pdf-totals {
        padding: var(--space-4);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        margin-bottom: var(--space-4);
        box-shadow: var(--shadow-sm)
    }

    .pdf-totals-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: var(--text-md)
    }

    .pdf-totals-row.grand {
        font-size: var(--text-xl);
        font-weight: var(--weight-bold);
        padding-top: var(--space-2);
        border-top: 2px solid var(--color-text-primary)
    }

    .pdf-actions {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        margin-bottom: var(--space-4)
    }

    .pdf-btn {
        width: 100%;
        padding: var(--space-4);
        border: none;
        border-radius: var(--radius-xl);
        font-weight: var(--weight-bold);
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .pdf-btn.client {
        background: var(--color-accent);
        color: var(--color-text-on-accent)
    }

    .pdf-btn.client:hover {
        background: var(--color-accent-hover)
    }

    .pdf-btn.internal {
        background: var(--color-surface-3);
        color: var(--color-text-primary);
        border: 1px solid var(--color-border)
    }

    .pdf-btn.internal:hover {
        background: var(--color-surface-hover)
    }

    .pdf-btn.despiece {
        background: var(--color-info-subtle);
        color: var(--color-info);
        border: 1px solid var(--color-accent-border)
    }

    .pdf-btn.despiece:hover {
        background: rgba(3, 105, 161, 0.15)
    }

    /* ═══ BRAND SELECTOR ═══ */
    .brand-toggle {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-4)
    }

    .brand-btn {
        flex: 1;
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: var(--text-base);
        font-weight: var(--weight-semi);
        cursor: pointer;
        text-align: center;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .brand-btn:hover {
        border-color: var(--color-border-strong)
    }

    .brand-btn.sel {
        border-color: var(--color-accent);
        background: var(--color-accent-subtle);
        color: var(--color-accent)
    }

    .brand-btn .mono {
        font-size: var(--text-xl);
        font-weight: var(--weight-bold);
        display: block;
        margin-bottom: var(--space-1)
    }

    /* ═══ LOGO UPLOAD ═══ */
    .logo-section {
        margin-bottom: var(--space-4)
    }

    .logo-preview {
        width: 160px;
        height: 80px;
        border-radius: var(--radius-lg);
        background: var(--color-surface-3);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: var(--space-2)
    }

    .logo-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain
    }

    .logo-btns {
        display: flex;
        gap: var(--space-2)
    }

    .logo-btns button {
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-lg);
        border: none;
        font-size: var(--text-sm);
        cursor: pointer;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .logo-btns .upload {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        font-weight: var(--weight-semi)
    }

    .logo-btns .upload:hover {
        background: var(--color-accent-hover)
    }

    .logo-btns .remove {
        background: var(--color-danger-subtle);
        color: var(--color-danger)
    }

    .logo-btns .remove:hover {
        background: rgba(220, 38, 38, 0.15)
    }
    /* ═══ LED CONFIGURATOR ═══ */
    .led-section {
        margin-top: var(--space-3);
        padding: var(--space-3);
        background: var(--color-warning-subtle);
        border: 1px solid rgba(217, 119, 6, 0.2);
        border-radius: var(--radius-lg)
    }

    .led-toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-2) 0
    }

    .led-toggle-row span {
        font-size: var(--text-sm);
        color: var(--color-warning);
        font-weight: var(--weight-medium);
        display: flex;
        align-items: center;
        gap: 6px
    }

    .led-edges {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin: 10px 0
    }

    .led-edge-box {
        position: relative;
        width: 120px;
        height: 80px;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-sm);
        flex-shrink: 0
    }

    .led-edge {
        position: absolute;
        background: var(--color-border-strong);
        border: none;
        cursor: pointer;
        border-radius: 3px;
        transition: background var(--duration-fast) var(--ease-default)
    }

    .led-edge.on {
        background: var(--color-warning)
    }

    .led-edge.top {
        top: -4px;
        left: 10px;
        right: 10px;
        height: 6px
    }

    .led-edge.bottom {
        bottom: -4px;
        left: 10px;
        right: 10px;
        height: 6px
    }

    .led-edge.left {
        left: -4px;
        top: 10px;
        bottom: 10px;
        width: 6px
    }

    .led-edge.right {
        right: -4px;
        top: 10px;
        bottom: 10px;
        width: 6px
    }

    .led-edge-label {
        position: absolute;
        font-size: 9px;
        color: var(--color-text-tertiary);
        pointer-events: none
    }

    .led-edge-label.top {
        top: -16px;
        left: 50%;
        transform: translateX(-50%)
    }

    .led-edge-label.bottom {
        bottom: -16px;
        left: 50%;
        transform: translateX(-50%)
    }

    .led-edge-label.left {
        left: -30px;
        top: 50%;
        transform: translateY(-50%)
    }

    .led-edge-label.right {
        right: -30px;
        top: 50%;
        transform: translateY(-50%)
    }

    .led-opts {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 0
    }

    .led-shelf-row {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-xs);
        color: var(--color-text-secondary)
    }

    .led-shelf-row input {
        width: 48px;
        padding: var(--space-1);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        color: var(--color-text-primary);
        text-align: center;
        font-size: var(--text-xs);
        font-family: var(--font-mono)
    }

    .led-shelf-row button {
        padding: 2px var(--space-2);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: var(--text-xs);
        cursor: pointer;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .led-shelf-row button.on {
        background: var(--color-warning);
        color: var(--color-text-primary);
        border-color: var(--color-warning)
    }

    .led-meters {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        margin: 6px 0;
        flex-wrap: wrap
    }

    .led-meters input {
        width: 56px;
        padding: 3px;
        background: var(--color-surface-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        text-align: center;
        font-size: var(--text-xs);
        font-family: var(--font-mono)
    }

    .led-meters strong {
        color: var(--color-warning)
    }

    .led-radio {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 6px 0
    }

    .led-radio button {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: var(--text-xs);
        cursor: pointer;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .led-radio button.sel {
        background: var(--color-warning);
        color: var(--color-text-primary);
        border-color: var(--color-warning)
    }

    .led-bom-preview {
        margin-top: var(--space-2);
        padding: var(--space-2);
        background: var(--color-surface-3);
        border-radius: var(--radius-lg);
        font-size: var(--text-xs)
    }

    .led-bom-preview .led-bom-row {
        display: flex;
        justify-content: space-between;
        padding: 1px 0;
        color: var(--color-text-secondary)
    }

    .led-bom-preview .led-bom-row strong {
        color: var(--color-warning);
        font-family: var(--font-mono)
    }

    .led-bom-total {
        display: flex;
        justify-content: space-between;
        padding-top: var(--space-1);
        border-top: 1px solid var(--color-border);
        font-weight: var(--weight-bold);
        color: var(--color-warning);
        margin-top: var(--space-1)
    }

    /* ═══ CLOSET ESTANDARIZADO ═══ */
    .est-modules-row {
        display: flex;
        gap: var(--space-3);
        overflow-x: auto;
        padding: var(--space-3) 0;
        -webkit-overflow-scrolling: touch
    }

    .est-mod-card {
        min-width: 100px;
        flex-shrink: 0;
        padding: var(--space-3);
        background: var(--color-bg-elevated);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-xl);
        text-align: center;
        cursor: pointer;
        position: relative;
        transition: all var(--duration-fast) var(--ease-default)
    }

    .est-mod-card:hover {
        border-color: var(--color-border-strong)
    }

    .est-mod-card.sel {
        border-color: var(--color-accent);
        background: var(--color-accent-subtle)
    }

    .est-mod-card .est-mod-num {
        width: 24px;
        height: 24px;
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border-radius: var(--radius-full);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-xs);
        font-weight: var(--weight-bold);
        margin-bottom: 6px
    }

    .est-mod-card .est-mod-w {
        font-size: var(--text-base);
        font-weight: var(--weight-bold);
        color: var(--color-text-primary);
        margin-top: var(--space-1)
    }

    .est-mod-card .est-mod-type {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        margin-top: 2px
    }

    .est-mod-card .est-mod-arrows {
        display: flex;
        justify-content: center;
        gap: var(--space-1);
        margin-top: 6px
    }

    .est-mod-card .est-mod-arrows button {
        width: 24px;
        height: 24px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--color-border);
        background: var(--color-bg-elevated);
        color: var(--color-text-primary);
        font-size: var(--text-xs);
        cursor: pointer;
        transition: background var(--duration-fast) var(--ease-default)
    }

    .est-mod-card .est-mod-arrows button:hover {
        background: var(--color-surface-hover)
    }

    .est-mod-del {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        background: var(--color-danger-subtle);
        color: var(--color-danger);
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: var(--text-xs);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background var(--duration-fast) var(--ease-default)
    }

    .est-mod-del:hover {
        background: rgba(220, 38, 38, 0.2)
    }

    .est-add-btn {
        min-width: 80px;
        flex-shrink: 0;
        padding: var(--space-3);
        border: 2px dashed var(--color-accent);
        border-radius: var(--radius-xl);
        background: none;
        color: var(--color-accent);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--space-1);
        font-size: var(--text-sm);
        font-weight: var(--weight-semi);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .est-add-btn:hover {
        background: var(--color-accent-subtle)
    }

    .est-zone {
        padding: var(--space-3);
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-2)
    }

    .est-zone-hdr {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-2)
    }

    .est-zone-hdr strong {
        font-size: var(--text-base);
        color: var(--color-accent)
    }

    .est-zone-actions {
        display: flex;
        gap: var(--space-1)
    }

    .est-zone-actions button {
        width: 28px;
        height: 28px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background: var(--color-bg-elevated);
        color: var(--color-text-primary);
        font-size: var(--text-base);
        cursor: pointer;
        transition: all var(--duration-fast) var(--ease-default)
    }

    .est-zone-actions button:hover {
        background: var(--color-surface-hover)
    }

    .est-zone-actions button.del {
        background: var(--color-danger-subtle);
        color: var(--color-danger);
        border-color: transparent
    }

    .est-zone-actions button.del:hover {
        background: rgba(220, 38, 38, 0.2)
    }

    .est-zone-row {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: 6px;
        flex-wrap: wrap
    }

    .est-zone-row span {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        min-width: 60px
    }
    /* ═══ HEIGHT BAR & VISUAL ═══ */
    .est-height-bar {
        margin: var(--space-3) 0;
        padding: var(--space-3);
        background: var(--color-surface-2);
        border: 1px solid var(--color-border-subtle);
        border-radius: var(--radius-lg)
    }

    .est-vbar-wrap {
        display: flex;
        gap: var(--space-3);
        align-items: stretch
    }

    .est-vbar {
        width: 60px;
        min-height: 220px;
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        background: var(--color-bg-elevated)
    }

    .est-vbar-seg {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        color: var(--color-text-inverse);
        overflow: hidden;
        min-height: 2px;
        position: relative;
        box-sizing: border-box
    }

    .est-vbar-seg.techo, .est-vbar-seg.piso {
        background: var(--color-surface-hover);
        color: var(--color-text-tertiary)
    }

    .est-vbar-seg.cajones {
        background: var(--color-accent)
    }

    .est-vbar-seg.colgador {
        background: rgba(2, 132, 199, 0.25);
        border: 1px dashed rgba(2, 132, 199, 0.5)
    }

    .est-vbar-seg.zapatero {
        background: #7C3AED
    }

    .est-vbar-seg.entrepa {
        background: var(--color-border-strong);
        min-height: 3px
    }

    .est-vbar-seg.entrepa_esp {
        background: var(--color-border);
        min-height: 3px;
        border: 1px dashed var(--color-border-strong)
    }

    .est-vbar-seg.libre {
        background: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(15, 23, 42, 0.04) 3px, rgba(15, 23, 42, 0.04) 6px)
    }

    .est-vbar-seg.exceso {
        background: var(--color-danger-subtle);
        border: 1px solid var(--color-danger)
    }

    .est-vbar-seg.fijo {
        background: rgba(100, 116, 139, 0.3);
        border: 1px solid rgba(148, 163, 184, 0.5)
    }

    .est-vbar-seg.maletero {
        background: var(--color-warning-subtle);
        border: 1px solid rgba(217, 119, 6, 0.3)
    }

    .est-vbar-seg.zoclo {
        background: rgba(120, 90, 60, 0.3);
        border: 1px solid rgba(120, 90, 60, 0.4);
        font-size: 8px;
        color: #92643a
    }

    .est-vbar-info {
        flex: 1;
        font-size: var(--text-xs);
        display: flex;
        flex-direction: column;
        gap: 2px
    }

    .est-vbar-row {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        color: var(--color-text-secondary)
    }

    .est-vbar-row strong {
        color: var(--color-text-primary)
    }

    .est-vbar-warn {
        font-size: var(--text-xs);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        margin-top: var(--space-1)
    }

    .est-vbar-warn.yellow {
        background: var(--color-warning-subtle);
        color: var(--color-warning);
        border: 1px solid rgba(217, 119, 6, 0.2)
    }

    .est-vbar-warn.red {
        background: var(--color-danger-subtle);
        color: var(--color-danger);
        border: 1px solid rgba(220, 38, 38, 0.2)
    }

    .est-vbar-warn.blue {
        background: var(--color-info-subtle);
        color: var(--color-info);
        border: 1px solid rgba(2, 132, 199, 0.2)
    }

    .est-chap-grid {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        margin-top: var(--space-2)
    }

    .est-chap-edge {
        padding: 6px var(--space-3);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: var(--text-xs);
        cursor: pointer;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .est-chap-edge:hover {
        border-color: var(--color-border-strong)
    }

    .est-chap-edge.on {
        background: var(--color-accent-subtle);
        border-color: var(--color-accent);
        color: var(--color-accent)
    }

    .est-total-bar {
        padding: var(--space-3);
        background: var(--color-accent-subtle);
        border: 1px solid var(--color-accent-border);
        border-radius: var(--radius-xl);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: var(--space-3) 0
    }

    .est-total-bar span {
        color: var(--color-accent);
        font-weight: var(--weight-medium);
        font-size: var(--text-base)
    }

    .est-total-bar strong {
        font-size: var(--text-xl);
        color: var(--color-accent);
        font-family: var(--font-mono)
    }

    /* ═══ SILHOUETTE ═══ */
    .est-silhouette {
        width: 60px;
        height: 80px;
        margin: 0 auto 4px;
        display: flex;
        flex-direction: column;
        gap: 1px;
        padding: 2px;
        background: var(--color-surface-3);
        border-radius: var(--radius-sm)
    }

    .est-silhouette.est-sil-esq {
        clip-path: polygon(0 0, 100% 0, 100% 40%, 50% 40%, 50% 100%, 0 100%);
        width: 70px
    }

    .est-sil-zone {
        border-radius: 2px;
        width: 100%
    }

    .est-sil-cajones {
        background: rgba(3, 105, 161, 0.4)
    }

    .est-sil-colgador {
        background: rgba(2, 132, 199, 0.3)
    }

    .est-sil-zapatero {
        background: rgba(124, 58, 237, 0.4)
    }

    .est-sil-entrepa {
        background: rgba(148, 163, 184, 0.4)
    }

    .est-sil-entrepa_esp {
        background: rgba(148, 163, 184, 0.25);
        border: 1px dashed rgba(148, 163, 184, 0.5)
    }

    .est-sil-fijo {
        background: rgba(100, 116, 139, 0.3);
        border: 1px dashed rgba(148, 163, 184, 0.4)
    }

    .est-sil-maletero {
        background: rgba(217, 119, 6, 0.3)
    }

    .est-sil-zoclo {
        background: rgba(120, 90, 60, 0.3);
        border-top: 1px solid rgba(120, 90, 60, 0.4)
    }

    .est-mod-card.especial {
        border-color: var(--color-text-tertiary)
    }

    /* ═══ EST NAVIGATION ═══ */
    .est-home-btn {
        width: 100%;
        padding: var(--space-5);
        background: var(--color-accent-subtle);
        border: 2px solid var(--color-accent);
        border-radius: var(--radius-xl);
        color: var(--color-accent);
        font-size: 1rem;
        font-weight: var(--weight-bold);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .est-home-btn:hover {
        background: rgba(3, 105, 161, 0.12)
    }

    .est-step-dots {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-3)
    }

    .est-step-dot {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--weight-bold);
        font-size: var(--text-sm);
        border: none;
        cursor: pointer;
        transition: all var(--duration-fast) var(--ease-default)
    }

    .est-step-dot.active {
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        transform: scale(1.1)
    }

    .est-step-dot.done {
        background: var(--color-accent-subtle);
        color: var(--color-accent)
    }

    .est-step-dot.future {
        background: var(--color-surface-3);
        color: var(--color-text-tertiary);
        cursor: default
    }

    .est-step-line {
        width: 28px;
        height: 3px;
        border-radius: 2px;
        background: var(--color-border)
    }

    .est-step-line.done {
        background: var(--color-accent-subtle)
    }

    /* ═══ SAVED PROJECTS ═══ */
    .saved-projects-section {
        margin-top: var(--space-6);
        padding-top: var(--space-4);
        border-top: 1px solid var(--color-border)
    }

    .saved-projects-title {
        font-size: var(--text-sm);
        font-weight: var(--weight-semi);
        color: var(--color-text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-3)
    }

    .saved-project-card {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: 14px;
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-2);
        position: relative;
        transition: border-color var(--duration-fast) var(--ease-default)
    }

    .saved-project-card:hover {
        border-color: var(--color-border-strong)
    }

    .saved-project-info {
        flex: 1;
        min-width: 0
    }

    .saved-project-info .sp-client {
        font-size: var(--text-md);
        font-weight: var(--weight-semi);
        color: var(--color-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
    }

    .saved-project-info .sp-meta {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        margin-top: 2px
    }

    .saved-project-actions {
        display: flex;
        gap: 6px;
        flex-shrink: 0
    }

    .saved-project-actions button {
        padding: 6px 14px;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: var(--text-xs);
        cursor: pointer;
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .saved-project-actions .sp-load {
        border-color: var(--color-accent);
        color: var(--color-accent)
    }

    .saved-project-actions .sp-load:hover {
        background: var(--color-accent-subtle)
    }

    .saved-project-actions .sp-del {
        border-color: var(--color-danger);
        color: var(--color-danger)
    }

    .saved-project-actions .sp-del:hover {
        background: var(--color-danger-subtle)
    }

    .est-dup-btn {
        width: 100%;
        padding: var(--space-3);
        margin-top: var(--space-3);
        background: var(--color-info-subtle);
        border: 2px dashed rgba(2, 132, 199, 0.3);
        border-radius: var(--radius-lg);
        color: var(--color-info);
        font-size: var(--text-base);
        font-weight: var(--weight-semi);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .est-dup-btn:hover {
        background: rgba(2, 132, 199, 0.12);
        border-color: rgba(2, 132, 199, 0.5)
    }

    .est-save-btn {
        width: 100%;
        padding: 14px;
        margin-top: var(--space-4);
        background: var(--color-success-subtle);
        border: 2px solid rgba(5, 150, 105, 0.3);
        border-radius: var(--radius-lg);
        color: var(--color-success);
        font-size: var(--text-base);
        font-weight: var(--weight-semi);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        font-family: var(--font-sans);
        transition: all var(--duration-fast) var(--ease-default)
    }

    .est-save-btn:hover {
        background: rgba(5, 150, 105, 0.12);
        border-color: rgba(5, 150, 105, 0.5)
    }

    /* ═══ SETUP WIZARD ═══ */
    .setup-overlay {
        position: fixed;
        inset: 0;
        z-index: var(--z-setup);
        background: var(--color-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
        padding: var(--space-5);
        box-sizing: border-box;
    }
    .setup-card {
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-2xl);
        padding: 36px 32px;
        width: 100%;
        max-width: 480px;
        box-sizing: border-box;
        box-shadow: var(--shadow-lg);
    }
    .setup-card h1 {
        color: var(--color-accent);
        font-size: 1.375rem;
        font-weight: var(--weight-bold);
        margin: 0 0 6px;
        letter-spacing: 0.02em;
    }
    .setup-card .setup-subtitle {
        color: var(--color-text-tertiary);
        font-size: var(--text-sm);
        margin: 0 0 28px;
    }
    .setup-divider {
        color: var(--color-accent);
        font-size: var(--text-xs);
        font-weight: var(--weight-semi);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin: 24px 0 14px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--color-border);
    }
    .setup-field {
        margin-bottom: 14px;
    }
    .setup-field label {
        display: block;
        font-size: var(--text-xs);
        color: var(--color-text-secondary);
        margin-bottom: 5px;
        font-weight: var(--weight-medium);
    }
    .setup-field input[type="text"],
    .setup-field input[type="email"] {
        width: 100%;
        background: var(--color-surface-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        font-size: var(--text-base);
        padding: 10px 12px;
        box-sizing: border-box;
        outline: none;
        transition: border-color var(--duration-fast) var(--ease-default), box-shadow var(--duration-fast) var(--ease-default);
        font-family: var(--font-sans);
    }
    .setup-field input[type="text"]:focus,
    .setup-field input[type="email"]:focus {
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring);
    }
    .setup-field input.setup-error {
        border-color: var(--color-danger) !important;
    }
    .setup-field .setup-hint {
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        margin-top: 3px;
    }
    .setup-logo-preview {
        margin-top: var(--space-2);
        height: 60px;
        display: none;
        object-fit: contain;
        border-radius: var(--radius-md);
        background: var(--color-surface-3);
        padding: var(--space-1);
    }
    .setup-file-label {
        display: inline-block;
        cursor: pointer;
        background: var(--color-surface-3);
        border: 1px dashed var(--color-border-strong);
        border-radius: var(--radius-lg);
        color: var(--color-text-tertiary);
        font-size: var(--text-sm);
        padding: 10px var(--space-4);
        transition: border-color var(--duration-fast) var(--ease-default), color var(--duration-fast) var(--ease-default);
    }
    .setup-file-label:hover { border-color: var(--color-accent); color: var(--color-accent); }
    .setup-file-input { display: none; }
    .setup-btn {
        width: 100%;
        background: var(--color-accent);
        color: var(--color-text-on-accent);
        border: none;
        border-radius: var(--radius-lg);
        font-size: var(--text-md);
        font-weight: var(--weight-bold);
        padding: 14px;
        cursor: pointer;
        margin-top: 24px;
        transition: background var(--duration-fast) var(--ease-default), opacity var(--duration-fast) var(--ease-default);
        font-family: var(--font-sans);
        letter-spacing: 0.02em;
    }
    .setup-btn:hover { background: var(--color-accent-hover); }
    .setup-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .setup-footer-note {
        text-align: center;
        color: var(--color-text-tertiary);
        font-size: var(--text-xs);
        margin-top: 14px;
    }

    /* ═══════════════════════════════════════════════════════════════
       BLUEPRINT CANVAS v3 — Free 2D Konva.js Floor Plan Builder
       ═══════════════════════════════════════════════════════════════ */

    .bp-layout {
        display: flex;
        gap: 16px;
        margin-top: 12px;
    }

    /* Module palette sidebar */
    .bp-palette {
        width: 200px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 600px;
        overflow-y: auto;
    }
    .bp-palette-tile {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        background: var(--color-surface-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.15s ease;
        font-size: var(--text-sm);
        color: var(--color-text-primary);
    }
    .bp-palette-tile:hover {
        background: var(--color-surface-hover);
        border-color: var(--color-accent);
        transform: translateY(-1px);
    }
    .bp-palette-tile .tile-plus {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--color-accent-subtle);
        color: var(--color-accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        flex-shrink: 0;
    }
    .bp-palette-tile .tile-cat-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    /* Canvas wrap */
    .bp-canvas-wrap {
        flex: 1;
        min-width: 0;
    }

    /* Toolbar above canvas */
    .bp-toolbar {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: var(--color-surface-1);
        border: 1px solid var(--color-border);
        border-bottom: none;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        font-size: var(--text-sm);
        flex-wrap: wrap;
    }
    .bp-toolbar-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        background: var(--color-surface-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: var(--text-xs);
        color: var(--color-text-secondary);
        transition: all 0.15s;
        font-family: var(--font-sans);
    }
    .bp-toolbar-btn:hover {
        background: var(--color-surface-hover);
        border-color: var(--color-accent);
        color: var(--color-accent);
    }
    .bp-toolbar-btn.active {
        background: var(--color-accent);
        color: #fff;
        border-color: var(--color-accent);
    }
    .bp-toolbar-sep {
        width: 1px;
        height: 20px;
        background: var(--color-border);
        margin: 0 4px;
    }
    .bp-zoom-label {
        font-family: var(--font-mono);
        font-size: var(--text-xs);
        color: var(--color-text-tertiary);
        min-width: 40px;
        text-align: center;
    }

    /* Konva canvas container */
    .bp-konva-container {
        width: 100%;
        height: 500px;
        border: 1px solid var(--color-border);
        border-top: none;
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        overflow: hidden;
        position: relative;
        background: var(--color-surface-2);
        cursor: default;
    }
    .bp-konva-container.wall-mode {
        cursor: crosshair;
    }
    .bp-konva-container.panning {
        cursor: grab;
    }

    /* Scale indicator overlay */
    .bp-scale-indicator {
        position: absolute;
        bottom: 8px;
        left: 10px;
        font-family: var(--font-mono);
        font-size: 10px;
        color: var(--color-text-tertiary);
        pointer-events: none;
        z-index: 5;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .bp-scale-bar {
        height: 2px;
        background: var(--color-text-tertiary);
        display: inline-block;
    }

    /* Config panel below canvas */
    .bp-config {
        margin-top: 12px;
        background: var(--color-surface-1);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 16px;
    }
    .bp-config-title {
        font-weight: var(--weight-semi);
        font-size: var(--text-md);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .bp-config-title .bp-config-num {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--color-accent);
        color: #fff;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .bp-no-sel {
        color: var(--color-text-tertiary);
        font-size: var(--text-sm);
        font-style: italic;
        padding: 8px 0;
    }

    /* Total width bar */
    .bp-total-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-top: 8px;
        background: var(--color-accent-subtle);
        border: 1px solid var(--color-accent-border);
        border-radius: 6px;
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
    }
    .bp-total-bar strong {
        color: var(--color-accent);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .bp-layout {
            flex-direction: column;
        }
        .bp-palette {
            width: 100%;
            flex-direction: row;
            flex-wrap: wrap;
            max-height: none;
        }
        .bp-palette-tile {
            flex: 1 1 calc(50% - 4px);
            min-width: 120px;
        }
        .bp-konva-container {
            height: 350px;
        }
    }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="supplier-catalog-data.js"></script>
    <script>
    (function() {
        // ╔══════════════════════════════════════════════════════════════╗
        // ║  BLUEPRINT CANVAS — Scale constant (1cm = PX_PER_CM pixels) ║
        // ╚══════════════════════════════════════════════════════════════╝
        var PX_PER_CM = 1;  // 1px = 1cm in floor plan view (zoom adjusts visual size)

        // ╔══════════════════════════════════════════════════════════════╗
        // ║  CONFIG — Edit this section to customize for your business  ║
        // ╚══════════════════════════════════════════════════════════════╝
        var CONFIG = {
            version: '1.0',
            brand: {
                name: 'Renova',
                mono: 'RN',
                tagline: 'Muebles a la Medida',
                altBrand: null, // e.g. { id:'alt', mono:'ALT', name:'OTRA MARCA', tagline:'Subtitulo' }
                // CUSTOMIZE: Legal terms for client PDF — edit these to match your business terms
                legalTerms: [
                    'ACUERDO:',
                    'Vigencia de cotizacion 15 dias naturales a partir de la fecha.',
                    'Tiempo de entrega de 6-8 semanas a partir de aprobacion del diseno y anticipo del 60%.',
                    'Se inicia el proyecto con anticipo del 60% y el saldo del 40% con muebles fabricados en taller previo a la instalacion.',
                    'Una vez realizado el pago del anticipo, no se podra realizar cancelacion de trabajos.',
                    'Cualquier alteracion y/o solicitud nueva al proyecto se cobrara aparte.',
                    '',
                    'INSTALACION:',
                    'El presupuesto incluye traslado en la ubicacion acordada, dentro de la Zona Metropolitana de Monterrey.',
                    'La instalacion NO incluye ajustes o cambios en trabajos que no se incluyan o que no correspondan al giro de la empresa previamente solicitado (instalaciones Electricas, Hidraulicas, Gas).',
                    'El horario de instalacion es de 9:00 am a 5:00 pm de Lunes a Viernes.',
                    'El espacio debe estar adecuado y libre para instalacion.',
                    '',
                    'MATERIALES:',
                    'La sobreexposicion al sol y rayos UV generan un deterioro indebido el cual no sera objeto de garantia. De igual manera la exposicion a exceso de humedad o fugas dentro del espacio.'
                ]
            },
            contact: {
                name: 'Renova',
                office: '00 0000-0000',
                cell: '00 0000-0000',
                email: 'contacto@miempresa.com',
                city: 'Tu Ciudad'
            },
            quoting: {
                prefix: 'COT',
                defaultDelivery: '6-8 semanas',
                defaultAnticipo: 60,
                terms: [
                    '{anticipo}% de anticipo, resto al programar la instalacion',
                    'El pago total debera estar cubierto al llegar a la obra',
                    'Tiempo de entrega: {deliveryTime} habiles a partir del anticipo',
                    'Incluye: fabricacion, transporte, instalacion y regulador',
                    'No incluye: instalaciones electricas, obra civil, plomeria',
                    'Instalaciones: Lun-Vie 9AM-5PM / Sab 9AM-1PM',
                    'Cotizacion vigente por 15 dias'
                ],
                htmlTerms: [
                    '{anticipo}% anticipo para iniciar',
                    'Resto al programar instalacion',
                    'Tiempo: {deliveryTime}',
                    'Incluye instalacion',
                    'NO incluye instalaciones electricas'
                ]
            },
            storage: {
                prefix: 'cot_'
            },
            pwa: {
                cacheName: 'cotizador-v5'
            },
            pricing: {
                iva: 0.16,
                marginCarp: 66,
                marginHwStd: 66,
                marginBlum: 0.30,
                // CUSTOMIZE: Material merma (waste) factor — 1.20 = 20% extra material
                mermaFactor: 1.20,
                // CUSTOMIZE: Hardware pricing — items with total cost <= threshold go into carpentry bucket (3x multiplier), above threshold get premium margin (30%)
                carpentryMultiplier: 3,
                hardwareThreshold: 500,
                premiumHardwareMargin: 0.30,
                extrasMultiplier: 4,
                cuttingCostPerSheet: 75,
                glassCostPerM2: 800,
                defaultLaborCost: 5000,
                defaultFreightCost: 2000,
                defaultChapPrice: 13.10,
                defaultEnchapPrice: 13,
                defaultChapSpec: '1mm x 19mm ABS para refilar',
                saleMultiplierPresets: [1.5, 2, 2.5, 3],
                defaultSaleMultiplier: 2,
                // CUSTOMIZE: Cubierta pricing per m2 (MXN) — postformado/cuarzo/granito
                cubiertaPrices: {
                    postformado: 2500,
                    cuarzo: 8500,
                    granito: 6500
                }
            },
            // CUSTOMIZE: Bisagra auto-assignment rules — adjust count by door height and material
            hardware: {
                autoAssignRules: {
                    puertas: {
                        bisagras: [
                            { maxHeight: 100, count: 3 },
                            { maxHeight: 200, count: 4 },
                            { maxHeight: Infinity, count: 5 }
                        ],
                        heavyMaterialBonus: 1
                    }
                }
            },
            supabase: {
                url: '',
                key: ''
            },
            bundledProjects: []
        };

        // ╔══════════════════════════════════════════════════════════════╗
        // ║  APP_CONFIG — Multi-tenant runtime configuration layer       ║
        // ╚══════════════════════════════════════════════════════════════╝
        var APP_CONFIG_KEY = CONFIG.storage.prefix + 'app_config';

        function loadAppConfig() {
            try {
                var raw = localStorage.getItem(APP_CONFIG_KEY);
                if (!raw) return null;
                var appConfig = JSON.parse(raw);
                // Override CONFIG.brand fields
                if (appConfig.companyName) CONFIG.brand.name = appConfig.companyName;
                if (appConfig.monogram)    CONFIG.brand.mono = appConfig.monogram;
                if (appConfig.tagline)     CONFIG.brand.tagline = appConfig.tagline;
                if (appConfig.legalTerms)  CONFIG.brand.legalTerms = appConfig.legalTerms;
                // Override CONFIG.contact fields
                if (appConfig.contactName)   CONFIG.contact.name   = appConfig.contactName;
                if (appConfig.contactCity)   CONFIG.contact.city   = appConfig.contactCity;
                if (appConfig.contactOffice) CONFIG.contact.office = appConfig.contactOffice;
                if (appConfig.contactCell)   CONFIG.contact.cell   = appConfig.contactCell;
                if (appConfig.contactEmail)  CONFIG.contact.email  = appConfig.contactEmail;
                // Override CONFIG.supabase fields
                if (appConfig.supabaseUrl) CONFIG.supabase.url = appConfig.supabaseUrl;
                if (appConfig.supabaseKey) CONFIG.supabase.key = appConfig.supabaseKey;
                // If logo was saved in APP_CONFIG, persist it to the standard logo key
                if (appConfig.logoBase64) {
                    try { localStorage.setItem(CONFIG.storage.prefix + 'logo_base64', appConfig.logoBase64); } catch(e) {}
                }
                return appConfig;
            } catch(e) { return null; }
        }

        function saveAppConfig(data) {
            try {
                localStorage.setItem(APP_CONFIG_KEY, JSON.stringify(data));
                loadAppConfig();
                return true;
            } catch(e) { return false; }
        }

        function hasAppConfig() {
            return !!localStorage.getItem(APP_CONFIG_KEY);
        }

        // ╔══════════════════════════════════════════════════════════════╗
        // ║  LICENSE VALIDATION                                          ║
        // ╚══════════════════════════════════════════════════════════════╝
        var LICENSE_SALT = 'renova-cotizador-2024';

        function simpleHash(str) {
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                var chr = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + chr;
                hash |= 0;
            }
            return hash.toString(36);
        }

        function validateLicense() {
            var appCfgRaw = localStorage.getItem(APP_CONFIG_KEY);
            if (!appCfgRaw) return { valid: false, reason: 'no_key' };
            var appCfg;
            try { appCfg = JSON.parse(appCfgRaw); } catch(e) { return { valid: false, reason: 'no_key' }; }
            var licenseKey = appCfg.licenseKey;
            if (!licenseKey) return { valid: false, reason: 'no_key' };
            try {
                var decoded = JSON.parse(atob(licenseKey));
                var expectedHash = simpleHash(decoded.client + decoded.exp + LICENSE_SALT);
                if (decoded.hash !== expectedHash) return { valid: false, reason: 'invalid' };
                if (new Date(decoded.exp) < new Date()) {
                    return { valid: false, reason: 'expired', client: decoded.client, exp: decoded.exp };
                }
                return { valid: true, client: decoded.client, exp: decoded.exp };
            } catch(e) {
                return { valid: false, reason: 'invalid' };
            }
        }

        function generateLicenseKey(client, expDate) {
            var hash = simpleHash(client + expDate + LICENSE_SALT);
            var payload = { client: client, exp: expDate, hash: hash };
            return btoa(JSON.stringify(payload));
        }

        function showLockScreen(reason, details) {
            var existing = document.getElementById('license-lock');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);

            var messages = {
                no_key: 'Licencia No Configurada &mdash; Ingrese su clave de licencia para utilizar el cotizador.',
                invalid: 'Licencia Invalida &mdash; La clave de licencia no es valida. Contacte soporte.',
                expired: 'Licencia Expirada &mdash; Su licencia expiro el ' + (details && details.exp ? details.exp : '') + '. Contacte soporte para renovar.'
            };
            var msg = messages[reason] || messages.invalid;
            var supportEmail = (CONFIG.contact && CONFIG.contact.email) ? CONFIG.contact.email : 'soporte@renova.mx';

            var overlay = document.createElement('div');
            overlay.id = 'license-lock';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#0d0d0d;z-index:10001;display:flex;align-items:center;justify-content:center;font-family:sans-serif;';
            overlay.innerHTML = [
                '<div style="max-width:420px;width:90%;text-align:center;padding:40px 32px;background:#141414;border-radius:16px;border:1px solid #2a2a2a;">',
                '  <div style="font-size:56px;margin-bottom:16px;">&#x1F512;</div>',
                '  <h2 style="color:#c49a6c;font-size:20px;margin:0 0 12px;font-weight:600;">Acceso Bloqueado</h2>',
                '  <p style="color:#aaa;font-size:14px;line-height:1.5;margin:0 0 24px;">' + msg + '</p>',
                '  <div style="margin-bottom:12px;">',
                '    <input id="lic-key-input" type="text" placeholder="Ingrese clave de licencia" style="width:100%;box-sizing:border-box;padding:10px 12px;background:#1e1e1e;border:1px solid #333;border-radius:8px;color:#fff;font-size:13px;outline:none;">',
                '  </div>',
                '  <button id="lic-validate-btn" style="width:100%;padding:12px;background:#c49a6c;color:#1a1a2e;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;margin-bottom:20px;">Validar</button>',
                '  <p style="color:#555;font-size:12px;margin:0;">Soporte: <a href="mailto:' + supportEmail + '" style="color:#c49a6c;text-decoration:none;">' + supportEmail + '</a></p>',
                '</div>'
            ].join('\n');

            document.body.appendChild(overlay);

            var btn = document.getElementById('lic-validate-btn');
            if (btn) {
                btn.addEventListener('click', function() {
                    var keyInput = document.getElementById('lic-key-input');
                    var newKey = keyInput ? keyInput.value.trim() : '';
                    if (!newKey) return;

                    var appCfgRaw = localStorage.getItem(APP_CONFIG_KEY);
                    var appCfg = {};
                    try { appCfg = JSON.parse(appCfgRaw) || {}; } catch(e) {}
                    appCfg.licenseKey = newKey;
                    saveAppConfig(appCfg);

                    var result = validateLicense();
                    if (result.valid) {
                        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                        window.location.reload();
                    } else {
                        var inputEl = document.getElementById('lic-key-input');
                        if (inputEl) {
                            inputEl.style.borderColor = '#f44336';
                            inputEl.placeholder = 'Clave invalida. Intente nuevamente.';
                            inputEl.value = '';
                        }
                    }
                });
            }
        }

        function showLicenseInfo() {
            var existing = document.getElementById('license-info-overlay');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);

            var result = validateLicense();
            var version = CONFIG.version || '1.0';
            var supportEmail = (CONFIG.contact && CONFIG.contact.email) ? CONFIG.contact.email : 'soporte@renova.mx';
            var supportPhone = (CONFIG.contact && CONFIG.contact.cell) ? CONFIG.contact.cell : '';

            var clientText = result.client || '&mdash;';
            var expText = '&mdash;';
            var statusColor = '#888';
            var statusText = 'Sin licencia';

            if (result.valid) {
                statusColor = '#4caf50';
                statusText = 'Activa';
                clientText = result.client;
                // Format date as "DD de Mes YYYY"
                try {
                    var meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
                    var parts = result.exp.split('-');
                    expText = parseInt(parts[2], 10) + ' de ' + meses[parseInt(parts[1], 10) - 1] + ' ' + parts[0];
                } catch(e) { expText = result.exp || '&mdash;'; }
            } else if (result.reason === 'expired') {
                statusColor = '#f44336';
                statusText = 'Expirada';
                clientText = result.client || '&mdash;';
                try {
                    var meses2 = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
                    var parts2 = (result.exp || '').split('-');
                    expText = parseInt(parts2[2], 10) + ' de ' + meses2[parseInt(parts2[1], 10) - 1] + ' ' + parts2[0];
                } catch(e) { expText = result.exp || '&mdash;'; }
            }

            var overlay = document.createElement('div');
            overlay.id = 'license-info-overlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;font-family:sans-serif;';
            overlay.innerHTML = [
                '<div style="max-width:400px;width:90%;background:#141414;border-radius:16px;border:1px solid #2a2a2a;overflow:hidden;">',
                '  <div style="padding:24px 28px 0;">',
                '    <h2 style="color:#c49a6c;font-size:18px;margin:0 0 20px;font-weight:600;">Informacion de Licencia</h2>',
                '    <table style="width:100%;border-collapse:collapse;font-size:14px;">',
                '      <tr><td style="color:#666;padding:8px 0 8px;border-bottom:1px solid #1e1e1e;width:100px;">Version</td><td style="color:#eee;padding:8px 0;border-bottom:1px solid #1e1e1e;">Cotizador Pro v' + version + '</td></tr>',
                '      <tr><td style="color:#666;padding:8px 0 8px;border-bottom:1px solid #1e1e1e;">Cliente</td><td style="color:#eee;padding:8px 0;border-bottom:1px solid #1e1e1e;">' + clientText + '</td></tr>',
                '      <tr><td style="color:#666;padding:8px 0 8px;border-bottom:1px solid #1e1e1e;">Expiracion</td><td style="color:#eee;padding:8px 0;border-bottom:1px solid #1e1e1e;">' + expText + '</td></tr>',
                '      <tr><td style="color:#666;padding:8px 0 8px;border-bottom:1px solid #1e1e1e;">Estado</td><td style="color:' + statusColor + ';padding:8px 0;border-bottom:1px solid #1e1e1e;font-weight:600;">' + statusText + '</td></tr>',
                '      <tr><td style="color:#666;padding:8px 0 8px;">Soporte</td><td style="padding:8px 0;"><a href="mailto:' + supportEmail + '" style="color:#c49a6c;text-decoration:none;font-size:13px;">' + supportEmail + '</a>' + (supportPhone ? '<br><span style="color:#aaa;font-size:12px;">' + supportPhone + '</span>' : '') + '</td></tr>',
                '    </table>',
                '  </div>',
                '  <div style="padding:20px 28px 24px;text-align:right;">',
                '    <button id="lic-info-close-btn" style="padding:10px 24px;background:#c49a6c;color:#1a1a2e;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">Cerrar</button>',
                '  </div>',
                '</div>'
            ].join('\n');

            document.body.appendChild(overlay);

            var closeBtn = document.getElementById('lic-info-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                });
            }
            // Also close on backdrop click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                }
            });
        }

        function showSetupScreen() {
            var overlay = document.createElement('div');
            overlay.className = 'setup-overlay';
            overlay.id = 'setup-overlay';
            overlay.innerHTML = [
                '<div class="setup-card">',
                '  <h1>Configuracion Inicial</h1>',
                '  <p class="setup-subtitle">Configure su instancia del cotizador</p>',

                '  <div class="setup-field">',
                '    <label>Empresa <span style="color:#c49a6c">*</span></label>',
                '    <input type="text" id="su-company" placeholder="Mi Carpinteria" maxlength="60">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Monograma <span style="color:#c49a6c">*</span></label>',
                '    <input type="text" id="su-mono" placeholder="MC" maxlength="4">',
                '    <div class="setup-hint">2-4 letras que identifican su empresa</div>',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Lema (opcional)</label>',
                '    <input type="text" id="su-tagline" placeholder="Muebles a la Medida" maxlength="80">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Logo (opcional)</label>',
                '    <label class="setup-file-label" for="su-logo-input">Seleccionar imagen</label>',
                '    <input type="file" id="su-logo-input" class="setup-file-input" accept="image/*">',
                '    <img id="su-logo-preview" class="setup-logo-preview" alt="Logo preview">',
                '  </div>',

                '  <div class="setup-divider">Licencia</div>',
                '  <div class="setup-field">',
                '    <label>Clave de Licencia (opcional)</label>',
                '    <input type="text" id="su-lickey" placeholder="Pegue su clave de licencia aqui">',
                '    <div class="setup-hint">Puede ingresar o actualizar la clave de licencia despues</div>',
                '  </div>',

                '  <div class="setup-divider">Conexion Cloud (Supabase)</div>',
                '  <div class="setup-field">',
                '    <label>URL de Supabase (opcional)</label>',
                '    <input type="text" id="su-sburl" placeholder="https://xxx.supabase.co">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Anon Key (opcional)</label>',
                '    <input type="text" id="su-sbkey" placeholder="eyJ...">',
                '  </div>',

                '  <div class="setup-divider">Datos de Contacto</div>',
                '  <div class="setup-field">',
                '    <label>Nombre de contacto (opcional)</label>',
                '    <input type="text" id="su-cname" placeholder="Mi Carpinteria">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Ciudad (opcional)</label>',
                '    <input type="text" id="su-ccity" placeholder="Monterrey">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Telefono oficina (opcional)</label>',
                '    <input type="text" id="su-coffice" placeholder="81 1234-5678">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Celular (opcional)</label>',
                '    <input type="text" id="su-ccell" placeholder="81 1234-5678">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Email (opcional)</label>',
                '    <input type="email" id="su-cemail" placeholder="info@micarpinteria.com">',
                '  </div>',

                '  <button class="setup-btn" id="su-save-btn">Guardar y Comenzar</button>',
                '  <p class="setup-footer-note">Puede modificar estos datos despues en Configuracion</p>',
                '</div>'
            ].join('\n');

            document.body.appendChild(overlay);

            // Logo file picker — show preview
            var logoInput = document.getElementById('su-logo-input');
            var logoPreview = document.getElementById('su-logo-preview');
            if (logoInput) {
                logoInput.addEventListener('change', function() {
                    var file = logoInput.files && logoInput.files[0];
                    if (!file) return;
                    var reader = new FileReader();
                    reader.onload = function(ev) {
                        logoPreview.src = ev.target.result;
                        logoPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                });
            }

            // Save button handler
            var saveBtn = document.getElementById('su-save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    var companyEl = document.getElementById('su-company');
                    var monoEl    = document.getElementById('su-mono');
                    var company   = companyEl ? companyEl.value.trim() : '';
                    var mono      = monoEl    ? monoEl.value.trim()    : '';

                    // Validate required fields
                    var valid = true;
                    if (!company) {
                        if (companyEl) companyEl.classList.add('setup-error');
                        valid = false;
                    } else {
                        if (companyEl) companyEl.classList.remove('setup-error');
                    }
                    if (!mono) {
                        if (monoEl) monoEl.classList.add('setup-error');
                        valid = false;
                    } else {
                        if (monoEl) monoEl.classList.remove('setup-error');
                    }
                    if (!valid) return;

                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Guardando...';

                    var data = {
                        companyName:   company,
                        monogram:      mono,
                        tagline:       (document.getElementById('su-tagline')  || {}).value || '',
                        licenseKey:    (document.getElementById('su-lickey')   || {}).value || '',
                        supabaseUrl:   (document.getElementById('su-sburl')    || {}).value || '',
                        supabaseKey:   (document.getElementById('su-sbkey')    || {}).value || '',
                        contactName:   (document.getElementById('su-cname')    || {}).value || '',
                        contactCity:   (document.getElementById('su-ccity')    || {}).value || '',
                        contactOffice: (document.getElementById('su-coffice')  || {}).value || '',
                        contactCell:   (document.getElementById('su-ccell')    || {}).value || '',
                        contactEmail:  (document.getElementById('su-cemail')   || {}).value || ''
                    };

                    // Handle logo: if base64 already loaded in preview, include it
                    var logoSrc = logoPreview ? logoPreview.src : '';
                    if (logoSrc && logoSrc.indexOf('data:') === 0) {
                        data.logoBase64 = logoSrc;
                    }

                    saveAppConfig(data);

                    // Remove overlay and reload cleanly
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    window.location.reload();
                });
            }
        }

        // Apply APP_CONFIG overrides immediately (before BRANDS are initialized)
        loadAppConfig();

        // Helper: get bisagra count based on door height (cm) and material type
        function getBisagraCount(heightCm, materialType) {
            var rules = CONFIG.hardware.autoAssignRules.puertas;
            var count = 3; // default
            for (var i = 0; i < rules.bisagras.length; i++) {
                if (heightCm <= rules.bisagras[i].maxHeight) {
                    count = rules.bisagras[i].count;
                    break;
                }
            }
            if (materialType === 'vidrio' || materialType === 'metal') {
                count += rules.heavyMaterialBonus;
            }
            return count;
        }

        // ┌─────────────────────────────────────────────────────────────┐
        // │  DEMO MATERIALS — Replace with real COLORS array when ready  │
        // │  To restore: delete this block and uncomment REAL block below│
        // └─────────────────────────────────────────────────────────────┘
        var COLORS = [
            { c: 'D01', n: 'Roble Natural', f: 'Demo' },
            { c: 'D02', n: 'Nogal Oscuro', f: 'Demo' },
            { c: 'D03', n: 'Encino Blanco', f: 'Demo' },
            { c: 'D04', n: 'Cerezo Clasico', f: 'Demo' },
            { c: 'D05', n: 'Gris Cemento', f: 'Demo' },
            { c: 'D06', n: 'Negro Mate', f: 'Demo' },
            { c: 'D07', n: 'Blanco Polar', f: 'Demo' },
            { c: 'D08', n: 'Fresno Humo', f: 'Demo' },
            { c: 'D09', n: 'Olmo Toscano', f: 'Demo' },
            { c: 'D10', n: 'Maple Dorado', f: 'Demo' }
        ];
        var FINSA_PRICES = {
            16: 1200,
            25: 1700
        };
        /* ── REAL COLORS (uncomment to restore) ──
        var COLORS = [
        { c: '74V', n: 'Roble Stella', f: 'Atlas' },
        { c: '98V', n: 'Roble Aurora', f: 'Atlas' },
        { c: '42B', n: 'Roble Trigo', f: 'Atlas' },
        { c: '95Q', n: 'Roble Trufa', f: 'Atlas' },
        { c: '97V', n: 'Roble Colorado', f: 'Atlas' },
        { c: '4AE', n: 'Roble Eternity', f: 'Atlas' },
        { c: '04R', n: 'Olmo Volga', f: 'Atlas' },
        { c: '16N', n: 'Fresno Glacial', f: 'Atlas' },
        { c: '91B', n: 'Roble Renovales', f: 'Atlas' },
        { c: '10C', n: 'Cambridge Walnut', f: 'Atlas' },
        { c: '75V', n: 'Roble Azabache', f: 'Atlas' },
        { c: '20N', n: 'Roble Sinatra', f: 'Atlas' },
        { c: '9AR', n: 'Hickory Frida', f: 'Boreal' },
        { c: '4AR', n: 'Olmo Sabi', f: 'Boreal' },
        { c: '1AS', n: 'Nogal Valentina', f: 'Mesura' },
        { c: '451B', n: 'Roble Newman', f: 'Mesura' },
        { c: '07R', n: 'Olmo Ontario', f: 'Poro' },
        { c: '12G', n: 'Lino Cancun', f: 'Textil' },
        { c: '890', n: 'Aluminio', f: 'Soft' },
        { c: 'U12', n: 'Natural Grey', f: 'Soft' },
        { c: '197', n: 'Gris Rioja', f: 'Soft' },
        { c: '71A', n: 'Gris Gu', f: 'Soft' },
        { c: '231', n: 'Negro', f: 'Soft' },
        { c: '465B', n: 'Verde Plomo', f: 'Soft' },
        { c: '3AU', n: 'Verde Arcilla', f: 'Soft' }
        ];
        var FINSA_PRICES = { 16: 1000, 25: 1400 };
        ── END REAL COLORS ── */
        // CUSTOMIZE: Project types — add/remove project categories for custom mode
        var TYPES = [{
            id: 'tv',
            n: 'Mueble de TV',
            i: '&#x1f4fa;'
        }, {
            id: 'credenza',
            n: 'Credenza',
            i: '&#x1f5c4;'
        }, {
            id: 'closet',
            n: 'Closet',
            i: '&#x1f454;'
        }, {
            id: 'cocina',
            n: 'Cocina',
            i: '&#x1f373;'
        }, {
            id: 'bano',
            n: 'Bano',
            i: '&#x1f6bf;'
        }, {
            id: 'puerta',
            n: 'Puertas',
            i: '&#x1f6aa;'
        }, {
            id: 'librero',
            n: 'Librero',
            i: '&#x1f4da;'
        }, {
            id: 'mesa_centro',
            n: 'Mesa de Centro',
            i: '&#x2615;'
        }, {
            id: 'otro',
            n: 'Otro',
            i: '&#x1f4e6;'
        }];
        // CUSTOMIZE: Module types — add new module types here (id, name, available widths, description)
        // Standard dimensions based on Mexico market
        var MODS = {
            // Closet modules — Prof: 55-60cm
            modulo: {
                n: 'Modulo',
                w: [70, 80, 90],
                d: 'Corredera oculta | Prof: 55-60cm',
                forType: ['closet'],
                cat: 'Modulos'
            },
            colgador: {
                n: 'Colgador',
                w: [90],
                d: 'Tubo sencillo | Min 110cm alto (largo), 90cm (corto)',
                forType: ['closet'],
                cat: 'Modulos'
            },
            zapatero: {
                n: 'Zapatero',
                w: [90],
                d: 'Extraible | 15-20cm por nivel',
                forType: ['closet'],
                cat: 'Modulos'
            },
            esquinero: {
                n: 'Esquinero',
                w: [90],
                d: '90x90 L-shape',
                forType: ['closet'],
                cat: 'Modulos'
            },
            entrepa: {
                n: 'Torre de Entrepa\u00f1os',
                w: [30, 40, 50, 60, 70, 80, 90, 100],
                d: 'Torre completa de entrepa\u00f1os regulables | Cremallera 32mm | Ropa doblada, su\u00e9teres',
                custom: 1,
                forType: ['closet'],
                cat: 'Modulos'
            },
            entrepanos: {
                n: 'Entrepa\u00f1os',
                w: [30, 40, 50, 60, 70, 80, 90],
                d: 'Repisas simples | Ancho y alto libre | Auto-calcula entrepa\u00f1os',
                custom: 1,
                forType: ['closet'],
                cat: 'Modulos'
            },
            colgadorCorto: {
                n: 'Colgador Corto (Doble)',
                w: [60, 70, 80, 90],
                d: 'Doble barra | Camisas arriba, pantalones abajo',
                forType: ['closet'],
                cat: 'Modulos'
            },
            maletero: {
                n: 'Maletero',
                w: [60, 80, 90, 100, 120],
                d: 'Repisa superior | Maletas y ropa de temporada | Alto: 30-50cm',
                forType: ['closet'],
                cat: 'Modulos'
            },
            // TV modules — Prof: 40-50cm, Alto base: 45-55cm
            torreLateral: {
                n: 'Torre Lateral',
                w: [30, 40, 50, 60],
                d: 'Torre lateral | Prof: 40-50cm',
                forType: ['tv'],
                cat: 'Modulos'
            },
            panelTV: {
                n: 'Panel para TV',
                w: [140, 170, 200, 240],
                d: 'Panel decorativo para TV',
                forType: ['tv'],
                cat: 'Modulos'
            },
            moduloCentral: {
                n: 'Modulo Central',
                w: [80, 100, 120, 140],
                d: 'Modulo central TV | Prof: 40-50cm, Alto: 45-55cm',
                forType: ['tv'],
                cat: 'Modulos'
            },
            lateralAbierto: {
                n: 'Lateral Abierto',
                w: [30, 40, 50, 60],
                d: 'Lateral abierto | 30-40cm ancho tipico',
                forType: ['tv'],
                cat: 'Modulos'
            },
            // Cocina modules (legacy, no forType — shown for 'otro' only)
            alacenaAlta: {
                n: 'Alacena Alta',
                w: [30, 45, 60, 90],
                d: 'Gabinete superior | Prof: 30-35cm, Alto: 70-90cm'
            },
            gabineteBase: {
                n: 'Gabinete Base',
                w: [30, 45, 60, 90],
                d: 'Gabinete inferior | Prof: 60cm, Alto: 85-90cm'
            },
            cajonBase: {
                n: 'Cajon Base',
                w: [30, 45, 60, 90],
                d: 'Base con cajones | Prof: 60cm, Alto: 85-90cm'
            },
            despensa: {
                n: 'Despensa',
                w: [40, 50, 60],
                d: 'Mueble despensa alto | Prof: 60cm'
            },
            espacioCampana: {
                n: 'Espacio Campana',
                w: [60, 70, 80, 90],
                d: 'Espacio campana | Min 60cm ancho, Prof: 50-65cm'
            },
            esquineroGiratorio: {
                n: 'Esquinero Giratorio',
                w: [90],
                d: 'Esquinero con charola giratoria'
            },
            // Cocina Bajos — Prof: 58cm, Alto casco: 72cm, Alto total: 85-90cm con patas y cubierta
            bajoEstandar: {
                n: 'Bajo Estandar',
                w: [30, 40, 45, 50, 60, 75, 80, 90, 100],
                d: 'Gabinete base 1-2 puertas | Prof: 58cm, Alto: 72cm',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            fregadero: {
                n: 'Fregadero',
                w: [60, 75, 80, 90],
                d: 'Sin techo, 2 amarres, saque trasero | Prof: 58cm',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            cajonera: {
                n: 'Cajonera',
                w: [30, 40, 45, 50, 60, 75, 80, 90],
                d: '2-4 cajones Blum Tandem | Prof: 58cm',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            esquineroCiego: {
                n: 'Esquinero Ciego',
                w: [90],
                d: 'Esquinero 90x90 ciego o en L (165\u00b0)',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            hornoBase: {
                n: 'Horno Base',
                w: [60, 75, 90],
                d: 'Nicho horno 595mm + caj\u00f3n inferior',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            // Cocina Alacenas — Prof: 30-35cm, Alto: 70-90cm
            alacenaEstandar: {
                n: 'Alacena Est\u00e1ndar',
                w: [30, 40, 45, 50, 60, 75, 80, 90],
                d: '1-2 puertas, 1-2 entrepa\u00f1os | Prof: 30-35cm, Alto: 70-90cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            alacenaAventos: {
                n: 'Alacena Aventos',
                w: [60, 75, 80, 90],
                d: 'Puerta elevable Blum Aventos (HK/HL/HS) | Prof: 30-35cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            alacenaSobreCampana: {
                n: 'Alacena Sobre Campana',
                w: [60, 70, 80, 90],
                d: 'Sobre campana o refri, prof. reducida | Prof: 20-30cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            // Cocina Torres — Prof: 58-60cm, Alto total: 220-240cm
            torreHornos: {
                n: 'Torre de Hornos',
                w: [60, 75, 90],
                d: 'Microondas + horno, caj\u00f3n inferior, ventilaci\u00f3n | Prof: 58-60cm',
                forType: ['cocina'],
                cat: 'Torres'
            },
            torreDespensa: {
                n: 'Torre Despensa',
                w: [40, 50, 60],
                d: 'Entrepa\u00f1os regulables 32mm, 2 puertas (sup+inf) | Prof: 58-60cm',
                forType: ['cocina'],
                cat: 'Torres'
            },
            // Cocina Extras — Piezas de terminacion y acabado
            zoclo: {
                n: 'Zoclo',
                w: [30, 40, 50, 60, 75, 80, 90, 100],
                d: 'Vista frontal inferior | melamina o aluminio',
                forType: ['cocina'],
                cat: 'Extras',
                custom: 1
            },
            vistaLateral: {
                n: 'Vista Lateral',
                w: [58, 60],
                d: 'Panel lateral visible | material premium',
                forType: ['cocina'],
                cat: 'Extras'
            },
            panelRelleno: {
                n: 'Panel de Relleno',
                w: [5, 10, 15, 20, 30, 50],
                d: 'Tira entre modulo y pared | 5-100mm',
                forType: ['cocina'],
                cat: 'Extras',
                custom: 1
            },
            cubierta: {
                n: 'Cubierta',
                w: [60, 90, 120, 150, 180, 240, 300],
                d: 'Superficie superior m2 | postformado/cuarzo/granito',
                forType: ['cocina'],
                cat: 'Extras',
                custom: 1
            },
            // Bano modules — Material: MDF RH obligatorio | Prof: 45-50cm, Alto: 50-60cm
            bajoLavabo: {
                n: 'Bajo Lavabo',
                w: [60, 75, 80, 90, 100],
                d: 'Cajon con saque U para cespol | MDF RH | Prof: 45-50cm',
                forType: ['bano'],
                cat: 'Bajos'
            },
            cajoneraBano: {
                n: 'Cajonera Bano',
                w: [40, 45, 50, 60],
                d: '2-3 cajones auxiliar | MDF RH | Alto: 50-60cm',
                forType: ['bano'],
                cat: 'Bajos'
            },
            botiquin: {
                n: 'Botiquin / Espejo',
                w: [40, 50, 60, 80],
                d: 'Modulo pared delgado 10-15cm prof | MDF RH',
                forType: ['bano'],
                cat: 'Altos'
            },
            // Puertas — Ancho: 80-90cm (int), 100cm (principal) | Alto: 200, 210, 240cm
            puerta: {
                n: 'Puerta',
                w: [80, 90, 100],
                d: 'Puerta individual | >100cm ancho = doble',
                panel: true,
                forType: ['puerta']
            },
            // --- TV modules (Phase 07) — Muebles de TV / Centros de Entretenimiento ---
            consolaPatas: {
                n: 'Consola con Patas',
                w: [120, 150, 180, 200, 240],
                h: 40,
                d: 40,
                d_desc: 'Prof: 35-45cm | Alto cuerpo: 40cm | Patas metalicas 5-15cm',
                forType: ['tv'],
                cat: 'TV'
            },
            consolaFlotante: {
                n: 'Consola Flotante',
                w: [120, 150, 180, 200, 240],
                h: 40,
                d: 40,
                d_desc: 'Prof: 35-45cm | Alto cuerpo: 40cm | Flotante (soportes muro)',
                forType: ['tv'],
                cat: 'TV'
            },
            torreLateralTV: {
                n: 'Torre Lateral TV',
                w: [30, 35, 40, 45, 50],
                h: 180,
                d: 30,
                d_desc: 'Ancho: 300-500mm | Prof: 250-350mm | Alto: piso a panel TV',
                forType: ['tv'],
                cat: 'TV'
            },
            repisaFlotante: {
                n: 'Repisa Flotante',
                w: [60, 80, 100, 120, 150],
                h: 4,
                d: 25,
                d_desc: 'Variante: hueca (caja) o herraje oculto (espigon min 38mm)',
                forType: ['tv'],
                cat: 'TV'
            },
            panelFondo: {
                n: 'Panel de Fondo (Lambrin)',
                w: [120, 150, 180, 200, 240],
                h: 180,
                d: 3,
                d_desc: 'Panel lambrin + bastidor oculto | Espacio cable 20-30mm',
                forType: ['tv'],
                cat: 'TV'
            },
            // Tablered Arauco — Fixed catalog products (exact INSTRUCTIVO dimensions)
            librero: {
                n: 'Librero KIRA',
                w: [138.5],  // Fixed: 1385mm total width
                d: 'Tablered Arauco | KIRA 15mm | 1385x400x1800mm | 9 piezas',
                forType: ['librero'],
                cat: 'Tablered'
            },
            credenzaTV: {
                n: 'Credenza TV NERO',
                w: [160],  // Fixed: 1600mm
                d: 'Tablered Arauco | NERO 15mm | 1600x450x440mm | 7 piezas',
                forType: ['credenza'],
                cat: 'Tablered'
            },
            mesaCentro: {
                n: 'Mesa de Centro',
                w: [100],  // Fixed: 1000mm
                d: 'Tablered Arauco | NERO+KIRA bicolor | 1000x600x400mm | 9 piezas (2 bloques)',
                forType: ['mesa_centro'],
                cat: 'Tablered'
            }
        };

        // ┌─────────────────────────────────────────────────────────────────┐
        // │  DEMO HARDWARE — Replace with real HW_DEFAULTS when ready       │
        // │  To restore: delete this block and uncomment REAL block below    │
        // │  Demo prices are round numbers, ~15-35% above typical cost      │
        // └─────────────────────────────────────────────────────────────────┘
        var HW_DEFAULTS = {
            corr_oculta: {
                desc: 'Corredera oculta soft-close',
                marca: 'DEMO',
                fallback: 300,
                cat: 'CORREDERA'
            },
            bisagra: {
                desc: 'Bisagra de cierre suave',
                marca: 'DEMO',
                fallback: 20,
                cat: 'BISAGRA'
            },
            base_clip: {
                desc: 'Base clip para bisagra',
                marca: 'DEMO',
                fallback: 5,
                cat: 'BISAGRA'
            },
            tipon: {
                desc: 'Sistema push-to-open',
                marca: 'DEMO',
                fallback: 110,
                cat: 'TIP-ON'
            },
            jaladera: {
                desc: 'Jaladera moderna',
                marca: 'DEMO',
                fallback: 20,
                cat: 'JALADERA'
            }
        };
        // Keys needed by auto-assignment but not in demo — add minimal fallbacks
        if (!HW_DEFAULTS.corr_eco) HW_DEFAULTS.corr_eco = { desc: 'Corredera economica', marca: 'DEMO', fallback: 60, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.corr_prem) HW_DEFAULTS.corr_prem = { desc: 'Corredera premium', marca: 'DEMO', fallback: 120, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.corr_basica) HW_DEFAULTS.corr_basica = { desc: 'Corredera basica', marca: 'DEMO', fallback: 25, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.placa_tipon) HW_DEFAULTS.placa_tipon = { desc: 'Placa tip-on', marca: 'DEMO', fallback: 25, cat: 'TIP-ON' };
        if (!HW_DEFAULTS.tubo) HW_DEFAULTS.tubo = { desc: 'Tubo colgador', marca: 'DEMO', fallback: 150, cat: 'ACC. CLOSET' };
        if (!HW_DEFAULTS.soporte) HW_DEFAULTS.soporte = { desc: 'Soporte tubo', marca: 'DEMO', fallback: 45, cat: 'ACC. CLOSET' };
        if (!HW_DEFAULTS.nivelador) HW_DEFAULTS.nivelador = { desc: 'Nivelador', marca: 'DEMO', fallback: 6, cat: 'NIVELADOR' };
        // Cocina bajo hardware — patas, zoclo, Blum Tandem, bisagra 165 para esquinero
        if (!HW_DEFAULTS.pata) HW_DEFAULTS.pata = { desc: 'Pata regulable cocina', marca: 'DEMO', fallback: 35, cat: 'ACC. COCINA' };
        if (!HW_DEFAULTS.zoclo_clip) HW_DEFAULTS.zoclo_clip = { desc: 'Clip zoclo cocina', marca: 'DEMO', fallback: 8, cat: 'ACC. COCINA' };
        if (!HW_DEFAULTS.corr_tandem) HW_DEFAULTS.corr_tandem = { desc: 'Corredera Blum Tandem soft-close', marca: 'DEMO', fallback: 350, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.bisagra_165) HW_DEFAULTS.bisagra_165 = { desc: 'Bisagra 165\u00b0 esquinero', marca: 'DEMO', fallback: 45, cat: 'BISAGRA' };
        if (!HW_DEFAULTS.aventos_hk) HW_DEFAULTS.aventos_hk = { desc: 'Blum Aventos HK-S', marca: 'DEMO', fallback: 850, cat: 'AVENTOS' };
        if (!HW_DEFAULTS.aventos_hl) HW_DEFAULTS.aventos_hl = { desc: 'Blum Aventos HL', marca: 'DEMO', fallback: 1200, cat: 'AVENTOS' };
        if (!HW_DEFAULTS.aventos_hs) HW_DEFAULTS.aventos_hs = { desc: 'Blum Aventos HS', marca: 'DEMO', fallback: 1500, cat: 'AVENTOS' };
        if (!HW_DEFAULTS.soporte_alacena) HW_DEFAULTS.soporte_alacena = { desc: 'Soporte colgante alacena', marca: 'DEMO', fallback: 25, cat: 'ACC. COCINA' };
        if (!HW_DEFAULTS.soporte_bano) HW_DEFAULTS.soporte_bano = { desc: 'Escuadra muro bano flotante', marca: 'DEMO', fallback: 35, cat: 'ACC. BANO' };
        // Tablered Arauco hardware keys (guarded conditionals — matching Phase 1 pattern)
        if (!HW_DEFAULTS.regaton) HW_DEFAULTS.regaton = { desc: 'Regaton nivelador tachuela plastica', marca: 'DEMO', fallback: 8, cat: 'ACC. TABLERED' };
        if (!HW_DEFAULTS.pata_metalica) HW_DEFAULTS.pata_metalica = { desc: 'Pata metalica 10cm', marca: 'DEMO', fallback: 85, cat: 'ACC. TABLERED' };
        if (!HW_DEFAULTS.piston_150n) HW_DEFAULTS.piston_150n = { desc: 'Piston gas 150N (tapa abatible)', marca: 'DEMO', fallback: 350, cat: 'ACC. TABLERED' };
        if (!HW_DEFAULTS.pata_niveladora) HW_DEFAULTS.pata_niveladora = { desc: 'Pata niveladora 5cm regulable', marca: 'DEMO', fallback: 25, cat: 'ACC. TABLERED' };
        if (!HW_DEFAULTS.cubrecanto_ml) HW_DEFAULTS.cubrecanto_ml = { desc: 'Cubrecanto PVC 0.45mm (por ml)', marca: 'DEMO', fallback: 15, cat: 'ACC. TABLERED' };
        // TV module hardware keys (Phase 07 — guarded conditionals)
        if (!HW_DEFAULTS.soporte_flotante) HW_DEFAULTS.soporte_flotante = { desc: 'Soporte muro flotante (consola/repisa)', marca: 'DEMO', fallback: 45, cat: 'ACC. TV' };
        if (!HW_DEFAULTS.herraje_repisa) HW_DEFAULTS.herraje_repisa = { desc: 'Herraje repisa oculto espigon (par)', marca: 'DEMO', fallback: 120, cat: 'ACC. TV' };
        if (!HW_DEFAULTS.bastidor_ml) HW_DEFAULTS.bastidor_ml = { desc: 'Bastidor pino 1x2 panel fondo (por ml)', marca: 'DEMO', fallback: 25, cat: 'ACC. TV' };
        if (!HW_DEFAULTS.bisagra_libro) HW_DEFAULTS.bisagra_libro = { desc: 'Bisagra libro/mariposa puerta', marca: 'DEMO', fallback: 65, cat: 'BISAGRA' };
        if (!HW_DEFAULTS.chapa_puerta) HW_DEFAULTS.chapa_puerta = { desc: 'Chapa con manija puerta', marca: 'DEMO', fallback: 350, cat: 'ACC. PUERTA' };
        /* ── REAL HW_DEFAULTS (uncomment to restore) ──
        var HW_DEFAULTS = {
            corr_eco: { desc: 'Corredera ext total ecoline', marca: 'HERRAXA', fallback: 49.90, cat: 'CORREDERA' },
            corr_prem: { desc: 'Corredera ext total soft close', marca: 'HERRAXA', fallback: 99.90, cat: 'CORREDERA' },
            corr_oculta: { desc: 'Guia TDM oculta soft', marca: 'HERRAXA', fallback: 249.90, cat: 'CORREDERA' },
            corr_basica: { desc: 'Corredera ext lateral basica', marca: 'HERRAXA', fallback: 20.90, cat: 'CORREDERA' },
            bisagra: { desc: 'Bisagra bastidor', marca: 'HERRAXA', fallback: 16.90, cat: 'BISAGRA' },
            base_clip: { desc: 'Base clip', marca: 'HERRAXA', fallback: 4.18, cat: 'BISAGRA' },
            tipon: { desc: 'Tip on corto gris', marca: 'HERRAXA', fallback: 88.38, cat: 'TIP-ON' },
            placa_tipon: { desc: 'Placa para tip on recta', marca: 'HERRAXA', fallback: 20.18, cat: 'TIP-ON' },
            jaladera: { desc: 'Jaladera', marca: 'HERRAXA', fallback: 15.00, cat: 'JALADERA' },
            tubo: { desc: 'Tubo colgador', marca: 'HERRAXA', fallback: 120.00, cat: 'ACC. CLOSET' },
            soporte: { desc: 'Soporte tubo', marca: 'HERRAXA', fallback: 35.00, cat: 'ACC. CLOSET' },
            nivelador: { desc: 'Nivelador', marca: 'HERRAXA', fallback: 5.00, cat: 'NIVELADOR' },
            pata: { desc: 'Pata regulable cocina 100-150mm', marca: 'HERRAXA', fallback: 28.00, cat: 'ACC. COCINA' },
            zoclo_clip: { desc: 'Clip fijacion zoclo', marca: 'HERRAXA', fallback: 6.50, cat: 'ACC. COCINA' },
            corr_tandem: { desc: 'Blum Tandem cierre suave', marca: 'HERRAXA', fallback: 289.00, cat: 'CORREDERA' },
            bisagra_165: { desc: 'Bisagra 165 grados esquinero', marca: 'HERRAXA', fallback: 38.00, cat: 'BISAGRA' },
            bisagra_libro: { desc: 'Bisagra libro/mariposa puerta', marca: 'HERRAXA', fallback: 55.00, cat: 'BISAGRA' },
            chapa_puerta: { desc: 'Chapa con manija puerta interior', marca: 'HERRAXA', fallback: 280.00, cat: 'ACC. PUERTA' }
        };
        ── END REAL HW_DEFAULTS ── */

        // V2.3: Closet Estandarizado constants
        var EST_HEIGHT = 200,
            EST_DEPTH = 60,
            EST_WIDTHS = [60, 70, 80, 90];
        var EST_CAJON_HEIGHTS = [10, 15, 20, 25, 30, 35, 40, 45, 50];
        var EST_ZAPATERO_HEIGHTS = [10, 12, 15, 18, 20, 25];
        // CUSTOMIZE: Zone types for estandarizado mode — add new zone types here
        var EST_ZONE_TYPES = [
        {
            id: 'cajones',
            n: 'Cajones',
            icon: '&#x1f4e6;'
        },
        {
            id: 'colgador',
            n: 'Colgador',
            icon: '&#x1f455;'
        },
        {
            id: 'zapatero',
            n: 'Zapatero',
            icon: '&#x1f45f;',
            sub: 'Caj\u00f3n extra\u00edble'
        },
        {
            id: 'entrepa',
            n: 'Entrepa\u00f1os',
            icon: '&#x1f4da;'
        },
        {
            id: 'maletero',
            n: 'Maleteros',
            icon: '&#x1f9f3;',
            hidden: true
        },
        // Cocina zone types
        {
            id: 'alacenaAlta',
            n: 'Alacena Alta',
            icon: '&#x1f3e0;'
        },
        {
            id: 'gabineteBase',
            n: 'Gabinete Base',
            icon: '&#x1f3e0;'
        },
        {
            id: 'cajonBase',
            n: 'Cajon Base',
            icon: '&#x1f4e6;'
        },
        {
            id: 'despensa',
            n: 'Despensa',
            icon: '&#x1f3e0;'
        },
        {
            id: 'espacioCampana',
            n: 'Espacio Campana',
            icon: '&#x1f32c;'
        },
        {
            id: 'esquineroGiratorio',
            n: 'Esquinero Giratorio',
            icon: '&#x1f504;'
        }
        ];
        var EST_ZONE_DEFAULTS = {
            colgador_single: 100,
            colgador_double: 190,
            entrepa_h: 3,
            zapatero_repisa: 15,
            structure_overhead: 3.2
        };

        // CUSTOMIZE: Estandarizado module defaults — adjust default widths, zones per module type
        function defaultEstModule(modType) {
            if (modType === 'esquinero')
                return {
                    id: uid(),
                    type: 'esquinero',
                    width: 90,
                    width2: 90,
                    height: 200,
                    zones: [{
                        id: uid(),
                        type: 'colgador',
                        tubos: 1
                    }, {
                        id: uid(),
                        type: 'entrepa',
                        count: 2
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            if (modType === 'especial')
                return {
                    id: uid(),
                    type: 'especial',
                    width: 40,
                    height: 200,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 3
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            if (modType === 'fijo')
                return {
                    id: uid(),
                    type: 'fijo',
                    width: 30,
                    height: 20,
                    zones: [],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            if (modType === 'panelTV')
                return {
                    id: uid(),
                    type: 'panelTV',
                    width: 180,
                    height: 200,
                    zones: [],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            if (modType === 'torreLateral')
                return {
                    id: uid(),
                    type: 'torreLateral',
                    width: 50,
                    height: 200,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 3
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    },
                    led: null,
                    zoclo: {
                        enabled: false,
                        height: 10
                    },
                    maletero: {
                        enabled: false,
                        height: 30
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
            // Cocina: Alacena Alta (upper cabinet)
            if (modType === 'alacenaAlta')
                return {
                    id: uid(),
                    type: 'alacenaAlta',
                    width: 60,
                    height: 70,
                    depth: 35,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 2
                    }],
                    doors: true,
                    doorMode: 'completo',
                    doorType: 'bisagra',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: false, height: 10 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            // Cocina: Gabinete Base (lower cabinet)
            if (modType === 'gabineteBase')
                return {
                    id: uid(),
                    type: 'gabineteBase',
                    width: 60,
                    height: 85,
                    depth: 60,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 1
                    }],
                    doors: true,
                    doorMode: 'completo',
                    doorType: 'bisagra',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: true, height: 10 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            // Cocina: Cajon Base (drawer base)
            if (modType === 'cajonBase')
                return {
                    id: uid(),
                    type: 'cajonBase',
                    width: 60,
                    height: 85,
                    depth: 60,
                    zones: [{
                        id: uid(),
                        type: 'cajones',
                        count: 4
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 0,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: true, height: 10 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            // Cocina: Despensa (tall pantry)
            if (modType === 'despensa')
                return {
                    id: uid(),
                    type: 'despensa',
                    width: 60,
                    height: 200,
                    depth: 60,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 5
                    }],
                    doors: true,
                    doorMode: 'completo',
                    doorType: 'bisagra',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: true, height: 10 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            // Puerta (standalone door)
            if (modType === 'puerta')
                return {
                    id: uid(),
                    type: 'puerta',
                    width: 90,
                    height: 210,
                    depth: 4,
                    zones: [],
                    doors: true,
                    doorMode: 'completo',
                    doorType: 'bisagra',
                    doorCount: 1,
                    doorMaterial: 'melamina',
                    marco: true,
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: false, height: 0 },
                    maletero: { enabled: false, height: 0 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            if (modType === 'entrepanos')
                return {
                    id: uid(),
                    type: 'entrepanos',
                    width: 60,
                    height: 100,
                    shelfCount: 3,
                    zones: [],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: false, height: 10 },
                    maletero: { enabled: false, height: 30 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            if (modType === 'entrepa')
                return {
                    id: uid(),
                    type: 'entrepa',
                    width: 60,
                    height: 200,
                    zones: [{
                        id: uid(),
                        type: 'entrepa',
                        count: 5
                    }],
                    doors: false,
                    doorMode: 'por_zona',
                    doorType: 'tipon',
                    doorCount: 2,
                    doorMaterial: 'melamina',
                    chap: { mode: 'perimetrico', edges: { latIzq: true, latDer: true, techo: true, piso: true, fondo: false } },
                    led: null,
                    zoclo: { enabled: false, height: 10 },
                    maletero: { enabled: false, height: 30 },
                    quoteMode: 'completo',
                    paint: { enabled: false, name: '', pricePerLiter: 0, coats: 2, scope: 'doors' }
                };
            return {
                id: uid(),
                type: 'normal',
                width: 80,
                height: 200,
                zones: [{
                    id: uid(),
                    type: 'colgador',
                    tubos: 1
                }],
                doors: false,
                doorMode: 'por_zona',
                doorType: 'tipon',
                doorCount: 2,
                doorMaterial: 'melamina',
                chap: {
                    mode: 'perimetrico',
                    edges: {
                        latIzq: true,
                        latDer: true,
                        techo: true,
                        piso: true,
                        fondo: false
                    }
                },
                led: null,
                zoclo: {
                    enabled: false,
                    height: 10
                },
                maletero: {
                    enabled: false,
                    height: 30
                },
                quoteMode: 'completo',
                paint: {
                    enabled: false,
                    name: '',
                    pricePerLiter: 0,
                    coats: 2,
                    scope: 'doors'
                }
            };
        }
        function defaultEstProject() {
            return {
                mode: 'estandarizado',
                projectDepth: 60,
                sameDepth: true,
                projectType: '',
                client: '',
                sameMaterial: true,
                matFrentes: defaultMat(),
                matInterior: defaultMat(),
                chapFrentesPrice: CONFIG.pricing.defaultChapPrice,
                chapInteriorPrice: CONFIG.pricing.defaultChapPrice,
                enchapPrice: CONFIG.pricing.defaultEnchapPrice,
                thickness: 16,
                modules: [],
                hardware: [],
                hwOverrides: {},
                planoImage: null,
                ledConfig: {
                    activation: 'dimmer',
                    lightTemp: 'calida'
                },
                saleMultiplier: CONFIG.pricing.defaultSaleMultiplier,
                laborCost: CONFIG.pricing.defaultLaborCost,
                freight: true,
                freightCost: CONFIG.pricing.defaultFreightCost,
                chapSpec: CONFIG.pricing.defaultChapSpec
            };
        }

        // LED component catalog (Häfele LOOX5 system)
        var LED_CATALOG = {
            alimentadores: [
            {
                w: 20,
                desc: 'Alimentador LOOX5 24V 20W',
                price: 412.27
            },
            {
                w: 40,
                desc: 'Alimentador LOOX5 24V 40W',
                price: 1026.17
            },
            {
                w: 60,
                desc: 'Alimentador LOOX5 24V 60W',
                price: 1371.96
            },
            {
                w: 90,
                desc: 'Alimentador LOOX5 24V 90W',
                price: 1681.19
            }
            ],
            fixed: {
                cable_primario: {
                    desc: 'Cable primario US/Csa 250V 2000mm',
                    price: 150.00
                },
                distribuidor: {
                    desc: 'Distribuidor 6 vias 24V c/conmutacion',
                    price: 205.01
                },
                cable_interruptor: {
                    desc: 'Cable alim interruptor modular',
                    price: 113.96
                },
                placa_montaje: {
                    desc: 'Placa montaje interruptor',
                    price: 26.41
                }
            },
            switches: {
                presion: {
                    desc: 'Interruptor presion embutir negro 2000mm',
                    price: 109.63
                },
                dimmer: {
                    desc: 'Interruptor dimmer sin contacto',
                    price: 142.64
                },
                movimiento: {
                    desc: 'Interruptor sensor movimiento',
                    price: 98.24
                },
                puerta: {
                    desc: 'Interruptor puerta embutir/montar gris',
                    price: 410.44
                }
            },
            variable: {
                tira_calida: {
                    desc: 'Tira LED 3103 24V 5m Calida 3000K',
                    price: 1332.27,
                    length: 5
                },
                tira_fria: {
                    desc: 'Tira LED 3103 24V 5m Fria 5000K',
                    price: 1332.28,
                    length: 5
                },
                cable_alim_tira: {
                    desc: 'Cable alimentador 24V 2000mm tira 8mm',
                    price: 110.07
                },
                perfil_embutir: {
                    desc: 'Perfil embutir 1103 AL 11.5mm 3000mm',
                    price: 521.12,
                    length: 3
                },
                cable_extension: {
                    desc: 'Cable extension LOOX5 24V 2000mm',
                    price: 129.94
                },
                regleta_extra: {
                    desc: 'Regleta LOOX5 6 puertos 24V',
                    price: 115.26
                }
            },
            wattsPerMeter: 4.8,
            headroom: 1.2
        };

        // CUSTOMIZE: Templates — add/modify quick-quote templates (base price, dimensions, modules)
        var TEMPLATES = [
        {
            id: 'tv-panel-credenza',
            name: 'Muro TV con Credenza Nogal',
            photo: 'data-closets/pic38-closet.jpeg',
            type: 'tv',
            desc: 'Panel liso con ranuras decorativas y credenza',
            baseWidth: 360,
            baseHeight: 260,
            material: 'Nogal Claro Alto Brillo',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 24500,
            weeks: 5,
            laborCost: 4000,
            preModules: [{
                type: 'panelTV',
                width: 240
            }, {
                type: 'entrepa',
                width: 100,
                shelves: 4,
                doors: true
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'cocina-loft',
            name: 'Cocina Loft',
            photo: 'data-closets/pic37-closet.jpeg',
            type: 'cocina',
            desc: 'Diseno moderno negro mate + nogal con cubierta de cuarzo',
            baseWidth: 320,
            baseHeight: 240,
            material: 'Negro mate + Nogal',
            matCode: '231',
            matName: 'Negro',
            matFinish: 'Soft',
            basePrice: 95000,
            weeks: 4,
            laborCost: 12000,
            preModules: [{
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'entrepa',
                width: 80,
                shelves: 5,
                doors: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'closet-europeo',
            name: 'Closet Europeo con Espejo',
            photo: 'data-closets/pic40-closet.jpeg',
            type: 'closet',
            desc: 'Closet con espejo ahumado, color personalizable',
            baseWidth: 240,
            baseHeight: 240,
            material: 'Nogal + Espejo ahumado',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 38000,
            weeks: 4,
            laborCost: 6000,
            preModules: [{
                type: 'colgador',
                width: 90
            }, {
                type: 'modulo',
                width: 80,
                cajones: 4
            }, {
                type: 'entrepa',
                width: 70,
                shelves: 5
            }]
        },
        {
            id: 'tv-nogal-torres',
            name: 'Mueble TV Nogal con Torres',
            photo: 'data-closets/pic41-closet.jpeg',
            type: 'tv',
            desc: 'Panel TV central, 2 torres laterales, credenza base',
            baseWidth: 300,
            baseHeight: 240,
            material: 'Nogal melamina europea',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 42000,
            weeks: 5,
            laborCost: 6000,
            preModules: [{
                type: 'panelTV',
                width: 200
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 3
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 3
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'tv-premium-led',
            name: 'Mueble TV Premium LED + Vidrio',
            photo: 'data-closets/pic11-closet.jpeg',
            type: 'tv',
            desc: '2 torres con vidrio templado, credenza 6 puertas, panel TV, LED',
            baseWidth: 295,
            baseHeight: 240,
            material: 'Melamina europea cedro/nogal',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 55500,
            weeks: 5,
            laborCost: 8000,
            hasLed: true,
            hasGlass: true,
            preModules: [{
                type: 'panelTV',
                width: 200
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 4,
                doors: true
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 4,
                doors: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true,
                tipon: true
            }]
        }
        ];

        // Catalog helpers
        function getCatalog() {
            return typeof CATALOG !== 'undefined' ? CATALOG : [];
        }
        function getAraucoTableros() {
            return getCatalog().filter(function(i) {
                return i.categoria === 'TABLERO' && i.marca === 'ARAUCO';
            });
        }
        function getChapacanto() {
            return getCatalog().filter(function(i) {
                return i.categoria === 'CHAPACANTO';
            });
        }
        function findCatItem(searchDesc, marca) {
            var cat = getCatalog(),
                best = null,
                bestScore = 0;
            var terms = searchDesc.toLowerCase().split(/\s+/);
            cat.forEach(function(item) {
                if (marca && item.marca !== marca)
                    return;
                var d = item.descripcion.toLowerCase(),
                    score = 0;
                terms.forEach(function(t) {
                    if (d.indexOf(t) >= 0)
                        score++;
                });
                if (score > bestScore) {
                    bestScore = score;
                    best = item;
                }
            });
            return best;
        }
        function adjPrice(item) {
            if (!item)
                return 0;
            var adj = S.settings.supplierAdj[item.marca] || 0;
            return item.precio * (1 + adj / 100);
        }
        function getHWCats() {
            var cats = {};
            getCatalog().forEach(function(i) {
                if (i.categoria !== 'TABLERO' && i.categoria !== 'CHAPACANTO')
                    cats[i.categoria] = 1;
            });
            return Object.keys(cats).sort();
        }
        function getHWMarcas() {
            var m = {};
            getCatalog().forEach(function(i) {
                if (i.categoria !== 'TABLERO' && i.categoria !== 'CHAPACANTO')
                    m[i.marca] = 1;
            });
            return Object.keys(m).sort();
        }
        function filterHW() {
            var f = S.hwFilter,
                items = getCatalog().filter(function(i) {
                    if (i.categoria === 'TABLERO' || i.categoria === 'CHAPACANTO')
                        return false;
                    if (f.marca && i.marca !== f.marca)
                        return false;
                    if (f.cat && i.categoria !== f.cat)
                        return false;
                    if (f.q) {
                        var q = f.q.toLowerCase();
                        if (i.descripcion.toLowerCase().indexOf(q) < 0 && i.codigo.toLowerCase().indexOf(q) < 0)
                            return false;
                    }
                    return true;
                });
            return items.slice(0, 60);
        }

        function defaultMat() {
            return {
                brand: 'FINSA',
                code: COLORS[0].c,
                name: COLORS[0].n,
                finish: COLORS[0].f,
                precio: FINSA_PRICES[16],
                thickness: 16
            };
        }

        // Brands (derived from CONFIG)
        var BRANDS = {};
        BRANDS.primary = { id:'primary', mono:CONFIG.brand.mono, name:CONFIG.brand.name, tagline:CONFIG.brand.tagline };
        if (CONFIG.brand.altBrand) { var a = CONFIG.brand.altBrand; BRANDS[a.id] = a; }
        var CONTACT = {
            name: CONFIG.contact.name,
            office: CONFIG.contact.office,
            cell: CONFIG.contact.cell,
            email: CONFIG.contact.email,
            city: CONFIG.contact.city
        };

        // Load persisted data
        var savedLogo = null;
        try {
            savedLogo = localStorage.getItem(CONFIG.storage.prefix + 'logo_base64');
        } catch (e) {}
        var savedCounter = 1;
        try {
            var sc = localStorage.getItem(CONFIG.storage.prefix + 'quote_counter');
            if (sc)
                savedCounter = parseInt(sc) || 1;
        } catch (e) {}
        var savedBrand = 'primary';
        try {
            var sb = localStorage.getItem(CONFIG.storage.prefix + 'brand');
            if (sb && BRANDS[sb])
                savedBrand = sb;
        } catch (e) {}

        // State
        var S = {
            screen: 'templates',
            selTemplate: null,
            quickWidth: 0,
            quickHeight: 0,
            quickMat: '',
            quickMatName: '',
            quickMatFinish: '',
            waCopied: false,
            imgModal: null,
            step: 1,
            view: 'quote',
            copied: false,
            showHWPicker: false,
            hwFilter: {
                marca: '',
                cat: '',
                q: ''
            },
            showSettings: false,
            showCostBreakdown: false,
            modCatTab: '',
            bpSelectedMod: null,
            brand: savedBrand,
            logoBase64: savedLogo,
            quoteCounter: savedCounter,
            pdfData: null,
            settings: {
                marginCarp: CONFIG.pricing.marginCarp,
                marginHwStd: CONFIG.pricing.marginHwStd,
                marginBlum: CONFIG.pricing.marginBlum * 100,
                marginPreset: 'estandar',
                supplierAdj: {
                    ARAUCO: 0,
                    HERRAXA: 0,
                    BLUM: 0,
                    HAFELE: 0,
                    DEMO: 0
                }
            },
            project: {
                client: '',
                type: '',
                sameMaterial: true,
                matFrentes: defaultMat(),
                matInterior: defaultMat(),
                chapFrentesPrice: CONFIG.pricing.defaultChapPrice,
                chapInteriorPrice: CONFIG.pricing.defaultChapPrice,
                thickness: 16,
                modules: [],
                hardware: [],
                ledConfig: {
                    activation: 'dimmer',
                    lightTemp: 'calida'
                },
                glass: false,
                glassM2: 0,
                laborCost: CONFIG.pricing.defaultLaborCost,
                freight: true,
                freightCost: CONFIG.pricing.defaultFreightCost,
                defaultHeight: 200,
                defaultDepth: 50,
                sameDepth: true,
                chapSpec: CONFIG.pricing.defaultChapSpec
            },
            editedPieces: {},
            // V2.3: Estandarizado state
            estScreen: 'builder',
            estEditIdx: -1,
            estProject: defaultEstProject(),
            estPdfData: null,
            estHwSwapKey: null
        };
        var scrollY = 0;

        // Utilities
        function $(id) {
            return document.getElementById(id);
        }
        function fmt(n) {
            return '$' + Math.round(n).toLocaleString('es-MX');
        }
        function fmtD(n) {
            return '$' + n.toLocaleString('es-MX', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        function uid() {
            return Math.random().toString(36).substr(2, 9);
        }
        function date() {
            return new Date().toLocaleDateString('es-MX', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }
        var BUNDLED_PROJECTS = CONFIG.bundledProjects;
        /* BUNDLED_PROJECTS_REMOVED: Original demo project data was here.
           To bundle demo projects, add them to CONFIG.bundledProjects array. */
        // === SUPABASE CLOUD STORAGE ===
        var SB_URL = CONFIG.supabase.url;
        var SB_KEY = CONFIG.supabase.key;
        var sb = null;
        try {
            if (SB_URL && SB_KEY) sb = window.supabase.createClient(SB_URL, SB_KEY);
        } catch (e) {
            console.warn('Supabase not available, using localStorage only');
        }
        var cloudProjects = null; // null=not loaded yet, []=loaded

        // === CONNECTION STATUS INDICATOR ===
        // Tracks the current cloud connection state to re-apply after DOM rebuilds
        var _cloudStatus = sb ? 'none' : 'none'; // initial: gray until first fetch

        // Updates the header dot to reflect cloud connection state
        // status: 'connected' | 'disconnected' | 'none'
        function updateCloudStatus(status) {
            _cloudStatus = status;
            var el = document.getElementById('cloud-status');
            if (!el) return;
            if (status === 'connected') {
                el.style.background = '#4caf50';
                el.title = 'Conectado a Supabase';
            } else if (status === 'disconnected') {
                el.style.background = '#f44336';
                el.title = 'Error de conexion';
            } else {
                el.style.background = '#666';
                el.title = 'Sin conexion cloud';
            }
        }

        // Re-apply stored status after DOM rebuild
        function applyCloudStatus() {
            updateCloudStatus(_cloudStatus);
        }

        function loadSavedProjects() {
            // Return cached cloud data if available, else localStorage fallback
            if (cloudProjects !== null) {
                var merged = cloudProjects.slice();
                BUNDLED_PROJECTS.forEach(function(bp) {
                    var exists = merged.some(function(p) {
                        return p.id === bp.id;
                    });
                    if (!exists)
                        merged.push(bp);
                });
                return merged;
            }
            try {
                var local = JSON.parse(localStorage.getItem(CONFIG.storage.prefix + 'saved_projects') || '[]');
                BUNDLED_PROJECTS.forEach(function(bp) {
                    var exists = local.some(function(lp) {
                        return lp.id === bp.id;
                    });
                    if (!exists)
                        local.push(bp);
                });
                return local;
            } catch (e) {
                return BUNDLED_PROJECTS.slice();
            }
        }
        function saveSavedProjects(arr) {
            try {
                localStorage.setItem(CONFIG.storage.prefix + 'saved_projects', JSON.stringify(arr));
            } catch (e) {}
        }

        // Fetch all projects from Supabase
        function cloudFetchProjects() {
            if (!sb) {
                updateCloudStatus('none');
                return;
            }
            sb.from('projects').select('*').order('updated_at', {
                ascending: false
            }).then(function(res) {
                if (res.error) {
                    console.error('Supabase fetch error:', res.error);
                    updateCloudStatus('disconnected');
                    return;
                }
                updateCloudStatus('connected');
                cloudProjects = (res.data || []).map(function(row) {
                    var d = row.data || {};
                    return {
                        id: row.id,
                        savedAt: row.updated_at,
                        client: row.client || d.client || '',
                        label: (d.mode === 'custom' ? 'Proyecto Personalizado' : 'Closet Estandarizado') + ' - ' + (d.modules ? d.modules.length : 0) + ' modulo' + (d.modules && d.modules.length !== 1 ? 's' : ''),
                        moduleCount: d.modules ? d.modules.length : 0,
                        project: d
                    };
                });
                // Also cache to localStorage
                saveSavedProjects(cloudProjects);
                render();
            });
        }

        // Save one project to Supabase (upsert)
        function cloudSaveProject(entry) {
            if (!sb)
                return;
            var row = {
                id: entry.id,
                name: entry.label || '',
                client: entry.client || '',
                type: entry.project ? entry.project.projectType || '' : '',
                mode: entry.project ? entry.project.mode || 'est' : '',
                data: entry.project,
                updated_at: new Date().toISOString()
            };
            sb.from('projects').upsert(row, {
                onConflict: 'id'
            }).then(function(res) {
                if (res.error)
                    console.error('Supabase save error:', res.error);
                else
                    cloudFetchProjects(); // refresh list
            });
        }

        // Delete one project from Supabase
        function cloudDeleteProject(id) {
            if (!sb)
                return;
            sb.from('projects').delete().eq('id', id).then(function(res) {
                if (res.error)
                    console.error('Supabase delete error:', res.error);
                else
                    cloudFetchProjects();
            });
        }

        // Initial load from cloud
        cloudFetchProjects();
        function isDualType(t) {
            return t === 'closet' || t === 'cocina';
        }

        function svg(name) {
            var paths = {
                plus: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
                trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
                left: '<polyline points="15 18 9 12 15 6"/>',
                right: '<polyline points="9 18 15 12 9 6"/>',
                file: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>',
                clip: '<path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>',
                copy: '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>',
                check: '<polyline points="20 6 9 17 4 12"/>',
                x: '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
                dollar: '<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
                layers: '<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
                users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>',
                zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
                settings: '<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>',
                pkg: '<line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>',
                edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>',
                lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
                search: '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
                chevDown: '<polyline points="6 9 12 15 18 9"/>'
            };
            return '<svg viewBox="0 0 24 24">' + (paths[name] || '') + '</svg>';
        }

        function marcaClass(m) {
            return 'marca-' + (m || '').toLowerCase();
        }
        function anchoLargo(w, h) {
            return {
                ancho: Math.min(w, h),
                largo: Math.max(w, h)
            };
        }

        // Get material price per sheet
        function getMatPrice(mat, thickness) {
            if (!mat)
                return FINSA_PRICES[thickness] || FINSA_PRICES[16] || 850;
            if (mat.brand === 'CUSTOM')
                return mat.customPrice || 0;
            if (mat.brand === 'FINSA')
                return FINSA_PRICES[thickness] || (thickness > 20 ? FINSA_PRICES[25] : FINSA_PRICES[16]) || 850;
            if (mat.brand === 'ARAUCO' && mat.catItem)
                return adjPrice(mat.catItem);
            return mat.precio || 850;
        }

        // === LED BOM Calculator ===
        function calcModuleLedMeters(m) {
            var P = S.project,
                led = m.led;
            if (!led || !led.enabled)
                return {
                    meters: 0,
                    segments: 0
                };
            var w = m.width / 100,
                h = (m.height || P.defaultHeight || 200) / 100;
            var meters = 0,
                segments = 0;
            if (led.edges.top) {
                meters += w;
                segments++;
            }
            if (led.edges.bottom) {
                meters += w;
                segments++;
            }
            if (led.edges.left) {
                meters += h;
                segments++;
            }
            if (led.edges.right) {
                meters += h;
                segments++;
            }
            if (led.edges.shelves && led.shelfCount > 0) {
                meters += led.shelfCount * w;
                segments += led.shelfCount;
            }
            return {
                meters: Math.round(meters * 100) / 100,
                segments: segments
            };
        }

        function calcLedBOM() {
            var P = S.project,
                totalMeters = 0,
                totalSegments = 0,
                hasLed = false;
            P.modules.forEach(function(m) {
                if (!m.led || !m.led.enabled)
                    return;
                hasLed = true;
                var auto = calcModuleLedMeters(m);
                m.led.ledMeters = auto.meters;
                m.led.segments = auto.segments;
                var usedMeters = (m.led.metersOverride !== null && m.led.metersOverride >= 0) ? m.led.metersOverride : auto.meters;
                var usedSegments = (m.led.segmentsOverride !== null && m.led.segmentsOverride >= 0) ? m.led.segmentsOverride : auto.segments;
                totalMeters += usedMeters;
                totalSegments += usedSegments;
            });
            if (!hasLed)
                return null;
            var LC = LED_CATALOG,
                items = [];
            // Variable components
            var tiraKey = P.ledConfig.lightTemp === 'fria' ? 'tira_fria' : 'tira_calida';
            var tiraInfo = LC.variable[tiraKey];
            var tiraQty = Math.max(1, Math.ceil(totalMeters / tiraInfo.length));
            items.push({
                desc: tiraInfo.desc,
                qty: tiraQty,
                unitPrice: tiraInfo.price,
                total: tiraQty * tiraInfo.price,
                type: 'variable'
            });
            var cableAlimQty = Math.max(1, totalSegments);
            items.push({
                desc: LC.variable.cable_alim_tira.desc,
                qty: cableAlimQty,
                unitPrice: LC.variable.cable_alim_tira.price,
                total: cableAlimQty * LC.variable.cable_alim_tira.price,
                type: 'variable'
            });
            var perfilQty = Math.max(1, Math.ceil(totalMeters / LC.variable.perfil_embutir.length));
            items.push({
                desc: LC.variable.perfil_embutir.desc,
                qty: perfilQty,
                unitPrice: LC.variable.perfil_embutir.price,
                total: perfilQty * LC.variable.perfil_embutir.price,
                type: 'variable'
            });
            var extQty = Math.max(1, Math.ceil(totalMeters / 4));
            items.push({
                desc: LC.variable.cable_extension.desc,
                qty: extQty,
                unitPrice: LC.variable.cable_extension.price,
                total: extQty * LC.variable.cable_extension.price,
                type: 'variable'
            });
            // Extra distributors if >6 segments
            if (totalSegments > 6) {
                var extraDist = Math.ceil((totalSegments - 6) / 6);
                items.push({
                    desc: LC.variable.regleta_extra.desc,
                    qty: extraDist,
                    unitPrice: LC.variable.regleta_extra.price,
                    total: extraDist * LC.variable.regleta_extra.price,
                    type: 'variable'
                });
            }
            // Fixed kit
            items.push({
                desc: LC.fixed.distribuidor.desc,
                qty: 1,
                unitPrice: LC.fixed.distribuidor.price,
                total: LC.fixed.distribuidor.price,
                type: 'fixed'
            });
            // Alimentador sizing
            var totalWatts = totalMeters * LC.wattsPerMeter * LC.headroom;
            var alim = LC.alimentadores[LC.alimentadores.length - 1];
            for (var i = 0; i < LC.alimentadores.length; i++) {
                if (totalWatts <= LC.alimentadores[i].w) {
                    alim = LC.alimentadores[i];
                    break;
                }
            }
            items.push({
                desc: alim.desc,
                qty: 1,
                unitPrice: alim.price,
                total: alim.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_primario.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_primario.price,
                total: LC.fixed.cable_primario.price,
                type: 'fixed'
            });
            // Switch
            var sw = LC.switches[P.ledConfig.activation] || LC.switches.dimmer;
            items.push({
                desc: sw.desc,
                qty: 1,
                unitPrice: sw.price,
                total: sw.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_interruptor.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_interruptor.price,
                total: LC.fixed.cable_interruptor.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.placa_montaje.desc,
                qty: 1,
                unitPrice: LC.fixed.placa_montaje.price,
                total: LC.fixed.placa_montaje.price,
                type: 'fixed'
            });
            var totalCost = items.reduce(function(a, it) {
                return a + it.total;
            }, 0);
            return {
                items: items,
                totalCost: totalCost,
                totalMeters: totalMeters,
                totalSegments: totalSegments,
                totalWatts: totalWatts,
                alimentadorW: alim.w
            };
        }

        // === calculateParts: Generic piece-generation engine ===
        // Called by calc() and future calc engines to generate cut pieces for any module type.
        // moduleType: string matching MODS keys (e.g. 'modulo', 'colgador', 'zapatero', 'esquinero', 'entrepa', etc.)
        // dimensions: { w: mm, h: mm, d: mm, w2: mm (optional, for esquinero/esquineroGiratorio) }
        // materials: { thickness: number (16 or 25), cajones: number, shelves: number,
        //              quoteMode: string, corrTier: string, marco: bool, materialType: string }
        // Returns: array of { n, q, w, h, t, c, z }   (no mid/mn/mw — caller stamps those)
        function calculateParts(moduleType, dimensions, materials) {
            var w  = dimensions.w;
            var h  = dimensions.h;
            var d  = dimensions.d;
            var w2 = dimensions.w2 !== undefined ? dimensions.w2 : w;
            var TK = materials.thickness || 16;
            var pieces  = [];

            if (moduleType === 'modulo') {
                // Closet drawer/shelf module
                var caj = typeof materials.cajones === 'number' ? materials.cajones : 4;
                // AUDIT: Lateral — full depth, full height — no deductions (outer structural panels)
                pieces.push({ n: 'Lateral',   q: 2, w: d,       h: h,        t: TK, z: 'i' });
                // AUDIT: Techo/Piso — deduct 2x panel thickness from width (w - 2*TK = w - 32 at 16mm) so they fit between laterales
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32, h: d,        t: TK, z: 'i' });
                // AUDIT: Fondo — inset by 1x TK on all sides so it fits inside the box (w - 2*TK, h - 2*TK)
                pieces.push({ n: 'Fondo',      q: 1, w: w - 2 * TK, h: h - 2 * TK, t: TK, z: 'i' });
                if (caj > 0) {
                    // AUDIT: ch = usable height (h minus 100mm structure allowance) divided evenly by drawer count
                    var ch = Math.floor((h - 100) / caj);
                    // AUDIT: Frente cajon — 6mm gap on all sides for alignment tolerance (w-6, ch-6); 4 edges chapacanto; zone='f' (frente)
                    pieces.push({ n: 'Frente cajon', q: caj,     w: w - 6,     h: ch - 6,  t: TK, c: 4, z: 'f' });
                    // AUDIT: Costado cajon — 50mm deducted from depth for slide mechanism clearance; 80mm deducted from height for slide height
                    pieces.push({ n: 'Costado cajon', q: caj * 2, w: d - 50,   h: ch - 80, t: TK, c: 1, z: 'i' });
                    // AUDIT: Int. cajon — 100mm deducted from width for slide + structure on both sides; 80mm height clearance for slide
                    pieces.push({ n: 'Int. cajon',    q: caj * 2, w: w - 100,  h: ch - 80, t: TK, c: 1, z: 'i' });
                    // AUDIT: Fondo cajon — same 100mm width deduction; 50mm depth deduction for slide stop
                    pieces.push({ n: 'Fondo cajon',   q: caj,     w: w - 100,  h: d - 50,  t: TK, z: 'i' });
                } else {
                    var msh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                    if (msh > 0) {
                        // AUDIT: Entrepano — same width deduction as Techo/Piso (fits between laterales)
                        pieces.push({ n: 'Entrepano', q: msh, w: w - 32, h: d, t: TK, z: 'i' });
                    }
                }

            } else if (moduleType === 'colgador') {
                // Closet hanging-bar module
                // AUDIT: Lateral — full depth, full height (outer structural panels)
                pieces.push({ n: 'Lateral',   q: 2, w: d,       h: h,             t: TK, z: 'i' });
                // AUDIT: Techo/Piso — w - 2*TK (= w - 32 at 16mm), fits between laterales
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32, h: d,             t: TK, z: 'i' });
                // AUDIT: Entrepano — single shelf, same width deduction as Techo/Piso (single shelf at mid-height)
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32, h: d,             t: TK, z: 'i' });
                // AUDIT: Fondo — inset by TK on all sides (w - 2*TK, h - 2*TK)
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK, t: TK, z: 'i' });

            } else if (moduleType === 'zapatero') {
                // Closet shoe-rack module with pull-out trays
                // AUDIT: Lateral — full depth, full height (outer structural panels)
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                // AUDIT: Techo/Piso — w - 2*TK (= w - 32 at 16mm)
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                // AUDIT: Charola — pull-out tray; 100mm inset on width for slide mechanism on both sides; 100mm inset on depth for slide stop
                pieces.push({ n: 'Charola',   q: 6, w: w - 100,     h: d - 100,       t: TK, z: 'i' });
                // AUDIT: Fondo — inset by TK on all sides
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'esquinero') {
                // Closet L-shape corner module
                // AUDIT: Lateral A — full width A, full height (one outer panel of the L)
                pieces.push({ n: 'Lateral A', q: 1, w: w,  h: h,            t: TK, z: 'i' });
                // AUDIT: Lateral B — uses w2 (second leg of L), full height
                pieces.push({ n: 'Lateral B', q: 1, w: w2, h: h,            t: TK, z: 'i' });
                // AUDIT: Diagonal — hypotenuse face panel; width = half hypotenuse (sqrt(w^2+w2^2)*0.5) rounded; 2 edges chapacanto; zone='f'
                pieces.push({ n: 'Diagonal',  q: 1, w: Math.round(Math.sqrt(w * w + w2 * w2) * 0.5), h: h, t: TK, c: 2, z: 'f' });
                // AUDIT: Techo/Piso — horizontal panels; deduct TK from both w and w2 (fit inside both laterales)
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 2 * TK, h: w2 - 2 * TK, t: TK, z: 'i' });
                // AUDIT: Entrepano — same deductions as Techo/Piso (fits inside the L-box)
                pieces.push({ n: 'Entrepano', q: 1, w: w - 2 * TK, h: w2 - 2 * TK,  t: TK, z: 'i' });

            } else if (moduleType === 'entrepa') {
                // Closet open shelving unit
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 5;
                // AUDIT: Lateral — full depth, full height (outer structural panels)
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                // AUDIT: Techo/Piso — w - 2*TK (= w - 32 at 16mm), fits between laterales
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                // AUDIT: Entrepano — same width deduction as Techo/Piso; shelves||5 count
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                // AUDIT: Fondo — inset by TK on all sides
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'entrepanos') {
                // Simple open shelf unit
                var sc = typeof materials.shelfCount === 'number' ? materials.shelfCount : 3;
                pieces.push({ n: 'Lateral',    q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano',  q: sc, w: w - 32,    h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',      q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'colgadorCorto') {
                // Closet double-bar hanging module (INSTRUCTIVO 6.1)
                // AUDIT: Lateral — full depth, full height (outer structural panels)
                pieces.push({ n: 'Lateral',    q: 2, w: d,           h: h,             t: TK, z: 'i' });
                // AUDIT: Techo/Piso — w - 2*TK (= w - 32 at 16mm), fits between laterales
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,      h: d,             t: TK, z: 'i' });
                // No divider shelf — open cavity for 2 bars
                // AUDIT: Fondo — inset by TK on all sides (w - 2*TK, h - 2*TK)
                pieces.push({ n: 'Fondo',      q: 1, w: w - 2 * TK,  h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'maletero') {
                // Closet top luggage shelf module (INSTRUCTIVO 6.1)
                // AUDIT: Lateral — full depth, full height
                pieces.push({ n: 'Lateral',    q: 2, w: d,           h: h,             t: TK, z: 'i' });
                // AUDIT: Techo/Piso — w - 2*TK, fits between laterales
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,      h: d,             t: TK, z: 'i' });
                // AUDIT: Fondo — inset by TK on all sides
                pieces.push({ n: 'Fondo',      q: 1, w: w - 2 * TK,  h: h - 2 * TK,   t: TK, z: 'i' });
                // Note: No entrepano — single open cavity for luggage/seasonal storage

            } else if (moduleType === 'torreLateral') {
                // TV: lateral tower unit with shelves
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                // AUDIT: Lateral — zone='f' (visible front material) for TV towers
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'panelTV') {
                // TV: decorative TV background panel with crossbars
                // AUDIT: Panel — fixed 1200mm height regardless of module height (standard TV back panel)
                pieces.push({ n: 'Panel',     q: 1, w: w,       h: 1200,  t: TK, c: 4, z: 'f' });
                // AUDIT: Travesano — horizontal cross-member; 100mm tall; w - 2*TK width
                pieces.push({ n: 'Travesano', q: 2, w: w - 32,  h: 100,   t: TK,       z: 'i' });

            } else if (moduleType === 'moduloCentral') {
                // TV: central base module with single shelf
                // AUDIT: Lateral — zone='f' (visible front material) for TV modules
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'lateralAbierto') {
                // TV: open lateral unit with shelves
                // AUDIT: Lateral — zone='f' (visible front material) for TV laterals
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'alacenaAlta') {
                // Cocina: upper wall cabinet
                // AUDIT: alacH uses module h directly (already resolved by caller in mm)
                var alacH = h;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: alacH,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,                 t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32,     h: d,                 t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: alacH - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'gabineteBase') {
                // Cocina: base cabinet with single shelf
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'cajonBase') {
                // Cocina: base cabinet with drawers
                var caj = typeof materials.cajones === 'number' ? materials.cajones : 3;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });
                if (caj > 0) {
                    // AUDIT: ch = usable height divided by drawer count (100mm structure allowance)
                    var ch = Math.floor((h - 100) / caj);
                    // AUDIT: Frente cajon — 6mm gap; 4 edges chapacanto; zone='f'
                    pieces.push({ n: 'Frente cajon', q: caj,     w: w - 6,    h: ch - 6,  t: TK, c: 4, z: 'f' });
                    // AUDIT: Lat. cajon — 80mm deducted from depth for kitchen drawer slide; 30mm height clearance
                    pieces.push({ n: 'Lat. cajon',   q: caj * 2, w: d - 80,   h: ch - 30, t: TK, z: 'i' });
                    // AUDIT: Resp. cajon — 80mm deducted from width for kitchen slide; 30mm height clearance
                    pieces.push({ n: 'Resp. cajon',  q: caj * 2, w: w - 80,   h: ch - 30, t: TK, z: 'i' });
                    // AUDIT: Base cajon — 80mm deducted from both w and d for slide clearance
                    pieces.push({ n: 'Base cajon',   q: caj,     w: w - 80,   h: d - 80,  t: TK, z: 'i' });
                }

            } else if (moduleType === 'despensa') {
                // Cocina: tall pantry with adjustable shelves
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 4;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'espacioCampana') {
                // Cocina: open frame for range hood — no back, fixed 400mm lateral height
                // AUDIT: Lateral — fixed 400mm height (standard hood clearance frame)
                pieces.push({ n: 'Lateral',   q: 2, w: d,      h: 400, t: TK, z: 'i' });
                // AUDIT: Travesano — 100mm tall horizontal cross-member; w - 2*TK width
                pieces.push({ n: 'Travesano', q: 2, w: w - 32, h: 100, t: TK, z: 'i' });

            } else if (moduleType === 'esquineroGiratorio') {
                // Cocina: corner unit with lazy-susan hardware
                var w2g = dimensions.w2 !== undefined ? dimensions.w2 : w;
                pieces.push({ n: 'Lateral A', q: 1, w: w,           h: h,              t: TK, z: 'i' });
                pieces.push({ n: 'Lateral B', q: 1, w: w2g,          h: h,              t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 2 * TK, h: w2g - 2 * TK,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,    t: TK, z: 'i' });

            } else if (moduleType === 'bajoEstandar') {
                // Cocina: base cabinet with 1-2 puertas (auto by width)
                // AUDIT: Costados — full casco height x depth (outer structural panels)
                pieces.push({ n: 'Costado',      q: 2, w: d,           h: h,         t: TK, z: 'i' });
                // AUDIT: Base — inner width (w - 2*TK = w - 30 at 15mm) x depth
                pieces.push({ n: 'Base',          q: 1, w: w - 2 * TK,  h: d,         t: TK, z: 'i' });
                // AUDIT: Techo — same as base (inner width x depth), closes the box on top
                pieces.push({ n: 'Techo',         q: 1, w: w - 2 * TK,  h: d,         t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x casco height (backs the box); t:3 = 3mm HDF per INSTRUCTIVO
                pieces.push({ n: 'Fondo',         q: 1, w: w - 2 * TK,  h: h,         t: 3,  z: 'i' });
                // AUDIT: Amarre frontal superior — inner width x 80mm structural brace at top front
                pieces.push({ n: 'Amarre sup.',   q: 1, w: w - 2 * TK,  h: 80,        t: TK, z: 'i' });
                // AUDIT: Amarre frontal inferior — inner width x 80mm structural brace at bottom front
                pieces.push({ n: 'Amarre inf.',   q: 1, w: w - 2 * TK,  h: 80,        t: TK, z: 'i' });
                // AUDIT: Entrepa\u00f1o — inner width minus 30mm extra clearance (sits between costados with inset) x (depth - TK for fondo)
                pieces.push({ n: 'Entrepa\u00f1o', q: 1, w: w - 2 * TK - 30, h: d - TK, t: TK, z: 'i' });

            } else if (moduleType === 'fregadero') {
                // Cocina: sink module — NO techo (tarja sits on top), 2 amarres only, saque trasero for tuberias
                // AUDIT: Costados — full casco height x depth
                pieces.push({ n: 'Costado',          q: 2, w: d,          h: h,  t: TK, z: 'i' });
                // AUDIT: Base — inner width x depth
                pieces.push({ n: 'Base',              q: 1, w: w - 2 * TK, h: d,  t: TK, z: 'i' });
                // AUDIT: NO techo — replaced by 2 amarres (tarja occupies the top opening)
                // AUDIT: Amarre frontal — inner width x 80mm (structural brace where techo would be, front)
                pieces.push({ n: 'Amarre frontal',   q: 1, w: w - 2 * TK, h: 80, t: TK, z: 'i' });
                // AUDIT: Amarre trasero — inner width x 80mm (rear structural brace)
                pieces.push({ n: 'Amarre trasero',   q: 1, w: w - 2 * TK, h: 80, t: TK, z: 'i' });
                // AUDIT: Fondo HDF with saque notation — inner width x casco height; t:3 = 3mm HDF; saque for plumbing
                pieces.push({ n: 'Fondo (saque trasero)', q: 1, w: w - 2 * TK, h: h, t: 3, z: 'i' });
                // NO entrepa\u00f1o — space is free for plumbing

            } else if (moduleType === 'cajonera') {
                // Cocina: drawer module with 2-4 cajones and Blum Tandem correderas
                var caj = typeof materials.cajones === 'number' ? materials.cajones : 3;
                // AUDIT: Costados — full casco height x depth
                pieces.push({ n: 'Costado',      q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base — inner width x depth
                pieces.push({ n: 'Base',          q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Amarre superior — inner width x 80mm (no techo on cajoneras, just structural amarre)
                pieces.push({ n: 'Amarre sup.',   q: 1, w: w - 2 * TK,  h: 80, t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x casco height; t:3 = 3mm HDF per INSTRUCTIVO
                pieces.push({ n: 'Fondo',         q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                if (caj > 0) {
                    // AUDIT: ch = usable casco height minus 100mm structure allowance divided evenly by cajones
                    var ch = Math.floor((h - 100) / caj);
                    // AUDIT: Frente caj\u00f3n — inner width - 4mm juego x ch - 4mm juego; 4 edges chapa; zone='f' (frente visible)
                    pieces.push({ n: 'Frente caj\u00f3n',     q: caj,     w: w - 2 * TK - 4,  h: ch - 4,  t: TK, c: 4, z: 'f' });
                    // AUDIT: Costado caj\u00f3n — (depth - 80mm for Blum Tandem slide mechanism) x (ch - 30mm slide height)
                    pieces.push({ n: 'Costado caj\u00f3n',    q: caj * 2, w: d - 80,           h: ch - 30, t: TK,       z: 'i' });
                    // AUDIT: Frente int. caj\u00f3n — (inner width - 26mm for correderas x2 sides) x (ch - 30mm)
                    pieces.push({ n: 'Frente int. caj\u00f3n', q: caj,   w: w - 2 * TK - 26,  h: ch - 30, t: TK,       z: 'i' });
                    // AUDIT: Fondo caj\u00f3n HDF — same width as frente int x (depth - 80mm slide stop); t:3 = 3mm HDF
                    pieces.push({ n: 'Fondo caj\u00f3n',      q: caj,    w: w - 2 * TK - 26,  h: d - 80,  t: 3,        z: 'i' });
                }

            } else if (moduleType === 'esquineroCiego') {
                // Cocina: blind corner module (esquinero ciego) or esquinero en L
                // w = total width of visible face, w2ec = depth into corner (second leg)
                var w2ec = dimensions.w2 !== undefined ? dimensions.w2 : w;
                // AUDIT: Costado visible — full depth x casco height (the exposed outer side)
                pieces.push({ n: 'Costado visible', q: 1, w: d,           h: h,              t: TK, z: 'i' });
                // AUDIT: Costado ciego — w2ec leg depth x casco height (the blind/corner side)
                pieces.push({ n: 'Costado ciego',   q: 1, w: w2ec,         h: h,              t: TK, z: 'i' });
                // AUDIT: Base — full module footprint (w - TK) x (w2ec - TK) — deduct one TK per leg for costado overlap
                pieces.push({ n: 'Base',             q: 1, w: w - TK,       h: w2ec - TK,      t: TK, z: 'i' });
                // AUDIT: Techo — same dimensions as base
                pieces.push({ n: 'Techo',            q: 1, w: w - TK,       h: w2ec - TK,      t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x casco height; t:3 = 3mm HDF per INSTRUCTIVO
                pieces.push({ n: 'Fondo',            q: 1, w: w - 2 * TK,   h: h,              t: 3,  z: 'i' });
                // AUDIT: Entrepa\u00f1o — same as base minus clearance (30mm extra inset per side)
                pieces.push({ n: 'Entrepa\u00f1o',   q: 1, w: w - TK - 30,  h: w2ec - TK - TK, t: TK, z: 'i' });

            } else if (moduleType === 'hornoBase') {
                // Cocina: oven base module — entrepa\u00f1o at 595mm for oven niche, caj\u00f3n inferior, ventilaci\u00f3n
                // AUDIT: Costados — full casco height x depth
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base — inner width x depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo — inner width x depth (closes the top of the module)
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Entrepa\u00f1o horno — at 595mm from top for oven niche (INSTRUCTIVO: 595-598mm nicho); same depth as casco
                pieces.push({ n: 'Entrepa\u00f1o horno (595mm)', q: 1, w: w - 2 * TK, h: d, t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x casco height; note: needs 100mm ventilaci\u00f3n clearance behind oven; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo (ventilaci\u00f3n 100mm)', q: 1, w: w - 2 * TK, h: h, t: 3, z: 'i' });
                // AUDIT: Caj\u00f3n inferior pieces — below the oven niche
                // Caj\u00f3n height = casco height - 595mm oven niche - TK entrepa\u00f1o - TK base - 10mm clearance
                var cajH = h - 595 - TK - TK - 10;
                if (cajH > 50) {
                    // AUDIT: Frente caj\u00f3n inferior — 150mm standard height per INSTRUCTIVO; 4 chapa edges; zone='f'
                    pieces.push({ n: 'Frente caj\u00f3n inferior',   q: 1, w: w - 2 * TK - 4, h: 150, t: TK, c: 4, z: 'f' });
                    // AUDIT: Costado caj\u00f3n — (depth - 80mm Blum slide) x (150mm frente - 30mm slide height = 120mm)
                    pieces.push({ n: 'Costado caj\u00f3n',           q: 2, w: d - 80,          h: 120, t: TK,       z: 'i' });
                    // AUDIT: Frente int. caj\u00f3n — (inner width - 26mm for correderas x2) x 120mm
                    pieces.push({ n: 'Frente int. caj\u00f3n',       q: 1, w: w - 2 * TK - 26, h: 120, t: TK,       z: 'i' });
                    // AUDIT: Fondo caj\u00f3n HDF — same width as frente int x (depth - 80mm slide stop); t:3 = 3mm HDF
                    pieces.push({ n: 'Fondo caj\u00f3n',             q: 1, w: w - 2 * TK - 26, h: d - 80, t: 3,     z: 'i' });
                }

            } else if (moduleType === 'alacenaEstandar') {
                // Cocina: wall-mounted upper cabinet — 1-2 puertas, 1-2 entrepa\u00f1os
                // No amarres: wall-mounted, not free-standing (fixed to wall via soporte_alacena)
                // AUDIT: Costados — full casco height x depth (h and d from caller, typically 700-900mm x 300-350mm)
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base — inner width (w - 2*TK) x depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo — inner width x depth (closes top of wall cabinet)
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x casco height; t:3 = 3mm HDF per INSTRUCTIVO
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                // AUDIT: Entrepa\u00f1o — depth is d-TK to clear fondo; count from materials.shelves (default 1)
                var entEst = typeof materials.shelves === 'number' ? materials.shelves : 1;
                if (entEst > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: entEst, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'alacenaAventos') {
                // Cocina: wall cabinet with Blum Aventos elevating door (HK-S / HL / HS)
                // Same casco as alacenaEstandar; NO entrepa\u00f1o — single open cavity for aventos door sweep arc
                // Door piece generated in calc() door block (Plan 02); hardware in assignHardware()
                // AUDIT: Costados — full casco height x depth
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base — inner width x depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo — inner width x depth
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x casco height; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                // No entrepa\u00f1o: aventos door requires unobstructed cavity for full lift sweep

            } else if (moduleType === 'alacenaSobreCampana') {
                // Same casco as alacenaEstandar but depth comes from caller (typically 200-300mm for campana/refri)
                // Caller passes reduced d value; piece formulas are identical to alacenaEstandar
                // AUDIT: Costados — full casco height x caller-supplied reduced depth
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base — inner width x reduced depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo — inner width x reduced depth
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x casco height; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                // AUDIT: Entrepa\u00f1o — depth d-TK to clear fondo; default 1 (shorter cabinet)
                var entSC = typeof materials.shelves === 'number' ? materials.shelves : 1;
                if (entSC > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: entSC, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'torreHornos') {
                // Cocina: full-height tower with microondas niche + horno niche at 595mm + caj\u00f3n inferior
                // AUDIT: Costados — full tower height x depth (h typically 2200mm, d 580-600mm)
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base — inner width x depth (bottom of tower)
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo — inner width x depth (top of tower)
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Entrepa\u00f1o microondas — at microH mm from top (default 400mm); defines microwave niche ceiling
                var microH = materials.microHeight || 400;
                pieces.push({ n: 'Entrepa\u00f1o microondas', q: 1, w: w - 2 * TK, h: d, t: TK, z: 'i' });
                // AUDIT: Entrepa\u00f1o horno — 595mm below microondas entrepa\u00f1o per INSTRUCTIVO spec (same as hornoBase)
                pieces.push({ n: 'Entrepa\u00f1o horno (595mm)', q: 1, w: w - 2 * TK, h: d, t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x full tower height; needs 100mm ventilaci\u00f3n clearance behind oven; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo (ventilaci\u00f3n 100mm)', q: 1, w: w - 2 * TK, h: h, t: 3, z: 'i' });
                // AUDIT: Caj\u00f3n inferior — below oven niche
                // cajH = total height - microH niche - 595mm oven - 3*TK (entrepa\u00f1os + base) - 10mm clearance
                var cajHTorre = h - microH - 595 - 3 * TK - 10;
                if (cajHTorre > 50) {
                    // AUDIT: Frente caj\u00f3n inferior — 150mm standard height; 4 chapa edges; zone='f'
                    pieces.push({ n: 'Frente caj\u00f3n inferior',   q: 1, w: w - 2 * TK - 4,  h: 150,   t: TK, c: 4, z: 'f' });
                    // AUDIT: Costado caj\u00f3n — (depth - 80mm Blum slide) x 120mm
                    pieces.push({ n: 'Costado caj\u00f3n',           q: 2, w: d - 80,            h: 120,   t: TK,       z: 'i' });
                    // AUDIT: Frente int. caj\u00f3n — (inner width - 26mm correderas) x 120mm
                    pieces.push({ n: 'Frente int. caj\u00f3n',       q: 1, w: w - 2 * TK - 26,  h: 120,   t: TK,       z: 'i' });
                    // AUDIT: Fondo caj\u00f3n HDF — same width as frente int x (depth - 80mm slide stop); t:3 = 3mm HDF
                    pieces.push({ n: 'Fondo caj\u00f3n',             q: 1, w: w - 2 * TK - 26,  h: d - 80, t: 3,       z: 'i' });
                }

            } else if (moduleType === 'torreDespensa') {
                // Cocina: full-height pantry tower with adjustable shelves on 32mm system
                // AUDIT: Costados — full tower height x depth
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base — inner width x depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo — inner width x depth
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Fondo HDF — inner width x full tower height; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                // AUDIT: entrepa\u00f1os on 32mm system — adjustable via shelf pins, not fixed
                var entDesp = typeof materials.shelves === 'number' ? materials.shelves : 4;
                if (entDesp > 0) {
                    // AUDIT: Entrepa\u00f1o — depth d-TK to clear fondo; count from materials.shelves (default 4)
                    pieces.push({ n: 'Entrepa\u00f1o', q: entDesp, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'zoclo') {
                // AUDIT: Zoclo — linear strip, w=module width, h=150mm standard zoclo height, frente material
                pieces.push({ n: 'Zoclo', q: 1, w: w, h: 150, t: TK, z: 'f' });

            } else if (moduleType === 'vistaLateral') {
                // AUDIT: Vista lateral — exposed side panel, profundidad x alto casco, frente material
                pieces.push({ n: 'Vista Lateral', q: 1, w: d, h: h, t: TK, z: 'f' });

            } else if (moduleType === 'panelRelleno') {
                // AUDIT: Panel relleno — gap strip between module and wall, ancho=gap width, alto=casco height
                pieces.push({ n: 'Panel Relleno', q: 1, w: w, h: h, t: TK, z: 'f' });

            } else if (moduleType === 'cubierta') {
                // AUDIT: Cubierta — priced per m2, not by sheet; w=length, h=depth (d param)
                // isCubierta: true signals calc() to use m2-based pricing instead of sheet area
                pieces.push({ n: 'Cubierta', q: 1, w: w, h: d, t: 0, z: 'f', isCubierta: true });

            } else if (moduleType === 'puerta') {
                // Interior door — bastidor sandwich (INSTRUCTIVO 7.1)
                // Anatomy: 2 tapas MDF (exterior faces) + bastidor pino frame + relleno
                // AUDIT: w = door leaf width (typically 800-1000mm), h = door leaf height (2000-2100mm)

                // Bastidor pino frame (the internal wood skeleton)
                // AUDIT: Larguero — 2 vertical pine frame members, full height, 80mm wide
                pieces.push({ n: 'Larguero bastidor',   q: 2, w: 80,      h: h,       t: 30, z: 'i', isBastidor: true });
                // AUDIT: Travesano — 2 horizontal pine frame members, inner width (w - 2*80 = w-160), 80mm tall
                pieces.push({ n: 'Travesano bastidor',  q: 2, w: w - 160, h: 80,      t: 30, z: 'i', isBastidor: true });

                // Tapas MDF (the visible sandwich faces)
                // AUDIT: Tapa — 2 full-size MDF panels (3mm), full w x h; zone='f' (premium visible material)
                pieces.push({ n: 'Tapa MDF',            q: 2, w: w,       h: h,       t: 3,  c: 0, z: 'f' });

                // Marco chambrana (frame covering the wall gap)
                if (materials.marco !== false) {
                    // AUDIT: Jamba — 2 vertical frame pieces covering vano gap, 70mm wide; zone='f'
                    pieces.push({ n: 'Jamba chambrana',  q: 2, w: 70,      h: h,       t: TK, z: 'f' });
                    // AUDIT: Cabezal chambrana — horizontal top frame; w + 140mm to overlap both jambas
                    pieces.push({ n: 'Cabezal chambrana', q: 1, w: w + 140, h: 70,     t: TK, z: 'f' });
                    // AUDIT: Tope — the thin stop strip where the door contacts when closing; 3 pieces (2 vertical + 1 horizontal)
                    pieces.push({ n: 'Tope',             q: 3, w: 20,      h: h,       t: 10, z: 'f' });
                    // Note: Tope q=3 covers 2 vertical + 1 horizontal (cabezal tope); height approximation uses h for all 3
                }
                // Note: bisagra_libro and chapa_puerta are handled in assignHardware()

            } else if (moduleType === 'bajoLavabo') {
                // Bano: bajo lavabo flotante (INSTRUCTIVO 4.2)
                // AUDIT: Standard bano bajo h=500-600mm, d=450-500mm — wall-mounted flotante
                var cajCount = materials.cajones || 2;
                var cajH = cajCount === 1
                    ? Math.round(h - TK) // single cajon: full inner height minus top amarre
                    : Math.round((h - 2 * TK) / 2); // 2-cajón: split height with techo amarre
                // Casco pieces
                pieces.push({ n: 'Costado',         q: 2, w: d,        h: h,   t: TK, z: 'i' }); // AUDIT: h x d full height
                pieces.push({ n: 'Piso',             q: 1, w: iW,       h: d,   t: TK, z: 'i' }); // AUDIT: iW = w - 2*TK
                pieces.push({ n: 'Amarre sup',       q: 1, w: iW,       h: 80,  t: TK, z: 'i' }); // AUDIT: 80mm structural top amarre
                pieces.push({ n: 'Fondo HDF',        q: 1, w: iW,       h: h,   t: 3,  z: 'i' }); // AUDIT: 3mm HDF fondo trasero
                // Cajon superior WITH saque en U for cespol
                pieces.push({ n: 'Costado cajon',   q: 2, w: cajH,     h: d - 80, t: TK, z: 'i' }); // AUDIT: cajH x (d-80) Blum Tandem depth
                pieces.push({ n: 'Frente int caj 1', q: 1, w: iW - 26,  h: cajH,   t: TK, z: 'i', saqueU: true }); // AUDIT: -26mm = 13mm per side clip; saqueU=true: 220x180mm centered notch for cespol
                pieces.push({ n: 'Fondo cajon HDF', q: 1, w: iW - 26,  h: d - 80, t: 3,  z: 'i' }); // AUDIT: HDF 3mm cajon base
                if (cajCount >= 2) {
                    // Bottom cajon — same dimensions WITHOUT saqueU
                    pieces.push({ n: 'Costado cajon 2', q: 2, w: cajH,    h: d - 80, t: TK, z: 'i' }); // AUDIT: same as top cajon costados
                    pieces.push({ n: 'Frente int caj 2', q: 1, w: iW - 26, h: cajH,   t: TK, z: 'i' }); // AUDIT: no saqueU on bottom cajon
                    pieces.push({ n: 'Fondo caj 2 HDF', q: 1, w: iW - 26, h: d - 80, t: 3,  z: 'i' });
                }
                // Frente pieces (z:'f') — exterior cajon fronts
                pieces.push({ n: 'Frente cajon', q: cajCount, w: iW - 4, h: cajH - 5, t: TK, z: 'f' }); // AUDIT: -4mm total gap; -5mm height gap

            } else if (moduleType === 'cajoneraBano') {
                // Bano: cajonera auxiliar (INSTRUCTIVO 4.2)
                // AUDIT: Auxiliary bano bajo h=500-600mm, d=450-500mm — same logic as cocina cajonera but shorter
                var cajCount = materials.cajones || 2;
                // AUDIT: cajH = (h - TK) / cajCount — minus one TK for top amarre only
                var cajH = Math.round((h - TK) / cajCount);
                // Casco pieces
                pieces.push({ n: 'Costado',         q: 2, w: d,        h: h,   t: TK, z: 'i' }); // AUDIT: h x d full height
                pieces.push({ n: 'Piso',             q: 1, w: iW,       h: d,   t: TK, z: 'i' }); // AUDIT: iW = w - 2*TK
                pieces.push({ n: 'Amarre sup',       q: 1, w: iW,       h: 80,  t: TK, z: 'i' }); // AUDIT: 80mm top amarre
                pieces.push({ n: 'Fondo HDF',        q: 1, w: iW,       h: h,   t: 3,  z: 'i' }); // AUDIT: 3mm HDF fondo trasero
                // Per-cajon pieces
                for (var ci = 0; ci < cajCount; ci++) {
                    pieces.push({ n: 'Costado cajon', q: 2, w: cajH,     h: d - 80,  t: TK, z: 'i' }); // AUDIT: cajH x (d-80mm) Blum Tandem clip depth
                    pieces.push({ n: 'Frente int caj', q: 1, w: iW - 26,  h: cajH,    t: TK, z: 'i' }); // AUDIT: -26mm = 13mm per side for Blum Tandem clip
                    pieces.push({ n: 'Fondo cajon HDF', q: 1, w: iW - 26, h: d - 80,  t: 3,  z: 'i' }); // AUDIT: HDF 3mm cajon base
                }
                // Frente pieces (z:'f') — exterior cajon fronts
                pieces.push({ n: 'Frente cajon', q: cajCount, w: iW - 4, h: cajH - 5, t: TK, z: 'f' }); // AUDIT: -4mm total gap; -5mm height gap

            } else if (moduleType === 'botiquin') {
                // Bano: botiquin/espejo wall-mount thin module (INSTRUCTIVO 4.2)
                // AUDIT: d=100-150mm (thin wall cabinet), h=600-900mm, w=400-800mm
                var doorCnt = w <= 500 ? 1 : 2;
                // Casco pieces
                pieces.push({ n: 'Costado',      q: 2, w: d,        h: h,       t: TK, z: 'i' }); // AUDIT: h x d full height
                pieces.push({ n: 'Piso',          q: 1, w: iW,       h: d,       t: TK, z: 'i' }); // AUDIT: iW = w - 2*TK
                pieces.push({ n: 'Techo',         q: 1, w: iW,       h: d,       t: TK, z: 'i' }); // AUDIT: same as piso
                pieces.push({ n: 'Fondo HDF',     q: 1, w: iW,       h: h,       t: 3,  z: 'i' }); // AUDIT: 3mm HDF fondo trasero
                pieces.push({ n: 'Entrepano',     q: 1, w: iW - 30,  h: d - 15,  t: TK, z: 'i' }); // AUDIT: -30mm = 15mm per side pin clearance; -15mm depth clearance
                // Frente pieces (z:'f') — door(s)
                if (doorCnt === 1) {
                    pieces.push({ n: 'Puerta', q: 1, w: iW - 4,        h: h - 10, t: TK, z: 'f' }); // AUDIT: -4mm total gap; -10mm height gap
                } else {
                    pieces.push({ n: 'Puerta', q: 2, w: Math.round(iW / 2) - 2, h: h - 10, t: TK, z: 'f' }); // AUDIT: iW/2 - 2mm per door gap
                }

            } else if (moduleType === 'librero') {
                // AUDIT: Tablered Arauco Librero KIRA — fixed catalog despiece (INSTRUCTIVO S.9)
                // Overall: 1385mm wide (1000 izq + 385 der), 400mm deep, 1800mm tall
                pieces.push({ label: 'A', n: 'Piso/Techo zona izq',         q: 2, w: 1000, h: 385,  cubrecanto: '3 lados', t: TK, z: 'i' });
                pieces.push({ label: 'B', n: 'Lateral exterior',              q: 2, w: 1770, h: 385,  cubrecanto: '2 lados', t: TK, z: 'i' });
                pieces.push({ label: 'C', n: 'Fondo trasero',                 q: 1, w: 1770, h: 970,  cubrecanto: 'no',      t: TK, z: 'i' });
                pieces.push({ label: 'D', n: 'Puerta media',                  q: 2, w: 745,  h: 335,  cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                pieces.push({ label: 'E', n: 'Puerta baja',                   q: 2, w: 385,  h: 335,  cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                pieces.push({ label: 'F', n: 'Repisa larga horizontal',       q: 2, w: 970,  h: 370,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'G', n: 'Paral vertical interno',        q: 4, w: 699,  h: 370,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'H', n: 'Repisa corta zona der',         q: 2, w: 310,  h: 370,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'I', n: 'Repisa media zona der',         q: 1, w: 645,  h: 370,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                // Cubrecanto total: 59.2 ml PVC 0.45mm KIRA — priced per ml in calc()
                pieces.push({ n: 'Cubrecanto PVC KIRA', q: 1, w: 59200, h: 0, mlTotal: 59.2, isCubrecanto: true, t: 0, z: 'i' });

            } else if (moduleType === 'credenzaTV') {
                // AUDIT: Tablered Arauco Credenza TV NERO — fixed catalog despiece (INSTRUCTIVO S.8)
                // Overall: 1600mm long, 450mm deep, 440mm tall (540mm with patas)
                pieces.push({ label: 'A', n: 'Piso/Techo',                   q: 2, w: 1600, h: 450,  cubrecanto: '3 lados', t: TK, z: 'i' });
                pieces.push({ label: 'B', n: 'Fondo trasero',                 q: 1, w: 1570, h: 435,  cubrecanto: 'no',      t: TK, z: 'i' });
                pieces.push({ label: 'C', n: 'Costado exterior',              q: 2, w: 410,  h: 450,  cubrecanto: '2 lados', t: TK, z: 'i' });
                pieces.push({ label: 'D', n: 'Paral interno vertical',        q: 3, w: 410,  h: 435,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'E', n: 'Repisa horizontal interna',     q: 4, w: 380,  h: 435,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'F', n: 'Puerta central',                q: 2, w: 400,  h: 390,  cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                pieces.push({ label: 'G', n: 'Puerta lateral',                q: 2, w: 320,  h: 405,  cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                // Cubrecanto total: 49 ml PVC 0.45mm NERO — priced per ml in calc()
                pieces.push({ n: 'Cubrecanto PVC NERO', q: 1, w: 49000, h: 0, mlTotal: 49, isCubrecanto: true, t: 0, z: 'i' });

            } else if (moduleType === 'mesaCentro') {
                // AUDIT: Tablered Arauco Mesa de Centro — bicolor KIRA+NERO (INSTRUCTIVO S.10)
                // Overall: 1000mm long, 600mm wide, 400mm tall (450-500mm with patas)
                // BLOQUE 1 = KIRA (tapa abatible), BLOQUE 2 = NERO (nicho abierto)
                // BLOQUE 1 — KIRA
                pieces.push({ label: 'A', n: 'Tapa abatible',      q: 1, w: 600, h: 645, bloque: 'KIRA', cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                pieces.push({ label: 'B', n: 'Costado',             q: 2, w: 385, h: 650, bloque: 'KIRA', cubrecanto: '2 lados', t: TK, z: 'i' });
                pieces.push({ label: 'C', n: 'Frente',              q: 1, w: 360, h: 570, bloque: 'KIRA', cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'D', n: 'Fondo interno',       q: 1, w: 385, h: 570, bloque: 'KIRA', cubrecanto: 'no',      t: TK, z: 'i' });
                pieces.push({ label: 'E', n: 'Piso interno',        q: 1, w: 570, h: 635, bloque: 'KIRA', cubrecanto: '1 lado',  t: TK, z: 'i' });
                // BLOQUE 2 — NERO
                pieces.push({ label: 'F', n: 'Piso',                q: 1, w: 570, h: 350, bloque: 'NERO', cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'G', n: 'Techo/Cubierta',      q: 1, w: 600, h: 350, bloque: 'NERO', cubrecanto: '3 lados', t: TK, z: 'i' });
                pieces.push({ label: 'H', n: 'Costado',             q: 2, w: 385, h: 350, bloque: 'NERO', cubrecanto: '2 lados', t: TK, z: 'i' });
                pieces.push({ label: 'I', n: 'Fondo interno',       q: 1, w: 370, h: 570, bloque: 'NERO', cubrecanto: 'no',      t: TK, z: 'i' });
                // Cubrecanto totals: 12 ml KIRA + 9 ml NERO = 21 ml total
                pieces.push({ n: 'Cubrecanto PVC KIRA', q: 1, w: 12000, h: 0, mlTotal: 12, isCubrecanto: true, t: 0, z: 'i' });
                pieces.push({ n: 'Cubrecanto PVC NERO', q: 1, w: 9000,  h: 0, mlTotal: 9,  isCubrecanto: true, t: 0, z: 'i' });

            // --- TV modules (Phase 07) ---
            } else if (moduleType === 'consolaPatas') {
                // TV: consola con patas — standard casco (bajo TV) con patas metalicas (INSTRUCTIVO S.5)
                // AUDIT: Costados x2 — full h x d; inner width = w - 2*TK
                pieces.push({ n: 'Costado',       q: 2, w: d,             h: h,         t: TK, z: 'i' });
                // AUDIT: Piso x1 — (w - 2*TK) x d
                pieces.push({ n: 'Piso',           q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Techo x1 — (w - 2*TK) x d
                pieces.push({ n: 'Techo',          q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Fondo HDF x1 — (w - 2*TK) x h; t:3 = 3mm HDF backing
                pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: h,         t: 3,  z: 'i' });
                // AUDIT: Amarre frontal x1 — (w - 2*TK) x 80mm structural rigidity brace at front top
                pieces.push({ n: 'Amarre frontal', q: 1, w: w - 2 * TK,   h: 80,        t: TK, z: 'i' });
                // AUDIT: Entrepaño x1 — (w - 2*TK - 2*TK) x (d - TK); 15mm holgura each side for pin clearance
                pieces.push({ n: 'Entrepa\u00f1o', q: 1, w: w - 4 * TK,   h: d - TK,    t: TK, z: 'i' });
                // Puertas NOT generated here — handled by calc() door block

            } else if (moduleType === 'consolaFlotante') {
                // TV: consola flotante — identical casco to consolaPatas; mounting via soporte_flotante brackets (INSTRUCTIVO S.5)
                // AUDIT: Costados x2 — full h x d
                pieces.push({ n: 'Costado',       q: 2, w: d,             h: h,         t: TK, z: 'i' });
                // AUDIT: Piso x1 — (w - 2*TK) x d
                pieces.push({ n: 'Piso',           q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Techo x1 — (w - 2*TK) x d
                pieces.push({ n: 'Techo',          q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Fondo HDF x1 — (w - 2*TK) x h; t:3 = 3mm HDF backing
                pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: h,         t: 3,  z: 'i' });
                // AUDIT: Amarre frontal x1 — (w - 2*TK) x 80mm structural rigidity brace at front top
                pieces.push({ n: 'Amarre frontal', q: 1, w: w - 2 * TK,   h: 80,        t: TK, z: 'i' });
                // AUDIT: Entrepaño x1 — (w - 2*TK - 2*TK) x (d - TK); 15mm holgura each side for pin clearance
                pieces.push({ n: 'Entrepa\u00f1o', q: 1, w: w - 4 * TK,   h: d - TK,    t: TK, z: 'i' });
                // Puertas NOT generated here — handled by calc() door block

            } else if (moduleType === 'torreLateralTV') {
                // TV: torre lateral vertical — nichos abiertos con puerta opcional (INSTRUCTIVO S.5)
                // AUDIT: Costados x2 — full tower height h x depth d (vertical panels)
                pieces.push({ n: 'Costado',       q: 2, w: d,             h: h,         t: TK, z: 'i' });
                // AUDIT: Piso x1 — (w - 2*TK) x d (base of tower)
                pieces.push({ n: 'Piso',           q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Techo x1 — (w - 2*TK) x d (top of tower)
                pieces.push({ n: 'Techo',          q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Fondo HDF x1 — (w - 2*TK) x h; t:3 = 3mm HDF backing panel
                pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: h,         t: 3,  z: 'i' });
                // AUDIT: Entrepaños x2 — 2 shelves dividing tower into 3 sections; (w - 2*TK) x (d - TK) per INSTRUCTIVO 5.1
                pieces.push({ n: 'Entrepa\u00f1o', q: 2, w: w - 2 * TK,   h: d - TK,    t: TK, z: 'i' });
                // Door for tower handled by calc() door block (optional — user toggles m.doors)

            } else if (moduleType === 'repisaFlotante') {
                // TV: repisa flotante — two variants per INSTRUCTIVO S.5 (Metodo 1=hueca, Metodo 2=herraje)
                var variant = materials.variant || 'hueca';
                if (variant === 'hueca') {
                    // AUDIT: Variant hueca — hollow box; tapa superior + inferior + costados + HDF fondo for wall-mount
                    // tapa_superior x1 — w x d (top face, full width)
                    pieces.push({ n: 'Tapa superior',  q: 1, w: w,             h: d,         t: TK, z: 'i' });
                    // tapa_inferior x1 — w x d (bottom face, full width)
                    pieces.push({ n: 'Tapa inferior',  q: 1, w: w,             h: d,         t: TK, z: 'i' });
                    // costado_caja x2 — (h - 2*TK) x d; box sides, h=box height (38-40mm nominal)
                    pieces.push({ n: 'Costado caja',   q: 2, w: h - 2 * TK,   h: d,         t: TK, z: 'i' });
                    // fondo HDF x1 — (w - 2*TK) x d; t:3 hides wall mount bracket inside box
                    pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: d,         t: 3,  z: 'i' });
                } else {
                    // AUDIT: Variant herraje — hidden espigon bracket; single solid shelf minimum 38mm thick
                    // AUDIT: min 38mm for herraje oculto insertion (espigon bracket enters from back into shelf)
                    pieces.push({ n: 'Tablero repisa', q: 1, w: w,             h: d,         t: Math.max(TK, 38), z: 'i' });
                }

            } else if (moduleType === 'panelFondo') {
                // TV: panel de fondo (lambrin) con bastidor oculto de madera (INSTRUCTIVO S.5)
                // AUDIT: Panel principal x1 — full w x h; material frente (premium visible face)
                pieces.push({ n: 'Panel',                  q: 1, w: w,         h: h,         t: TK, z: 'f' });
                // AUDIT: Bastidor horizontal x2 — (w - 100) x 50; pine frame top + bottom (50mm from each edge)
                pieces.push({ n: 'Bastidor horizontal',    q: 2, w: w - 100,   h: 50,        t: 0,  z: 'i', isBastidor: true });
                // AUDIT: Bastidor vertical x2 — (h - 100) x 50; pine frame left + right sides (50mm from each edge)
                pieces.push({ n: 'Bastidor vertical',      q: 2, w: h - 100,   h: 50,        t: 0,  z: 'i', isBastidor: true });
                // AUDIT: Bastidor travesano x1 — (w - 100) x 50; center cross-brace for rigidity
                pieces.push({ n: 'Bastidor travesano',     q: 1, w: w - 100,   h: 50,        t: 0,  z: 'i', isBastidor: true });
            }

            return pieces;
        }

        // === assignHardware: Generic hardware auto-assignment engine ===
        // Called by calc() to get hardware items for any module type.
        // moduleType: string matching MODS keys
        // dimensions: { w: mm, h: mm, d: mm }
        // options: { cajones, corrTier, doors, tipon, doorCount, doorMaterial, materialType, shelves, heightCm, marco }
        // Returns: array of { key: string (HW_DEFAULTS key), q: number }
        function assignHardware(moduleType, dimensions, options) {
            var hw = [];
            var opts = options || {};

            if (moduleType === 'modulo') {
                // Closet drawer/shelf module
                var caj = typeof opts.cajones === 'number' ? opts.cajones : 0;
                if (caj > 0) {
                    // AUDIT: Default slide type is economica; user can upgrade via corrTier property
                    var corrKey = opts.corrTier || 'corr_eco';
                    hw.push({ key: corrKey, q: caj });
                    // AUDIT: Jaladera only when no doors — if doors present, jaladera goes on door not drawer
                    if (!opts.doors) {
                        hw.push({ key: 'jaladera', q: caj });
                    }
                }

            } else if (moduleType === 'colgador') {
                // Closet hanging-bar module
                // AUDIT: One tube per module, two brackets (left + right support)
                hw.push({ key: 'tubo',    q: 1 });
                hw.push({ key: 'soporte', q: 2 });

            } else if (moduleType === 'zapatero') {
                // Closet shoe-rack module with pull-out trays
                // AUDIT: 6 pull-out shoe trays, each needs one pair of slides
                hw.push({ key: 'corr_eco', q: 6 });

            } else if (moduleType === 'esquinero') {
                // Closet L-shape corner module with hanging bar
                // AUDIT: Corner module gets a hanging bar like colgador
                hw.push({ key: 'tubo',    q: 1 });
                hw.push({ key: 'soporte', q: 2 });

            } else if (moduleType === 'colgadorCorto') {
                // Closet double-bar hanging module — 2 tubes + 4 brackets
                // AUDIT: 2 tubes (upper + lower bar), 2 soportes per tube
                hw.push({ key: 'tubo',    q: 2 });
                hw.push({ key: 'soporte', q: 4 });

            } else if (moduleType === 'maletero') {
                // Closet luggage shelf — no hardware (open shelf, no doors, no bars)
                // AUDIT: Maletero is a simple open box — no special hardware

            } else if (moduleType === 'cajonBase') {
                // Cocina base cabinet with drawers
                var caj = typeof opts.cajones === 'number' ? opts.cajones : 0;
                if (caj > 0) {
                    // AUDIT: Cocina base drawers use premium soft-close concealed slides
                    hw.push({ key: 'corr_oculta', q: caj });
                }

            } else if (moduleType === 'puerta') {
                // Interior door — bisagra libro count driven by relleno type (INSTRUCTIVO 7.4)
                // AUDIT: honeycomb/peinazos (lighter) = 3 bisagras; solida (heavy) = 4 bisagras
                var relleno = opts.relleno || 'honeycomb';
                var hinges = relleno === 'solida' ? 4 : 3;
                hw.push({ key: 'bisagra_libro', q: hinges });
                // AUDIT: 1 chapa (lock + handle set) per door
                hw.push({ key: 'chapa_puerta', q: 1 });

            } else if (moduleType === 'bajoEstandar') {
                // Cocina: standard base cabinet — patas + zoclo only (door hardware in calc())
                // AUDIT: 4 adjustable legs per INSTRUCTIVO 3.8 (shared between adjacent modules in real install, but quoted per module)
                hw.push({ key: 'pata', q: 4 });
                // AUDIT: 4 zoclo clips (1 per leg) for attaching the decorative zoclo strip
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'fregadero') {
                // Cocina: sink module — patas + zoclo only (always 2 puertas, bisagras in calc())
                // AUDIT: 4 patas + 4 clips per INSTRUCTIVO 3.8
                hw.push({ key: 'pata', q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'cajonera') {
                // Cocina: drawer module — Blum Tandem correderas + patas + zoclo
                var caj = typeof opts.cajones === 'number' ? opts.cajones : 3;
                if (caj > 0) {
                    // AUDIT: 1 pair Blum Tandem soft-close per cajón per INSTRUCTIVO 3.3
                    hw.push({ key: 'corr_tandem', q: caj });
                    // AUDIT: 1 jaladera per cajón (drawer pulls)
                    hw.push({ key: 'jaladera', q: caj });
                }
                // AUDIT: 4 patas + 4 clips
                hw.push({ key: 'pata', q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'esquineroCiego') {
                // Cocina: blind corner or L-corner — patas + zoclo (door bisagras in calc())
                // AUDIT: 4 patas + 4 clips per INSTRUCTIVO 3.8
                hw.push({ key: 'pata', q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'hornoBase') {
                // Cocina: oven base — 1 pair Tandem for cajón inferior + patas + zoclo
                // AUDIT: 1 corredera Tandem for the single inferior drawer per INSTRUCTIVO 3.8
                hw.push({ key: 'corr_tandem', q: 1 });
                // AUDIT: 1 jaladera for the inferior drawer
                hw.push({ key: 'jaladera', q: 1 });
                // AUDIT: 4 patas + 4 clips
                hw.push({ key: 'pata', q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'alacenaEstandar') {
                // Cocina: standard wall cabinet — wall-mount brackets only (door bisagras in calc())
                // AUDIT: 2 soporte colgante brackets for wall mounting per INSTRUCTIVO
                hw.push({ key: 'soporte_alacena', q: 2 });

            } else if (moduleType === 'alacenaAventos') {
                // Cocina: aventos wall cabinet — specific aventos model + wall-mount brackets
                // AUDIT: 1 Aventos mechanism set (opts.aventosModel selects HK/HL/HS), default HK-S
                var aventosKey = 'aventos_' + (opts.aventosModel || 'hk');
                hw.push({ key: aventosKey, q: 1 });
                // AUDIT: 2 soporte colgante brackets for wall mounting
                hw.push({ key: 'soporte_alacena', q: 2 });

            } else if (moduleType === 'alacenaSobreCampana') {
                // Cocina: over-hood/fridge wall cabinet — wall-mount brackets only (same as standard alacena)
                // AUDIT: 2 soporte colgante brackets for wall mounting
                hw.push({ key: 'soporte_alacena', q: 2 });

            } else if (moduleType === 'torreHornos') {
                // Cocina: tower with microwave + oven niches — 1 Tandem for caj\u00f3n inferior + patas + zoclo
                // AUDIT: 1 corredera Tandem for the single inferior drawer (same pattern as hornoBase)
                hw.push({ key: 'corr_tandem', q: 1 });
                // AUDIT: 1 jaladera for the inferior drawer
                hw.push({ key: 'jaladera', q: 1 });
                // AUDIT: 4 patas + 4 clips (tower is floor-standing)
                hw.push({ key: 'pata', q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'torreDespensa') {
                // Cocina: tall pantry tower — patas + zoclo (door bisagras in calc())
                // AUDIT: 4 patas + 4 clips (tower is floor-standing)
                hw.push({ key: 'pata', q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'zoclo' || moduleType === 'vistaLateral' || moduleType === 'panelRelleno' || moduleType === 'cubierta') {
                // Cocina extras: finishing pieces — no hardware required
                // AUDIT: zoclo/vistaLateral/panelRelleno/cubierta are panel-only; no hinges, legs, or clips

            } else if (moduleType === 'bajoLavabo') {
                // Bano: bajo lavabo flotante — Blum Tandem per cajon + wall-mount brackets
                // AUDIT: no patas/zoclo_clip — flotante wall-mounted (INSTRUCTIVO 4.3)
                var cajCount = opts.cajones || 2;
                for (var ci = 0; ci < cajCount; ci++) {
                    hw.push({ key: 'corr_tandem', q: 1 });
                }
                hw.push({ key: 'soporte_bano', q: 2 });

            } else if (moduleType === 'cajoneraBano') {
                // Bano: cajonera auxiliar — Blum Tandem per cajon + wall-mount brackets (flotante)
                // AUDIT: no patas/zoclo_clip — flotante wall-mounted (INSTRUCTIVO 4.3)
                var cajCount = opts.cajones || 2;
                for (var ci = 0; ci < cajCount; ci++) {
                    hw.push({ key: 'corr_tandem', q: 1 });
                }
                hw.push({ key: 'soporte_bano', q: 2 });

            } else if (moduleType === 'botiquin') {
                // Bano: botiquin/espejo — wall-mount brackets only, bisagras handled in calc() door block
                // AUDIT: no patas/zoclo_clip — flotante wall-mounted (INSTRUCTIVO 4.3)
                hw.push({ key: 'soporte_bano', q: 2 });

            } else if (moduleType === 'librero') {
                // AUDIT: Tablered Librero KIRA — 8 bisagras (4 puertas x 2), 6 regatones (INSTRUCTIVO S.9)
                // Bisagras are fixed here (puertas already in calculateParts with isPuerta, not in calc door block)
                hw.push({ key: 'bisagra', q: 8 });
                hw.push({ key: 'regaton', q: 6 });

            } else if (moduleType === 'credenzaTV') {
                // AUDIT: Tablered Credenza TV NERO — 8 bisagras (4 puertas x 2), 4 patas metalicas 10cm (INSTRUCTIVO S.8)
                hw.push({ key: 'bisagra', q: 8 });
                hw.push({ key: 'pata_metalica', q: 4 });

            } else if (moduleType === 'mesaCentro') {
                // AUDIT: Tablered Mesa Centro — 2 bisagras (tapa abatible), 1 piston 150N, 4 patas 5cm (INSTRUCTIVO S.10)
                hw.push({ key: 'bisagra', q: 2 });
                hw.push({ key: 'piston_150n', q: 1 });
                hw.push({ key: 'pata_niveladora', q: 4 });

            // --- TV modules (Phase 07) ---
            } else if (moduleType === 'consolaPatas') {
                // AUDIT: Consola con patas — 4 patas regulables + 4 zoclo clips (floor-standing TV console)
                // Bisagras handled by calc() door block — NOT assigned here
                hw.push({ key: 'pata',       q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'consolaFlotante') {
                // AUDIT: Consola flotante — 2 soportes muro (parallel to soporte_bano pattern for bano flotante)
                // Bisagras handled by calc() door block — NOT assigned here
                hw.push({ key: 'soporte_flotante', q: 2 });

            } else if (moduleType === 'torreLateralTV') {
                // AUDIT: Torre lateral TV — 4 patas regulables (floor-standing tower, same pattern as cocina torres)
                // Bisagras for door option handled by calc() door block — NOT assigned here
                hw.push({ key: 'pata', q: 4 });

            } else if (moduleType === 'repisaFlotante') {
                // AUDIT: Repisa flotante — hardware depends on variant (hueca or herraje)
                // No bisagras, no jaladeras — open shelf (no doors)
                var variant = opts.variant || 'hueca';
                if (variant === 'hueca') {
                    // AUDIT: Hueca variant — 2 soportes_flotante hidden inside box as internal wall brackets
                    hw.push({ key: 'soporte_flotante', q: 2 });
                } else {
                    // AUDIT: Herraje variant — 1 pair of hidden espigon brackets (herraje_repisa counted per pair)
                    hw.push({ key: 'herraje_repisa', q: 1 });
                }

            } else if (moduleType === 'panelFondo') {
                // AUDIT: Panel fondo (lambrin) — no standard hardware; bastidor priced via isBastidor pieces in calculateParts
                // Panel attaches to bastidor with tornillos (absorbed in carpentry cost, not tracked separately)
                // Push nothing — empty hardware array for this module type

            }
            // All other module types (entrepa, torreLateral, panelTV, moduloCentral, lateralAbierto,
            // alacenaAlta, gabineteBase, despensa, espacioCampana, esquineroGiratorio):
            // AUDIT: These types get hardware only through doors (handled separately in calc) or manual assignment

            return hw;
        }

        // === CALC: Cost-based pricing engine ===
        function calc() {
            var P = S.project,
                pieces = [],
                autoHW = [];
            var useDual = isDualType(P.type) && !P.sameMaterial;

            // Generate pieces from modules
            var TK = P.thickness;
            P.modules.forEach(function(m) {
                var w = m.width * 10,
                    d = (P.sameDepth ? (P.defaultDepth || 50) : (m.depth || P.defaultDepth || 50)) * 10,
                    h = (m.height || P.defaultHeight || 200) * 10;
                var qm = m.quoteMode || 'completo';
                if (qm !== 'solo_puertas') {
                    // Delegate piece generation to calculateParts()
                    var cPieces = calculateParts(m.type, {
                        w: w,
                        h: h,
                        d: d,
                        w2: m.width2 ? m.width2 * 10 : undefined
                    }, {
                        thickness: TK,
                        cajones: typeof m.cajones === 'number' ? m.cajones : undefined,
                        shelves: m.shelves,
                        quoteMode: qm,
                        corrTier: m.corrTier,
                        marco: m.marco,
                        materialType: m.materialType,
                        doors: m.doors,
                        variant: m.variant  // TV: repisaFlotante variant ('hueca' or 'herraje')
                    });
                    // Stamp module context onto each piece and push into the pieces array
                    cPieces.forEach(function(p) {
                        p.mid = m.id;
                        p.mn  = m.name;
                        p.mw  = m.width;
                        // Stamp cubiertaType for m2 pricing in area calculation
                        if (p.isCubierta) p.cubiertaType = m.cubiertaType || 'postformado';
                        pieces.push(p);
                    });
                    // Delegate hardware assignment to assignHardware()
                    var modHW = assignHardware(m.type, { w: w, h: h, d: d }, {
                        cajones: typeof m.cajones === 'number' ? m.cajones : undefined,
                        corrTier: m.corrTier,
                        doors: m.doors,
                        tipon: m.tipon,
                        shelves: m.shelves,
                        heightCm: m.height || P.defaultHeight || 200,
                        materialType: m.materialType,
                        marco: m.marco,
                        aventosModel: m.aventosModel,
                        variant: m.variant,  // TV: repisaFlotante variant ('hueca' or 'herraje')
                        relleno: m.relleno || 'honeycomb'  // Puerta: relleno type drives bisagra count
                    });
                    modHW.forEach(function(hw) {
                        autoHW.push({ key: hw.key, q: hw.q, modId: m.id });
                    });
                } // end qm!=='solo_puertas'
                // Door pieces
                if (m.doors || qm === 'solo_puertas') {
                    // Skip door generation for module types that have no doors (drawers/oven use their own frentes)
                    if (m.type === 'cajonera' || m.type === 'hornoBase' || m.type === 'torreHornos' || m.type === 'zoclo' || m.type === 'vistaLateral' || m.type === 'panelRelleno' || m.type === 'cubierta' || m.type === 'bajoLavabo' || m.type === 'cajoneraBano' || m.type === 'librero' || m.type === 'credenzaTV' || m.type === 'mesaCentro' || m.type === 'repisaFlotante' || m.type === 'panelFondo' || m.type === 'puerta' || (m.type === 'torreLateralTV' && m.noPuertas)) {
                        // cajonera: frentes are in calculateParts(); hornoBase: oven has its own door
                        // torreHornos: oven has its own door, cajón frente in calculateParts()
                        // zoclo/vistaLateral/panelRelleno/cubierta: extras have no puertas
                        // librero/credenzaTV/mesaCentro: puertas already in calculateParts (isPuerta flag); bisagras in assignHardware()
                        // repisaFlotante: open shelf — no doors; panelFondo: flat panel — no doors
                        // puerta: tapas MDF ARE the door faces — no separate frente pieces needed; hardware in assignHardware()
                        // torreLateralTV with noPuertas: open nicho configuration — no doors
                        // Do nothing — skip door generation
                    } else {
                    var doorCnt;
                    if (m.type === 'fregadero') {
                        // AUDIT: Fregadero always has 2 puertas per INSTRUCTIVO_TECNICO
                        doorCnt = 2;
                    } else if (m.type === 'bajoEstandar') {
                        // AUDIT: 1 puerta for <=500mm width, 2 puertas for >500mm per INSTRUCTIVO_TECNICO 3.3
                        // m.width is in cm, so threshold is 50 (= 500mm)
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'esquineroCiego') {
                        // AUDIT: Ciego = 1 puerta, en L = 2 puertas with 165° bisagras
                        doorCnt = (m.esquineroTipo === 'enL') ? 2 : 1;
                    } else if (m.type === 'esquinero') {
                        doorCnt = 2;
                    } else if (m.type === 'alacenaAventos') {
                        // AUDIT: Aventos has 1 single elevating door (full width)
                        doorCnt = 1;
                    } else if (m.type === 'alacenaEstandar' || m.type === 'alacenaSobreCampana') {
                        // AUDIT: 1 puerta for <=500mm width, 2 puertas for >500mm (same threshold as bajoEstandar)
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'torreDespensa') {
                        // AUDIT: 2 puertas always — 1 superior + 1 inferior per INSTRUCTIVO torre despensa
                        doorCnt = 2;
                    } else if (m.type === 'botiquin') {
                        // AUDIT: botiquin 1 puerta if <=500mm, 2 puertas if >500mm (same as bajoEstandar/alacenaEstandar pattern)
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'consolaPatas' || m.type === 'consolaFlotante') {
                        // AUDIT: TV consola — 1 puerta if <=500mm (50cm), 2 puertas if >500mm per INSTRUCTIVO S.5
                        // m.width is in cm, threshold 50 = 500mm
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'torreLateralTV') {
                        // AUDIT: Torre lateral TV — always 1 puerta (narrow 300-500mm tower, single door)
                        // noPuertas case already handled in skip guard above
                        doorCnt = 1;
                    } else {
                        doorCnt = Math.ceil(m.width / 50);
                    }
                    var innerW = w - 2 * TK;
                    var doorW, doorH;
                    if (m.type === 'consolaPatas' || m.type === 'consolaFlotante') {
                        // AUDIT: TV consola door dims — doorH = h - 10 (10mm juego total); doorW per door
                        doorH = h - 10;
                        doorW = doorCnt === 1 ? (innerW - 4) : (Math.round(innerW / 2) - 2);
                    } else if (m.type === 'torreLateralTV') {
                        // AUDIT: Torre lateral TV door dims — doorH = h - 10; doorW = innerW - 4 (single door)
                        doorH = h - 10;
                        doorW = innerW - 4;
                    } else {
                        doorW = Math.round(w / doorCnt) - 3;
                        doorH = h - 3;
                    }
                    // For torreDespensa, doorH is half the tower (2 stacked doors)
                    if (m.type === 'torreDespensa') {
                        doorH = Math.round(h / 2) - 3;
                    }
                    if (m.doorMaterial !== 'vidrio')
                        pieces.push({
                            mid: m.id,
                            mn: m.name,
                            mw: m.width,
                            n: 'Puerta',
                            q: doorCnt,
                            w: doorW,
                            h: doorH,
                            t: TK,
                            c: 4,
                            z: 'f'
                        });
                    var doorHeightCm = (m.height || P.defaultHeight || 200);
                    var doorMatType = m.doorMaterial || 'melamina';
                    if (m.type !== 'alacenaAventos') {
                        // Standard bisagra + base_clip push (aventos hardware is already in assignHardware — no bisagras needed)
                        var bisPerDoor = getBisagraCount(doorHeightCm, doorMatType);
                        // AUDIT: esquineroCiego en L uses 165-degree bisagras; all other types use standard bisagra
                        var bisKey = (m.type === 'esquineroCiego' && m.esquineroTipo === 'enL') ? 'bisagra_165' : 'bisagra';
                        autoHW.push({
                            key: bisKey,
                            q: doorCnt * bisPerDoor,
                            modId: m.id
                        });
                        autoHW.push({
                            key: 'base_clip',
                            q: doorCnt * bisPerDoor,
                            modId: m.id
                        });
                    }
                    // Aventos doors have integrated handles — skip jaladera/tipon for alacenaAventos
                    if (m.type !== 'alacenaAventos') {
                        if (m.tipon) {
                            autoHW.push({
                                key: 'tipon',
                                q: doorCnt,
                                modId: m.id
                            });
                            autoHW.push({
                                key: 'placa_tipon',
                                q: doorCnt,
                                modId: m.id
                            });
                        } else {
                            autoHW.push({
                                key: 'jaladera',
                                q: doorCnt,
                                modId: m.id
                            });
                        }
                    }
                    } // end else (not cajonera/hornoBase/torreHornos)
                }
            });

            // Calculate areas by zone — all pieces use project thickness
            // cubierta pieces (isCubierta: true) are excluded from sheet area and priced per m2 separately
            // cubrecanto pieces (isCubrecanto: true) are excluded from sheet area and priced per ml separately
            // bastidor pieces (isBastidor: true) are excluded from sheet area and priced per ml separately (TV panelFondo)
            var areaF = 0, areaI = 0, cantoF = 0, cantoI = 0;
            var cubiertaCost = 0, cubiertaM2 = 0;
            var cubrecantoCost = 0;
            var bastidorCost = 0;
            pieces.forEach(function(p) {
                if (p.isCubierta) {
                    // AUDIT: Cubierta priced per m2 from CONFIG.cubiertaPrices; apply mermaFactor
                    var cubArea = (p.w / 1000) * (p.h / 1000) * p.q;
                    cubiertaM2 += cubArea;
                    var cubType = (p.cubiertaType || 'postformado');
                    var cubPriceM2 = CONFIG.pricing.cubiertaPrices[cubType] || CONFIG.pricing.cubiertaPrices.postformado;
                    cubiertaCost += cubArea * CONFIG.pricing.mermaFactor * cubPriceM2;
                    return; // skip sheet area accumulation for cubierta
                }
                if (p.isCubrecanto) {
                    // AUDIT: Cubrecanto PVC 0.45mm — Tablered Arauco products use fixed ml totals from INSTRUCTIVO
                    // Priced per linear meter (not sheet area); cost rate from HW_DEFAULTS.cubrecanto_ml
                    var mlRate = HW_DEFAULTS.cubrecanto_ml ? HW_DEFAULTS.cubrecanto_ml.fallback : 15;
                    cubrecantoCost += (p.mlTotal || 0) * mlRate;
                    return; // skip sheet area accumulation for cubrecanto
                }
                if (p.isBastidor) {
                    // AUDIT: Bastidor pino 1x2 — panelFondo TV; priced per linear meter via HW_DEFAULTS.bastidor_ml
                    // Piece w = length in mm; q = quantity; total ml = (w * q) / 1000
                    var bastRate = HW_DEFAULTS.bastidor_ml ? HW_DEFAULTS.bastidor_ml.fallback : 25;
                    bastidorCost += (p.w * p.q / 1000) * bastRate;
                    return; // skip sheet area accumulation for bastidor
                }
                var a = (p.w / 1000) * (p.h / 1000) * p.q;
                if (useDual && p.z === 'i') areaI += a;
                else areaF += a;
                var ml = 0;
                if (p.c) {
                    if (p.c === 4)
                        ml = ((p.w + p.h) * 2 / 1000) * p.q;
                    else if (p.c === 2)
                        ml = ((p.w + p.h) / 1000) * p.q;
                    else
                        ml = (Math.max(p.w, p.h) / 1000) * p.q;
                } else {
                    ml = (Math.max(p.w, p.h) / 1000) * p.q;
                }
                if (useDual && p.z === 'i')
                    cantoI += ml;
                else
                    cantoF += ml;
            });

            var SHEET = 1.22 * 2.44;
            var merma = CONFIG.pricing.mermaFactor;
            var totalSheetsF = Math.ceil(areaF * merma / SHEET);
            var totalSheetsI = Math.ceil(areaI * merma / SHEET);
            // sheetsF/sheetsI keyed by actual thickness for UI display
            var sheetsF = { 16: 0, 25: 0 }; sheetsF[TK] = totalSheetsF;
            var sheetsI = { 16: 0, 25: 0 }; sheetsI[TK] = totalSheetsI;
            cantoF = Math.ceil(cantoF);
            cantoI = Math.ceil(cantoI);
            var totalSheets = totalSheetsF + totalSheetsI;
            var totalCanto = cantoF + cantoI;

            // Material costs — use actual project thickness for price lookup
            var matPriceF = getMatPrice(P.matFrentes, TK);
            var matPriceI = getMatPrice(P.matInterior, TK);
            var matCostF = totalSheetsF * matPriceF;
            var matCostI = totalSheetsI * matPriceI;
            var chapCostF = cantoF * P.chapFrentesPrice;
            var chapCostI = cantoI * P.chapInteriorPrice;
            var corteCost = totalSheets * CONFIG.pricing.cuttingCostPerSheet;
            var enchapPrice = typeof P.enchapPrice === 'number' ? P.enchapPrice : 13;
            var enchapCost = totalCanto * enchapPrice;

            // Carpinteria total cost
            var carpCost = matCostF + matCostI + chapCostF + chapCostI + corteCost + enchapCost + P.laborCost + (P.freight ? P.freightCost : 0);

            // Hardware costs - combine auto + manual
            var hwConsolidated = {};
            autoHW.forEach(function(ah) {
                var def = HW_DEFAULTS[ah.key];
                if (!def)
                    return;
                var catItem = findCatItem(def.desc, def.marca);
                var price = catItem ? adjPrice(catItem) : def.fallback;
                var k = ah.key;
                if (!hwConsolidated[k])
                    hwConsolidated[k] = {
                        desc: def.desc,
                        marca: def.marca,
                        price: price,
                        qty: 0,
                        cat: def.cat,
                        catItem: catItem
                    };
                hwConsolidated[k].qty += ah.q;
            });
            // Manual hardware from project.hardware
            var manualHW = [];
            P.hardware.forEach(function(h) {
                manualHW.push({
                    desc: h.descripcion,
                    marca: h.marca,
                    price: adjPrice(h),
                    qty: h.qty,
                    cat: h.categoria,
                    codigo: h.codigo
                });
            });

            var hwCostCarpBucket = 0,
                hwCostPremium = 0;
            // Legacy brand-based accumulators (kept for backward compat in return object)
            var hwCostHerraxa = 0,
                hwCostHafele = 0,
                hwCostBlum = 0;
            var allHW = [];
            var hwThreshold = CONFIG.pricing.hardwareThreshold;
            for (var k in hwConsolidated) {
                var h = hwConsolidated[k];
                allHW.push(h);
                var cost = Math.ceil(h.qty) * h.price;
                // Threshold-based split: line item total <= threshold goes to carpentry bucket
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h._bucket = 'premium';
                }
                // Legacy brand tracking
                if (h.marca === 'BLUM') hwCostBlum += cost;
                else if (h.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            }
            manualHW.forEach(function(h) {
                allHW.push(h);
                var cost = Math.ceil(h.qty) * h.price;
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h._bucket = 'premium';
                }
                if (h.marca === 'BLUM') hwCostBlum += cost;
                else if (h.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            });

            var hwStdCost = hwCostHerraxa + hwCostHafele;

            // Extras
            var extraCost = 0;
            // Include cubierta m2 cost in extras bucket
            extraCost += cubiertaCost;
            // Include cubrecanto ml cost (Tablered Arauco PVC edge banding, priced per linear meter)
            extraCost += cubrecantoCost;
            // Include bastidor ml cost (TV panelFondo pine frame, priced per linear meter)
            extraCost += bastidorCost;
            var ledBOM = calcLedBOM();
            if (ledBOM)
                extraCost += ledBOM.totalCost;
            if (P.glass && P.glassM2 > 0)
                extraCost += P.glassM2 * CONFIG.pricing.glassCostPerM2;
            // CUSTOMIZE: Paint calc — adjust coverage rates and paint cost logic here
            var paintCost = 0;
            P.modules.forEach(function(m2) {
                if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                    var pm2 = calcPaintM2(m2, {
                        mode: 'custom',
                        defaultHeight: P.defaultHeight,
                        defaultDepth: P.defaultDepth
                    });
                    var liters = calcPaintLiters(pm2, m2.paint.coats);
                    paintCost += liters * m2.paint.pricePerLiter;
                }
            });
            extraCost += paintCost;

            // Apply margins — threshold-based hardware pricing
            var carpMultiplier = CONFIG.pricing.carpentryMultiplier;
            var premiumMargin = CONFIG.pricing.premiumHardwareMargin;
            // Carpentry cost now includes the carpentry-bucket hardware (low-cost items)
            var carpSale = (carpCost + hwCostCarpBucket) * carpMultiplier;
            // Premium hardware (above threshold) gets margin-based pricing
            var hwPremiumSale = hwCostPremium / (1 - premiumMargin);
            // Legacy aliases for backward compat
            var hwStdSale = hwPremiumSale;
            var hwBlumSale = 0;
            var extrasSale = extraCost * CONFIG.pricing.extrasMultiplier;

            var subtotal = carpSale + hwPremiumSale + extrasSale;
            var iva = subtotal * CONFIG.pricing.iva;
            var total = subtotal + iva;
            var totalCost = carpCost + hwCostCarpBucket + hwCostPremium + extraCost;
            var profit = subtotal - totalCost;
            var margin = subtotal > 0 ? ((profit / subtotal) * 100).toFixed(1) : 0;

            return {
                pieces: pieces,
                autoHW: autoHW,
                allHW: allHW,
                hwConsolidated: hwConsolidated,
                manualHW: manualHW,
                sheetsF: sheetsF,
                sheetsI: sheetsI,
                cantoF: cantoF,
                cantoI: cantoI,
                totalSheetsF: totalSheetsF,
                totalSheetsI: totalSheetsI,
                totalSheets: totalSheets,
                totalCanto: totalCanto,
                matCostF: matCostF,
                matCostI: matCostI,
                chapCostF: chapCostF,
                chapCostI: chapCostI,
                corteCost: corteCost,
                enchapCost: enchapCost,
                carpCost: carpCost,
                hwCostCarpBucket: hwCostCarpBucket,
                hwCostPremium: hwCostPremium,
                hwCostHerraxa: hwCostHerraxa,
                hwCostHafele: hwCostHafele,
                hwCostBlum: hwCostBlum,
                hwStdCost: hwStdCost,
                extraCost: extraCost,
                cubiertaCost: cubiertaCost,
                cubiertaM2: cubiertaM2,
                cubrecantoCost: cubrecantoCost,
                bastidorCost: bastidorCost,
                cascoCost: matCostI + (useDual ? chapCostI : 0),
                frenteCost: matCostF + chapCostF,
                herrajesCost: hwCostCarpBucket + hwCostPremium,
                extrasCost: extraCost,
                ledBOM: ledBOM,
                paintCost: paintCost,
                carpSale: carpSale,
                hwPremiumSale: hwPremiumSale,
                hwStdSale: hwStdSale,
                hwBlumSale: hwBlumSale,
                extrasSale: extrasSale,
                subtotal: subtotal,
                iva: iva,
                total: total,
                totalCost: totalCost,
                profit: profit,
                margin: margin,
                useDual: useDual
            };
        }

        // === Sheet optimizer: calculates standard 1220x2440mm melamina sheets needed ===
        function calcSheets(pieces) {
            var SHEET_AREA = 1.22 * 2.44; // m2 per sheet (same as existing calc)
            var merma = CONFIG.pricing.mermaFactor || 1.20;
            var cascoArea = 0, frenteArea = 0;
            (pieces || []).forEach(function(p) {
                if (p.isCubierta || p.isCubrecanto || p.isBastidor) return; // priced separately
                if (p.t !== 15 && p.t !== 18 && p.t !== 16 && p.t !== 25) return; // only standard melamina sheets
                var a = (p.w / 1000) * (p.h / 1000) * (p.q || 1);
                if (p.z === 'f') frenteArea += a;
                else cascoArea += a;
            });
            return {
                casco: Math.ceil((cascoArea * merma) / SHEET_AREA),
                frente: Math.ceil((frenteArea * merma) / SHEET_AREA),
                total: Math.ceil((cascoArea * merma) / SHEET_AREA) + Math.ceil((frenteArea * merma) / SHEET_AREA)
            };
        }

        // === V2.3: Estandarizado calc ===
        // Height/depth helpers — always respect per-module values with fallback to defaults
        function estModHeight(m) {
            return (m && m.height) || EST_HEIGHT;
        }
        function estProjDepth(mod) {
            var EP = S.estProject;
            if (mod && !EP.sameDepth && mod.depth) return mod.depth;
            return EP.projectDepth || EST_DEPTH;
        }
        // Calculate fixed zone heights (everything except colgador)
        // Espacio útil = height minus techo+piso panel thickness
        function estEspacioUtil(m) {
            var tk = S.estProject.thickness || 16;
            return estModHeight(m) - (2 * tk / 10);
        }
        // Sum of all fixed-height zones (everything except colgador and entrepa which fill free space)
        function calcEstFixedHeight(m) {
            var tk = (S.estProject.thickness || 16) / 10; // espesor in cm
            var h = 0;
            var numZones = m.zones.length;
            // Especial modules: entrepaños auto-fill entire space (unless colgador present)
            var espHasColg = m.type === 'especial' && m.zones.some(function(z) {
                return z.type === 'colgador';
            });
            if (m.type === 'especial' && !espHasColg) {
                return estEspacioUtil(m);
            }
            m.zones.forEach(function(z) {
                if (z.type === 'cajones') {
                    h += (z.count || 1) * (z.cajonHeight || 20);
                }
                else if (z.type === 'zapatero') {
                    h += (z.repisas || 3) * (z.repisaHeight || 15);
                }

                else // maletero is module-level (outside height), not a zone
                if (z.type === 'entrepa') {
                    h += (z.count || 2) * tk;
                }


            });
            // colgador is flexible — not counted here
            // entrepa fills free space — only the shelf thickness counts (already above)
            // Add divisiones internas between zones (espesor each, numZones-1 dividers)
            if (numZones > 1)
                h += (numZones - 1) * tk;
            return h;
        }
        // Get effective height of a colgador zone (fills remaining space)
        function calcEstColgadorHeight(m, z) {
            var eu = estEspacioUtil(m);
            var fixed = calcEstFixedHeight(m);
            var numColg = m.zones.filter(function(x) {
                return x.type === 'colgador';
            }).length;
            var remaining = eu - fixed;
            if (numColg <= 0)
                return 0;
            return Math.max(0, Math.round(remaining / numColg));
        }
        // Free space remaining when no colgador
        function calcEstFreeSpace(m) {
            var eu = estEspacioUtil(m);
            var fixed = calcEstFixedHeight(m);
            return eu - fixed;
        }
        // Total height used (should always = espacio_util if colgador present)
        function calcEstZoneHeight(m) {
            var eu = estEspacioUtil(m);
            var fixed = calcEstFixedHeight(m);
            var hasColg = m.zones.some(function(z) {
                return z.type === 'colgador';
            });
            if (hasColg)
                return eu;
            return fixed;
        }
        // Get display height for any zone
        function getEstZoneDisplayHeight(m, z) {
            if (z.type === 'cajones')
                return (z.count || 1) * (z.cajonHeight || 20);
            if (z.type === 'colgador')
                return calcEstColgadorHeight(m, z);
            if (z.type === 'zapatero')
                return (z.repisas || 3) * (z.repisaHeight || 15);
            if (z.type === 'entrepa') {
                // Especial modules without colgador: entrepaños divide the full space evenly
                var espColg = m.type === 'especial' && m.zones.some(function(x) {
                    return x.type === 'colgador';
                });
                if (m.type === 'especial' && !espColg) {
                    var eu = estEspacioUtil(m);
                    var cnt = z.count || 2;
                    return eu / cnt;
                }
                // Regular modules: entrepaños divide the free space evenly
                var freeEnt = calcEstFreeSpace(m);
                if (freeEnt > 0) {
                    var cntEnt = z.count || 2;
                    return freeEnt / (cntEnt + 1);
                }
                return (z.count || 2) * ((S.estProject.thickness || 16) / 10);
            }
            return 0;
        }

        function calcEstChapML(m, TK) {
            var W = m.width * 10,
                H = estModHeight(m) * 10,
                D = estProjDepth(m) * 10;
            var ml = 0;
            var ch = m.chap;
            if (!ch)
                return 0;
            if (ch.edges.latIzq)
                ml += (H / 1000) * 2;
            if (ch.edges.latDer)
                ml += (H / 1000) * 2;
            if (ch.edges.techo)
                ml += ((W - 2 * TK) / 1000) * 2 + (D / 1000) * 2;
            if (ch.edges.piso)
                ml += ((W - 2 * TK) / 1000) * 2 + (D / 1000) * 2;
            if (ch.edges.fondo)
                ml += (W / 1000) * 2 + (H / 1000) * 2;
            return ml;
        }

        function calcPaintLiters(m2, coats) {
            return (m2 * (coats || 2)) / 10;
        }

        function calcPaintM2(m, projConfig) {
            var paint = m.paint;
            if (!paint || !paint.enabled)
                return 0;
            var scope = paint.scope || 'doors';
            var qm = m.quoteMode || 'completo';
            var doorsM2 = 0,
                structM2 = 0;
            var w = m.width * 10,
                h,
                d;
            if (projConfig.mode === 'est') {
                h = estModHeight(m) * 10;
                d = estProjDepth(m) * 10;
            } else {
                h = (m.height || projConfig.defaultHeight || 200) * 10;
                d = (projConfig.defaultDepth || 50) * 10;
            }
            if (scope === 'doors' || scope === 'all') {
                if (m.doors || qm === 'solo_puertas') {
                    if (projConfig.mode === 'est') {
                        var doorMode = m.doorMode || 'por_zona';
                        if (doorMode === 'completa') {
                            var cnt = m.doorCount || 2;
                            var dw = Math.round(w / cnt) - 3,
                                dh = h - 3;
                            if ((m.doorMaterial || 'melamina') === 'melamina')
                                doorsM2 += (dw / 1000) * (dh / 1000) * cnt;
                        } else {
                            (m.zones || []).forEach(function(z) {
                                if (!z.doors)
                                    return;
                                var zH = Math.round(getEstZoneDisplayHeight(m, z) * 10);
                                var pw2 = Math.round(w / 2) - 3;
                                if ((z.doorMaterial || 'melamina') === 'melamina')
                                    doorsM2 += (pw2 / 1000) * ((zH - 3) / 1000) * 2;
                            });
                        }
                    } else {
                        var doorCnt = m.type === 'esquinero' ? 2 : Math.ceil(m.width / 50);
                        var dw2 = Math.round(w / doorCnt) - 3,
                            dh2 = h - 3;
                        if (m.doorMaterial !== 'vidrio')
                            doorsM2 += (dw2 / 1000) * (dh2 / 1000) * doorCnt;
                    }
                }
            }
            if ((scope === 'structure' || scope === 'all') && qm !== 'solo_puertas') {
                structM2 += 2 * (d / 1000) * (h / 1000);
                structM2 += 2 * (w / 1000) * (d / 1000);
            }
            return doorsM2 + structM2;
        }

        function calcEstLedBOM() {
            var EP = S.estProject,
                totalMeters = 0,
                totalSegments = 0,
                hasLed = false;
            EP.modules.forEach(function(m) {
                if (!m.led || !m.led.enabled)
                    return;
                hasLed = true;
                var auto = calcEstModuleLedMeters(m);
                var usedMeters = (m.led.metersOverride !== null && m.led.metersOverride >= 0) ? m.led.metersOverride : auto.meters;
                var usedSegments = (m.led.segmentsOverride !== null && m.led.segmentsOverride >= 0) ? m.led.segmentsOverride : auto.segments;
                totalMeters += usedMeters;
                totalSegments += usedSegments;
            });
            if (!hasLed)
                return null;
            var LC = LED_CATALOG,
                items = [];
            var tiraKey = EP.ledConfig.lightTemp === 'fria' ? 'tira_fria' : 'tira_calida';
            var tiraInfo = LC.variable[tiraKey];
            var tiraQty = Math.max(1, Math.ceil(totalMeters / tiraInfo.length));
            items.push({
                desc: tiraInfo.desc,
                qty: tiraQty,
                unitPrice: tiraInfo.price,
                total: tiraQty * tiraInfo.price,
                type: 'variable'
            });
            var cableAlimQty = Math.max(1, totalSegments);
            items.push({
                desc: LC.variable.cable_alim_tira.desc,
                qty: cableAlimQty,
                unitPrice: LC.variable.cable_alim_tira.price,
                total: cableAlimQty * LC.variable.cable_alim_tira.price,
                type: 'variable'
            });
            var perfilQty = Math.max(1, Math.ceil(totalMeters / LC.variable.perfil_embutir.length));
            items.push({
                desc: LC.variable.perfil_embutir.desc,
                qty: perfilQty,
                unitPrice: LC.variable.perfil_embutir.price,
                total: perfilQty * LC.variable.perfil_embutir.price,
                type: 'variable'
            });
            var extQty = Math.max(1, Math.ceil(totalMeters / 4));
            items.push({
                desc: LC.variable.cable_extension.desc,
                qty: extQty,
                unitPrice: LC.variable.cable_extension.price,
                total: extQty * LC.variable.cable_extension.price,
                type: 'variable'
            });
            if (totalSegments > 6) {
                var extraDist = Math.ceil((totalSegments - 6) / 6);
                items.push({
                    desc: LC.variable.regleta_extra.desc,
                    qty: extraDist,
                    unitPrice: LC.variable.regleta_extra.price,
                    total: extraDist * LC.variable.regleta_extra.price,
                    type: 'variable'
                });
            }
            items.push({
                desc: LC.fixed.distribuidor.desc,
                qty: 1,
                unitPrice: LC.fixed.distribuidor.price,
                total: LC.fixed.distribuidor.price,
                type: 'fixed'
            });
            var totalWatts = totalMeters * LC.wattsPerMeter * LC.headroom;
            var alim = LC.alimentadores[LC.alimentadores.length - 1];
            for (var i = 0; i < LC.alimentadores.length; i++) {
                if (totalWatts <= LC.alimentadores[i].w) {
                    alim = LC.alimentadores[i];
                    break;
                }
            }
            items.push({
                desc: alim.desc,
                qty: 1,
                unitPrice: alim.price,
                total: alim.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_primario.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_primario.price,
                total: LC.fixed.cable_primario.price,
                type: 'fixed'
            });
            var sw = LC.switches[EP.ledConfig.activation] || LC.switches.dimmer;
            items.push({
                desc: sw.desc,
                qty: 1,
                unitPrice: sw.price,
                total: sw.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_interruptor.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_interruptor.price,
                total: LC.fixed.cable_interruptor.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.placa_montaje.desc,
                qty: 1,
                unitPrice: LC.fixed.placa_montaje.price,
                total: LC.fixed.placa_montaje.price,
                type: 'fixed'
            });
            var totalCost = items.reduce(function(a, it) {
                return a + it.total;
            }, 0);
            return {
                items: items,
                totalCost: totalCost,
                totalMeters: totalMeters,
                totalSegments: totalSegments,
                totalWatts: totalWatts,
                alimentadorW: alim.w
            };
        }

        function calcEstandarizado() {
            var EP = S.estProject,
                pieces = [],
                autoHW = [];
            var TK = EP.thickness,
                useDual = !EP.sameMaterial;

            EP.modules.forEach(function(m, mi) {
                var D = estProjDepth(m) * 10;
                var W = m.width * 10;
                var H = estModHeight(m) * 10;
                var mname = 'Mod ' + (mi + 1);
                var mid = m.id;
                var qm = m.quoteMode || 'completo';
                // Structure: 2 laterales, techo, piso, fondo
                if (qm !== 'solo_puertas') {
                    if (m.type === 'fijo') {
                        // Fijo: single sheet
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Fijo)',
                            mw: m.width,
                            n: 'Fijo',
                            q: 1,
                            w: W,
                            h: H,
                            t: TK,
                            c: 4,
                            z: 'i'
                        });
                    } else if (m.type === 'panelTV') {
                        // Panel TV: flat panel + 2 travesaños horizontales
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (PanelTV)',
                            mw: m.width,
                            n: 'Panel frontal',
                            q: 1,
                            w: W,
                            h: H,
                            t: TK,
                            c: 4,
                            z: 'f'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (PanelTV)',
                            mw: m.width,
                            n: 'Travesa\u00f1o',
                            q: 2,
                            w: W - 2 * TK,
                            h: D,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (PanelTV)',
                            mw: m.width,
                            n: 'Fondo',
                            q: 1,
                            w: W - 2 * TK,
                            h: H - 2 * TK,
                            t: TK,
                            z: 'i'
                        });
                    } else if (m.type === 'esquinero') {
                        var W2 = (m.width2 || m.width) * 10;
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Lateral A',
                            q: 1,
                            w: W,
                            h: H,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Lateral B',
                            q: 1,
                            w: W2,
                            h: H,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Techo',
                            q: 1,
                            w: W - TK,
                            h: W2 - TK,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Piso',
                            q: 1,
                            w: W - TK,
                            h: W2 - TK,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname + ' (Esq)',
                            mw: m.width,
                            n: 'Fondo',
                            q: 1,
                            w: W - 2 * TK,
                            h: H - 2 * TK,
                            t: TK,
                            z: 'i'
                        });
                    } else {
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Lateral izq',
                            q: 1,
                            w: D,
                            h: H,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Lateral der',
                            q: 1,
                            w: D,
                            h: H,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Techo',
                            q: 1,
                            w: W - 2 * TK,
                            h: D,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Piso',
                            q: 1,
                            w: W - 2 * TK,
                            h: D,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Fondo',
                            q: 1,
                            w: W - 2 * TK,
                            h: H - 2 * TK,
                            t: TK,
                            z: 'i'
                        });
                    }

                    // Entrepaños module: generate shelf pieces (no zones)
                    if (m.type === 'entrepanos') {
                        var sc = m.shelfCount || 3;
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Entrepa\u00f1o',
                            q: sc,
                            w: W - 2 * TK,
                            h: D - 20,
                            t: TK,
                            z: 'i'
                        });
                    }

                    // Zones
                    m.zones.forEach(function(z) {
                        if (z.type === 'entrepa') {
                            var cnt = z.count || 2;
                            var eW = W - 2 * TK;
                            var eD = m.type === 'esquinero' ? D : D - 20;
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Entrepa\u00f1o',
                                q: cnt,
                                w: eW,
                                h: eD,
                                t: TK,
                                z: 'i'
                            });
                        } else if (z.type === 'cajones') {
                            var cnt = z.count || 3;
                            var ch = (z.cajonHeight || 20) * 10;
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Frente caj\u00f3n',
                                q: cnt,
                                w: W - 2 * TK - 3,
                                h: ch,
                                t: TK,
                                c: 4,
                                z: 'f'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Lateral caj\u00f3n',
                                q: cnt * 2,
                                w: D - 50,
                                h: ch - 30,
                                t: TK,
                                z: 'i'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Trasera caj\u00f3n',
                                q: cnt,
                                w: W - 2 * TK - 40,
                                h: ch - 30,
                                t: TK,
                                z: 'i'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Fondo caj\u00f3n',
                                q: cnt,
                                w: W - 2 * TK - 20,
                                h: D - 50,
                                t: TK,
                                z: 'i'
                            });
                            autoHW.push({
                                key: 'corr_eco',
                                q: cnt,
                                modId: mid
                            });
                            if (m.doors) {
                                if (m.doorType === 'tipon') {
                                    autoHW.push({
                                        key: 'tipon',
                                        q: cnt,
                                        modId: mid
                                    });
                                    autoHW.push({
                                        key: 'placa_tipon',
                                        q: cnt,
                                        modId: mid
                                    });
                                }
                                else {
                                    autoHW.push({
                                        key: 'jaladera',
                                        q: cnt,
                                        modId: mid
                                    });
                                }
                            } else {
                                autoHW.push({
                                    key: 'jaladera',
                                    q: cnt,
                                    modId: mid
                                });
                            }
                        } else if (z.type === 'colgador') {
                            autoHW.push({
                                key: 'tubo',
                                q: 1,
                                modId: mid
                            });
                            autoHW.push({
                                key: 'soporte',
                                q: 2,
                                modId: mid
                            });
                        } else if (z.type === 'zapatero') {
                            var reps = z.repisas || 3;
                            var zapH = (z.repisaHeight || 15) * 10; // full height per cajón extraíble in mm
                            var zapFrH = 50; // 5cm visible front height
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Frente zapatero',
                                q: reps,
                                w: W - 2 * TK - 3,
                                h: zapFrH,
                                t: TK,
                                c: 4,
                                z: 'f'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Lateral zapatero',
                                q: reps * 2,
                                w: D - 50,
                                h: zapFrH,
                                t: TK,
                                z: 'i'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Trasera zapatero',
                                q: reps,
                                w: W - 2 * TK - 40,
                                h: zapFrH,
                                t: TK,
                                z: 'i'
                            });
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: 'Fondo zapatero',
                                q: reps,
                                w: W - 2 * TK - 20,
                                h: D - 50,
                                t: TK,
                                z: 'i'
                            });
                            autoHW.push({
                                key: 'corr_eco',
                                q: reps,
                                modId: mid
                            });
                        }
                    });
                } // end qm!=='solo_puertas' (structure+zones)

                // Doors
                var doorMode = m.doorMode || 'por_zona';
                if (m.doors && doorMode === 'completa') {
                    // Full-height doors spanning entire module
                    var fullDoorCnt = m.doorCount || 2;
                    var fullDoorMat = m.doorMaterial || 'melamina';
                    var fullDoorType = m.doorType || 'tipon';
                    var fullDoorW = Math.round(W / fullDoorCnt) - 3;
                    var fullDoorH = H - 3; // full espacio util height minus gap
                    if (fullDoorMat === 'melamina') {
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Puerta completa',
                            q: fullDoorCnt,
                            w: fullDoorW,
                            h: fullDoorH,
                            t: TK,
                            c: 4,
                            z: 'f'
                        });
                    }
                    // Bisagra count from CONFIG rules based on door height
                    var fullDoorHeightCm = estModHeight(m);
                    var fullDoorMat = m.doorMaterial || 'melamina';
                    var hingasPerDoor = getBisagraCount(fullDoorHeightCm, fullDoorMat);
                    autoHW.push({
                        key: 'bisagra',
                        q: hingasPerDoor * fullDoorCnt,
                        modId: mid
                    });
                    autoHW.push({
                        key: 'base_clip',
                        q: hingasPerDoor * fullDoorCnt,
                        modId: mid
                    });
                    if (fullDoorType === 'tipon') {
                        autoHW.push({
                            key: 'tipon',
                            q: fullDoorCnt,
                            modId: mid
                        });
                        autoHW.push({
                            key: 'placa_tipon',
                            q: fullDoorCnt,
                            modId: mid
                        });
                    }
                    else if (fullDoorType === 'jaladera') {
                        autoHW.push({
                            key: 'jaladera',
                            q: fullDoorCnt,
                            modId: mid
                        });
                    }
                } else if (doorMode === 'por_zona') {
                    // Per-zone doors
                    m.zones.forEach(function(z) {
                        if (!z.doors)
                            return;
                        var zH = Math.round(getEstZoneDisplayHeight(m, z) * 10); // zone height in mm
                        var pw2 = Math.round(W / 2) - 3;
                        var dMat = z.doorMaterial || 'melamina';
                        var dType = z.doorType || 'tipon';
                        var zLabel = EST_ZONE_TYPES.find(function(x) {
                            return x.id === z.type;
                        });
                        var doorName = 'Puerta ' + (zLabel ? zLabel.n : z.type);
                        if (dMat === 'melamina') {
                            pieces.push({
                                mid: mid,
                                mn: mname,
                                mw: m.width,
                                n: doorName,
                                q: 2,
                                w: pw2,
                                h: zH - 3,
                                t: TK,
                                c: 4,
                                z: 'f'
                            });
                        }
                        // Hardware: bisagras per door from CONFIG rules
                        var zoneDoorHeightCm = Math.round(getEstZoneDisplayHeight(m, z));
                        var zoneBisCount = getBisagraCount(zoneDoorHeightCm, dMat);
                        autoHW.push({
                            key: 'bisagra',
                            q: zoneBisCount * 2,
                            modId: mid
                        });
                        autoHW.push({
                            key: 'base_clip',
                            q: zoneBisCount * 2,
                            modId: mid
                        });
                        if (dType === 'tipon') {
                            autoHW.push({
                                key: 'tipon',
                                q: 2,
                                modId: mid
                            });
                            autoHW.push({
                                key: 'placa_tipon',
                                q: 2,
                                modId: mid
                            });
                        }
                        else if (dType === 'jaladera') {
                            autoHW.push({
                                key: 'jaladera',
                                q: 2,
                                modId: mid
                            });
                        }

                    });
                }
                // jaladera_int: fresada, no additional hardware

                // Zoclo (baseboard - outside 2m, 55cm depth, arremetido)
                if (qm !== 'solo_puertas') {
                    var zoc = m.zoclo || {
                        enabled: false,
                        height: 10
                    };
                    if (zoc.enabled) {
                        var zocH = (zoc.height || 10) * 10; // height in mm
                        var zocD = 550; // 55cm depth
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Zoclo frente',
                            q: 1,
                            w: W,
                            h: zocH,
                            t: TK,
                            c: 1,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Zoclo trasera',
                            q: 1,
                            w: W,
                            h: zocH,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Zoclo lateral',
                            q: 2,
                            w: zocD,
                            h: zocH,
                            t: TK,
                            c: 1,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Zoclo larguero',
                            q: 2,
                            w: zocD - 2 * TK,
                            h: zocH,
                            t: TK,
                            z: 'i'
                        });
                    }

                    // Maletero (on top of module, outside height)
                    var mal = m.maletero || {
                        enabled: false,
                        height: 30
                    };
                    if (mal.enabled) {
                        var malH = (mal.height || 30) * 10;
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Lateral maletero',
                            q: 2,
                            w: D - 50,
                            h: malH - 30,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Trasera maletero',
                            q: 1,
                            w: W - 2 * TK - 40,
                            h: malH - 30,
                            t: TK,
                            z: 'i'
                        });
                        pieces.push({
                            mid: mid,
                            mn: mname,
                            mw: m.width,
                            n: 'Fondo maletero',
                            q: 1,
                            w: W - 2 * TK - 20,
                            h: D - 50,
                            t: TK,
                            z: 'i'
                        });
                        autoHW.push({
                            key: 'corr_eco',
                            q: 1,
                            modId: mid
                        });
                        // Maletero doors
                        if (mal.doors) {
                            var malDoorH = malH - 3;
                            var malPw2 = Math.round(W / 2) - 3;
                            var malDMat = mal.doorMaterial || 'melamina';
                            var malDType = mal.doorType || 'tipon';
                            if (malDMat === 'melamina') {
                                pieces.push({
                                    mid: mid,
                                    mn: mname,
                                    mw: m.width,
                                    n: 'Puerta maletero',
                                    q: 2,
                                    w: malPw2,
                                    h: malDoorH,
                                    t: TK,
                                    c: 4,
                                    z: 'f'
                                });
                            }
                            var malHeightCm = mal.height || 30;
                            var malBisCount = getBisagraCount(malHeightCm, malDMat);
                            autoHW.push({
                                key: 'bisagra',
                                q: malBisCount * 2,
                                modId: mid
                            });
                            autoHW.push({
                                key: 'base_clip',
                                q: malBisCount * 2,
                                modId: mid
                            });
                            if (malDType === 'tipon') {
                                autoHW.push({
                                    key: 'tipon',
                                    q: 2,
                                    modId: mid
                                });
                                autoHW.push({
                                    key: 'placa_tipon',
                                    q: 2,
                                    modId: mid
                                });
                            }
                            else if (malDType === 'jaladera') {
                                autoHW.push({
                                    key: 'jaladera',
                                    q: 2,
                                    modId: mid
                                });
                            }
                        }
                    }

                    // Niveladores per module
                    autoHW.push({
                        key: 'nivelador',
                        q: 4,
                        modId: mid
                    });
                } // end qm!=='solo_puertas' (zoclo+maletero+niveladores)
            });

            // Calculate areas, sheets, canto — all pieces use project thickness
            var TK_EST = EP.thickness || 16;
            var areaF = 0, areaI = 0, cantoF = 0, cantoI = 0;
            pieces.forEach(function(p) {
                var a = (p.w / 1000) * (p.h / 1000) * p.q;
                if (useDual && p.z === 'i') areaI += a;
                else areaF += a;
                var ml = 0;
                if (p.c) {
                    if (p.c === 4)
                        ml = ((p.w + p.h) * 2 / 1000) * p.q;
                    else if (p.c === 2)
                        ml = ((p.w + p.h) / 1000) * p.q;
                    else
                        ml = (Math.max(p.w, p.h) / 1000) * p.q;
                } else {
                    ml = (Math.max(p.w, p.h) / 1000) * p.q;
                }
                if (useDual && p.z === 'i')
                    cantoI += ml;
                else
                    cantoF += ml;
            });

            // Add chapacanto from module edge selections
            EP.modules.forEach(function(m) {
                var chapML = calcEstChapML(m, EP.thickness);
                cantoF += chapML;
            });

            var SHEET = 1.22 * 2.44;
            var merma = CONFIG.pricing.mermaFactor;
            var totalSheetsF = Math.ceil(areaF * merma / SHEET);
            var totalSheetsI = Math.ceil(areaI * merma / SHEET);
            var sheetsF = { 16: 0, 25: 0 }; sheetsF[TK_EST] = totalSheetsF;
            var sheetsI = { 16: 0, 25: 0 }; sheetsI[TK_EST] = totalSheetsI;
            cantoF = Math.ceil(cantoF);
            cantoI = Math.ceil(cantoI);
            var totalSheets = totalSheetsF + totalSheetsI;
            var totalCanto = cantoF + cantoI;

            var matPriceF = getMatPrice(EP.matFrentes, TK_EST);
            var matPriceI = getMatPrice(EP.matInterior, TK_EST);
            var matCostF = totalSheetsF * matPriceF;
            var matCostI = totalSheetsI * matPriceI;
            var chapCostF = cantoF * EP.chapFrentesPrice;
            var chapCostI = cantoI * EP.chapInteriorPrice;
            var corteCost = totalSheets * CONFIG.pricing.cuttingCostPerSheet;
            var enchapPrice = typeof EP.enchapPrice === 'number' ? EP.enchapPrice : 13;
            var enchapCost = totalCanto * enchapPrice;
            var carpCost = matCostF + matCostI + chapCostF + chapCostI + corteCost + enchapCost + EP.laborCost + (EP.freight ? EP.freightCost : 0);

            // Apply module-level hwOverrides: adjust autoHW quantities before consolidation
            var modAutoHW = autoHW.map(function(ah) {
                return {
                    key: ah.key,
                    q: ah.q,
                    modId: ah.modId
                };
            });
            EP.modules.forEach(function(m) {
                if (!m.hwOverrides)
                    return;
                // Consolidate auto quantities per key for this module
                var modTotals = {};
                modAutoHW.forEach(function(ah) {
                    if (ah.modId !== m.id)
                        return;
                    if (!modTotals[ah.key])
                        modTotals[ah.key] = 0;
                    modTotals[ah.key] += ah.q;
                });
                for (var ok in m.hwOverrides) {
                    if (typeof modTotals[ok] === 'undefined')
                        continue;
                    var autoTotal = modTotals[ok];
                    var overrideQty = m.hwOverrides[ok];
                    if (overrideQty === autoTotal)
                        continue;
                    // Distribute the override: scale each entry proportionally or set the first and zero others
                    var entries = modAutoHW.filter(function(ah) {
                        return ah.modId === m.id && ah.key === ok;
                    });
                    if (entries.length === 1) {
                        entries[0].q = overrideQty;
                    } else if (entries.length > 1) {
                        entries[0].q = overrideQty;
                        for (var ei = 1; ei < entries.length; ei++)
                            entries[ei].q = 0;
                    }
                }
            });

            var hwConsolidated = {};
            // First pass: compute true autoQty from original autoHW
            autoHW.forEach(function(ah) {
                var def = HW_DEFAULTS[ah.key];
                if (!def)
                    return;
                var catItem = findCatItem(def.desc, def.marca);
                var price = catItem ? adjPrice(catItem) : def.fallback;
                var k = ah.key;
                if (!hwConsolidated[k])
                    hwConsolidated[k] = {
                        key: k,
                        desc: def.desc,
                        marca: def.marca,
                        price: price,
                        qty: 0,
                        autoQty: 0,
                        cat: def.cat,
                        catItem: catItem
                    };
                hwConsolidated[k].autoQty += ah.q;
            });
            // Second pass: compute effective qty from overridden modAutoHW
            modAutoHW.forEach(function(ah) {
                var k = ah.key;
                if (!hwConsolidated[k])
                    return;
                hwConsolidated[k].qty += ah.q;
            });
            // Apply hardware overrides (qty changes and item swaps)
            var ov = EP.hwOverrides || {};
            for (var ok in ov) {
                if (!hwConsolidated[ok])
                    continue;
                var o = ov[ok];
                if (typeof o.qty === 'number')
                    hwConsolidated[ok].qty = Math.max(0, o.qty);
                if (o.swap) {
                    hwConsolidated[ok].desc = o.swap.desc;
                    hwConsolidated[ok].marca = o.swap.marca;
                    hwConsolidated[ok].price = o.swap.price;
                    hwConsolidated[ok].catItem = o.swap.catItem || null;
                }
            }
            var manualHW = [];
            EP.hardware.forEach(function(h2) {
                manualHW.push({
                    desc: h2.descripcion,
                    marca: h2.marca,
                    price: adjPrice(h2),
                    qty: h2.qty,
                    cat: h2.categoria,
                    codigo: h2.codigo
                });
            });

            var hwCostCarpBucket = 0,
                hwCostPremium = 0;
            var hwCostHerraxa = 0,
                hwCostHafele = 0,
                hwCostBlum = 0;
            var allHW = [];
            var hwThreshold = CONFIG.pricing.hardwareThreshold;
            for (var k in hwConsolidated) {
                var h2 = hwConsolidated[k];
                allHW.push(h2);
                var cost = Math.ceil(h2.qty) * h2.price;
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h2._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h2._bucket = 'premium';
                }
                if (h2.marca === 'BLUM') hwCostBlum += cost;
                else if (h2.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            }
            manualHW.forEach(function(h2) {
                allHW.push(h2);
                var cost = Math.ceil(h2.qty) * h2.price;
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h2._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h2._bucket = 'premium';
                }
                if (h2.marca === 'BLUM') hwCostBlum += cost;
                else if (h2.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            });
            var hwStdCost = hwCostHerraxa + hwCostHafele;

            var extraCost = 0;
            var ledBOM = calcEstLedBOM();
            if (ledBOM)
                extraCost += ledBOM.totalCost;

            // Vidrio cost: accumulate from zones, full-height doors, and maletero doors
            var vidrioCost = 0;
            EP.modules.forEach(function(m) {
                var doorMode = m.doorMode || 'por_zona';
                if (m.doors && doorMode === 'completa' && (m.doorMaterial || 'melamina') === 'vidrio') {
                    vidrioCost += (m.vidrioPrice || 0);
                }
                if (m.doors && doorMode === 'por_zona') {
                    m.zones.forEach(function(z) {
                        if (z.doors && (z.doorMaterial || 'melamina') === 'vidrio') {
                            vidrioCost += (z.vidrioPrice || 0);
                        }
                    });
                }
                var mal = m.maletero || {
                    enabled: false
                };
                if (mal.enabled && mal.doors && (mal.doorMaterial || 'melamina') === 'vidrio') {
                    vidrioCost += (mal.vidrioPrice || 0);
                }
            });
            if (vidrioCost > 0)
                extraCost += vidrioCost;
            var paintCost = 0;
            EP.modules.forEach(function(m2) {
                if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                    var pm2 = calcPaintM2(m2, {
                        mode: 'est'
                    });
                    var liters = calcPaintLiters(pm2, m2.paint.coats);
                    paintCost += liters * m2.paint.pricePerLiter;
                }
            });
            if (paintCost > 0)
                extraCost += paintCost;

            var mult = EP.saleMultiplier || CONFIG.pricing.defaultSaleMultiplier;
            var carpMultiplier = CONFIG.pricing.carpentryMultiplier;
            var premiumMargin = CONFIG.pricing.premiumHardwareMargin;
            // Carpentry + low-cost hardware (≤ threshold) → carpentry multiplier (3x)
            var carpSale = (carpCost + hwCostCarpBucket) * carpMultiplier;
            // Premium hardware (> threshold) → margin-based (cost / 0.70 = 30% margin)
            var hwPremiumSale = hwCostPremium > 0 ? hwCostPremium / (1 - premiumMargin) : 0;
            // Extras
            var extrasSale = extraCost * CONFIG.pricing.extrasMultiplier;
            var totalCostAll = carpCost + hwCostCarpBucket + hwCostPremium + extraCost;
            var subtotal = carpSale + hwPremiumSale + extrasSale;
            var iva = subtotal * CONFIG.pricing.iva;
            var total = subtotal + iva;
            var profit = subtotal - totalCostAll;
            var margin = subtotal > 0 ? ((profit / subtotal) * 100).toFixed(1) : 0;

            return {
                pieces: pieces,
                autoHW: autoHW,
                allHW: allHW,
                hwConsolidated: hwConsolidated,
                manualHW: manualHW,
                sheetsF: sheetsF,
                sheetsI: sheetsI,
                cantoF: cantoF,
                cantoI: cantoI,
                totalSheetsF: totalSheetsF,
                totalSheetsI: totalSheetsI,
                totalSheets: totalSheets,
                totalCanto: totalCanto,
                matCostF: matCostF,
                matCostI: matCostI,
                chapCostF: chapCostF,
                chapCostI: chapCostI,
                corteCost: corteCost,
                enchapCost: enchapCost,
                carpCost: carpCost,
                hwCostCarpBucket: hwCostCarpBucket,
                hwCostPremium: hwCostPremium,
                hwCostHerraxa: hwCostHerraxa,
                hwCostHafele: hwCostHafele,
                hwCostBlum: hwCostBlum,
                hwStdCost: hwStdCost,
                extraCost: extraCost,
                vidrioCost: vidrioCost,
                ledBOM: ledBOM,
                paintCost: paintCost,
                carpSale: carpSale,
                hwPremiumSale: hwPremiumSale,
                extrasSale: extrasSale,
                subtotal: subtotal,
                iva: iva,
                total: total,
                totalCost: totalCostAll,
                profit: profit,
                margin: margin,
                useDual: useDual,
                saleMultiplier: mult,
                projThickness: TK_EST,
                matPriceF: matPriceF,
                matPriceI: matPriceI
            };
        }

        // === RENDER FUNCTIONS ===
        function renderTemplates() {
            var h = '<div class="tpl-grid">';
            h += '<div class="title"><h2>Plantillas</h2><p>Selecciona un diseno para cotizar</p></div>';
            h += '<button class="tpl-new" onclick="APP.newProject()">' + svg('plus') + 'Nuevo proyecto desde cero</button>';
            // h += '<button class="est-home-btn" onclick="APP.newEstandarizado()">&#x1f5c4;&#xfe0f; Closet Estandarizado</button>'; // Hidden for now
            // Saved projects
            var saved = loadSavedProjects();
            if (saved.length > 0) {
                h += '<div class="saved-projects-section">';
                var cloudIcon = cloudProjects !== null ? '<span style="color:#4ade80;font-size:11px;margin-left:8px">&#9729; En la nube</span>' : '<span style="color:#fbbf24;font-size:11px;margin-left:8px">&#9729; Sincronizando...</span>';
                h += '<div class="saved-projects-title">Proyectos Guardados (' + saved.length + ')' + cloudIcon + '</div>';
                saved.forEach(function(sp, idx) {
                    h += '<div class="saved-project-card">';
                    h += '<div class="saved-project-info">';
                    h += '<div class="sp-client">' + (sp.client || 'Sin nombre') + '</div>';
                    h += '<div class="sp-meta">' + sp.label + ' &middot; ' + (sp.savedAt ? new Date(sp.savedAt).toLocaleDateString('es-MX', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                    }) : '') + '</div>';
                    h += '</div>';
                    h += '<div class="saved-project-actions">';
                    h += '<button class="sp-load" onclick="APP.loadSavedProject(' + idx + ')">Cargar</button>';
                    h += '<button class="sp-del" onclick="APP.deleteSavedProject(' + idx + ')">&times;</button>';
                    h += '</div></div>';
                });
                h += '</div>';
            }
            /* TEMPLATES hidden
            TEMPLATES.forEach(function(t) {
                var typeName = TYPES.find(function(x) {
                    return x.id === t.type;
                });
                h += '<div class="tpl-card">';
                h += '<img class="tpl-card-img" src="' + t.photo + '" alt="' + t.name + '" onclick="APP.openImg(\'' + t.photo + '\')" onerror="this.outerHTML=\'<div style=height:180px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;font-size:48px>&#x1f4f7;</div>\'">';
                h += '<div class="tpl-card-body">';
                h += '<div class="tpl-card-name">' + t.name + '</div>';
                if (typeName)
                    h += '<span class="tpl-card-type">' + typeName.n + '</span>';
                h += '<div class="tpl-card-desc">' + t.desc + '</div>';
                h += '<div class="tpl-card-dims">' + (t.baseWidth / 100) + 'm ancho x ' + (t.baseHeight / 100) + 'm alto</div>';
                h += '<div class="tpl-card-price">' + fmt(t.basePrice) + '</div>';
                h += '<button class="tpl-card-btn" onclick="APP.selectTpl(\'' + t.id + '\')">Usar plantilla</button>';
                h += '</div></div>';
            });
            */
            h += '</div>';
            return h;
        }

        function renderQuickQuote() {
            var t = TEMPLATES.find(function(x) {
                return x.id === S.selTemplate;
            });
            if (!t)
                return '';
            var nw = S.quickWidth,
                nh = S.quickHeight;
            // CUSTOMIZE: Quick quote ratio logic — adjust pricing formula here
            var ratio = (nw * nh) / (t.baseWidth * t.baseHeight);
            var newPrice = Math.round(t.basePrice * ratio / 500) * 500;
            var iva = newPrice * CONFIG.pricing.iva;
            var total = newPrice + iva;
            var matName = S.quickMatName || t.matName;
            var matFinish = S.quickMatFinish || t.matFinish;
            var matDisplay = S.quickMatName ? matName + ' (' + matFinish + ')' : t.material;
            var h = '<img class="qq-img" src="' + t.photo + '" alt="' + t.name + '" onclick="APP.openImg(\'' + t.photo + '\')" style="cursor:pointer" onerror="this.style.display=\'none\'">';
            h += '<div class="qq-body">';
            h += '<div class="qq-name">' + t.name + '</div>';
            h += '<div class="qq-desc">' + t.desc + '</div>';
            h += '<div class="qq-section"><div class="qq-section-title">Ajustar medidas</div>';
            h += '<div class="qq-dim-row"><label>Ancho:</label><input class="qq-dim-input" type="number" value="' + (nw / 100) + '" step="0.1" min="0.5" max="8" onchange="APP.setQW(parseFloat(this.value)*100)"><span>m</span></div>';
            h += '<div class="qq-dim-row"><label>Alto:</label><input class="qq-dim-input" type="number" value="' + (nh / 100) + '" step="0.1" min="0.5" max="4" onchange="APP.setQH(parseFloat(this.value)*100)"><span>m</span></div>';
            h += '<div class="qq-base-ref" style="font-size:12px;color:#999;text-align:center;margin-top:4px">Base: ' + (t.baseWidth / 100) + 'm x ' + (t.baseHeight / 100) + 'm = ' + fmt(t.basePrice) + '</div></div>';
            h += '<div class="qq-section"><div class="qq-section-title">Material</div>';
            h += '<select class="qq-mat-select" onchange="APP.setQMat(this.value)">';
            h += '<option value=""' + (S.quickMat === '' ? ' selected' : '') + '>' + t.material + ' (original)</option>';
            COLORS.forEach(function(c) {
                h += '<option value="' + c.c + '"' + (S.quickMat === c.c ? ' selected' : '') + '>' + c.c + ' - ' + c.n + ' (' + c.f + ')</option>';
            });
            h += '</select></div>';
            h += '<div class="qq-price-box"><div class="qq-price-label">Precio estimado</div><div class="qq-price">' + fmt(newPrice) + '</div><div class="qq-price-iva">+ IVA = ' + fmt(total) + '</div></div>';
            h += '<div class="qq-info"><div class="qq-info-item"><span>Material</span><strong>' + matDisplay + '</strong></div><div class="qq-info-item"><span>Entrega</span><strong>' + t.weeks + ' semanas</strong></div><div class="qq-info-item"><span>Anticipo</span><strong>60%</strong></div><div class="qq-info-item"><span>Medida</span><strong>' + (nw / 100) + 'm x ' + (nh / 100) + 'm</strong></div></div>';
            h += '<div class="pdf-actions" style="margin-top:16px">';
            h += '<button class="pdf-btn client" onclick="APP.genQuickPDF(\'client\')">&#x1f4c4; PDF Cliente</button>';
            h += '<button class="pdf-btn internal" onclick="APP.genQuickPDF(\'internal\')">&#x1f512; PDF Interno</button>';
            h += '<button class="pdf-btn despiece" onclick="APP.genQuickPDF(\'despiece\')">&#x1f4cb; PDF Despiece</button>';
            h += '</div>';
            h += '<button class="qq-full-btn" onclick="APP.fullQuote()">' + svg('edit') + 'Editar en cotizador completo</button></div>';
            return h;
        }

        function renderMaterialSelect(label, mat, onChange, badgeClass) {
            var araucoTabs = getAraucoTableros();
            var h = '<div class="mat-section">';
            h += '<div class="mat-section-label">' + label;
            if (badgeClass)
                h += ' <span class="badge ' + badgeClass + '">' + (badgeClass === 'vis' ? 'visible' : 'oculto') + '</span>';
            h += '</div>';
            h += '<select class="mat-select" onchange="' + onChange + '(this.value)">';
            h += '<optgroup label="FINSA (Melamina)">';
            COLORS.forEach(function(c) {
                var sel = (mat.brand === 'FINSA' && mat.code === c.c) ? ' selected' : '';
                h += '<option value="FINSA:' + c.c + '"' + sel + '>' + c.c + ' - ' + c.n + ' (' + c.f + ') - ' + fmt(FINSA_PRICES[16]) + '/hoja</option>';
            });
            h += '</optgroup>';
            if (araucoTabs.length > 0) {
                h += '<optgroup label="ARAUCO (Tableros)">';
                araucoTabs.forEach(function(item, idx) {
                    var sel = (mat.brand === 'ARAUCO' && mat.catItem && mat.catItem.codigo === item.codigo) ? ' selected' : '';
                    h += '<option value="ARAUCO:' + idx + '"' + sel + '>' + item.descripcion + ' - ' + fmtD(item.precio) + '</option>';
                });
                h += '</optgroup>';
            }
            var customSel = mat.brand === 'CUSTOM' ? ' selected' : '';
            h += '<option value="CUSTOM:0"' + customSel + '>\u2014 Material personalizado \u2014</option>';
            h += '</select>';
            if (mat.brand === 'CUSTOM') {
                h += '<div style="display:flex;gap:12px;margin-top:8px">';
                h += '<div style="flex:2"><span style="font-size:12px;color:#bbb">Nombre</span><input type="text" value="' + (mat.name || '') + '" placeholder="Ej: MDF Nogal" onchange="' + onChange + '(\'CUSTOM_NAME:\'+this.value)" style="margin-top:4px"></div>';
                h += '<div style="flex:1"><span style="font-size:12px;color:#bbb">Precio/hoja</span><input type="number" value="' + (mat.customPrice || 0) + '" min="0" step="50" onchange="' + onChange + '(\'CUSTOM_PRICE:\'+this.value)" style="margin-top:4px"></div>';
                h += '</div>';
            }
            var matInfoStr = mat.brand === 'CUSTOM' ? (mat.name || 'Personalizado') + ' - ' + fmt(mat.customPrice || 0) + '/hoja' : mat.brand + ': ' + (mat.brand === 'FINSA' ? mat.name + ' (' + mat.finish + ')' : mat.catItem ? mat.catItem.descripcion : '');
            h += '<div class="mat-info">' + matInfoStr + '</div>';
            h += '</div>';
            return h;
        }

        function renderModuleLed(m) {
            var P = S.project;
            if (!m.led)
                m.led = {
                    enabled: false,
                    edges: {
                        top: false,
                        bottom: false,
                        left: false,
                        right: false,
                        shelves: false
                    },
                    shelfCount: 0,
                    ledMeters: 0,
                    segments: 0,
                    metersOverride: null,
                    segmentsOverride: null
                };
            var led = m.led;
            var h = '<div class="led-section">';
            h += '<div class="led-toggle-row"><span>&#x1f4a1; Iluminacion LED</span><button class="toggle' + (led.enabled ? ' on' : '') + '" onclick="APP.togModLed(\'' + m.id + '\')"></button></div>';
            if (!led.enabled) {
                h += '</div>';
                return h;
            }
            // Edge selector
            h += '<div class="led-edges">';
            h += '<div style="position:relative;padding:18px 34px">';
            h += '<div class="led-edge-box">';
            h += '<button class="led-edge top' + (led.edges.top ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'top\')"></button>';
            h += '<button class="led-edge bottom' + (led.edges.bottom ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'bottom\')"></button>';
            h += '<button class="led-edge left' + (led.edges.left ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'left\')"></button>';
            h += '<button class="led-edge right' + (led.edges.right ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'right\')"></button>';
            h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;color:#666;pointer-events:none;text-align:center;white-space:nowrap">' + m.width + 'x' + (m.height || P.defaultHeight || 200) + '</div>';
            h += '</div></div>';
            h += '<div class="led-opts">';
            // Shelf LED toggle + count
            h += '<div class="led-shelf-row"><button class="' + (led.edges.shelves ? 'on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'shelves\')">' + (led.edges.shelves ? '&#10003;' : '') + ' Entrepaños</button>';
            if (led.edges.shelves)
                h += '<input type="number" value="' + led.shelfCount + '" min="0" max="10" onchange="APP.setLedShelves(\'' + m.id + '\',parseInt(this.value))">';
            h += '</div>';
            // Auto-calc display
            var auto = calcModuleLedMeters(m);
            var usedM = (led.metersOverride !== null && led.metersOverride >= 0) ? led.metersOverride : auto.meters;
            var usedS = (led.segmentsOverride !== null && led.segmentsOverride >= 0) ? led.segmentsOverride : auto.segments;
            h += '<div class="led-meters"><span>Metros:</span><input type="number" value="' + usedM.toFixed(2) + '" min="0" step="0.1" onchange="APP.setLedMeters(\'' + m.id + '\',parseFloat(this.value))">';
            h += '<span>Segmentos:</span><input type="number" value="' + usedS + '" min="0" step="1" onchange="APP.setLedSegments(\'' + m.id + '\',parseInt(this.value))">';
            if (led.metersOverride !== null || led.segmentsOverride !== null)
                h += '<button style="padding:2px 6px;border-radius:4px;border:1px solid #fbbf24;background:none;color:#fbbf24;font-size:10px;cursor:pointer" onclick="APP.resetLedOverride(\'' + m.id + '\')">Auto</button>';
            h += '</div>';
            h += '</div></div>';
            // Activation type (project-level)
            h += '<div style="font-size:11px;color:#999;margin-bottom:4px">Activacion:</div>';
            h += '<div class="led-radio">';
            [{
                k: 'presion',
                l: 'Presion',
                p: LED_CATALOG.switches.presion.price
            }, {
                k: 'dimmer',
                l: 'Dimmer',
                p: LED_CATALOG.switches.dimmer.price
            }, {
                k: 'movimiento',
                l: 'Movimiento',
                p: LED_CATALOG.switches.movimiento.price
            }, {
                k: 'puerta',
                l: 'Puerta',
                p: LED_CATALOG.switches.puerta.price
            }].forEach(function(sw) {
                h += '<button class="' + (P.ledConfig.activation === sw.k ? 'sel' : '') + '" onclick="APP.setLedActivation(\'' + sw.k + '\')">' + sw.l + ' ' + fmtD(sw.p) + '</button>';
            });
            h += '</div>';
            // Light temperature (project-level)
            h += '<div style="font-size:11px;color:#999;margin:4px 0">Temperatura:</div>';
            h += '<div class="led-radio">';
            h += '<button class="' + (P.ledConfig.lightTemp === 'calida' ? 'sel' : '') + '" onclick="APP.setLedTemp(\'calida\')">Calida 3000K</button>';
            h += '<button class="' + (P.ledConfig.lightTemp === 'fria' ? 'sel' : '') + '" onclick="APP.setLedTemp(\'fria\')">Fria 5000K</button>';
            h += '</div>';
            // Mini BOM preview (project-level, shown on first module with LED)
            var ledBOM = calcLedBOM();
            if (ledBOM) {
                h += '<div class="led-bom-preview">';
                h += '<div style="font-size:10px;color:#999;margin-bottom:4px">Lista de Material LED (auto)</div>';
                ledBOM.items.forEach(function(it) {
                    h += '<div class="led-bom-row"><span>' + it.qty + 'x ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                });
                h += '<div class="led-bom-total"><span>Costo LED</span><strong>' + fmtD(ledBOM.totalCost) + '</strong></div>';
                h += '<div class="led-bom-total" style="border:none;padding-top:0;margin-top:0;font-size:11px"><span>Venta LED (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong>' + fmtD(ledBOM.totalCost * CONFIG.pricing.extrasMultiplier) + '</strong></div>';
                h += '</div>';
            }
            h += '</div>';
            return h;
        }

        function renderModulePaint(m) {
            var P = S.project;
            if (!m.paint)
                m.paint = {
                    enabled: false,
                    name: '',
                    pricePerLiter: 0,
                    coats: 2,
                    scope: 'doors'
                };
            var paint = m.paint;
            var h = '<div style="margin-top:8px;padding:8px;background:#1a1a2e;border-radius:8px;border:1px solid #2a2a3a">';
            h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:13px;color:#e0e0e0">&#x1f3a8; Pintura</span><button class="toggle' + (paint.enabled ? ' on' : '') + '" onclick="APP.togPaint(\'' + m.id + '\')"></button></div>';
            if (!paint.enabled) {
                h += '</div>';
                return h;
            }
            var qm = m.quoteMode || 'completo';
            h += '<div style="display:flex;flex-direction:column;gap:6px">';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:#999;min-width:60px">Nombre:</span><input type="text" value="' + (paint.name || '') + '" placeholder="Ej: Laqueado blanco" style="flex:1;font-size:12px;padding:4px 8px;background:#111;border:1px solid #3a3a3a;border-radius:4px;color:#fff" onchange="APP.setPaintName(\'' + m.id + '\',this.value)"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:#999;min-width:60px">$/Litro:</span><input type="number" value="' + paint.pricePerLiter + '" min="0" step="50" style="width:90px;font-size:12px;padding:4px 8px;background:#111;border:1px solid #3a3a3a;border-radius:4px;color:#fff" onchange="APP.setPaintPrice(\'' + m.id + '\',parseFloat(this.value))"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:#999;min-width:60px">Manos:</span><input type="number" value="' + (paint.coats || 2) + '" min="1" max="5" step="1" style="width:60px;font-size:12px;padding:4px 8px;background:#111;border:1px solid #3a3a3a;border-radius:4px;color:#fff" onchange="APP.setPaintCoats(\'' + m.id + '\',parseInt(this.value))"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:#999;min-width:60px">Alcance:</span>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'doors' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'doors\')">Puertas</button>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'structure' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'structure\')">Estructura</button>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'all' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'all\')">Todo</button>';
            h += '</div>';
            var coats = paint.coats || 2;
            var pm2 = calcPaintM2(m, {
                mode: 'custom',
                defaultHeight: P.defaultHeight,
                defaultDepth: P.defaultDepth
            });
            var liters = calcPaintLiters(pm2, coats);
            var buyLiters = Math.ceil(liters);
            var cost = liters * paint.pricePerLiter;
            h += '<div style="font-size:12px;color:#60a5fa;padding:2px 0">' + pm2.toFixed(2) + ' m\u00b2 \u00d7 ' + coats + ' manos \u00f7 10 m\u00b2/L = ' + liters.toFixed(2) + ' L &rarr; ' + fmtD(Math.round(cost)) + '</div>';
            h += '<div style="font-size:11px;color:#999;padding:1px 0">Comprar: ' + buyLiters + ' L</div>';
            if (pm2 === 0 && paint.scope === 'doors' && !m.doors && qm !== 'solo_puertas')
                h += '<div style="font-size:11px;color:#f87171">Sin puertas \u2014 0 m\u00b2</div>';
            if (pm2 === 0 && paint.scope === 'structure' && qm === 'solo_puertas')
                h += '<div style="font-size:11px;color:#f87171">Solo puertas \u2014 sin estructura</div>';
            h += '</div></div>';
            return h;
        }

        function step1() {
            var P = S.project;
            var h = '<div class="title"><h2>Nuevo Proyecto</h2><p>Informacion basica</p></div>';
            h += '<div class="field"><label>Nombre del Cliente</label><input type="text" id="client" value="' + P.client + '" placeholder="Ej: Juan Perez" oninput="APP.setClient(this.value)"></div>';
            h += '<div class="field"><label>Tipo de Proyecto</label><div class="grid2">';
            TYPES.forEach(function(t) {
                h += '<button class="type-btn' + (P.type === t.id ? ' sel' : '') + '" onclick="APP.setType(\'' + t.id + '\')"><span>' + t.i + '</span>' + t.n + '</button>';
            });
            h += '</div></div>';
            // Dual material toggle
            if (isDualType(P.type)) {
                h += '<div class="mat-toggle-row"><span>Usar mismo material para todo</span><button class="toggle' + (P.sameMaterial ? ' on' : '') + '" onclick="APP.togSameMat()"></button></div>';
            }
            // Material selection
            if (P.sameMaterial || !isDualType(P.type)) {
                h += renderMaterialSelect('Material', 'matFrentes' in P ? P.matFrentes : defaultMat(), 'APP.setMatFrentes', '');
            } else {
                h += renderMaterialSelect('Material Frentes', 'matFrentes' in P ? P.matFrentes : defaultMat(), 'APP.setMatFrentes', 'vis');
                h += renderMaterialSelect('Material Interior', 'matInterior' in P ? P.matInterior : defaultMat(), 'APP.setMatInterior', 'hid');
            }
            // Thickness
            var qqStdThicks = [16, 18, 25];
            var qqCustomThk = qqStdThicks.indexOf(P.thickness) === -1;
            h += '<div class="field"><label>Espesor Principal</label><div style="display:flex;gap:8px;flex-wrap:wrap">';
            qqStdThicks.forEach(function(t) {
                h += '<button class="thick-btn' + (P.thickness === t ? ' sel' : '') + '" onclick="APP.setThick(' + t + ')">' + t + 'mm</button>';
            });
            h += '<button class="thick-btn' + (qqCustomThk ? ' sel' : '') + '" onclick="APP.setCustomThick()">Otro</button>';
            h += '</div>';
            if (qqCustomThk) {
                h += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input type="number" value="' + P.thickness + '" min="3" max="50" step="1" style="width:80px" onchange="APP.setThick(parseInt(this.value))"><span style="color:#bbb">mm</span></div>';
            }
            h += '<p class="hint">Todas las piezas usan el espesor seleccionado</p></div>';
            // Chapacanto
            h += '<div class="field"><label>Chapacanto ($/ml)</label>';
            if (P.sameMaterial || !isDualType(P.type)) {
                h += '<input type="number" value="' + P.chapFrentesPrice + '" step="0.1" onchange="APP.setChapF(parseFloat(this.value))" style="width:120px">';
            } else {
                h += '<div style="display:flex;gap:12px;margin-bottom:8px"><div style="flex:1"><span style="font-size:12px;color:#60a5fa">Frentes</span><input type="number" value="' + P.chapFrentesPrice + '" step="0.1" onchange="APP.setChapF(parseFloat(this.value))"></div>';
                h += '<div style="flex:1"><span style="font-size:12px;color:#9ca3af">Interior</span><input type="number" value="' + P.chapInteriorPrice + '" step="0.1" onchange="APP.setChapI(parseFloat(this.value))"></div></div>';
            }
            h += '<div style="margin-top:8px"><span style="font-size:12px;color:#bbb">Especificacion del canto</span><input type="text" value="' + (P.chapSpec || '') + '" placeholder="Ej: 1mm x 19mm ABS para refilar" oninput="APP.setChapSpec(this.value)" style="margin-top:4px"></div>';
            h += '</div>';
            // Enchapado price
            h += '<div class="field"><label>Enchapado ($/ml)</label>';
            h += '<input type="number" value="' + (typeof P.enchapPrice === 'number' ? P.enchapPrice : 13) + '" step="0.5" min="0" onchange="APP.setEnchapPrice(parseFloat(this.value))" style="width:120px">';
            h += '<p class="hint">Costo por metro lineal de enchapado</p></div>';
            // Default Height
            h += '<div class="field"><label>Alto por defecto (cm)</label>';
            h += '<input type="number" value="' + P.defaultHeight + '" min="50" max="400" step="1" onchange="APP.setDefaultHeight(parseInt(this.value))" placeholder="200" style="width:120px">';
            h += '<p class="hint">Aplica a todos los modulos sin alto propio</p></div>';
            // Depth — same for all or per-module
            h += '<div class="field"><label>Profundidad</label>';
            h += '<div class="mat-toggle-row" style="margin-bottom:8px"><span>Misma profundidad para todos</span><button class="toggle' + (P.sameDepth ? ' on' : '') + '" onclick="APP.togSameDepth()"></button></div>';
            if (P.sameDepth) {
                h += '<input type="number" value="' + P.defaultDepth + '" min="20" max="100" step="1" onchange="APP.setDefaultDepth(parseInt(this.value))" placeholder="50" style="width:120px">';
                h += '<span style="font-size:12px;color:#999;margin-left:8px">cm — general para todo el proyecto</span>';
            } else {
                h += '<p class="hint">Cada modulo tendra su propia profundidad editable</p>';
            }
            h += '</div>';
            return h;
        }

        // ═══════════════════════════════════════════════════════════════
        // BLUEPRINT CANVAS v3 — Konva.js Free 2D Floor Plan Builder
        // ═══════════════════════════════════════════════════════════════

        // Category color scheme
        var BP_COLORS = {
            Bajos:    { fill: 'rgba(45,125,210,0.12)', stroke: '#2D7DD2' },
            Alacenas: { fill: 'rgba(61,204,199,0.12)', stroke: '#3DCCC7' },
            Altos:    { fill: 'rgba(61,204,199,0.12)', stroke: '#3DCCC7' },
            Torres:   { fill: 'rgba(155,93,229,0.12)', stroke: '#9B5DE5' },
            Isla:     { fill: 'rgba(247,127,0,0.12)',  stroke: '#F77F00' },
            _default: { fill: 'rgba(3,105,161,0.10)',  stroke: '#0369A1' }
        };

        function getModCatColor(type) {
            if (!MODS[type]) return BP_COLORS._default;
            var cat = MODS[type].cat || '';
            return BP_COLORS[cat] || BP_COLORS._default;
        }

        // Get effective depth for floor plan (top-down view uses depth)
        function getModDepth(m) {
            if (m.depth) return m.depth;
            if (MODS[m.type] && MODS[m.type].d && typeof MODS[m.type].d === 'number') return MODS[m.type].d;
            return S.project.defaultDepth || 50;
        }

        // Snap helper
        function snapToGrid(value, gridSize) {
            return Math.round(value / gridSize) * gridSize;
        }

        // Canvas state (persists across renders, managed outside render cycle)
        var konvaStage = null;
        var konvaZoom = 2;  // start at 200% so modules are visible
        var konvaWallMode = false;
        var konvaWalls = [];
        var konvaDrawingWall = null;

        // Undo stack — stores snapshots of {modules, walls}
        var undoStack = [];
        var UNDO_MAX = 30;

        function pushUndo() {
            var snapshot = {
                modules: JSON.parse(JSON.stringify(S.project.modules)),
                walls: JSON.parse(JSON.stringify(konvaWalls))
            };
            undoStack.push(snapshot);
            if (undoStack.length > UNDO_MAX) undoStack.shift();
        }

        function popUndo() {
            if (undoStack.length === 0) return false;
            var snap = undoStack.pop();
            S.project.modules = snap.modules;
            konvaWalls = snap.walls;
            S.bpSelectedMod = null;
            S.editedPieces = {};
            render();
            return true;
        }

        // Sort modules by canvas position (Y first, then X) and update array order
        function sortModulesByPosition() {
            S.project.modules.sort(function(a, b) {
                var ay = a.canvasY || 0, by = b.canvasY || 0;
                var ax = a.canvasX || 0, bx = b.canvasX || 0;
                if (Math.abs(ay - by) > 20) return ay - by;
                return ax - bx;
            });
        }

        // Check overlap between two rects
        function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
            return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
        }

        // Find nearest non-overlapping position
        function findFreePosition(modId, targetX, targetY, modW, modH) {
            var grid = 10;
            var P = S.project;
            var others = P.modules.filter(function(m) { return m.id !== modId; });
            // Check if target is free
            var blocked = false;
            for (var i = 0; i < others.length; i++) {
                var o = others[i];
                var ow = (o.width || 60) * PX_PER_CM;
                var oh = getModDepth(o) * PX_PER_CM;
                if (rectsOverlap(targetX, targetY, modW, modH, o.canvasX || 0, o.canvasY || 0, ow, oh)) {
                    blocked = true;
                    break;
                }
            }
            if (!blocked) return { x: targetX, y: targetY };
            // Spiral search for free spot
            for (var r = 1; r < 50; r++) {
                for (var dx = -r; dx <= r; dx++) {
                    for (var dy = -r; dy <= r; dy++) {
                        if (Math.abs(dx) !== r && Math.abs(dy) !== r) continue;
                        var nx = targetX + dx * grid;
                        var ny = targetY + dy * grid;
                        var free = true;
                        for (var j = 0; j < others.length; j++) {
                            var o2 = others[j];
                            var ow2 = (o2.width || 60) * PX_PER_CM;
                            var oh2 = getModDepth(o2) * PX_PER_CM;
                            if (rectsOverlap(nx, ny, modW, modH, o2.canvasX || 0, o2.canvasY || 0, ow2, oh2)) {
                                free = false;
                                break;
                            }
                        }
                        if (free) return { x: nx, y: ny };
                    }
                }
            }
            return { x: targetX, y: targetY }; // fallback
        }

        // ═══════════════════════════════════════════════════════════════
        // KONVA CANVAS — Main initialization (called after render)
        // ═══════════════════════════════════════════════════════════════
        function initKonvaCanvas() {
            if (typeof Konva === 'undefined') return;
            var container = document.getElementById('bp-konva-stage');
            if (!container) return;
            var cw = container.offsetWidth || 600;
            var ch = container.offsetHeight || 500;

            // Destroy previous stage
            if (konvaStage) { konvaStage.destroy(); konvaStage = null; }

            var stage = new Konva.Stage({
                container: 'bp-konva-stage',
                width: cw,
                height: ch,
                draggable: false
            });
            konvaStage = stage;

            // ── Grid layer ──
            var gridLayer = new Konva.Layer({ listening: false });
            var gridSize = 10 * PX_PER_CM; // 10cm grid cells
            var viewW = cw / konvaZoom + 400;
            var viewH = ch / konvaZoom + 400;
            var offsetX = stage.x() / konvaZoom;
            var offsetY = stage.y() / konvaZoom;
            // Dot grid
            for (var gx = 0; gx < viewW; gx += gridSize) {
                for (var gy = 0; gy < viewH; gy += gridSize) {
                    gridLayer.add(new Konva.Circle({
                        x: gx, y: gy,
                        radius: 1,
                        fill: '#CBD5E1',
                        opacity: 0.5
                    }));
                }
            }
            stage.add(gridLayer);

            // ── Wall layer ──
            var wallLayer = new Konva.Layer();
            konvaWalls.forEach(function(w) {
                var line = new Konva.Line({
                    points: [w.x1, w.y1, w.x2, w.y2],
                    stroke: '#94A3B8',
                    strokeWidth: 8,
                    lineCap: 'round',
                    hitStrokeWidth: 20
                });
                line.wallData = w;
                line.on('click tap', function(e) {
                    if (!konvaWallMode) return;
                    e.cancelBubble = true;
                    // Remove wall on click in wall mode
                    pushUndo();
                    var idx = konvaWalls.indexOf(w);
                    if (idx !== -1) konvaWalls.splice(idx, 1);
                    render();
                });
                wallLayer.add(line);
            });
            stage.add(wallLayer);

            // ── Module layer ──
            var moduleLayer = new Konva.Layer();
            var P = S.project;

            P.modules.forEach(function(m) {
                var mw = (m.width || 60) * PX_PER_CM;
                var mh = getModDepth(m) * PX_PER_CM;
                var colors = getModCatColor(m.type);
                var isSelected = S.bpSelectedMod === m.id;

                var group = new Konva.Group({
                    x: m.canvasX || 0,
                    y: m.canvasY || 0,
                    draggable: !konvaWallMode,
                    id: m.id
                });

                // Background rect
                var rect = new Konva.Rect({
                    width: mw,
                    height: mh,
                    fill: colors.fill,
                    stroke: isSelected ? colors.stroke : colors.stroke,
                    strokeWidth: isSelected ? 2.5 : 1.5,
                    cornerRadius: 2,
                    shadowColor: isSelected ? colors.stroke : 'transparent',
                    shadowBlur: isSelected ? 10 : 0,
                    shadowOpacity: 0.4
                });
                group.add(rect);

                // Module name
                var nameText = new Konva.Text({
                    text: (m.name || '').toUpperCase(),
                    width: mw,
                    align: 'center',
                    y: Math.max(2, mh / 2 - 12),
                    fontSize: Math.min(11, Math.max(7, mw / 8)),
                    fontFamily: 'JetBrains Mono, Courier New, monospace',
                    fill: '#475569',
                    listening: false
                });
                group.add(nameText);

                // Dimensions text
                var dimText = new Konva.Text({
                    text: (m.width || 60) + 'x' + getModDepth(m) + (m.height ? ' h' + m.height : ''),
                    width: mw,
                    align: 'center',
                    y: Math.max(14, mh / 2 + 2),
                    fontSize: Math.min(9, Math.max(6, mw / 10)),
                    fontFamily: 'JetBrains Mono, Courier New, monospace',
                    fill: colors.stroke,
                    opacity: 0.8,
                    listening: false
                });
                group.add(dimText);

                // Drag handle dots (top-left)
                if (mw > 20 && mh > 20) {
                    [0, 4, 8].forEach(function(dx) {
                        [0, 4].forEach(function(dy) {
                            group.add(new Konva.Circle({
                                x: 6 + dx, y: 6 + dy,
                                radius: 1,
                                fill: '#94A3B8',
                                listening: false
                            }));
                        });
                    });
                }

                // Events
                group.on('click tap', function(e) {
                    e.cancelBubble = true;
                    S.bpSelectedMod = m.id;
                    S.editedPieces = {};
                    render();
                });

                group.on('dragstart', function() {
                    group.moveToTop();
                    rect.opacity(0.6);
                    moduleLayer.batchDraw();
                });

                group.on('dragmove', function() {
                    // Show snap preview
                    var pos = group.position();
                    var snappedX = snapToGrid(pos.x, 10);
                    var snappedY = snapToGrid(pos.y, 10);
                    // Visual feedback: slight snap feel
                    if (Math.abs(pos.x - snappedX) < 3 && Math.abs(pos.y - snappedY) < 3) {
                        group.position({ x: snappedX, y: snappedY });
                    }
                });

                group.on('dragend', function() {
                    pushUndo();
                    rect.opacity(1);
                    var pos = group.position();
                    var snappedX = snapToGrid(pos.x, 10);
                    var snappedY = snapToGrid(pos.y, 10);
                    // Overlap prevention
                    var freePos = findFreePosition(m.id, snappedX, snappedY, mw, mh);
                    m.canvasX = freePos.x;
                    m.canvasY = freePos.y;
                    // Sort and sync
                    sortModulesByPosition();
                    S.bpSelectedMod = m.id;
                    S.editedPieces = {};
                    render();
                });

                moduleLayer.add(group);
            });
            stage.add(moduleLayer);

            // Apply zoom
            stage.scale({ x: konvaZoom, y: konvaZoom });

            // ── Stage click: deselect or wall drawing ──
            stage.on('click tap', function(e) {
                if (e.target === stage || e.target.parent === gridLayer) {
                    if (konvaWallMode && konvaDrawingWall) return;
                    S.bpSelectedMod = null;
                    render();
                }
            });

            // ── Wall drawing ──
            stage.on('mousedown touchstart', function(e) {
                if (!konvaWallMode) return;
                if (e.target !== stage && e.target.parent !== gridLayer && e.target.parent !== wallLayer) return;
                var pos = stage.getRelativePointerPosition();
                if (!pos) return;
                konvaDrawingWall = {
                    x1: snapToGrid(pos.x, 10),
                    y1: snapToGrid(pos.y, 10),
                    x2: snapToGrid(pos.x, 10),
                    y2: snapToGrid(pos.y, 10)
                };
            });
            stage.on('mousemove touchmove', function() {
                if (!konvaDrawingWall) return;
                var pos = stage.getRelativePointerPosition();
                if (!pos) return;
                konvaDrawingWall.x2 = snapToGrid(pos.x, 10);
                konvaDrawingWall.y2 = snapToGrid(pos.y, 10);
                // Draw temp wall line
                wallLayer.find('.tempWall').forEach(function(n) { n.destroy(); });
                var tempLine = new Konva.Line({
                    points: [konvaDrawingWall.x1, konvaDrawingWall.y1, konvaDrawingWall.x2, konvaDrawingWall.y2],
                    stroke: '#94A3B8',
                    strokeWidth: 8,
                    lineCap: 'round',
                    opacity: 0.5,
                    name: 'tempWall'
                });
                wallLayer.add(tempLine);
                wallLayer.batchDraw();
            });
            stage.on('mouseup touchend', function() {
                if (!konvaDrawingWall) return;
                var w = konvaDrawingWall;
                konvaDrawingWall = null;
                wallLayer.find('.tempWall').forEach(function(n) { n.destroy(); });
                // Only add if wall has some length
                var len = Math.sqrt(Math.pow(w.x2 - w.x1, 2) + Math.pow(w.y2 - w.y1, 2));
                if (len > 15) {
                    pushUndo();
                    konvaWalls.push(w);
                    var newLine = new Konva.Line({
                        points: [w.x1, w.y1, w.x2, w.y2],
                        stroke: '#94A3B8',
                        strokeWidth: 8,
                        lineCap: 'round',
                        hitStrokeWidth: 20
                    });
                    wallLayer.add(newLine);
                }
                wallLayer.batchDraw();
            });

            // ── Pan (when not in wall mode, drag on empty space) ──
            var isPanning = false;
            var panStart = { x: 0, y: 0 };
            var stageStart = { x: 0, y: 0 };

            container.addEventListener('mousedown', function(e) {
                if (konvaWallMode) return;
                if (e.target.tagName === 'CANVAS' && !e.target.closest('.konva-node')) {
                    // Check if we hit an empty area
                    var shape = stage.getIntersection(stage.getPointerPosition());
                    if (!shape || shape.parent === gridLayer) {
                        isPanning = true;
                        panStart = { x: e.clientX, y: e.clientY };
                        stageStart = { x: stage.x(), y: stage.y() };
                        container.classList.add('panning');
                    }
                }
            });
            window.addEventListener('mousemove', function(e) {
                if (!isPanning) return;
                var dx = e.clientX - panStart.x;
                var dy = e.clientY - panStart.y;
                stage.position({ x: stageStart.x + dx, y: stageStart.y + dy });
                stage.batchDraw();
            });
            window.addEventListener('mouseup', function() {
                isPanning = false;
                container.classList.remove('panning');
            });

            // ── Touch pan (two fingers) ──
            var lastTouchDist = 0;
            var lastTouchCenter = null;
            container.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    var t = e.touches;
                    lastTouchDist = Math.sqrt(Math.pow(t[0].clientX - t[1].clientX, 2) + Math.pow(t[0].clientY - t[1].clientY, 2));
                    lastTouchCenter = { x: (t[0].clientX + t[1].clientX) / 2, y: (t[0].clientY + t[1].clientY) / 2 };
                    stageStart = { x: stage.x(), y: stage.y() };
                }
            }, { passive: false });
            container.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    var t = e.touches;
                    var dist = Math.sqrt(Math.pow(t[0].clientX - t[1].clientX, 2) + Math.pow(t[0].clientY - t[1].clientY, 2));
                    var center = { x: (t[0].clientX + t[1].clientX) / 2, y: (t[0].clientY + t[1].clientY) / 2 };
                    // Pinch zoom
                    var scale = dist / lastTouchDist;
                    var newZoom = Math.max(0.5, Math.min(5, konvaZoom * scale));
                    konvaZoom = newZoom;
                    stage.scale({ x: newZoom, y: newZoom });
                    // Pan with center
                    if (lastTouchCenter) {
                        var dx = center.x - lastTouchCenter.x;
                        var dy = center.y - lastTouchCenter.y;
                        stage.position({ x: stage.x() + dx, y: stage.y() + dy });
                    }
                    lastTouchDist = dist;
                    lastTouchCenter = center;
                    stage.batchDraw();
                    updateZoomLabel();
                }
            }, { passive: false });

            // ── Mouse wheel zoom ──
            container.addEventListener('wheel', function(e) {
                e.preventDefault();
                var delta = e.deltaY > 0 ? -0.1 : 0.1;
                konvaZoom = Math.max(0.5, Math.min(5, konvaZoom + delta));
                stage.scale({ x: konvaZoom, y: konvaZoom });
                stage.batchDraw();
                updateZoomLabel();
            }, { passive: false });

            // ── Delete key for selected module ──
            function handleKeyDown(e) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) return;
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    APP.bpUndo();
                    return;
                }
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    if (S.bpSelectedMod) {
                        APP.delMod(S.bpSelectedMod);
                    }
                }
            }
            document.addEventListener('keydown', handleKeyDown);
            // Store cleanup ref
            stage._cleanupKeyHandler = handleKeyDown;

            // Update zoom label
            updateZoomLabel();

            // ── Responsive resize ──
            function handleResize() {
                if (!container.parentElement) return;
                var newW = container.offsetWidth;
                var newH = container.offsetHeight;
                if (newW > 0 && newH > 0) {
                    stage.width(newW);
                    stage.height(newH);
                    stage.batchDraw();
                }
            }
            window.addEventListener('resize', handleResize);
            stage._cleanupResize = handleResize;
        }

        function updateZoomLabel() {
            var el = document.getElementById('bp-zoom-label');
            if (el) el.textContent = Math.round(konvaZoom * 100) + '%';
        }

        // Helper: render module config controls for selected module
        function renderModConfig(m) {
            var P = S.project;
            var idx = P.modules.indexOf(m);
            var h = '';
            h += '<div class="bp-config-title"><span class="bp-config-num">' + (idx + 1) + '</span><strong>' + m.name + '</strong><button class="module-del" onclick="APP.delMod(\'' + m.id + '\')" style="margin-left:auto">' + svg('trash') + '</button></div>';
            // Width selector row — free input for all modules
            h += '<div class="module-row"><span>Ancho:</span><div style="display:flex;align-items:center;gap:6px">';
            h += '<input type="number" value="' + m.width + '" min="10" max="300" step="1" style="width:72px;padding:5px;background:var(--color-surface-3);border:1px solid var(--color-border);border-radius:var(--radius-md);color:var(--color-text-primary);text-align:center;font-size:13px;font-family:var(--font-mono)" onchange="APP.setModW(\'' + m.id + '\',parseInt(this.value))">';
            h += '<span style="font-size:11px;color:var(--color-text-tertiary)">cm</span>';
            h += '</div></div>';
            // Compact inline dimensions: Alto + Prof
            h += '<div class="dim-row">';
            h += '<div class="dim-group"><label>Alto</label><input type="number" value="' + (m.height || '') + '" placeholder="' + (P.defaultHeight || 200) + '" onchange="APP.setModH(\'' + m.id + '\',this.value?parseInt(this.value):0)"><span style="font-size:11px;color:#666">cm</span></div>';
            if (!P.sameDepth) {
                h += '<div class="dim-group"><label>Prof.</label><input type="number" value="' + (m.depth || P.defaultDepth || 50) + '" min="20" max="120" step="1" onchange="APP.setModDepth(\'' + m.id + '\',parseInt(this.value))"><span style="font-size:11px;color:#666">cm</span></div>';
            }
            h += '</div>';
            if (m.type === 'modulo') {
                var mcaj = typeof m.cajones === 'number' ? m.cajones : 4;
                h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [0, 1, 2, 3, 4, 5, 6].forEach(function(n) {
                    h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                });
                h += '</div></div>';
                if (mcaj === 0) {
                    var msh = typeof m.shelves === 'number' ? m.shelves : 3;
                    h += '<div class="module-row"><span>Estantes:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                    [0, 1, 2, 3, 4, 5, 6, 7].forEach(function(n) {
                        h += '<button class="opt-btn' + (msh === n ? ' sel' : '') + '" onclick="APP.setModS(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                    });
                    h += '</div></div>';
                }
                if (mcaj > 0) {
                    h += '<div class="module-row"><span>Corredera:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                    [{ k: 'corr_eco', l: 'Ecoline' }, { k: 'corr_prem', l: 'Premium' }, { k: 'corr_oculta', l: 'TDM Oculta' }].forEach(function(tier) {
                        var sel = (m.corrTier || 'corr_eco') === tier.k ? ' sel' : '';
                        h += '<button class="opt-btn' + sel + '" onclick="APP.setModCorr(\'' + m.id + '\',\'' + tier.k + '\')">' + tier.l + '</button>';
                    });
                    h += '</div></div>';
                }
            }
            if (m.type === 'entrepa' || m.type === 'torreLateral' || m.type === 'lateralAbierto' || m.type === 'despensa') {
                h += '<div class="module-row"><span>Estantes:</span><div style="display:flex;gap:8px">';
                [2, 3, 4, 5, 6, 7].forEach(function(n) {
                    h += '<button class="opt-btn' + ((m.shelves || 3) === n ? ' sel' : '') + '" onclick="APP.setModS(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'cajonBase') {
                var mcaj = typeof m.cajones === 'number' ? m.cajones : 3;
                h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [1, 2, 3, 4, 5].forEach(function(n) {
                    h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'cajonera') {
                var mcaj = typeof m.cajones === 'number' ? m.cajones : 3;
                h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [2, 3, 4].forEach(function(n) {
                    h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'bajoLavabo') {
                var mcaj = typeof m.cajones === 'number' ? m.cajones : 2;
                h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [1, 2].forEach(function(n) {
                    h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'cajoneraBano') {
                var mcaj = typeof m.cajones === 'number' ? m.cajones : 2;
                h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [2, 3].forEach(function(n) {
                    h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'alacenaAventos') {
                var aventosM = m.aventosModel || 'hk';
                h += '<div class="module-row"><span>Aventos:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [['hk', 'HK-S'], ['hl', 'HL'], ['hs', 'HS']].forEach(function(opt) {
                    h += '<button class="opt-btn' + (aventosM === opt[0] ? ' sel' : '') + '" onclick="APP.setModAventos(\'' + m.id + '\',\'' + opt[0] + '\')">' + opt[1] + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'alacenaEstandar' || m.type === 'alacenaSobreCampana') {
                var entCnt = typeof m.shelves === 'number' ? m.shelves : 1;
                h += '<div class="module-row"><span>Entrepa\u00f1os:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [0, 1, 2, 3].forEach(function(n) {
                    h += '<button class="opt-btn' + (entCnt === n ? ' sel' : '') + '" onclick="APP.setModShelves(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'torreDespensa') {
                var entCnt = typeof m.shelves === 'number' ? m.shelves : 4;
                h += '<div class="module-row"><span>Entrepa\u00f1os:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [2, 3, 4, 5, 6].forEach(function(n) {
                    h += '<button class="opt-btn' + (entCnt === n ? ' sel' : '') + '" onclick="APP.setModShelves(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'esquineroGiratorio') {
                h += '<div class="module-row"><span>Ancho 2:</span><input type="number" value="' + (m.width2 || m.width) + '" min="30" max="120" step="10" style="width:80px;padding:6px;background:#3a3a3a;border:none;border-radius:8px;color:#fff;text-align:center" onchange="APP.setModW2(\'' + m.id + '\',parseInt(this.value))"><span style="font-size:12px;color:#999;margin-left:4px">cm (segundo lado)</span></div>';
            }
            if (m.type === 'puerta') {
                var relleno = m.relleno || 'honeycomb';
                h += '<div class="module-row"><span>Relleno:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [['honeycomb', 'Honey-comb (ligera)'], ['peinazos', 'Peinazos pino'], ['solida', 'Solida (pesada)']].forEach(function(r) {
                    h += '<button class="opt-btn' + (relleno === r[0] ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'relleno\',\'' + r[0] + '\')">' + r[1] + '</button>';
                });
                h += '</div></div>';
                var bisHint = relleno === 'solida' ? '4 bisagras (puerta pesada)' : '3 bisagras';
                h += '<div style="font-size:11px;color:#888;margin:2px 0 4px 0">Bisagras: ' + bisHint + '</div>';
                h += '<div class="module-row"><span>Marco:</span><button class="opt-btn' + (m.marco !== false ? ' sel' : '') + '" onclick="APP.togModProp(\'' + m.id + '\',\'marco\')">' + svg(m.marco !== false ? 'check' : 'plus') + ' Con marco chambrana</button></div>';
            }
            if (m.type === 'cubierta') {
                var cubT = m.cubiertaType || 'postformado';
                h += '<div class="module-row"><span>Tipo:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [['postformado', 'Postformado'], ['cuarzo', 'Cuarzo'], ['granito', 'Granito']].forEach(function(opt) {
                    h += '<button class="opt-btn' + (cubT === opt[0] ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'cubiertaType\',\'' + opt[0] + '\')">' + opt[1] + '</button>';
                });
                h += '</div></div>';
            }
            if (m.type === 'zoclo') {
                var bajoTypes = ['bajoEstandar', 'fregadero', 'cajonera', 'esquineroCiego', 'hornoBase'];
                var totalBW = 0;
                S.project.modules.forEach(function(x) {
                    if (bajoTypes.indexOf(x.type) !== -1) totalBW += (x.width || 60) * (x.quantity || 1);
                });
                if (totalBW > 0) {
                    h += '<div style="font-size:11px;color:#999;margin:2px 0 4px">Total bajos: ' + totalBW + ' cm (auto-calculado)</div>';
                }
            }
            // Quote mode + door toggles
            if (m.type !== 'puerta' && m.type !== 'zoclo' && m.type !== 'vistaLateral' && m.type !== 'panelRelleno' && m.type !== 'cubierta') {
                var qmC = m.quoteMode || 'completo';
                h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">';
                h += '<button class="opt-btn' + (qmC === 'completo' ? ' sel' : '') + '" onclick="APP.setQuoteMode(\'' + m.id + '\',\'completo\')">Completo</button>';
                h += '<button class="opt-btn' + (qmC === 'solo_puertas' ? ' sel' : '') + '" style="' + (qmC === 'solo_puertas' ? 'background:#fbbf24;color:#1a1a1a;border-color:#fbbf24' : '') + '" onclick="APP.setQuoteMode(\'' + m.id + '\',\'solo_puertas\')">Solo puertas</button>';
                h += '</div>';
                if (qmC === 'solo_puertas') {
                    h += '<div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:6px;padding:6px 10px;margin-bottom:6px;font-size:12px;color:#fbbf24">Solo puertas: la estructura no se cotiza</div>';
                }
                h += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
                if (qmC !== 'solo_puertas') {
                    h += '<button class="opt-btn' + (m.doors ? ' sel' : '') + '" onclick="APP.togDoor(\'' + m.id + '\')">' + svg(m.doors ? 'check' : 'plus') + ' Puertas</button>';
                    if (m.doors)
                        h += '<button class="opt-btn' + (m.tipon ? ' sel' : '') + '" onclick="APP.togTipon(\'' + m.id + '\')">' + svg(m.tipon ? 'check' : 'plus') + ' Tip-On</button>';
                } else {
                    h += '<button class="opt-btn' + (m.tipon ? ' sel' : '') + '" onclick="APP.togTipon(\'' + m.id + '\')">' + svg(m.tipon ? 'check' : 'plus') + ' Tip-On</button>';
                }
                h += '</div>';
            }
            h += renderModuleLed(m);
            h += renderModulePaint(m);
            // Warnings
            if (m.type === 'hornoBase' || m.type === 'torreHornos') {
                h += '<div class="module-row"><span>Ventilacion:</span><button class="opt-btn' + (m.ventilacion !== false ? ' sel' : '') + '" onclick="APP.togModProp(\'' + m.id + '\',\'ventilacion\')">' + svg(m.ventilacion !== false ? 'check' : 'plus') + ' Saque trasero 100mm</button></div>';
                if (m.ventilacion === false) {
                    h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:#facc15">\u26a0 Horno sin ventilacion trasera \u2014 riesgo de sobrecalentamiento</div>';
                }
            }
            if (m.type === 'repisaFlotante') {
                var repVariant = m.variant || 'hueca';
                h += '<div class="module-row"><span>Tipo de Repisa:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                [['hueca', 'Caja hueca'], ['herraje', 'Herraje oculto']].forEach(function(opt) {
                    h += '<button class="opt-btn' + (repVariant === opt[0] ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'variant\',\'' + opt[0] + '\')">' + opt[1] + '</button>';
                });
                h += '</div></div>';
                if (repVariant === 'herraje') {
                    h += '<div style="background:rgba(196,154,108,0.1);border:1px solid rgba(196,154,108,0.3);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:#c49a6c">Minimo 38mm de grosor para herraje oculto (espigon de metal)</div>';
                }
            }
            if (m.type === 'torreLateralTV') {
                h += '<div class="module-row"><span>Configuracion:</span><button class="opt-btn' + (m.noPuertas ? ' sel' : '') + '" onclick="APP.togModProp(\'' + m.id + '\',\'noPuertas\')">' + svg(m.noPuertas ? 'check' : 'plus') + ' Sin puerta (nichos abiertos)</button></div>';
            }
            if (m.type === 'fregadero' || m.type === 'bajoLavabo' || m.type === 'cajoneraBano' || m.type === 'botiquin') {
                var matI = P.matInterior || {};
                var matF = P.matFrentes || {};
                var matIName = (matI.name || '').toUpperCase();
                var matFName = (matF.name || '').toUpperCase();
                var isRH = (matIName.indexOf('RH') !== -1 || matIName.indexOf('RESISTENTE') !== -1)
                        && (matFName.indexOf('RH') !== -1 || matFName.indexOf('RESISTENTE') !== -1);
                if (!isRH) {
                    h += '<div style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:#ef4444">\uD83D\uDD34 Zona humeda \u2014 usar MDF RH (Resistente a Humedad) obligatorio. Material actual no es MDF-RH.</div>';
                }
            }
            if (MODS[m.type] && MODS[m.type].forType && MODS[m.type].forType.indexOf('closet') !== -1 && m.height > 150) {
                h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:#facc15">\u26a0 Anti-vuelco: modulo > 1,500mm de alto. Anclar a pared con taquetes obligatorio.</div>';
            }
            // Width is always free-form — no standard width warning needed
            h += '<p class="module-desc">' + MODS[m.type].d + '</p>';
            return h;
        }

        // CUSTOMIZE: Module type buttons — controls which module types appear in the add-module panel
        function step2() {
            var P = S.project;
            var typeObj = TYPES.find(function(t) { return t.id === P.type; });
            var typeName = typeObj ? typeObj.i + ' ' + typeObj.n : 'Proyecto';
            var h = '<div class="title"><h2>' + typeName + '</h2><p>Configurar modulos del proyecto</p></div>';

            // Filter modules by project type using forType field
            var filteredKeys = [];
            for (var k in MODS) {
                var modDef = MODS[k];
                if (modDef.forType) {
                    if (modDef.forType.indexOf(P.type) !== -1) filteredKeys.push(k);
                } else {
                    if (!P.type || P.type === 'otro') filteredKeys.push(k);
                }
            }
            // Group filtered modules by cat field
            var groups = {};
            var groupOrder = [];
            filteredKeys.forEach(function(fk) {
                var c = MODS[fk].cat || '';
                if (!groups[c]) { groups[c] = []; groupOrder.push(c); }
                groups[c].push(fk);
            });
            var activeTab = S.modCatTab;
            if (!activeTab || groupOrder.indexOf(activeTab) === -1) activeTab = groupOrder[0] || '';

            // ── Layout: Palette (left) + Canvas (right) ──
            h += '<div class="bp-layout">';

            // ── Module palette sidebar ──
            h += '<div class="bp-palette">';
            if (groupOrder.length > 1) {
                h += '<div class="cat-tabs" style="width:100%;margin-bottom:4px">';
                groupOrder.forEach(function(gName) {
                    var label = gName || 'General';
                    h += '<button class="cat-tab' + (activeTab === gName ? ' sel' : '') + '" onclick="APP.setModCatTab(\'' + gName + '\')" style="font-size:11px;padding:4px 8px">' + label + '</button>';
                });
                h += '</div>';
            }
            var activeMods = groups[activeTab] || filteredKeys;
            activeMods.forEach(function(mk) {
                var colors = getModCatColor(mk);
                var tip = (MODS[mk].d || '') + (MODS[mk].w ? ' | Anchos: ' + MODS[mk].w.join(', ') + 'cm' : '');
                h += '<button class="bp-palette-tile" title="' + tip + '" onclick="APP.addMod(\'' + mk + '\')">';
                h += '<span class="tile-cat-dot" style="background:' + colors.stroke + '"></span>';
                h += '<span>' + MODS[mk].n + '</span>';
                h += '</button>';
            });
            h += '</div>';

            // ── Canvas area ──
            h += '<div class="bp-canvas-wrap">';

            // Toolbar
            h += '<div class="bp-toolbar">';
            h += '<button class="bp-toolbar-btn" onclick="APP.bpZoomIn()" title="Acercar">+</button>';
            h += '<span class="bp-zoom-label" id="bp-zoom-label">' + Math.round(konvaZoom * 100) + '%</span>';
            h += '<button class="bp-toolbar-btn" onclick="APP.bpZoomOut()" title="Alejar">&minus;</button>';
            h += '<div class="bp-toolbar-sep"></div>';
            h += '<button class="bp-toolbar-btn" onclick="APP.bpUndo()" title="Deshacer (Ctrl+Z)"' + (undoStack.length === 0 ? ' disabled style="opacity:0.4;cursor:default"' : '') + '>&#8630; Deshacer</button>';
            h += '<div class="bp-toolbar-sep"></div>';
            h += '<button class="bp-toolbar-btn' + (konvaWallMode ? ' active' : '') + '" onclick="APP.bpToggleWall()" title="Dibujar pared">Pared</button>';
            h += '<button class="bp-toolbar-btn" onclick="APP.bpCenterView()" title="Centrar vista">Centrar</button>';
            h += '<div class="bp-toolbar-sep"></div>';
            h += '<button class="bp-toolbar-btn" onclick="APP.bpClearCanvas()" title="Limpiar todo" style="color:var(--color-danger)">Limpiar</button>';
            h += '</div>';

            // Konva container
            h += '<div class="bp-konva-container' + (konvaWallMode ? ' wall-mode' : '') + '" id="bp-konva-stage"></div>';

            // Scale indicator
            h += '<div class="bp-scale-indicator"><span class="bp-scale-bar" style="width:' + Math.round(100 * PX_PER_CM * konvaZoom) + 'px"></span> 100cm</div>';

            // Total width bar
            if (P.modules.length > 0) {
                var tw = P.modules.reduce(function(a, m) { return a + m.width; }, 0);
                h += '<div class="bp-total-bar"><span>Ancho Total</span><strong>' + tw + ' cm</strong></div>';
            }

            // ── Config panel for selected module ──
            h += '<div class="bp-config">';
            var selMod = S.bpSelectedMod ? P.modules.find(function(m) { return m.id === S.bpSelectedMod; }) : null;
            if (selMod) {
                h += renderModConfig(selMod);
            } else {
                h += '<div class="bp-no-sel">Selecciona un modulo en el canvas para configurar</div>';
            }
            h += '</div>';

            h += '</div>'; // bp-canvas-wrap
            h += '</div>'; // bp-layout

            // Hardware section
            h += '<div class="hw-selected"><h4>' + svg('settings') + ' Herrajes <span style="font-size:12px;color:#999;font-weight:400">(auto + manual)</span></h4>';
            var c = P.modules.length > 0 ? calc() : null;
            if (c) {
                for (var k in c.hwConsolidated) {
                    var hw = c.hwConsolidated[k];
                    h += '<div class="hw-sel-item"><span class="hw-sel-marca ' + marcaClass(hw.marca) + '">' + hw.marca + '</span><span class="hw-sel-name">' + hw.desc + '</span><span style="color:#999;font-size:12px">x' + Math.ceil(hw.qty) + '</span><span class="hw-sel-price">' + fmtD(Math.ceil(hw.qty) * hw.price) + '</span></div>';
                }
            }
            if (P.hardware.length > 0) {
                P.hardware.forEach(function(h2, idx) {
                    h += '<div class="hw-sel-item"><span class="hw-sel-marca ' + marcaClass(h2.marca) + '">' + h2.marca + '</span><span class="hw-sel-name">' + h2.descripcion + '</span>';
                    h += '<div class="hw-sel-qty"><button onclick="APP.hwQty(' + idx + ',-1)">-</button><strong>' + h2.qty + '</strong><button onclick="APP.hwQty(' + idx + ',1)">+</button></div>';
                    h += '<span class="hw-sel-price">' + fmtD(h2.qty * adjPrice(h2)) + '</span></div>';
                });
            }
            h += '<button class="hw-add-btn" onclick="APP.openHWPicker()">' + svg('plus') + ' Agregar herraje del catalogo</button>';
            h += '</div>';
            // Extras
            h += '<div class="extra-section"><label style="font-size:14px;color:#ffffff;display:block;margin-bottom:12px">Extras</label>';
            h += '<div class="extra-row"><div style="display:flex;align-items:center">' + svg('layers') + ' Vidrio Templado</div><button class="toggle' + (P.glass ? ' on' : '') + '" onclick="APP.togGlass()"></button></div>';
            if (P.glass)
                h += '<div class="extra-input"><span>Metros2 vidrio:</span><input type="number" value="' + P.glassM2 + '" min="0" step="0.1" onchange="APP.setGlassM2(parseFloat(this.value))"></div>';
            h += '</div>';
            return h;
        }

        function step3(c) {
            var P = S.project;
            var h = '<div class="title"><h2>Resumen de Costeo</h2><p>Carpinter\u00eda x' + CONFIG.pricing.carpentryMultiplier + ' | Herrajes premium ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%</p></div>';

            // ── Command Center Grid (Top Section) ──
            h += '<div class="bento-grid">';

            // Carpinteria card
            h += '<div class="card"><div class="card-title">' + svg('layers') + ' Carpinteria</div>';
            if (c.totalSheetsF > 0) {
                h += '<div class="cost-row"><span>Material Frentes (' + c.totalSheetsF + ' hojas)</span><strong>' + fmt(c.matCostF) + '</strong></div>';
            }
            if (c.useDual && c.totalSheetsI > 0) {
                h += '<div class="cost-row"><span>Material Interior (' + c.totalSheetsI + ' hojas)</span><strong>' + fmt(c.matCostI) + '</strong></div>';
            }
            if (c.cantoF > 0)
                h += '<div class="cost-row"><span>Chapacanto' + (c.useDual ? ' Frentes' : '') + ' (' + c.cantoF + ' ml)</span><strong>' + fmt(c.chapCostF) + '</strong></div>';
            if (c.useDual && c.cantoI > 0)
                h += '<div class="cost-row"><span>Chapacanto Interior (' + c.cantoI + ' ml)</span><strong>' + fmt(c.chapCostI) + '</strong></div>';
            h += '<div class="cost-row"><span>Corte (' + c.totalSheets + ' hojas x $75)</span><strong>' + fmt(c.corteCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Enchapado (' + c.totalCanto + ' ml x $' + (typeof P.enchapPrice === 'number' ? P.enchapPrice : 13) + ')</span><strong>' + fmt(c.enchapCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Mano de obra</span><strong>' + fmt(P.laborCost) + '</strong></div>';
            if (P.freight)
                h += '<div class="cost-row"><span>Flete</span><strong>' + fmt(P.freightCost) + '</strong></div>';
            h += '<div class="cost-total"><span>Costo Carpinteria</span><strong>' + fmt(c.carpCost) + '</strong></div>';
            h += '<div class="cost-row" style="margin-top:4px"><span>Venta (carp + hw std) x' + CONFIG.pricing.carpentryMultiplier + '</span><strong style="color:#ffffff">' + fmt(c.carpSale) + '</strong></div></div>';

            // Labor config card with pill presets
            h += '<div class="card"><div class="card-title">' + svg('users') + ' Mano de Obra</div>';
            h += '<div style="margin-bottom:12px"><span style="font-size:13px;color:#bbb">Costo:</span>';
            h += '<div class="labor-input"><span>$</span><input type="number" value="' + P.laborCost + '" min="0" step="500" onchange="APP.setLabor(parseFloat(this.value))"></div>';
            h += '<div class="labor-pills">';
            [{l:'$3k',v:3000},{l:'$5k',v:5000},{l:'$8k',v:8000},{l:'$12k',v:12000},{l:'$15k',v:15000}].forEach(function(p) {
                h += '<button class="labor-pill' + (P.laborCost === p.v ? ' sel' : '') + '" onclick="APP.setLabor(' + p.v + ')">' + p.l + '</button>';
            });
            h += '</div></div>';
            h += '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px"><span style="color:#bbb">Flete:</span>';
            if (P.freight)
                h += '<div class="labor-input" style="flex:1;max-width:120px"><span>$</span><input type="number" value="' + P.freightCost + '" min="0" step="100" onchange="APP.setFreightCost(parseFloat(this.value))"></div>';
            h += '<button class="toggle' + (P.freight ? ' on' : '') + '" onclick="APP.togFreight()"></button></div></div>';

            // Herrajes card — carpentry bucket
            if (c.hwCostCarpBucket > 0) {
                h += '<div class="card"><div class="card-title">' + svg('settings') + ' Herrajes (en carp. x' + CONFIG.pricing.carpentryMultiplier + ')</div>';
                h += '<div style="font-size:11px;color:#999;margin-bottom:6px">\u2264 $' + CONFIG.pricing.hardwareThreshold + '</div>';
                c.allHW.forEach(function(hw) {
                    if (hw._bucket !== 'carp') return;
                    h += '<div class="cost-row"><span class="' + marcaClass(hw.marca) + '">' + hw.desc + ' x' + Math.ceil(hw.qty) + '</span><strong>' + fmtD(Math.ceil(hw.qty) * hw.price) + '</strong></div>';
                });
                h += '<div class="cost-total"><span>Subtotal herrajes (en carp.)</span><strong>' + fmt(c.hwCostCarpBucket) + '</strong></div></div>';
            }

            // Premium hardware card
            if (c.hwCostPremium > 0) {
                h += '<div class="card"><div class="card-title">' + svg('lock') + ' Herrajes Premium <span style="font-size:11px;color:#999;font-weight:400">' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%</span></div>';
                h += '<div style="font-size:11px;color:#999;margin-bottom:6px">> $' + CONFIG.pricing.hardwareThreshold + '</div>';
                c.allHW.forEach(function(hw) {
                    if (hw._bucket !== 'premium') return;
                    h += '<div class="cost-row"><span class="' + marcaClass(hw.marca) + '">' + hw.desc + ' x' + Math.ceil(hw.qty) + '</span><strong>' + fmtD(Math.ceil(hw.qty) * hw.price) + '</strong></div>';
                });
                h += '<div class="cost-total"><span>Costo Premium</span><strong>' + fmt(c.hwCostPremium) + '</strong></div>';
                h += '<div class="cost-row" style="margin-top:4px"><span>Venta (' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong style="color:#ffffff">' + fmt(c.hwPremiumSale) + '</strong></div></div>';
            }

            // Extras card (spans full width if present)
            if (c.extraCost > 0) {
                h += '<div class="card span-2"><div class="card-title">' + svg('zap') + ' Extras (x' + CONFIG.pricing.extrasMultiplier + ')</div>';
                if (c.ledBOM) {
                    h += '<div style="font-size:12px;color:#fbbf24;font-weight:600;margin-bottom:4px">LED (' + c.ledBOM.totalMeters.toFixed(1) + 'm | ' + c.ledBOM.totalSegments + ' seg | ' + c.ledBOM.alimentadorW + 'W)</div>';
                    c.ledBOM.items.forEach(function(it) {
                        h += '<div class="cost-row"><span style="font-size:12px">' + it.qty + 'x ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                    });
                    h += '<div class="cost-row" style="border-top:1px solid #3a3a3a;padding-top:4px;margin-top:4px"><span style="color:#fbbf24">Subtotal LED</span><strong style="color:#fbbf24">' + fmtD(c.ledBOM.totalCost) + '</strong></div>';
                }
                if (c.cubiertaCost > 0)
                    h += '<div class="cost-row"><span>Cubierta (' + (c.cubiertaM2 || 0).toFixed(2) + ' m\u00b2)</span><strong>' + fmt(c.cubiertaCost) + '</strong></div>';
                if (P.glass)
                    h += '<div class="cost-row"><span>Vidrio (' + P.glassM2 + 'm2)</span><strong>' + fmt(P.glassM2 * CONFIG.pricing.glassCostPerM2) + '</strong></div>';
                if (c.paintCost > 0) {
                    P.modules.forEach(function(m2, mi2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'custom',
                                defaultHeight: P.defaultHeight,
                                defaultDepth: P.defaultDepth
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                h += '<div class="cost-row"><span>Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' ' + m2.name + ' (' + lit.toFixed(1) + 'L)</span><strong>' + fmtD(Math.round(lit * m2.paint.pricePerLiter)) + '</strong></div>';
                        }
                    });
                }
                h += '<div class="cost-total"><span>Costo Extras</span><strong>' + fmt(c.extraCost) + '</strong></div>';
                h += '<div class="cost-row" style="margin-top:4px"><span>Venta (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong style="color:#ffffff">' + fmt(c.extrasSale) + '</strong></div></div>';
            }

            // Subtotales por Categoria (cocina only) — spans full width
            if (P.type === 'cocina') {
                h += '<div class="card span-2"><div class="card-title">' + svg('layers') + ' Subtotales por Categoria</div>';
                h += '<div class="cost-row"><span>Casco (material interior + canto)</span><strong>' + fmt(c.cascoCost) + '</strong></div>';
                h += '<div class="cost-row"><span>Frente (material visible + canto)</span><strong>' + fmt(c.frenteCost) + '</strong></div>';
                h += '<div class="cost-row"><span>Herrajes (std + premium)</span><strong>' + fmt(c.herrajesCost) + '</strong></div>';
                if (c.extrasCost > 0)
                    h += '<div class="cost-row"><span>Extras (LED, vidrio, cubierta, pintura)</span><strong>' + fmt(c.extrasCost) + '</strong></div>';
                h += '</div>';
            }

            h += '</div>'; // close bento-grid

            // ── Profit Engine Hero Card ──
            h += '<div class="profit-hero">';
            h += '<div class="hero-label">Resumen de Venta</div>';
            h += '<div class="hero-row"><span>Carpinter\u00eda (incl. herrajes std)</span><strong>' + fmt(c.carpSale) + '</strong></div>';
            if (c.hwCostPremium > 0)
                h += '<div class="hero-row"><span>Herrajes Premium</span><strong>' + fmt(c.hwPremiumSale) + '</strong></div>';
            if (c.extrasSale > 0)
                h += '<div class="hero-row"><span>Extras</span><strong>' + fmt(c.extrasSale) + '</strong></div>';
            h += '<div class="hero-row" style="padding-top:6px;border-top:1px solid rgba(255,255,255,0.08)"><span>SUBTOTAL</span><strong style="color:var(--color-text-primary)">' + fmt(c.subtotal) + '</strong></div>';
            h += '<div class="hero-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong style="color:var(--color-text-secondary)">' + fmt(c.iva) + '</strong></div>';
            h += '<div class="hero-row total"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div>';
            h += '<div style="display:flex;align-items:center;gap:12px;margin-top:8px">';
            h += '<div class="hero-row cost" style="flex:1"><span>Costo real</span><strong>' + fmt(c.totalCost) + '</strong></div>';
            h += '<div class="hero-row profit" style="flex:1"><span>Utilidad</span><strong>' + fmt(c.profit) + '</strong></div>';
            h += '<span class="hero-margin">' + c.margin + '%</span>';
            h += '</div></div>';

            // ── Sheet Optimizer Visual Gauge ──
            if (c.pieces && c.pieces.length > 0) {
                var sheets = calcSheets(c.pieces);
                if (sheets.total > 0) {
                    var pctCasco = Math.round((sheets.casco / sheets.total) * 100);
                    var pctFrente = 100 - pctCasco;
                    h += '<div class="sheet-gauge">';
                    h += '<div class="sheet-gauge-title">' + svg('layers') + ' Laminas Necesarias <span style="font-weight:400;color:#a0e0be">(1220\u00d72440mm, +20% merma)</span></div>';
                    h += '<div class="sheet-gauge-bar">';
                    if (sheets.casco > 0)
                        h += '<div class="sheet-gauge-seg casco" style="width:' + pctCasco + '%">' + sheets.casco + '</div>';
                    if (sheets.frente > 0)
                        h += '<div class="sheet-gauge-seg frente" style="width:' + pctFrente + '%">' + sheets.frente + '</div>';
                    h += '</div>';
                    h += '<div class="sheet-gauge-legend">';
                    h += '<span><span class="dot" style="background:#059669"></span> Casco <strong>' + sheets.casco + '</strong></span>';
                    h += '<span><span class="dot" style="background:#0d9488"></span> Frente <strong>' + sheets.frente + '</strong></span>';
                    h += '<span style="color:#4a9">Total <strong>' + sheets.total + '</strong> laminas</span>';
                    h += '</div></div>';
                }
            }

            // ── Locked Internal Breakdown Accordion ──
            h += '<div class="cost-bd-accordion">';
            h += '<button class="cost-bd-toggle" onclick="APP.togCostBD()"><span><span class="lock-icon">&#x1f512;</span>Desglose de Costos (Interno)</span> ' + svg(S.showCostBreakdown ? 'chevDown' : 'right') + '</button>';
            if (S.showCostBreakdown) {
                h += '<div class="cost-bd-lock">Solo para uso interno \u2014 no se comparte con el cliente</div>';
                h += '<div class="cost-bd-body">';
                h += '<div class="cost-bd-section"><h5>Carpinteria</h5>';
                if (c.totalSheetsF > 0)
                    h += '<div class="cost-bd-row"><span>Mat. Frentes ' + c.totalSheetsF + ' hojas</span><strong>' + fmt(c.matCostF) + '</strong></div>';
                if (c.useDual && c.totalSheetsI > 0)
                    h += '<div class="cost-bd-row"><span>Mat. Interior ' + c.totalSheetsI + ' hojas</span><strong>' + fmt(c.matCostI) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Chapacanto</span><strong>' + fmt(c.chapCostF + c.chapCostI) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Corte + Enchapado</span><strong>' + fmt(c.corteCost + c.enchapCost) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Mano de obra</span><strong>' + fmt(P.laborCost) + '</strong></div>';
                if (P.freight)
                    h += '<div class="cost-bd-row"><span>Flete</span><strong>' + fmt(P.freightCost) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Costo carp.</span><strong>' + fmt(c.carpCost) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Venta (carp + hw std) x' + CONFIG.pricing.carpentryMultiplier + '</span><strong>' + fmt(c.carpSale) + '</strong></div></div>';
                h += '<div class="cost-bd-section"><h5>Herrajes</h5>';
                h += '<div class="cost-bd-row"><span>En carpinter\u00eda (\u2264$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostCarpBucket) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Premium (>$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostPremium) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Venta premium (' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong>' + fmt(c.hwPremiumSale) + '</strong></div></div>';
                if (c.extraCost > 0) {
                    h += '<div class="cost-bd-section"><h5>Extras</h5>';
                    if (c.ledBOM)
                        h += '<div class="cost-bd-row"><span>LED (' + c.ledBOM.totalMeters.toFixed(1) + 'm)</span><strong>' + fmtD(c.ledBOM.totalCost) + '</strong></div>';
                    if (P.glass)
                        h += '<div class="cost-bd-row"><span>Vidrio (' + P.glassM2 + 'm2)</span><strong>' + fmt(P.glassM2 * CONFIG.pricing.glassCostPerM2) + '</strong></div>';
                    if (c.paintCost > 0)
                        h += '<div class="cost-bd-row"><span>Pintura</span><strong>' + fmtD(c.paintCost) + '</strong></div>';
                    h += '<div class="cost-bd-subtotal"><span>Costo extras</span><strong>' + fmt(c.extraCost) + '</strong></div>';
                    h += '<div class="cost-bd-subtotal"><span>Venta (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong>' + fmt(c.extrasSale) + '</strong></div></div>';
                }
                h += '<div class="cost-bd-grand">';
                h += '<div class="cost-bd-grand-row"><span>Subtotal</span><strong>' + fmt(c.subtotal) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
                h += '<div class="cost-bd-grand-row total"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div>';
                h += '<div class="cost-bd-grand-row" style="margin-top:8px;border-top:1px solid #3a3a3a;padding-top:8px"><span>Costo real</span><strong>' + fmt(c.totalCost) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>Utilidad real</span><strong>' + fmt(c.profit) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>Margen real</span><strong>' + c.margin + '%</strong></div>';
                h += '</div></div>';
            }
            h += '</div>';
            return h;
        }

        function step4(c) {
            var P = S.project,
                v = S.view;
            var h = '<div class="title"><h2>' + (v === 'quote' ? 'Cotizacion' : 'Despiece') + '</h2></div>';
            h += '<div class="tabs"><button class="tab' + (v === 'quote' ? ' sel' : '') + '" onclick="APP.setView(\'quote\')">' + svg('file') + ' Cotizacion</button>';
            h += '<button class="tab' + (v === 'cutlist' ? ' sel' : '') + '" onclick="APP.setView(\'cutlist\')">' + svg('clip') + ' Despiece</button></div>';
            if (v === 'quote') {
                var type = TYPES.find(function(t) {
                    return t.id === P.type;
                });
                h += '<div class="quote"><div class="quote-hdr"><h2>' + (BRANDS[S.brand] || BRANDS.primary).name + '</h2><p>' + (BRANDS[S.brand] || BRANDS.primary).tagline + '</p></div><div class="quote-body">';
                h += '<div class="quote-info"><div><span>Cliente:</span><p>' + (P.client || 'Sin nombre') + '</p></div><div><span>Fecha:</span><p>' + date() + '</p></div></div>';
                var matDesc = P.matFrentes.brand + ' ' + P.matFrentes.name;
                if (c.useDual)
                    matDesc += ' (frentes) + ' + P.matInterior.brand + ' ' + P.matInterior.name + ' (interior)';
                h += '<div class="quote-project"><span>Proyecto:</span><h3>' + (type ? type.n : '') + '</h3><p>Material: ' + matDesc + '</p></div>';
                h += '<div class="quote-mods"><h4>Modulos:</h4>';
                P.modules.forEach(function(m, i) {
                    var mInfo = m.width + 'cm';
                    if (m.height)
                        mInfo += ' x ' + m.height + 'cm';
                    var mcaj = typeof m.cajones === 'number' ? m.cajones : (m.type === 'modulo' ? 4 : 0);
                    if (m.type === 'modulo' && mcaj === 0)
                        mInfo += ' (' + (typeof m.shelves === 'number' ? m.shelves : 3) + ' ent.)';
                    else if (mcaj > 0)
                        mInfo += ' (' + mcaj + ' caj.)';
                    h += '<div class="quote-mod"><span>' + (i + 1) + '. ' + m.name + '</span><span>' + mInfo + '</span></div>';
                });
                h += '</div>';
                if (c.ledBOM || P.glass) {
                    h += '<div class="quote-extras"><h4>Extras:</h4>';
                    if (c.ledBOM)
                        h += '<p>- Iluminacion LED perimetral completa</p>';
                    if (P.glass)
                        h += '<p>- Vidrio templado 6mm</p>';
                    h += '</div>';
                }
                h += '<div class="quote-price"><div class="quote-price-row"><span>Subtotal</span><strong>' + fmt(c.subtotal) + '</strong></div>';
                h += '<div class="quote-price-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
                h += '<div class="quote-total"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div></div>';
                var _ht = CONFIG.quoting.htmlTerms.map(function(t) { return t.replace('{anticipo}', CONFIG.quoting.defaultAnticipo).replace('{deliveryTime}', CONFIG.quoting.defaultDelivery); });
                h += '<div class="quote-terms"><h4>Condiciones:</h4>' + _ht.map(function(t) { return '<p>- ' + t + '</p>'; }).join('') + '</div>';
                h += '<div class="quote-contact"><p>&#x1f4de; ' + CONTACT.cell + '</p><p>&#x1f4e7; ' + CONTACT.email + '</p></div>';
                h += '</div></div>';
            } else {
                h += '<div class="quote"><div class="cut-hdr"><h2>DESPIECE PARA COMSA</h2><p>' + (P.client || 'Sin nombre') + ' - ' + date() + '</p>';
                h += '<p style="font-size:14px;opacity:0.85">Frentes: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '</p>';
                if (c.useDual)
                    h += '<p style="font-size:14px;opacity:0.6">Interior: ' + P.matInterior.brand + ' ' + P.matInterior.name + '</p>';
                if (P.chapSpec)
                    h += '<p style="font-size:13px;color:var(--color-accent)">Chapacanto: ' + P.chapSpec + '</p>';
                h += '</div><div class="cut-body">';
                h += '<div class="cut-summary"><div class="cut-box"><strong>' + c.totalSheets + '</strong><span>Hojas Total</span></div><div class="cut-box"><strong>' + c.totalCanto + '</strong><span>ML Canto</span></div></div>';
                var tk = c.projThickness || 16;
                h += '<div style="padding:12px;background:var(--color-surface-3);border:1px solid var(--color-border);border-radius:8px;margin-bottom:16px"><h4 style="font-weight:700;margin-bottom:8px;color:var(--color-text-primary)">Hojas (' + tk + 'mm):</h4>';
                if (c.useDual) {
                    h += '<p style="font-size:12px;color:var(--color-info);margin-bottom:4px;font-weight:600">FRENTES:</p>';
                    if (c.totalSheetsF > 0)
                        h += '<p style="font-size:14px;color:var(--color-text-secondary)">  ' + tk + 'mm: ' + c.totalSheetsF + ' hojas</p>';
                    h += '<p style="font-size:12px;color:var(--color-text-tertiary);margin:8px 0 4px;font-weight:600">INTERIOR:</p>';
                    if (c.totalSheetsI > 0)
                        h += '<p style="font-size:14px;color:var(--color-text-secondary)">  ' + tk + 'mm: ' + c.totalSheetsI + ' hojas</p>';
                } else {
                    var sAll = c.totalSheetsF + c.totalSheetsI;
                    if (sAll > 0)
                        h += '<p style="font-size:14px;color:var(--color-text-secondary)">' + tk + 'mm: ' + sAll + ' hojas</p>';
                }
                h += '</div>';
                // Reset edits button (placed above tables)
                if (Object.keys(S.editedPieces).length > 0) {
                    h += '<button class="cut-reset-btn" onclick="APP.resetEdits()">Restaurar medidas calculadas</button>';
                }
                P.modules.forEach(function(m) {
                    var pcs = c.pieces.filter(function(p) {
                        return p.mid === m.id;
                    });
                    pcs.sort(function(a, b) {
                        var alA = anchoLargo(a.w, a.h),
                            alB = anchoLargo(b.w, b.h);
                        return alB.largo - alA.largo;
                    });
                    var mHdr = m.name + ' ' + m.width + 'cm';
                    if (m.height)
                        mHdr += ' x ' + m.height + 'cm';
                    h += '<div class="cut-module"><div class="cut-module-hdr">' + mHdr + '</div><div class="cut-module-body">';
                    // Proper data table with sticky headers
                    h += '<table class="cut-table"><thead><tr>';
                    h += '<th>Pieza</th>';
                    h += '<th class="col-num">Cant</th>';
                    h += '<th class="col-num">Ancho</th>';
                    h += '<th class="col-num">Largo</th>';
                    h += '<th class="col-num">Esp.</th>';
                    if (c.useDual) h += '<th class="col-zone">Zona</th>';
                    h += '</tr></thead><tbody>';
                    pcs.forEach(function(p) {
                        var al = anchoLargo(p.w, p.h);
                        var eKey = m.id + ':' + p.n;
                        var ep = S.editedPieces[eKey] || {};
                        var isEdited = !!S.editedPieces[eKey];
                        var eq = typeof ep.q === 'number' ? ep.q : p.q;
                        var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                        var el = typeof ep.largo === 'number' ? ep.largo : al.largo;
                        var editedQty = typeof ep.q === 'number';
                        var editedA = typeof ep.ancho === 'number';
                        var editedL = typeof ep.largo === 'number';
                        h += '<tr' + (isEdited ? ' class="cut-row-edited"' : '') + '>';
                        h += '<td class="col-name">' + p.n + '</td>';
                        h += '<td class="col-num"><input type="number" class="cut-input cut-input-qty' + (editedQty ? ' cut-input-edited' : '') + '" value="' + eq + '" min="0" onchange="APP.editPiece(\'' + eKey + '\',\'q\',parseInt(this.value))"></td>';
                        h += '<td class="col-num"><input type="number" class="cut-input' + (editedA ? ' cut-input-edited' : '') + '" value="' + ea + '" min="0" onchange="APP.editPiece(\'' + eKey + '\',\'ancho\',parseInt(this.value))"></td>';
                        h += '<td class="col-num"><input type="number" class="cut-input' + (editedL ? ' cut-input-edited' : '') + '" value="' + el + '" min="0" onchange="APP.editPiece(\'' + eKey + '\',\'largo\',parseInt(this.value))"></td>';
                        h += '<td class="col-num" style="color:var(--color-text-tertiary)">' + p.t + 'mm</td>';
                        if (c.useDual)
                            h += '<td class="col-zone"><span class="cut-badge ' + (p.z === 'f' ? 'cut-badge-f' : 'cut-badge-i') + '">' + (p.z === 'f' ? 'Frentes' : 'Interior') + '</span></td>';
                        h += '</tr>';
                    });
                    h += '</tbody></table>';
                    h += '</div></div>';
                });
                h += '<div style="padding:12px;background:var(--color-surface-3);border:1px solid var(--color-border);border-radius:8px"><h4 style="font-weight:700;margin-bottom:8px;color:var(--color-text-primary)">Herrajes:</h4>';
                c.allHW.forEach(function(hw) {
                    h += '<p style="font-size:14px;color:var(--color-text-secondary)">- ' + hw.desc + ': ' + Math.ceil(hw.qty) + ' (' + hw.marca + ')</p>';
                });
                h += '</div></div></div>';
            }
            h += '';
            return h;
        }

        function buildHWListHTML(items, isSwap) {
            var h = '';
            if (items.length === 0) {
                h += '<div style="text-align:center;padding:32px;color:var(--color-text-tertiary)">Sin resultados</div>';
            } else {
                var lastCat = '';
                items.forEach(function(item) {
                    if (item.categoria !== lastCat) {
                        lastCat = item.categoria;
                        h += '<div class="hw-cat-hdr">' + item.categoria + '</div>';
                    }
                    var hwArr = S.screen === 'estandarizado' ? S.estProject.hardware : S.project.hardware;
                    var inCart = hwArr.find(function(x) {
                        return x.codigo === item.codigo;
                    });
                    h += '<div class="hw-item"' + (isSwap ? ' style="flex-wrap:wrap"' : '') + '>';
                    h += '<div class="hw-item-info"><div class="hw-item-name">' + item.descripcion + '</div><div class="hw-item-meta"><span class="hw-sel-marca ' + marcaClass(item.marca) + '">' + item.marca + '</span> ' + item.codigo + ' | ' + item.unidad + '</div></div>';
                    h += '<div class="hw-item-price">' + fmtD(adjPrice(item)) + '</div>';
                    if (isSwap) {
                        h += '<button style="width:100%;margin-top:6px;padding:10px 12px;border-radius:8px;border:none;background:var(--color-accent);color:var(--color-text-on-accent);font-weight:700;cursor:pointer;font-size:14px" onclick="APP.hwCartAdd(\'' + item.codigo + '\')">Seleccionar</button>';
                    } else if (inCart) {
                        h += '<div class="hw-item-qty"><button onclick="APP.hwCartQty(\'' + item.codigo + '\',-1)">-</button><strong>' + inCart.qty + '</strong><button onclick="APP.hwCartQty(\'' + item.codigo + '\',1)">+</button></div>';
                    } else {
                        h += '<button style="padding:6px 12px;border-radius:6px;border:none;background:var(--color-accent);color:var(--color-text-on-accent);font-weight:600;cursor:pointer;font-size:12px" onclick="APP.hwCartAdd(\'' + item.codigo + '\')">+ Agregar</button>';
                    }
                    h += '</div>';
                });
                if (items.length >= 60)
                    h += '<div style="text-align:center;padding:16px;color:var(--color-text-tertiary);font-size:13px">Mostrando primeros 60 resultados. Usa filtros para refinar.</div>';
            }
            return h;
        }

        function renderHWPicker() {
            if (!S.showHWPicker)
                return '';
            var items = filterHW();
            var cats = getHWCats();
            var marcas = getHWMarcas();
            var h = '<div class="hw-picker" onclick="APP.closeHWPicker(event)">';
            h += '<div class="hw-picker-content" onclick="event.stopPropagation()">';
            var isSwap = !!S.estHwSwapKey;
            h += '<div class="hw-picker-hdr"><h3>' + svg('search') + (isSwap ? ' Cambiar Herraje' : ' Catalogo de Herrajes') + '</h3><button class="modal-close" onclick="APP.closeHWPicker()">' + svg('x') + '</button></div>';
            if (isSwap) {
                var swDef = HW_DEFAULTS[S.estHwSwapKey];
                h += '<div style="padding:10px 16px;background:var(--color-warning-subtle);border-bottom:1px solid var(--color-border);font-size:13px;color:var(--color-warning);display:flex;align-items:center;gap:8px"><strong>Reemplazando:</strong> ' + (swDef ? swDef.desc : S.estHwSwapKey) + '</div>';
            }
            // Sticky search area
            h += '<div class="hw-search-area">';
            h += '<input class="hw-search" type="text" placeholder="Buscar por nombre o codigo..." value="' + (S.hwFilter.q || '') + '" oninput="APP.hwSearch(this.value)" id="hwSearchInput">';
            // Marca filters (collapsed when selected)
            h += '<div class="hw-filters">';
            if (S.hwFilter.marca) {
                h += '<button class="hw-chip sel" onclick="APP.hwFilterMarca(\'\')">' + S.hwFilter.marca + ' &times;</button>';
            } else {
                h += '<span style="font-size:11px;color:var(--color-text-tertiary);white-space:nowrap">Marca:</span>';
                marcas.forEach(function(m) {
                    h += '<button class="hw-chip" onclick="APP.hwFilterMarca(\'' + m + '\')">' + m + '</button>';
                });
            }
            h += '</div>';
            // Category filters (collapsed when selected)
            h += '<div class="hw-filters">';
            if (S.hwFilter.cat) {
                h += '<button class="hw-chip sel" onclick="APP.hwFilterCat(\'\')">' + S.hwFilter.cat + ' &times;</button>';
            } else {
                h += '<span style="font-size:11px;color:var(--color-text-tertiary);white-space:nowrap">Categor\u00eda:</span>';
                cats.forEach(function(c2) {
                    h += '<button class="hw-chip" onclick="APP.hwFilterCat(\'' + c2 + '\')">' + c2 + '</button>';
                });
            }
            h += '</div></div>';
            h += '<div class="hw-list" id="hwListContainer">' + buildHWListHTML(items, isSwap) + '</div></div></div>';
            return h;
        }

        function renderSettings() {
            if (!S.showSettings)
                return '';
            var s = S.settings;
            var h = '<div class="settings-overlay" onclick="APP.closeSettings(event)">';
            h += '<div class="settings-panel" onclick="event.stopPropagation()">';
            h += '<div class="settings-hdr"><h3>' + svg('settings') + ' Configuracion</h3><button class="modal-close" onclick="APP.closeSettings()">' + svg('x') + '</button></div>';
            h += '<div class="settings-body">';
            h += '<div class="settings-section"><h4>Ajuste Precio Proveedores</h4>';
            ['ARAUCO', 'HERRAXA', 'BLUM', 'HAFELE'].forEach(function(m) {
                h += '<div class="supplier-row"><span class="' + marcaClass(m) + '">' + m + '</span><input type="number" value="' + (s.supplierAdj[m] || 0) + '" onchange="APP.setSupplierAdj(\'' + m + '\',parseFloat(this.value))">%</div>';
            });
            h += '</div>';
            // Brand selector
            h += '<div class="settings-section"><h4>Marca Activa</h4>';
            h += '<div class="brand-toggle">';
            for (var bk in BRANDS) {
                var b = BRANDS[bk];
                h += '<button class="brand-btn' + (S.brand === bk ? ' sel' : '') + '" onclick="APP.setBrand(\'' + bk + '\')"><span class="mono">' + b.mono + '</span>' + b.name + '</button>';
            }
            h += '</div></div>';
            // Logo upload
            h += '<div class="settings-section"><h4>Logo de Empresa</h4>';
            h += '<div class="logo-section">';
            h += '<div class="logo-preview">';
            if (S.logoBase64)
                h += '<img src="' + S.logoBase64 + '">';
            else {
                var abr = BRANDS[S.brand] || BRANDS.primary;
                h += '<div style="font-size:24px;font-weight:700;color:#c49a6c">' + abr.mono + '</div>';
            }
            h += '</div>';
            h += '<div class="logo-btns"><button class="upload" onclick="APP.uploadLogo()">Subir logo</button>';
            if (S.logoBase64)
                h += '<button class="remove" onclick="APP.removeLogo()">Quitar</button>';
            h += '</div></div></div>';
            // Quote counter
            h += '<div class="settings-section"><h4>Numero de Cotizacion</h4>';
            h += '<div class="margin-row"><label>Siguiente #</label><input type="number" value="' + S.quoteCounter + '" min="1" onchange="APP.setQuoteCounter(parseInt(this.value))"></div>';
            h += '<p style="font-size:12px;color:#999;margin-top:4px">El mismo n\u00famero se usa en PDF Cliente e Interno</p>';
            h += '</div>';
            h += '</div></div></div>';
            return h;
        }

        function nav() {
            var canNext = S.step === 1 ? S.project.type !== '' : S.step === 2 ? S.project.modules.length > 0 : true;
            var h = '<div class="nav">';
            if (S.step === 1)
                h += '<button class="nav-btn back" onclick="APP.goHome()">' + svg('left') + ' Plantillas</button>';
            else if (S.step > 1)
                h += '<button class="nav-btn back" onclick="APP.goStep(' + (S.step - 1) + ')">' + svg('left') + ' Atras</button>';
            if (S.step < 4)
                h += '<button class="nav-btn next" onclick="APP.next()"' + (canNext ? '' : ' disabled') + '>' + (S.step === 3 ? 'Ver Cotizacion' : 'Siguiente') + svg('right') + '</button>';
            if (S.step === 4)
                h += '<button class="nav-btn next" style="background:#c49a6c;color:#1a1a2e" onclick="APP.next()">Generar PDF ' + svg('right') + '</button>';
            h += '</div>';
            return h;
        }

        function step5(c) {
            var P = S.project,
                d = S.pdfData;
            if (!d) {
                APP.initPdfData();
                d = S.pdfData;
            }
            var br = BRANDS[S.brand] || BRANDS.primary;
            var h = '<div class="title"><h2>Generar Cotizacion</h2><p>Revisa y edita antes de generar</p></div>';
            // Brand selector
            h += '<div class="brand-toggle">';
            for (var bk in BRANDS) {
                var b = BRANDS[bk];
                h += '<button class="brand-btn' + (S.brand === bk ? ' sel' : '') + '" onclick="APP.setBrand(\'' + bk + '\')"><span class="mono">' + b.mono + '</span>' + b.name + '</button>';
            }
            h += '</div>';
            // Editable fields
            h += '<div class="pdf-field"><label>Cliente</label><input type="text" value="' + (d.client || '') + '" oninput="APP.setPdfField(\'client\',this.value)"></div>';
            h += '<div class="pdf-field"><label>Proyecto</label><input type="text" value="' + (d.projectName || '') + '" oninput="APP.setPdfField(\'projectName\',this.value)"></div>';
            h += '<div class="pdf-field"><label>Ubicacion</label><input type="text" value="' + (d.location || '') + '" placeholder="Ciudad, Estado" oninput="APP.setPdfField(\'location\',this.value)"></div>';
            h += '<div style="display:flex;gap:12px">';
            h += '<div class="pdf-field" style="flex:1"><label>No. Cotizacion</label><input type="text" value="' + (d.quoteNum || '') + '" oninput="APP.setPdfField(\'quoteNum\',this.value)"></div>';
            h += '<div class="pdf-field" style="flex:1"><label>Entrega</label><input type="text" value="' + (d.deliveryTime || '') + '" oninput="APP.setPdfField(\'deliveryTime\',this.value)"></div>';
            h += '</div>';
            h += '<div class="pdf-field"><label>Anticipo %</label><input type="number" value="' + (d.anticipo || CONFIG.quoting.defaultAnticipo) + '" min="0" max="100" onchange="APP.setPdfField(\'anticipo\',parseInt(this.value))"></div>';
            // Line items — one per module
            h += '<div class="pdf-items"><label style="font-size:14px;color:#fff;display:block;margin-bottom:4px">Modulos del proyecto (aparecen en el PDF)</label>';
            h += '<p style="font-size:12px;color:#999;margin-bottom:12px">Cada modulo es una linea en la tabla de cotizacion. Edita descripcion y precio.</p>';
            d.items.forEach(function(item, i) {
                h += '<div class="pdf-item">';
                h += '<div class="pdf-item-hdr" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
                h += '<strong style="color:#60a5fa;font-size:13px">' + (item.name || 'Modulo ' + (i + 1)) + '</strong>';
                h += '<div style="display:flex;align-items:center;gap:4px"><span style="color:#bbb;font-size:12px">Precio:</span><span style="color:#bbb">$</span><input class="pdf-item-price" type="number" value="' + item.price + '" onchange="APP.setPdfItemPrice(' + i + ',parseFloat(this.value))" style="width:100px"></div>';
                h += '</div>';
                h += '<textarea class="pdf-item-desc" oninput="APP.setPdfItemDesc(' + i + ',this.value)" rows="5">' + item.desc + '</textarea>';
                h += '<div style="font-size:12px;color:#999;margin-top:4px">Medidas: ' + item.dims + '</div>';
                h += '</div>';
            });
            h += '</div>';
            // Totals
            var itemTotal = d.items.reduce(function(a, it) {
                return a + it.price;
            }, 0);
            var iva = itemTotal * CONFIG.pricing.iva;
            var total = itemTotal + iva;
            h += '<div class="pdf-totals">';
            h += '<div class="pdf-totals-row"><span>Subtotal</span><strong style="font-family:monospace">' + fmt(itemTotal) + '</strong></div>';
            h += '<div class="pdf-totals-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong style="font-family:monospace">' + fmt(iva) + '</strong></div>';
            h += '<div class="pdf-totals-row grand"><span>TOTAL</span><strong style="font-family:monospace">' + fmt(total) + '</strong></div>';
            h += '</div>';
            // Notes
            h += '<div class="pdf-field"><label>Notas especiales</label><textarea oninput="APP.setPdfField(\'notes\',this.value)">' + (d.notes || '') + '</textarea></div>';
            // Action buttons
            h += '<div class="pdf-actions">';
            h += '<button class="pdf-btn client" onclick="APP.genClientPDF()">&#x1f4c4; PDF Cliente</button>';
            h += '<button class="pdf-btn internal" onclick="APP.genInternalPDF()">&#x1f512; PDF Interno</button>';
            h += '<button class="pdf-btn despiece" onclick="APP.genDespiece()">&#x1f4cb; PDF Despiece</button>';
            h += '</div>';
            return h;
        }

        // PDF generation helpers
        function getBrandSvgDataUrl(brandId) {
            var b = BRANDS[brandId] || BRANDS.primary;
            var svgStr = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 80"><rect width="200" height="80" rx="12" fill="#1a1a2e"/><text x="100" y="52" font-size="36" font-weight="bold" text-anchor="middle" font-family="Helvetica,Arial,sans-serif" fill="#c49a6c">' + b.mono + '</text></svg>';
            return 'data:image/svg+xml;base64,' + btoa(svgStr);
        }

        function getQuoteNum() {
            var yr = new Date().getFullYear();
            var num = S.pdfData ? S.pdfData.quoteNum : CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
            return num;
        }

        function fmtDatePDF() {
            var d = new Date();
            var months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return d.getDate() + '/' + months[d.getMonth()] + '/' + d.getFullYear();
        }

        function sanitize(s) {
            return (s || '').replace(/[<>&"']/g, '');
        }

        function addPlanoPage(doc, margin) {
            var EP = S.estProject;
            if (!EP || !EP.modules || EP.modules.length === 0)
                return;
            var plano = EP.planoImage;
            doc.addPage('letter', 'l'); // landscape for more horizontal space
            var pw = 279.4,
                ph = 215.9; // letter landscape mm
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            // Header
            doc.setFillColor(accent[0], accent[1], accent[2]);
            doc.rect(0, 0, pw, 12, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('PLANO DEL PROYECTO', margin, 9);

            if (plano) {
                // User-uploaded image
                var maxW = pw - 2 * margin,
                    maxH = ph - 28;
                try {
                    var img = new Image();
                    img.src = plano;
                    var iw = img.naturalWidth || 1,
                        ih = img.naturalHeight || 1;
                    var ratio = Math.min(maxW / iw, maxH / ih);
                    var drawW = iw * ratio,
                        drawH = ih * ratio;
                    var cx = margin + (maxW - drawW) / 2;
                    var imgFmt = plano.indexOf('data:image/png') === 0 ? 'PNG' : 'JPEG';
                    doc.addImage(plano, imgFmt, cx, 18, drawW, drawH);
                } catch (e) {
                    doc.setFontSize(10);
                    doc.setTextColor(180, 0, 0);
                    doc.text('Error al cargar imagen del plano', margin, 30);
                }
            } else {
                // Draw module visuals
                var tk = (EP.thickness || 16) / 10;
                var modules = EP.modules;
                var totalW = 0;
                modules.forEach(function(m) {
                    totalW += m.width;
                });
                var nMods = modules.length;
                // Dynamic gap: smaller when many modules
                var modGap = nMods <= 3 ? 10 : nMods <= 5 ? 6 : 4;
                var totalGap = (nMods - 1) * modGap;
                var availW = pw - 2 * margin - totalGap;
                // Reserve space at bottom: module details list + legend + specs line
                var detailLines = nMods + 3; // nMods lines + header + legend + specs
                var reservedBottom = detailLines * 3.5 + 16;
                var availH = ph - 24 - reservedBottom; // 24 = top header area
                var maxModH = 0;
                modules.forEach(function(m) {
                    var mH = estModHeight(m);
                    if (mH > maxModH)
                        maxModH = mH;
                });
                // Account for maletero/zoclo in max visual height
                var maxVisH = maxModH;
                modules.forEach(function(m) {
                    var vH = estModHeight(m);
                    if (m.maletero && m.maletero.enabled)
                        vH += (m.maletero.height || 30);
                    if (m.zoclo && m.zoclo.enabled)
                        vH += (m.zoclo.height || 10);
                    if (vH > maxVisH)
                        maxVisH = vH;
                });
                var scale = Math.min(availW / totalW, availH / maxVisH);
                if (scale > 1.2)
                    scale = 1.2;

                // Check if we need 2 rows (very small scale)
                var useRows = 1;
                if (scale < 0.3 && nMods > 3) {
                    useRows = 2;
                    // Recalculate for 2 rows
                    var modsPerRow = Math.ceil(nMods / 2);
                    var row1W = 0,
                        row2W = 0;
                    modules.forEach(function(m, i) {
                        if (i < modsPerRow)
                            row1W += m.width;
                        else
                            row2W += m.width;
                    });
                    var maxRowW = Math.max(row1W, row2W);
                    var rowGaps = (modsPerRow - 1) * modGap;
                    var rowAvailW = pw - 2 * margin - rowGaps;
                    var rowAvailH = (availH - 15) / 2; // 15mm gap between rows
                    scale = Math.min(rowAvailW / maxRowW, rowAvailH / maxVisH);
                    if (scale > 1.2)
                        scale = 1.2;
                }

                var rowStartY = 24; // leave room for module number labels above visuals
                var modsPerRow = useRows > 1 ? Math.ceil(nMods / 2) : nMods;
                // Zone colors (RGB) for PDF
                var zColors = {
                    techo: [80, 80, 80],
                    piso: [80, 80, 80],
                    cajones: [196, 154, 108],
                    colgador: [96, 165, 250],
                    zapatero: [139, 92, 246],
                    entrepa: [120, 120, 120],
                    libre: [200, 200, 200],
                    maletero: [234, 179, 8],
                    zoclo: [139, 92, 60]
                };
                // Center modules horizontally: calculate total drawn width per row
                var row1W = 0,
                    row2W = 0;
                modules.forEach(function(m, i) {
                    var w = m.width * scale;
                    if (i < modsPerRow)
                        row1W += w;
                    else
                        row2W += w;
                });
                row1W += (Math.min(nMods, modsPerRow) - 1) * modGap;
                if (useRows > 1 && nMods > modsPerRow)
                    row2W += (nMods - modsPerRow - 1) * modGap;
                var contentArea = pw - 2 * margin;
                var curX = margin + (contentArea - row1W) / 2;
                // Track the bottom-most Y for legend placement
                var maxBottomY = 0;
                doc.setFontSize(8);
                modules.forEach(function(m, mi) {
                    // Row management
                    if (useRows > 1 && mi === modsPerRow) {
                        curX = margin + (contentArea - row2W) / 2;
                        rowStartY = rowStartY + maxVisH * scale + 25;
                    }
                    var mH = estModHeight(m);
                    var W = m.width * scale;
                    var H = mH * scale;
                    var eu = estEspacioUtil(m);
                    var fixed = calcEstFixedHeight(m);
                    var hasColg = m.zones.some(function(z) {
                        return z.type === 'colgador';
                    });
                    var isEsp = m.type === 'especial';
                    var freeSpace = eu - fixed;
                    var barX = curX;
                    var barW = W;
                    var barH = H;
                    // Maletero above module body
                    var malObj = m.maletero || {
                        enabled: false,
                        height: 30
                    };
                    var malH2 = malObj.enabled ? (malObj.height || 30) * scale : 0;
                    // Module body starts after maletero
                    var bodyY = rowStartY + malH2;
                    // Draw maletero above the body
                    if (malObj.enabled) {
                        doc.setFillColor(zColors.maletero[0], zColors.maletero[1], zColors.maletero[2]);
                        doc.rect(barX, rowStartY, barW, malH2, 'F');
                        doc.setDrawColor(180, 150, 0);
                        doc.rect(barX, rowStartY, barW, malH2);
                        doc.setTextColor(80, 60, 0);
                        doc.setFontSize(6);
                        doc.text((malObj.height || 30) + 'cm', barX + barW / 2, rowStartY + malH2 / 2 + 1, {
                            align: 'center'
                        });
                    }
                    // Module body outline
                    doc.setDrawColor(150, 150, 150);
                    doc.setLineWidth(0.3);
                    if (m.type !== 'esquinero')
                        doc.rect(barX, bodyY, barW, barH);
                    // Techo (skip for fijo)
                    var segY = bodyY;
                    var tkH = tk * scale;
                    if (m.type !== 'fijo') {
                        doc.setFillColor(zColors.techo[0], zColors.techo[1], zColors.techo[2]);
                        doc.rect(barX, segY, barW, tkH, 'F');
                        doc.setFontSize(6);
                        doc.setTextColor(180, 180, 180);
                        doc.text('T', barX + barW / 2, segY + tkH - 0.5, {
                            align: 'center'
                        });
                        segY += tkH;
                    }
                    // Zones — array is already top→bottom, draw in order
                    var hasDoors = false;
                    m.zones.forEach(function(z) {
                        var zh = getEstZoneDisplayHeight(m, z);
                        var segH2 = zh * scale;
                        var col = zColors[z.type] || [160, 160, 160];
                        var zoneStartY = segY; // track start for door lines
                        if (z.type === 'entrepa' && (isEsp || (!hasColg && freeSpace > 0))) {
                            var cnt = z.count || 2;
                            var spaceForEnt = isEsp ? eu : freeSpace;
                            var totalSegH = spaceForEnt * scale;
                            var entLineH = tk * scale * 0.5;
                            var sectionH = (totalSegH - cnt * entLineH) / (cnt + 1);
                            for (var si = 0; si < cnt + 1; si++) {
                                doc.setFillColor(240, 240, 240);
                                doc.rect(barX + 0.5, segY, barW - 1, Math.max(1, sectionH), 'F');
                                segY += Math.max(1, sectionH);
                                if (si < cnt) {
                                    doc.setFillColor(col[0], col[1], col[2]);
                                    doc.rect(barX + 0.5, segY, barW - 1, Math.max(0.5, entLineH), 'F');
                                    segY += Math.max(0.5, entLineH);
                                }
                            }
                        } else if (z.type === 'colgador') {
                            doc.setFillColor(col[0], col[1], col[2]);
                            doc.setGState(new doc.GState({
                                opacity: 0.3
                            }));
                            doc.rect(barX + 0.5, segY, barW - 1, segH2, 'F');
                            doc.setGState(new doc.GState({
                                opacity: 1
                            }));
                            doc.setDrawColor(col[0], col[1], col[2]);
                            doc.setLineDashPattern([1, 1], 0);
                            doc.rect(barX + 0.5, segY, barW - 1, segH2);
                            doc.setLineDashPattern([], 0);
                            var tuboY2 = segY + Math.min(4, segH2 * 0.3);
                            doc.setDrawColor(col[0], col[1], col[2]);
                            doc.setLineWidth(0.5);
                            doc.line(barX + 3, tuboY2, barX + barW - 3, tuboY2);
                            doc.setLineWidth(0.3);
                            doc.setFontSize(6);
                            doc.setTextColor(col[0], col[1], col[2]);
                            doc.text(Math.round(zh) + 'cm', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else if (z.type === 'cajones') {
                            var cCnt = z.count || 3;
                            var cUnitH = segH2 / cCnt;
                            for (var ci = 0; ci < cCnt; ci++) {
                                doc.setFillColor(col[0], col[1], col[2]);
                                doc.rect(barX + 0.5, segY + ci * cUnitH, barW - 1, Math.max(1, cUnitH - 0.5), 'F');
                            }
                            doc.setFontSize(6);
                            doc.setTextColor(255, 255, 255);
                            doc.text(cCnt + 'C', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else if (z.type === 'zapatero') {
                            var zCnt = z.repisas || 3;
                            var zUnitH = segH2 / zCnt;
                            for (var zzi = 0; zzi < zCnt; zzi++) {
                                doc.setFillColor(col[0], col[1], col[2]);
                                doc.rect(barX + 0.5, segY + zzi * zUnitH, barW - 1, Math.max(1, zUnitH - 0.5), 'F');
                            }
                            doc.setFontSize(6);
                            doc.setTextColor(255, 255, 255);
                            doc.text(zCnt + 'Z', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else {
                            doc.setFillColor(col[0], col[1], col[2]);
                            doc.rect(barX + 0.5, segY, barW - 1, segH2, 'F');
                            segY += segH2;
                        }
                        if (z.doors)
                            hasDoors = true;
                    });
                    // Check for completa door mode
                    var pdfDoorMode = m.doorMode || 'por_zona';
                    if (m.doors && pdfDoorMode === 'completa')
                        hasDoors = true;
                    // Piso (skip for fijo)
                    if (m.type !== 'fijo') {
                        doc.setFillColor(zColors.piso[0], zColors.piso[1], zColors.piso[2]);
                        doc.rect(barX, segY, barW, tkH, 'F');
                        doc.setFontSize(6);
                        doc.setTextColor(180, 180, 180);
                        doc.text('P', barX + barW / 2, segY + tkH - 0.5, {
                            align: 'center'
                        });
                        segY += tkH;
                    }
                    // Zoclo (below module body)
                    var zoc2 = m.zoclo || {
                        enabled: false,
                        height: 10
                    };
                    if (zoc2.enabled) {
                        var zocH2 = (zoc2.height || 10) * scale;
                        doc.setFillColor(zColors.zoclo[0], zColors.zoclo[1], zColors.zoclo[2]);
                        doc.rect(barX, segY, barW, zocH2, 'F');
                        doc.setFontSize(5);
                        doc.setTextColor(255, 255, 255);
                        doc.text('Z', barX + barW / 2, segY + zocH2 / 2 + 1, {
                            align: 'center'
                        });
                        segY += zocH2;
                    }
                    // Door indicator — spans full module body
                    if (hasDoors) {
                        var pdfDoorCnt = (m.doors && pdfDoorMode === 'completa') ? (m.doorCount || 2) : 2;
                        doc.setDrawColor(196, 154, 108);
                        doc.setLineWidth(0.4);
                        doc.line(barX, bodyY, barX, bodyY + barH);
                        doc.line(barX + barW, bodyY, barX + barW, bodyY + barH);
                        if (pdfDoorCnt >= 2) {
                            doc.line(barX + barW / 2, bodyY, barX + barW / 2, bodyY + barH);
                        }
                        doc.setLineWidth(0.3);
                    }
                    // Esquinero L-shape visual
                    if (m.type === 'esquinero') {
                        var esqArmW = Math.max(barW * 0.45, 6);
                        var esqTopH = Math.max(barH * 0.38, 6);
                        var esqMaskBot = Math.max(segY, bodyY + barH);
                        // Mask bottom-right notch area with white
                        doc.setFillColor(255, 255, 255);
                        doc.rect(barX + esqArmW, bodyY + esqTopH, barW - esqArmW + 1, esqMaskBot - bodyY - esqTopH + 1, 'F');
                        // Draw L-shaped outline
                        doc.setDrawColor(150, 150, 150);
                        doc.setLineWidth(0.3);
                        doc.lines([
                        [barW, 0], [0, esqTopH], [-(barW - esqArmW), 0], [0, barH - esqTopH], [-esqArmW, 0], [0, -barH]
                        ], barX, bodyY, [1, 1], 'S', true);
                        // Lado A / Lado B labels
                        doc.setFontSize(5);
                        doc.setTextColor(120, 120, 120);
                        doc.setFont('helvetica', 'normal');
                        doc.text('A:' + m.width + 'cm', barX + barW / 2, bodyY + esqTopH * 0.6, {
                            align: 'center'
                        });
                        doc.text('B:' + (m.width2 || m.width) + 'cm', barX + esqArmW / 2, bodyY + esqTopH + (barH - esqTopH) * 0.5, {
                            align: 'center'
                        });
                    }
                    // Module number label above the visual
                    var labelTopY = malObj.enabled ? rowStartY : bodyY;
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(60, 60, 60);
                    doc.text('M' + (mi + 1), barX + barW / 2, labelTopY - 1.5, {
                        align: 'center'
                    });
                    var thisBottom = segY + 2;
                    if (thisBottom > maxBottomY)
                        maxBottomY = thisBottom;
                    doc.setFontSize(8);
                    curX += W + modGap;
                });
                // Module names listed at the bottom of the sheet — always in reserved area
                var bottomY = ph - reservedBottom + 4;
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(60, 60, 60);
                doc.text('Detalle de M\u00f3dulos:', margin, bottomY);
                bottomY += 4;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6.5);
                modules.forEach(function(m, mi) {
                    var mLabel = m.width + 'cm';
                    if (m.type === 'esquinero')
                        mLabel = m.width + 'x' + (m.width2 || m.width) + 'cm';
                    else if (m.type === 'fijo')
                        mLabel = m.width + 'x' + m.height + 'cm';
                    var typeName = m.type === 'esquinero' ? 'Esquinero' : m.type === 'fijo' ? 'Fijo' : m.type === 'panelTV' ? 'Panel TV' : m.type === 'especial' ? 'Especial' : m.type === 'torreLateral' ? 'Torre Lat.' : 'M\u00f3dulo';
                    var zoneSummary = [];
                    m.zones.forEach(function(z2) {
                        if (z2.type === 'cajones')
                            zoneSummary.push((z2.count || 3) + ' cajones');
                        else if (z2.type === 'colgador')
                            zoneSummary.push('colgador');
                        else if (z2.type === 'zapatero')
                            zoneSummary.push((z2.repisas || 3) + ' zapatero');
                        else if (z2.type === 'entrepa')
                            zoneSummary.push((z2.count || 2) + ' entrepa\u00f1os');
                    });
                    if (m.doors) {
                        var dm = m.doorMode || 'por_zona';
                        if (dm === 'completa')
                            zoneSummary.push((m.doorCount || 2) + ' puertas completas');
                        else
                            zoneSummary.push('puertas por zona');
                    }
                    var line = (mi + 1) + '. ' + typeName + ' \u2014 ' + mLabel;
                    if (zoneSummary.length > 0)
                        line += ' (' + zoneSummary.join(', ') + ')';
                    doc.setTextColor(40, 40, 40);
                    doc.setFont('helvetica', 'bold');
                    doc.text((mi + 1) + '. ' + typeName, margin, bottomY);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(80, 80, 80);
                    doc.text(' \u2014 ' + mLabel + (zoneSummary.length > 0 ? ' (' + zoneSummary.join(', ') + ')' : ''), margin + doc.getTextWidth((mi + 1) + '. ' + typeName), bottomY);
                    bottomY += 3.5;
                });
                // Legend
                bottomY += 2;
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);
                var legItems = [
                {
                    c: zColors.cajones,
                    l: 'Cajones'
                }, {
                    c: zColors.colgador,
                    l: 'Colgador'
                },
                {
                    c: zColors.zapatero,
                    l: 'Zapatero'
                }, {
                    c: zColors.entrepa,
                    l: 'Entrepa\u00f1os'
                },
                {
                    c: zColors.techo,
                    l: 'Techo/Piso'
                }, {
                    c: zColors.maletero,
                    l: 'Maletero'
                },
                {
                    c: zColors.zoclo,
                    l: 'Zoclo'
                }
                ];
                var legX = margin;
                legItems.forEach(function(li) {
                    doc.setFillColor(li.c[0], li.c[1], li.c[2]);
                    doc.rect(legX, bottomY - 2, 3, 2.5, 'F');
                    doc.text(li.l, legX + 4, bottomY);
                    legX += 25;
                });
                doc.text('Espesor: ' + EP.thickness + 'mm \u00b7 Prof: ' + estProjDepth() + 'cm \u00b7 Total: ' + modules.length + ' m\u00f3dulo' + (modules.length > 1 ? 's' : ''), margin, bottomY + 4);
            }
        }

        // CUSTOMIZE: Client PDF — black & white Excel-style layout
        function genClientPDF(optProject, optCalc) {
            if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado. Verifica tu conexion a internet.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                P = optProject || S.project,
                c = optCalc || calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var black = [0, 0, 0];
            var white = [255, 255, 255];
            var pw = 215.9, ph = 279.4, margin = 15, cw = pw - margin * 2;
            var y = margin;

            // === COVER PAGE (cocina only) ===
            if (P.type === 'cocina') {
                // Full-page dark background
                doc.setFillColor(13, 13, 13); // #0d0d0d matching client PDF dark theme
                doc.rect(0, 0, pw, ph, 'F');

                // Company logo centered at top
                var coverY = 50;
                if (S.logoBase64) {
                    try {
                        doc.addImage(S.logoBase64, 'PNG', (pw - 60) / 2, coverY, 60, 24);
                        coverY += 35;
                    } catch (e) { coverY += 10; }
                }

                // Company name
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(196, 154, 108); // #c49a6c gold accent
                doc.text(br.name.toUpperCase(), pw / 2, coverY, { align: 'center' });
                coverY += 15;

                // Decorative line
                doc.setDrawColor(196, 154, 108);
                doc.setLineWidth(0.5);
                doc.line(pw / 2 - 40, coverY, pw / 2 + 40, coverY);
                coverY += 20;

                // "COTIZACION DE COCINA" title
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('COTIZACION DE COCINA', pw / 2, coverY, { align: 'center' });
                coverY += 30;

                // Project info block
                doc.setFontSize(13);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(200, 200, 200);
                var infoLines = [
                    'Proyecto: ' + (P.name || 'Sin nombre'),
                    'Cliente: ' + (P.client || 'Sin cliente'),
                    'Fecha: ' + fmtDatePDF(),
                    'Cotizacion: ' + d.quoteNum,
                    'Modulos: ' + P.modules.length
                ];
                infoLines.forEach(function(ln) {
                    doc.text(ln, pw / 2, coverY, { align: 'center' });
                    coverY += 8;
                });

                // Footer with contact info
                doc.setFontSize(9);
                doc.setTextColor(120, 120, 120);
                var contactLine = br.contact || '';
                if (contactLine) {
                    doc.text(contactLine, pw / 2, ph - 20, { align: 'center' });
                }

                // Add new page for the actual quote content
                doc.addPage();
                y = margin; // Reset y position for quote page
            }

            // === PAGE 1: QUOTE ===

            // 1. Title bar — full-width black rect with brand name
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 14, 'F');
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            if (S.logoBase64) {
                try { doc.addImage(S.logoBase64, 'PNG', margin + 2, y + 1, 30, 12); } catch (e) {}
                doc.text(br.name.toUpperCase(), margin + 35, y + 10);
            } else {
                doc.text(br.name.toUpperCase(), margin + 6, y + 10);
            }
            y += 14;

            // 2. Info row — black bg: Fecha left, Cotizacion right
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('Fecha: ' + fmtDatePDF(), margin + 4, y + 5.5);
            doc.text('Cotizacion: ' + d.quoteNum, margin + cw - 4, y + 5.5, { align: 'right' });
            y += 8;

            // 3. Cliente row — white bg
            doc.setFillColor(white[0], white[1], white[2]);
            doc.setDrawColor(black[0], black[1], black[2]);
            doc.setLineWidth(0.3);
            doc.rect(margin, y, cw, 8, 'FD');
            doc.setFontSize(10);
            doc.setTextColor(black[0], black[1], black[2]);
            doc.setFont('helvetica', 'normal');
            doc.text('Cliente:', margin + 4, y + 5.5);
            doc.setFont('helvetica', 'bold');
            doc.text(d.client || '', margin + 28, y + 5.5);
            y += 8;

            // 4. Proyecto row — black bg
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(10);
            doc.setTextColor(white[0], white[1], white[2]);
            doc.setFont('helvetica', 'normal');
            doc.text('Proyecto:', margin + 4, y + 5.5);
            doc.setFont('helvetica', 'bold');
            doc.text(d.projectName || '', margin + 30, y + 5.5);
            y += 8;

            // 5. Intro text — black bg
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('A continuacion remito la propuesta economica para su proyecto de muebles a la medida.', margin + 4, y + 5.5);
            y += 10;

            // 6. Item table using autoTable
            var itemTotal = d.items.reduce(function(a, it) { return a + (it.price * (it.qty || 1)); }, 0);
            var tableBody = d.items.map(function(it) {
                var total = (it.price || 0) * (it.qty || 1);
                return [
                    it.desc || it.name || '',
                    '$' + Math.round(it.price || 0).toLocaleString('es-MX'),
                    String(it.qty || 1),
                    '$' + Math.round(total).toLocaleString('es-MX')
                ];
            });

            doc.autoTable({
                startY: y,
                margin: { left: margin, right: margin },
                head: [['DESCRIPCION', 'PRECIO', 'CANT.', 'TOTAL']],
                body: tableBody,
                foot: [['TOTAL', '', '', '$' + Math.round(itemTotal).toLocaleString('es-MX')]],
                theme: 'plain',
                styles: {
                    fontSize: 8.5,
                    cellPadding: 3,
                    lineColor: black,
                    lineWidth: 0.3,
                    textColor: black
                },
                headStyles: {
                    fillColor: black,
                    textColor: white,
                    fontStyle: 'bold',
                    fontSize: 9
                },
                footStyles: {
                    fillColor: black,
                    textColor: white,
                    fontStyle: 'bold',
                    fontSize: 9
                },
                columnStyles: {
                    0: { cellWidth: cw * 0.50 },
                    1: { cellWidth: cw * 0.18, halign: 'right' },
                    2: { cellWidth: cw * 0.10, halign: 'center' },
                    3: { cellWidth: cw * 0.22, halign: 'right' }
                },
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });
            y = doc.lastAutoTable.finalY + 4;

            // 7. Totals section — right-aligned
            var roundedTotal = Math.round(itemTotal / 100) * 100;
            var iva = Math.round(roundedTotal * CONFIG.pricing.iva);
            var grandTotal = roundedTotal + iva;
            var totalsW = 80;
            var totalsX = margin + cw - totalsW;
            // Subtotal row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('SUBTOTAL', totalsX + 4, y + 5);
            doc.text('$' + roundedTotal.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 5, { align: 'right' });
            y += 7;
            // IVA row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 7, 'F');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%', totalsX + 4, y + 5);
            doc.text('$' + iva.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 5, { align: 'right' });
            y += 7;
            // Grand total row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 9, 'F');
            doc.setFontSize(11);
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('TOTAL', totalsX + 4, y + 6.5);
            doc.text('$' + grandTotal.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 6.5, { align: 'right' });
            y += 13;

            // 8. Legal terms
            if (y > 210) { doc.addPage(); y = margin; }
            var legalTerms = CONFIG.brand.legalTerms || CONFIG.quoting.terms.map(function(t) {
                return t.replace('{anticipo}', d.anticipo).replace('{deliveryTime}', d.deliveryTime);
            });
            doc.setTextColor(black[0], black[1], black[2]);
            legalTerms.forEach(function(t) {
                if (y > ph - 20) { doc.addPage(); y = margin; }
                if (!t || t.trim() === '') { y += 3; return; }
                if (t.trim().slice(-1) === ':') {
                    // Section header bar
                    y += 2;
                    doc.setFillColor(black[0], black[1], black[2]);
                    doc.rect(margin, y, cw, 7, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.setTextColor(white[0], white[1], white[2]);
                    doc.text(t, margin + 4, y + 5);
                    doc.setTextColor(black[0], black[1], black[2]);
                    y += 10;
                } else {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    var tLines = doc.splitTextToSize(t, cw - 8);
                    doc.text(tLines, margin + 4, y);
                    y += tLines.length * 3.8 + 2;
                }
            });
            if (d.notes) {
                y += 3;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('Nota: ' + d.notes, margin + 4, y);
                y += 6;
            }
            y += 6;

            // 9. Contact footer
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 0.5, 'F');
            y += 4;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(black[0], black[1], black[2]);
            doc.text('Encargado del proyecto: ' + CONTACT.name, margin + 4, y);
            y += 3.5;
            doc.text('Contacto: ' + CONTACT.cell + '  |  ' + CONTACT.email, margin + 4, y);

            // === PAGE 2: MATERIALES ===
            doc.addPage();
            y = margin;
            var matMargin = margin;

            // Header
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 12, 'F');
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('MATERIALES', matMargin + 6, y + 8.5);
            y += 12;

            // Project/Vendedor info row
            doc.setFillColor(white[0], white[1], white[2]);
            doc.setDrawColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'FD');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(black[0], black[1], black[2]);
            doc.text('Proyecto: ' + (d.projectName || '') + '  |  Cliente: ' + (d.client || '') + '  |  ' + d.quoteNum, matMargin + 4, y + 4.8);
            y += 9;

            // CARPINTERIA section
            var carpMultiplier = CONFIG.pricing.carpentryMultiplier;
            var carpBody = [];
            if (c.totalSheetsF > 0) {
                var sheetSaleF = Math.round(getMatPrice(P.matFrentes, P.thickness) * carpMultiplier);
                carpBody.push([
                    String(c.totalSheetsF),
                    'Hoja',
                    'Melamina ' + P.matFrentes.name + (P.matFrentes.finish ? ' ' + P.matFrentes.finish : '') + ' ' + P.thickness + 'mm',
                    P.matFrentes.brand || 'FINSA',
                    '$' + Math.round(c.totalSheetsF * sheetSaleF).toLocaleString('es-MX')
                ]);
            }
            if (c.useDual && c.totalSheetsI > 0) {
                var sheetSaleI = Math.round(getMatPrice(P.matInterior, P.thickness) * carpMultiplier);
                carpBody.push([
                    String(c.totalSheetsI),
                    'Hoja',
                    'Melamina ' + P.matInterior.name + (P.matInterior.finish ? ' ' + P.matInterior.finish : '') + ' ' + P.thickness + 'mm (Interior)',
                    P.matInterior.brand || 'FINSA',
                    '$' + Math.round(c.totalSheetsI * sheetSaleI).toLocaleString('es-MX')
                ]);
            }
            if (c.totalCanto > 0) {
                var chapSale = Math.round((c.chapCostF + c.chapCostI) * carpMultiplier);
                carpBody.push([
                    String(c.totalCanto),
                    'ML',
                    'Chapacanto ' + (CONFIG.pricing.defaultChapSpec || ''),
                    '',
                    '$' + chapSale.toLocaleString('es-MX')
                ]);
            }
            if (c.totalSheets > 0) {
                carpBody.push([
                    String(c.totalSheets),
                    'Hoja',
                    'Corte CNC',
                    '',
                    '$' + Math.round(c.corteCost * carpMultiplier).toLocaleString('es-MX')
                ]);
            }
            if (c.totalCanto > 0) {
                carpBody.push([
                    String(c.totalCanto),
                    'ML',
                    'Enchapado',
                    '',
                    '$' + Math.round(c.enchapCost * carpMultiplier).toLocaleString('es-MX')
                ]);
            }

            // Section header for CARPINTERIA
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('CARPINTERIA', matMargin + 4, y + 4.8);
            y += 8;

            if (carpBody.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: { left: matMargin, right: margin },
                    tableWidth: cw,
                    head: [['CANT.', 'UNIDAD', 'DESCRIPCION', 'MARCA', 'TOTAL']],
                    body: carpBody,
                    foot: [['TOTAL CARPINTERIA', '', '', '', '$' + Math.round(c.carpSale).toLocaleString('es-MX')]],
                    theme: 'plain',
                    styles: { fontSize: 8, cellPadding: 2.5, lineColor: black, lineWidth: 0.2, textColor: black },
                    headStyles: { fillColor: [220, 220, 220], textColor: black, fontStyle: 'bold' },
                    footStyles: { fillColor: black, textColor: white, fontStyle: 'bold', fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 14, halign: 'center' },
                        1: { cellWidth: 16, halign: 'center' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 24 },
                        4: { cellWidth: 35, halign: 'right' }
                    },
                    didParseCell: function(data) {
                        if (data.section === 'foot' && data.column.index === 0) {
                            data.cell.colSpan = 4;
                        }
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            }

            // Check if HERRAJES section fits, otherwise new page
            if (y > ph - 50) { doc.addPage(); y = margin; }

            // HERRAJES section
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('HERRAJES', matMargin + 4, y + 4.8);
            y += 8;

            var hwBody = [];
            c.allHW.forEach(function(hw) {
                var qty = Math.ceil(hw.qty);
                if (qty <= 0) return;
                var salePrice;
                if (hw._bucket === 'carp') {
                    salePrice = Math.round(hw.price * carpMultiplier);
                } else {
                    salePrice = Math.round(hw.price / (1 - CONFIG.pricing.premiumHardwareMargin));
                }
                hwBody.push([
                    String(qty),
                    'Pza',
                    hw.desc,
                    hw.marca || '',
                    '$' + Math.round(qty * salePrice).toLocaleString('es-MX')
                ]);
            });

            var hwSaleTotal = c.hwPremiumSale + (c.hwCostCarpBucket * carpMultiplier);
            if (hwBody.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: { left: matMargin, right: margin },
                    tableWidth: cw,
                    head: [['CANT.', 'UNIDAD', 'DESCRIPCION', 'MARCA', 'TOTAL']],
                    body: hwBody,
                    foot: [['TOTAL HERRAJES', '', '', '', '$' + Math.round(hwSaleTotal).toLocaleString('es-MX')]],
                    theme: 'plain',
                    styles: { fontSize: 8, cellPadding: 2.5, lineColor: black, lineWidth: 0.2, textColor: black },
                    headStyles: { fillColor: [220, 220, 220], textColor: black, fontStyle: 'bold' },
                    footStyles: { fillColor: black, textColor: white, fontStyle: 'bold', fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 14, halign: 'center' },
                        1: { cellWidth: 16, halign: 'center' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 24 },
                        4: { cellWidth: 35, halign: 'right' }
                    },
                    didParseCell: function(data) {
                        if (data.section === 'foot' && data.column.index === 0) {
                            data.cell.colSpan = 4;
                        }
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            } else {
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('(Sin herrajes)', matMargin + 4, y + 4);
                y += 10;
            }


            // === COCINA-SPECIFIC PAGES (client PDF) ===
            if (P.type === 'cocina') {
                // Module index page
                doc.addPage();
                y = margin;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Detalle de Modulos', margin, y + 6);
                y += 12;

                var modRows = P.modules.map(function(m, i) {
                    var modDef = MODS[m.type] || {};
                    return [
                        (i + 1) + '',
                        modDef.n || m.name,
                        m.width + ' cm',
                        (m.height || P.defaultHeight || 200) + ' cm',
                        (P.sameDepth ? (P.defaultDepth || 50) : (m.depth || P.defaultDepth || 50)) + ' cm',
                        (m.quantity || 1) + ''
                    ];
                });

                doc.autoTable({
                    startY: y,
                    head: [['#', 'Modulo', 'Ancho', 'Alto', 'Prof.', 'Cant.']],
                    body: modRows,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 9 },
                    bodyStyles: { fontSize: 8 },
                    columnStyles: { 0: { cellWidth: 10 } },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 8;

                // Despiece section
                if (y > ph - 60) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Despiece Completo', margin, y + 6);
                y += 12;

                var despRows = [];
                c.pieces.forEach(function(p) {
                    despRows.push([
                        p.mn || '',
                        p.n,
                        p.q + '',
                        p.w + ' mm',
                        p.h + ' mm',
                        (p.t || 15) + ' mm',
                        p.z === 'f' ? 'Frente' : 'Interior'
                    ]);
                });

                doc.autoTable({
                    startY: y,
                    head: [['Modulo', 'Pieza', 'Cant.', 'Ancho', 'Alto', 'Esp.', 'Material']],
                    body: despRows,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 8 },
                    bodyStyles: { fontSize: 7 },
                    columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 30 } },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 8;

                // Hardware summary
                if (y > ph - 60) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Resumen de Herrajes', margin, y + 6);
                y += 12;

                var hwRows = [];
                c.allHW.forEach(function(hw) {
                    hwRows.push([
                        hw.desc,
                        hw.marca || '',
                        Math.ceil(hw.qty) + '',
                        fmtD(hw.price),
                        fmtD(Math.ceil(hw.qty) * hw.price)
                    ]);
                });

                if (hwRows.length > 0) {
                    doc.autoTable({
                        startY: y,
                        head: [['Herraje', 'Marca', 'Cant.', 'Precio Unit.', 'Total']],
                        body: hwRows,
                        theme: 'grid',
                        headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 8 },
                        bodyStyles: { fontSize: 7 },
                        margin: { left: margin, right: margin }
                    });
                    y = doc.lastAutoTable.finalY + 8;
                }

                // Extras
                var hasExtras = P.modules.some(function(m) {
                    return m.type === 'zoclo' || m.type === 'vistaLateral' || m.type === 'panelRelleno' || m.type === 'cubierta';
                });
                if (hasExtras) {
                    if (y > ph - 50) { doc.addPage(); y = margin; }
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Extras y Acabados', margin, y + 6);
                    y += 12;

                    var extRows = [];
                    P.modules.forEach(function(m) {
                        if (m.type === 'zoclo' || m.type === 'vistaLateral' || m.type === 'panelRelleno' || m.type === 'cubierta') {
                            var desc = MODS[m.type] ? MODS[m.type].n : m.name;
                            if (m.type === 'cubierta') desc += ' (' + (m.cubiertaType || 'postformado') + ')';
                            extRows.push([desc, m.width + ' cm', (m.quantity || 1) + '']);
                        }
                    });

                    doc.autoTable({
                        startY: y,
                        head: [['Extra', 'Medida', 'Cant.']],
                        body: extRows,
                        theme: 'grid',
                        headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 9 },
                        bodyStyles: { fontSize: 8 },
                        margin: { left: margin, right: margin }
                    });
                    y = doc.lastAutoTable.finalY + 8;
                }

                // Technical note
                if (y > ph - 40) { doc.addPage(); y = margin; }
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Nota Tecnica', margin, y + 5);
                y += 8;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var techNote = 'Modulos fabricados en melamina 15mm con cantos sellados. Herrajes Blum importados con garantia. Instalacion incluye nivelacion con patas regulables, anclaje de alacenas a muro, y verificacion de escuadra. Cubierta cotizada por separado segun material seleccionado. Saque trasero de 100mm obligatorio en modulos de horno para ventilacion.';
                var splitNote = doc.splitTextToSize(techNote, cw);
                doc.text(splitNote, margin, y);
                y += splitNote.length * 4 + 4;
            } // end if cocina (client PDF)

            // Plano page
            addPlanoPage(doc, margin);

            // Save
            var fname = d.quoteNum + '-Cotizacion-' + (d.client || 'Cliente').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
            // Increment counter
            S.quoteCounter++;
            try {
                localStorage.setItem(CONFIG.storage.prefix + 'quote_counter', S.quoteCounter);
            } catch (e) {}
        }

        function genInternalPDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                c = calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            var red = [220, 38, 38];
            var pw = 215.9,
                margin = 20;
            var y = margin;

            // === COVER PAGE (cocina internal) ===
            if (S.project.type === 'cocina') {
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('COTIZACION INTERNA - COCINA', pw / 2, 30, { align: 'center' });
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Proyecto: ' + (S.project.name || ''), pw / 2, 42, { align: 'center' });
                doc.text('Cliente: ' + (S.project.client || ''), pw / 2, 50, { align: 'center' });
                doc.text('Fecha: ' + new Date().toLocaleDateString('es-MX'), pw / 2, 58, { align: 'center' });
                doc.text('Modulos: ' + S.project.modules.length, pw / 2, 66, { align: 'center' });
                doc.addPage();
                y = margin;
            }

            // Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text(br.name + ' - DESGLOSE DE COSTOS', margin, y + 6);
            y += 12;
            // Red banner
            doc.setFillColor(red[0], red[1], red[2]);
            doc.rect(margin, y, pw - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('CONFIDENCIAL - NO COMPARTIR CON CLIENTE', pw / 2, y + 5.5, {
                align: 'center'
            });
            y += 12;
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(d.quoteNum + ' | ' + fmtDatePDF() + ' | Cliente: ' + (d.client || ''), margin, y);
            y += 8;
            // Cost breakdown table
            var tableData = [];
            // Carpinteria section
            tableData.push([{
                content: 'CARPINTERIA (x' + CONFIG.pricing.carpentryMultiplier + ')',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            if (c.totalSheetsF > 0)
                tableData.push(['Mat. Frentes (' + c.totalSheetsF + ' hojas)', '', '$' + Math.round(c.matCostF).toLocaleString('es-MX'), '']);
            if (c.useDual && c.totalSheetsI > 0)
                tableData.push(['Mat. Interior (' + c.totalSheetsI + ' hojas)', '', '$' + Math.round(c.matCostI).toLocaleString('es-MX'), '']);
            tableData.push(['Chapacanto', c.totalCanto + ' ml', '$' + Math.round(c.chapCostF + c.chapCostI).toLocaleString('es-MX'), '']);
            tableData.push(['Corte', c.totalSheets + ' hojas', '$' + Math.round(c.corteCost).toLocaleString('es-MX'), '']);
            tableData.push(['Enchapado', c.totalCanto + ' ml', '$' + Math.round(c.enchapCost).toLocaleString('es-MX'), '']);
            tableData.push(['Mano de obra', '', '$' + Math.round(S.project.laborCost).toLocaleString('es-MX'), '']);
            tableData.push([{
                content: 'Subtotal carpinteria',
                styles: {
                    fontStyle: 'bold'
                }
            }, '', '$' + Math.round(c.carpCost).toLocaleString('es-MX'), '$' + Math.round(c.carpSale).toLocaleString('es-MX')]);
            // Herrajes — carpentry bucket
            tableData.push([{
                content: 'HERRAJES EN CARPINTERIA (\u2264$' + CONFIG.pricing.hardwareThreshold + ')',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            var hasCarpHW = false;
            c.allHW.forEach(function(hw) {
                if (hw._bucket !== 'carp') return;
                hasCarpHW = true;
                tableData.push([hw.desc + ' (' + hw.marca + ')', Math.ceil(hw.qty), '$' + Math.round(Math.ceil(hw.qty) * hw.price).toLocaleString('es-MX'), '']);
            });
            if (!hasCarpHW)
                tableData.push(['(ninguno)', '', '$0', '']);
            tableData.push([{
                content: 'Subtotal herrajes (en carp.)',
                styles: { fontStyle: 'bold' }
            }, '', '$' + Math.round(c.hwCostCarpBucket).toLocaleString('es-MX'), '(incl. en carp.)']);
            // Premium hardware
            tableData.push([{
                content: 'HERRAJES PREMIUM (>$' + CONFIG.pricing.hardwareThreshold + ', ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            var hasPremHW = false;
            c.allHW.forEach(function(hw) {
                if (hw._bucket !== 'premium') return;
                hasPremHW = true;
                tableData.push([hw.desc + ' (' + hw.marca + ')', Math.ceil(hw.qty), '$' + Math.round(Math.ceil(hw.qty) * hw.price).toLocaleString('es-MX'), '']);
            });
            if (!hasPremHW)
                tableData.push(['(ninguno)', '', '$0', '$0']);
            tableData.push([{
                content: 'Subtotal premium',
                styles: { fontStyle: 'bold' }
            }, '', '$' + Math.round(c.hwCostPremium).toLocaleString('es-MX'), '$' + Math.round(c.hwPremiumSale).toLocaleString('es-MX')]);
            // Extras
            if (c.extraCost > 0) {
                tableData.push([{
                    content: 'EXTRAS (x' + CONFIG.pricing.extrasMultiplier + ')',
                    colSpan: 4,
                    styles: {
                        fillColor: [200, 200, 200],
                        fontStyle: 'bold',
                        fontSize: 9
                    }
                }]);
                if (c.ledBOM) {
                    tableData.push([{
                        content: 'LED BOM (' + c.ledBOM.totalMeters.toFixed(1) + 'm, ' + c.ledBOM.totalSegments + ' seg, ' + c.ledBOM.alimentadorW + 'W)',
                        colSpan: 4,
                        styles: {
                            fontStyle: 'bold',
                            fontSize: 8,
                            textColor: [180, 140, 50]
                        }
                    }]);
                    c.ledBOM.items.forEach(function(it) {
                        tableData.push([it.desc, it.qty, '$' + Math.round(it.total).toLocaleString('es-MX'), '']);
                    });
                    tableData.push([{
                        content: 'Subtotal LED',
                        styles: {
                            fontStyle: 'bold'
                        }
                    }, '', '$' + Math.round(c.ledBOM.totalCost).toLocaleString('es-MX'), '']);
                }
                if (S.project.glass)
                    tableData.push(['Vidrio ' + S.project.glassM2 + 'm2', '', '$' + Math.round(S.project.glassM2 * CONFIG.pricing.glassCostPerM2).toLocaleString('es-MX'), '']);
                if (c.paintCost > 0) {
                    S.project.modules.forEach(function(m2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'custom',
                                defaultHeight: S.project.defaultHeight,
                                defaultDepth: S.project.defaultDepth
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                tableData.push(['Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' (' + lit.toFixed(1) + 'L)', '', '$' + Math.round(lit * m2.paint.pricePerLiter).toLocaleString('es-MX'), '']);
                        }
                    });
                }
                tableData.push([{
                    content: 'Subtotal extras',
                    styles: {
                        fontStyle: 'bold'
                    }
                }, '', '$' + Math.round(c.extraCost).toLocaleString('es-MX'), '$' + Math.round(c.extrasSale).toLocaleString('es-MX')]);
            }
            doc.autoTable({
                startY: y,
                margin: {
                    left: margin,
                    right: margin
                },
                head: [['Concepto', 'Cant.', 'Costo', 'Venta']],
                body: tableData,
                headStyles: {
                    fillColor: dark,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                bodyStyles: {
                    fontSize: 8,
                    textColor: dark
                },
                columnStyles: {
                    0: {
                        cellWidth: 80
                    },
                    1: {
                        cellWidth: 25
                    },
                    2: {
                        cellWidth: 35,
                        halign: 'right'
                    },
                    3: {
                        cellWidth: 35,
                        halign: 'right'
                    }
                },
                alternateRowStyles: {
                    fillColor: [250, 248, 245]
                }
            });
            y = doc.lastAutoTable.finalY + 8;

            // === COCINA-SPECIFIC PAGES (internal PDF) ===
            var intP = S.project;
            var intPh = 279.4;
            var intCw = pw - margin * 2;
            if (intP.type === 'cocina') {
                // Module index table with costs
                doc.addPage();
                y = margin;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(dark[0], dark[1], dark[2]);
                doc.text('Detalle de Modulos (Interno)', margin, y + 6);
                y += 12;

                var modRowsInt = intP.modules.map(function(m, i) {
                    var modDef = MODS[m.type] || {};
                    var modCost = 0;
                    if (c.perModule && c.perModule[m.id]) {
                        modCost = c.perModule[m.id].total || 0;
                    }
                    return [
                        (i + 1) + '',
                        modDef.n || m.name,
                        m.width + ' cm',
                        (m.height || intP.defaultHeight || 200) + ' cm',
                        (m.quantity || 1) + '',
                        fmtD(modCost),
                        fmtD(modCost * (CONFIG.pricing.margin || 0.30))
                    ];
                });

                doc.autoTable({
                    startY: y,
                    head: [['#', 'Modulo', 'Ancho', 'Alto', 'Cant.', 'Costo', 'Margen']],
                    body: modRowsInt,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 8 },
                    bodyStyles: { fontSize: 7 },
                    columnStyles: { 0: { cellWidth: 8 }, 5: { halign: 'right' }, 6: { halign: 'right' } },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 8;

                // Hardware detail (internal)
                if (y > intPh - 60) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(dark[0], dark[1], dark[2]);
                doc.text('Herrajes Detalle (Interno)', margin, y + 6);
                y += 12;

                var hwRowsInt = [];
                var hwTotalCost = 0;
                c.allHW.forEach(function(hw) {
                    var qty = Math.ceil(hw.qty);
                    var unitP = hw.price || 0;
                    var total = qty * unitP;
                    var bucket = (unitP <= (CONFIG.pricing.hwPremiumThreshold || 500)) ? 'Carpinteria' : 'Premium';
                    hwTotalCost += total;
                    hwRowsInt.push([
                        hw.desc,
                        hw.marca || '',
                        qty + '',
                        fmtD(unitP),
                        fmtD(total),
                        bucket
                    ]);
                });

                if (hwRowsInt.length > 0) {
                    doc.autoTable({
                        startY: y,
                        head: [['Herraje', 'Marca', 'Cant.', 'P. Unit.', 'Total', 'Tipo']],
                        body: hwRowsInt,
                        theme: 'grid',
                        headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 8 },
                        bodyStyles: { fontSize: 7 },
                        columnStyles: { 3: { halign: 'right' }, 4: { halign: 'right' } },
                        margin: { left: margin, right: margin }
                    });
                    y = doc.lastAutoTable.finalY + 4;

                    // Hardware total row
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(dark[0], dark[1], dark[2]);
                    doc.text('Total Herrajes: ' + fmtD(hwTotalCost), margin, y + 4);
                    y += 10;
                }

                // Category cost summary (internal)
                if (y > intPh - 50) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(dark[0], dark[1], dark[2]);
                doc.text('Resumen por Categoria (Interno)', margin, y + 6);
                y += 12;

                var catRows = [
                    ['Casco (interior + canto)', fmtD(c.cascoCost || 0)],
                    ['Frente (visible + canto)', fmtD(c.frenteCost || 0)],
                    ['Herrajes', fmtD(c.herrajesCost || 0)],
                    ['Extras', fmtD(c.extrasCost || 0)]
                ];

                doc.autoTable({
                    startY: y,
                    head: [['Categoria', 'Costo']],
                    body: catRows,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 9 },
                    bodyStyles: { fontSize: 8 },
                    columnStyles: { 1: { halign: 'right' } },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 8;
            } // end if cocina (internal PDF)

            // Summary box
            if (y > 230) {
                doc.addPage();
                y = margin;
            }
            doc.setFillColor(245, 240, 235);
            doc.rect(margin, y, pw - margin * 2, 40, 'F');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('RESUMEN DE RENTABILIDAD', margin + 5, y + 7);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Costo total:', margin + 5, y + 15);
            doc.text('$' + Math.round(c.totalCost).toLocaleString('es-MX'), margin + 70, y + 15);
            doc.text('Precio venta:', margin + 5, y + 21);
            doc.text('$' + Math.round(c.subtotal).toLocaleString('es-MX'), margin + 70, y + 21);
            doc.text('Utilidad bruta:', margin + 5, y + 27);
            doc.text('$' + Math.round(c.profit).toLocaleString('es-MX'), margin + 70, y + 27);
            doc.setFont('helvetica', 'bold');
            doc.text('Margen real:', margin + 5, y + 33);
            doc.text(c.margin + '%', margin + 70, y + 33);
            // Save
            var fname = d.quoteNum + '-Desglose-' + (d.client || 'Interno').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
        }

        function genEstInternalPDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var EP = S.estProject,
                c = calcEstandarizado(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var d = S.estPdfData || {
                quoteNum: '',
                client: EP.client
            };
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            var red = [220, 38, 38];
            var pw = 215.9,
                margin = 20;
            var y = margin;
            // Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text(br.name + ' - DESGLOSE DE COSTOS', margin, y + 6);
            y += 12;
            // Red banner
            doc.setFillColor(red[0], red[1], red[2]);
            doc.rect(margin, y, pw - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('CONFIDENCIAL - NO COMPARTIR CON CLIENTE', pw / 2, y + 5.5, {
                align: 'center'
            });
            y += 12;
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text((d.quoteNum || '') + ' | ' + fmtDatePDF() + ' | Cliente: ' + (d.client || EP.client || ''), margin, y);
            y += 5;
            var pdfProjName = EP.mode === 'custom' ? 'Proyecto Personalizado' : 'Closet Estandarizado';
            doc.text(pdfProjName + ' | ' + c.totalSheets + ' hojas | ' + c.totalCanto + ' ml chapacanto', margin, y);
            y += 8;
            // Despiece table — merge pieces with same name + dimensions
            var merged = {};
            c.pieces.forEach(function(p) {
                var al = anchoLargo(p.w, p.h);
                var key = p.n + '|' + al.ancho + 'x' + al.largo + '|' + p.t;
                if (!merged[key])
                    merged[key] = {
                        n: p.n,
                        q: 0,
                        medida: al.ancho + 'x' + al.largo,
                        t: p.t
                    };
                merged[key].q += p.q;
            });
            var despData = [];
            Object.keys(merged).forEach(function(k) {
                var m2 = merged[k];
                despData.push([m2.n, m2.q, m2.medida, m2.t + 'mm']);
            });
            doc.autoTable({
                startY: y,
                margin: {
                    left: margin,
                    right: margin
                },
                head: [['Pieza', 'Qty', 'Medida (mm)', 'Esp.']],
                body: despData,
                headStyles: {
                    fillColor: dark,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 8
                },
                bodyStyles: {
                    fontSize: 7,
                    textColor: dark
                },
                columnStyles: {
                    0: {
                        cellWidth: 65
                    },
                    1: {
                        cellWidth: 15,
                        halign: 'center'
                    },
                    2: {
                        cellWidth: 40
                    },
                    3: {
                        cellWidth: 18,
                        halign: 'center'
                    }
                },
                alternateRowStyles: {
                    fillColor: [250, 248, 245]
                }
            });
            y = doc.lastAutoTable.finalY + 6;
            // Cost breakdown table
            if (y > 200) {
                doc.addPage();
                y = margin;
            }
            var tableData = [];
            var pdfMatF = EP.matFrentes.brand === 'CUSTOM' ? (EP.matFrentes.name || 'Personalizado') : EP.matFrentes.brand + ' ' + EP.matFrentes.name;
            var pdfMatI = EP.matInterior.brand === 'CUSTOM' ? (EP.matInterior.name || 'Personalizado') : EP.matInterior.brand + ' ' + EP.matInterior.name;
            tableData.push([{
                content: 'CARPINTERIA',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            var pdfTK = c.projThickness || 16;
            if (c.totalSheetsF > 0)
                tableData.push([pdfMatF + ' ' + pdfTK + 'mm (' + c.totalSheetsF + ' hojas x $' + Math.round(c.matPriceF).toLocaleString('es-MX') + ')', c.totalSheetsF, '$' + Math.round(c.totalSheetsF * c.matPriceF).toLocaleString('es-MX'), '']);
            if (c.useDual && c.totalSheetsI > 0)
                tableData.push([pdfMatI + ' ' + pdfTK + 'mm (' + c.totalSheetsI + ' hojas x $' + Math.round(c.matPriceI).toLocaleString('es-MX') + ')', c.totalSheetsI, '$' + Math.round(c.totalSheetsI * c.matPriceI).toLocaleString('es-MX'), '']);
            tableData.push(['Chapacanto', c.totalCanto + ' ml', '$' + Math.round(c.chapCostF + c.chapCostI).toLocaleString('es-MX'), '']);
            tableData.push(['Corte', c.totalSheets + ' hojas', '$' + Math.round(c.corteCost).toLocaleString('es-MX'), '']);
            tableData.push(['Enchapado', c.totalCanto + ' ml', '$' + Math.round(c.enchapCost).toLocaleString('es-MX'), '']);
            tableData.push(['Mano de obra', '', '$' + Math.round(EP.laborCost).toLocaleString('es-MX'), '']);
            tableData.push([{
                content: 'Subtotal carpinteria',
                styles: {
                    fontStyle: 'bold'
                }
            }, '', '$' + Math.round(c.carpCost).toLocaleString('es-MX'), '']);
            tableData.push([{
                content: 'HERRAJES',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            c.allHW.forEach(function(hw) {
                tableData.push([hw.desc + ' (' + hw.marca + ')', Math.ceil(hw.qty), '$' + Math.round(Math.ceil(hw.qty) * hw.price).toLocaleString('es-MX'), '']);
            });
            tableData.push([{
                content: 'Subtotal herrajes',
                styles: {
                    fontStyle: 'bold'
                }
            }, '', '$' + Math.round(c.hwCostCarpBucket + c.hwCostPremium).toLocaleString('es-MX'), '']);
            if (c.extraCost > 0) {
                tableData.push([{
                    content: 'EXTRAS',
                    colSpan: 4,
                    styles: {
                        fillColor: [200, 200, 200],
                        fontStyle: 'bold',
                        fontSize: 9
                    }
                }]);
                if (c.ledBOM) {
                    c.ledBOM.items.forEach(function(it) {
                        tableData.push([it.desc, it.qty, '$' + Math.round(it.total).toLocaleString('es-MX'), '']);
                    });
                }
                if (c.vidrioCost > 0) {
                    tableData.push(['Vidrio (cotizacion externa)', '', '$' + Math.round(c.vidrioCost).toLocaleString('es-MX'), '']);
                }
                if (c.paintCost > 0) {
                    EP.modules.forEach(function(m2, mi2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'est'
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                tableData.push(['Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' Mod ' + (mi2 + 1) + ' (' + lit.toFixed(1) + 'L)', '', '$' + Math.round(lit * m2.paint.pricePerLiter).toLocaleString('es-MX'), '']);
                        }
                    });
                }
                tableData.push([{
                    content: 'Subtotal extras',
                    styles: {
                        fontStyle: 'bold'
                    }
                }, '', '$' + Math.round(c.extraCost).toLocaleString('es-MX'), '']);
            }
            doc.autoTable({
                startY: y,
                margin: {
                    left: margin,
                    right: margin
                },
                head: [['Concepto', 'Cant.', 'Costo', '']],
                body: tableData,
                headStyles: {
                    fillColor: dark,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                bodyStyles: {
                    fontSize: 8,
                    textColor: dark
                },
                columnStyles: {
                    0: {
                        cellWidth: 80
                    },
                    1: {
                        cellWidth: 25
                    },
                    2: {
                        cellWidth: 35,
                        halign: 'right'
                    },
                    3: {
                        cellWidth: 35,
                        halign: 'right'
                    }
                },
                alternateRowStyles: {
                    fillColor: [250, 248, 245]
                }
            });
            y = doc.lastAutoTable.finalY + 8;
            // Summary box
            if (y > 230) {
                doc.addPage();
                y = margin;
            }
            doc.setFillColor(245, 240, 235);
            doc.rect(margin, y, pw - margin * 2, 46, 'F');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('RESUMEN DE RENTABILIDAD', margin + 5, y + 7);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Costo total:', margin + 5, y + 15);
            doc.text('$' + Math.round(c.totalCost).toLocaleString('es-MX'), margin + 70, y + 15);
            doc.text('Carp. x' + CONFIG.pricing.carpentryMultiplier + ' + HW ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%:', margin + 5, y + 21);
            doc.text('$' + Math.round(c.carpSale).toLocaleString('es-MX') + ' + $' + Math.round(c.hwPremiumSale || 0).toLocaleString('es-MX'), margin + 70, y + 21);
            doc.text('Precio venta:', margin + 5, y + 27);
            doc.text('$' + Math.round(c.subtotal).toLocaleString('es-MX'), margin + 70, y + 27);
            doc.text('Utilidad bruta:', margin + 5, y + 33);
            doc.text('$' + Math.round(c.profit).toLocaleString('es-MX'), margin + 70, y + 33);
            doc.setFont('helvetica', 'bold');
            doc.text('Margen real:', margin + 5, y + 39);
            doc.text(c.margin + '%', margin + 70, y + 39);
            // Plano page
            addPlanoPage(doc, margin);
            var fname = (d.quoteNum || CONFIG.quoting.prefix) + '-Desglose-' + (d.client || EP.client || 'Interno').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
        }

        function genDespiece() {
            if (typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                P = S.project,
                c = calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            var blue = [30, 58, 95];
            var pw = 215.9,
                margin = 15;
            var y = margin;
            // Header
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text(br.name + ' - DESPIECE / LISTA DE CORTE', margin, y + 5);
            y += 10;
            // Blue banner
            doc.setFillColor(blue[0], blue[1], blue[2]);
            doc.rect(margin, y, pw - margin * 2, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('DOCUMENTO PARA PROVEEDOR / TALLER — NO INCLUYE PRECIOS DE VENTA', pw / 2, y + 5, {
                align: 'center'
            });
            y += 11;
            doc.setTextColor(dark[0], dark[1], dark[2]);
            // Info row
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            var qnum = d ? d.quoteNum : getQuoteNum();
            doc.text(qnum + ' | ' + fmtDatePDF() + ' | Cliente: ' + (d && d.client ? d.client : P.client || ''), margin, y);
            y += 5;
            doc.text('Proyecto: ' + (d && d.projectName ? d.projectName : ''), margin, y);
            y += 6;
            // Material info
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('MATERIALES', margin, y);
            y += 5;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Frentes: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + (P.matFrentes.finish ? ' (' + P.matFrentes.finish + ')' : ''), margin, y);
            y += 4;
            if (c.useDual) {
                doc.text('Interior: ' + P.matInterior.brand + ' ' + P.matInterior.name + (P.matInterior.finish ? ' (' + P.matInterior.finish + ')' : ''), margin, y);
                y += 4;
            }
            if (P.chapSpec) {
                doc.text('Chapacanto: ' + P.chapSpec, margin, y);
                y += 4;
            }
            y += 2;
            // Sheet summary
            doc.setFillColor(240, 238, 233);
            doc.rect(margin, y, pw - margin * 2, c.useDual ? 22 : 14, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            var sx = margin + 3;
            doc.text('RESUMEN HOJAS: ' + c.totalSheets + ' hojas | CANTO: ' + c.totalCanto + ' ml', sx, y + 5);
            if (c.useDual) {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var pTK = c.projThickness || 16;
                var fLine = 'FRENTES: ' + pTK + 'mm=' + c.totalSheetsF + ' | Canto: ' + c.cantoF + ' ml';
                doc.text(fLine, sx, y + 10);
                var iLine = 'INTERIOR: ' + pTK + 'mm=' + c.totalSheetsI + ' | Canto: ' + c.cantoI + ' ml';
                doc.text(iLine, sx, y + 15);
                y += 25;
            } else {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var pTK2 = c.projThickness || 16;
                var sAllSheets = c.totalSheetsF + c.totalSheetsI;
                var aLine = pTK2 + 'mm: ' + sAllSheets + ' hojas  ';
                doc.text(aLine, sx, y + 10);
                y += 17;
            }
            // Cut list table per module
            P.modules.forEach(function(m) {
                var pcs = c.pieces.filter(function(p) {
                    return p.mid === m.id;
                });
                if (pcs.length === 0)
                    return;
                // Check page space
                if (y > 240) {
                    doc.addPage();
                    y = margin;
                }
                // Module header
                doc.setFillColor(accent[0], accent[1], accent[2]);
                doc.rect(margin, y, pw - margin * 2, 6, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                var mHdr = m.name + ' — ' + m.width + ' cm';
                if (m.height)
                    mHdr += ' x ' + m.height + ' cm';
                doc.text(mHdr, margin + 3, y + 4.3);
                y += 8;
                doc.setTextColor(dark[0], dark[1], dark[2]);
                // Pieces table — ancho x largo format with edits applied
                var tData = [];
                pcs.sort(function(a, b) {
                    var alA = anchoLargo(a.w, a.h),
                        alB = anchoLargo(b.w, b.h);
                    return alB.largo - alA.largo;
                });
                pcs.forEach(function(p) {
                    var al = anchoLargo(p.w, p.h);
                    var eKey = m.id + ':' + p.n;
                    var ep = S.editedPieces[eKey] || {};
                    var eq = typeof ep.q === 'number' ? ep.q : p.q;
                    var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                    var el2 = typeof ep.largo === 'number' ? ep.largo : al.largo;
                    var row = [p.n, String(eq), String(ea), String(el2), p.t + 'mm'];
                    if (c.useDual)
                        row.push(p.z === 'f' ? 'FRENTE' : 'INTERIOR');
                    tData.push(row);
                });
                var cols = c.useDual ? ['Pieza', 'Cant.', 'Ancho (mm)', 'Largo (mm)', 'Espesor', 'Zona'] : ['Pieza', 'Cant.', 'Ancho (mm)', 'Largo (mm)', 'Espesor'];
                doc.autoTable({
                    startY: y,
                    margin: {
                        left: margin,
                        right: margin
                    },
                    head: [cols],
                    body: tData,
                    headStyles: {
                        fillColor: [80, 80, 80],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: dark
                    },
                    alternateRowStyles: {
                        fillColor: [250, 248, 245]
                    },
                    columnStyles: c.useDual ? {
                        0: {
                            cellWidth: 40
                        },
                        1: {
                            cellWidth: 13
                        },
                        2: {
                            cellWidth: 25
                        },
                        3: {
                            cellWidth: 25
                        },
                        4: {
                            cellWidth: 18
                        },
                        5: {
                            cellWidth: 22
                        }
                    } : {
                        0: {
                            cellWidth: 50
                        },
                        1: {
                            cellWidth: 15
                        },
                        2: {
                            cellWidth: 28
                        },
                        3: {
                            cellWidth: 28
                        },
                        4: {
                            cellWidth: 20
                        }
                    },
                    theme: 'grid',
                    styles: {
                        cellPadding: 1.5,
                        lineWidth: 0.2,
                        lineColor: [180, 180, 180]
                    }
                });
                y = doc.lastAutoTable.finalY + 4;
            });
            // Hardware list
            if (y > 230) {
                doc.addPage();
                y = margin;
            }
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('HERRAJES', margin, y + 4);
            y += 7;
            var hwData = [];
            c.allHW.forEach(function(hw) {
                hwData.push([hw.desc, hw.marca, String(Math.ceil(hw.qty))]);
            });
            if (hwData.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: {
                        left: margin,
                        right: margin
                    },
                    head: [['Herraje', 'Marca', 'Cantidad']],
                    body: hwData,
                    headStyles: {
                        fillColor: [80, 80, 80],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: dark
                    },
                    alternateRowStyles: {
                        fillColor: [250, 248, 245]
                    },
                    columnStyles: {
                        0: {
                            cellWidth: 90
                        },
                        1: {
                            cellWidth: 30
                        },
                        2: {
                            cellWidth: 20
                        }
                    },
                    theme: 'grid',
                    styles: {
                        cellPadding: 1.5,
                        lineWidth: 0.2,
                        lineColor: [180, 180, 180]
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            } else {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('(Sin herrajes registrados)', margin, y);
                y += 6;
            }
            // Extras
            var dLedBOM = calcLedBOM();
            if (dLedBOM || P.glass) {
                if (y > 250) {
                    doc.addPage();
                    y = margin;
                }
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('EXTRAS', margin, y);
                y += 5;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                if (dLedBOM) {
                    doc.text('LED - ' + dLedBOM.totalMeters.toFixed(1) + 'm total, ' + dLedBOM.totalSegments + ' segmentos, ' + dLedBOM.alimentadorW + 'W', margin, y);
                    y += 4;
                    dLedBOM.items.forEach(function(it) {
                        doc.text('  ' + it.qty + 'x ' + it.desc, margin, y);
                        y += 3.5;
                    });
                    y += 1;
                }
                if (P.glass) {
                    doc.text('- Vidrio templado: ' + P.glassM2 + ' m2', margin, y);
                    y += 4;
                }
            }
            // Footer
            if (y > 255) {
                doc.addPage();
                y = margin;
            }
            y += 4;
            doc.setDrawColor(180, 180, 180);
            doc.line(margin, y, pw - margin, y);
            y += 5;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(120, 120, 120);
            doc.text('Generado por ' + br.name + ' | ' + CONTACT.name + ' | ' + CONTACT.cell + ' | ' + CONTACT.email, margin, y);
            // Save
            var fname = qnum + '-Despiece-' + (d && d.client ? d.client : 'Proveedor').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
        }

        // === V2.3: Estandarizado Render Functions ===
        function renderEstStepDots() {
            var steps = ['builder', 'editor', 'material', 'summary'];
            var labels = ['1', '2', '3', '4'];
            var ci = steps.indexOf(S.estScreen);
            var h = '<div class="est-step-dots">';
            steps.forEach(function(s, i) {
                var cls = i === ci ? 'active' : i < ci ? 'done' : 'future';
                h += '<button class="est-step-dot ' + cls + '" onclick="APP.estGoStep(\'' + s + '\')">' + labels[i] + '</button>';
                if (i < steps.length - 1)
                    h += '<div class="est-step-line' + (i < ci ? ' done' : '') + '"></div>';
            });
            h += '</div>';
            return h;
        }

        function renderEstSilhouette(m) {
            var mH = estModHeight(m);
            var h = '<div class="est-silhouette' + (m.type === 'esquinero' ? ' est-sil-esq' : '') + '">';
            var malS = m.maletero || {
                enabled: false
            };
            if (malS.enabled)
                h += '<div class="est-sil-zone est-sil-maletero" style="height:6px"></div>';
            if (m.type === 'panelTV') {
                h += '<div class="est-sil-zone" style="height:60px;background:linear-gradient(180deg,#555,#333);display:flex;align-items:center;justify-content:center;font-size:10px;color:#aaa">TV</div>';
            } else if (m.type === 'entrepanos') {
                var sc = m.shelfCount || 3;
                var secH = Math.max(4, Math.round(70 / (sc + 1)));
                for (var si = 0; si <= sc; si++) {
                    h += '<div class="est-sil-zone est-sil-entrepa" style="height:' + secH + 'px"></div>';
                    if (si < sc)
                        h += '<div style="height:2px;background:#c49a6c;width:100%"></div>';
                }
            } else {
                m.zones.forEach(function(z) {
                    var zh = getEstZoneDisplayHeight(m, z);
                    var pct = mH > 0 ? Math.max(4, Math.round(zh / mH * 70)) : 10;
                    h += '<div class="est-sil-zone est-sil-' + z.type + '" style="height:' + pct + 'px"></div>';
                });
            }
            var zoc = m.zoclo || {
                enabled: false
            };
            if (zoc.enabled)
                h += '<div class="est-sil-zone est-sil-zoclo" style="height:6px"></div>';
            h += '</div>';
            return h;
        }

        function renderEstBuilder() {
            var EP = S.estProject;
            var isCustom = EP.mode === 'custom';
            var titleText = isCustom ? 'Nuevo Proyecto' : 'Closet Estandarizado';
            var subtitleText = isCustom ? 'Configura los m\u00f3dulos del proyecto' : 'Configura los m\u00f3dulos del closet';
            var h = '<div class="title"><h2>' + titleText + '</h2><p>' + subtitleText + '</p></div>';
            h += '<div class="field"><label>Nombre del Cliente</label><input type="text" id="estClient" value="' + EP.client + '" placeholder="Ej: Juan P\u00e9rez" oninput="APP.estSetClient(this.value)"></div>';
            if (isCustom) {
                // Project type selector
                h += '<div class="field"><label>Tipo de Proyecto</label><div style="display:flex;gap:8px;flex-wrap:wrap">';
                TYPES.forEach(function(t) {
                    var sel = EP.projectType === t.id;
                    h += '<button style="flex:1;min-width:80px;padding:10px 8px;border-radius:12px;border:2px solid ' + (sel ? '#c49a6c' : '#3a3a3a') + ';background:' + (sel ? '#c49a6c22' : '#2a2a2a') + ';color:' + (sel ? '#c49a6c' : '#999') + ';cursor:pointer;font-size:13px;text-align:center" onclick="APP.estSetProjectType(\'' + t.id + '\')">' + t.i + '<br>' + t.n + '</button>';
                });
                h += '</div></div>';
            }
            // Depth toggle (always visible)
            h += '<div class="field"><label>Profundidad</label>';
            h += '<div class="mat-toggle-row" style="margin-bottom:8px"><span>Misma profundidad para todos</span><button class="toggle' + (EP.sameDepth ? ' on' : '') + '" onclick="APP.estTogSameDepth()"></button></div>';
            if (EP.sameDepth) {
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + EP.projectDepth + '" min="20" max="120" step="1" style="width:100px" onchange="APP.estSetProjectDepth(parseInt(this.value))"><span style="color:#bbb">cm — general para todo el proyecto</span></div>';
            } else {
                h += '<p class="hint">Cada m\u00f3dulo tendr\u00e1 su propia profundidad editable</p>';
            }
            h += '</div>';
            if (EP.modules.length === 0) {
                h += '<div class="empty" style="margin:16px 0">' + svg('pkg') + '<p>Agrega m\u00f3dulos para comenzar</p></div>';
            } else {
                h += '<div class="est-modules-row">';
                EP.modules.forEach(function(m, i) {
                    var typeLabel = m.type === 'esquinero' ? 'Esquinero' : m.type === 'especial' ? 'Especial' : m.type === 'fijo' ? 'Fijo' : m.type === 'panelTV' ? 'Panel TV' : m.type === 'torreLateral' ? 'Torre Lat.' : m.type === 'alacenaAlta' ? 'Alacena' : m.type === 'gabineteBase' ? 'Gab. Base' : m.type === 'cajonBase' ? 'Caj\u00f3n Base' : m.type === 'despensa' ? 'Despensa' : m.type === 'puerta' ? 'Puerta' : m.type === 'entrepa' ? 'Torre Ent.' : m.type === 'entrepanos' ? 'Entrepa\u00f1os' : m.zones.length + ' zona' + (m.zones.length !== 1 ? 's' : '');
                    h += '<div class="est-mod-card" onclick="APP.estEditMod(' + i + ')">';
                    h += '<button class="est-mod-del" onclick="event.stopPropagation();APP.estDelMod(' + i + ')">&times;</button>';
                    h += '<div class="est-mod-num">' + (i + 1) + '</div>';
                    h += renderEstSilhouette(m);
                    h += '<div class="est-mod-w">' + (m.type === 'esquinero' ? m.width + '\u00d7' + (m.width2 || m.width) : m.width) + 'cm</div>';
                    h += '<div class="est-mod-type" style="font-size:11px;color:#60a5fa">' + m.height + 'cm alto</div>';
                    if (!EP.sameDepth)
                        h += '<div class="est-mod-type" style="font-size:11px;color:#9ca3af">' + (m.depth || EP.projectDepth) + 'cm prof</div>';
                    h += '<div class="est-mod-type">' + typeLabel + '</div>';
                    h += '<div class="est-mod-arrows">';
                    if (i > 0)
                        h += '<button onclick="event.stopPropagation();APP.estMoveMod(' + i + ',-1)">&larr;</button>';
                    if (i < EP.modules.length - 1)
                        h += '<button onclick="event.stopPropagation();APP.estMoveMod(' + i + ',1)">&rarr;</button>';
                    h += '</div></div>';
                });
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'normal\')">' + svg('plus') + 'M\u00f3dulo</button>';
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'esquinero\')">' + svg('plus') + 'Esquinero</button>';
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'especial\')">' + svg('plus') + 'Especial</button>';
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'fijo\')">' + svg('plus') + 'Fijo</button>';
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'entrepa\')">' + svg('plus') + 'Torre Ent.</button>';
                h += '<button class="est-add-btn" onclick="APP.estAddMod(\'entrepanos\')">' + svg('plus') + 'Entrepa\u00f1os</button>';
                if (isCustom) {
                    h += '<button class="est-add-btn" onclick="APP.estAddMod(\'panelTV\')">' + svg('plus') + 'Panel TV</button>';
                    h += '<button class="est-add-btn" onclick="APP.estAddMod(\'torreLateral\')">' + svg('plus') + 'Torre Lat.</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'alacenaAlta\')">' + svg('plus') + 'Alacena Alta</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'gabineteBase\')">' + svg('plus') + 'Gab. Base</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'cajonBase\')">' + svg('plus') + 'Caj\u00f3n Base</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'despensa\')">' + svg('plus') + 'Despensa</button>';
                    h += '<button class="est-add-btn" style="border-color:#c49a6c44" onclick="APP.estAddMod(\'puerta\')">' + svg('plus') + 'Puerta</button>';
                }
                h += '</div>';
                var tw = EP.modules.reduce(function(a, m2) {
                    return a + m2.width;
                }, 0);
                h += '<div class="est-total-bar"><span>Ancho Total:</span><strong>' + tw + ' cm (' + (tw / 100).toFixed(2) + 'm)</strong></div>';
                h += '<button class="est-dup-btn" onclick="APP.estDuplicateModules()">' + svg('copy') + ' Duplicar Closet (x2)</button>';
            }
            if (EP.modules.length === 0) {
                h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin:16px 0">';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'normal\')">' + svg('plus') + 'M\u00f3dulo</button>';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'esquinero\')">' + svg('plus') + 'Esquinero</button>';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'especial\')">' + svg('plus') + 'Especial</button>';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'fijo\')">' + svg('plus') + 'Fijo</button>';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'entrepa\')">' + svg('plus') + 'Torre Ent.</button>';
                h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'entrepanos\')">' + svg('plus') + 'Entrepa\u00f1os</button>';
                if (isCustom) {
                    h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'panelTV\')">' + svg('plus') + 'Panel TV</button>';
                    h += '<button class="est-add-btn" style="flex:1" onclick="APP.estAddMod(\'torreLateral\')">' + svg('plus') + 'Torre Lat.</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'alacenaAlta\')">' + svg('plus') + 'Alacena Alta</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'gabineteBase\')">' + svg('plus') + 'Gab. Base</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'cajonBase\')">' + svg('plus') + 'Caj\u00f3n Base</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'despensa\')">' + svg('plus') + 'Despensa</button>';
                    h += '<button class="est-add-btn" style="flex:1;border-color:#c49a6c44" onclick="APP.estAddMod(\'puerta\')">' + svg('plus') + 'Puerta</button>';
                }
                h += '</div>';
            }
            return h;
        }

        function renderEstEditor() {
            var EP = S.estProject,
                idx = S.estEditIdx;
            if (idx < 0 || idx >= EP.modules.length)
                return '<p>Error: m\u00f3dulo no encontrado</p>';
            var m = EP.modules[idx];
            var isEsq = m.type === 'esquinero';
            var isEsp = m.type === 'especial';
            var isFijo = m.type === 'fijo';
            var isPanelTV = m.type === 'panelTV';
            var isTorre = m.type === 'torreLateral';
            var isAlacena = m.type === 'alacenaAlta';
            var isGabBase = m.type === 'gabineteBase';
            var isCajBase = m.type === 'cajonBase';
            var isDespensa = m.type === 'despensa';
            var isPuerta = m.type === 'puerta';
            var isEntrepanos = m.type === 'entrepanos';
            var isCustom = EP.mode === 'custom';
            var typeNames = { esquinero: 'Esquinero', especial: 'Especial', fijo: 'Fijo', panelTV: 'Panel TV', torreLateral: 'Torre Lateral', alacenaAlta: 'Alacena Alta', gabineteBase: 'Gabinete Base', cajonBase: 'Caj\u00f3n Base', despensa: 'Despensa', puerta: 'Puerta', entrepa: 'Torre de Ent.', entrepanos: 'Entrepa\u00f1os' };
            var typeSuffix = typeNames[m.type] ? ' (' + typeNames[m.type] + ')' : '';
            var h = '<div class="title"><h2>M\u00f3dulo ' + (idx + 1) + typeSuffix + '</h2></div>';
            // fijo: just ancho + alto, nothing else
            if (isFijo) {
                h += '<div class="field"><label>Ancho</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + m.width + '" min="5" max="300" step="1" style="width:80px" onchange="APP.estSetWidth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div></div>';
                h += '<div class="field"><label>Alto</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + m.height + '" min="5" max="300" step="1" style="width:80px" onchange="APP.estSetModHeight(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div></div>';
                h += '<div class="field"><p style="color:#999;font-size:14px">L\u00e1mina para tapar pijas \u2014 ' + m.width + 'cm \u00d7 ' + m.height + 'cm</p></div>';
                return h;
            }
            // Height selector (always editable)
            h += '<div class="field"><label>Alto del m\u00f3dulo</label>';
            h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + m.height + '" min="50" max="300" step="1" style="width:80px" onchange="APP.estSetModHeight(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div></div>';
            // Per-module depth (when sameDepth is off)
            if (!EP.sameDepth) {
                h += '<div class="field"><label>Profundidad</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + (m.depth || EP.projectDepth) + '" min="20" max="120" step="1" style="width:80px" onchange="APP.estSetModDepth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div></div>';
            }
            // Width selector — all modules use free input
            if (isEsq) {
                var w2 = m.width2 || m.width;
                h += '<div class="field"><label>Dimensiones (L-shape)</label>';
                h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="color:#bbb;min-width:50px">Lado A:</span><input type="number" value="' + m.width + '" min="10" max="300" step="1" style="width:80px" onchange="APP.estSetWidth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div>';
                h += '<div style="display:flex;align-items:center;gap:8px"><span style="color:#bbb;min-width:50px">Lado B:</span><input type="number" value="' + w2 + '" min="10" max="300" step="1" style="width:80px" onchange="APP.estSetWidth2(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div>';
                h += '<p class="hint">Esquinero en L &mdash; ' + m.width + 'cm &times; ' + w2 + 'cm &times; ' + estProjDepth() + 'cm prof.</p></div>';
            } else {
                h += '<div class="field"><label>Ancho</label>';
                h += '<div style="display:flex;align-items:center;gap:8px"><input type="number" value="' + m.width + '" min="10" max="300" step="1" style="width:80px" onchange="APP.estSetWidth(' + idx + ',parseInt(this.value))"><span style="color:#bbb">cm</span></div>';
                h += '</div>';
            }
            // panelTV has no zones
            if (isPanelTV) {
                h += '<div class="field"><p style="color:#999;font-size:14px">Panel plano \u2014 sin zonas internas. Incluye panel, travesa\u00f1os y fondo.</p></div>';
                h += renderEstHeightBar(m, idx);
                return h;
            }
            // puerta has no zones — just panel + optional marco
            if (isPuerta) {
                h += '<div class="field"><label>Marco</label>';
                h += '<div class="mat-toggle-row"><span>Incluir marco</span><button class="toggle' + (m.marco ? ' on' : '') + '" onclick="APP.estTogMarco(' + idx + ')"></button></div>';
                h += '<p class="hint">Puerta: ' + m.width + 'cm \u00d7 ' + m.height + 'cm' + (m.marco ? ' + marco' : '') + '</p></div>';
                h += renderEstHeightBar(m, idx);
                return h;
            }
            // Entrepaños module — shelf count selector, no zones
            if (isEntrepanos) {
                var sc = m.shelfCount || 3;
                var eu = estEspacioUtil(m);
                var spacing = sc > 0 ? (eu / (sc + 1)).toFixed(1) : eu.toFixed(1);
                h += '<div class="field"><label>Cantidad de entrepa\u00f1os</label>';
                h += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
                for (var sn = 1; sn <= 12; sn++) {
                    h += '<button class="opt-btn' + (sc === sn ? ' sel' : '') + '" onclick="APP.estSetShelfCount(' + idx + ',' + sn + ')">' + sn + '</button>';
                }
                h += '</div>';
                h += '<p class="hint">Espacio entre entrepa\u00f1os: ~' + spacing + ' cm (' + sc + ' repisas en ' + eu.toFixed(1) + 'cm \u00fatiles)</p>';
                h += '</div>';
                h += renderEstHeightBar(m, idx);
                return h;
            }
            // Zone stack (rendered bottom to top)
            h += '<div class="field"><label>Zonas (de abajo a arriba)</label>';
            for (var ri = m.zones.length - 1; ri >= 0; ri--) {
                var z = m.zones[ri],
                    zi = ri;
                var zt = EST_ZONE_TYPES.find(function(x) {
                    return x.id === z.type;
                });
                h += '<div class="est-zone">';
                h += '<div class="est-zone-hdr"><strong>' + (zt ? zt.n : z.type) + '</strong>';
                h += '<div class="est-zone-actions">';
                if (zi < m.zones.length - 1)
                    h += '<button onclick="APP.estMoveZone(' + idx + ',' + zi + ',1)">&uarr;</button>';
                if (zi > 0)
                    h += '<button onclick="APP.estMoveZone(' + idx + ',' + zi + ',-1)">&darr;</button>';
                h += '<button class="del" onclick="APP.estDelZone(' + idx + ',' + zi + ')">&times;</button>';
                h += '</div></div>';
                if (z.type === 'cajones') {
                    h += '<div class="est-zone-row"><span>Cantidad:</span><div style="display:flex;gap:6px">';
                    for (var n = 1; n <= 7; n++) {
                        h += '<button class="opt-btn' + ((z.count || 3) === n ? ' sel' : '') + '" onclick="APP.estSetZoneCount(' + idx + ',' + zi + ',' + n + ')">' + n + '</button>';
                    }
                    h += '</div></div>';
                    h += '<div class="est-zone-row"><span>Alto c/u:</span><select class="mat-select" style="width:auto;padding:8px" onchange="APP.estSetZoneHeight(' + idx + ',' + zi + ',parseInt(this.value))">';
                    EST_CAJON_HEIGHTS.forEach(function(ch) {
                        h += '<option value="' + ch + '"' + ((z.cajonHeight || 20) === ch ? ' selected' : '') + '>' + ch + ' cm</option>';
                    });
                    h += '</select></div>';
                } else if (z.type === 'colgador') {
                    var colgH = calcEstColgadorHeight(m, z);
                    h += '<div class="est-zone-row"><span>Tubo:</span><span style="color:#60a5fa">1 (sencillo)</span></div>';
                    h += '<div style="font-size:12px;color:#60a5fa;padding:4px 0">Altura auto: ' + colgH + ' cm (llena espacio restante)</div>';
                } else if (z.type === 'zapatero') {
                    h += '<div class="est-zone-row"><span>Cajones extra\u00edbles:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                    for (var n = 1; n <= 12; n++) {
                        h += '<button class="opt-btn' + ((z.repisas || 3) === n ? ' sel' : '') + '" onclick="APP.estSetZoneRepisas(' + idx + ',' + zi + ',' + n + ')">' + n + '</button>';
                    }
                    h += '</div></div>';
                    h += '<div class="est-zone-row"><span>Alto c/u:</span><select class="mat-select" style="width:auto;padding:8px" onchange="APP.estSetZoneRepisaHeight(' + idx + ',' + zi + ',parseInt(this.value))">';
                    EST_ZAPATERO_HEIGHTS.forEach(function(rh) {
                        h += '<option value="' + rh + '"' + ((z.repisaHeight || 15) === rh ? ' selected' : '') + '>' + rh + ' cm</option>';
                    });
                    h += '</select></div>';
                    h += '<div style="font-size:11px;color:#999;padding:2px 0">Frente visible: 5cm \u00b7 Resto abierto para zapatos</div>';
                } else if (z.type === 'entrepa') {
                    var maxE = isEsp ? 12 : 12;
                    h += '<div class="est-zone-row"><span>Cantidad:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                    for (var n = 1; n <= maxE; n++) {
                        h += '<button class="opt-btn' + ((z.count || 2) === n ? ' sel' : '') + '" onclick="APP.estSetZoneCount(' + idx + ',' + zi + ',' + n + ')">' + n + '</button>';
                    }
                    h += '</div></div>';
                    if (!isEsp) {
                        var entFree = calcEstFreeSpace(m);
                        if (entFree > 0) {
                            var entSecH = entFree / ((z.count || 2) + 1);
                            h += '<div style="font-size:12px;color:#60a5fa;padding:4px 0">Espacio libre: ' + entFree.toFixed(1) + ' cm \u00f7 ' + ((z.count || 2) + 1) + ' secciones = ' + entSecH.toFixed(1) + ' cm c/u (auto)</div>';
                        }
                    }
                }
                // Per-zone door toggle (only in por_zona mode)
                if ((m.doorMode || 'por_zona') === 'por_zona') {
                    h += '<div class="est-zone-row" style="margin-top:6px;border-top:1px solid #2a2a2a;padding-top:6px"><span>Puerta:</span>';
                    h += '<button class="opt-btn' + (z.doors ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoor(' + idx + ',' + zi + ',' + (!z.doors) + ')">' + svg(z.doors ? 'check' : 'plus') + ' Con puerta</button>';
                    h += '<button class="opt-btn' + (!z.doors ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoor(' + idx + ',' + zi + ',false)">Sin</button>';
                    h += '</div>';
                    if (z.doors) {
                        h += '<div class="est-zone-row"><span>Material:</span><div style="display:flex;gap:6px">';
                        h += '<button class="opt-btn' + ((z.doorMaterial || 'melamina') === 'melamina' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorMat(' + idx + ',' + zi + ',\'melamina\')">Melamina</button>';
                        h += '<button class="opt-btn' + ((z.doorMaterial || 'melamina') === 'vidrio' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorMat(' + idx + ',' + zi + ',\'vidrio\')">Vidrio</button>';
                        h += '</div></div>';
                        if ((z.doorMaterial || 'melamina') === 'vidrio') {
                            h += '<div class="est-zone-row"><span>Precio vidrio (cot. externa):</span><div style="display:flex;align-items:center;gap:6px">';
                            h += '<span style="color:#bbb">$</span><input type="number" value="' + (z.vidrioPrice || 0) + '" min="0" step="100" style="width:100px;font-size:13px" onchange="APP.estSetZoneVidrioPrice(' + idx + ',' + zi + ',parseFloat(this.value)||0)">';
                            h += '</div></div>';
                        }
                        h += '<div class="est-zone-row"><span>Apertura:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        h += '<button class="opt-btn' + ((z.doorType || 'tipon') === 'tipon' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorType(' + idx + ',' + zi + ',\'tipon\')">Push Tip-On</button>';
                        h += '<button class="opt-btn' + ((z.doorType || 'tipon') === 'jaladera' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorType(' + idx + ',' + zi + ',\'jaladera\')">Jaladera</button>';
                        h += '<button class="opt-btn' + ((z.doorType || 'tipon') === 'jaladera_int' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetZoneDoorType(' + idx + ',' + zi + ',\'jaladera_int\')">Jaladera Integrada</button>';
                        h += '</div></div>';
                    }
                }
                h += '</div>';
            }
            // Add zone buttons
            h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">';
            if (isEsp) {
                h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'entrepa\')">' + svg('plus') + ' Entrepa\u00f1os</button>';
                h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'colgador\')">' + svg('plus') + ' Colgador</button>';
            } else if (isEsq) {
                h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'entrepa\')">' + svg('plus') + ' Entrepa\u00f1os</button>';
                h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'colgador\')">' + svg('plus') + ' Colgador</button>';
            } else {
                EST_ZONE_TYPES.forEach(function(zt2) {
                    if (zt2.hidden)
                        return;
                    h += '<button class="add-btn" onclick="APP.estAddZone(' + idx + ',\'' + zt2.id + '\')">' + svg('plus') + ' ' + zt2.n + '</button>';
                });
            }
            h += '</div></div>';
            // Height validation bar
            h += renderEstHeightBar(m, idx);
            // Puertas
            var dm = m.doorMode || 'por_zona';
            var qm = m.quoteMode || 'completo';
            h += '<div class="field"><label>Puertas</label>';
            h += '<div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">';
            h += '<button class="opt-btn' + (!m.doors && qm !== 'solo_puertas' ? ' sel' : '') + '" onclick="APP.estTogDoors(' + idx + ',false)">Sin puertas</button>';
            h += '<button class="opt-btn' + (m.doors && dm === 'completa' && qm !== 'solo_puertas' ? ' sel' : '') + '" onclick="APP.estSetQuoteMode(' + idx + ',\'completo\');APP.estTogDoors(' + idx + ',true,\'completa\')">Puerta completa</button>';
            h += '<button class="opt-btn' + (m.doors && dm === 'por_zona' && qm !== 'solo_puertas' ? ' sel' : '') + '" onclick="APP.estSetQuoteMode(' + idx + ',\'completo\');APP.estTogDoors(' + idx + ',true,\'por_zona\')">Puertas por zona</button>';
            h += '<button class="opt-btn' + (qm === 'solo_puertas' ? ' sel' : '') + '" style="' + (qm === 'solo_puertas' ? 'background:#fbbf24;color:#1a1a1a;border-color:#fbbf24' : '') + '" onclick="APP.estSetQuoteMode(' + idx + ',\'solo_puertas\')">Solo puertas</button>';
            h += '</div>';
            if (qm === 'solo_puertas') {
                h += '<div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:6px;padding:8px 12px;margin-bottom:8px;font-size:12px;color:#fbbf24">Solo puertas: la estructura no se cotiza</div>';
            }
            if (m.doors && dm === 'completa') {
                // Full-height door config
                var dCnt = m.doorCount || 2;
                var dMat = m.doorMaterial || 'melamina';
                var dType = m.doorType || 'tipon';
                var eu2 = estEspacioUtil();
                var doorH = Math.round(eu2);
                var doorW = Math.round((m.width / dCnt) * 10 - 3) / 10;
                h += '<div class="est-zone-row"><span>Cantidad:</span><div style="display:flex;gap:8px">';
                h += '<button class="opt-btn' + (dCnt === 1 ? ' sel' : '') + '" onclick="APP.estSetDoorCount(' + idx + ',1)">1 puerta</button>';
                h += '<button class="opt-btn' + (dCnt === 2 ? ' sel' : '') + '" onclick="APP.estSetDoorCount(' + idx + ',2)">2 puertas</button>';
                h += '</div></div>';
                h += '<div class="est-zone-row"><span>Material:</span><div style="display:flex;gap:6px">';
                h += '<button class="opt-btn' + (dMat === 'melamina' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorMat(' + idx + ',\'melamina\')">Melamina</button>';
                h += '<button class="opt-btn' + (dMat === 'vidrio' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorMat(' + idx + ',\'vidrio\')">Vidrio</button>';
                h += '</div></div>';
                if (dMat === 'vidrio') {
                    h += '<div class="est-zone-row"><span>Precio vidrio (cot. externa):</span><div style="display:flex;align-items:center;gap:6px">';
                    h += '<span style="color:#bbb">$</span><input type="number" value="' + (m.vidrioPrice || 0) + '" min="0" step="100" style="width:100px;font-size:13px" onchange="APP.estSetVidrioPrice(' + idx + ',parseFloat(this.value)||0)">';
                    h += '</div></div>';
                }
                h += '<div class="est-zone-row"><span>Apertura:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                h += '<button class="opt-btn' + (dType === 'tipon' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorType2(' + idx + ',\'tipon\')">Push Tip-On</button>';
                h += '<button class="opt-btn' + (dType === 'jaladera' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorType2(' + idx + ',\'jaladera\')">Jaladera</button>';
                h += '<button class="opt-btn' + (dType === 'jaladera_int' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetDoorType2(' + idx + ',\'jaladera_int\')">Jaladera Integrada</button>';
                h += '</div></div>';
                h += '<div style="font-size:12px;color:#60a5fa;padding:4px 0">' + dCnt + ' puerta' + (dCnt > 1 ? 's' : '') + ' de ' + doorW + 'cm \u00d7 ' + doorH + 'cm (alto completo)</div>';
            } else if (m.doors && dm === 'por_zona') {
                h += '<div style="font-size:12px;color:#999;padding:4px 0">Configura las puertas en cada zona arriba</div>';
            }
            h += '</div>';
            // Chapacanto
            h += '<div class="field"><label>Enchapado</label>';
            var ch = m.chap || {
                mode: 'perimetrico',
                edges: {
                    latIzq: true,
                    latDer: true,
                    techo: true,
                    piso: true,
                    fondo: false
                }
            };
            h += '<div style="margin-bottom:8px"><button class="opt-btn' + (ch.mode === 'perimetrico' ? ' sel' : '') + '" onclick="APP.estSetChapMode(' + idx + ',\'perimetrico\')">' + svg(ch.mode === 'perimetrico' ? 'check' : 'plus') + ' Perim\u00e9trico (4 lados)</button></div>';
            h += '<div class="est-chap-grid">';
            [{
                k: 'latIzq',
                l: 'Lat. izq'
            }, {
                k: 'latDer',
                l: 'Lat. der'
            }, {
                k: 'techo',
                l: 'Techo'
            }, {
                k: 'piso',
                l: 'Piso'
            }, {
                k: 'fondo',
                l: 'Fondo'
            }].forEach(function(e) {
                h += '<button class="est-chap-edge' + (ch.edges[e.k] ? ' on' : '') + '" onclick="APP.estTogChapEdge(' + idx + ',\'' + e.k + '\')">' + e.l + '</button>';
            });
            h += '</div></div>';
            // Zoclo (baseboard)
            if (!m.zoclo)
                m.zoclo = {
                    enabled: false,
                    height: 10
                };
            var zoc = m.zoclo;
            h += '<div class="field"><label>Zoclo (z\u00f3calo)</label>';
            h += '<div style="display:flex;gap:8px;margin-bottom:8px">';
            h += '<button class="opt-btn' + (zoc.enabled ? ' sel' : '') + '" onclick="APP.estTogZoclo(' + idx + ')">' + svg(zoc.enabled ? 'check' : 'plus') + ' Con zoclo</button>';
            h += '<button class="opt-btn' + (!zoc.enabled ? ' sel' : '') + '" onclick="APP.estTogZoclo(' + idx + ')">Sin zoclo</button>';
            h += '</div>';
            if (zoc.enabled) {
                h += '<div class="est-zone-row"><span>Altura:</span><div style="display:flex;align-items:center;gap:6px">';
                h += '<input type="number" value="' + zoc.height + '" min="5" max="25" step="1" style="width:70px" onchange="APP.estSetZocloHeight(' + idx + ',parseInt(this.value))">';
                h += '<span style="color:#bbb">cm</span></div></div>';
                h += '<p class="hint">Prof. 55cm (arremetido 5cm) \u00b7 Ancho: ' + m.width + 'cm \u00b7 No consume espacio interior</p>';
            }
            h += '</div>';
            // Maletero (on top of module, outside height)
            if (!m.maletero)
                m.maletero = {
                    enabled: false,
                    height: 30
                };
            var mal = m.maletero;
            h += '<div class="field"><label>Maletero (encima del m\u00f3dulo)</label>';
            h += '<div style="display:flex;gap:8px;margin-bottom:8px">';
            h += '<button class="opt-btn' + (mal.enabled ? ' sel' : '') + '" onclick="APP.estTogMaletero(' + idx + ')">' + svg(mal.enabled ? 'check' : 'plus') + ' Con maletero</button>';
            h += '<button class="opt-btn' + (!mal.enabled ? ' sel' : '') + '" onclick="APP.estTogMaletero(' + idx + ')">Sin maletero</button>';
            h += '</div>';
            if (mal.enabled) {
                h += '<div class="est-zone-row"><span>Altura:</span><div style="display:flex;align-items:center;gap:6px">';
                h += '<input type="number" value="' + mal.height + '" min="10" max="100" step="5" style="width:70px" onchange="APP.estSetMaleteroHeight(' + idx + ',parseInt(this.value))">';
                h += '<span style="color:#bbb">cm</span></div></div>';
                h += '<p class="hint">Encima del m\u00f3dulo \u00b7 No consume altura interior \u00b7 Ajustar seg\u00fan distancia al techo</p>';
                // Maletero door
                h += '<div class="est-zone-row" style="margin-top:6px;border-top:1px solid #2a2a2a;padding-top:6px"><span>Puerta:</span>';
                h += '<button class="opt-btn' + (mal.doors ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoor(' + idx + ',' + (!mal.doors) + ')">' + svg(mal.doors ? 'check' : 'plus') + ' Con puerta</button>';
                h += '<button class="opt-btn' + (!mal.doors ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoor(' + idx + ',false)">Sin</button>';
                h += '</div>';
                if (mal.doors) {
                    h += '<div class="est-zone-row"><span>Material:</span><div style="display:flex;gap:6px">';
                    h += '<button class="opt-btn' + ((mal.doorMaterial || 'melamina') === 'melamina' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorMat(' + idx + ',\'melamina\')">Melamina</button>';
                    h += '<button class="opt-btn' + ((mal.doorMaterial || 'melamina') === 'vidrio' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorMat(' + idx + ',\'vidrio\')">Vidrio</button>';
                    h += '</div></div>';
                    if ((mal.doorMaterial || 'melamina') === 'vidrio') {
                        h += '<div class="est-zone-row"><span>Precio vidrio (cot. externa):</span><div style="display:flex;align-items:center;gap:6px">';
                        h += '<span style="color:#bbb">$</span><input type="number" value="' + (mal.vidrioPrice || 0) + '" min="0" step="100" style="width:100px;font-size:13px" onchange="APP.estSetMaleteroVidrioPrice(' + idx + ',parseFloat(this.value)||0)">';
                        h += '</div></div>';
                    }
                    h += '<div class="est-zone-row"><span>Apertura:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                    h += '<button class="opt-btn' + ((mal.doorType || 'tipon') === 'tipon' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorType(' + idx + ',\'tipon\')">Push Tip-On</button>';
                    h += '<button class="opt-btn' + ((mal.doorType || 'tipon') === 'jaladera' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorType(' + idx + ',\'jaladera\')">Jaladera</button>';
                    h += '<button class="opt-btn' + ((mal.doorType || 'tipon') === 'jaladera_int' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetMaleteroDoorType(' + idx + ',\'jaladera_int\')">Jaladera Integrada</button>';
                    h += '</div></div>';
                }
            }
            h += '</div>';
            // LED
            h += renderEstModuleLed(m, idx);
            h += renderEstModulePaint(m, idx);
            // Hardware preview (editable per-module)
            h += '<div class="field"><label>Herrajes (por m\u00f3dulo)</label>';
            var tempC = calcEstandarizado();
            var modHW = tempC.autoHW.filter(function(ah) {
                return ah.modId === m.id;
            });
            if (modHW.length > 0) {
                // Consolidate by key for this module
                var modHWConsol = {};
                modHW.forEach(function(ah) {
                    var def = HW_DEFAULTS[ah.key];
                    if (!def)
                        return;
                    if (!modHWConsol[ah.key])
                        modHWConsol[ah.key] = {
                            key: ah.key,
                            desc: def.desc,
                            autoQty: 0
                        };
                    modHWConsol[ah.key].autoQty += ah.q;
                });
                var mhwOv = m.hwOverrides || {};
                for (var hwk in modHWConsol) {
                    var mhw = modHWConsol[hwk];
                    var hasOv = typeof mhwOv[hwk] === 'number';
                    var dispQty = hasOv ? mhwOv[hwk] : mhw.autoQty;
                    h += '<div style="display:flex;align-items:center;gap:6px;padding:3px 0">';
                    h += '<span style="flex:1;font-size:13px;color:#bbb">' + mhw.desc + '</span>';
                    h += '<button style="width:24px;height:24px;border-radius:4px;border:1px solid #3a3a3a;background:#1a1a1a;color:#fff;font-size:14px;cursor:pointer" onclick="APP.estModHwQty(' + idx + ',\'' + hwk + '\',-1)">\u2212</button>';
                    h += '<input type="number" value="' + dispQty + '" min="0" style="width:48px;text-align:center;font-size:13px;color:#c49a6c;background:#1a1a1a;border:1px solid #3a3a3a;border-radius:4px;padding:2px" onchange="APP.estModHwQty(' + idx + ',\'' + hwk + '\',0,parseInt(this.value))">';
                    h += '<button style="width:24px;height:24px;border-radius:4px;border:1px solid #3a3a3a;background:#1a1a1a;color:#fff;font-size:14px;cursor:pointer" onclick="APP.estModHwQty(' + idx + ',\'' + hwk + '\',1)">+</button>';
                    if (hasOv) {
                        h += ' <span style="font-size:10px;color:#fbbf24">(editado)</span>';
                        h += ' <button style="font-size:10px;padding:1px 6px;border-radius:3px;border:1px solid #c49a6c;background:none;color:#c49a6c;cursor:pointer" onclick="APP.estModHwReset(' + idx + ',\'' + hwk + '\')">Restaurar</button>';
                    }
                    h += '</div>';
                }
            } else {
                h += '<p style="color:#999;font-size:13px">Sin herrajes autom\u00e1ticos</p>';
            }
            h += '<button class="hw-add-btn" onclick="APP.openHWPicker()" style="margin-top:6px;font-size:12px">' + svg('plus') + ' Agregar herraje</button>';
            h += '</div>';
            return h;
        }

        function renderEstHeightBar(m, idx) {
            var eu = estEspacioUtil(m);
            var mH = estModHeight(m);
            var tk = (S.estProject.thickness || 16) / 10;
            var fixed = calcEstFixedHeight(m);
            var hasColg = m.zones.some(function(z) {
                return z.type === 'colgador';
            });
            var freeSpace = eu - fixed;
            var barH = 220; // total bar height in px
            var h = '<div class="est-height-bar"><div class="est-vbar-wrap">';
            // === Vertical bar ===
            h += '<div class="est-vbar">';
            // Fijo: not shown in height bar (just a cover panel, not spatial)
            // Maletero segment (above techo, outside 2m)
            var malObj = m.maletero || {
                enabled: false,
                height: 30
            };
            if (malObj.enabled) {
                var malH = Math.max(6, (malObj.height || 30) / mH * barH);
                h += '<div class="est-vbar-seg maletero" style="height:' + malH + 'px" title="Maletero ' + (malObj.height || 30) + 'cm (encima)">&#x1f9f3;</div>';
            }
            // Techo segment
            var techoPct = tk / mH * barH;
            h += '<div class="est-vbar-seg techo" style="height:' + Math.max(6, techoPct) + 'px" title="Techo ' + tk + 'cm">T</div>';
            // Entrepanos module: render shelf lines in height bar
            var isEntrepanosMod = m.type === 'entrepanos';
            if (isEntrepanosMod) {
                var sc = m.shelfCount || 3;
                var sections = sc + 1;
                var totalBarSpace = (eu / mH) * barH;
                var entH = 3;
                var sectionPx = Math.max(4, (totalBarSpace - sc * entH) / sections);
                for (var si = 0; si < sections; si++) {
                    h += '<div class="est-vbar-seg libre" style="height:' + Math.round(sectionPx) + 'px" title="Secci\u00f3n ' + (si + 1) + '"></div>';
                    if (si < sections - 1) {
                        h += '<div class="est-vbar-seg entrepa" style="height:' + entH + 'px" title="Entrepa\u00f1o ' + (si + 1) + '"></div>';
                    }
                }
            }
            // Free space at top (if no colgador, no entrepa to distribute it, and positive)
            var isEsp = m.type === 'especial';
            var espHasColg2 = isEsp && hasColg;
            var isEspNoColg = isEsp && !hasColg;
            var hasEntrepa = m.zones.some(function(z) {
                return z.type === 'entrepa';
            });
            if (!isEntrepanosMod && !isEspNoColg && !hasColg && !hasEntrepa && freeSpace > 0) {
                var freeH = Math.max(3, freeSpace / mH * barH);
                h += '<div class="est-vbar-seg libre" style="height:' + freeH + 'px;flex:1" title="Libre ' + freeSpace.toFixed(1) + 'cm"></div>';
            } else if (!isEntrepanosMod && !isEspNoColg && !hasColg && !hasEntrepa && freeSpace < 0) {
                h += '<div class="est-vbar-seg exceso" style="height:12px" title="Excede"></div>';
            }
            // Zone segments (top to bottom)
            m.zones.forEach(function(z) {
                if (z.type === 'entrepa' && (isEspNoColg || (!hasColg && freeSpace > 0))) {
                    // Entrepaños divide free space (or full space for especial w/o colgador) into cnt+1 equal sections
                    var cnt = z.count || 2;
                    var sections = cnt + 1;
                    var spaceForEnt = isEspNoColg ? eu : freeSpace;
                    var totalBarSpace = (spaceForEnt / mH) * barH;
                    var entH = 3; // entrepaño line height in px
                    var sectionPx = Math.max(4, (totalBarSpace - cnt * entH) / sections);
                    for (var si = 0; si < sections; si++) {
                        h += '<div class="est-vbar-seg libre" style="height:' + Math.round(sectionPx) + 'px" title="Secci\u00f3n ' + (si + 1) + '"></div>';
                        if (si < sections - 1) {
                            h += '<div class="est-vbar-seg entrepa" style="height:' + entH + 'px" title="Entrepa\u00f1o ' + (si + 1) + '"></div>';
                        }
                    }
                } else if (z.type === 'zapatero') {
                    // Zapatero: show individual cajón extraíble divisions
                    var zapCnt = z.repisas || 3;
                    var zapUnitH = (z.repisaHeight || 15);
                    var zapTotalH = zapCnt * zapUnitH;
                    var zapBarH = Math.max(8, zapTotalH / mH * barH);
                    var zapUnitPx = Math.max(6, zapBarH / zapCnt);
                    var zapGap = 1;
                    for (var zi2 = 0; zi2 < zapCnt; zi2++) {
                        h += '<div class="est-vbar-seg zapatero" style="height:' + Math.max(4, zapUnitPx - zapGap) + 'px;margin-bottom:' + zapGap + 'px;font-size:8px" title="Caj\u00f3n ext. ' + (zi2 + 1) + ' (' + zapUnitH + 'cm)">Z</div>';
                    }
                } else {
                    var zh = getEstZoneDisplayHeight(m, z);
                    var segH = Math.max(3, zh / mH * barH);
                    var cls = z.type;
                    var label = '';
                    if (z.type === 'cajones')
                        label = (z.count || 1) + 'C';
                    else if (z.type === 'colgador')
                        label = '1T';
                    else if (z.type === 'zapatero')
                        label = (z.repisas || 3) + 'Z';
                    else if (z.type === 'entrepa')
                        label = (z.count || 2) + 'E';
                    h += '<div class="est-vbar-seg ' + cls + '" style="height:' + segH + 'px" title="' + zh.toFixed(1) + 'cm">' + label + '</div>';
                }
            });
            // Piso segment
            h += '<div class="est-vbar-seg piso" style="height:' + Math.max(6, techoPct) + 'px" title="Piso ' + tk + 'cm">P</div>';
            // Zoclo segment (below piso, outside 2m interior)
            var zoc = m.zoclo || {
                enabled: false,
                height: 10
            };
            if (zoc.enabled) {
                var zocH = Math.max(6, (zoc.height || 10) / mH * barH);
                h += '<div class="est-vbar-seg zoclo" style="height:' + zocH + 'px" title="Zoclo ' + (zoc.height || 10) + 'cm (arremetido)">Z</div>';
            }
            h += '</div>';
            // === Info panel ===
            h += '<div class="est-vbar-info">';
            h += '<div class="est-vbar-row"><span>Espacio \u00fatil:</span><strong>' + eu.toFixed(1) + ' cm</strong></div>';
            h += '<div class="est-vbar-row"><span>Estructura (techo+piso):</span><span>' + ((tk * 2).toFixed(1)) + ' cm</span></div>';
            m.zones.forEach(function(z) {
                var zt = EST_ZONE_TYPES.find(function(x) {
                    return x.id === z.type;
                });
                var zh = getEstZoneDisplayHeight(m, z);
                var label = (zt ? zt.n : z.type) + ': ';
                if (z.type === 'colgador')
                    label += zh.toFixed(0) + ' cm (auto)';
                else if (z.type === 'zapatero')
                    label += (z.repisas || 3) + ' cajones ext. \u00d7 ' + (z.repisaHeight || 15) + 'cm = ' + zh.toFixed(1) + ' cm (frente 5cm)';
                else if (z.type === 'entrepa') {
                    var entCnt2 = z.count || 2;
                    var entSpace = (isEsp && !hasColg) ? eu : freeSpace;
                    if (entSpace > 0) {
                        var secH2 = entSpace / (entCnt2 + 1);
                        label += entCnt2 + ' entrepa\u00f1os \u00f7 ' + entSpace.toFixed(1) + ' cm' + ((isEsp && !hasColg) ? '' : ' libre') + ' = ' + secH2.toFixed(1) + ' cm c/secci\u00f3n';
                    } else {
                        label += zh.toFixed(1) + ' cm';
                    }
                }
                else
                    label += zh.toFixed(1) + ' cm';
                h += '<div class="est-vbar-row"><span>' + label + '</span><span>' + Math.round(zh / eu * 100) + '%</span></div>';
            });
            if (!isEsp && m.zones.length > 1) {
                var divH = (m.zones.length - 1) * tk;
                h += '<div class="est-vbar-row" style="color:#666"><span>Divisiones internas:</span><span>' + divH.toFixed(1) + ' cm</span></div>';
            }
            if (isEsp || hasEntrepa) {
                h += '<div class="est-vbar-row" style="color:#4ade80"><span>Estado:</span><strong>Auto-distribuido</strong></div>';
            } else if (hasColg) {
                var colgH = calcEstColgadorHeight(m, m.zones.find(function(z) {
                    return z.type === 'colgador';
                }));
                h += '<div class="est-vbar-row" style="color:#4ade80"><span>Estado:</span><strong>Auto-ajustado</strong></div>';
                // Colgador warnings
                if (colgH < 50)
                    h += '<div class="est-vbar-warn red">\u26a0\ufe0f Espacio insuficiente para colgador (' + colgH + ' cm)</div>';
                else if (colgH < 80)
                    h += '<div class="est-vbar-warn yellow">\u26a0\ufe0f Colgador corto (' + colgH + ' cm)</div>';
            } else {
                if (freeSpace > 0) {
                    h += '<div class="est-vbar-row" style="color:#fbbf24"><span>Espacio libre:</span><strong>' + freeSpace.toFixed(1) + ' cm</strong></div>';
                } else if (freeSpace < 0) {
                    h += '<div class="est-vbar-warn red">\ud83d\udd34 Las zonas exceden el espacio disponible por ' + (-freeSpace).toFixed(1) + ' cm</div>';
                } else {
                    h += '<div class="est-vbar-row" style="color:#4ade80"><span>Estado:</span><strong>Ajuste perfecto</strong></div>';
                }
            }
            if (zoc.enabled) {
                h += '<div class="est-vbar-row" style="color:#8b5c3c"><span>Zoclo (fuera del m\u00f3dulo):</span><span>' + (zoc.height || 10) + ' cm \u00b7 55cm prof.</span></div>';
            }
            var malInfo = m.maletero || {
                enabled: false,
                height: 30
            };
            if (malInfo.enabled) {
                h += '<div class="est-vbar-row" style="color:#eab308"><span>Maletero (encima):</span><span>' + (malInfo.height || 30) + ' cm \u00b7 sin frente</span></div>';
            }
            h += '</div></div></div>';
            return h;
        }

        function calcEstModuleLedMeters(m) {
            var led = m.led;
            if (!led || !led.enabled)
                return {
                    meters: 0,
                    segments: 0
                };
            var w = m.width / 100,
                h2 = estModHeight(m) / 100;
            var meters = 0,
                segments = 0;
            if (led.edges.top) {
                meters += w;
                segments++;
            }
            if (led.edges.bottom) {
                meters += w;
                segments++;
            }
            if (led.edges.left) {
                meters += h2;
                segments++;
            }
            if (led.edges.right) {
                meters += h2;
                segments++;
            }
            if (led.edges.shelves && led.shelfCount > 0) {
                meters += led.shelfCount * w;
                segments += led.shelfCount;
            }
            return {
                meters: Math.round(meters * 100) / 100,
                segments: segments
            };
        }

        function renderEstModuleLed(m, idx) {
            if (!m.led)
                m.led = {
                    enabled: false,
                    edges: {
                        top: false,
                        bottom: false,
                        left: false,
                        right: false,
                        shelves: false
                    },
                    shelfCount: 0,
                    metersOverride: null,
                    segmentsOverride: null
                };
            var EP = S.estProject,
                led = m.led;
            var h = '<div class="led-section">';
            h += '<div class="led-toggle-row"><span>&#x1f4a1; Iluminaci\u00f3n LED</span><button class="toggle' + (led.enabled ? ' on' : '') + '" onclick="APP.estTogModLed(' + idx + ')"></button></div>';
            if (!led.enabled) {
                h += '</div>';
                return h;
            }
            // Edge selector
            h += '<div class="led-edges"><div style="position:relative;padding:18px 34px"><div class="led-edge-box">';
            ['top', 'bottom', 'left', 'right'].forEach(function(e) {
                h += '<button class="led-edge ' + e + (led.edges[e] ? ' on' : '') + '" onclick="APP.estTogLedEdge(' + idx + ',\'' + e + '\')"></button>';
            });
            h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;color:#666;pointer-events:none">' + m.width + '\u00d7' + estModHeight(m) + '</div>';
            h += '</div></div>';
            // Shelf LED + meters/segments
            h += '<div class="led-opts">';
            h += '<div class="led-shelf-row"><button class="' + (led.edges.shelves ? 'on' : '') + '" onclick="APP.estTogLedShelves(' + idx + ')">' + (led.edges.shelves ? '&#10003;' : '') + ' Entrepa\u00f1os</button>';
            if (led.edges.shelves)
                h += '<input type="number" value="' + led.shelfCount + '" min="0" max="10" onchange="APP.estSetLedShelves(' + idx + ',parseInt(this.value))">';
            h += '</div>';
            var auto = calcEstModuleLedMeters(m);
            var usedM = (led.metersOverride !== null && led.metersOverride >= 0) ? led.metersOverride : auto.meters;
            var usedS = (led.segmentsOverride !== null && led.segmentsOverride >= 0) ? led.segmentsOverride : auto.segments;
            h += '<div class="led-meters"><span>Metros:</span><input type="number" value="' + usedM.toFixed(2) + '" min="0" step="0.1" onchange="APP.estSetLedMeters(' + idx + ',parseFloat(this.value))">';
            h += '<span>Segmentos:</span><input type="number" value="' + usedS + '" min="0" step="1" onchange="APP.estSetLedSegments(' + idx + ',parseInt(this.value))">';
            if (led.metersOverride !== null || led.segmentsOverride !== null)
                h += '<button style="padding:2px 6px;border-radius:4px;border:1px solid #fbbf24;background:none;color:#fbbf24;font-size:10px;cursor:pointer" onclick="APP.estResetLedOverride(' + idx + ')">Auto</button>';
            h += '</div></div></div>';
            // Activation type (project-level)
            h += '<div style="font-size:11px;color:#999;margin-bottom:4px">Activaci\u00f3n:</div>';
            h += '<div class="led-radio">';
            [{
                k: 'presion',
                l: 'Presi\u00f3n',
                p: LED_CATALOG.switches.presion.price
            }, {
                k: 'dimmer',
                l: 'Dimmer',
                p: LED_CATALOG.switches.dimmer.price
            }, {
                k: 'movimiento',
                l: 'Movimiento',
                p: LED_CATALOG.switches.movimiento.price
            }, {
                k: 'puerta',
                l: 'Puerta',
                p: LED_CATALOG.switches.puerta.price
            }].forEach(function(sw) {
                h += '<button class="' + (EP.ledConfig.activation === sw.k ? 'sel' : '') + '" onclick="APP.estSetLedActivation(\'' + sw.k + '\')">' + sw.l + ' ' + fmtD(sw.p) + '</button>';
            });
            h += '</div>';
            // Light temperature (project-level)
            h += '<div style="font-size:11px;color:#999;margin:4px 0">Temperatura:</div>';
            h += '<div class="led-radio">';
            h += '<button class="' + (EP.ledConfig.lightTemp === 'calida' ? 'sel' : '') + '" onclick="APP.estSetLedTemp(\'calida\')">C\u00e1lida 3000K</button>';
            h += '<button class="' + (EP.ledConfig.lightTemp === 'fria' ? 'sel' : '') + '" onclick="APP.estSetLedTemp(\'fria\')">Fr\u00eda 5000K</button>';
            h += '</div>';
            // Mini BOM preview
            var ledBOM = calcEstLedBOM();
            if (ledBOM) {
                h += '<div class="led-bom-preview">';
                h += '<div style="font-size:10px;color:#999;margin-bottom:4px">Lista de Material LED (auto)</div>';
                ledBOM.items.forEach(function(it) {
                    h += '<div class="led-bom-row"><span>' + it.qty + 'x ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                });
                h += '<div class="led-bom-total"><span>Costo LED</span><strong>' + fmtD(ledBOM.totalCost) + '</strong></div>';
                h += '<div class="led-bom-total" style="border:none;padding-top:0;margin-top:0;font-size:11px"><span>Venta LED (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong>' + fmtD(ledBOM.totalCost * CONFIG.pricing.extrasMultiplier) + '</strong></div>';
                h += '</div>';
            }
            h += '</div>';
            return h;
        }

        function renderEstModulePaint(m, idx) {
            if (!m.paint)
                m.paint = {
                    enabled: false,
                    name: '',
                    pricePerLiter: 0,
                    coats: 2,
                    scope: 'doors'
                };
            var paint = m.paint;
            var qm = m.quoteMode || 'completo';
            var h = '<div class="field"><label>&#x1f3a8; Pintura</label>';
            h += '<div style="display:flex;gap:8px;margin-bottom:8px">';
            h += '<button class="opt-btn' + (paint.enabled ? ' sel' : '') + '" onclick="APP.estTogPaint(' + idx + ')">' + svg(paint.enabled ? 'check' : 'plus') + ' Con pintura</button>';
            h += '<button class="opt-btn' + (!paint.enabled ? ' sel' : '') + '" onclick="APP.estTogPaint(' + idx + ')">Sin pintura</button>';
            h += '</div>';
            if (paint.enabled) {
                h += '<div style="display:flex;flex-direction:column;gap:6px">';
                h += '<div class="est-zone-row"><span>Nombre:</span><input type="text" value="' + (paint.name || '') + '" placeholder="Ej: Laqueado blanco" style="flex:1;font-size:13px" onchange="APP.estSetPaintName(' + idx + ',this.value)"></div>';
                h += '<div class="est-zone-row"><span>Precio/Litro:</span><div style="display:flex;align-items:center;gap:6px"><span style="color:#bbb">$</span><input type="number" value="' + paint.pricePerLiter + '" min="0" step="50" style="width:100px;font-size:13px" onchange="APP.estSetPaintPrice(' + idx + ',parseFloat(this.value))"></div></div>';
                h += '<div class="est-zone-row"><span>Manos:</span><div style="display:flex;align-items:center;gap:6px"><input type="number" value="' + (paint.coats || 2) + '" min="1" max="5" step="1" style="width:60px;font-size:13px" onchange="APP.estSetPaintCoats(' + idx + ',parseInt(this.value))"></div></div>';
                h += '<div class="est-zone-row"><span>Alcance:</span><div style="display:flex;gap:6px">';
                h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'doors' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetPaintScope(' + idx + ',\'doors\')">Puertas</button>';
                h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'structure' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetPaintScope(' + idx + ',\'structure\')">Estructura</button>';
                h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'all' ? ' sel' : '') + '" style="font-size:12px;padding:4px 10px" onclick="APP.estSetPaintScope(' + idx + ',\'all\')">Todo</button>';
                h += '</div></div>';
                var coats = paint.coats || 2;
                var pm2 = calcPaintM2(m, {
                    mode: 'est'
                });
                var liters = calcPaintLiters(pm2, coats);
                var buyLiters = Math.ceil(liters);
                var cost = liters * paint.pricePerLiter;
                h += '<div style="font-size:12px;color:#60a5fa;padding:4px 0">' + pm2.toFixed(2) + ' m\u00b2 \u00d7 ' + coats + ' manos \u00f7 10 m\u00b2/L = ' + liters.toFixed(2) + ' L &rarr; ' + fmtD(Math.round(cost)) + '</div>';
                h += '<div style="font-size:11px;color:#999;padding:1px 0">Comprar: ' + buyLiters + ' L</div>';
                if (pm2 === 0 && paint.scope === 'doors' && !m.doors && qm !== 'solo_puertas')
                    h += '<div style="font-size:11px;color:#f87171;padding:2px 0">Sin puertas \u2014 0 m\u00b2</div>';
                if (pm2 === 0 && paint.scope === 'structure' && qm === 'solo_puertas')
                    h += '<div style="font-size:11px;color:#f87171;padding:2px 0">Solo puertas \u2014 sin estructura</div>';
                h += '</div>';
            }
            h += '</div>';
            return h;
        }

        function renderEstMaterial() {
            var EP = S.estProject;
            var h = '<div class="title"><h2>Material y Espesor</h2><p>Selecciona los materiales</p></div>';
            // Same material toggle
            h += '<div class="mat-toggle-row"><span>Usar mismo material para todo</span><button class="toggle' + (EP.sameMaterial ? ' on' : '') + '" onclick="APP.estTogSameMat()"></button></div>';
            if (EP.sameMaterial) {
                h += renderMaterialSelect('Material', EP.matFrentes, 'APP.estSetMatFrentes', '');
            } else {
                h += renderMaterialSelect('Material Frentes', EP.matFrentes, 'APP.estSetMatFrentes', 'vis');
                h += renderMaterialSelect('Material Interior', EP.matInterior, 'APP.estSetMatInterior', 'hid');
            }
            // Thickness
            var stdThicks = [16, 18, 25];
            var isCustomThk = stdThicks.indexOf(EP.thickness) === -1;
            h += '<div class="field"><label>Espesor Principal</label><div style="display:flex;gap:8px;flex-wrap:wrap">';
            stdThicks.forEach(function(t) {
                h += '<button class="thick-btn' + (EP.thickness === t ? ' sel' : '') + '" onclick="APP.estSetThick(' + t + ')">' + t + 'mm</button>';
            });
            h += '<button class="thick-btn' + (isCustomThk ? ' sel' : '') + '" onclick="APP.estSetCustomThick()">Otro</button>';
            h += '</div>';
            if (isCustomThk) {
                h += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input type="number" value="' + EP.thickness + '" min="3" max="50" step="1" style="width:80px" onchange="APP.estSetThick(parseInt(this.value))"><span style="color:#bbb">mm</span></div>';
            }
            h += '<p class="hint">Todas las piezas usan el espesor seleccionado</p></div>';
            // Chapacanto price
            h += '<div class="field"><label>Chapacanto ($/ml)</label>';
            if (EP.sameMaterial) {
                h += '<input type="number" value="' + EP.chapFrentesPrice + '" step="0.1" onchange="APP.estSetChapPrice(parseFloat(this.value))" style="width:120px">';
            } else {
                h += '<div style="display:flex;gap:12px"><div style="flex:1"><span style="font-size:12px;color:#60a5fa">Frentes</span><input type="number" value="' + EP.chapFrentesPrice + '" step="0.1" onchange="APP.estSetChapPrice(parseFloat(this.value))"></div>';
                h += '<div style="flex:1"><span style="font-size:12px;color:#9ca3af">Interior</span><input type="number" value="' + EP.chapInteriorPrice + '" step="0.1" onchange="APP.estSetChapPriceI(parseFloat(this.value))"></div></div>';
            }
            h += '</div>';
            // Enchapado price
            h += '<div class="field"><label>Enchapado ($/ml)</label>';
            h += '<input type="number" value="' + (typeof EP.enchapPrice === 'number' ? EP.enchapPrice : 13) + '" step="0.5" min="0" onchange="APP.estSetEnchapPrice(parseFloat(this.value))" style="width:120px">';
            h += '<p class="hint">Costo por metro lineal de enchapado</p></div>';
            // Labor
            h += '<div class="field"><label>Mano de Obra</label>';
            h += '<div class="labor-input"><span>$</span><input type="number" value="' + EP.laborCost + '" min="0" step="500" onchange="APP.estSetLabor(parseFloat(this.value))"></div>';
            h += '<div class="labor-presets">';
            [{
                l: '$3,000',
                v: 3000
            }, {
                l: '$5,000',
                v: 5000
            }, {
                l: '$8,000',
                v: 8000
            }, {
                l: '$12,000',
                v: 12000
            }].forEach(function(p) {
                h += '<button class="labor-preset' + (EP.laborCost === p.v ? ' sel' : '') + '" onclick="APP.estSetLabor(' + p.v + ')">' + p.l + '</button>';
            });
            h += '</div></div>';
            return h;
        }

        function renderEstSummary() {
            var EP = S.estProject;
            if (EP.modules.length === 0)
                return '<div class="empty">No hay m\u00f3dulos configurados</div>';
            var c = calcEstandarizado();
            var ov = EP.hwOverrides || {};
            var isCustom = EP.mode === 'custom';
            var h = '<div class="title"><h2>Resumen de Cotizaci\u00f3n</h2><p>' + (isCustom ? 'Proyecto Personalizado' : 'Closet Estandarizado') + '</p></div>';
            // Despiece per module — grouped by section
            EP.modules.forEach(function(m, mi) {
                var pcs = c.pieces.filter(function(p) {
                    return p.mid === m.id;
                });
                var mTypeStr = m.type === 'esquinero' ? ' \u2014 Esquinero ' + m.width + '\u00d7' + (m.width2 || m.width) + 'cm' : m.type === 'fijo' ? ' \u2014 Fijo ' + m.width + '\u00d7' + m.height + 'cm' : m.type === 'panelTV' ? ' \u2014 Panel TV ' + m.width + 'cm' : m.type === 'torreLateral' ? ' \u2014 Torre Lat. ' + m.width + 'cm' : m.type === 'entrepa' ? ' \u2014 Torre Ent. ' + m.width + 'cm' : m.type === 'entrepanos' ? ' \u2014 Entrepa\u00f1os ' + m.width + 'cm' : ' \u2014 ' + m.width + 'cm';
                mTypeStr += ' \u00d7 ' + m.height + 'cm alto';
                var mLabel = 'M\u00f3dulo ' + (mi + 1) + mTypeStr;
                h += '<div class="card" style="border-left:3px solid #c49a6c">';
                h += '<div style="font-size:16px;font-weight:700;color:#c49a6c;margin-bottom:12px">' + mLabel + '</div>';
                // Group: structure
                var struct = pcs.filter(function(p) {
                    return p.n.indexOf('caj') < 0 && p.n.indexOf('Puerta') < 0 && p.n.indexOf('Repisa') < 0 && p.n.indexOf('Entrepa') < 0 && p.n.indexOf('maletero') < 0 && p.n !== 'Fijo';
                });
                var cajones = pcs.filter(function(p) {
                    return p.n.indexOf('caj') >= 0 || p.n.indexOf('Caj') >= 0;
                });
                var entrepa = pcs.filter(function(p) {
                    return p.n.indexOf('Entrepa') >= 0;
                });
                var repisas = pcs.filter(function(p) {
                    return p.n.indexOf('Repisa') >= 0;
                });
                var fijos = pcs.filter(function(p) {
                    return p.n === 'Fijo';
                });
                var puertas = pcs.filter(function(p) {
                    return p.n.indexOf('Puerta') >= 0;
                });
                var maleteros = pcs.filter(function(p) {
                    return p.n.indexOf('maletero') >= 0;
                });
                function renderPieceGroup(label, items) {
                    if (items.length === 0)
                        return '';
                    var g = '<div style="margin-bottom:10px"><div style="font-size:13px;font-weight:600;color:#999;text-transform:uppercase;margin-bottom:4px;border-bottom:1px solid #2a2a2a;padding-bottom:3px">' + label + '</div>';
                    items.forEach(function(p) {
                        var al = anchoLargo(p.w, p.h);
                        g += '<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:15px"><span style="color:#fff">' + p.n + ' <span style="color:#c49a6c;font-weight:700">\u00d7' + p.q + '</span></span><strong style="font-family:monospace;color:#bbb">' + al.ancho + ' \u00d7 ' + al.largo + ' <span style="color:#666">' + p.t + 'mm</span></strong></div>';
                    });
                    g += '</div>';
                    return g;
                }
                h += renderPieceGroup('Estructura', struct);
                h += renderPieceGroup('Cajones', cajones);
                h += renderPieceGroup('Entrepa\u00f1os', entrepa);
                h += renderPieceGroup('Zapatero', repisas);
                h += renderPieceGroup('Fijos', fijos);
                h += renderPieceGroup('Maletero', maleteros);
                h += renderPieceGroup('Puertas', puertas);
                // Zone summary for this module
                h += '<div style="font-size:12px;color:#666;margin-top:4px">';
                m.zones.forEach(function(z) {
                    var zt = EST_ZONE_TYPES.find(function(x) {
                        return x.id === z.type;
                    });
                    var zh = getEstZoneDisplayHeight(m, z);
                    h += (zt ? zt.n : z.type) + ' ' + zh + 'cm';
                    if (z.type === 'cajones')
                        h += ' (' + (z.count || 3) + '\u00d7' + (z.cajonHeight || 20) + 'cm)';
                    if (z.type === 'zapatero')
                        h += ' (' + (z.repisas || 3) + ' cajones ext.)';
                    h += '&nbsp;&nbsp;';
                });
                var malSum = m.maletero || {
                    enabled: false
                };
                if (malSum.enabled)
                    h += '&#x1f9f3; Maletero ' + (malSum.height || 30) + 'cm (encima)&nbsp;&nbsp;';
                h += '</div>';
                h += '</div>';
            });
            // Sheets + Canto
            h += '<div class="card"><div class="card-title">' + svg('layers') + ' Material</div>';
            h += '<div class="cost-row"><span>Hojas totales (' + (c.projThickness || 16) + 'mm)</span><strong>' + c.totalSheets + '</strong></div>';
            h += '<div class="cost-row"><span>Chapacanto total</span><strong>' + c.totalCanto + ' ml</strong></div>';
            h += '</div>';
            // Hardware (editable)
            h += '<div class="card"><div class="card-title">' + svg('settings') + ' Herrajes</div>';
            h += '<div style="font-size:11px;color:#999;margin-bottom:8px">Autom\u00e1ticos (editable)</div>';
            c.allHW.forEach(function(hw) {
                if (!hw.key)
                    return; // skip manual HW here, shown below
                var isOverridden = ov[hw.key];
                var qtyVal = Math.ceil(hw.qty);
                h += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #2a2a2a">';
                h += '<div style="flex:1;min-width:0">';
                h += '<span class="hw-sel-marca ' + marcaClass(hw.marca) + '">' + hw.marca + '</span> ';
                h += '<span style="font-size:13px;color:#ddd">' + hw.desc + '</span>';
                if (isOverridden)
                    h += ' <span style="font-size:10px;color:#fbbf24">(editado)</span>';
                h += '</div>';
                h += '<div style="display:flex;align-items:center;gap:4px">';
                h += '<button style="width:28px;height:28px;border-radius:6px;border:1px solid #3a3a3a;background:#1a1a1a;color:#fff;font-size:16px;cursor:pointer" onclick="APP.estHwQty(\'' + hw.key + '\',-1)">\u2212</button>';
                h += '<input type="number" value="' + qtyVal + '" min="0" style="width:48px;text-align:center;font-size:15px;font-weight:700;color:#c49a6c;background:#1a1a1a;border:1px solid #3a3a3a;border-radius:6px;padding:2px" onchange="APP.estHwQtySet(\'' + hw.key + '\',parseInt(this.value))">';
                h += '<button style="width:28px;height:28px;border-radius:6px;border:1px solid #3a3a3a;background:#1a1a1a;color:#fff;font-size:16px;cursor:pointer" onclick="APP.estHwQty(\'' + hw.key + '\',1)">+</button>';
                h += '</div>';
                h += '<strong style="min-width:70px;text-align:right;font-family:monospace;font-size:13px;color:#bbb">' + fmtD(qtyVal * hw.price) + '</strong>';
                h += '</div>';
                // Swap button row
                h += '<div style="display:flex;gap:6px;padding:2px 0 4px">';
                h += '<button style="font-size:10px;padding:2px 8px;border-radius:4px;border:1px solid #3a3a3a;background:none;color:#999;cursor:pointer" onclick="APP.estHwSwap(\'' + hw.key + '\')">Cambiar tipo</button>';
                if (isOverridden)
                    h += '<button style="font-size:10px;padding:2px 8px;border-radius:4px;border:1px solid #c49a6c;background:none;color:#c49a6c;cursor:pointer" onclick="APP.estHwReset(\'' + hw.key + '\')">Restaurar</button>';
                h += '</div>';
            });
            // Manual hardware
            if (EP.hardware.length > 0) {
                h += '<div style="margin-top:8px;padding-top:8px;border-top:1px solid #3a3a3a"><div style="font-size:11px;color:#999;margin-bottom:4px">Manual:</div>';
                EP.hardware.forEach(function(h2, hi) {
                    h += '<div class="hw-sel-item"><span class="hw-sel-marca ' + marcaClass(h2.marca) + '">' + h2.marca + '</span><span class="hw-sel-name">' + h2.descripcion + '</span>';
                    h += '<div class="hw-sel-qty"><button onclick="APP.hwCartQty(\'' + h2.codigo + '\',-1)">-</button><strong>' + h2.qty + '</strong><button onclick="APP.hwCartQty(\'' + h2.codigo + '\',1)">+</button></div>';
                    h += '<span class="hw-sel-price">' + fmtD(h2.qty * adjPrice(h2)) + '</span></div>';
                });
                h += '</div>';
            }
            h += '<button class="hw-add-btn" onclick="APP.openHWPicker()" style="margin-top:8px">' + svg('plus') + ' Agregar herraje</button>';
            h += '</div>';
            // LED
            if (c.ledBOM) {
                h += '<div class="card"><div class="card-title" style="color:#fbbf24">&#x1f4a1; LED</div>';
                c.ledBOM.items.forEach(function(it) {
                    h += '<div class="cost-row"><span style="font-size:12px">' + it.qty + '\u00d7 ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                });
                h += '<div class="cost-total"><span>Costo LED</span><strong>' + fmtD(c.ledBOM.totalCost) + '</strong></div>';
                h += '</div>';
            }
            // Cost breakdown
            h += '<div class="card"><div class="card-title">' + svg('dollar') + ' Costos</div>';
            // --- CARPINTERIA ---
            h += '<div style="font-size:13px;font-weight:600;color:#999;text-transform:uppercase;margin-bottom:6px;border-bottom:1px solid #2a2a2a;padding-bottom:3px">Carpinter\u00eda</div>';
            var matNameF = EP.matFrentes.brand === 'CUSTOM' ? (EP.matFrentes.name || 'Personalizado') : EP.matFrentes.brand + ' ' + EP.matFrentes.name + (EP.matFrentes.finish ? ' ' + EP.matFrentes.finish : '');
            var matNameI = EP.matInterior.brand === 'CUSTOM' ? (EP.matInterior.name || 'Personalizado') : EP.matInterior.brand + ' ' + EP.matInterior.name + (EP.matInterior.finish ? ' ' + EP.matInterior.finish : '');
            var csTK = c.projThickness || 16;
            if (c.totalSheetsF > 0)
                h += '<div class="cost-row"><span>' + matNameF + ' ' + csTK + 'mm (' + c.totalSheetsF + ' hojas \u00d7 ' + fmtD(c.matPriceF) + ')</span><strong>' + fmt(c.totalSheetsF * c.matPriceF) + '</strong></div>';
            if (c.useDual && c.totalSheetsI > 0)
                h += '<div class="cost-row"><span>' + matNameI + ' ' + csTK + 'mm (' + c.totalSheetsI + ' hojas \u00d7 ' + fmtD(c.matPriceI) + ')</span><strong>' + fmt(c.totalSheetsI * c.matPriceI) + '</strong></div>';
            h += '<div class="cost-row"><span>Chapacanto (' + c.totalCanto + ' ml)</span><strong>' + fmt(c.chapCostF + c.chapCostI) + '</strong></div>';
            h += '<div class="cost-row"><span>Corte (' + c.totalSheets + ' hojas)</span><strong>' + fmt(c.corteCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Enchapado (' + c.totalCanto + ' ml x $' + (typeof EP.enchapPrice === 'number' ? EP.enchapPrice : 13) + ')</span><strong>' + fmt(c.enchapCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Mano de obra</span><strong>' + fmt(EP.laborCost) + '</strong></div>';
            h += '<div class="cost-total"><span>Costo Carpinter\u00eda</span><strong>' + fmt(c.carpCost) + '</strong></div>';
            h += '<div class="cost-row" style="font-size:12px;color:#c49a6c"><span>Carpinter\u00eda x' + CONFIG.pricing.carpentryMultiplier + '</span><strong>' + fmt(c.carpSale) + '</strong></div>';
            // --- HERRAJES ---
            h += '<div style="font-size:13px;font-weight:600;color:#999;text-transform:uppercase;margin:10px 0 6px;border-bottom:1px solid #2a2a2a;padding-bottom:3px">Herrajes</div>';
            var hwTotalCost = c.hwCostCarpBucket + c.hwCostPremium;
            if (c.hwCostCarpBucket > 0)
                h += '<div class="cost-row"><span>Herrajes est\u00e1ndar (\u2264$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostCarpBucket) + '</strong></div>';
            if (c.hwCostPremium > 0)
                h += '<div class="cost-row"><span>Herrajes premium (>$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostPremium) + '</strong></div>';
            h += '<div class="cost-total"><span>Costo Herrajes</span><strong>' + fmt(hwTotalCost) + '</strong></div>';
            var hwSaleTotal = (c.hwCostCarpBucket * CONFIG.pricing.carpentryMultiplier) + c.hwPremiumSale;
            h += '<div class="cost-row" style="font-size:12px;color:#c49a6c"><span>Herrajes (margen ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong>' + fmt(hwSaleTotal) + '</strong></div>';
            // --- SUBTOTAL CARP + HERRAJES ---
            h += '<div class="cost-total" style="margin-top:8px;border-top:2px solid #c49a6c;padding-top:8px"><span>Subtotal Carpinter\u00eda + Herrajes</span><strong style="color:#c49a6c">' + fmt(c.carpSale + hwSaleTotal) + '</strong></div>';
            if (c.extraCost > 0) {
                h += '<div style="font-size:13px;font-weight:600;color:#999;text-transform:uppercase;margin:10px 0 6px;border-bottom:1px solid #2a2a2a;padding-bottom:3px">Extras</div>';
                if (c.ledBOM)
                    h += '<div class="cost-row"><span>LED</span><strong>' + fmt(c.ledBOM.totalCost) + '</strong></div>';
                if (c.vidrioCost > 0)
                    h += '<div class="cost-row"><span>Vidrio (cot. externa)</span><strong>' + fmt(c.vidrioCost) + '</strong></div>';
                if (c.paintCost > 0) {
                    EP.modules.forEach(function(m2, mi2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'est'
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                h += '<div class="cost-row"><span>Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' Mod ' + (mi2 + 1) + ' (' + lit.toFixed(1) + 'L)</span><strong>' + fmtD(Math.round(lit * m2.paint.pricePerLiter)) + '</strong></div>';
                        }
                    });
                }
                h += '<div class="cost-total"><span>Subtotal Extras</span><strong>' + fmt(c.extraCost) + '</strong></div>';
            }
            h += '</div>';
            // Totals
            h += '<div class="summary">';
            h += '<div class="grand-total"><span>COSTO TOTAL</span><strong>' + fmt(c.totalCost) + '</strong></div>';
            h += '<div class="summary-row"><span>Carpinter\u00eda (carp + herrajes \u2264$' + CONFIG.pricing.hardwareThreshold + ') x' + CONFIG.pricing.carpentryMultiplier + '</span><strong>' + fmt(c.carpSale) + '</strong></div>';
            if (c.hwPremiumSale > 0)
                h += '<div class="summary-row"><span>Herrajes Premium (margen ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong>' + fmt(c.hwPremiumSale) + '</strong></div>';
            if (c.extrasSale > 0)
                h += '<div class="summary-row"><span>Extras</span><strong>' + fmt(c.extrasSale) + '</strong></div>';
            h += '<div class="grand-total"><span>PRECIO VENTA</span><strong>' + fmt(c.subtotal) + '</strong></div>';
            h += '<div class="summary-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
            h += '<div class="grand-total" style="margin-top:8px"><span>TOTAL CON IVA</span><strong>' + fmt(c.total) + '</strong></div>';
            h += '<div class="profit-box"><span>Costo: ' + fmt(c.totalCost) + '</span><strong>Utilidad: ' + fmt(c.profit) + ' (' + c.margin + '%)</strong></div></div>';
            // Plano upload
            h += '<div class="card" style="margin-top:16px"><div class="card-title">' + svg('layers') + ' Plano</div>';
            h += '<input type="file" id="plano-upload" accept="image/jpeg,image/png,image/jpg" style="display:none" onchange="APP.estUploadPlano(this)">';
            if (EP.planoImage) {
                h += '<div style="position:relative;margin-bottom:12px">';
                h += '<img src="' + EP.planoImage + '" style="max-width:100%;max-height:300px;border-radius:8px;border:1px solid #3a3a3a">';
                h += '<button onclick="APP.estRemovePlano()" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:#f87171;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:16px">&times;</button>';
                h += '</div>';
                h += '<p style="color:#4ade80;font-size:13px">Plano adjunto - se incluir\u00e1 en PDF Cliente e Interno</p>';
            } else {
                h += '<button class="opt-btn" onclick="document.getElementById(\'plano-upload\').click()" style="margin-bottom:8px">' + svg('plus') + ' Adjuntar plano (JPG/PNG)</button>';
                h += '<p class="hint">Imagen del plano final del proyecto. Se agrega como p\u00e1gina al final del PDF.</p>';
            }
            h += '</div>';
            // PDF buttons
            h += '<div class="pdf-actions" style="margin-top:16px">';
            h += '<button class="pdf-btn client" onclick="APP.estGenClientPDF()">&#x1f4c4; PDF Cliente</button>';
            h += '<button class="pdf-btn internal" onclick="APP.estGenInternalPDF()">&#x1f512; PDF Interno</button>';
            h += '</div>';
            // Save project button
            h += '<button class="est-save-btn" onclick="APP.saveProject()">' + svg('check') + ' Guardar Proyecto</button>';
            return h;
        }

        function renderEstandarizado() {
            var br = BRANDS[S.brand] || BRANDS.primary;
            var isCustom = S.estProject && S.estProject.mode === 'custom';
            var hdrTitle = isCustom ? 'Nuevo Proyecto' : 'Closet Estandarizado';
            var h = '<div class="hdr"><div style="display:flex;align-items:center"><div class="hdr-logo" onclick="APP.goHome()" style="background:#1a1a2e;color:#c49a6c;font-size:12px;cursor:pointer">' + br.mono + '</div><div class="hdr-txt"><h1>' + hdrTitle + '</h1><p>' + br.name + '</p></div><span id="cloud-status" style="width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:8px;vertical-align:middle;background:#666;flex-shrink:0" title="Sin conexion cloud"></span></div>';
            h += '<div class="hdr-actions"><button class="hdr-btn" onclick="APP.showLicenseInfo()" title="Informacion de Licencia" style="font-size:16px;line-height:1;">&#x2139;&#xFE0F;</button><button class="hdr-btn" onclick="APP.openSettings()">' + svg('settings') + '</button></div></div>';
            h += renderEstStepDots();
            h += '<div class="content" id="content">';
            if (S.estScreen === 'builder')
                h += renderEstBuilder();
            else if (S.estScreen === 'editor')
                h += renderEstEditor();
            else if (S.estScreen === 'material')
                h += renderEstMaterial();
            else if (S.estScreen === 'summary')
                h += renderEstSummary();
            h += '</div>';
            // Nav
            h += '<div class="nav">';
            if (S.estScreen === 'builder') {
                h += '<button class="nav-btn back" onclick="APP.goHome()">' + svg('left') + ' Inicio</button>';
                h += '<button class="nav-btn next" onclick="APP.estNext()"' + (S.estProject.modules.length > 0 ? '' : ' disabled') + '>Siguiente ' + svg('right') + '</button>';
            } else if (S.estScreen === 'editor') {
                h += '<button class="nav-btn back" onclick="APP.estBackToBuilder()">' + svg('left') + ' M\u00f3dulos</button>';
                h += '<button class="nav-btn next" onclick="APP.estNext()">Siguiente ' + svg('right') + '</button>';
            } else if (S.estScreen === 'material') {
                h += '<button class="nav-btn back" onclick="APP.estPrev()">' + svg('left') + ' Atr\u00e1s</button>';
                h += '<button class="nav-btn next" onclick="APP.estNext()">Ver Cotizaci\u00f3n ' + svg('right') + '</button>';
            } else {
                h += '<button class="nav-btn back" onclick="APP.estPrev()">' + svg('left') + ' Atr\u00e1s</button>';
                h += '<button class="nav-btn next" style="background:#c49a6c;color:#1a1a2e" onclick="APP.estGenClientPDF()">Generar PDF ' + svg('right') + '</button>';
            }
            h += '</div>';
            h += renderHWPicker();
            h += renderSettings();
            return h;
        }

        function render() {
            var el = $('content');
            if (el)
                scrollY = el.scrollTop;
            var br = BRANDS[S.brand] || BRANDS.primary;
            if (S.screen === 'estandarizado') {
                $('app').innerHTML = renderEstandarizado();
                applyCloudStatus();
                var el2 = $('content');
                if (el2)
                    el2.scrollTop = scrollY;
                return;
            }
            if (S.screen === 'templates') {
                var h = '<div class="hdr"><div style="display:flex;align-items:center"><div class="hdr-logo" style="background:#1a1a2e;color:#c49a6c;font-size:12px">' + br.mono + '</div><div class="hdr-txt"><h1>' + br.name + '</h1><p>Cotizador V2</p></div><span id="cloud-status" style="width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:8px;vertical-align:middle;background:#666;flex-shrink:0" title="Sin conexion cloud"></span></div><div class="hdr-actions"><button class="hdr-btn" onclick="APP.showLicenseInfo()" title="Informacion de Licencia" style="font-size:16px;line-height:1;">&#x2139;&#xFE0F;</button></div></div>';
                h += '<div class="content" id="content">' + renderTemplates() + '</div>';
                if (S.imgModal)
                    h += '<div class="img-modal" onclick="APP.closeImg()"><button class="img-modal-close" onclick="APP.closeImg()">' + svg('x') + '</button><img src="' + S.imgModal + '" onclick="event.stopPropagation()"></div>';
                $('app').innerHTML = h;
                applyCloudStatus();
                return;
            }
            var c = calc();
            var h = '<div class="hdr"><div style="display:flex;align-items:center"><div class="hdr-logo" onclick="APP.goHome()" style="background:#1a1a2e;color:#c49a6c;font-size:12px">' + br.mono + '</div><div class="hdr-txt"><h1>' + br.name + '</h1><p>Cotizador V2</p></div><span id="cloud-status" style="width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:8px;vertical-align:middle;background:#666;flex-shrink:0" title="Sin conexion cloud"></span></div>';
            h += '<div class="hdr-actions"><button class="hdr-btn" onclick="APP.showLicenseInfo()" title="Informacion de Licencia" style="font-size:16px;line-height:1;">&#x2139;&#xFE0F;</button><button class="hdr-btn" onclick="APP.openSettings()">' + svg('settings') + '</button></div></div>';
            h += '<div class="steps">';
            for (var i = 1; i <= 5; i++) {
                var cls = i === S.step ? 'active' : i < S.step ? 'done' : 'future';
                h += '<button class="step-dot ' + cls + '" onclick="APP.goStep(' + i + ')">' + i + '</button>';
                if (i < 5)
                    h += '<div class="step-line' + (i < S.step ? ' done' : '') + '"></div>';
            }
            h += '</div><div class="content" id="content">';
            if (S.step === 1)
                h += step1();
            else if (S.step === 2)
                h += step2();
            else if (S.step === 3)
                h += step3(c);
            else if (S.step === 4)
                h += step4(c);
            else
                h += step5(c);
            h += '</div>' + nav();
            h += renderHWPicker();
            h += renderSettings();
            $('app').innerHTML = h;
            applyCloudStatus();
            var el2 = $('content');
            if (el2)
                el2.scrollTop = scrollY;
            // Initialize Konva canvas when on Step 2
            if (S.step === 2) {
                initKonvaCanvas();
            }
        }

        // === APP METHODS ===
        window.APP = {
            goHome: function() {
                S.screen = 'templates';
                S.selTemplate = null;
                scrollY = 0;
                render();
            },
            selectTpl: function(id) {
                var t = TEMPLATES.find(function(x) {
                    return x.id === id;
                });
                if (!t)
                    return;
                // Convert template to estandarizado project
                var ep = defaultEstProject();
                ep.mode = 'custom';
                ep.projectType = t.type || '';
                // Material from template
                var matCode = t.matCode || '1AS';
                var matName = t.matName || 'Nogal Valentina';
                var matFinish = t.matFinish || 'Mesura';
                var matObj = {
                    brand: 'FINSA',
                    code: matCode,
                    name: matName,
                    finish: matFinish,
                    precio: FINSA_PRICES[16],
                    thickness: 16
                };
                ep.matFrentes = matObj;
                ep.matInterior = JSON.parse(JSON.stringify(matObj));
                ep.sameMaterial = true;
                ep.laborCost = t.laborCost || 5000;
                ep.ledConfig = {
                    activation: 'dimmer',
                    lightTemp: 'calida'
                };
                // Convert preModules to estandarizado modules
                ep.modules = [];
                if (t.preModules) {
                    t.preModules.forEach(function(pm) {
                        var modType = pm.type;
                        // Map old types to estandarizado types
                        if (modType === 'modulo' || modType === 'colgador' || modType === 'zapatero')
                            modType = 'normal';
                        var mod = defaultEstModule(modType === 'panelTV' ? 'panelTV' : modType === 'torreLateral' ? 'torreLateral' : modType === 'esquinero' ? 'esquinero' : modType === 'especial' ? 'especial' : modType === 'entrepa' ? 'entrepa' : modType === 'entrepanos' ? 'entrepanos' : 'normal');
                        mod.width = pm.width;
                        mod.height = t.baseHeight ? Math.min(t.baseHeight, 300) : 200;
                        // Build zones from preModule fields
                        mod.zones = [];
                        if (pm.type === 'colgador') {
                            mod.zones.push({
                                id: uid(),
                                type: 'colgador',
                                tubos: 1
                            });
                        } else if (pm.type === 'modulo') {
                            var caj = pm.cajones || 4;
                            if (caj > 0)
                                mod.zones.push({
                                    id: uid(),
                                    type: 'cajones',
                                    count: caj,
                                    cajonHeight: 20
                                });
                        } else if (pm.type === 'entrepa' || pm.type === 'torreLateral') {
                            var sh = pm.shelves || 3;
                            mod.zones.push({
                                id: uid(),
                                type: 'entrepa',
                                count: sh
                            });
                        } else if (pm.type === 'zapatero') {
                            mod.zones.push({
                                id: uid(),
                                type: 'zapatero',
                                repisas: 3,
                                repisaHeight: 15
                            });
                        }
                        // If no zones set, add default colgador
                        if (mod.zones.length === 0 && modType !== 'panelTV') {
                            mod.zones.push({
                                id: uid(),
                                type: 'colgador',
                                tubos: 1
                            });
                        }
                        // Doors
                        if (pm.doors) {
                            mod.doors = true;
                            mod.doorMode = 'por_zona';
                            mod.zones.forEach(function(z) {
                                z.doors = true;
                                z.doorMaterial = 'melamina';
                                z.doorType = pm.tipon ? 'tipon' : 'jaladera';
                            });
                        }
                        // LED
                        if (t.hasLed) {
                            mod.led = {
                                enabled: true,
                                edges: {
                                    top: true,
                                    bottom: false,
                                    left: false,
                                    right: false,
                                    shelves: false
                                },
                                shelfCount: 0,
                                metersOverride: null,
                                segmentsOverride: null
                            };
                        }
                        ep.modules.push(mod);
                    });
                }
                // Enter estandarizado flow
                S.screen = 'estandarizado';
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                S.estProject = ep;
                S.estPdfData = null;
                scrollY = 0;
                render();
            },
            openImg: function(src) {
                S.imgModal = src;
                render();
            },
            closeImg: function() {
                S.imgModal = null;
                render();
            },
            newProject: function() {
                S.screen = 'project';
                S.step = 1;
                S.project = {
                    client: '',
                    type: '',
                    sameMaterial: true,
                    matFrentes: defaultMat(),
                    matInterior: defaultMat(),
                    chapFrentesPrice: CONFIG.pricing.defaultChapPrice,
                    chapInteriorPrice: CONFIG.pricing.defaultChapPrice,
                    thickness: 16,
                    modules: [],
                    hardware: [],
                    ledConfig: { activation: 'dimmer', lightTemp: 'calida' },
                    glass: false,
                    glassM2: 0,
                    laborCost: CONFIG.pricing.defaultLaborCost,
                    freight: true,
                    freightCost: CONFIG.pricing.defaultFreightCost,
                    defaultHeight: 200,
                    defaultDepth: 50,
                    sameDepth: true,
                    chapSpec: CONFIG.pricing.defaultChapSpec,
                    enchapPrice: typeof CONFIG.pricing.defaultEnchapPrice === 'number' ? CONFIG.pricing.defaultEnchapPrice : 13
                };
                S.pdfData = null;
                S.editedPieces = {};
                scrollY = 0;
                render();
            },
            // Step navigation
            goStep: function(s) {
                if (s <= S.step) {
                    S.step = s;
                    scrollY = 0;
                    render();
                }
            },
            next: function() {
                var can = S.step === 1 ? S.project.type !== '' : S.step === 2 ? S.project.modules.length > 0 : true;
                if (can && S.step < 5) {
                    if (S.step === 4)
                        APP.initPdfData();
                    S.step++;
                    scrollY = 0;
                    render();
                }
            },
            // Step 1
            setClient: function(v) {
                S.project.client = v;
            },
            setType: function(t) {
                S.project.type = t;
                if (isDualType(t))
                    S.project.sameMaterial = false;
                else
                    S.project.sameMaterial = true;
                render();
            },
            togSameMat: function() {
                S.project.sameMaterial = !S.project.sameMaterial;
                if (S.project.sameMaterial)
                    S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                render();
            },
            setMatFrentes: function(val) {
                var parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    S.project.matFrentes.name = rest;
                    if (S.project.sameMaterial)
                        S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    S.project.matFrentes.customPrice = parseFloat(rest) || 0;
                    if (S.project.sameMaterial)
                        S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    S.project.matFrentes = {
                        brand: 'CUSTOM',
                        code: '',
                        name: S.project.matFrentes.brand === 'CUSTOM' ? S.project.matFrentes.name : '',
                        finish: '',
                        customPrice: S.project.matFrentes.brand === 'CUSTOM' ? S.project.matFrentes.customPrice : 0,
                        thickness: S.project.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        S.project.matFrentes = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[S.project.thickness],
                            thickness: S.project.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        S.project.matFrentes = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: S.project.thickness
                        };
                }
                if (S.project.sameMaterial)
                    S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                render();
            },
            setMatInterior: function(val) {
                var parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    S.project.matInterior.name = rest;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    S.project.matInterior.customPrice = parseFloat(rest) || 0;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    S.project.matInterior = {
                        brand: 'CUSTOM',
                        code: '',
                        name: S.project.matInterior.brand === 'CUSTOM' ? S.project.matInterior.name : '',
                        finish: '',
                        customPrice: S.project.matInterior.brand === 'CUSTOM' ? S.project.matInterior.customPrice : 0,
                        thickness: S.project.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        S.project.matInterior = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[S.project.thickness],
                            thickness: S.project.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        S.project.matInterior = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: S.project.thickness
                        };
                }
                render();
            },
            setThick: function(t) {
                S.project.thickness = t;
                render();
            },
            setCustomThick: function() {
                if ([16, 18, 25].indexOf(S.project.thickness) !== -1)
                    S.project.thickness = 12;
                render();
            },
            setChapF: function(v) {
                S.project.chapFrentesPrice = v || 0;
                if (S.project.sameMaterial)
                    S.project.chapInteriorPrice = v || 0;
                render();
            },
            setEnchapPrice: function(v) {
                S.project.enchapPrice = Math.max(0, v || 0);
                render();
            },
            setChapI: function(v) {
                S.project.chapInteriorPrice = v || 0;
                render();
            },
            setChapSpec: function(v) {
                S.project.chapSpec = v;
            },
            // Step 2 - Modules
            addMod: function(t) {
                pushUndo();
                var m = MODS[t];
                var newMod = {
                    id: uid(),
                    type: t,
                    name: m.n,
                    width: m.w[m.w.length > 1 ? 1 : 0],
                    doors: false,
                    tipon: false,
                    cajones: t === 'modulo' ? 4 : undefined,
                    shelves: t === 'entrepa' ? 5 : t === 'torreLateral' ? 3 : undefined,
                    corrTier: 'corr_eco',
                    led: {
                        enabled: false,
                        edges: {
                            top: false,
                            bottom: false,
                            left: false,
                            right: false,
                            shelves: false
                        },
                        shelfCount: 0,
                        ledMeters: 0,
                        segments: 0,
                        metersOverride: null,
                        segmentsOverride: null
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    }
                };
                // Auto-populate zoclo width from sum of all bajo module widths (CEXT-01)
                if (t === 'zoclo') {
                    var bajoTypes = ['bajoEstandar', 'fregadero', 'cajonera', 'esquineroCiego', 'hornoBase'];
                    var totalBajoWidth = 0;
                    S.project.modules.forEach(function(existing) {
                        if (bajoTypes.indexOf(existing.type) !== -1) {
                            totalBajoWidth += (existing.width || 60) * (existing.quantity || 1);
                        }
                    });
                    if (totalBajoWidth > 0) {
                        newMod.width = totalBajoWidth;
                    }
                }
                // Set initial canvas position: place next to last module or at origin
                var lastMod = S.project.modules.length > 0 ? S.project.modules[S.project.modules.length - 1] : null;
                if (lastMod && typeof lastMod.canvasX === 'number') {
                    newMod.canvasX = lastMod.canvasX + (lastMod.width || 60) * PX_PER_CM + 10;
                    newMod.canvasY = lastMod.canvasY || 100;
                } else {
                    newMod.canvasX = 50;
                    newMod.canvasY = 100;
                }
                S.project.modules.push(newMod);
                S.bpSelectedMod = newMod.id;
                S.editedPieces = {};
                render();
            },
            selectBpMod: function(id) {
                S.bpSelectedMod = S.bpSelectedMod === id ? null : id;
                render();
            },
            // Konva canvas controls
            bpUndo: function() {
                popUndo();
            },
            bpZoomIn: function() {
                konvaZoom = Math.min(5, konvaZoom + 0.25);
                if (konvaStage) {
                    konvaStage.scale({ x: konvaZoom, y: konvaZoom });
                    konvaStage.batchDraw();
                }
                updateZoomLabel();
            },
            bpZoomOut: function() {
                konvaZoom = Math.max(0.5, konvaZoom - 0.25);
                if (konvaStage) {
                    konvaStage.scale({ x: konvaZoom, y: konvaZoom });
                    konvaStage.batchDraw();
                }
                updateZoomLabel();
            },
            bpToggleWall: function() {
                konvaWallMode = !konvaWallMode;
                var cont = document.getElementById('bp-konva-stage');
                if (cont) {
                    if (konvaWallMode) cont.classList.add('wall-mode');
                    else cont.classList.remove('wall-mode');
                }
                // Re-render to update toolbar button state
                render();
            },
            bpCenterView: function() {
                if (!konvaStage) return;
                var P = S.project;
                if (P.modules.length === 0) {
                    konvaStage.position({ x: 0, y: 0 });
                    konvaZoom = 2;
                    konvaStage.scale({ x: konvaZoom, y: konvaZoom });
                    konvaStage.batchDraw();
                    updateZoomLabel();
                    return;
                }
                // Calculate bounding box of all modules
                var minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                P.modules.forEach(function(m) {
                    var mx = m.canvasX || 0;
                    var my = m.canvasY || 0;
                    var mw = (m.width || 60) * PX_PER_CM;
                    var mh = getModDepth(m) * PX_PER_CM;
                    if (mx < minX) minX = mx;
                    if (my < minY) minY = my;
                    if (mx + mw > maxX) maxX = mx + mw;
                    if (my + mh > maxY) maxY = my + mh;
                });
                var bw = maxX - minX + 40;
                var bh = maxY - minY + 40;
                var sw = konvaStage.width();
                var sh = konvaStage.height();
                var zoom = Math.min(sw / bw, sh / bh, 4);
                zoom = Math.max(0.5, zoom);
                konvaZoom = zoom;
                konvaStage.scale({ x: zoom, y: zoom });
                var cx = (minX + maxX) / 2;
                var cy = (minY + maxY) / 2;
                konvaStage.position({
                    x: sw / 2 - cx * zoom,
                    y: sh / 2 - cy * zoom
                });
                konvaStage.batchDraw();
                updateZoomLabel();
            },
            bpClearCanvas: function() {
                if (!confirm('Eliminar todos los modulos y paredes?')) return;
                pushUndo();
                S.project.modules = [];
                S.bpSelectedMod = null;
                konvaWalls = [];
                S.editedPieces = {};
                render();
            },
            delMod: function(id) {
                pushUndo();
                S.project.modules = S.project.modules.filter(function(m) {
                    return m.id !== id;
                });
                if (S.bpSelectedMod === id) S.bpSelectedMod = null;
                S.editedPieces = {};
                render();
            },
            setDefaultHeight: function(v) {
                S.project.defaultHeight = Math.max(50, Math.min(400, v || 200));
                S.editedPieces = {};
                render();
            },
            setDefaultDepth: function(v) {
                S.project.defaultDepth = Math.max(20, Math.min(100, v || 50));
                S.editedPieces = {};
                render();
            },
            togSameDepth: function() {
                S.project.sameDepth = !S.project.sameDepth;
                S.editedPieces = {};
                render();
            },
            setModDepth: function(id, v) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) {
                    m.depth = Math.max(20, Math.min(120, v || 50));
                    S.editedPieces = {};
                    render();
                }
            },
            setModW: function(id, w) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.width = w;
                    S.editedPieces = {};
                    render();
                }
            },
            setModH: function(id, h) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.height = h || 0;
                    S.editedPieces = {};
                    render();
                }
            },
            setModC: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.cajones = n;
                    if (n === 0 && typeof m.shelves !== 'number')
                        m.shelves = 3;
                    S.editedPieces = {};
                    render();
                }
            },
            setModS: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.shelves = n;
                    S.editedPieces = {};
                    render();
                }
            },
            setModCorr: function(id, tier) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.corrTier = tier;
                    S.editedPieces = {};
                    render();
                }
            },
            setModW2: function(id, w) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m.width2 = w; S.editedPieces = {}; render(); }
            },
            setModAventos: function(id, model) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m.aventosModel = model; S.editedPieces = {}; render(); }
            },
            setModShelves: function(id, n) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m.shelves = n; S.editedPieces = {}; render(); }
            },
            togModProp: function(id, prop) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m[prop] = !m[prop]; S.editedPieces = {}; render(); }
            },
            setModProp: function(id, prop, val) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m[prop] = val; S.editedPieces = {}; render(); }
            },
            togDoor: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.doors = !m.doors;
                    if (!m.doors) {
                        m.tipon = false;
                        m.quoteMode = 'completo';
                    }
                    S.editedPieces = {};
                    render();
                }
            },
            togTipon: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.tipon = !m.tipon;
                    S.editedPieces = {};
                    render();
                }
            },
            setQuoteMode: function(id, mode) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.quoteMode = mode;
                    if (mode === 'solo_puertas') {
                        m.doors = true;
                    }
                    S.editedPieces = {};
                    render();
                }
            },
            // Paint (custom mode)
            togPaint: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    if (!m.paint)
                        m.paint = {
                            enabled: false,
                            name: '',
                            pricePerLiter: 0,
                            coats: 2,
                            scope: 'doors'
                        };
                    m.paint.enabled = !m.paint.enabled;
                    render();
                }
            },
            setPaintName: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.name = v;
                }
            },
            setPaintPrice: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.pricePerLiter = Math.max(0, v || 0);
                    render();
                }
            },
            setPaintCoats: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.coats = Math.max(1, Math.min(5, v || 2));
                    render();
                }
            },
            setPaintScope: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.scope = v;
                    render();
                }
            },
            // Hardware picker
            openHWPicker: function() {
                S.showHWPicker = true;
                S.hwFilter = {
                    marca: '',
                    cat: '',
                    q: ''
                };
                render();
                setTimeout(function() {
                    var i = $('hwSearchInput');
                    if (i)
                        i.focus();
                }, 100);
            },
            closeHWPicker: function(e) {
                if (!e || e.target.classList.contains('hw-picker')) {
                    S.showHWPicker = false;
                    S.estHwSwapKey = null;
                    render();
                }
            },
            hwSearch: function(q) {
                S.hwFilter.q = q;
                var listEl = $('hwListContainer');
                if (listEl) {
                    listEl.innerHTML = buildHWListHTML(filterHW(), !!S.estHwSwapKey);
                } else {
                    render();
                }
            },
            hwFilterMarca: function(m) {
                S.hwFilter.marca = m;
                render();
            },
            hwFilterCat: function(c) {
                S.hwFilter.cat = c;
                render();
            },
            hwCartAdd: function(codigo) {
                var item = getCatalog().find(function(x) {
                    return x.codigo === codigo;
                });
                if (!item)
                    return;
                // Check if in swap mode for estandarizado auto-HW
                if (S.estHwSwapKey) {
                    var EP = S.estProject;
                    if (!EP.hwOverrides)
                        EP.hwOverrides = {};
                    if (!EP.hwOverrides[S.estHwSwapKey])
                        EP.hwOverrides[S.estHwSwapKey] = {};
                    EP.hwOverrides[S.estHwSwapKey].swap = {
                        desc: item.descripcion,
                        marca: item.marca,
                        price: adjPrice(item),
                        catItem: item
                    };
                    S.estHwSwapKey = null;
                    S.showHWPicker = false;
                    render();
                    return;
                }
                var hwArr = S.screen === 'estandarizado' ? S.estProject.hardware : S.project.hardware;
                hwArr.push({
                    codigo: item.codigo,
                    descripcion: item.descripcion,
                    unidad: item.unidad,
                    precio: item.precio,
                    marca: item.marca,
                    categoria: item.categoria,
                    qty: 1
                });
                render();
            },
            hwCartQty: function(codigo, delta) {
                var hwArr = S.screen === 'estandarizado' ? S.estProject.hardware : S.project.hardware;
                var idx = hwArr.findIndex(function(x) {
                    return x.codigo === codigo;
                });
                if (idx >= 0) {
                    hwArr[idx].qty += delta;
                    if (hwArr[idx].qty <= 0)
                        hwArr.splice(idx, 1);
                }
                render();
            },
            hwQty: function(idx, delta) {
                if (S.project.hardware[idx]) {
                    S.project.hardware[idx].qty += delta;
                    if (S.project.hardware[idx].qty <= 0)
                        S.project.hardware.splice(idx, 1);
                }
                render();
            },
            // LED per-module
            togModLed: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    if (!m.led)
                        m.led = {
                            enabled: false,
                            edges: {
                                top: false,
                                bottom: false,
                                left: false,
                                right: false,
                                shelves: false
                            },
                            shelfCount: 0,
                            ledMeters: 0,
                            segments: 0,
                            metersOverride: null,
                            segmentsOverride: null
                        };
                    m.led.enabled = !m.led.enabled;
                    render();
                }
            },
            togLedEdge: function(id, edge) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.edges[edge] = !m.led.edges[edge];
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedShelves: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.shelfCount = Math.max(0, n || 0);
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedMeters: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.metersOverride = Math.max(0, v || 0);
                    render();
                }
            },
            setLedSegments: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.segmentsOverride = Math.max(0, v || 0);
                    render();
                }
            },
            resetLedOverride: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedActivation: function(type) {
                S.project.ledConfig.activation = type;
                render();
            },
            setLedTemp: function(temp) {
                S.project.ledConfig.lightTemp = temp;
                render();
            },
            // Extras
            togGlass: function() {
                S.project.glass = !S.project.glass;
                render();
            },
            setGlassM2: function(v) {
                S.project.glassM2 = v || 0;
                render();
            },
            // Step 3
            setLabor: function(v) {
                S.project.laborCost = Math.max(0, v || 0);
                render();
            },
            togFreight: function() {
                S.project.freight = !S.project.freight;
                render();
            },
            setFreightCost: function(v) {
                S.project.freightCost = Math.max(0, v || 0);
                render();
            },
            togCostBD: function() {
                S.showCostBreakdown = !S.showCostBreakdown;
                render();
            },
            setModCatTab: function(tab) {
                S.modCatTab = tab;
                render();
            },
            setView: function(v) {
                S.view = v;
                render();
            },
            // Settings
            openSettings: function() {
                S.showSettings = true;
                render();
            },
            closeSettings: function(e) {
                if (!e || e.target.classList.contains('settings-overlay')) {
                    S.showSettings = false;
                    render();
                }
            },
            setMarginPreset: function(p) {
                S.settings.marginPreset = p;
                if (p === 'estandar') {
                    S.settings.marginCarp = CONFIG.pricing.marginCarp;
                    S.settings.marginHwStd = CONFIG.pricing.marginHwStd;
                }
                else if (p === 'conservador') {
                    S.settings.marginCarp = 60;
                    S.settings.marginHwStd = 60;
                }
                render();
            },
            setMarginCarp: function(v) {
                S.settings.marginCarp = Math.max(0, Math.min(90, v || 0));
                S.settings.marginPreset = 'custom';
                render();
            },
            setMarginHwStd: function(v) {
                S.settings.marginHwStd = Math.max(0, Math.min(90, v || 0));
                S.settings.marginPreset = 'custom';
                render();
            },
            setSupplierAdj: function(marca, val) {
                S.settings.supplierAdj[marca] = val || 0;
                render();
            },
            // Brand
            setBrand: function(b) {
                S.brand = b;
                try {
                    localStorage.setItem(CONFIG.storage.prefix + 'brand', b);
                } catch (e) {}
                render();
            },
            // Logo
            uploadLogo: function() {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    var file = e.target.files[0];
                    if (!file)
                        return;
                    var reader = new FileReader();
                    reader.onload = function(ev) {
                        var img = new Image();
                        img.onload = function() {
                            var canvas = document.createElement('canvas');
                            var maxW = 300,
                                scale = Math.min(maxW / img.width, 1);
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            var ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            var b64 = canvas.toDataURL('image/png');
                            S.logoBase64 = b64;
                            try {
                                localStorage.setItem(CONFIG.storage.prefix + 'logo_base64', b64);
                            } catch (e2) {}
                            render();
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                };
                input.click();
            },
            removeLogo: function() {
                S.logoBase64 = null;
                try {
                    localStorage.removeItem(CONFIG.storage.prefix + 'logo_base64');
                } catch (e) {}
                render();
            },
            setQuoteCounter: function(v) {
                S.quoteCounter = Math.max(1, v || 1);
                try {
                    localStorage.setItem(CONFIG.storage.prefix + 'quote_counter', S.quoteCounter);
                } catch (e) {}
                render();
            },
            // PDF
            initPdfData: function() {
                var P = S.project,
                    c = calc(),
                    type = TYPES.find(function(t) {
                        return t.id === P.type;
                    });
                var yr = new Date().getFullYear();
                var qnum = CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
                // Round total price to nearest 500
                var totalPrice = Math.round(c.subtotal / 500) * 500;
                // Build one item per module with proportional price allocation
                var tw = P.modules.reduce(function(a, x) { return a + x.width; }, 0);
                var items = [];
                var priceAllocated = 0;
                P.modules.forEach(function(m, idx) {
                    var mh = (m.height || P.defaultHeight || 200);
                    // Proportional price by width
                    var proportion = tw > 0 ? m.width / tw : 1 / P.modules.length;
                    var mPrice;
                    if (idx === P.modules.length - 1) {
                        mPrice = totalPrice - priceAllocated; // last module gets remainder
                    } else {
                        mPrice = Math.round(totalPrice * proportion / 100) * 100;
                        priceAllocated += mPrice;
                    }
                    // Build description
                    var desc = m.name;
                    var matLine = P.matFrentes.name;
                    if (c.useDual) matLine += ' (frentes) / ' + P.matInterior.name + ' (interior)';
                    desc += '\nMaterial: ' + matLine;
                    var mcaj = typeof m.cajones === 'number' ? m.cajones : (m.type === 'modulo' ? 4 : 0);
                    if (mcaj > 0) desc += '\n' + mcaj + ' cajones';
                    else if (m.type === 'modulo') desc += '\n' + (typeof m.shelves === 'number' ? m.shelves : 3) + ' entrepaños';
                    if (m.doors) desc += m.tipon ? '\nPuertas con tip-on' : '\nCon puertas';
                    if (m.led && m.led.enabled) desc += '\nIluminacion LED';
                    desc += '\nHerrajes incluidos';
                    desc += '\nInstalacion incluida';
                    items.push({
                        name: m.name,
                        desc: desc,
                        dims: m.width + 'cm x ' + mh + 'cm',
                        price: mPrice,
                        qty: 1
                    });
                });
                S.pdfData = {
                    client: P.client || '',
                    projectName: (type ? type.n : 'Proyecto'),
                    location: '',
                    quoteNum: qnum,
                    deliveryTime: CONFIG.quoting.defaultDelivery,
                    anticipo: CONFIG.quoting.defaultAnticipo,
                    notes: '',
                    items: items
                };
            },
            setPdfField: function(key, val) {
                if (S.pdfData)
                    S.pdfData[key] = val;
            },
            setPdfItemPrice: function(idx, val) {
                if (S.pdfData && S.pdfData.items[idx])
                    S.pdfData.items[idx].price = val || 0;
                render();
            },
            setPdfItemDesc: function(idx, val) {
                if (S.pdfData && S.pdfData.items[idx])
                    S.pdfData.items[idx].desc = val;
            },
            editPiece: function(key, field, val) {
                if (!S.editedPieces[key])
                    S.editedPieces[key] = {};
                S.editedPieces[key][field] = val;
                render();
            },
            resetEdits: function() {
                S.editedPieces = {};
                render();
            },
            genClientPDF: function() {
                genClientPDF();
            },
            genInternalPDF: function() {
                genInternalPDF();
            },
            genDespiece: function() {
                genDespiece();
            },
            genQuickPDF: function(pdfType) {
                var t = TEMPLATES.find(function(x) {
                    return x.id === S.selTemplate;
                });
                if (!t)
                    return;
                var nw = S.quickWidth,
                    nh = S.quickHeight;
                var ratio = (nw * nh) / (t.baseWidth * t.baseHeight);
                var newPrice = Math.round(t.basePrice * ratio / 500) * 500;
                var matName = S.quickMatName || t.matName;
                var yr = new Date().getFullYear();
                var qnum = CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
                var desc = t.name + '\nMaterial: Melamina ' + matName + ' 16mm\nMedida: ' + (nw / 100) + 'm x ' + (nh / 100) + 'm';
                if (t.preModules) {
                    desc += '\n\nIncluye:';
                    t.preModules.forEach(function(pm) {
                        var mod = MODS[pm.type];
                        desc += '\n- ' + mod.n + ' ' + pm.width + 'cm';
                        if (pm.doors)
                            desc += pm.tipon ? ' con puertas tip-on' : ' con puertas';
                    });
                }
                if (t.hasLed)
                    desc += '\n- Iluminacion LED perimetral completa';
                if (t.hasGlass)
                    desc += '\n- Vidrio templado';
                desc += '\n- Herrajes incluidos\n- Instalacion incluida';
                S.pdfData = {
                    client: '',
                    projectName: t.name,
                    location: '',
                    quoteNum: qnum,
                    deliveryTime: t.weeks + ' semanas',
                    anticipo: CONFIG.quoting.defaultAnticipo,
                    notes: '',
                    items: [{
                        desc: desc,
                        dims: (nw / 100) + 'm x ' + (nh / 100) + 'm',
                        price: newPrice
                    }]
                };
                if (pdfType === 'client') {
                    genClientPDF();
                    return;
                }
                // For internal/despiece PDF, populate S.project from template so calc() works
                var savedProject = JSON.parse(JSON.stringify(S.project));
                try {
                    var widthRatio = nw / t.baseWidth;
                    var mat = {
                        brand: 'FINSA',
                        code: t.matCode || '74V',
                        name: matName,
                        finish: t.matFinish || 'Atlas',
                        precio: FINSA_PRICES[16],
                        thickness: 16
                    };
                    S.project.type = t.type || 'tv';
                    S.project.sameMaterial = true;
                    S.project.matFrentes = mat;
                    S.project.matInterior = mat;
                    S.project.defaultHeight = Math.round(nh / 10) * 10 || 200;
                    S.project.defaultDepth = 50;
                    S.project.laborCost = Math.round((t.laborCost || 5000) * ratio);
                    S.project.ledConfig = {
                        activation: 'dimmer',
                        lightTemp: 'calida'
                    };
                    S.project.glass = !!t.hasGlass;
                    S.project.glassM2 = t.hasGlass ? Math.round((nw / 100) * (nh / 100) * 0.3 * 10) / 10 : 0;
                    S.project.hardware = [];
                    S.project.modules = [];
                    if (t.preModules) {
                        t.preModules.forEach(function(pm) {
                            var scaledW = Math.round(pm.width * widthRatio / 10) * 10;
                            if (scaledW < 30)
                                scaledW = 30;
                            if (scaledW > 300)
                                scaledW = 300;
                            var ledObj = {
                                enabled: false,
                                edges: {
                                    top: false,
                                    bottom: false,
                                    left: false,
                                    right: false,
                                    shelves: false
                                },
                                shelfCount: 0,
                                ledMeters: 0,
                                segments: 0,
                                metersOverride: null,
                                segmentsOverride: null
                            };
                            if (t.hasLed) {
                                ledObj.enabled = true;
                                ledObj.edges.top = true;
                            }
                            S.project.modules.push({
                                id: uid(),
                                type: pm.type,
                                name: MODS[pm.type].n,
                                width: scaledW,
                                cajones: pm.cajones || 4,
                                doors: !!pm.doors,
                                tipon: !!pm.tipon,
                                shelves: pm.shelves || 3,
                                corrTier: pm.corrTier || 'corr_eco',
                                led: ledObj
                            });
                        });
                    }
                    if (pdfType === 'despiece')
                        genDespiece();
                    else
                        genInternalPDF();
                } catch (e) {
                    alert('Error generando PDF: ' + e.message);
                }
                S.project = savedProject;
            },
            // Copy
            copy: function() {
                var P = S.project,
                    c = calc(),
                    type = TYPES.find(function(t) {
                        return t.id === P.type;
                    }),
                    br = BRANDS[S.brand] || BRANDS.primary,
                    txt = '';
                if (S.view === 'quote') {
                    txt = br.name + '\n' + br.tagline + '\n\n';
                    txt += 'Fecha: ' + date() + '\nCliente: ' + (P.client || 'Sin nombre') + '\nProyecto: ' + (type ? type.n : '') + '\n\n';
                    txt += 'MODULOS:\n';
                    P.modules.forEach(function(m, i) {
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : (m.type === 'modulo' ? 4 : 0);
                        var extra = mcaj > 0 ? ' (' + mcaj + ' cajones)' : (m.type === 'modulo' ? ' (' + (typeof m.shelves === 'number' ? m.shelves : 3) + ' entrepaños)' : '');
                        txt += (i + 1) + '. ' + m.name + ' ' + m.width + 'cm' + (m.height ? ' x ' + m.height + 'cm' : '') + extra + (m.doors ? ' con puertas' : '') + '\n';
                    });
                    txt += '\nMaterial: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '\n';
                    if (c.ledBOM || P.glass) {
                        txt += '\nExtras:\n';
                        if (c.ledBOM)
                            txt += '- Iluminacion LED perimetral completa\n';
                        if (P.glass)
                            txt += '- Vidrio templado\n';
                    }
                    txt += '\nSubtotal: ' + fmt(c.subtotal) + '\nIVA ' + Math.round(CONFIG.pricing.iva * 100) + '%: ' + fmt(c.iva) + '\nTOTAL: ' + fmt(c.total) + '\n\n';
                    txt += CONFIG.quoting.defaultAnticipo + '% anticipo | Entrega ' + CONFIG.quoting.defaultDelivery + '\nIncluye instalacion\n\n' + CONTACT.cell + '\n' + CONTACT.email;
                } else {
                    txt = 'DESPIECE - ' + (BRANDS[S.brand] || BRANDS.primary).name + '\n\nFecha: ' + date() + '\nCliente: ' + (P.client || 'Sin nombre') + '\nMaterial: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '\n';
                    if (P.chapSpec)
                        txt += 'Chapacanto: ' + P.chapSpec + '\n';
                    txt += '\nHojas: ' + c.totalSheets + ' | Canto: ' + c.totalCanto + ' ml\n\n';
                    P.modules.forEach(function(m) {
                        var pcs = c.pieces.filter(function(p) {
                            return p.mid === m.id;
                        });
                        pcs.sort(function(a, b) {
                            var alA = anchoLargo(a.w, a.h),
                                alB = anchoLargo(b.w, b.h);
                            return alB.largo - alA.largo;
                        });
                        var mHdr = m.name + ' ' + m.width + 'cm';
                        if (m.height)
                            mHdr += ' x ' + m.height + 'cm';
                        txt += mHdr + '\n';
                        pcs.forEach(function(p) {
                            var al = anchoLargo(p.w, p.h);
                            var eKey = m.id + ':' + p.n;
                            var ep = S.editedPieces[eKey] || {};
                            var eq = typeof ep.q === 'number' ? ep.q : p.q;
                            var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                            var el2 = typeof ep.largo === 'number' ? ep.largo : al.largo;
                            txt += '  ' + p.n + ': ' + eq + 'x  Ancho:' + ea + ' Largo:' + el2 + 'mm (' + p.t + 'mm)\n';
                        });
                        txt += '\n';
                    });
                    txt += 'HERRAJES:\n';
                    c.allHW.forEach(function(hw) {
                        txt += '- ' + hw.desc + ': ' + Math.ceil(hw.qty) + ' (' + hw.marca + ')\n';
                    });
                }
                navigator.clipboard.writeText(txt).then(function() {
                    S.copied = true;
                    render();
                    setTimeout(function() {
                        S.copied = false;
                        render();
                    }, 2000);
                });
            },
            // === V2.3: Closet Estandarizado Methods ===
            newEstandarizado: function() {
                S.screen = 'estandarizado';
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                S.estProject = defaultEstProject();
                S.estPdfData = null;
                scrollY = 0;
                render();
            },
            estGoStep: function(step) {
                var steps = ['builder', 'editor', 'material', 'summary'];
                var ci = steps.indexOf(S.estScreen);
                var ti = steps.indexOf(step);
                if (ti <= ci) {
                    S.estScreen = step;
                    if (step === 'builder')
                        S.estEditIdx = -1;
                    scrollY = 0;
                    render();
                }
            },
            estNext: function() {
                var steps = ['builder', 'editor', 'material', 'summary'];
                var ci = steps.indexOf(S.estScreen);
                if (S.estScreen === 'builder' && S.estProject.modules.length === 0)
                    return;
                if (S.estScreen === 'builder') {
                    // If haven't edited any module, go to editor of first module
                    S.estEditIdx = 0;
                    S.estScreen = 'editor';
                } else if (ci < steps.length - 1) {
                    S.estScreen = steps[ci + 1];
                }
                scrollY = 0;
                render();
            },
            estPrev: function() {
                var steps = ['builder', 'editor', 'material', 'summary'];
                var ci = steps.indexOf(S.estScreen);
                if (ci > 0) {
                    S.estScreen = steps[ci - 1];
                    if (S.estScreen === 'builder')
                        S.estEditIdx = -1;
                    scrollY = 0;
                    render();
                }
            },
            estSetClient: function(v) {
                S.estProject.client = v;
            },
            // Modules
            estAddMod: function(modType) {
                S.estProject.modules.push(defaultEstModule(modType));
                scrollY = 0;
                render();
            },
            estDuplicateModules: function() {
                var EP = S.estProject;
                if (EP.modules.length === 0)
                    return;
                var clones = JSON.parse(JSON.stringify(EP.modules));
                clones.forEach(function(m) {
                    m.id = uid();
                    if (m.name)
                        m.name = m.name + ' (Copia)';
                    if (m.zones)
                        m.zones.forEach(function(z) {
                            z.id = uid();
                        });
                });
                EP.modules = EP.modules.concat(clones);
                scrollY = 0;
                render();
            },
            estDelMod: function(idx) {
                S.estProject.modules.splice(idx, 1);
                if (S.estEditIdx >= S.estProject.modules.length)
                    S.estEditIdx = S.estProject.modules.length - 1;
                render();
            },
            estMoveMod: function(idx, dir) {
                var mods = S.estProject.modules;
                var ni = idx + dir;
                if (ni < 0 || ni >= mods.length)
                    return;
                var tmp = mods[idx];
                mods[idx] = mods[ni];
                mods[ni] = tmp;
                render();
            },
            estEditMod: function(idx) {
                S.estEditIdx = idx;
                S.estScreen = 'editor';
                scrollY = 0;
                render();
            },
            estBackToBuilder: function() {
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                scrollY = 0;
                render();
            },
            estSetWidth: function(idx, w) {
                var m = S.estProject.modules[idx];
                if (m) {
                    m.width = w;
                    render();
                }
            },
            estSetCustomWidth: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (EST_WIDTHS.indexOf(m.width) !== -1)
                    m.width = 45;
                render();
            },
            estSetModHeight: function(idx, h) {
                var m = S.estProject.modules[idx];
                var minH = m && m.type === 'fijo' ? 5 : 50;
                if (m) {
                    m.height = Math.max(minH, Math.min(300, h || 200));
                    render();
                }
            },
            estSetProjectDepth: function(d) {
                S.estProject.projectDepth = Math.max(30, Math.min(120, d || 60));
                render();
            },
            estSetProjectType: function(typeId) {
                S.estProject.projectType = typeId;
                render();
            },
            estTogSameDepth: function() {
                S.estProject.sameDepth = !S.estProject.sameDepth;
                render();
            },
            estSetModDepth: function(idx, d) {
                var m = S.estProject.modules[idx];
                if (m) { m.depth = Math.max(20, Math.min(120, d || 60)); render(); }
            },
            estTogMarco: function(idx) {
                var m = S.estProject.modules[idx];
                if (m) { m.marco = !m.marco; render(); }
            },
            estSetShelfCount: function(idx, count) {
                var m = S.estProject.modules[idx];
                if (m) { m.shelfCount = Math.max(1, Math.min(12, count || 3)); render(); }
            },
            // Zones
            estAddZone: function(idx, type) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                // panelTV and entrepanos have no zones
                if (m.type === 'panelTV' || m.type === 'entrepanos')
                    return;
                // Especial modules: entrepaños and colgador allowed
                if (m.type === 'especial' && type !== 'entrepa' && type !== 'colgador')
                    return;
                var z = {
                    id: uid(),
                    type: type
                };
                if (type === 'cajones') {
                    z.count = 3;
                    z.cajonHeight = 20;
                }
                else if (type === 'colgador') {
                    z.tubos = 1;
                }
                else if (type === 'zapatero') {
                    z.repisas = 3;
                    z.repisaHeight = 15;
                }
                else if (type === 'entrepa') {
                    z.count = 2;
                }
                m.zones.push(z);
                render();
            },
            estDelZone: function(idx, zi) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones.splice(zi, 1);
                render();
            },
            estMoveZone: function(idx, zi, dir) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                var ni = zi + dir;
                if (ni < 0 || ni >= m.zones.length)
                    return;
                var tmp = m.zones[zi];
                m.zones[zi] = m.zones[ni];
                m.zones[ni] = tmp;
                render();
            },
            estSetZoneCount: function(idx, zi, n) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].count = n;
                render();
            },
            estSetZoneHeight: function(idx, zi, h) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].cajonHeight = h;
                render();
            },
            estSetZoneTubos: function(idx, zi, n) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].tubos = n;
                render();
            },
            estSetZoneRepisas: function(idx, zi, n) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].repisas = n;
                render();
            },
            estSetZoneRepisaHeight: function(idx, zi, h) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.zones[zi].repisaHeight = h;
                render();
            },
            estSetWidth2: function(idx, w) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.width2 = w;
                render();
            },
            // Module-level door controls
            estTogDoors: function(idx, enabled, mode) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.doors = enabled;
                if (mode)
                    m.doorMode = mode;
                if (!enabled)
                    m.quoteMode = 'completo';
                if (enabled && !m.doorMaterial)
                    m.doorMaterial = 'melamina';
                if (enabled && !m.doorType)
                    m.doorType = 'tipon';
                if (enabled && !m.doorCount)
                    m.doorCount = 2;
                // When switching to completa, clear per-zone doors
                if (mode === 'completa') {
                    m.zones.forEach(function(z) {
                        z.doors = false;
                    });
                }
                render();
            },
            estSetQuoteMode: function(idx, mode) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.quoteMode = mode;
                if (mode === 'solo_puertas') {
                    m.doors = true;
                    if (!m.doorMode)
                        m.doorMode = 'completa';
                    if (!m.doorMaterial)
                        m.doorMaterial = 'melamina';
                    if (!m.doorType)
                        m.doorType = 'tipon';
                    if (!m.doorCount)
                        m.doorCount = 2;
                }
                render();
            },
            estSetDoorCount: function(idx, cnt) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.doorCount = cnt;
                render();
            },
            estSetDoorMat: function(idx, mat) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.doorMaterial = mat;
                render();
            },
            estSetDoorType2: function(idx, type) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.doorType = type;
                render();
            },
            // Zone doors
            estSetZoneDoor: function(idx, zi, bool) {
                var m = S.estProject.modules[idx];
                if (!m || !m.zones[zi])
                    return;
                m.zones[zi].doors = bool;
                if (bool && !m.zones[zi].doorMaterial)
                    m.zones[zi].doorMaterial = 'melamina';
                if (bool && !m.zones[zi].doorType)
                    m.zones[zi].doorType = 'tipon';
                render();
            },
            estSetZoneDoorMat: function(idx, zi, mat) {
                var m = S.estProject.modules[idx];
                if (!m || !m.zones[zi])
                    return;
                m.zones[zi].doorMaterial = mat;
                render();
            },
            estSetZoneDoorType: function(idx, zi, type) {
                var m = S.estProject.modules[idx];
                if (!m || !m.zones[zi])
                    return;
                m.zones[zi].doorType = type;
                render();
            },
            // Maletero doors
            estSetMaleteroDoor: function(idx, bool) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.maletero)
                    m.maletero = {
                        enabled: true,
                        height: 30
                    };
                m.maletero.doors = bool;
                if (bool && !m.maletero.doorMaterial)
                    m.maletero.doorMaterial = 'melamina';
                if (bool && !m.maletero.doorType)
                    m.maletero.doorType = 'tipon';
                render();
            },
            estSetMaleteroDoorMat: function(idx, mat) {
                var m = S.estProject.modules[idx];
                if (!m || !m.maletero)
                    return;
                m.maletero.doorMaterial = mat;
                render();
            },
            estSetMaleteroDoorType: function(idx, type) {
                var m = S.estProject.modules[idx];
                if (!m || !m.maletero)
                    return;
                m.maletero.doorType = type;
                render();
            },
            // Zoclo
            estTogZoclo: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.zoclo)
                    m.zoclo = {
                        enabled: false,
                        height: 10
                    };
                m.zoclo.enabled = !m.zoclo.enabled;
                render();
            },
            estSetZocloHeight: function(idx, h) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.zoclo)
                    m.zoclo = {
                        enabled: true,
                        height: 10
                    };
                m.zoclo.height = Math.max(5, Math.min(25, h || 10));
                render();
            },
            // Maletero
            estTogMaletero: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.maletero)
                    m.maletero = {
                        enabled: false,
                        height: 30
                    };
                m.maletero.enabled = !m.maletero.enabled;
                render();
            },
            estSetMaleteroHeight: function(idx, h) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.maletero)
                    m.maletero = {
                        enabled: true,
                        height: 30
                    };
                m.maletero.height = Math.max(10, Math.min(100, h || 30));
                render();
            },
            // Paint (estandarizado)
            estTogPaint: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.paint)
                    m.paint = {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    };
                m.paint.enabled = !m.paint.enabled;
                render();
            },
            estSetPaintName: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.paint)
                    return;
                m.paint.name = v;
            },
            estSetPaintPrice: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.paint)
                    return;
                m.paint.pricePerLiter = Math.max(0, v || 0);
                render();
            },
            estSetPaintCoats: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.paint)
                    return;
                m.paint.coats = Math.max(1, Math.min(5, v || 2));
                render();
            },
            estSetPaintScope: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.paint)
                    return;
                m.paint.scope = v;
                render();
            },
            // Chapacanto
            estSetChapMode: function(idx, mode) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.chap)
                    m.chap = {
                        mode: 'perimetrico',
                        edges: {
                            latIzq: true,
                            latDer: true,
                            techo: true,
                            piso: true,
                            fondo: false
                        }
                    };
                if (mode === 'perimetrico') {
                    m.chap.mode = 'perimetrico';
                    m.chap.edges = {
                        latIzq: true,
                        latDer: true,
                        techo: true,
                        piso: true,
                        fondo: false
                    };
                } else {
                    m.chap.mode = 'individual';
                }
                render();
            },
            estTogChapEdge: function(idx, edge) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.chap)
                    m.chap = {
                        mode: 'individual',
                        edges: {
                            latIzq: false,
                            latDer: false,
                            techo: false,
                            piso: false,
                            fondo: false
                        }
                    };
                m.chap.edges[edge] = !m.chap.edges[edge];
                m.chap.mode = 'individual';
                // Check if all 4 perimetric are on
                var e = m.chap.edges;
                if (e.latIzq && e.latDer && e.techo && e.piso)
                    m.chap.mode = 'perimetrico';
                render();
            },
            // Material
            estTogSameMat: function() {
                var EP = S.estProject;
                EP.sameMaterial = !EP.sameMaterial;
                if (EP.sameMaterial)
                    EP.matInterior = JSON.parse(JSON.stringify(EP.matFrentes));
                render();
            },
            estSetMatFrentes: function(val) {
                var EP = S.estProject,
                    parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    EP.matFrentes.name = rest;
                    if (EP.sameMaterial)
                        EP.matInterior = JSON.parse(JSON.stringify(EP.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    EP.matFrentes.customPrice = parseFloat(rest) || 0;
                    if (EP.sameMaterial)
                        EP.matInterior = JSON.parse(JSON.stringify(EP.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    EP.matFrentes = {
                        brand: 'CUSTOM',
                        code: '',
                        name: EP.matFrentes.brand === 'CUSTOM' ? EP.matFrentes.name : '',
                        finish: '',
                        customPrice: EP.matFrentes.brand === 'CUSTOM' ? EP.matFrentes.customPrice : 0,
                        thickness: EP.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        EP.matFrentes = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[EP.thickness],
                            thickness: EP.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        EP.matFrentes = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: EP.thickness
                        };
                }
                if (EP.sameMaterial)
                    EP.matInterior = JSON.parse(JSON.stringify(EP.matFrentes));
                render();
            },
            estSetMatInterior: function(val) {
                var EP = S.estProject,
                    parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    EP.matInterior.name = rest;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    EP.matInterior.customPrice = parseFloat(rest) || 0;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    EP.matInterior = {
                        brand: 'CUSTOM',
                        code: '',
                        name: EP.matInterior.brand === 'CUSTOM' ? EP.matInterior.name : '',
                        finish: '',
                        customPrice: EP.matInterior.brand === 'CUSTOM' ? EP.matInterior.customPrice : 0,
                        thickness: EP.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        EP.matInterior = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[EP.thickness],
                            thickness: EP.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        EP.matInterior = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: EP.thickness
                        };
                }
                render();
            },
            estSetThick: function(t) {
                S.estProject.thickness = t;
                render();
            },
            estSetCustomThick: function() {
                if ([16, 18, 25].indexOf(S.estProject.thickness) !== -1)
                    S.estProject.thickness = 12;
                render();
            },
            estSetChapPrice: function(v) {
                S.estProject.chapFrentesPrice = v || 0;
                if (S.estProject.sameMaterial)
                    S.estProject.chapInteriorPrice = v || 0;
                render();
            },
            estSetChapPriceI: function(v) {
                S.estProject.chapInteriorPrice = v || 0;
                render();
            },
            estSetEnchapPrice: function(v) {
                S.estProject.enchapPrice = Math.max(0, v || 0);
                render();
            },
            estSetLabor: function(v) {
                S.estProject.laborCost = Math.max(0, v || 0);
                render();
            },
            estSetMultiplier: function(v) {
                S.estProject.saleMultiplier = Math.max(1, Math.min(10, Math.round((v || CONFIG.pricing.defaultSaleMultiplier) * 10) / 10));
                render();
            },
            // LED
            estTogModLed: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.led)
                    m.led = {
                        enabled: false,
                        edges: {
                            top: false,
                            bottom: false,
                            left: false,
                            right: false,
                            shelves: false
                        },
                        shelfCount: 0,
                        metersOverride: null,
                        segmentsOverride: null
                    };
                m.led.enabled = !m.led.enabled;
                render();
            },
            estTogLedEdge: function(idx, edge) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.edges[edge] = !m.led.edges[edge];
                render();
            },
            estTogLedShelves: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.edges.shelves = !m.led.edges.shelves;
                if (!m.led.edges.shelves)
                    m.led.shelfCount = 0;
                else if (m.led.shelfCount === 0)
                    m.led.shelfCount = 1;
                render();
            },
            estSetLedShelves: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.shelfCount = Math.max(0, Math.min(10, v || 0));
                render();
            },
            estSetLedMeters: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.metersOverride = Math.max(0, v || 0);
                render();
            },
            estSetLedSegments: function(idx, v) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.segmentsOverride = Math.max(0, v || 0);
                render();
            },
            estResetLedOverride: function(idx) {
                var m = S.estProject.modules[idx];
                if (!m || !m.led)
                    return;
                m.led.metersOverride = null;
                m.led.segmentsOverride = null;
                render();
            },
            estSetLedActivation: function(k) {
                S.estProject.ledConfig.activation = k;
                render();
            },
            estSetLedTemp: function(k) {
                S.estProject.ledConfig.lightTemp = k;
                render();
            },
            // HW overrides
            estHwQty: function(key, delta) {
                var EP = S.estProject;
                if (!EP.hwOverrides)
                    EP.hwOverrides = {};
                // Run calc to get auto qty
                var c = calcEstandarizado();
                var hw = c.hwConsolidated[key];
                if (!hw)
                    return;
                var currentQty = Math.ceil(hw.qty);
                var newQty = Math.max(0, currentQty + delta);
                if (!EP.hwOverrides[key])
                    EP.hwOverrides[key] = {};
                EP.hwOverrides[key].qty = newQty;
                render();
            },
            estHwSwap: function(key) {
                var def = HW_DEFAULTS[key];
                if (!def)
                    return;
                S.estHwSwapKey = key;
                S.showHWPicker = true;
                S.hwFilter = {
                    marca: '',
                    cat: def.cat,
                    q: ''
                };
                render();
                setTimeout(function() {
                    var i = $('hwSearchInput');
                    if (i)
                        i.focus();
                }, 100);
            },
            estHwReset: function(key) {
                var EP = S.estProject;
                if (!EP.hwOverrides)
                    return;
                delete EP.hwOverrides[key];
                render();
            },
            estHwQtySet: function(key, qty) {
                var EP = S.estProject;
                if (!EP.hwOverrides)
                    EP.hwOverrides = {};
                if (isNaN(qty) || qty < 0)
                    qty = 0;
                if (!EP.hwOverrides[key])
                    EP.hwOverrides[key] = {};
                EP.hwOverrides[key].qty = qty;
                render();
            },
            // Per-module HW overrides
            estModHwQty: function(idx, key, delta, absVal) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.hwOverrides)
                    m.hwOverrides = {};
                // Get current auto qty for this module+key
                var c = calcEstandarizado();
                var modEntries = c.autoHW.filter(function(ah) {
                    return ah.modId === m.id && ah.key === key;
                });
                var autoTotal = modEntries.reduce(function(a, e) {
                    return a + e.q;
                }, 0);
                var current = typeof m.hwOverrides[key] === 'number' ? m.hwOverrides[key] : autoTotal;
                var newQty;
                if (typeof absVal === 'number') {
                    newQty = Math.max(0, absVal);
                }
                else {
                    newQty = Math.max(0, current + delta);
                }
                m.hwOverrides[key] = newQty;
                render();
            },
            estModHwReset: function(idx, key) {
                var m = S.estProject.modules[idx];
                if (!m || !m.hwOverrides)
                    return;
                delete m.hwOverrides[key];
                if (Object.keys(m.hwOverrides).length === 0)
                    delete m.hwOverrides;
                render();
            },
            // Vidrio price setters
            estSetZoneVidrioPrice: function(idx, zi, price) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                var z = m.zones[zi];
                if (!z)
                    return;
                z.vidrioPrice = price;
                render();
            },
            estSetVidrioPrice: function(idx, price) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                m.vidrioPrice = price;
                render();
            },
            estSetMaleteroVidrioPrice: function(idx, price) {
                var m = S.estProject.modules[idx];
                if (!m)
                    return;
                if (!m.maletero)
                    return;
                m.maletero.vidrioPrice = price;
                render();
            },
            // PDF Generation
            estInitPdfData: function() {
                var EP = S.estProject,
                    c = calcEstandarizado();
                var isCustom = EP.mode === 'custom';
                var projName = isCustom ? 'Proyecto Personalizado' : 'Closet Estandarizado';
                var yr = new Date().getFullYear();
                var qnum = CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
                var tw = EP.modules.reduce(function(a, m2) {
                    return a + m2.width;
                }, 0);
                var desc = projName + '\nMaterial: ' + EP.matFrentes.name;
                if (!EP.sameMaterial)
                    desc += ' (frentes) / ' + EP.matInterior.name + ' (interior)';
                desc += '\n\nIncluye:';
                EP.modules.forEach(function(m, i) {
                    var line = '\n- M\u00f3dulo ' + (i + 1);
                    if (m.type === 'esquinero')
                        line += ' Esquinero ' + m.width + '\u00d7' + (m.width2 || m.width) + 'cm';
                    else if (m.type === 'fijo')
                        line += ' Fijo ' + m.width + '\u00d7' + m.height + 'cm';
                    else if (m.type === 'panelTV')
                        line += ' Panel TV ' + m.width + 'cm';
                    else if (m.type === 'torreLateral')
                        line += ' Torre Lat. ' + m.width + 'cm';
                    else
                        line += ' ' + m.width + 'cm';
                    if (isCustom)
                        line += ' \u00d7 ' + m.height + 'cm alto';
                    m.zones.forEach(function(z) {
                        if (z.type === 'cajones')
                            line += ', ' + (z.count || 3) + ' cajones';
                        else if (z.type === 'colgador')
                            line += ', colgador sencillo';
                        else if (z.type === 'zapatero')
                            line += ', ' + (z.repisas || 3) + ' cajones ext. ' + (z.repisaHeight || 15) + 'cm';
                        else if (z.type === 'entrepa')
                            line += ', ' + (z.count || 2) + ' entrepa\u00f1os';
                    });
                    if (m.doors) {
                        var dMode = m.doorMode || 'por_zona';
                        if (dMode === 'completa')
                            line += ', ' + (m.doorCount || 2) + ' puerta' + ((m.doorCount || 2) > 1 ? 's' : '') + ' completa' + ((m.doorCount || 2) > 1 ? 's' : '');
                        else
                            line += ', puertas por zona';
                    }
                    var malWa = m.maletero || {
                        enabled: false
                    };
                    if (malWa.enabled)
                        line += ', maletero ' + (malWa.height || 30) + 'cm';
                    desc += line;
                });
                desc += '\n- Herrajes incluidos\n- Instalaci\u00f3n incluida';
                var totalPrice = Math.round(c.subtotal / 500) * 500;
                var dimsStr = isCustom ? (tw / 100) + 'm ancho (alturas variables)' : (tw / 100) + 'm ancho \u00d7 2.00m alto';
                S.estPdfData = {
                    client: EP.client || '',
                    projectName: projName,
                    location: '',
                    quoteNum: qnum,
                    deliveryTime: CONFIG.quoting.defaultDelivery,
                    anticipo: CONFIG.quoting.defaultAnticipo,
                    notes: '',
                    items: [{
                        desc: desc,
                        dims: dimsStr,
                        price: totalPrice
                    }]
                };
            },
            estUploadPlano: function(input) {
                if (!input.files || !input.files[0])
                    return;
                var file = input.files[0];
                if (!file.type.match(/image\/(jpeg|png|jpg)/)) {
                    alert('Solo se aceptan im\u00e1genes JPG o PNG');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    alert('La imagen es muy grande (m\u00e1x 10MB)');
                    return;
                }
                var reader = new FileReader();
                reader.onload = function(e) {
                    S.estProject.planoImage = e.target.result;
                    render();
                };
                reader.readAsDataURL(file);
            },
            estRemovePlano: function() {
                S.estProject.planoImage = null;
                render();
            },
            // Saved Projects
            saveProject: function(silent) {
                var EP = S.estProject;
                var saved = loadSavedProjects();
                var clone = JSON.parse(JSON.stringify(EP));
                clone.planoImage = null;
                delete clone._saveId;
                var isCustom = EP.mode === 'custom';
                var entry = {
                    id: EP._saveId || uid(),
                    savedAt: new Date().toISOString(),
                    client: EP.client || 'Sin nombre',
                    label: (isCustom ? 'Proyecto Personalizado' : 'Closet Estandarizado') + ' - ' + EP.modules.length + ' m\u00f3dulo' + (EP.modules.length !== 1 ? 's' : ''),
                    moduleCount: EP.modules.length,
                    project: clone
                };
                EP._saveId = entry.id;
                // Update local list
                var existIdx = -1;
                for (var i = 0; i < saved.length; i++) {
                    if (saved[i].id === entry.id) {
                        existIdx = i;
                        break;
                    }
                }
                if (existIdx >= 0) {
                    saved[existIdx] = entry;
                } else {
                    saved.unshift(entry);
                }
                if (saved.length > 20)
                    saved = saved.slice(0, 20);
                saveSavedProjects(saved);
                // Sync to cloud
                cloudSaveProject(entry);
                if (!silent)
                    alert('Proyecto guardado en la nube');
            },
            loadSavedProject: function(idx) {
                var saved = loadSavedProjects();
                if (!saved[idx])
                    return;
                var proj = JSON.parse(JSON.stringify(saved[idx].project));
                proj.planoImage = null;
                proj._saveId = saved[idx].id;
                S.estProject = proj;
                S.screen = 'estandarizado';
                S.estScreen = 'builder';
                S.estEditIdx = -1;
                S.estPdfData = null;
                scrollY = 0;
                render();
            },
            deleteSavedProject: function(idx) {
                var saved = loadSavedProjects();
                if (!saved[idx])
                    return;
                if (!confirm('\u00bfEliminar proyecto "' + saved[idx].client + '"?'))
                    return;
                var deletedId = saved[idx].id;
                saved.splice(idx, 1);
                saveSavedProjects(saved);
                cloudDeleteProject(deletedId);
                render();
            },
            estGenClientPDF: function() {
                APP.estInitPdfData();
                var savedPdf = S.pdfData;
                S.pdfData = S.estPdfData;
                genClientPDF(S.estProject, calcEstandarizado());
                S.pdfData = savedPdf;
                APP.saveProject(true);
            },
            estGenInternalPDF: function() {
                APP.estInitPdfData();
                genEstInternalPDF();
                APP.saveProject(true);
            },
            // APP_CONFIG API — multi-tenant setup
            hasAppConfig:      function() { return hasAppConfig(); },
            saveAppConfig:     function(data) { return saveAppConfig(data); },
            loadAppConfig:     function() { return loadAppConfig(); },
            // License API
            generateLicenseKey: function(client, expDate) { return generateLicenseKey(client, expDate); },
            validateLicense:    function() { return validateLicense(); },
            showLicenseInfo:    function() { showLicenseInfo(); }
        };

        // First-run check: show setup screen if no APP_CONFIG exists yet
        if (!hasAppConfig()) {
            showSetupScreen();
            return; // Do not render main app until setup is complete
        }

        // License check: only enforce if a licenseKey was provided
        var licResult = validateLicense();
        if (licResult.reason !== 'no_key' && !licResult.valid) {
            showLockScreen(licResult.reason, licResult);
            return;
        }

        render();

        // Dynamic title and favicon from CONFIG
        document.title = CONFIG.brand.name + ' - Cotizador';
        try {
            var fav = document.getElementById('dynamic-favicon');
            if (fav) fav.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text x='50' y='65' font-size='" + (CONFIG.brand.mono.length > 3 ? '30' : '40') + "' text-anchor='middle' fill='%23c49a6c'>" + encodeURIComponent(CONFIG.brand.mono) + "</text></svg>";
        } catch (e) {}

        // PWA: Inline manifest
        try {
            var manifest = {
                name: CONFIG.brand.name + ' Cotizador',
                short_name: CONFIG.brand.mono + ' Cotizador',
                start_url: window.location.href,
                display: 'standalone',
                background_color: '#1a1a2e',
                theme_color: '#c49a6c',
                icons: [{
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text x='50' y='65' font-size='" + (CONFIG.brand.mono.length > 3 ? '30' : '40') + "' text-anchor='middle' fill='%23c49a6c'>" + encodeURIComponent(CONFIG.brand.mono) + "</text></svg>",
                    sizes: '192x192',
                    type: 'image/svg+xml'
                }]
            };
            var mBlob = new Blob([JSON.stringify(manifest)], {
                type: 'application/json'
            });
            var mLink = document.createElement('link');
            mLink.rel = 'manifest';
            mLink.href = URL.createObjectURL(mBlob);
            document.head.appendChild(mLink);
        } catch (e) {}

        // PWA: Service Worker
        if ('serviceWorker' in navigator) {
            try {
                var swCode = "var CACHE='" + CONFIG.pwa.cacheName + "';self.addEventListener('install',function(e){self.skipWaiting();e.waitUntil(caches.open(CACHE).then(function(c){return c.addAll([self.location.origin+self.location.pathname])}))});self.addEventListener('activate',function(e){e.waitUntil(caches.keys().then(function(ks){return Promise.all(ks.filter(function(k){return k!==CACHE}).map(function(k){return caches.delete(k)}))}));self.clients.claim()});self.addEventListener('fetch',function(e){e.respondWith(fetch(e.request).catch(function(){return caches.match(e.request)}))});";
                var swBlob = new Blob([swCode], {
                    type: 'application/javascript'
                });
                navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(function() {});
            } catch (e) {}
        }
    })();
    </script>
</body>
</html>
