<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Cotizador v1.2</title>
    <meta name="theme-color" content="#c49a6c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cotizador">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" id="dynamic-favicon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text x='50' y='65' font-size='40' text-anchor='middle' fill='%23c49a6c'>COT</text></svg>">
    <script src="jspdf.umd.min.js"></script>
    <script src="jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
    :root {
        --color-bg: #0d0d0d;
        --color-bg-elevated: #1a1a1a;
        --color-bg-tertiary: #2a2a2a;
        --color-border: #3a3a3a;
        --color-bg-card: rgba(40, 40, 40, 0.3);
        --color-bg-card-hover: rgba(40, 40, 40, 0.5);
        --color-text-primary: #ffffff;
        --color-text-secondary: #bbbbbb;
        --color-text-muted: #999999;
        --color-accent: #c49a6c;
        --color-accent-hover: #d4aa7c;
        --color-accent-bg: rgba(196, 154, 108, 0.1);
        --color-text-inverted: #000000;
        --color-error: #f87171;
        --color-warning: #fbbf24;
        --color-success: #4ade80;
        --color-info: #60a5fa;
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-full: 9999px;
        --shadow-card: 0 2px 8px rgba(0,0,0,0.2);
        --color-btn-primary-bg: #ffffff;
        --color-btn-primary-text: #000000;
        --color-bg-input: rgba(40, 40, 40, 0.5);
        --color-bg-overlay: rgba(13, 13, 13, 0.8);
        --color-highlight: rgba(255, 255, 255, 0.08);
        --color-highlight-border: rgba(255, 255, 255, 0.15);
        --color-bg-quote-hdr: #222222;
        --mod-block-stroke: rgba(255,255,255,0.75)
    }
    body.light {
        --color-bg: #f5f5f5;
        --color-bg-elevated: #ffffff;
        --color-bg-tertiary: #e5e5e5;
        --color-border: #d1d5db;
        --color-bg-card: rgba(0, 0, 0, 0.04);
        --color-bg-card-hover: rgba(0, 0, 0, 0.08);
        --color-text-primary: #1a1a1a;
        --color-text-secondary: #4b5563;
        --color-text-muted: #6b7280;
        --color-accent: #b8894f;
        --color-accent-hover: #a07840;
        --color-accent-bg: rgba(184, 137, 79, 0.1);
        --color-text-inverted: #ffffff;
        --color-error: #ef4444;
        --color-warning: #f59e0b;
        --color-success: #22c55e;
        --color-info: #3b82f6;
        --shadow-card: 0 2px 8px rgba(0,0,0,0.08);
        --color-btn-primary-bg: #1a1a1a;
        --color-btn-primary-text: #ffffff;
        --color-bg-input: rgba(0, 0, 0, 0.06);
        --color-bg-overlay: rgba(0, 0, 0, 0.5);
        --color-highlight: rgba(0, 0, 0, 0.05);
        --color-highlight-border: rgba(0, 0, 0, 0.12);
        --color-bg-quote-hdr: #e8e8e8;
        --mod-block-stroke: rgba(0,0,0,0.65)
    }

    * {
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;
        margin: 0;
        padding: 0
    }

    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        background: var(--color-bg);
        color: var(--color-text-primary);
        font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif
    }

    #app {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden
    }

    .hdr {
        background: var(--color-bg-elevated);
        border-bottom: 1px solid var(--color-border);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between
    }

    .hdr-logo {
        width: 40px;
        height: 40px;
        background: var(--color-btn-primary-bg);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--color-btn-primary-text);
        cursor: pointer
    }

    .hdr-txt {
        margin-left: 12px;
        flex: 1
    }

    .hdr-txt h1 {
        font-size: 18px;
        line-height: 1.2
    }

    .hdr-txt p {
        font-size: 11px;
        color: var(--color-text-secondary)
    }

    .hdr-btn {
        padding: 8px;
        border-radius: 8px;
        background: none;
        border: none;
        color: var(--color-text-primary);
        cursor: pointer
    }

    .hdr-actions {
        display: flex;
        gap: 4px
    }

    .steps {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px;
        background: var(--color-bg-overlay)
    }

    .step-dot {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all .15s
    }

    .step-dot.active {
        background: var(--color-btn-primary-bg);
        color: var(--color-btn-primary-text);
        transform: scale(1.1)
    }

    .step-dot.done {
        background: var(--color-highlight-border);
        color: var(--color-text-primary)
    }

    .step-dot.future {
        background: var(--color-bg-tertiary);
        color: var(--color-text-muted);
        cursor: default
    }

    .step-line {
        width: 32px;
        height: 4px;
        border-radius: 2px;
        background: var(--color-bg-tertiary)
    }

    .step-line.done {
        background: var(--color-highlight-border)
    }

    .content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 16px
    }

    .nav {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: var(--color-bg-overlay);
        border-top: 1px solid var(--color-bg-tertiary)
    }

    .nav-btn {
        flex: 1;
        padding: 16px;
        border-radius: 12px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 16px
    }

    .nav-btn.back {
        background: var(--color-bg-tertiary);
        color: var(--color-text-primary)
    }

    .nav-btn.next {
        background: var(--color-btn-primary-bg);
        color: var(--color-btn-primary-text)
    }

    .nav-btn:disabled {
        background: var(--color-bg-tertiary);
        color: var(--color-text-muted);
        cursor: not-allowed
    }

    .title {
        text-align: center;
        padding: 16px 0
    }

    .title h2 {
        font-size: 24px;
        color: var(--color-text-primary)
    }

    .title p {
        color: var(--color-text-secondary);
        margin-top: 4px
    }

    .field {
        margin-bottom: 20px
    }

    .field label {
        display: block;
        font-size: 14px;
        color: var(--color-text-primary);
        margin-bottom: 8px
    }

    .field input, .field select {
        width: 100%;
        padding: 16px;
        background: var(--color-bg-card-hover);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        color: var(--color-text-primary);
        font-size: 16px
    }

    .field input:focus, .field select:focus {
        outline: none;
        border-color: var(--color-text-primary)
    }

    .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px
    }

    .type-btn {
        padding: 16px;
        border-radius: 12px;
        border: 2px solid var(--color-border);
        background: var(--color-bg-card);
        cursor: pointer;
        text-align: center;
        color: var(--color-text-primary)
    }

    .type-btn.sel {
        border-color: var(--color-accent);
        background: var(--color-accent-bg);
        color: var(--color-text-primary)
    }

    .type-btn span {
        display: block;
        font-size: 24px;
        margin-bottom: 8px
    }

    .thick-btn {
        padding: 16px;
        border-radius: 12px;
        border: 2px solid var(--color-border);
        background: var(--color-bg-card);
        cursor: pointer;
        font-weight: 700;
        font-size: 18px;
        color: var(--color-text-primary)
    }

    .thick-btn.sel {
        border-color: var(--color-text-primary);
        background: var(--color-accent-bg);
        color: var(--color-text-primary)
    }

    .hint {
        font-size: 13px;
        color: var(--color-text-muted);
        margin-top: 8px
    }

    .add-btns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 16px
    }

    .cat-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
        overflow-x: auto;
        padding-bottom: 4px;
        -webkit-overflow-scrolling: touch
    }
    .cat-tab {
        padding: 8px 16px;
        border-radius: var(--radius-sm, 8px);
        border: 2px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
        transition: all .15s
    }
    .cat-tab.sel {
        color: #fff;
        border-color: transparent
    }

    /* V9: Horizontal Module Row with SVG silhouettes */
    .mod-row {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 12px 4px;
        -webkit-overflow-scrolling: touch;
        align-items: flex-end;
        min-height: 152px
    }
    .mod-block {
        flex-shrink: 0;
        border-radius: 8px;
        cursor: pointer;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 6px 6px 4px;
        border: 2px solid transparent;
        transition: all .15s;
        min-width: 72px;
        overflow: hidden
    }
    .mod-block.sel {
        border-color: var(--color-text-primary);
        box-shadow: 0 0 12px rgba(255,255,255,0.15)
    }
    .mod-block:hover .mod-block-actions { opacity: 1 }
    .mod-block-actions {
        position: absolute;
        top: -8px;
        right: -8px;
        display: flex;
        gap: 2px;
        opacity: 0;
        transition: opacity .15s
    }
    .mod-block-actions button {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: none;
        font-size: 11px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-bg-elevated, #333);
        color: var(--color-text-primary);
        box-shadow: 0 1px 4px rgba(0,0,0,0.3)
    }
    .mod-block-actions .del-btn {
        color: var(--color-error);
        background: rgba(248,113,113,0.15)
    }
    .mod-block-label {
        font-size: 10px;
        color: var(--color-text-primary);
        text-align: center;
        margin-top: 4px;
        max-width: 100%;
        line-height: 1.2;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        word-break: break-word
    }
    .mod-block-w {
        font-size: 9px;
        color: var(--color-text-secondary);
        text-align: center;
        margin-top: 2px
    }
    .mod-block svg.mod-silhouette {
        width: 100%;
        height: 64px;
        flex-shrink: 0;
        stroke: var(--mod-block-stroke);
        stroke-width: 1.5;
        fill: none
    }

    .add-btn {
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--color-border);
        background: var(--color-bg-card-hover);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--color-text-primary)
    }

    .module {
        padding: 16px;
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        margin-bottom: 12px
    }

    .module-hdr {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px
    }

    .module-num {
        width: 28px;
        height: 28px;
        background: var(--color-btn-primary-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 700;
        color: var(--color-btn-primary-text)
    }

    .module-del {
        padding: 8px;
        color: var(--color-error);
        background: none;
        border: none;
        cursor: pointer;
        border-radius: 8px
    }

    .module-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px
    }

    .module-row span {
        font-size: 14px;
        color: var(--color-text-secondary);
        width: 60px
    }

    .opt-btn {
        padding: 6px 12px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background: var(--color-border);
        color: var(--color-text-primary)
    }

    .opt-btn.sel {
        background: var(--color-accent);
        color: var(--color-text-inverted)
    }

    .module-desc {
        font-size: 12px;
        color: var(--color-text-muted)
    }

    .empty {
        padding: 32px;
        border: 2px dashed var(--color-border);
        border-radius: 12px;
        text-align: center;
        color: var(--color-text-muted)
    }

    .total-w {
        padding: 12px;
        background: var(--color-highlight);
        border: 1px solid var(--color-highlight-border);
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 16px 0
    }

    .total-w span {
        color: var(--color-text-primary);
        font-weight: 500
    }

    .total-w strong {
        font-size: 20px;
        color: var(--color-text-primary)
    }

    .extra-section {
        padding-top: 16px;
        border-top: 1px solid var(--color-bg-tertiary);
        margin-top: 16px
    }

    .extra-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: var(--color-bg-card);
        border-radius: 12px;
        margin-bottom: 12px
    }

    .toggle {
        width: 56px;
        height: 32px;
        border-radius: 16px;
        background: var(--color-border);
        position: relative;
        cursor: pointer;
        border: none;
        flex-shrink: 0
    }

    .toggle.on {
        background: var(--color-btn-primary-bg)
    }

    .toggle::after {
        content: '';
        position: absolute;
        width: 24px;
        height: 24px;
        background: var(--color-btn-primary-bg);
        border-radius: 50%;
        top: 4px;
        left: 4px;
        transition: transform .15s
    }

    .toggle.on::after {
        transform: translateX(24px);
        background: var(--color-btn-primary-text)
    }

    .extra-input {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-left: 32px;
        margin-bottom: 12px
    }

    .extra-input span {
        font-size: 14px;
        color: var(--color-text-secondary)
    }

    .extra-input input {
        width: 80px;
        padding: 8px 12px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        color: var(--color-text-primary);
        text-align: center
    }

    .card {
        padding: 16px;
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        margin-bottom: 16px
    }

    .card-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px
    }

    .cost-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 14px
    }

    .cost-row span {
        color: var(--color-text-secondary)
    }

    .cost-row strong {
        font-family: monospace
    }

    .cost-total {
        display: flex;
        justify-content: space-between;
        padding-top: 8px;
        border-top: 1px solid var(--color-border);
        font-weight: 700
    }

    .cost-total strong {
        color: var(--color-text-primary);
        font-family: monospace
    }

    .summary {
        padding: 16px;
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-highlight-border);
        border-radius: 12px;
        margin-bottom: 16px
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px
    }

    .summary-row span {
        color: var(--color-text-secondary)
    }

    .summary-row strong {
        font-family: monospace
    }

    .grand-total {
        display: flex;
        justify-content: space-between;
        padding-top: 8px;
        border-top: 1px solid var(--color-border)
    }

    .grand-total span {
        font-size: 20px;
        font-weight: 700
    }

    .grand-total strong {
        font-size: 24px;
        color: var(--color-text-primary);
        font-family: monospace
    }

    .profit-box {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 12px;
        background: var(--color-highlight);
        border-radius: 8px;
        margin-top: 12px
    }

    .profit-box span {
        color: var(--color-text-primary);
        font-size: 14px
    }

    .profit-box strong {
        color: var(--color-text-primary);
        font-family: monospace;
        font-size: 14px
    }

    .tabs {
        display: flex;
        background: var(--color-bg-card-hover);
        border-radius: 12px;
        padding: 4px;
        margin-bottom: 16px
    }

    .tab {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: none;
        color: var(--color-text-secondary)
    }

    .tab.sel {
        background: var(--color-btn-primary-bg);
        color: var(--color-btn-primary-text)
    }

    .quote {
        background: var(--color-bg-elevated);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--color-border)
    }

    .quote-hdr {
        background: var(--color-bg-quote-hdr);
        padding: 24px;
        text-align: center
    }

    .quote-hdr h2 {
        font-size: 24px
    }

    .quote-hdr p {
        color: var(--color-text-primary);
        font-size: 14px
    }

    .quote-body {
        padding: 16px
    }

    .quote-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px
    }

    .quote-info div span {
        font-size: 12px;
        color: var(--color-text-secondary)
    }

    .quote-info div p {
        font-weight: 500
    }

    .quote-project {
        padding: 12px;
        background: var(--color-bg-card-hover);
        border-radius: 8px;
        margin-bottom: 16px
    }

    .quote-project span {
        font-size: 12px;
        color: var(--color-text-secondary)
    }

    .quote-project h3 {
        font-size: 18px
    }

    .quote-project p {
        color: var(--color-text-primary);
        font-size: 14px
    }

    .quote-mods h4 {
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 8px
    }

    .quote-mod {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        background: var(--color-bg-card);
        border-radius: 8px;
        margin-bottom: 4px;
        font-size: 14px
    }

    .quote-extras {
        margin: 16px 0
    }

    .quote-extras h4 {
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 8px
    }

    .quote-extras p {
        font-size: 14px;
        color: var(--color-text-secondary)
    }

    .quote-price {
        border-top: 1px solid var(--color-border);
        padding-top: 16px;
        margin-top: 16px
    }

    .quote-price-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px
    }

    .quote-price-row span {
        color: var(--color-text-secondary)
    }

    .quote-price-row strong {
        font-family: monospace
    }

    .quote-total {
        display: flex;
        justify-content: space-between;
        padding-top: 8px;
        border-top: 1px solid var(--color-border);
        font-size: 20px;
        font-weight: 700
    }

    .quote-total strong {
        color: var(--color-text-primary)
    }

    .quote-terms {
        padding: 12px;
        background: var(--color-bg-card);
        border-radius: 8px;
        margin: 16px 0
    }

    .quote-terms h4 {
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 8px
    }

    .quote-terms p {
        font-size: 14px;
        color: var(--color-text-secondary);
        margin-bottom: 4px
    }

    .quote-contact {
        text-align: center;
        font-size: 14px;
        color: var(--color-text-secondary);
        padding-top: 8px
    }

    .cut-hdr {
        background: var(--color-bg-tertiary);
        padding: 16px
    }

    .cut-hdr h2 {
        font-size: 18px
    }

    .cut-body {
        padding: 16px
    }

    .cut-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px
    }

    .cut-box {
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        background: var(--color-highlight)
    }

    .cut-box strong {
        font-size: 24px;
        display: block;
        color: var(--color-text-primary)
    }

    .cut-box span {
        font-size: 12px;
        color: var(--color-text-secondary)
    }

    .cut-module {
        background: var(--color-bg-card);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px
    }

    .cut-module-hdr {
        background: var(--color-bg-tertiary);
        padding: 8px 12px;
        font-weight: 700;
        font-size: 14px
    }

    .cut-module-body {
        padding: 8px
    }

    .cut-piece {
        display: flex;
        align-items: center;
        font-size: 12px;
        padding: 8px;
        background: var(--color-bg-card-hover);
        border-radius: 4px;
        margin-bottom: 4px
    }

    .cut-piece span:first-child {
        flex: 1
    }

    .cut-piece .qty {
        width: 32px;
        text-align: center;
        color: var(--color-text-primary)
    }

    .cut-piece .dims {
        width: 80px;
        text-align: right;
        font-family: monospace
    }

    .cut-piece .thk {
        width: 48px;
        text-align: right;
        color: var(--color-text-muted)
    }

    .cut-piece .zone {
        width: 48px;
        text-align: center;
        font-size: 10px;
        border-radius: 4px;
        padding: 2px 4px
    }

    .cut-piece .zone.f {
        background: rgba(59, 130, 246, 0.2);
        color: var(--color-info)
    }

    .cut-piece .zone.i {
        background: rgba(156, 163, 175, 0.2);
        color: #9ca3af
    }

    .copy-btn {
        width: 100%;
        padding: 16px;
        background: var(--color-btn-primary-bg);
        border: none;
        border-radius: 12px;
        color: var(--color-btn-primary-text);
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 16px
    }

    .copy-btn.copied {
        background: var(--color-text-muted)
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: 100
    }

    .modal-content {
        background: var(--color-bg-elevated);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        border-radius: 24px 24px 0 0;
        overflow: hidden
    }

    .modal-hdr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid var(--color-bg-tertiary)
    }

    .modal-hdr h2 {
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 8px
    }

    .modal-close {
        padding: 8px;
        background: none;
        border: none;
        color: var(--color-text-primary);
        cursor: pointer
    }

    .modal-body {
        overflow-y: auto;
        max-height: 70vh;
        padding: 16px
    }

    svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none
    }/* Templates */

    .tpl-grid {
        padding: 24px;
        max-width: 600px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        min-height: 100%
    }

    .tpl-card {
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 16px
    }

    .tpl-card-img {
        width: 100%;
        height: 220px;
        object-fit: cover;
        display: block;
        cursor: pointer
    }

    .tpl-card-body {
        padding: 16px
    }

    .tpl-card-name {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 4px
    }

    .tpl-card-type {
        display: inline-block;
        font-size: 11px;
        background: var(--color-bg-tertiary);
        color: var(--color-text-secondary);
        padding: 2px 8px;
        border-radius: 4px;
        margin-bottom: 8px
    }

    .tpl-card-desc {
        font-size: 13px;
        color: var(--color-text-secondary);
        margin-bottom: 8px
    }

    .tpl-card-dims {
        font-size: 14px;
        color: var(--color-text-secondary);
        margin-bottom: 4px
    }

    .tpl-card-price {
        font-size: 22px;
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 12px
    }

    .tpl-card-btn {
        width: 100%;
        padding: 14px;
        background: var(--color-btn-primary-bg);
        color: var(--color-btn-primary-text);
        border: none;
        border-radius: 10px;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer
    }

    .tpl-new {
        width: 100%;
        padding: 20px;
        background: none;
        border: 2px dashed var(--color-border);
        border-radius: 14px;
        color: var(--color-text-secondary);
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 24px;
        transition: border-color .15s, color .15s
    }
    .tpl-new:active {
        border-color: #c49a6c;
        color: #c49a6c
    }

    .tpl-grid > .title {
        padding: 32px 0 20px
    }
    .tpl-grid > .title h2 {
        font-size: 28px
    }
    .tpl-grid > .title p {
        font-size: 15px;
        margin-top: 4px
    }

    .saved-projects-section {
        flex: 1;
        display: flex;
        flex-direction: column
    }
    .saved-projects-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--color-text-secondary);
        margin-bottom: 14px
    }
    .saved-project-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border);
        border-radius: 14px;
        padding: 18px 20px;
        margin-bottom: 12px
    }
    .saved-project-info {
        flex: 1;
        min-width: 0
    }
    .sp-client {
        font-size: 17px;
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
    }
    .sp-meta {
        font-size: 13px;
        color: var(--color-text-muted)
    }
    .saved-project-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: 12px;
        flex-shrink: 0
    }
    .sp-load {
        padding: 10px 20px;
        background: #c49a6c;
        color: #000;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer
    }
    .sp-del {
        padding: 8px 12px;
        background: var(--color-bg-tertiary);
        color: var(--color-text-muted);
        border: none;
        border-radius: 10px;
        font-size: 18px;
        cursor: pointer;
        line-height: 1
    }

    .qq-back {
        display: flex;
        align-items: center;
        gap: 8px;
        background: none;
        border: none;
        color: var(--color-text-primary);
        cursor: pointer;
        padding: 12px 16px;
        font-size: 15px
    }

    .qq-img {
        width: 100%;
        max-height: 220px;
        object-fit: cover;
        display: block
    }

    .qq-body {
        padding: 16px
    }

    .qq-name {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 4px
    }

    .qq-desc {
        font-size: 14px;
        color: var(--color-text-secondary);
        margin-bottom: 16px
    }

    .qq-section {
        padding: 16px;
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        margin-bottom: 16px
    }

    .qq-section-title {
        font-size: 14px;
        color: var(--color-text-secondary);
        margin-bottom: 12px
    }

    .qq-dim-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px
    }

    .qq-dim-row label {
        font-size: 14px;
        color: var(--color-text-secondary);
        width: 50px
    }

    .qq-dim-input {
        flex: 1;
        padding: 12px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        color: var(--color-text-primary);
        font-size: 18px;
        font-weight: 700;
        text-align: center
    }

    .qq-dim-input:focus {
        border-color: var(--color-text-primary);
        outline: none
    }

    .qq-price-box {
        padding: 20px;
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-highlight-border);
        border-radius: 12px;
        text-align: center;
        margin-bottom: 16px
    }

    .qq-price-label {
        font-size: 14px;
        color: var(--color-text-secondary);
        margin-bottom: 4px
    }

    .qq-price {
        font-size: 32px;
        font-weight: 700;
        color: var(--color-text-primary)
    }

    .qq-price-iva {
        font-size: 14px;
        color: var(--color-text-secondary);
        margin-top: 4px
    }

    .qq-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px
    }

    .qq-info-item {
        padding: 12px;
        background: var(--color-bg-card);
        border-radius: 8px
    }

    .qq-info-item span {
        font-size: 12px;
        color: var(--color-text-secondary);
        display: block
    }

    .qq-info-item strong {
        font-size: 15px
    }

    .wa-btn {
        width: 100%;
        padding: 16px;
        background: var(--color-btn-primary-bg);
        border: none;
        border-radius: 12px;
        color: var(--color-btn-primary-text);
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 12px
    }

    .wa-btn.copied {
        background: var(--color-text-muted)
    }

    .qq-full-btn {
        width: 100%;
        padding: 14px;
        background: none;
        border: 2px solid var(--color-border);
        border-radius: 12px;
        color: var(--color-text-primary);
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 16px
    }

    .qq-mat-select {
        width: 100%;
        padding: 12px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        color: var(--color-text-primary);
        font-size: 15px
    }

    .qq-mat-select:focus {
        border-color: var(--color-text-primary);
        outline: none
    }

    .img-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center
    }

    .img-modal img {
        max-width: 100%;
        max-height: 85vh;
        object-fit: contain;
        touch-action: pinch-zoom
    }

    .img-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 44px;
        height: 44px;
        background: var(--color-highlight-border);
        border: none;
        border-radius: 50%;
        color: var(--color-text-primary);
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center
    }/* V2: Dual Material */

    .mat-dual {
        margin-bottom: 20px
    }

    .mat-toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: var(--color-bg-card);
        border-radius: 12px;
        margin-bottom: 16px
    }

    .mat-toggle-row span {
        font-size: 14px;
        color: var(--color-text-primary)
    }

    .mat-section {
        margin-bottom: 16px
    }

    .mat-section-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--color-text-primary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px
    }

    .mat-section-label .badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px
    }

    .mat-section-label .badge.vis {
        background: rgba(59, 130, 246, 0.2);
        color: var(--color-info)
    }

    .mat-section-label .badge.hid {
        background: rgba(156, 163, 175, 0.2);
        color: #9ca3af
    }

    .mat-select {
        width: 100%;
        padding: 12px;
        background: var(--color-bg-card-hover);
        border: 1px solid var(--color-border);
        border-radius: 10px;
        color: var(--color-text-primary);
        font-size: 14px
    }

    .mat-select:focus {
        outline: none;
        border-color: var(--color-text-primary)
    }

    .mat-info {
        font-size: 12px;
        color: var(--color-text-muted);
        margin-top: 4px;
        padding-left: 4px
    }/* V2: Hardware Picker */

    .hw-picker {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 150;
        display: flex;
        justify-content: flex-end;
        backdrop-filter: blur(4px);
        animation: hw-overlay-in .2s ease
    }
    @keyframes hw-overlay-in {
        from { opacity: 0 }
        to   { opacity: 1 }
    }
    @keyframes hw-drawer-slide {
        from { transform: translateX(100%) }
        to   { transform: translateX(0) }
    }

    .hw-picker-content {
        background: var(--color-bg-elevated);
        width: 38%;
        min-width: 380px;
        max-width: 520px;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: -4px 0 24px rgba(0,0,0,0.4);
        border-left: 1px solid var(--color-border);
        animation: hw-drawer-slide .25s ease
    }
    @media (max-width: 640px) {
        .hw-picker {
            align-items: flex-end;
            justify-content: center
        }
        .hw-picker-content {
            width: 100%;
            min-width: unset;
            max-width: unset;
            height: 92vh;
            border-left: none;
            border-radius: 24px 24px 0 0;
            animation: none
        }
    }

    .hw-picker-hdr {
        padding: 16px;
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0
    }

    .hw-picker-hdr h3 {
        font-size: 18px;
        color: var(--color-text-primary)
    }

    .hw-search {
        padding: 12px;
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        color: var(--color-text-primary);
        font-size: 14px;
        margin: 12px 16px;
        flex-shrink: 0;
        box-sizing: border-box;
        width: calc(100% - 32px)
    }

    .hw-search:focus {
        outline: none;
        border-color: var(--color-text-primary)
    }

    .hw-filters {
        display: flex;
        gap: 6px;
        padding: 0 16px 10px;
        overflow-x: auto;
        flex-wrap: wrap;
        flex-shrink: 0
    }

    .hw-chip {
        padding: 6px 12px;
        border-radius: 16px;
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: 12px;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0
    }

    .hw-chip.sel {
        background: var(--color-btn-primary-bg);
        color: var(--color-btn-primary-text);
        border-color: var(--color-text-primary)
    }

    .hw-list {
        overflow-y: auto;
        flex: 1;
        padding: 0 16px 16px
    }

    .hw-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: var(--color-bg-card);
        border-radius: 10px;
        margin-bottom: 8px;
        gap: 12px
    }

    .hw-item-info {
        flex: 1;
        min-width: 0
    }

    .hw-item-name {
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
    }

    .hw-item-meta {
        font-size: 11px;
        color: var(--color-text-muted)
    }

    .hw-item-price {
        font-family: monospace;
        font-size: 14px;
        font-weight: 700;
        white-space: nowrap
    }

    .hw-item-qty {
        display: flex;
        align-items: center;
        gap: 6px
    }

    .hw-item-qty button {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: var(--color-border);
        color: var(--color-text-primary);
        font-size: 16px;
        font-weight: 700;
        cursor: pointer
    }

    .hw-item-qty strong {
        width: 24px;
        text-align: center;
        font-size: 14px
    }

    .hw-cat-hdr {
        font-size: 12px;
        color: var(--color-text-muted);
        text-transform: uppercase;
        padding: 8px 0;
        border-bottom: 1px solid var(--color-bg-tertiary);
        margin-bottom: 8px;
        margin-top: 8px
    }/* V2: Hardware selected in step 2 */

    .hw-selected {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--color-bg-tertiary)
    }

    .hw-selected h4 {
        font-size: 14px;
        color: var(--color-text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px
    }

    .hw-sel-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--color-bg-card);
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 13px
    }

    .hw-sel-item .hw-sel-name {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 8px
    }

    .hw-sel-item .hw-sel-qty {
        display: flex;
        align-items: center;
        gap: 4px
    }

    .hw-sel-item .hw-sel-qty button {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        background: var(--color-border);
        color: var(--color-text-primary);
        cursor: pointer;
        font-weight: 700
    }

    .hw-sel-item .hw-sel-price {
        font-family: monospace;
        font-weight: 600;
        width: 70px;
        text-align: right
    }

    .hw-sel-item .hw-sel-marca {
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 3px;
        margin-right: 4px
    }

    .marca-herraxa {
        background: rgba(234, 179, 8, 0.15);
        color: #fbbf24
    }

    .marca-blum {
        background: rgba(239, 68, 68, 0.15);
        color: var(--color-error)
    }

    .marca-hafele {
        background: rgba(59, 130, 246, 0.15);
        color: var(--color-info)
    }

    .marca-arauco {
        background: rgba(34, 197, 94, 0.15);
        color: var(--color-success)
    }

    .hw-add-btn {
        width: 100%;
        padding: 12px;
        border: 1px dashed var(--color-border);
        border-radius: 10px;
        background: none;
        color: var(--color-text-secondary);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 8px
    }/* V2: Settings Panel */

    .settings-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 160;
        display: flex;
        align-items: center;
        justify-content: center
    }

    .settings-panel {
        background: var(--color-bg-elevated);
        width: 90%;
        max-width: 420px;
        border-radius: 16px;
        overflow: hidden;
        max-height: 85vh;
        display: flex;
        flex-direction: column
    }

    .settings-hdr {
        padding: 16px;
        border-bottom: 1px solid var(--color-bg-tertiary);
        display: flex;
        justify-content: space-between;
        align-items: center
    }

    .settings-hdr h3 {
        font-size: 18px
    }

    .settings-body {
        overflow-y: auto;
        padding: 16px;
        flex: 1;
        min-height: 0
    }

    .settings-section {
        margin-bottom: 20px
    }

    .settings-section h4 {
        font-size: 14px;
        color: var(--color-text-secondary);
        margin-bottom: 12px
    }

    .margin-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: var(--color-bg-card);
        border-radius: 8px;
        margin-bottom: 8px
    }

    .margin-row label {
        font-size: 14px;
        flex: 1
    }

    .margin-row input {
        width: 70px;
        padding: 8px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        color: var(--color-text-primary);
        text-align: center;
        font-size: 14px
    }

    .margin-row input:focus {
        outline: none;
        border-color: var(--color-text-primary)
    }

    .margin-row .lock {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        color: var(--color-text-muted);
        padding: 8px 12px;
        background: var(--color-bg-tertiary);
        border-radius: 6px
    }

    .margin-presets {
        display: flex;
        gap: 8px;
        margin-bottom: 16px
    }

    .margin-preset {
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        cursor: pointer;
        font-size: 13px
    }

    .margin-preset.sel {
        background: var(--color-btn-primary-bg);
        color: var(--color-btn-primary-text);
        border-color: var(--color-text-primary)
    }

    .supplier-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--color-bg-card);
        border-radius: 8px;
        margin-bottom: 6px
    }

    .supplier-row span {
        font-size: 14px
    }

    .supplier-row input {
        width: 60px;
        padding: 6px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        color: var(--color-text-primary);
        text-align: center;
        font-size: 13px
    }/* V2: Cost Breakdown */

    .cost-bd {
        margin-top: 16px;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        overflow: hidden
    }

    .cost-bd-lock {
        padding: 12px 16px;
        background: var(--color-bg-tertiary);
        font-size: 12px;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        gap: 8px
    }

    .cost-bd-toggle {
        padding: 12px 16px;
        background: var(--color-bg-card);
        border: none;
        color: var(--color-text-primary);
        width: 100%;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between
    }

    .cost-bd-body {
        padding: 16px
    }

    .cost-bd-section {
        margin-bottom: 16px
    }

    .cost-bd-section h5 {
        font-size: 13px;
        color: var(--color-text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase
    }

    .cost-bd-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        font-size: 13px;
        font-family: monospace
    }

    .cost-bd-row span {
        color: var(--color-text-secondary)
    }

    .cost-bd-row strong {
        color: var(--color-text-primary)
    }

    .cost-bd-subtotal {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-top: 1px solid var(--color-bg-tertiary);
        font-size: 13px;
        font-weight: 700;
        margin-top: 4px
    }

    .cost-bd-grand {
        padding: 12px;
        background: var(--color-highlight);
        border-radius: 8px;
        margin-top: 8px
    }

    .cost-bd-grand-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 14px;
        font-family: monospace
    }

    .cost-bd-grand-row.total {
        font-size: 18px;
        font-weight: 700
    }

    /* Bento Grid */
    .bento-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px
    }
    .bento-grid .card { margin-bottom: 0 }
    .bento-grid .card.span-2,
    .bento-grid .span-2 { grid-column: 1 / -1 }
    @media (max-width: 640px) {
        .bento-grid { grid-template-columns: 1fr }
    }

    /* Profit Hero */
    .profit-hero {
        padding: 20px 20px 16px;
        background: linear-gradient(145deg, #222236 0%, #2a2a44 50%, #222236 100%);
        border: 1px solid rgba(196,154,108,0.4);
        border-radius: 12px;
        margin-bottom: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3)
    }
    .profit-hero .hero-label {
        font-size: 11px;
        color: #b0b0c0;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 2px
    }
    .profit-hero .hero-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 6px 0
    }
    .profit-hero .hero-row span { font-size: 14px; color: #d0d0dd }
    .profit-hero .hero-row strong {
        font-family: monospace;
        font-size: 14px;
        text-align: right;
        color: #e8e8f0
    }
    .profit-hero .hero-row.cost strong { color: #a0a0b0 }
    .profit-hero .hero-row.profit strong { color: #5eeaab; font-size: 16px }
    .profit-hero .hero-row.total {
        padding-top: 8px;
        border-top: 2px solid rgba(196,154,108,0.3);
        margin-top: 4px
    }
    .profit-hero .hero-row.total span {
        font-size: 18px;
        font-weight: 700;
        color: var(--color-text-primary)
    }
    .profit-hero .hero-row.total strong {
        font-size: 22px;
        color: #c49a6c;
        font-weight: 700
    }
    .profit-hero .hero-margin {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        background: rgba(52,211,153,0.15);
        color: #34d399;
        font-size: 11px;
        font-weight: 600;
        font-family: monospace;
        margin-top: 4px
    }

    /* Sheet Gauge */
    .sheet-gauge {
        margin-top: 16px;
        padding: 16px 20px;
        background: linear-gradient(135deg, #152e1f 0%, #1f3528 100%);
        border: 1px solid #3a6a4a;
        border-radius: 12px;
        overflow: hidden
    }
    .sheet-gauge-title {
        font-size: 13px;
        color: #6edba0;
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px
    }
    .sheet-gauge-bar {
        display: flex;
        height: 28px;
        border-radius: 8px;
        overflow: hidden;
        background: rgba(255,255,255,0.05);
        margin-bottom: 8px
    }
    .sheet-gauge-seg {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        font-family: monospace;
        transition: width 0.4s ease
    }
    .sheet-gauge-seg.casco {
        background: linear-gradient(135deg, #059669, #047857);
        color: #d1fae5
    }
    .sheet-gauge-seg.frente {
        background: linear-gradient(135deg, #0d9488, #0f766e);
        color: #ccfbf1
    }
    .sheet-gauge-legend {
        display: flex;
        gap: 16px;
        font-size: 13px
    }
    .sheet-gauge-legend span {
        display: flex;
        align-items: center;
        gap: 6px;
        color: #c8d8d0
    }
    .sheet-gauge-legend .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0
    }
    .sheet-gauge-legend strong {
        color: var(--color-text-primary);
        font-family: monospace
    }

    /* Cost Breakdown Accordion */
    .cost-bd-accordion {
        margin-top: 16px;
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        overflow: hidden;
        background: var(--color-bg-card)
    }
    .cost-bd-accordion .cost-bd-toggle {
        background: var(--color-bg-card);
        padding: 12px 16px;
        gap: 8px
    }
    .cost-bd-accordion .cost-bd-toggle:hover {
        background: var(--color-bg-card-hover)
    }
    .cost-bd-accordion .lock-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 4px;
        background: rgba(255,255,255,0.06);
        font-size: 11px;
        margin-right: 6px
    }

    /* Cut Table (despiece) */
    .cut-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px
    }
    .cut-table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--color-bg-card);
        padding: 8px;
        font-weight: 600;
        font-size: 11px;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        text-align: left;
        border-bottom: 2px solid var(--color-border);
        white-space: nowrap
    }
    .cut-table thead th.col-num {
        text-align: right;
        font-family: monospace
    }
    .cut-table thead th.col-zone { text-align: center }
    .cut-table tbody tr {
        border-bottom: 1px solid rgba(255,255,255,0.04);
        transition: background 0.15s
    }
    .cut-table tbody tr:hover { background: var(--color-bg-card-hover) }
    .cut-table tbody tr.cut-row-edited {
        border-left: 3px solid #d97706;
        background: rgba(217,119,6,0.03)
    }
    .cut-table td {
        padding: 6px 8px;
        vertical-align: middle;
        color: var(--color-text-primary)
    }
    .cut-table td.col-name {
        font-weight: 500;
        max-width: 140px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap
    }
    .cut-table td.col-num {
        text-align: right;
        font-family: monospace;
        font-variant-numeric: tabular-nums;
        white-space: nowrap
    }
    .cut-table td.col-zone { text-align: center }
    .cut-table .cut-input {
        width: 52px;
        padding: 4px 6px;
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border);
        border-radius: 4px;
        color: var(--color-text-primary);
        text-align: right;
        font-size: 11px;
        font-family: monospace;
        font-variant-numeric: tabular-nums;
        transition: border-color 0.15s, background 0.15s
    }
    .cut-table .cut-input:focus {
        outline: none;
        border-color: #c49a6c;
        box-shadow: 0 0 0 2px rgba(196,154,108,0.3)
    }
    .cut-table .cut-input.cut-input-edited {
        background: rgba(217,119,6,0.08);
        border-color: rgba(217,119,6,0.3)
    }
    .cut-table .cut-input-qty { width: 40px; text-align: center }
    .cut-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.03em
    }
    .cut-badge-f {
        background: rgba(2,132,199,0.10);
        color: var(--color-info);
        border: 1px solid rgba(2,132,199,0.2)
    }
    .cut-badge-i {
        background: var(--color-bg-card);
        color: var(--color-text-muted);
        border: 1px solid var(--color-border)
    }
    .cut-reset-btn {
        width: 100%;
        padding: 10px;
        background: var(--color-bg-tertiary);
        border: 1px solid #c49a6c;
        border-radius: 8px;
        color: #c49a6c;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 12px
    }

    /* V2: Suggest panel */

    .hw-suggest {
        padding: 12px;
        background: var(--color-bg-card);
        border: 1px dashed var(--color-border);
        border-radius: 8px;
        margin-top: 8px
    }

    .hw-suggest-title {
        font-size: 12px;
        color: var(--color-text-muted);
        margin-bottom: 8px
    }

    .hw-suggest-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 13px
    }

    .hw-suggest-item button {
        padding: 4px 10px;
        border-radius: 6px;
        border: none;
        background: var(--color-border);
        color: var(--color-text-primary);
        font-size: 12px;
        cursor: pointer
    }

    .hw-suggest-item button.added {
        background: var(--color-highlight-border);
        color: var(--color-text-muted)
    }/* V2: Labor input */

    .labor-input {
        display: flex;
        align-items: center;
        gap: 8px
    }

    .labor-input input {
        width: 120px;
        padding: 10px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
        border-radius: 8px;
        color: var(--color-text-primary);
        font-size: 16px;
        text-align: right;
        font-family: monospace
    }

    .labor-input input:focus {
        outline: none;
        border-color: var(--color-text-primary)
    }

    .labor-input span {
        color: var(--color-text-secondary);
        font-size: 14px
    }

    .labor-presets {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        flex-wrap: wrap
    }

    .labor-preset {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: 12px;
        cursor: pointer
    }

    .labor-preset.sel {
        background: var(--color-btn-primary-bg);
        color: var(--color-btn-primary-text);
        border-color: var(--color-text-primary)
    }/* V2.1: PDF Screen */

    .pdf-screen {
        padding: 16px
    }

    .pdf-field {
        margin-bottom: 16px
    }

    .pdf-field label {
        display: block;
        font-size: 13px;
        color: var(--color-text-secondary);
        margin-bottom: 6px
    }

    .pdf-field input, .pdf-field textarea {
        width: 100%;
        padding: 12px;
        background: var(--color-bg-card-hover);
        border: 1px solid var(--color-border);
        border-radius: 10px;
        color: var(--color-text-primary);
        font-size: 15px
    }

    .pdf-field input:focus, .pdf-field textarea:focus {
        outline: none;
        border-color: #c49a6c
    }

    .pdf-field textarea {
        min-height: 60px;
        resize: vertical
    }

    .pdf-items {
        margin-bottom: 16px
    }

    .pdf-item {
        padding: 12px;
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: 10px;
        margin-bottom: 8px
    }

    .pdf-item-hdr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px
    }

    .pdf-item-hdr strong {
        font-size: 14px
    }

    .pdf-item-price {
        width: 120px;
        padding: 8px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        color: var(--color-text-primary);
        font-size: 16px;
        text-align: right;
        font-family: monospace
    }

    .pdf-item-price:focus {
        border-color: #c49a6c;
        outline: none
    }

    .pdf-item-desc {
        width: 100%;
        padding: 8px;
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        color: var(--color-text-secondary);
        font-size: 13px;
        resize: none;
        min-height: 40px
    }

    .pdf-item-desc:focus {
        border-color: #c49a6c;
        outline: none;
        color: var(--color-text-primary)
    }

    .pdf-totals {
        padding: 16px;
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-highlight-border);
        border-radius: 12px;
        margin-bottom: 16px
    }

    .pdf-totals-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 15px
    }

    .pdf-totals-row.grand {
        font-size: 20px;
        font-weight: 700;
        padding-top: 8px;
        border-top: 1px solid var(--color-border)
    }

    .pdf-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px
    }

    .pdf-btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px
    }

    .pdf-btn.client {
        background: #c49a6c;
        color: var(--color-bg-elevated)
    }

    .pdf-btn.internal {
        background: var(--color-bg-tertiary);
        color: var(--color-text-primary);
        border: 1px solid var(--color-border)
    }

    .pdf-btn.despiece {
        background: #1e3a5f;
        color: var(--color-text-primary);
        border: 1px solid #2a5080
    }/* V2.1: Brand Selector */

    .brand-toggle {
        display: flex;
        gap: 8px;
        margin-bottom: 16px
    }

    .brand-btn {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-align: center
    }

    .brand-btn.sel {
        border-color: #c49a6c;
        background: rgba(196, 154, 108, 0.1);
        color: #c49a6c
    }

    .brand-btn .mono {
        font-size: 20px;
        font-weight: 700;
        display: block;
        margin-bottom: 4px
    }/* V2.1: Logo Upload */

    .logo-section {
        margin-bottom: 16px
    }

    .logo-preview {
        width: 160px;
        height: 80px;
        border-radius: 8px;
        background: var(--color-bg-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 8px
    }

    .logo-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain
    }

    .logo-btns {
        display: flex;
        gap: 8px
    }

    .logo-btns button {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        font-size: 13px;
        cursor: pointer
    }

    .logo-btns .upload {
        background: #c49a6c;
        color: var(--color-bg-elevated);
        font-weight: 600
    }

    .logo-btns .remove {
        background: var(--color-border);
        color: var(--color-error)
    }/* V2.2: LED Configurator */

    .led-section {
        margin-top: 12px;
        padding: 12px;
        background: rgba(251, 191, 36, 0.05);
        border: 1px solid rgba(251, 191, 36, 0.2);
        border-radius: 10px
    }

    .led-toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0
    }

    .led-toggle-row span {
        font-size: 13px;
        color: #fbbf24;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px
    }

    .led-edges {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 10px 0
    }

    .led-edge-box {
        position: relative;
        width: 120px;
        height: 80px;
        border: 2px solid var(--color-border);
        border-radius: 4px;
        flex-shrink: 0
    }

    .led-edge {
        position: absolute;
        background: var(--color-border);
        border: none;
        cursor: pointer;
        border-radius: 3px;
        transition: background .15s
    }

    .led-edge.on {
        background: #fbbf24
    }

    .led-edge.top {
        top: -4px;
        left: 10px;
        right: 10px;
        height: 6px
    }

    .led-edge.bottom {
        bottom: -4px;
        left: 10px;
        right: 10px;
        height: 6px
    }

    .led-edge.left {
        left: -4px;
        top: 10px;
        bottom: 10px;
        width: 6px
    }

    .led-edge.right {
        right: -4px;
        top: 10px;
        bottom: 10px;
        width: 6px
    }

    .led-edge-label {
        position: absolute;
        font-size: 9px;
        color: var(--color-text-muted);
        pointer-events: none
    }

    .led-edge-label.top {
        top: -16px;
        left: 50%;
        transform: translateX(-50%)
    }

    .led-edge-label.bottom {
        bottom: -16px;
        left: 50%;
        transform: translateX(-50%)
    }

    .led-edge-label.left {
        left: -30px;
        top: 50%;
        transform: translateY(-50%)
    }

    .led-edge-label.right {
        right: -30px;
        top: 50%;
        transform: translateY(-50%)
    }

    .led-opts {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 0
    }

    .led-shelf-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--color-text-secondary)
    }

    .led-shelf-row input {
        width: 48px;
        padding: 4px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        color: var(--color-text-primary);
        text-align: center;
        font-size: 12px
    }

    .led-shelf-row button {
        padding: 2px 8px;
        border-radius: 6px;
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: 11px;
        cursor: pointer
    }

    .led-shelf-row button.on {
        background: #fbbf24;
        color: var(--color-btn-primary-text);
        border-color: #fbbf24
    }

    .led-meters {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--color-text-muted);
        margin: 6px 0;
        flex-wrap: wrap
    }

    .led-meters input {
        width: 56px;
        padding: 3px;
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border);
        border-radius: 4px;
        color: var(--color-text-primary);
        text-align: center;
        font-size: 11px;
        font-family: monospace
    }

    .led-meters strong {
        color: #fbbf24
    }

    .led-radio {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 6px 0
    }

    .led-radio button {
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: 11px;
        cursor: pointer
    }

    .led-radio button.sel {
        background: #fbbf24;
        color: var(--color-btn-primary-text);
        border-color: #fbbf24
    }

    .led-bom-preview {
        margin-top: 8px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        font-size: 11px
    }

    .led-bom-preview .led-bom-row {
        display: flex;
        justify-content: space-between;
        padding: 1px 0;
        color: var(--color-text-secondary)
    }

    .led-bom-preview .led-bom-row strong {
        color: #fbbf24;
        font-family: monospace
    }

    .led-bom-total {
        display: flex;
        justify-content: space-between;
        padding-top: 4px;
        border-top: 1px solid var(--color-border);
        font-weight: 700;
        color: #fbbf24;
        margin-top: 4px
    }
    /* Setup screen (first-run wizard) */
    .setup-overlay {
        position: fixed;
        inset: 0;
        z-index: 10000;
        background: #0d0d0d;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        overflow-y: auto;
        padding: 40px 20px;
        box-sizing: border-box;
    }
    .setup-card {
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-bg-tertiary);
        border-radius: 16px;
        padding: 36px 32px;
        width: 100%;
        max-width: 480px;
        box-sizing: border-box;
    }
    .setup-card h1 {
        color: #c49a6c;
        font-size: 22px;
        font-weight: 700;
        margin: 0 0 6px;
        letter-spacing: 0.5px;
    }
    .setup-card .setup-subtitle {
        color: var(--color-text-muted);
        font-size: 13px;
        margin: 0 0 28px;
    }
    .setup-divider {
        color: #c49a6c;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 24px 0 14px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--color-bg-quote-hdr);
    }
    .setup-field {
        margin-bottom: 14px;
    }
    .setup-field label {
        display: block;
        font-size: 12px;
        color: var(--color-text-secondary);
        margin-bottom: 5px;
        font-weight: 500;
    }
    .setup-field input[type="text"],
    .setup-field input[type="email"] {
        width: 100%;
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-bg-tertiary);
        border-radius: 8px;
        color: var(--color-text-primary);
        font-size: 14px;
        padding: 10px 12px;
        box-sizing: border-box;
        outline: none;
        transition: border-color 0.15s;
        font-family: inherit;
    }
    .setup-field input[type="text"]:focus,
    .setup-field input[type="email"]:focus {
        border-color: #c49a6c;
    }
    .setup-field input.setup-error {
        border-color: var(--color-error) !important;
    }
    .setup-field .setup-hint {
        font-size: 11px;
        color: var(--color-text-muted);
        margin-top: 3px;
    }
    .setup-logo-preview {
        margin-top: 8px;
        height: 60px;
        display: none;
        object-fit: contain;
        border-radius: 6px;
        background: var(--color-bg-elevated);
        padding: 4px;
    }
    .setup-file-label {
        display: inline-block;
        cursor: pointer;
        background: var(--color-bg-elevated);
        border: 1px dashed var(--color-border);
        border-radius: 8px;
        color: var(--color-text-muted);
        font-size: 13px;
        padding: 10px 16px;
        transition: border-color 0.15s, color 0.15s;
    }
    .setup-file-label:hover { border-color: #c49a6c; color: #c49a6c; }
    .setup-file-input { display: none; }
    .setup-btn {
        width: 100%;
        background: #c49a6c;
        color: #0d0d0d;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 700;
        padding: 14px;
        cursor: pointer;
        margin-top: 24px;
        transition: background 0.15s, opacity 0.15s;
        font-family: inherit;
        letter-spacing: 0.3px;
    }
    .setup-btn:hover { background: #d4aa7c; }
    .setup-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .setup-footer-note {
        text-align: center;
        color: var(--color-text-muted);
        font-size: 11px;
        margin-top: 14px;
    }
    /* V6: Theme-aware overrides for existing hardcoded classes */
    .hdr { background: var(--color-bg-elevated); border-bottom: 1px solid var(--color-border) }
    .module { background: var(--color-bg-card); border-color: var(--color-border) }
    .module-hdr { border-color: var(--color-border) }
    .opt-btn { border-color: var(--color-border); color: var(--color-text-primary) }
    .opt-btn.sel { border-color: var(--color-accent); background: var(--color-accent); color: var(--color-text-inverted) }
    .add-btn { border-color: var(--color-border); color: var(--color-text-primary) }
    .add-btn:hover { border-color: var(--color-accent) }
    .empty { border-color: var(--color-border); color: var(--color-text-muted) }

    /* V6: Chip buttons for LED/Pintura */
    .chip-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: var(--radius-full, 9999px);
        border: 1px solid var(--color-border);
        background: none;
        color: var(--color-text-secondary);
        font-size: 12px;
        cursor: pointer;
        transition: all .15s
    }
    .chip-btn.active {
        background: rgba(251, 191, 36, 0.15);
        border-color: #fbbf24;
        color: #fbbf24
    }
    .chip-btn.active-paint {
        background: rgba(96, 165, 250, 0.15);
        border-color: var(--color-info);
        color: var(--color-info)
    }
    .chip-panel {
        margin-top: 8px;
        animation: slideDown .15s ease
    }

    /* Space usage bar */
    .space-usage-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        border-radius: 10px;
        margin-bottom: 12px;
        font-size: 13px;
        color: var(--color-text-secondary)
    }
    .space-usage-track {
        flex: 1;
        height: 8px;
        background: var(--color-bg-tertiary);
        border-radius: 4px;
        overflow: hidden
    }
    .space-usage-fill {
        height: 100%;
        border-radius: 4px;
        background: #c49a6c;
        transition: width .3s ease
    }
    .space-usage-fill.over { background: #ef4444 }
    .space-usage-target input {
        width: 60px;
        padding: 4px 6px;
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border);
        border-radius: 6px;
        color: var(--color-text-primary);
        font-size: 13px;
        text-align: center
    }

    /* V6: Click-to-toggle spec panel */
    .mod-spec-panel {
        padding: 20px 24px;
        background: var(--color-bg-card);
        border: 2px solid #c49a6c;
        border-radius: 12px;
        margin-bottom: 16px;
        animation: slideDown .15s ease;
        box-shadow: 0 2px 12px rgba(196,154,108,0.15)
    }
    .mod-spec-panel .module-hdr {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--color-border)
    }
    .mod-spec-panel .module-hdr strong { font-size: 17px }
    .mod-spec-panel .module-row { margin-bottom: 14px }
    .mod-spec-panel .module-row > span { font-size: 15px; width: 70px }
    .mod-spec-panel .opt-btn { padding: 8px 14px; font-size: 14px }
    .mod-spec-panel input[type="number"] { font-size: 15px; padding: 8px 10px }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-8px) }
        to { opacity: 1; transform: translateY(0) }
    }

    /* V6: Closet module miniature block */
    .zone-mini {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: 2px solid transparent;
        border-radius: 8px;
        background: var(--color-bg-card);
        cursor: pointer;
        transition: all .15s;
        min-width: 80px;
        position: relative
    }
    .zone-mini:hover .zone-mini-actions { opacity: 1 }
    .zone-mini.sel {
        border-color: var(--color-accent);
        background: var(--color-accent-bg)
    }
    .zone-mini:hover {
        background: var(--color-bg-card-hover)
    }
    .zone-mini-label {
        font-size: 11px;
        color: var(--color-text-secondary)
    }
    .zone-mini-w {
        font-size: 10px;
        color: var(--color-text-muted)
    }

    /* V6: Theme toggle button */
    .hdr-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        color: var(--color-text-primary);
        font-size: 14px;
        line-height: 1
    }
    .hdr-btn:hover { background: var(--color-bg-tertiary) }
    .hdr-actions { display: flex; gap: 4px; align-items: center }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="supplier-catalog-data.js"></script>
    <script>
    (function() {
        // 
        //   CONFIG  Edit this section to customize for your business  
        // 
        var CONFIG = {
            version: '1.0',
            brand: {
                name: 'Renova',
                mono: 'RN',
                tagline: 'Muebles a la Medida',
                altBrand: null, // e.g. { id:'alt', mono:'ALT', name:'OTRA MARCA', tagline:'Subtitulo' }
                // CUSTOMIZE: Legal terms for client PDF  edit these to match your business terms
                legalTerms: [
                    'ACUERDO:',
                    'Vigencia de cotizacion 15 dias naturales a partir de la fecha.',
                    'Tiempo de entrega de 6-8 semanas a partir de aprobacion del diseno y anticipo del 60%.',
                    'Se inicia el proyecto con anticipo del 60% y el saldo del 40% con muebles fabricados en taller previo a la instalacion.',
                    'Una vez realizado el pago del anticipo, no se podra realizar cancelacion de trabajos.',
                    'Cualquier alteracion y/o solicitud nueva al proyecto se cobrara aparte.',
                    '',
                    'INSTALACION:',
                    'El presupuesto incluye traslado en la ubicacion acordada, dentro de la Zona Metropolitana de Monterrey.',
                    'La instalacion NO incluye ajustes o cambios en trabajos que no se incluyan o que no correspondan al giro de la empresa previamente solicitado (instalaciones Electricas, Hidraulicas, Gas).',
                    'El horario de instalacion es de 9:00 am a 5:00 pm de Lunes a Viernes.',
                    'El espacio debe estar adecuado y libre para instalacion.',
                    '',
                    'MATERIALES:',
                    'La sobreexposicion al sol y rayos UV generan un deterioro indebido el cual no sera objeto de garantia. De igual manera la exposicion a exceso de humedad o fugas dentro del espacio.'
                ]
            },
            contact: {
                name: 'Renova',
                office: '00 0000-0000',
                cell: '00 0000-0000',
                email: 'contacto@miempresa.com',
                city: 'Tu Ciudad'
            },
            quoting: {
                prefix: 'COT',
                defaultDelivery: '6-8 semanas',
                defaultAnticipo: 60,
                terms: [
                    '{anticipo}% de anticipo, resto al programar la instalacion',
                    'El pago total debera estar cubierto al llegar a la obra',
                    'Tiempo de entrega: {deliveryTime} habiles a partir del anticipo',
                    'Incluye: fabricacion, transporte, instalacion y regulador',
                    'No incluye: instalaciones electricas, obra civil, plomeria',
                    'Instalaciones: Lun-Vie 9AM-5PM / Sab 9AM-1PM',
                    'Cotizacion vigente por 15 dias'
                ],
                htmlTerms: [
                    '{anticipo}% anticipo para iniciar',
                    'Resto al programar instalacion',
                    'Tiempo: {deliveryTime}',
                    'Incluye instalacion',
                    'NO incluye instalaciones electricas'
                ]
            },
            storage: {
                prefix: 'cot_'
            },
            pwa: {
                cacheName: 'cotizador-v5'
            },
            pricing: {
                iva: 0.16,
                marginCarp: 66,
                marginHwStd: 66,
                marginBlum: 0.30,
                // CUSTOMIZE: Material merma (waste) factor  1.20 = 20% extra material
                mermaFactor: 1.20,
                // CUSTOMIZE: Hardware pricing  items with total cost <= threshold go into carpentry bucket (3x multiplier), above threshold get premium margin (30%)
                carpentryMultiplier: 3,
                hardwareThreshold: 500,
                premiumHardwareMargin: 0.30,
                extrasMultiplier: 4,
                cuttingCostPerSheet: 75,
                glassCostPerM2: 800,
                defaultLaborCost: 5000,
                defaultFreightCost: 2000,
                defaultChapPrice: 13.10,
                defaultEnchapPrice: 13,
                defaultChapSpec: '1mm x 19mm ABS para refilar',
                saleMultiplierPresets: [1.5, 2, 2.5, 3],
                defaultSaleMultiplier: 2,
                // CUSTOMIZE: Cubierta pricing per m2 (MXN)  postformado/cuarzo/granito
                cubiertaPrices: {
                    postformado: 2500,
                    cuarzo: 8500,
                    granito: 6500
                }
            },
            // CUSTOMIZE: Bisagra auto-assignment rules  adjust count by door height and material
            hardware: {
                autoAssignRules: {
                    puertas: {
                        bisagras: [
                            { maxHeight: 1000, count: 2 },
                            { maxHeight: 2000, count: 3 },
                            { maxHeight: Infinity, count: 4 }
                        ],
                        heavyMaterialBonus: 1
                    }
                }
            },
            supabase: {
                url: '',
                key: ''
            },
            bundledProjects: [],
            // 
            // COCINAS  Kitchen configuration (INSTRUCTIVO_TECNICO_COCINAS)
            // 
            kitchen: {
                zocloMode: 'configurable', // 'auto' | 'extra' | 'configurable'
                cubiertas: true,
                preciosCubierta: { postformado: 2500, cuarzo: 8500, granito: 6500, acero: 9000 },
                precioZoclo: 350,
                modules: {
                    bajo_estandar: true, bajo_cajones: true, bajo_fregadero: true,
                    bajo_horno: true, bajo_cooktop: false, esquinero_bajo: true,
                    alacena_estandar: true, alacena_aventos: true, alacena_campana: true,
                    alacena_esquinera: false, alacena_profunda: false,
                    torre_despensa: true, torre_hornos: true, torre_microondas: false,
                    torre_refrigerador: false, torre_limpieza: false,
                    cubierta: true, zoclo: true, panel_lateral: true,
                    panel_relleno: false, isla: false, gabinete_remate: false
                }
            }
        };

        // 
        // COCINAS  Kitchen module catalog, width presets, controls
        // Per INSTRUCTIVO_TECNICO_COCINAS.md sections 2, 5, 1
        // 
        var KITCHEN_MODS = {
            bajo_estandar:     { type: 'bajo_estandar',     label: 'Gabinete Bajo',         cat: 'bajos',    defaultW: 600, defaultH: 720, defaultD: 600, enabledKey: 'bajo_estandar' },
            bajo_cajones:      { type: 'bajo_cajones',      label: 'Bajo con Cajones',      cat: 'bajos',    defaultW: 600, defaultH: 720, defaultD: 600, enabledKey: 'bajo_cajones' },
            bajo_fregadero:    { type: 'bajo_fregadero',    label: 'Bajo Fregadero',        cat: 'bajos',    defaultW: 800, defaultH: 720, defaultD: 600, enabledKey: 'bajo_fregadero' },
            bajo_horno:        { type: 'bajo_horno',        label: 'Bajo para Horno',       cat: 'bajos',    defaultW: 600, defaultH: 720, defaultD: 600, enabledKey: 'bajo_horno' },
            bajo_cooktop:      { type: 'bajo_cooktop',      label: 'Bajo para Parrilla',    cat: 'bajos',    defaultW: 600, defaultH: 720, defaultD: 600, enabledKey: 'bajo_cooktop' },
            esquinero_bajo:    { type: 'esquinero_bajo',    label: 'Esquinero Bajo',        cat: 'bajos',    defaultW: 900, defaultH: 720, defaultD: 600, enabledKey: 'esquinero_bajo' },
            alacena_estandar:  { type: 'alacena_estandar',  label: 'Alacena',               cat: 'alacenas', defaultW: 600, defaultH: 700, defaultD: 320, enabledKey: 'alacena_estandar' },
            alacena_aventos:   { type: 'alacena_aventos',   label: 'Alacena Aventos',       cat: 'alacenas', defaultW: 600, defaultH: 700, defaultD: 320, enabledKey: 'alacena_aventos' },
            alacena_campana:   { type: 'alacena_campana',   label: 'Alacena sobre Campana', cat: 'alacenas', defaultW: 900, defaultH: 700, defaultD: 320, enabledKey: 'alacena_campana' },
            alacena_esquinera: { type: 'alacena_esquinera', label: 'Alacena Esquinera',     cat: 'alacenas', defaultW: 600, defaultH: 700, defaultD: 320, enabledKey: 'alacena_esquinera' },
            alacena_profunda:  { type: 'alacena_profunda',  label: 'Alacena Profunda',      cat: 'alacenas', defaultW: 600, defaultH: 350, defaultD: 600, enabledKey: 'alacena_profunda' },
            torre_despensa:    { type: 'torre_despensa',    label: 'Torre Despensa',        cat: 'torres',   defaultW: 600, defaultH: 2200, defaultD: 600, enabledKey: 'torre_despensa' },
            torre_hornos:      { type: 'torre_hornos',      label: 'Torre Hornos + Micro',  cat: 'torres',   defaultW: 600, defaultH: 2200, defaultD: 600, enabledKey: 'torre_hornos' },
            torre_microondas:  { type: 'torre_microondas',  label: 'Torre Microondas',      cat: 'torres',   defaultW: 600, defaultH: 2000, defaultD: 600, enabledKey: 'torre_microondas' },
            torre_refrigerador:{ type: 'torre_refrigerador',label: 'Torre Refrigerador',    cat: 'torres',   defaultW: 700, defaultH: 2200, defaultD: 600, enabledKey: 'torre_refrigerador' },
            torre_limpieza:    { type: 'torre_limpieza',    label: 'Torre Escobero',        cat: 'torres',   defaultW: 450, defaultH: 2000, defaultD: 600, enabledKey: 'torre_limpieza' },
            cubierta:          { type: 'cubierta',          label: 'Cubierta / Encimera',   cat: 'extras',   defaultW: 2000, defaultH: 0,  defaultD: 600, enabledKey: 'cubierta' },
            zoclo:             { type: 'zoclo',             label: 'Zoclo',                 cat: 'extras',   defaultW: 0,    defaultH: 120, defaultD: 0,   enabledKey: 'zoclo' },
            panel_lateral:     { type: 'panel_lateral',     label: 'Panel Lateral Vista',   cat: 'extras',   defaultW: 0,    defaultH: 720, defaultD: 600, enabledKey: 'panel_lateral' },
            panel_relleno:     { type: 'panel_relleno',     label: 'Panel de Relleno',      cat: 'extras',   defaultW: 50,   defaultH: 720, defaultD: 0,   enabledKey: 'panel_relleno' },
            isla:              { type: 'isla',              label: 'Isla',                  cat: 'extras',   defaultW: 1200, defaultH: 720, defaultD: 900, enabledKey: 'isla' },
            gabinete_remate:   { type: 'gabinete_remate',   label: 'Gabinete de Remate',    cat: 'extras',   defaultW: 600,  defaultH: 350, defaultD: 600, enabledKey: 'gabinete_remate' }
        };

        var KITCHEN_WIDTH_PRESETS = {
            bajos:    [300, 400, 450, 500, 600, 800, 900],
            alacenas: [300, 400, 450, 500, 600, 800, 900],
            torres:   [450, 500, 600],
            extras:   []
        };

        // Constants per INSTRUCTIVO 1.4
        var KT  = 15; // espesor casco mm
        var KTF = 18; // espesor frente/puerta mm
        var KTHDF = 3; // espesor fondo HDF mm

        // Bisagras per door per INSTRUCTIVO 4.2
        function kitchenBisagrasPerDoor(doorHeightMm, frontMaterial) {
            var count;
            if      (doorHeightMm <= 1000) count = 2;
            else if (doorHeightMm <= 2000) count = 3;
            else                           count = 4;
            var heavy = frontMaterial === 'vidrio' || frontMaterial === 'metal' || frontMaterial === 'aluminio';
            if (heavy) count += 1;
            return count;
        }

        // Patas per module per INSTRUCTIVO 4.4
        function kitchenPatas(moduleWidthMm) {
            return moduleWidthMm > 900 ? 6 : 4;
        }

        // Zoclo clips per INSTRUCTIVO 4.5
        function kitchenClipsZoclo(moduleWidthMm) {
            return Math.ceil(moduleWidthMm / 300) * 2;
        }

        // Map KITCHEN_MODS type  internal moduleType used by calculateParts/assignHardware
        var KITCHEN_TYPE_MAP = {
            bajo_estandar: 'bajoEstandar', bajo_cajones: 'cajonera', bajo_fregadero: 'fregadero',
            bajo_horno: 'hornoBase', bajo_cooktop: 'bajoCooktop', esquinero_bajo: 'esquineroCiego',
            alacena_estandar: 'alacenaEstandar', alacena_aventos: 'alacenaAventos',
            alacena_campana: 'alacenaCampana', alacena_esquinera: 'alacenaEsquinera',
            alacena_profunda: 'alacenaProfunda',
            torre_despensa: 'torreDespensa', torre_hornos: 'torreHornos',
            torre_microondas: 'torreMicroondas', torre_refrigerador: 'torreRefrigerador',
            torre_limpieza: 'torreLimpieza',
            cubierta: 'cubierta', zoclo: 'zocloMod', panel_lateral: 'vistaLateral',
            panel_relleno: 'panelRelleno', isla: 'isla', gabinete_remate: 'gabineteRemate'
        };
        // Reverse map for UI
        var KITCHEN_TYPE_MAP_REV = {};
        for (var kk in KITCHEN_TYPE_MAP) KITCHEN_TYPE_MAP_REV[KITCHEN_TYPE_MAP[kk]] = kk;

        //  COCINAS: Per-module toggle/control definitions (INSTRUCTIVO Seccin 5) 
        var KITCHEN_MODULE_CONTROLS = {
          bajo_estandar: {
            dims: ['width','height','depth'], widthPreset: 'bajos',
            puertas: { type:'button_group', options:[1,2], auto: function(w){return w<=500?1:2} },
            entrepanos: { type:'stepper', min:0, max:3, default:1 },
            corredera: false, cajones: false
          },
          bajo_cajones: {
            dims: ['width','height','depth'], widthPreset: 'bajos',
            puertas: false,
            cajones: { type:'button_group', options:[2,3,4], default:3 },
            corredera: { type:'button_group', options:['blum_tandem','economica'], default:'blum_tandem',
                         labels:['Blum Tandem','Econmica'] },
            entrepanos: false
          },
          bajo_fregadero: {
            dims: ['width','height','depth'], widthPreset: 'bajos',
            puertas: false, entrepanos: false, corredera: false,
            nota: 'Zona hmeda  se recomienda MDF RH en casco'
          },
          bajo_horno: {
            dims: ['width','height','depth'], widthPreset: 'bajos',
            altoHueco: { type:'number', default:600, label:'Alto hueco horno (mm)' },
            cajonHorno: { type:'button_group', options:['arriba','abajo','ninguno'],
                          labels:['Cajn arriba','Cajn abajo','Sin cajn'], default:'abajo' },
            corredera: { type:'button_group', options:['blum_tandem','economica'], default:'blum_tandem',
                         labels:['Blum Tandem','Econmica'], showIf: function(m){return m.cajonHorno!=='ninguno'} }
          },
          bajo_cooktop: {
            dims: ['width','height','depth'], widthPreset: 'bajos',
            puertas: { type:'button_group', options:[1,2], auto: function(w){return w<=500?1:2} },
            cajones: { type:'stepper', min:0, max:3, default:1 },
            corredera: { type:'button_group', options:['blum_tandem','economica'], default:'blum_tandem',
                         labels:['Blum Tandem','Econmica'], showIf: function(m){return m.cajones>0} }
          },
          esquinero_bajo: {
            dims: ['height','depth'],
            widthX: { type:'number', default:900, label:'Lado X (mm)' },
            widthY: { type:'number', default:900, label:'Lado Y (mm)' },
            esquineroTipo: { type:'button_group', options:['ciego','carrusel','magic_corner'],
                             labels:['Ciego','Carrusel','Magic Corner'], default:'ciego' }
          },
          alacena_estandar: {
            dims: ['width','height','depth'], widthPreset: 'alacenas',
            montaje: { type:'button_group', options:['pared','sobre_bajos'], labels:['A la pared','Sobre bajos'], default:'pared' },
            puertas: { type:'button_group', options:[1,2], auto: function(w){return w<=500?1:2} },
            entrepanos: { type:'stepper', min:0, max:4, default:2 }
          },
          alacena_aventos: {
            dims: ['width','height','depth'], widthPreset: 'alacenas',
            montaje: { type:'button_group', options:['pared','sobre_bajos'], default:'pared' },
            aventosHojas: { type:'button_group', options:[1,2], labels:['1 hoja completa','2 hojas divididas'], default:1 },
            entrepanos: { type:'stepper', min:0, max:3, default:1 }
          },
          alacena_campana: {
            dims: ['width','height','depth'],
            anchoCampana: { type:'number', default:600, label:'Ancho hueco campana (mm)' },
            entrepanos: false
          },
          alacena_esquinera: {
            dims: ['height','depth'],
            widthX: { type:'number', default:600, label:'Lado X (mm)' },
            widthY: { type:'number', default:600, label:'Lado Y (mm)' },
            esquineroTipo: { type:'button_group', options:['con_puertas','carrusel'], default:'con_puertas' }
          },
          alacena_profunda: {
            dims: ['width','height','depth'], widthPreset: 'alacenas',
            montaje: { type:'button_group', options:['pared','sobre_bajos'], default:'pared' },
            puertas: { type:'button_group', options:[1,2], auto: function(w){return w<=500?1:2} },
            entrepanos: { type:'stepper', min:0, max:3, default:1 }
          },
          torre_despensa: {
            dims: ['width','height','depth'], widthPreset: 'torres',
            entrepanos: { type:'stepper', min:2, max:8, default:4 }
          },
          torre_hornos: {
            dims: ['width','height','depth'], widthPreset: 'torres',
            altoMicro: { type:'number', default:450, label:'Alto hueco microondas (mm)' },
            altoHorno: { type:'number', default:600, label:'Alto hueco horno (mm)' },
            cajonesIntermedios: { type:'stepper', min:0, max:3, default:1 },
            corredera: { type:'button_group', options:['blum_tandem','economica'], default:'blum_tandem',
                         showIf: function(m){return m.cajonesIntermedios>0} }
          },
          torre_microondas: {
            dims: ['width','height','depth'], widthPreset: 'torres',
            altoMicro: { type:'number', default:450, label:'Alto hueco microondas (mm)' },
            entrepanos: { type:'stepper', min:1, max:6, default:3 }
          },
          torre_refrigerador: {
            dims: ['width','height','depth'],
            nota: 'Solo genera el marco/carcasa. El refrigerador no se cotiza.'
          },
          torre_limpieza: {
            dims: ['width','height','depth'], widthPreset: 'torres'
          },
          cubierta: {
            dims: ['width','depth'],
            tipoCubierta: { type:'button_group', options:['postformado','cuarzo','granito','acero'],
                            labels:['Postformado','Cuarzo','Granito','Acero inox'], default:'postformado' }
          },
          zoclo: {
            metrosLineales: { type:'number', default:1, label:'Metros lineales' },
            altoZoclo: { type:'number', default:120, label:'Alto zoclo (mm)' }
          },
          panel_lateral: {
            dims: ['height','depth'],
            matPanel: { type:'material_selector', label:'Material panel' }
          },
          panel_relleno: { dims: ['width','height'] },
          isla: {
            dims: ['width','height','depth'],
            entrepanos: { type:'stepper', min:0, max:4, default:1 },
            cajones: { type:'stepper', min:0, max:4, default:2 },
            corredera: { type:'button_group', options:['blum_tandem','economica'], default:'blum_tandem' }
          },
          gabinete_remate: {
            dims: ['width','height','depth'],
            nota: 'Gabinete de poca altura. Va sobre refrigerador o al remate de lnea.'
          }
        };

        // 
        //   APP_CONFIG  Multi-tenant runtime configuration layer       
        // 
        var APP_CONFIG_KEY = CONFIG.storage.prefix + 'app_config';

        function loadAppConfig() {
            try {
                var raw = localStorage.getItem(APP_CONFIG_KEY);
                if (!raw) return null;
                var appConfig = JSON.parse(raw);
                // Override CONFIG.brand fields
                if (appConfig.companyName) CONFIG.brand.name = appConfig.companyName;
                if (appConfig.monogram)    CONFIG.brand.mono = appConfig.monogram;
                if (appConfig.tagline)     CONFIG.brand.tagline = appConfig.tagline;
                if (appConfig.legalTerms)  CONFIG.brand.legalTerms = appConfig.legalTerms;
                // Override CONFIG.contact fields
                if (appConfig.contactName)   CONFIG.contact.name   = appConfig.contactName;
                if (appConfig.contactCity)   CONFIG.contact.city   = appConfig.contactCity;
                if (appConfig.contactOffice) CONFIG.contact.office = appConfig.contactOffice;
                if (appConfig.contactCell)   CONFIG.contact.cell   = appConfig.contactCell;
                if (appConfig.contactEmail)  CONFIG.contact.email  = appConfig.contactEmail;
                // Override CONFIG.supabase fields
                if (appConfig.supabaseUrl) CONFIG.supabase.url = appConfig.supabaseUrl;
                if (appConfig.supabaseKey) CONFIG.supabase.key = appConfig.supabaseKey;
                // If logo was saved in APP_CONFIG, persist it to the standard logo key
                if (appConfig.logoBase64) {
                    try { localStorage.setItem(CONFIG.storage.prefix + 'logo_base64', appConfig.logoBase64); } catch(e) {}
                }
                return appConfig;
            } catch(e) { return null; }
        }

        function saveAppConfig(data) {
            try {
                localStorage.setItem(APP_CONFIG_KEY, JSON.stringify(data));
                loadAppConfig();
                return true;
            } catch(e) { return false; }
        }

        function hasAppConfig() {
            return !!localStorage.getItem(APP_CONFIG_KEY);
        }

        // 
        //   LICENSE VALIDATION                                          
        // 
        var LICENSE_SALT = 'renova-cotizador-2024';

        function simpleHash(str) {
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                var chr = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + chr;
                hash |= 0;
            }
            return hash.toString(36);
        }

        function validateLicense() {
            var appCfgRaw = localStorage.getItem(APP_CONFIG_KEY);
            if (!appCfgRaw) return { valid: false, reason: 'no_key' };
            var appCfg;
            try { appCfg = JSON.parse(appCfgRaw); } catch(e) { return { valid: false, reason: 'no_key' }; }
            var licenseKey = appCfg.licenseKey;
            if (!licenseKey) return { valid: false, reason: 'no_key' };
            try {
                var decoded = JSON.parse(atob(licenseKey));
                var expectedHash = simpleHash(decoded.client + decoded.exp + LICENSE_SALT);
                if (decoded.hash !== expectedHash) return { valid: false, reason: 'invalid' };
                if (new Date(decoded.exp) < new Date()) {
                    return { valid: false, reason: 'expired', client: decoded.client, exp: decoded.exp };
                }
                return { valid: true, client: decoded.client, exp: decoded.exp };
            } catch(e) {
                return { valid: false, reason: 'invalid' };
            }
        }

        function generateLicenseKey(client, expDate) {
            var hash = simpleHash(client + expDate + LICENSE_SALT);
            var payload = { client: client, exp: expDate, hash: hash };
            return btoa(JSON.stringify(payload));
        }

        function showLockScreen(reason, details) {
            var existing = document.getElementById('license-lock');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);

            var messages = {
                no_key: 'Licencia No Configurada &mdash; Ingrese su clave de licencia para utilizar el cotizador.',
                invalid: 'Licencia Invalida &mdash; La clave de licencia no es valida. Contacte soporte.',
                expired: 'Licencia Expirada &mdash; Su licencia expiro el ' + (details && details.exp ? details.exp : '') + '. Contacte soporte para renovar.'
            };
            var msg = messages[reason] || messages.invalid;
            var supportEmail = (CONFIG.contact && CONFIG.contact.email) ? CONFIG.contact.email : 'soporte@renova.mx';

            var overlay = document.createElement('div');
            overlay.id = 'license-lock';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#0d0d0d;z-index:10001;display:flex;align-items:center;justify-content:center;font-family:sans-serif;';
            overlay.innerHTML = [
                '<div style="max-width:420px;width:90%;text-align:center;padding:40px 32px;background:var(--color-bg-elevated);border-radius:16px;border:1px solid var(--color-border);">',
                '  <div style="font-size:56px;margin-bottom:16px;">&#x1F512;</div>',
                '  <h2 style="color:#c49a6c;font-size:20px;margin:0 0 12px;font-weight:600;">Acceso Bloqueado</h2>',
                '  <p style="color:var(--color-text-secondary);font-size:14px;line-height:1.5;margin:0 0 24px;">' + msg + '</p>',
                '  <div style="margin-bottom:12px;">',
                '    <input id="lic-key-input" type="text" placeholder="Ingrese clave de licencia" style="width:100%;box-sizing:border-box;padding:10px 12px;background:var(--color-bg-elevated);border:1px solid var(--color-border);border-radius:8px;color:var(--color-text-primary);font-size:13px;outline:none;">',
                '  </div>',
                '  <button id="lic-validate-btn" style="width:100%;padding:12px;background:#c49a6c;color:var(--color-text-inverted);border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;margin-bottom:20px;">Validar</button>',
                '  <p style="color:var(--color-text-muted);font-size:12px;margin:0;">Soporte: <a href="mailto:' + supportEmail + '" style="color:#c49a6c;text-decoration:none;">' + supportEmail + '</a></p>',
                '</div>'
            ].join('\n');

            document.body.appendChild(overlay);

            var btn = document.getElementById('lic-validate-btn');
            if (btn) {
                btn.addEventListener('click', function() {
                    var keyInput = document.getElementById('lic-key-input');
                    var newKey = keyInput ? keyInput.value.trim() : '';
                    if (!newKey) return;

                    var appCfgRaw = localStorage.getItem(APP_CONFIG_KEY);
                    var appCfg = {};
                    try { appCfg = JSON.parse(appCfgRaw) || {}; } catch(e) {}
                    appCfg.licenseKey = newKey;
                    saveAppConfig(appCfg);

                    var result = validateLicense();
                    if (result.valid) {
                        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                        window.location.reload();
                    } else {
                        var inputEl = document.getElementById('lic-key-input');
                        if (inputEl) {
                            inputEl.style.borderColor = 'var(--color-error)';
                            inputEl.placeholder = 'Clave invalida. Intente nuevamente.';
                            inputEl.value = '';
                        }
                    }
                });
            }
        }

        function showLicenseInfo() {
            var existing = document.getElementById('license-info-overlay');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);

            var result = validateLicense();
            var version = CONFIG.version || '1.0';
            var supportEmail = (CONFIG.contact && CONFIG.contact.email) ? CONFIG.contact.email : 'soporte@renova.mx';
            var supportPhone = (CONFIG.contact && CONFIG.contact.cell) ? CONFIG.contact.cell : '';

            var clientText = result.client || '&mdash;';
            var expText = '&mdash;';
            var statusColor = '#888';
            var statusText = 'Sin licencia';

            if (result.valid) {
                statusColor = '#4caf50';
                statusText = 'Activa';
                clientText = result.client;
                // Format date as "DD de Mes YYYY"
                try {
                    var meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
                    var parts = result.exp.split('-');
                    expText = parseInt(parts[2], 10) + ' de ' + meses[parseInt(parts[1], 10) - 1] + ' ' + parts[0];
                } catch(e) { expText = result.exp || '&mdash;'; }
            } else if (result.reason === 'expired') {
                statusColor = '#f44336';
                statusText = 'Expirada';
                clientText = result.client || '&mdash;';
                try {
                    var meses2 = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
                    var parts2 = (result.exp || '').split('-');
                    expText = parseInt(parts2[2], 10) + ' de ' + meses2[parseInt(parts2[1], 10) - 1] + ' ' + parts2[0];
                } catch(e) { expText = result.exp || '&mdash;'; }
            }

            var overlay = document.createElement('div');
            overlay.id = 'license-info-overlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;font-family:sans-serif;';
            overlay.innerHTML = [
                '<div style="max-width:400px;width:90%;background:var(--color-bg-elevated);border-radius:16px;border:1px solid var(--color-border);overflow:hidden;">',
                '  <div style="padding:24px 28px 0;">',
                '    <h2 style="color:#c49a6c;font-size:18px;margin:0 0 20px;font-weight:600;">Informacion de Licencia</h2>',
                '    <table style="width:100%;border-collapse:collapse;font-size:14px;">',
                '      <tr><td style="color:var(--color-text-muted);padding:8px 0 8px;border-bottom:1px solid var(--color-border);width:100px;">Version</td><td style="color:var(--color-text-primary);padding:8px 0;border-bottom:1px solid var(--color-border);">Cotizador Pro v' + version + '</td></tr>',
                '      <tr><td style="color:var(--color-text-muted);padding:8px 0 8px;border-bottom:1px solid var(--color-border);">Cliente</td><td style="color:var(--color-text-primary);padding:8px 0;border-bottom:1px solid var(--color-border);">' + clientText + '</td></tr>',
                '      <tr><td style="color:var(--color-text-muted);padding:8px 0 8px;border-bottom:1px solid var(--color-border);">Expiracion</td><td style="color:var(--color-text-primary);padding:8px 0;border-bottom:1px solid var(--color-border);">' + expText + '</td></tr>',
                '      <tr><td style="color:var(--color-text-muted);padding:8px 0 8px;border-bottom:1px solid var(--color-border);">Estado</td><td style="color:' + statusColor + ';padding:8px 0;border-bottom:1px solid var(--color-border);font-weight:600;">' + statusText + '</td></tr>',
                '      <tr><td style="color:var(--color-text-muted);padding:8px 0 8px;">Soporte</td><td style="padding:8px 0;"><a href="mailto:' + supportEmail + '" style="color:#c49a6c;text-decoration:none;font-size:13px;">' + supportEmail + '</a>' + (supportPhone ? '<br><span style="color:var(--color-text-secondary);font-size:12px;">' + supportPhone + '</span>' : '') + '</td></tr>',
                '    </table>',
                '  </div>',
                '  <div style="padding:20px 28px 24px;text-align:right;">',
                '    <button id="lic-info-close-btn" style="padding:10px 24px;background:#c49a6c;color:var(--color-text-inverted);border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">Cerrar</button>',
                '  </div>',
                '</div>'
            ].join('\n');

            document.body.appendChild(overlay);

            var closeBtn = document.getElementById('lic-info-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                });
            }
            // Also close on backdrop click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                }
            });
        }

        function showSetupScreen() {
            var overlay = document.createElement('div');
            overlay.className = 'setup-overlay';
            overlay.id = 'setup-overlay';
            overlay.innerHTML = [
                '<div class="setup-card">',
                '  <h1>Configuracion Inicial</h1>',
                '  <p class="setup-subtitle">Configure su instancia del cotizador</p>',

                '  <div class="setup-field">',
                '    <label>Empresa <span style="color:#c49a6c">*</span></label>',
                '    <input type="text" id="su-company" placeholder="Mi Carpinteria" maxlength="60">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Monograma <span style="color:#c49a6c">*</span></label>',
                '    <input type="text" id="su-mono" placeholder="MC" maxlength="4">',
                '    <div class="setup-hint">2-4 letras que identifican su empresa</div>',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Lema (opcional)</label>',
                '    <input type="text" id="su-tagline" placeholder="Muebles a la Medida" maxlength="80">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Logo (opcional)</label>',
                '    <label class="setup-file-label" for="su-logo-input">Seleccionar imagen</label>',
                '    <input type="file" id="su-logo-input" class="setup-file-input" accept="image/*">',
                '    <img id="su-logo-preview" class="setup-logo-preview" alt="Logo preview">',
                '  </div>',

                '  <div class="setup-divider">Licencia</div>',
                '  <div class="setup-field">',
                '    <label>Clave de Licencia (opcional)</label>',
                '    <input type="text" id="su-lickey" placeholder="Pegue su clave de licencia aqui">',
                '    <div class="setup-hint">Puede ingresar o actualizar la clave de licencia despues</div>',
                '  </div>',

                '  <div class="setup-divider">Conexion Cloud (Supabase)</div>',
                '  <div class="setup-field">',
                '    <label>URL de Supabase (opcional)</label>',
                '    <input type="text" id="su-sburl" placeholder="https://xxx.supabase.co">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Anon Key (opcional)</label>',
                '    <input type="text" id="su-sbkey" placeholder="eyJ...">',
                '  </div>',

                '  <div class="setup-divider">Datos de Contacto</div>',
                '  <div class="setup-field">',
                '    <label>Nombre de contacto (opcional)</label>',
                '    <input type="text" id="su-cname" placeholder="Mi Carpinteria">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Ciudad (opcional)</label>',
                '    <input type="text" id="su-ccity" placeholder="Monterrey">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Telefono oficina (opcional)</label>',
                '    <input type="text" id="su-coffice" placeholder="81 1234-5678">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Celular (opcional)</label>',
                '    <input type="text" id="su-ccell" placeholder="81 1234-5678">',
                '  </div>',
                '  <div class="setup-field">',
                '    <label>Email (opcional)</label>',
                '    <input type="email" id="su-cemail" placeholder="info@micarpinteria.com">',
                '  </div>',

                '  <button class="setup-btn" id="su-save-btn">Guardar y Comenzar</button>',
                '  <p class="setup-footer-note">Puede modificar estos datos despues en Configuracion</p>',
                '</div>'
            ].join('\n');

            document.body.appendChild(overlay);

            // Logo file picker  show preview
            var logoInput = document.getElementById('su-logo-input');
            var logoPreview = document.getElementById('su-logo-preview');
            if (logoInput) {
                logoInput.addEventListener('change', function() {
                    var file = logoInput.files && logoInput.files[0];
                    if (!file) return;
                    var reader = new FileReader();
                    reader.onload = function(ev) {
                        logoPreview.src = ev.target.result;
                        logoPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                });
            }

            // Save button handler
            var saveBtn = document.getElementById('su-save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    var companyEl = document.getElementById('su-company');
                    var monoEl    = document.getElementById('su-mono');
                    var company   = companyEl ? companyEl.value.trim() : '';
                    var mono      = monoEl    ? monoEl.value.trim()    : '';

                    // Validate required fields
                    var valid = true;
                    if (!company) {
                        if (companyEl) companyEl.classList.add('setup-error');
                        valid = false;
                    } else {
                        if (companyEl) companyEl.classList.remove('setup-error');
                    }
                    if (!mono) {
                        if (monoEl) monoEl.classList.add('setup-error');
                        valid = false;
                    } else {
                        if (monoEl) monoEl.classList.remove('setup-error');
                    }
                    if (!valid) return;

                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Guardando...';

                    var data = {
                        companyName:   company,
                        monogram:      mono,
                        tagline:       (document.getElementById('su-tagline')  || {}).value || '',
                        licenseKey:    (document.getElementById('su-lickey')   || {}).value || '',
                        supabaseUrl:   (document.getElementById('su-sburl')    || {}).value || '',
                        supabaseKey:   (document.getElementById('su-sbkey')    || {}).value || '',
                        contactName:   (document.getElementById('su-cname')    || {}).value || '',
                        contactCity:   (document.getElementById('su-ccity')    || {}).value || '',
                        contactOffice: (document.getElementById('su-coffice')  || {}).value || '',
                        contactCell:   (document.getElementById('su-ccell')    || {}).value || '',
                        contactEmail:  (document.getElementById('su-cemail')   || {}).value || ''
                    };

                    // Handle logo: if base64 already loaded in preview, include it
                    var logoSrc = logoPreview ? logoPreview.src : '';
                    if (logoSrc && logoSrc.indexOf('data:') === 0) {
                        data.logoBase64 = logoSrc;
                    }

                    saveAppConfig(data);

                    // Remove overlay and reload cleanly
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    window.location.reload();
                });
            }
        }

        // Apply APP_CONFIG overrides immediately (before BRANDS are initialized)
        loadAppConfig();

        // Helper: get bisagra count based on door height (cm) and material type
        function getBisagraCount(heightCm, materialType) {
            var rules = CONFIG.hardware.autoAssignRules.puertas;
            var count = 3; // default
            for (var i = 0; i < rules.bisagras.length; i++) {
                if (heightCm <= rules.bisagras[i].maxHeight) {
                    count = rules.bisagras[i].count;
                    break;
                }
            }
            if (materialType === 'vidrio' || materialType === 'metal') {
                count += rules.heavyMaterialBonus;
            }
            return count;
        }

        // 
        //   DEMO MATERIALS  Replace with real COLORS array when ready  
        //   To restore: delete this block and uncomment REAL block below
        // 
        var COLORS = [
            { c: 'D01', n: 'Roble Natural', f: 'Demo' },
            { c: 'D02', n: 'Nogal Oscuro', f: 'Demo' },
            { c: 'D03', n: 'Encino Blanco', f: 'Demo' },
            { c: 'D04', n: 'Cerezo Clasico', f: 'Demo' },
            { c: 'D05', n: 'Gris Cemento', f: 'Demo' },
            { c: 'D06', n: 'Negro Mate', f: 'Demo' },
            { c: 'D07', n: 'Blanco Polar', f: 'Demo' },
            { c: 'D08', n: 'Fresno Humo', f: 'Demo' },
            { c: 'D09', n: 'Olmo Toscano', f: 'Demo' },
            { c: 'D10', n: 'Maple Dorado', f: 'Demo' }
        ];
        var FINSA_PRICES = {
            16: 1200,
            25: 1700
        };
        /*  REAL COLORS (uncomment to restore) 
        var COLORS = [
        { c: '74V', n: 'Roble Stella', f: 'Atlas' },
        { c: '98V', n: 'Roble Aurora', f: 'Atlas' },
        { c: '42B', n: 'Roble Trigo', f: 'Atlas' },
        { c: '95Q', n: 'Roble Trufa', f: 'Atlas' },
        { c: '97V', n: 'Roble Colorado', f: 'Atlas' },
        { c: '4AE', n: 'Roble Eternity', f: 'Atlas' },
        { c: '04R', n: 'Olmo Volga', f: 'Atlas' },
        { c: '16N', n: 'Fresno Glacial', f: 'Atlas' },
        { c: '91B', n: 'Roble Renovales', f: 'Atlas' },
        { c: '10C', n: 'Cambridge Walnut', f: 'Atlas' },
        { c: '75V', n: 'Roble Azabache', f: 'Atlas' },
        { c: '20N', n: 'Roble Sinatra', f: 'Atlas' },
        { c: '9AR', n: 'Hickory Frida', f: 'Boreal' },
        { c: '4AR', n: 'Olmo Sabi', f: 'Boreal' },
        { c: '1AS', n: 'Nogal Valentina', f: 'Mesura' },
        { c: '451B', n: 'Roble Newman', f: 'Mesura' },
        { c: '07R', n: 'Olmo Ontario', f: 'Poro' },
        { c: '12G', n: 'Lino Cancun', f: 'Textil' },
        { c: '890', n: 'Aluminio', f: 'Soft' },
        { c: 'U12', n: 'Natural Grey', f: 'Soft' },
        { c: '197', n: 'Gris Rioja', f: 'Soft' },
        { c: '71A', n: 'Gris Gu', f: 'Soft' },
        { c: '231', n: 'Negro', f: 'Soft' },
        { c: '465B', n: 'Verde Plomo', f: 'Soft' },
        { c: '3AU', n: 'Verde Arcilla', f: 'Soft' }
        ];
        var FINSA_PRICES = { 16: 1000, 25: 1400 };
         END REAL COLORS  */
        // CUSTOMIZE: Project types  add/remove project categories for custom mode
        var TYPES = [{
            id: 'tv',
            n: 'Mueble de TV',
            i: '&#x1f4fa;'
        }, {
            id: 'credenza',
            n: 'Credenza',
            i: '&#x1f5c4;'
        }, {
            id: 'closet',
            n: 'Closet',
            i: '&#x1f454;'
        }, {
            id: 'cocina',
            n: 'Cocina',
            i: '&#x1f373;'
        }, {
            id: 'bano',
            n: 'Bano',
            i: '&#x1f6bf;'
        }, {
            id: 'puerta',
            n: 'Puertas',
            i: '&#x1f6aa;'
        }, {
            id: 'librero',
            n: 'Librero',
            i: '&#x1f4da;'
        }, {
            id: 'mesa_centro',
            n: 'Mesa de Centro',
            i: '&#x2615;'
        }, {
            id: 'otro',
            n: 'Otro',
            i: '&#x1f4e6;'
        }];
        // CUSTOMIZE: Module types  add new module types here (id, name, available widths, description)
        // Standard dimensions based on Mexico market
        var MODS = {
            // Closet modules  Prof: 55-60cm
            modulo: {
                n: 'Modulo',
                w: [30, 40, 50, 60, 70, 80, 90, 100, 120],
                d: 'Modulo con zonas internas | Prof: 55-60cm',
                custom: 1,
                forType: ['closet'],
                cat: 'Modulos'
            },
            esquinero: {
                n: 'Esquinero',
                w: [90],
                d: '90x90 L-shape',
                forType: ['closet'],
                cat: 'Modulos'
            },
            // TV modules  Prof: 40-50cm, Alto base: 45-55cm
            torreLateral: {
                n: 'Torre Lateral',
                w: [30, 40, 50, 60],
                d: 'Torre lateral | Prof: 40-50cm',
                forType: ['tv'],
                cat: 'Modulos'
            },
            panelTV: {
                n: 'Panel para TV',
                w: [140, 170, 200, 240],
                d: 'Panel decorativo para TV',
                forType: ['tv'],
                cat: 'Modulos'
            },
            moduloCentral: {
                n: 'Modulo Central',
                w: [80, 100, 120, 140],
                d: 'Modulo central TV | Prof: 40-50cm, Alto: 45-55cm',
                forType: ['tv'],
                cat: 'Modulos'
            },
            lateralAbierto: {
                n: 'Lateral Abierto',
                w: [30, 40, 50, 60],
                d: 'Lateral abierto | 30-40cm ancho tipico',
                forType: ['tv'],
                cat: 'Modulos'
            },
            // Cocina modules (simplified)
            alacenaAlta: {
                n: 'Alacena Alta',
                w: [30, 45, 60, 90],
                d: 'Gabinete superior | Prof: 30-35cm, Alto: 70-90cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            gabineteBase: {
                n: 'Gabinete Base',
                w: [30, 45, 60, 90],
                d: 'Gabinete inferior | Prof: 60cm, Alto: 85-90cm',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            torre: {
                n: 'Torre',
                w: [40, 50, 60, 75, 90],
                d: 'Torre completa piso-techo | Prof: 60cm, Alto: 220cm',
                forType: ['cocina'],
                cat: 'Torres'
            },
            // Credenza modules
            credenzaBase: {
                n: 'Credenza Base',
                w: [120, 150, 180, 200, 240],
                d: 'Credenza con patas/zoclo | Prof: 40cm, Alto: 80cm',
                forType: ['credenza'],
                cat: 'Credenzas'
            },
            credenzaFlotante: {
                n: 'Credenza Flotante',
                w: [120, 150, 180, 200, 240],
                d: 'Credenza flotante muro | Prof: 40cm, Alto: 60cm',
                forType: ['credenza'],
                cat: 'Credenzas'
            },
            // TV simplified module
            gabineteTV: {
                n: 'Gabinete Flotante TV',
                w: [120, 150, 180, 200, 240],
                d: 'Gabinete flotante bajo TV | Prof: 35cm, Alto: 40cm',
                forType: ['tv'],
                cat: 'TV'
            },
            cajonBase: {
                n: 'Cajon Base',
                w: [30, 45, 60, 90],
                d: 'Base con cajones | Prof: 60cm, Alto: 85-90cm'
            },
            despensa: {
                n: 'Despensa',
                w: [40, 50, 60],
                d: 'Mueble despensa alto | Prof: 60cm'
            },
            espacioCampana: {
                n: 'Espacio Campana',
                w: [60, 70, 80, 90],
                d: 'Espacio campana | Min 60cm ancho, Prof: 50-65cm'
            },
            esquineroGiratorio: {
                n: 'Esquinero Giratorio',
                w: [90],
                d: 'Esquinero con charola giratoria'
            },
            // Cocina Bajos  Prof: 58cm, Alto casco: 72cm, Alto total: 85-90cm con patas y cubierta
            bajoEstandar: {
                n: 'Bajo Estandar',
                w: [30, 40, 45, 50, 60, 75, 80, 90, 100],
                d: 'Gabinete base 1-2 puertas | Prof: 58cm, Alto: 72cm',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            fregadero: {
                n: 'Fregadero',
                w: [60, 75, 80, 90],
                d: 'Sin techo, 2 amarres, saque trasero | Prof: 58cm',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            cajonera: {
                n: 'Cajonera',
                w: [30, 40, 45, 50, 60, 75, 80, 90],
                d: '2-4 cajones Blum Tandem | Prof: 58cm',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            esquineroCiego: {
                n: 'Esquinero Ciego',
                w: [90],
                d: 'Esquinero 90x90 ciego o en L (165\u00b0)',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            hornoBase: {
                n: 'Horno Base',
                w: [60, 75, 90],
                d: 'Nicho horno 595mm + caj\u00f3n inferior',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            // Cocina Alacenas  Prof: 30-35cm, Alto: 70-90cm
            alacenaEstandar: {
                n: 'Alacena Est\u00e1ndar',
                w: [30, 40, 45, 50, 60, 75, 80, 90],
                d: '1-2 puertas, 1-2 entrepa\u00f1os | Prof: 30-35cm, Alto: 70-90cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            alacenaAventos: {
                n: 'Alacena Aventos',
                w: [60, 75, 80, 90],
                d: 'Puerta elevable Blum Aventos (HK/HL/HS) | Prof: 30-35cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            alacenaSobreCampana: {
                n: 'Alacena Sobre Campana',
                w: [60, 70, 80, 90],
                d: 'Sobre campana o refri, prof. reducida | Prof: 20-30cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            // Cocina Torres  Prof: 58-60cm, Alto total: 220-240cm
            torreHornos: {
                n: 'Torre de Hornos',
                w: [60, 75, 90],
                d: 'Microondas + horno, caj\u00f3n inferior, ventilaci\u00f3n | Prof: 58-60cm',
                forType: ['cocina'],
                cat: 'Torres'
            },
            torreDespensa: {
                n: 'Torre Despensa',
                w: [40, 50, 60],
                d: 'Entrepa\u00f1os regulables 32mm, 2 puertas (sup+inf) | Prof: 58-60cm',
                forType: ['cocina'],
                cat: 'Torres'
            },
            // Cocina Extras  Piezas de terminacion y acabado
            vistaLateral: {
                n: 'Vista Lateral',
                w: [58, 60],
                d: 'Panel lateral visible | material premium',
                forType: ['cocina'],
                cat: 'Extras'
            },
            panelRelleno: {
                n: 'Panel de Relleno',
                w: [5, 10, 15, 20, 30, 50],
                d: 'Tira entre modulo y pared | 5-100mm',
                forType: ['cocina'],
                cat: 'Extras',
                custom: 1
            },
            cubierta: {
                n: 'Cubierta',
                w: [60, 90, 120, 150, 180, 240, 300],
                d: 'Superficie superior m2 | postformado/cuarzo/granito',
                forType: ['cocina'],
                cat: 'Extras',
                custom: 1
            },
            // New cocina modules per INSTRUCTIVO_TECNICO_COCINAS
            bajoCooktop: {
                n: 'Bajo Parrilla',
                w: [60, 75, 80, 90],
                d: 'Bajo con recorte para parrilla empotrada | Prof: 60cm',
                forType: ['cocina'],
                cat: 'Bajos'
            },
            alacenaCampana: {
                n: 'Alacena Campana',
                w: [90, 120, 150],
                d: 'Hueco central campana + 2 laterales | Prof: 32cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            alacenaEsquinera: {
                n: 'Alacena Esquinera',
                w: [60, 75, 90],
                d: 'Esquinera pared | bisagra 45\u00b0 | Prof: 32cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            alacenaProfunda: {
                n: 'Alacena Profunda',
                w: [60, 75, 80, 90],
                d: 'Sobre refri o remate | H:350mm, Prof: 60cm',
                forType: ['cocina'],
                cat: 'Alacenas'
            },
            torreMicroondas: {
                n: 'Torre Microondas',
                w: [45, 50, 60],
                d: 'Torre con hueco micro + entrepa\u00f1os | Prof: 60cm',
                forType: ['cocina'],
                cat: 'Torres'
            },
            torreRefrigerador: {
                n: 'Torre Refrigerador',
                w: [60, 70, 75, 80, 90],
                d: 'Marco/carcasa para refri (sin frentes) | Prof: 60cm',
                forType: ['cocina'],
                cat: 'Torres'
            },
            torreLimpieza: {
                n: 'Torre Escobero',
                w: [40, 45, 50],
                d: 'Espacio libre interior, 1 puerta | Prof: 60cm',
                forType: ['cocina'],
                cat: 'Torres'
            },
            zocloMod: {
                n: 'Zoclo',
                w: [100, 200, 300],
                d: 'Zoclo frontal por metros lineales',
                forType: ['cocina'],
                cat: 'Extras',
                custom: 1
            },
            isla: {
                n: 'Isla',
                w: [120, 150, 180, 200, 240],
                d: 'Caja cerrada acceso ambos lados | Prof: 90cm min',
                forType: ['cocina'],
                cat: 'Extras',
                custom: 1
            },
            gabineteRemate: {
                n: 'Gabinete Remate',
                w: [60, 75, 80, 90],
                d: 'Sobre refri o remate de linea | H:350mm',
                forType: ['cocina'],
                cat: 'Extras'
            },
            // Bano modules  Material: MDF RH obligatorio | Prof: 45-50cm, Alto: 50-60cm
            bajoLavabo: {
                n: 'Bajo Lavabo',
                w: [60, 75, 80, 90, 100],
                d: 'Cajon con saque U para cespol | MDF RH | Prof: 45-50cm',
                forType: ['bano'],
                cat: 'Bajos'
            },
            cajoneraBano: {
                n: 'Cajonera Bano',
                w: [40, 45, 50, 60],
                d: '2-3 cajones auxiliar | MDF RH | Alto: 50-60cm',
                forType: ['bano'],
                cat: 'Bajos'
            },
            botiquin: {
                n: 'Botiquin / Espejo',
                w: [40, 50, 60, 80],
                d: 'Modulo pared delgado 10-15cm prof | MDF RH',
                forType: ['bano'],
                cat: 'Altos'
            },
            // Puertas  Ancho: 80-90cm (int), 100cm (principal) | Alto: 200, 210, 240cm
            puerta: {
                n: 'Puerta',
                w: [80, 90, 100],
                d: 'Puerta individual | >100cm ancho = doble',
                panel: true,
                forType: ['puerta']
            },
            // --- TV modules (Phase 07)  Muebles de TV / Centros de Entretenimiento ---
            consolaPatas: {
                n: 'Consola con Patas',
                w: [120, 150, 180, 200, 240],
                h: 40,
                d: 40,
                d_desc: 'Prof: 35-45cm | Alto cuerpo: 40cm | Patas metalicas 5-15cm',
                forType: ['tv'],
                cat: 'TV'
            },
            consolaFlotante: {
                n: 'Consola Flotante',
                w: [120, 150, 180, 200, 240],
                h: 40,
                d: 40,
                d_desc: 'Prof: 35-45cm | Alto cuerpo: 40cm | Flotante (soportes muro)',
                forType: ['tv'],
                cat: 'TV'
            },
            torreLateralTV: {
                n: 'Torre Lateral TV',
                w: [30, 35, 40, 45, 50],
                h: 180,
                d: 30,
                d_desc: 'Ancho: 300-500mm | Prof: 250-350mm | Alto: piso a panel TV',
                forType: ['tv'],
                cat: 'TV'
            },
            repisaFlotante: {
                n: 'Repisa Flotante',
                w: [60, 80, 100, 120, 150],
                h: 4,
                d: 25,
                d_desc: 'Variante: hueca (caja) o herraje oculto (espigon min 38mm)',
                forType: ['tv'],
                cat: 'TV'
            },
            panelFondo: {
                n: 'Panel de Fondo (Lambrin)',
                w: [120, 150, 180, 200, 240],
                h: 180,
                d: 3,
                d_desc: 'Panel lambrin + bastidor oculto | Espacio cable 20-30mm',
                forType: ['tv'],
                cat: 'TV'
            },
            // Tablered Arauco  Fixed catalog products (exact INSTRUCTIVO dimensions)
            librero: {
                n: 'Librero KIRA',
                w: [138.5],  // Fixed: 1385mm total width
                d: 'Tablered Arauco | KIRA 15mm | 1385x400x1800mm | 9 piezas',
                forType: ['librero'],
                cat: 'Tablered'
            },
            credenzaTV: {
                n: 'Credenza TV NERO',
                w: [160],  // Fixed: 1600mm
                d: 'Tablered Arauco | NERO 15mm | 1600x450x440mm | 7 piezas',
                forType: ['credenza'],
                cat: 'Tablered'
            },
            mesaCentro: {
                n: 'Mesa de Centro',
                w: [100],  // Fixed: 1000mm
                d: 'Tablered Arauco | NERO+KIRA bicolor | 1000x600x400mm | 9 piezas (2 bloques)',
                forType: ['mesa_centro'],
                cat: 'Tablered'
            }
        };

        // Category tab colors for module picker
        var _isLight = document.body.classList.contains('light');
        var BP_COLORS = {
            'Bajos':    { bg: '#2563eb', border: '#3b82f6', light: _isLight ? 'rgba(37,99,235,0.18)'   : 'rgba(37,99,235,0.40)'   },
            'Alacenas': { bg: '#7c3aed', border: '#8b5cf6', light: _isLight ? 'rgba(124,58,237,0.18)'  : 'rgba(124,58,237,0.40)'  },
            'Altos':    { bg: '#7c3aed', border: '#8b5cf6', light: _isLight ? 'rgba(124,58,237,0.18)'  : 'rgba(124,58,237,0.40)'  },
            'Torres':   { bg: '#059669', border: '#10b981', light: _isLight ? 'rgba(5,150,105,0.18)'   : 'rgba(5,150,105,0.40)'   },
            'Extras':   { bg: '#d97706', border: '#f59e0b', light: _isLight ? 'rgba(217,119,6,0.18)'   : 'rgba(217,119,6,0.40)'   },
            'Modulos':  { bg: '#c49a6c', border: '#d4aa7c', light: _isLight ? 'rgba(196,154,108,0.18)' : 'rgba(196,154,108,0.40)' },
            'TV':       { bg: '#0891b2', border: '#06b6d4', light: _isLight ? 'rgba(8,145,178,0.18)'   : 'rgba(8,145,178,0.40)'   },
            'Tablered': { bg: '#65a30d', border: '#84cc16', light: _isLight ? 'rgba(101,163,13,0.18)'  : 'rgba(101,163,13,0.40)'  },
            '_default': { bg: '#6b7280', border: '#9ca3af', light: _isLight ? 'rgba(107,114,128,0.18)' : 'rgba(107,114,128,0.40)' }
        };
        function getModCatColor(modType) {
            var cat = (MODS[modType] && MODS[modType].cat) || '';
            return BP_COLORS[cat] || BP_COLORS['_default'];
        }

        // SVG silhouettes for module miniatures
        function modSvg(type) {
            var svgs = {
                bajoEstandar: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><line x1="30" y1="2" x2="30" y2="48"/><circle cx="22" cy="26" r="2"/><circle cx="38" cy="26" r="2"/></svg>',
                fregadero: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><line x1="30" y1="2" x2="30" y2="48"/><path d="M15 8 h30 v12 a6 6 0 01-6 6 h-18 a6 6 0 01-6-6z" stroke-dasharray="3,2"/></svg>',
                cajonera: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><line x1="6" y1="14" x2="54" y2="14"/><line x1="6" y1="26" x2="54" y2="26"/><line x1="6" y1="38" x2="54" y2="38"/><circle cx="30" cy="8" r="1.5"/><circle cx="30" cy="20" r="1.5"/><circle cx="30" cy="32" r="1.5"/><circle cx="30" cy="44" r="1.5"/></svg>',
                cajonBase: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><line x1="6" y1="14" x2="54" y2="14"/><line x1="6" y1="26" x2="54" y2="26"/><circle cx="30" cy="8" r="1.5"/><circle cx="30" cy="20" r="1.5"/><circle cx="30" cy="38" r="1.5"/></svg>',
                esquineroCiego: '<svg class="mod-silhouette" viewBox="0 0 60 50"><path d="M2 2 h36 v20 h20 v26 a3 3 0 01-3 3 h-50 a3 3 0 01-3-3z"/></svg>',
                hornoBase: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><rect x="8" y="6" width="44" height="28" rx="2" stroke-dasharray="3,2"/><line x1="6" y1="38" x2="54" y2="38"/></svg>',
                alacenaEstandar: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><line x1="30" y1="2" x2="30" y2="48"/><line x1="6" y1="26" x2="54" y2="26"/></svg>',
                alacenaAventos: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><path d="M30 2 v6 l20 4" stroke-dasharray="2,2"/><line x1="6" y1="26" x2="54" y2="26"/></svg>',
                alacenaSobreCampana: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="30" rx="3"/><path d="M10 36 L30 48 L50 36" stroke-dasharray="3,2"/></svg>',
                torreHornos: '<svg class="mod-silhouette" viewBox="0 0 40 70"><rect x="2" y="2" width="36" height="66" rx="3"/><rect x="6" y="6" width="28" height="20" rx="2" stroke-dasharray="3,2"/><rect x="6" y="30" width="28" height="20" rx="2" stroke-dasharray="3,2"/><line x1="6" y1="56" x2="34" y2="56"/></svg>',
                torreDespensa: '<svg class="mod-silhouette" viewBox="0 0 40 70"><rect x="2" y="2" width="36" height="66" rx="3"/><line x1="6" y1="18" x2="34" y2="18"/><line x1="6" y1="34" x2="34" y2="34"/><line x1="6" y1="50" x2="34" y2="50"/></svg>',
                vistaLateral: '<svg class="mod-silhouette" viewBox="0 0 20 50"><rect x="2" y="2" width="16" height="46" rx="2"/></svg>',
                panelRelleno: '<svg class="mod-silhouette" viewBox="0 0 16 50"><rect x="4" y="2" width="8" height="46" rx="1"/></svg>',
                cubierta: '<svg class="mod-silhouette" viewBox="0 0 80 16"><rect x="2" y="4" width="76" height="8" rx="2"/><line x1="2" y1="14" x2="78" y2="14" stroke-dasharray="2,2"/></svg>',
                modulo: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><line x1="6" y1="14" x2="54" y2="14"/><line x1="6" y1="26" x2="54" y2="26"/><line x1="6" y1="38" x2="54" y2="38"/></svg>',
                puerta: '<svg class="mod-silhouette" viewBox="0 0 40 70"><rect x="2" y="2" width="36" height="66" rx="3"/><circle cx="30" cy="38" r="2.5"/></svg>',
                bajoLavabo: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><ellipse cx="30" cy="10" rx="18" ry="6" stroke-dasharray="3,2"/><line x1="6" y1="30" x2="54" y2="30"/></svg>',
                cajoneraBano: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><line x1="6" y1="18" x2="54" y2="18"/><line x1="6" y1="34" x2="54" y2="34"/></svg>',
                botiquin: '<svg class="mod-silhouette" viewBox="0 0 50 50"><rect x="2" y="2" width="46" height="46" rx="3"/><line x1="25" y1="14" x2="25" y2="36"/><line x1="14" y1="25" x2="36" y2="25"/></svg>',
                panelTV: '<svg class="mod-silhouette" viewBox="0 0 80 50"><rect x="2" y="2" width="76" height="46" rx="3"/><rect x="12" y="10" width="56" height="30" rx="2" stroke-dasharray="3,2"/></svg>',
                consolaPatas: '<svg class="mod-silhouette" viewBox="0 0 80 40"><rect x="2" y="2" width="76" height="26" rx="3"/><line x1="10" y1="28" x2="10" y2="38"/><line x1="70" y1="28" x2="70" y2="38"/></svg>',
                consolaFlotante: '<svg class="mod-silhouette" viewBox="0 0 80 30"><rect x="2" y="6" width="76" height="20" rx="3"/><line x1="20" y1="2" x2="20" y2="6" stroke-dasharray="2,1"/><line x1="60" y1="2" x2="60" y2="6" stroke-dasharray="2,1"/></svg>',
                torreLateral: '<svg class="mod-silhouette" viewBox="0 0 30 60"><rect x="2" y="2" width="26" height="56" rx="3"/><line x1="6" y1="16" x2="24" y2="16"/><line x1="6" y1="30" x2="24" y2="30"/><line x1="6" y1="44" x2="24" y2="44"/></svg>',
                torreLateralTV: '<svg class="mod-silhouette" viewBox="0 0 30 60"><rect x="2" y="2" width="26" height="56" rx="3"/><line x1="6" y1="16" x2="24" y2="16"/><line x1="6" y1="30" x2="24" y2="30"/><line x1="6" y1="44" x2="24" y2="44"/></svg>',
                repisaFlotante: '<svg class="mod-silhouette" viewBox="0 0 80 16"><rect x="2" y="4" width="76" height="8" rx="2"/></svg>',
                panelFondo: '<svg class="mod-silhouette" viewBox="0 0 80 50"><rect x="2" y="2" width="76" height="46" rx="2" stroke-dasharray="4,2"/><line x1="20" y1="24" x2="60" y2="24"/></svg>',
                librero: '<svg class="mod-silhouette" viewBox="0 0 60 60"><rect x="2" y="2" width="56" height="56" rx="3"/><line x1="20" y1="2" x2="20" y2="58"/><line x1="40" y1="2" x2="40" y2="58"/><line x1="6" y1="20" x2="54" y2="20"/><line x1="6" y1="40" x2="54" y2="40"/></svg>',
                credenzaTV: '<svg class="mod-silhouette" viewBox="0 0 80 30"><rect x="2" y="2" width="76" height="26" rx="3"/><line x1="28" y1="2" x2="28" y2="28"/><line x1="52" y1="2" x2="52" y2="28"/></svg>',
                mesaCentro: '<svg class="mod-silhouette" viewBox="0 0 80 30"><rect x="2" y="4" width="76" height="22" rx="3"/><line x1="10" y1="26" x2="10" y2="30"/><line x1="70" y1="26" x2="70" y2="30"/></svg>',
                espacioCampana: '<svg class="mod-silhouette" viewBox="0 0 60 40"><rect x="2" y="2" width="56" height="36" rx="3" stroke-dasharray="3,2"/><path d="M15 20 L30 8 L45 20" stroke-dasharray="2,2"/></svg>',
                especial: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3" stroke-dasharray="4,2"/><text x="30" y="30" text-anchor="middle" fill="rgba(255,255,255,0.5)" stroke="none" font-size="14">?</text></svg>',
                torre: '<svg class="mod-silhouette" viewBox="0 0 40 70"><rect x="2" y="2" width="36" height="66" rx="3"/><line x1="6" y1="20" x2="34" y2="20"/><line x1="6" y1="38" x2="34" y2="38"/><line x1="6" y1="56" x2="34" y2="56"/></svg>',
                credenzaBase: '<svg class="mod-silhouette" viewBox="0 0 80 30"><rect x="2" y="2" width="76" height="22" rx="3"/><line x1="6" y1="13" x2="74" y2="13"/><line x1="10" y1="24" x2="10" y2="28"/><line x1="70" y1="24" x2="70" y2="28"/></svg>',
                credenzaFlotante: '<svg class="mod-silhouette" viewBox="0 0 80 30"><rect x="2" y="6" width="76" height="20" rx="3"/><line x1="6" y1="16" x2="74" y2="16"/><line x1="20" y1="2" x2="20" y2="6" stroke-dasharray="2,1"/><line x1="60" y1="2" x2="60" y2="6" stroke-dasharray="2,1"/></svg>',
                gabineteTV: '<svg class="mod-silhouette" viewBox="0 0 80 30"><rect x="2" y="6" width="76" height="20" rx="3"/><line x1="6" y1="16" x2="74" y2="16"/><line x1="20" y1="2" x2="20" y2="6" stroke-dasharray="2,1"/><line x1="60" y1="2" x2="60" y2="6" stroke-dasharray="2,1"/></svg>',
                // New cocina modules
                bajoCooktop: '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/><ellipse cx="20" cy="12" rx="8" ry="6" stroke-dasharray="2,2"/><ellipse cx="40" cy="12" rx="8" ry="6" stroke-dasharray="2,2"/><circle cx="22" cy="36" r="2"/><circle cx="38" cy="36" r="2"/></svg>',
                alacenaCampana: '<svg class="mod-silhouette" viewBox="0 0 80 50"><rect x="2" y="2" width="24" height="46" rx="3"/><rect x="54" y="2" width="24" height="46" rx="3"/><path d="M30 36 L40 24 L50 36" stroke-dasharray="3,2"/></svg>',
                alacenaEsquinera: '<svg class="mod-silhouette" viewBox="0 0 60 50"><path d="M2 2 h36 v20 h20 v26 a3 3 0 01-3 3 h-50 a3 3 0 01-3-3z"/><line x1="6" y1="26" x2="54" y2="26"/></svg>',
                alacenaProfunda: '<svg class="mod-silhouette" viewBox="0 0 60 30"><rect x="2" y="2" width="56" height="24" rx="3"/><line x1="30" y1="2" x2="30" y2="26"/></svg>',
                torreMicroondas: '<svg class="mod-silhouette" viewBox="0 0 40 70"><rect x="2" y="2" width="36" height="66" rx="3"/><rect x="6" y="10" width="28" height="18" rx="2" stroke-dasharray="3,2"/><line x1="6" y1="36" x2="34" y2="36"/><line x1="6" y1="50" x2="34" y2="50"/></svg>',
                torreRefrigerador: '<svg class="mod-silhouette" viewBox="0 0 40 70"><rect x="2" y="2" width="36" height="66" rx="3"/><rect x="6" y="6" width="28" height="56" rx="2" stroke-dasharray="3,2"/></svg>',
                torreLimpieza: '<svg class="mod-silhouette" viewBox="0 0 30 70"><rect x="2" y="2" width="26" height="66" rx="3"/><circle cx="20" cy="36" r="2"/></svg>',
                zocloMod: '<svg class="mod-silhouette" viewBox="0 0 80 16"><rect x="2" y="4" width="76" height="8" rx="2"/></svg>',
                isla: '<svg class="mod-silhouette" viewBox="0 0 80 50"><rect x="2" y="2" width="76" height="46" rx="3"/><line x1="6" y1="26" x2="74" y2="26"/><circle cx="22" cy="14" r="2"/><circle cx="40" cy="14" r="2"/><circle cx="58" cy="14" r="2"/></svg>',
                gabineteRemate: '<svg class="mod-silhouette" viewBox="0 0 60 24"><rect x="2" y="2" width="56" height="20" rx="3"/><line x1="30" y1="2" x2="30" y2="22"/></svg>'
            };
            return svgs[type] || '<svg class="mod-silhouette" viewBox="0 0 60 50"><rect x="2" y="2" width="56" height="46" rx="3"/></svg>';
        }

        // 
        //   DEMO HARDWARE  Replace with real HW_DEFAULTS when ready       
        //   To restore: delete this block and uncomment REAL block below    
        //   Demo prices are round numbers, ~15-35% above typical cost      
        // 
        var HW_DEFAULTS = {
            corr_oculta: {
                desc: 'Corredera oculta soft-close',
                marca: 'DEMO',
                fallback: 300,
                cat: 'CORREDERA'
            },
            bisagra: {
                desc: 'Bisagra de cierre suave',
                marca: 'DEMO',
                fallback: 20,
                cat: 'BISAGRA'
            },
            base_clip: {
                desc: 'Base clip para bisagra',
                marca: 'DEMO',
                fallback: 5,
                cat: 'BISAGRA'
            },
            tipon: {
                desc: 'Sistema push-to-open',
                marca: 'DEMO',
                fallback: 110,
                cat: 'TIP-ON'
            },
            jaladera: {
                desc: 'Jaladera moderna',
                marca: 'DEMO',
                fallback: 20,
                cat: 'JALADERA'
            }
        };
        // Keys needed by auto-assignment but not in demo  add minimal fallbacks
        if (!HW_DEFAULTS.corr_eco) HW_DEFAULTS.corr_eco = { desc: 'Corredera economica', marca: 'DEMO', fallback: 60, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.corr_prem) HW_DEFAULTS.corr_prem = { desc: 'Corredera premium', marca: 'DEMO', fallback: 120, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.corr_basica) HW_DEFAULTS.corr_basica = { desc: 'Corredera basica', marca: 'DEMO', fallback: 25, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.placa_tipon) HW_DEFAULTS.placa_tipon = { desc: 'Placa tip-on', marca: 'DEMO', fallback: 25, cat: 'TIP-ON' };
        if (!HW_DEFAULTS.tubo) HW_DEFAULTS.tubo = { desc: 'Tubo colgador', marca: 'DEMO', fallback: 150, cat: 'ACC. CLOSET' };
        if (!HW_DEFAULTS.soporte) HW_DEFAULTS.soporte = { desc: 'Soporte tubo', marca: 'DEMO', fallback: 45, cat: 'ACC. CLOSET' };
        if (!HW_DEFAULTS.nivelador) HW_DEFAULTS.nivelador = { desc: 'Nivelador', marca: 'DEMO', fallback: 6, cat: 'NIVELADOR' };
        // Cocina bajo hardware  patas, zoclo, Blum Tandem, bisagra 165 para esquinero
        if (!HW_DEFAULTS.pata) HW_DEFAULTS.pata = { desc: 'Pata regulable cocina', marca: 'DEMO', fallback: 35, cat: 'ACC. COCINA' };
        if (!HW_DEFAULTS.zoclo_clip) HW_DEFAULTS.zoclo_clip = { desc: 'Clip zoclo cocina', marca: 'DEMO', fallback: 8, cat: 'ACC. COCINA' };
        if (!HW_DEFAULTS.corr_tandem) HW_DEFAULTS.corr_tandem = { desc: 'Corredera Blum Tandem soft-close', marca: 'DEMO', fallback: 350, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.bisagra_165) HW_DEFAULTS.bisagra_165 = { desc: 'Bisagra 165\u00b0 esquinero', marca: 'DEMO', fallback: 45, cat: 'BISAGRA' };
        if (!HW_DEFAULTS.aventos_hk) HW_DEFAULTS.aventos_hk = { desc: 'Blum Aventos HK-S', marca: 'DEMO', fallback: 850, cat: 'AVENTOS' };
        if (!HW_DEFAULTS.aventos_hl) HW_DEFAULTS.aventos_hl = { desc: 'Blum Aventos HL', marca: 'DEMO', fallback: 1200, cat: 'AVENTOS' };
        if (!HW_DEFAULTS.aventos_hs) HW_DEFAULTS.aventos_hs = { desc: 'Blum Aventos HS', marca: 'DEMO', fallback: 1500, cat: 'AVENTOS' };
        if (!HW_DEFAULTS.soporte_alacena) HW_DEFAULTS.soporte_alacena = { desc: 'Soporte colgante alacena', marca: 'DEMO', fallback: 25, cat: 'ACC. COCINA' };
        if (!HW_DEFAULTS.soporte_bano) HW_DEFAULTS.soporte_bano = { desc: 'Escuadra muro bano flotante', marca: 'DEMO', fallback: 35, cat: 'ACC. BANO' };
        // Tablered Arauco hardware keys (guarded conditionals  matching Phase 1 pattern)
        if (!HW_DEFAULTS.regaton) HW_DEFAULTS.regaton = { desc: 'Regaton nivelador tachuela plastica', marca: 'DEMO', fallback: 8, cat: 'ACC. TABLERED' };
        if (!HW_DEFAULTS.pata_metalica) HW_DEFAULTS.pata_metalica = { desc: 'Pata metalica 10cm', marca: 'DEMO', fallback: 85, cat: 'ACC. TABLERED' };
        if (!HW_DEFAULTS.piston_150n) HW_DEFAULTS.piston_150n = { desc: 'Piston gas 150N (tapa abatible)', marca: 'DEMO', fallback: 350, cat: 'ACC. TABLERED' };
        if (!HW_DEFAULTS.pata_niveladora) HW_DEFAULTS.pata_niveladora = { desc: 'Pata niveladora 5cm regulable', marca: 'DEMO', fallback: 25, cat: 'ACC. TABLERED' };
        if (!HW_DEFAULTS.cubrecanto_ml) HW_DEFAULTS.cubrecanto_ml = { desc: 'Cubrecanto PVC 0.45mm (por ml)', marca: 'DEMO', fallback: 15, cat: 'ACC. TABLERED' };
        // TV module hardware keys (Phase 07  guarded conditionals)
        if (!HW_DEFAULTS.soporte_flotante) HW_DEFAULTS.soporte_flotante = { desc: 'Soporte muro flotante (consola/repisa)', marca: 'DEMO', fallback: 45, cat: 'ACC. TV' };
        if (!HW_DEFAULTS.herraje_repisa) HW_DEFAULTS.herraje_repisa = { desc: 'Herraje repisa oculto espigon (par)', marca: 'DEMO', fallback: 120, cat: 'ACC. TV' };
        if (!HW_DEFAULTS.bastidor_ml) HW_DEFAULTS.bastidor_ml = { desc: 'Bastidor pino 1x2 panel fondo (por ml)', marca: 'DEMO', fallback: 25, cat: 'ACC. TV' };
        if (!HW_DEFAULTS.corr_carga_pesada) HW_DEFAULTS.corr_carga_pesada = { desc: 'Corredera carga pesada (cajon ollero)', marca: 'DEMO', fallback: 180, cat: 'CORREDERA' };
        if (!HW_DEFAULTS.bisagra_libro) HW_DEFAULTS.bisagra_libro = { desc: 'Bisagra libro/mariposa puerta', marca: 'DEMO', fallback: 65, cat: 'BISAGRA' };
        if (!HW_DEFAULTS.chapa_puerta) HW_DEFAULTS.chapa_puerta = { desc: 'Chapa con manija puerta', marca: 'DEMO', fallback: 350, cat: 'ACC. PUERTA' };
        /*  REAL HW_DEFAULTS (uncomment to restore) 
        var HW_DEFAULTS = {
            corr_eco: { desc: 'Corredera ext total ecoline', marca: 'HERRAXA', fallback: 49.90, cat: 'CORREDERA' },
            corr_prem: { desc: 'Corredera ext total soft close', marca: 'HERRAXA', fallback: 99.90, cat: 'CORREDERA' },
            corr_oculta: { desc: 'Guia TDM oculta soft', marca: 'HERRAXA', fallback: 249.90, cat: 'CORREDERA' },
            corr_basica: { desc: 'Corredera ext lateral basica', marca: 'HERRAXA', fallback: 20.90, cat: 'CORREDERA' },
            bisagra: { desc: 'Bisagra bastidor', marca: 'HERRAXA', fallback: 16.90, cat: 'BISAGRA' },
            base_clip: { desc: 'Base clip', marca: 'HERRAXA', fallback: 4.18, cat: 'BISAGRA' },
            tipon: { desc: 'Tip on corto gris', marca: 'HERRAXA', fallback: 88.38, cat: 'TIP-ON' },
            placa_tipon: { desc: 'Placa para tip on recta', marca: 'HERRAXA', fallback: 20.18, cat: 'TIP-ON' },
            jaladera: { desc: 'Jaladera', marca: 'HERRAXA', fallback: 15.00, cat: 'JALADERA' },
            tubo: { desc: 'Tubo colgador', marca: 'HERRAXA', fallback: 120.00, cat: 'ACC. CLOSET' },
            soporte: { desc: 'Soporte tubo', marca: 'HERRAXA', fallback: 35.00, cat: 'ACC. CLOSET' },
            nivelador: { desc: 'Nivelador', marca: 'HERRAXA', fallback: 5.00, cat: 'NIVELADOR' },
            pata: { desc: 'Pata regulable cocina 100-150mm', marca: 'HERRAXA', fallback: 28.00, cat: 'ACC. COCINA' },
            zoclo_clip: { desc: 'Clip fijacion zoclo', marca: 'HERRAXA', fallback: 6.50, cat: 'ACC. COCINA' },
            corr_tandem: { desc: 'Blum Tandem cierre suave', marca: 'HERRAXA', fallback: 289.00, cat: 'CORREDERA' },
            bisagra_165: { desc: 'Bisagra 165 grados esquinero', marca: 'HERRAXA', fallback: 38.00, cat: 'BISAGRA' },
            bisagra_libro: { desc: 'Bisagra libro/mariposa puerta', marca: 'HERRAXA', fallback: 55.00, cat: 'BISAGRA' },
            chapa_puerta: { desc: 'Chapa con manija puerta interior', marca: 'HERRAXA', fallback: 280.00, cat: 'ACC. PUERTA' },
            perfil_gola: { desc: 'Perfil Gola aluminio (por pieza)', marca: 'HERRAXA', fallback: 180.00, cat: 'JALADERA' }
        };
         END REAL HW_DEFAULTS  */

        // CUSTOMIZE: Closet internal zone types  composable zones stacked vertically inside a modulo
        var CLOSET_ZONE_TYPES = {
            colgador:      { n: 'Colgador',          icon: '\uD83D\uDC54', flexible: true,  minH: 110, fixedH: 0,  desc: 'Tubo sencillo' },
            colgadorDoble: { n: 'Colgador Doble',    icon: '\uD83D\uDC54', flexible: true,  minH: 190, fixedH: 0,  desc: 'Doble barra (camisas + pantalones)' },
            entrepa:       { n: 'Entrepa\u00f1os',   icon: '\uD83D\uDCDA', flexible: true,  minH: 30,  fixedH: 0,  desc: 'Repisas regulables' },
            entrepa_esp:   { n: 'Entrepa\u00f1o Esp.', icon: '\uD83D\uDCDA', flexible: true,  minH: 30,  fixedH: 0,  desc: 'Repisas media profundidad' },
            cajones:       { n: 'Cajones',            icon: '\uD83D\uDCE6', flexible: false, minH: 0,   fixedH: 20, desc: '~20cm por cajon' },
            zapatero:      { n: 'Zapatero',           icon: '\uD83D\uDC5F', flexible: false, minH: 0,   fixedH: 15, desc: '15cm/nivel + 5cm frente' },
            // maletero removed from zones  it's a module-level toggle (on top, outside height)
        };
        // Auto-distribute zone heights within a module's total height (in cm)
        // Fixed zones get fixedH * qty; flexible zones split remaining space
        function autoDistributeZones(zones, totalH) {
            if (!zones || zones.length === 0) return;
            // Strip legacy maletero zones (maletero is module-level now)
            for (var mi = zones.length - 1; mi >= 0; mi--) {
                if (zones[mi].type === 'maletero') zones.splice(mi, 1);
            }
            var usedFixed = 0;
            var flexCount = 0;
            zones.forEach(function(z) {
                var zt = CLOSET_ZONE_TYPES[z.type];
                if (!zt) return;
                if (z.heightOverride > 0) {
                    usedFixed += z.heightOverride;
                } else if (!zt.flexible) {
                    var uH = z.unitH || zt.fixedH;
                    usedFixed += uH * (z.qty || 1);
                } else {
                    flexCount++;
                }
            });
            var remaining = Math.max(0, totalH - usedFixed);
            var perFlex = flexCount > 0 ? Math.floor(remaining / flexCount) : 0;
            zones.forEach(function(z) {
                var zt = CLOSET_ZONE_TYPES[z.type];
                if (!zt) { z._h = 20; return; }
                if (z.heightOverride > 0) {
                    z._h = z.heightOverride;
                } else if (!zt.flexible) {
                    var uH = z.unitH || zt.fixedH;
                    z._h = uH * (z.qty || 1);
                } else {
                    z._h = Math.max(zt.minH, perFlex);
                }
            });
        }

        // Find module by ID in custom project
        function findMod(id) {
            return S.project.modules.find(function(m) { return m.id === id; });
        }
        // LED component catalog (Hfele LOOX5 system)
        var LED_CATALOG = {
            alimentadores: [
            {
                w: 20,
                desc: 'Alimentador LOOX5 24V 20W',
                price: 412.27
            },
            {
                w: 40,
                desc: 'Alimentador LOOX5 24V 40W',
                price: 1026.17
            },
            {
                w: 60,
                desc: 'Alimentador LOOX5 24V 60W',
                price: 1371.96
            },
            {
                w: 90,
                desc: 'Alimentador LOOX5 24V 90W',
                price: 1681.19
            }
            ],
            fixed: {
                cable_primario: {
                    desc: 'Cable primario US/Csa 250V 2000mm',
                    price: 150.00
                },
                distribuidor: {
                    desc: 'Distribuidor 6 vias 24V c/conmutacion',
                    price: 205.01
                },
                cable_interruptor: {
                    desc: 'Cable alim interruptor modular',
                    price: 113.96
                },
                placa_montaje: {
                    desc: 'Placa montaje interruptor',
                    price: 26.41
                }
            },
            switches: {
                presion: {
                    desc: 'Interruptor presion embutir negro 2000mm',
                    price: 109.63
                },
                dimmer: {
                    desc: 'Interruptor dimmer sin contacto',
                    price: 142.64
                },
                movimiento: {
                    desc: 'Interruptor sensor movimiento',
                    price: 98.24
                },
                puerta: {
                    desc: 'Interruptor puerta embutir/montar gris',
                    price: 410.44
                }
            },
            variable: {
                tira_calida: {
                    desc: 'Tira LED 3103 24V 5m Calida 3000K',
                    price: 1332.27,
                    length: 5
                },
                tira_fria: {
                    desc: 'Tira LED 3103 24V 5m Fria 5000K',
                    price: 1332.28,
                    length: 5
                },
                cable_alim_tira: {
                    desc: 'Cable alimentador 24V 2000mm tira 8mm',
                    price: 110.07
                },
                perfil_embutir: {
                    desc: 'Perfil embutir 1103 AL 11.5mm 3000mm',
                    price: 521.12,
                    length: 3
                },
                cable_extension: {
                    desc: 'Cable extension LOOX5 24V 2000mm',
                    price: 129.94
                },
                regleta_extra: {
                    desc: 'Regleta LOOX5 6 puertos 24V',
                    price: 115.26
                }
            },
            wattsPerMeter: 4.8,
            headroom: 1.2
        };

        // CUSTOMIZE: Templates  add/modify quick-quote templates (base price, dimensions, modules)
        var TEMPLATES = [
        {
            id: 'tv-panel-credenza',
            name: 'Muro TV con Credenza Nogal',
            photo: 'data-closets/pic38-closet.jpeg',
            type: 'tv',
            desc: 'Panel liso con ranuras decorativas y credenza',
            baseWidth: 360,
            baseHeight: 260,
            material: 'Nogal Claro Alto Brillo',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 24500,
            weeks: 5,
            laborCost: 4000,
            preModules: [{
                type: 'panelTV',
                width: 240
            }, {
                type: 'entrepa',
                width: 100,
                shelves: 4,
                doors: true
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'cocina-loft',
            name: 'Cocina Loft',
            photo: 'data-closets/pic37-closet.jpeg',
            type: 'cocina',
            desc: 'Diseno moderno negro mate + nogal con cubierta de cuarzo',
            baseWidth: 320,
            baseHeight: 240,
            material: 'Negro mate + Nogal',
            matCode: '231',
            matName: 'Negro',
            matFinish: 'Soft',
            basePrice: 95000,
            weeks: 4,
            laborCost: 12000,
            preModules: [{
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'entrepa',
                width: 80,
                shelves: 5,
                doors: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'closet-europeo',
            name: 'Closet Europeo con Espejo',
            photo: 'data-closets/pic40-closet.jpeg',
            type: 'closet',
            desc: 'Closet con espejo ahumado, color personalizable',
            baseWidth: 240,
            baseHeight: 240,
            material: 'Nogal + Espejo ahumado',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 38000,
            weeks: 4,
            laborCost: 6000,
            preModules: [{
                type: 'colgador',
                width: 90
            }, {
                type: 'modulo',
                width: 80,
                cajones: 4
            }, {
                type: 'entrepa',
                width: 70,
                shelves: 5
            }]
        },
        {
            id: 'tv-nogal-torres',
            name: 'Mueble TV Nogal con Torres',
            photo: 'data-closets/pic41-closet.jpeg',
            type: 'tv',
            desc: 'Panel TV central, 2 torres laterales, credenza base',
            baseWidth: 300,
            baseHeight: 240,
            material: 'Nogal melamina europea',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 42000,
            weeks: 5,
            laborCost: 6000,
            preModules: [{
                type: 'panelTV',
                width: 200
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 3
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 3
            }, {
                type: 'modulo',
                width: 90,
                cajones: 4,
                doors: true
            }]
        },
        {
            id: 'tv-premium-led',
            name: 'Mueble TV Premium LED + Vidrio',
            photo: 'data-closets/pic11-closet.jpeg',
            type: 'tv',
            desc: '2 torres con vidrio templado, credenza 6 puertas, panel TV, LED',
            baseWidth: 295,
            baseHeight: 240,
            material: 'Melamina europea cedro/nogal',
            matCode: '1AS',
            matName: 'Nogal Valentina',
            matFinish: 'Mesura',
            basePrice: 55500,
            weeks: 5,
            laborCost: 8000,
            hasLed: true,
            hasGlass: true,
            preModules: [{
                type: 'panelTV',
                width: 200
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 4,
                doors: true
            }, {
                type: 'torreLateral',
                width: 50,
                shelves: 4,
                doors: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true,
                tipon: true
            }, {
                type: 'modulo',
                width: 70,
                cajones: 4,
                doors: true,
                tipon: true
            }]
        }
        ];

        // Catalog helpers
        function getCatalog() {
            return typeof CATALOG !== 'undefined' ? CATALOG : [];
        }
        function getAraucoTableros() {
            return getCatalog().filter(function(i) {
                return i.categoria === 'TABLERO' && i.marca === 'ARAUCO';
            });
        }
        function getChapacanto() {
            return getCatalog().filter(function(i) {
                return i.categoria === 'CHAPACANTO';
            });
        }
        function findCatItem(searchDesc, marca) {
            var cat = getCatalog(),
                best = null,
                bestScore = 0;
            var terms = searchDesc.toLowerCase().split(/\s+/);
            cat.forEach(function(item) {
                if (marca && item.marca !== marca)
                    return;
                var d = item.descripcion.toLowerCase(),
                    score = 0;
                terms.forEach(function(t) {
                    if (d.indexOf(t) >= 0)
                        score++;
                });
                if (score > bestScore) {
                    bestScore = score;
                    best = item;
                }
            });
            return best;
        }
        function adjPrice(item) {
            if (!item)
                return 0;
            var adj = S.settings.supplierAdj[item.marca] || 0;
            return item.precio * (1 + adj / 100);
        }
        function getHWCats() {
            var cats = {};
            getCatalog().forEach(function(i) {
                if (i.categoria !== 'TABLERO' && i.categoria !== 'CHAPACANTO')
                    cats[i.categoria] = 1;
            });
            return Object.keys(cats).sort();
        }
        function getHWMarcas() {
            var m = {};
            getCatalog().forEach(function(i) {
                if (i.categoria !== 'TABLERO' && i.categoria !== 'CHAPACANTO')
                    m[i.marca] = 1;
            });
            return Object.keys(m).sort();
        }
        function filterHW() {
            var f = S.hwFilter,
                items = getCatalog().filter(function(i) {
                    if (i.categoria === 'TABLERO' || i.categoria === 'CHAPACANTO')
                        return false;
                    if (f.marca && i.marca !== f.marca)
                        return false;
                    if (f.cat && i.categoria !== f.cat)
                        return false;
                    if (f.q) {
                        var q = f.q.toLowerCase();
                        if (i.descripcion.toLowerCase().indexOf(q) < 0 && i.codigo.toLowerCase().indexOf(q) < 0)
                            return false;
                    }
                    return true;
                });
            return items.slice(0, 60);
        }

        function defaultMat() {
            return {
                brand: 'FINSA',
                code: COLORS[0].c,
                name: COLORS[0].n,
                finish: COLORS[0].f,
                precio: FINSA_PRICES[16],
                thickness: 16
            };
        }

        // Brands (derived from CONFIG)
        var BRANDS = {};
        BRANDS.primary = { id:'primary', mono:CONFIG.brand.mono, name:CONFIG.brand.name, tagline:CONFIG.brand.tagline };
        if (CONFIG.brand.altBrand) { var a = CONFIG.brand.altBrand; BRANDS[a.id] = a; }
        var CONTACT = {
            name: CONFIG.contact.name,
            office: CONFIG.contact.office,
            cell: CONFIG.contact.cell,
            email: CONFIG.contact.email,
            city: CONFIG.contact.city
        };

        // Load persisted data
        var savedLogo = null;
        try {
            savedLogo = localStorage.getItem(CONFIG.storage.prefix + 'logo_base64');
        } catch (e) {}
        var savedCounter = 1;
        try {
            var sc = localStorage.getItem(CONFIG.storage.prefix + 'quote_counter');
            if (sc)
                savedCounter = parseInt(sc) || 1;
        } catch (e) {}
        var savedBrand = 'primary';
        try {
            var sb = localStorage.getItem(CONFIG.storage.prefix + 'brand');
            if (sb && BRANDS[sb])
                savedBrand = sb;
        } catch (e) {}

        // State
        var S = {
            screen: 'templates',
            selTemplate: null,
            quickWidth: 0,
            quickHeight: 0,
            quickMat: '',
            quickMatName: '',
            quickMatFinish: '',
            waCopied: false,
            imgModal: null,
            step: 1,
            view: 'quote',
            copied: false,
            showHWPicker: false,
            hwFilter: {
                marca: '',
                cat: '',
                q: ''
            },
            showSettings: false,
            showCostBreakdown: false,
            brand: savedBrand,
            logoBase64: savedLogo,
            quoteCounter: savedCounter,
            pdfData: null,
            settings: {
                marginCarp: CONFIG.pricing.marginCarp,
                marginHwStd: CONFIG.pricing.marginHwStd,
                marginBlum: CONFIG.pricing.marginBlum * 100,
                marginPreset: 'estandar',
                supplierAdj: {
                    ARAUCO: 0,
                    HERRAXA: 0,
                    BLUM: 0,
                    HAFELE: 0,
                    DEMO: 0
                }
            },
            project: {
                client: '',
                type: '',
                sameMaterial: true,
                matFrentes: defaultMat(),
                matInterior: defaultMat(),
                chapFrentesPrice: CONFIG.pricing.defaultChapPrice,
                chapInteriorPrice: CONFIG.pricing.defaultChapPrice,
                thickness: 16,
                modules: [],
                hardware: [],
                ledConfig: {
                    activation: 'dimmer',
                    lightTemp: 'calida'
                },
                glass: false,
                glassM2: 0,
                laborCost: CONFIG.pricing.defaultLaborCost,
                freight: true,
                freightCost: CONFIG.pricing.defaultFreightCost,
                defaultHeight: 200,
                defaultDepth: 50,
                sameDepth: true,
                chapSpec: CONFIG.pricing.defaultChapSpec
            },
            editedPieces: {},
            // V6: UI state
            modCatTab: '',
            selectedModId: null,
            ledPanelOpen: {},
            paintPanelOpen: {},
            darkMode: (function() { try { var v = localStorage.getItem('cot_darkMode'); return v === null ? true : v === 'true'; } catch(e) { return true; } })()
        };
        var scrollY = 0;
        if (!S.darkMode) document.body.classList.add('light');

        // Utilities
        function $(id) {
            return document.getElementById(id);
        }
        function fmt(n) {
            return '$' + Math.round(n).toLocaleString('es-MX');
        }
        function fmtD(n) {
            return '$' + n.toLocaleString('es-MX', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        function uid() {
            return Math.random().toString(36).substr(2, 9);
        }
        function date() {
            return new Date().toLocaleDateString('es-MX', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }
        var BUNDLED_PROJECTS = CONFIG.bundledProjects;
        /* BUNDLED_PROJECTS_REMOVED: Original demo project data was here.
           To bundle demo projects, add them to CONFIG.bundledProjects array. */
        // === SUPABASE CLOUD STORAGE ===
        var SB_URL = CONFIG.supabase.url;
        var SB_KEY = CONFIG.supabase.key;
        var sb = null;
        try {
            if (SB_URL && SB_KEY) sb = window.supabase.createClient(SB_URL, SB_KEY);
        } catch (e) {
            console.warn('Supabase not available, using localStorage only');
        }
        var cloudProjects = null; // null=not loaded yet, []=loaded

        // === CONNECTION STATUS INDICATOR ===
        // Tracks the current cloud connection state to re-apply after DOM rebuilds
        var _cloudStatus = sb ? 'none' : 'none'; // initial: gray until first fetch

        // Updates the header dot to reflect cloud connection state
        // status: 'connected' | 'disconnected' | 'none'
        function updateCloudStatus(status) {
            _cloudStatus = status;
            var el = document.getElementById('cloud-status');
            if (!el) return;
            if (status === 'connected') {
                el.style.background = 'var(--color-success)';
                el.title = 'Conectado a Supabase';
            } else if (status === 'disconnected') {
                el.style.background = 'var(--color-error)';
                el.title = 'Error de conexion';
            } else {
                el.style.background = 'var(--color-text-muted)';
                el.title = 'Sin conexion cloud';
            }
        }

        // Re-apply stored status after DOM rebuild
        function applyCloudStatus() {
            updateCloudStatus(_cloudStatus);
        }

        function loadSavedProjects() {
            // Return cached cloud data if available, else localStorage fallback
            if (cloudProjects !== null) {
                var merged = cloudProjects.slice();
                BUNDLED_PROJECTS.forEach(function(bp) {
                    var exists = merged.some(function(p) {
                        return p.id === bp.id;
                    });
                    if (!exists)
                        merged.push(bp);
                });
                return merged;
            }
            try {
                var local = JSON.parse(localStorage.getItem(CONFIG.storage.prefix + 'saved_projects') || '[]');
                BUNDLED_PROJECTS.forEach(function(bp) {
                    var exists = local.some(function(lp) {
                        return lp.id === bp.id;
                    });
                    if (!exists)
                        local.push(bp);
                });
                return local;
            } catch (e) {
                return BUNDLED_PROJECTS.slice();
            }
        }
        function saveSavedProjects(arr) {
            try {
                localStorage.setItem(CONFIG.storage.prefix + 'saved_projects', JSON.stringify(arr));
            } catch (e) {}
        }

        // Fetch all projects from Supabase
        function cloudFetchProjects() {
            if (!sb) {
                updateCloudStatus('none');
                return;
            }
            sb.from('projects').select('*').order('updated_at', {
                ascending: false
            }).then(function(res) {
                if (res.error) {
                    console.error('Supabase fetch error:', res.error);
                    updateCloudStatus('disconnected');
                    return;
                }
                updateCloudStatus('connected');
                cloudProjects = (res.data || []).map(function(row) {
                    var d = row.data || {};
                    return {
                        id: row.id,
                        savedAt: row.updated_at,
                        client: row.client || d.client || '',
                        label: 'Proyecto - ' + (d.modules ? d.modules.length : 0) + ' modulo' + (d.modules && d.modules.length !== 1 ? 's' : ''),
                        moduleCount: d.modules ? d.modules.length : 0,
                        project: d
                    };
                });
                // Also cache to localStorage
                saveSavedProjects(cloudProjects);
                render();
            });
        }

        // Save one project to Supabase (upsert)
        function cloudSaveProject(entry) {
            if (!sb)
                return;
            var row = {
                id: entry.id,
                name: entry.label || '',
                client: entry.client || '',
                type: entry.project ? entry.project.projectType || '' : '',
                mode: entry.project ? entry.project.mode || 'est' : '',
                data: entry.project,
                updated_at: new Date().toISOString()
            };
            sb.from('projects').upsert(row, {
                onConflict: 'id'
            }).then(function(res) {
                if (res.error)
                    console.error('Supabase save error:', res.error);
                else
                    cloudFetchProjects(); // refresh list
            });
        }

        // Delete one project from Supabase
        function cloudDeleteProject(id) {
            if (!sb)
                return;
            sb.from('projects').delete().eq('id', id).then(function(res) {
                if (res.error)
                    console.error('Supabase delete error:', res.error);
                else
                    cloudFetchProjects();
            });
        }

        // Initial load from cloud
        cloudFetchProjects();
        function isDualType(t) {
            return t === 'closet' || t === 'cocina';
        }

        function svg(name) {
            var paths = {
                plus: '<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>',
                trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
                left: '<polyline points="15 18 9 12 15 6"/>',
                right: '<polyline points="9 18 15 12 9 6"/>',
                file: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>',
                clip: '<path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>',
                copy: '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>',
                check: '<polyline points="20 6 9 17 4 12"/>',
                x: '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
                dollar: '<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
                layers: '<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
                users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>',
                zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
                settings: '<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>',
                pkg: '<line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>',
                edit: '<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>',
                lock: '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
                search: '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
                chevDown: '<polyline points="6 9 12 15 18 9"/>'
            };
            return '<svg viewBox="0 0 24 24">' + (paths[name] || '') + '</svg>';
        }

        function marcaClass(m) {
            return 'marca-' + (m || '').toLowerCase();
        }
        function anchoLargo(w, h) {
            return {
                ancho: Math.min(w, h),
                largo: Math.max(w, h)
            };
        }

        // Get material price per sheet
        function getMatPrice(mat, thickness) {
            if (!mat)
                return FINSA_PRICES[thickness] || FINSA_PRICES[16] || 850;
            if (mat.brand === 'CUSTOM')
                return mat.customPrice || 0;
            if (mat.brand === 'FINSA')
                return FINSA_PRICES[thickness] || (thickness > 20 ? FINSA_PRICES[25] : FINSA_PRICES[16]) || 850;
            if (mat.brand === 'ARAUCO' && mat.catItem)
                return adjPrice(mat.catItem);
            return mat.precio || 850;
        }

        // === LED BOM Calculator ===
        function calcModuleLedMeters(m) {
            var P = S.project,
                led = m.led;
            if (!led || !led.enabled)
                return {
                    meters: 0,
                    segments: 0
                };
            var w = m.width / 100,
                h = (m.height || P.defaultHeight || 200) / 100;
            var meters = 0,
                segments = 0;
            if (led.edges.top) {
                meters += w;
                segments++;
            }
            if (led.edges.bottom) {
                meters += w;
                segments++;
            }
            if (led.edges.left) {
                meters += h;
                segments++;
            }
            if (led.edges.right) {
                meters += h;
                segments++;
            }
            if (led.edges.shelves && led.shelfCount > 0) {
                meters += led.shelfCount * w;
                segments += led.shelfCount;
            }
            return {
                meters: Math.round(meters * 100) / 100,
                segments: segments
            };
        }

        function calcLedBOM() {
            var P = S.project,
                totalMeters = 0,
                totalSegments = 0,
                hasLed = false;
            P.modules.forEach(function(m) {
                if (!m.led || !m.led.enabled)
                    return;
                hasLed = true;
                var auto = calcModuleLedMeters(m);
                m.led.ledMeters = auto.meters;
                m.led.segments = auto.segments;
                var usedMeters = (m.led.metersOverride !== null && m.led.metersOverride >= 0) ? m.led.metersOverride : auto.meters;
                var usedSegments = (m.led.segmentsOverride !== null && m.led.segmentsOverride >= 0) ? m.led.segmentsOverride : auto.segments;
                totalMeters += usedMeters;
                totalSegments += usedSegments;
            });
            if (!hasLed)
                return null;
            var LC = LED_CATALOG,
                items = [];
            // Variable components
            var tiraKey = P.ledConfig.lightTemp === 'fria' ? 'tira_fria' : 'tira_calida';
            var tiraInfo = LC.variable[tiraKey];
            var tiraQty = Math.max(1, Math.ceil(totalMeters / tiraInfo.length));
            items.push({
                desc: tiraInfo.desc,
                qty: tiraQty,
                unitPrice: tiraInfo.price,
                total: tiraQty * tiraInfo.price,
                type: 'variable'
            });
            var cableAlimQty = Math.max(1, totalSegments);
            items.push({
                desc: LC.variable.cable_alim_tira.desc,
                qty: cableAlimQty,
                unitPrice: LC.variable.cable_alim_tira.price,
                total: cableAlimQty * LC.variable.cable_alim_tira.price,
                type: 'variable'
            });
            var perfilQty = Math.max(1, Math.ceil(totalMeters / LC.variable.perfil_embutir.length));
            items.push({
                desc: LC.variable.perfil_embutir.desc,
                qty: perfilQty,
                unitPrice: LC.variable.perfil_embutir.price,
                total: perfilQty * LC.variable.perfil_embutir.price,
                type: 'variable'
            });
            var extQty = Math.max(1, Math.ceil(totalMeters / 4));
            items.push({
                desc: LC.variable.cable_extension.desc,
                qty: extQty,
                unitPrice: LC.variable.cable_extension.price,
                total: extQty * LC.variable.cable_extension.price,
                type: 'variable'
            });
            // Extra distributors if >6 segments
            if (totalSegments > 6) {
                var extraDist = Math.ceil((totalSegments - 6) / 6);
                items.push({
                    desc: LC.variable.regleta_extra.desc,
                    qty: extraDist,
                    unitPrice: LC.variable.regleta_extra.price,
                    total: extraDist * LC.variable.regleta_extra.price,
                    type: 'variable'
                });
            }
            // Fixed kit
            items.push({
                desc: LC.fixed.distribuidor.desc,
                qty: 1,
                unitPrice: LC.fixed.distribuidor.price,
                total: LC.fixed.distribuidor.price,
                type: 'fixed'
            });
            // Alimentador sizing
            var totalWatts = totalMeters * LC.wattsPerMeter * LC.headroom;
            var alim = LC.alimentadores[LC.alimentadores.length - 1];
            for (var i = 0; i < LC.alimentadores.length; i++) {
                if (totalWatts <= LC.alimentadores[i].w) {
                    alim = LC.alimentadores[i];
                    break;
                }
            }
            items.push({
                desc: alim.desc,
                qty: 1,
                unitPrice: alim.price,
                total: alim.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_primario.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_primario.price,
                total: LC.fixed.cable_primario.price,
                type: 'fixed'
            });
            // Switch
            var sw = LC.switches[P.ledConfig.activation] || LC.switches.dimmer;
            items.push({
                desc: sw.desc,
                qty: 1,
                unitPrice: sw.price,
                total: sw.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.cable_interruptor.desc,
                qty: 1,
                unitPrice: LC.fixed.cable_interruptor.price,
                total: LC.fixed.cable_interruptor.price,
                type: 'fixed'
            });
            items.push({
                desc: LC.fixed.placa_montaje.desc,
                qty: 1,
                unitPrice: LC.fixed.placa_montaje.price,
                total: LC.fixed.placa_montaje.price,
                type: 'fixed'
            });
            var totalCost = items.reduce(function(a, it) {
                return a + it.total;
            }, 0);
            return {
                items: items,
                totalCost: totalCost,
                totalMeters: totalMeters,
                totalSegments: totalSegments,
                totalWatts: totalWatts,
                alimentadorW: alim.w
            };
        }

        // === calculateParts: Generic piece-generation engine ===
        // Called by calc() and future calc engines to generate cut pieces for any module type.
        // moduleType: string matching MODS keys (e.g. 'modulo', 'colgador', 'zapatero', 'esquinero', 'entrepa', etc.)
        // dimensions: { w: mm, h: mm, d: mm, w2: mm (optional, for esquinero/esquineroGiratorio) }
        // materials: { thickness: number (16 or 25), cajones: number, shelves: number,
        //              quoteMode: string, corrTier: string, marco: bool, materialType: string }
        // Returns: array of { n, q, w, h, t, c, z }   (no mid/mn/mw  caller stamps those)
        function calculateParts(moduleType, dimensions, materials) {
            var w  = dimensions.w;
            var h  = dimensions.h;
            var d  = dimensions.d;
            var w2 = dimensions.w2 !== undefined ? dimensions.w2 : w;
            var TK = materials.thickness || 16;
            var pieces  = [];

            if (moduleType === 'modulo') {
                // Closet module with internal zones
                // Shell pieces (always present)
                pieces.push({ n: 'Lateral',    q: 2, w: d,            h: h,            t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 2 * TK,  h: d,            t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',      q: 1, w: w - 2 * TK,  h: h - 2 * TK,  t: TK, z: 'i' });
                // Zone-specific internal pieces
                var zones = materials.zones || [];
                zones.forEach(function(z) {
                    var qty = z.qty || 1;
                    var zoneH = (z._h || 20) * 10; // cm to mm
                    if (z.type === 'colgador') {
                        // Divider shelf below the hanging zone
                        pieces.push({ n: 'Entrepano', q: 1, w: w - 2 * TK, h: d, t: TK, z: 'i' });
                    } else if (z.type === 'colgadorDoble') {
                        // Divider shelf between upper and lower bars
                        pieces.push({ n: 'Entrepano', q: 1, w: w - 2 * TK, h: d, t: TK, z: 'i' });
                    } else if (z.type === 'entrepa' || z.type === 'entrepa_esp') {
                        var entD = z.type === 'entrepa_esp' ? Math.round((z.depth || (d / 10 / 2)) * 10) : d;
                        pieces.push({ n: z.type === 'entrepa_esp' ? 'Entrepano Esp.' : 'Entrepano', q: qty, w: w - 2 * TK, h: entD, t: TK, z: 'i' });
                    } else if (z.type === 'cajones') {
                        var ch = qty > 0 ? Math.floor(zoneH / qty) : 200;
                        pieces.push({ n: 'Frente cajon',   q: qty,     w: w - 6,    h: ch - 6,   t: TK, c: 4, z: 'f' });
                        pieces.push({ n: 'Costado cajon',  q: qty * 2, w: d - 50,   h: ch - 80,  t: TK, c: 1, z: 'i' });
                        pieces.push({ n: 'Int. cajon',     q: qty * 2, w: w - 100,  h: ch - 80,  t: TK, c: 1, z: 'i' });
                        pieces.push({ n: 'Fondo cajon',    q: qty,     w: w - 100,  h: d - 50,   t: TK, z: 'i' });
                    } else if (z.type === 'zapatero') {
                        // Pull-out shoe trays with 5cm front panel
                        pieces.push({ n: 'Charola',        q: qty, w: w - 100, h: d - 100, t: TK, z: 'i' });
                        pieces.push({ n: 'Frente charola', q: qty, w: w - 6,   h: 50,      t: TK, c: 2, z: 'f' });
                    } else if (z.type === 'maletero') {
                        // Open shelf  no internal pieces beyond the shell
                    }
                });

            } else if (moduleType === 'esquinero') {
                // Closet L-shape corner module
                // AUDIT: Lateral A  full width A, full height (one outer panel of the L)
                pieces.push({ n: 'Lateral A', q: 1, w: w,  h: h,            t: TK, z: 'i' });
                // AUDIT: Lateral B  uses w2 (second leg of L), full height
                pieces.push({ n: 'Lateral B', q: 1, w: w2, h: h,            t: TK, z: 'i' });
                // AUDIT: Diagonal  hypotenuse face panel; width = half hypotenuse (sqrt(w^2+w2^2)*0.5) rounded; 2 edges chapacanto; zone='f'
                pieces.push({ n: 'Diagonal',  q: 1, w: Math.round(Math.sqrt(w * w + w2 * w2) * 0.5), h: h, t: TK, c: 2, z: 'f' });
                // AUDIT: Techo/Piso  horizontal panels; deduct TK from both w and w2 (fit inside both laterales)
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 2 * TK, h: w2 - 2 * TK, t: TK, z: 'i' });
                // AUDIT: Entrepano  same deductions as Techo/Piso (fits inside the L-box)
                pieces.push({ n: 'Entrepano', q: 1, w: w - 2 * TK, h: w2 - 2 * TK,  t: TK, z: 'i' });

            } else if (moduleType === 'torreLateral') {
                // TV: lateral tower unit with shelves
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                // AUDIT: Lateral  zone='f' (visible front material) for TV towers
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'panelTV') {
                // TV: decorative TV background panel with crossbars
                // AUDIT: Panel  fixed 1200mm height regardless of module height (standard TV back panel)
                pieces.push({ n: 'Panel',     q: 1, w: w,       h: 1200,  t: TK, c: 4, z: 'f' });
                // AUDIT: Travesano  horizontal cross-member; 100mm tall; w - 2*TK width
                pieces.push({ n: 'Travesano', q: 2, w: w - 32,  h: 100,   t: TK,       z: 'i' });

            } else if (moduleType === 'moduloCentral') {
                // TV: central base module with single shelf
                // AUDIT: Lateral  zone='f' (visible front material) for TV modules
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: 1, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'lateralAbierto') {
                // TV: open lateral unit with shelves
                // AUDIT: Lateral  zone='f' (visible front material) for TV laterals
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'f' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'alacenaAlta') {
                // Cocina: upper wall cabinet
                // AUDIT: alacH uses module h directly (already resolved by caller in mm)
                var alacH = h;
                pieces.push({ n: 'Costado',    q: 2, w: d,           h: alacH,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo',      q: 1, w: w - 2 * TK, h: d,                 t: TK, z: 'i' });
                pieces.push({ n: 'Piso',       q: 1, w: w - 2 * TK, h: d,                 t: TK, z: 'i' });
                pieces.push({ n: 'Entrepao',  q: 1, w: w - 2 * TK, h: d,                 t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',      q: 1, w: w - 2 * TK, h: alacH - 2 * TK,   t: 3,  z: 'i' });

            } else if (moduleType === 'gabineteBase') {
                // Cocina: base cabinet  NO techo (countertop goes on top), amarres instead
                pieces.push({ n: 'Costado',      q: 2, w: d,           h: h,         t: TK, z: 'i' });
                pieces.push({ n: 'Base',          q: 1, w: w - 2 * TK, h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Amarre sup.',   q: 1, w: w - 2 * TK, h: 100,       t: TK, z: 'i' });
                pieces.push({ n: 'Amarre inf.',   q: 1, w: w - 2 * TK, h: 100,       t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',         q: 1, w: w - 2 * TK, h: h,         t: 3,  z: 'i' });
                pieces.push({ n: 'Entrepa\u00f1o', q: 1, w: w - 2 * TK - 30, h: d - TK, t: TK, z: 'i' });

            } else if (moduleType === 'cajonBase') {
                // Cocina: base cabinet with drawers
                var caj = typeof materials.cajones === 'number' ? materials.cajones : 3;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });
                if (caj > 0) {
                    // AUDIT: ch = usable height divided by drawer count (100mm structure allowance)
                    var ch = Math.floor((h - 100) / caj);
                    // AUDIT: Frente cajon  6mm gap; 4 edges chapacanto; zone='f'
                    pieces.push({ n: 'Frente cajon', q: caj,     w: w - 6,    h: ch - 6,  t: TK, c: 4, z: 'f' });
                    // AUDIT: Lat. cajon  80mm deducted from depth for kitchen drawer slide; 30mm height clearance
                    pieces.push({ n: 'Lat. cajon',   q: caj * 2, w: d - 80,   h: ch - 30, t: TK, z: 'i' });
                    // AUDIT: Resp. cajon  80mm deducted from width for kitchen slide; 30mm height clearance
                    pieces.push({ n: 'Resp. cajon',  q: caj * 2, w: w - 80,   h: ch - 30, t: TK, z: 'i' });
                    // AUDIT: Base cajon  80mm deducted from both w and d for slide clearance
                    pieces.push({ n: 'Base cajon',   q: caj,     w: w - 80,   h: d - 80,  t: TK, z: 'i' });
                }

            } else if (moduleType === 'despensa') {
                // Cocina: tall pantry with adjustable shelves
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 4;
                pieces.push({ n: 'Lateral',   q: 2, w: d,           h: h,             t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Entrepano', q: sh, w: w - 32,     h: d,             t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,   t: TK, z: 'i' });

            } else if (moduleType === 'espacioCampana') {
                // Cocina: open frame for range hood  no back, fixed 400mm lateral height
                // AUDIT: Lateral  fixed 400mm height (standard hood clearance frame)
                pieces.push({ n: 'Lateral',   q: 2, w: d,      h: 400, t: TK, z: 'i' });
                // AUDIT: Travesano  100mm tall horizontal cross-member; w - 2*TK width
                pieces.push({ n: 'Travesano', q: 2, w: w - 32, h: 100, t: TK, z: 'i' });

            } else if (moduleType === 'esquineroGiratorio') {
                // Cocina: corner unit with lazy-susan hardware
                var w2g = dimensions.w2 !== undefined ? dimensions.w2 : w;
                pieces.push({ n: 'Lateral A', q: 1, w: w,           h: h,              t: TK, z: 'i' });
                pieces.push({ n: 'Lateral B', q: 1, w: w2g,          h: h,              t: TK, z: 'i' });
                pieces.push({ n: 'Techo/Piso', q: 2, w: w - 2 * TK, h: w2g - 2 * TK,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',     q: 1, w: w - 2 * TK, h: h - 2 * TK,    t: TK, z: 'i' });

            } else if (moduleType === 'bajoEstandar') {
                // Cocina: base cabinet with 1-2 puertas (auto by width)
                // AUDIT: Costados  full casco height x depth (outer structural panels)
                pieces.push({ n: 'Costado',      q: 2, w: d,           h: h,         t: TK, z: 'i' });
                // AUDIT: Base  inner width (w - 2*TK = w - 30 at 15mm) x depth
                pieces.push({ n: 'Base',          q: 1, w: w - 2 * TK,  h: d,         t: TK, z: 'i' });
                // NO techo  countertop sits on top; amarres provide structural support
                // AUDIT: Fondo HDF  inner width x casco height (backs the box); t:3 = 3mm HDF per INSTRUCTIVO
                pieces.push({ n: 'Fondo',         q: 1, w: w - 2 * TK,  h: h,         t: 3,  z: 'i' });
                // AUDIT: Amarre frontal superior  inner width x 80mm structural brace at top front
                pieces.push({ n: 'Amarre sup.',   q: 1, w: w - 2 * TK,  h: 80,        t: TK, z: 'i' });
                // AUDIT: Amarre frontal inferior  inner width x 80mm structural brace at bottom front
                pieces.push({ n: 'Amarre inf.',   q: 1, w: w - 2 * TK,  h: 80,        t: TK, z: 'i' });
                // AUDIT: Entrepa\u00f1o  inner width minus 30mm extra clearance (sits between costados with inset) x (depth - TK for fondo)
                pieces.push({ n: 'Entrepa\u00f1o', q: 1, w: w - 2 * TK - 30, h: d - TK, t: TK, z: 'i' });

            } else if (moduleType === 'fregadero') {
                // Cocina: sink module  NO techo (tarja sits on top), 2 amarres only, saque trasero for tuberias
                // AUDIT: Costados  full casco height x depth
                pieces.push({ n: 'Costado',          q: 2, w: d,          h: h,  t: TK, z: 'i' });
                // AUDIT: Base  inner width x depth
                pieces.push({ n: 'Base',              q: 1, w: w - 2 * TK, h: d,  t: TK, z: 'i' });
                // AUDIT: NO techo  replaced by 2 amarres (tarja occupies the top opening)
                // AUDIT: Amarre frontal  inner width x 80mm (structural brace where techo would be, front)
                pieces.push({ n: 'Amarre frontal',   q: 1, w: w - 2 * TK, h: 80, t: TK, z: 'i' });
                // AUDIT: Amarre trasero  inner width x 80mm (rear structural brace)
                pieces.push({ n: 'Amarre trasero',   q: 1, w: w - 2 * TK, h: 80, t: TK, z: 'i' });
                // AUDIT: Fondo HDF with saque notation  inner width x casco height; t:3 = 3mm HDF; saque for plumbing
                pieces.push({ n: 'Fondo (saque trasero)', q: 1, w: w - 2 * TK, h: h, t: 3, z: 'i' });
                // NO entrepa\u00f1o  space is free for plumbing

            } else if (moduleType === 'cajonera') {
                // Cocina: drawer module with 2-4 cajones and Blum Tandem correderas
                var caj = typeof materials.cajones === 'number' ? materials.cajones : 3;
                // AUDIT: Costados  full casco height x depth
                pieces.push({ n: 'Costado',      q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base  inner width x depth
                pieces.push({ n: 'Base',          q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Amarre superior  inner width x 80mm (no techo on cajoneras, just structural amarre)
                pieces.push({ n: 'Amarre sup.',   q: 1, w: w - 2 * TK,  h: 80, t: TK, z: 'i' });
                // AUDIT: Fondo HDF  inner width x casco height; t:3 = 3mm HDF per INSTRUCTIVO
                pieces.push({ n: 'Fondo',         q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                if (caj > 0) {
                    // AUDIT: ch = usable casco height minus 100mm structure allowance divided evenly by cajones
                    var ch = Math.floor((h - 100) / caj);
                    // AUDIT: Frente caj\u00f3n  inner width - 4mm juego x ch - 4mm juego; 4 edges chapa; zone='f' (frente visible)
                    pieces.push({ n: 'Frente caj\u00f3n',     q: caj,     w: w - 2 * TK - 4,  h: ch - 4,  t: TK, c: 4, z: 'f' });
                    // AUDIT: Costado caj\u00f3n  (depth - 80mm for Blum Tandem slide mechanism) x (ch - 30mm slide height)
                    pieces.push({ n: 'Costado caj\u00f3n',    q: caj * 2, w: d - 80,           h: ch - 30, t: TK,       z: 'i' });
                    // AUDIT: Frente int. caj\u00f3n  (inner width - 26mm for correderas x2 sides) x (ch - 30mm)
                    pieces.push({ n: 'Frente int. caj\u00f3n', q: caj,   w: w - 2 * TK - 26,  h: ch - 30, t: TK,       z: 'i' });
                    // AUDIT: Fondo caj\u00f3n HDF  same width as frente int x (depth - 80mm slide stop); t:3 = 3mm HDF
                    pieces.push({ n: 'Fondo caj\u00f3n',      q: caj,    w: w - 2 * TK - 26,  h: d - 80,  t: 3,        z: 'i' });
                }

            } else if (moduleType === 'esquineroCiego') {
                // Cocina: blind corner module (esquinero ciego) or esquinero en L
                // w = total width of visible face, w2ec = depth into corner (second leg)
                var w2ec = dimensions.w2 !== undefined ? dimensions.w2 : w;
                // AUDIT: Costado visible  full depth x casco height (the exposed outer side)
                pieces.push({ n: 'Costado visible', q: 1, w: d,           h: h,              t: TK, z: 'i' });
                // AUDIT: Costado ciego  w2ec leg depth x casco height (the blind/corner side)
                pieces.push({ n: 'Costado ciego',   q: 1, w: w2ec,         h: h,              t: TK, z: 'i' });
                // AUDIT: Base  full module footprint (w - TK) x (w2ec - TK)  deduct one TK per leg for costado overlap
                pieces.push({ n: 'Base',             q: 1, w: w - TK,       h: w2ec - TK,      t: TK, z: 'i' });
                // AUDIT: Techo  same dimensions as base
                pieces.push({ n: 'Techo',            q: 1, w: w - TK,       h: w2ec - TK,      t: TK, z: 'i' });
                // AUDIT: Fondo HDF  inner width x casco height; t:3 = 3mm HDF per INSTRUCTIVO
                pieces.push({ n: 'Fondo',            q: 1, w: w - 2 * TK,   h: h,              t: 3,  z: 'i' });
                // AUDIT: Entrepa\u00f1o  same as base minus clearance (30mm extra inset per side)
                pieces.push({ n: 'Entrepa\u00f1o',   q: 1, w: w - TK - 30,  h: w2ec - TK - TK, t: TK, z: 'i' });

            } else if (moduleType === 'hornoBase') {
                // Cocina: oven base module  entrepa\u00f1o at 595mm for oven niche, caj\u00f3n inferior, ventilaci\u00f3n
                // AUDIT: Costados  full casco height x depth
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base  inner width x depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo  inner width x depth (closes the top of the module)
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Entrepa\u00f1o horno  at 595mm from top for oven niche (INSTRUCTIVO: 595-598mm nicho); same depth as casco
                pieces.push({ n: 'Entrepa\u00f1o horno (595mm)', q: 1, w: w - 2 * TK, h: d, t: TK, z: 'i' });
                // AUDIT: Fondo HDF  inner width x casco height; note: needs 100mm ventilaci\u00f3n clearance behind oven; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo (ventilaci\u00f3n 100mm)', q: 1, w: w - 2 * TK, h: h, t: 3, z: 'i' });
                // AUDIT: Caj\u00f3n inferior pieces  below the oven niche
                // Caj\u00f3n height = casco height - 595mm oven niche - TK entrepa\u00f1o - TK base - 10mm clearance
                var cajH = h - 595 - TK - TK - 10;
                if (cajH > 50) {
                    // AUDIT: Frente caj\u00f3n inferior  150mm standard height per INSTRUCTIVO; 4 chapa edges; zone='f'
                    pieces.push({ n: 'Frente caj\u00f3n inferior',   q: 1, w: w - 2 * TK - 4, h: 150, t: TK, c: 4, z: 'f' });
                    // AUDIT: Costado caj\u00f3n  (depth - 80mm Blum slide) x (150mm frente - 30mm slide height = 120mm)
                    pieces.push({ n: 'Costado caj\u00f3n',           q: 2, w: d - 80,          h: 120, t: TK,       z: 'i' });
                    // AUDIT: Frente int. caj\u00f3n  (inner width - 26mm for correderas x2) x 120mm
                    pieces.push({ n: 'Frente int. caj\u00f3n',       q: 1, w: w - 2 * TK - 26, h: 120, t: TK,       z: 'i' });
                    // AUDIT: Fondo caj\u00f3n HDF  same width as frente int x (depth - 80mm slide stop); t:3 = 3mm HDF
                    pieces.push({ n: 'Fondo caj\u00f3n',             q: 1, w: w - 2 * TK - 26, h: d - 80, t: 3,     z: 'i' });
                }

            } else if (moduleType === 'alacenaEstandar') {
                // Cocina: wall-mounted upper cabinet  1-2 puertas, 1-2 entrepa\u00f1os
                // No amarres: wall-mounted, not free-standing (fixed to wall via soporte_alacena)
                // AUDIT: Costados  full casco height x depth (h and d from caller, typically 700-900mm x 300-350mm)
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base  inner width (w - 2*TK) x depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo  inner width x depth (closes top of wall cabinet)
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Fondo HDF  inner width x casco height; t:3 = 3mm HDF per INSTRUCTIVO
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                // AUDIT: Entrepa\u00f1o  depth is d-TK to clear fondo; count from materials.shelves (default 1)
                var entEst = typeof materials.shelves === 'number' ? materials.shelves : 1;
                if (entEst > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: entEst, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'alacenaAventos') {
                // Cocina: wall cabinet with Blum Aventos elevating door (HK-S / HL / HS)
                // Same casco as alacenaEstandar; NO entrepa\u00f1o  single open cavity for aventos door sweep arc
                // Door piece generated in calc() door block (Plan 02); hardware in assignHardware()
                // AUDIT: Costados  full casco height x depth
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base  inner width x depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo  inner width x depth
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Fondo HDF  inner width x casco height; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                // No entrepa\u00f1o: aventos door requires unobstructed cavity for full lift sweep

            } else if (moduleType === 'alacenaSobreCampana') {
                // Same casco as alacenaEstandar but depth comes from caller (typically 200-300mm for campana/refri)
                // Caller passes reduced d value; piece formulas are identical to alacenaEstandar
                // AUDIT: Costados  full casco height x caller-supplied reduced depth
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base  inner width x reduced depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo  inner width x reduced depth
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Fondo HDF  inner width x casco height; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                // AUDIT: Entrepa\u00f1o  depth d-TK to clear fondo; default 1 (shorter cabinet)
                var entSC = typeof materials.shelves === 'number' ? materials.shelves : 1;
                if (entSC > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: entSC, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'torreHornos') {
                // Cocina: full-height tower with microondas niche + horno niche at 595mm + caj\u00f3n inferior
                // AUDIT: Costados  full tower height x depth (h typically 2200mm, d 580-600mm)
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base  inner width x depth (bottom of tower)
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo  inner width x depth (top of tower)
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Entrepa\u00f1o microondas  at microH mm from top (default 400mm); defines microwave niche ceiling
                var microH = materials.microHeight || 400;
                pieces.push({ n: 'Entrepa\u00f1o microondas', q: 1, w: w - 2 * TK, h: d, t: TK, z: 'i' });
                // AUDIT: Entrepa\u00f1o horno  595mm below microondas entrepa\u00f1o per INSTRUCTIVO spec (same as hornoBase)
                pieces.push({ n: 'Entrepa\u00f1o horno (595mm)', q: 1, w: w - 2 * TK, h: d, t: TK, z: 'i' });
                // AUDIT: Fondo HDF  inner width x full tower height; needs 100mm ventilaci\u00f3n clearance behind oven; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo (ventilaci\u00f3n 100mm)', q: 1, w: w - 2 * TK, h: h, t: 3, z: 'i' });
                // AUDIT: Caj\u00f3n inferior  below oven niche
                // cajH = total height - microH niche - 595mm oven - 3*TK (entrepa\u00f1os + base) - 10mm clearance
                var cajHTorre = h - microH - 595 - 3 * TK - 10;
                if (cajHTorre > 50) {
                    // AUDIT: Frente caj\u00f3n inferior  150mm standard height; 4 chapa edges; zone='f'
                    pieces.push({ n: 'Frente caj\u00f3n inferior',   q: 1, w: w - 2 * TK - 4,  h: 150,   t: TK, c: 4, z: 'f' });
                    // AUDIT: Costado caj\u00f3n  (depth - 80mm Blum slide) x 120mm
                    pieces.push({ n: 'Costado caj\u00f3n',           q: 2, w: d - 80,            h: 120,   t: TK,       z: 'i' });
                    // AUDIT: Frente int. caj\u00f3n  (inner width - 26mm correderas) x 120mm
                    pieces.push({ n: 'Frente int. caj\u00f3n',       q: 1, w: w - 2 * TK - 26,  h: 120,   t: TK,       z: 'i' });
                    // AUDIT: Fondo caj\u00f3n HDF  same width as frente int x (depth - 80mm slide stop); t:3 = 3mm HDF
                    pieces.push({ n: 'Fondo caj\u00f3n',             q: 1, w: w - 2 * TK - 26,  h: d - 80, t: 3,       z: 'i' });
                }

            } else if (moduleType === 'torreDespensa') {
                // Cocina: full-height pantry tower with adjustable shelves on 32mm system
                // AUDIT: Costados  full tower height x depth
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                // AUDIT: Base  inner width x depth
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Techo  inner width x depth
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                // AUDIT: Fondo HDF  inner width x full tower height; t:3 = 3mm HDF
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                // AUDIT: entrepa\u00f1os on 32mm system  adjustable via shelf pins, not fixed
                var entDesp = typeof materials.shelves === 'number' ? materials.shelves : 4;
                if (entDesp > 0) {
                    // AUDIT: Entrepa\u00f1o  depth d-TK to clear fondo; count from materials.shelves (default 4)
                    pieces.push({ n: 'Entrepa\u00f1o', q: entDesp, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            //  COCINAS: New modules per INSTRUCTIVO_TECNICO_COCINAS 

            } else if (moduleType === 'bajoCooktop') {
                // INSTRUCTIVO 3.6: same as bajoEstandar + note for cooktop cutout
                pieces.push({ n: 'Costado',      q: 2, w: d,           h: h,         t: TK, z: 'i' });
                pieces.push({ n: 'Base',          q: 1, w: w - 2 * TK,  h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',         q: 1, w: w - 2 * TK,  h: h,         t: 3,  z: 'i' });
                pieces.push({ n: 'Amarre sup.',   q: 1, w: w - 2 * TK,  h: 80,        t: TK, z: 'i' });
                pieces.push({ n: 'Amarre inf.',   q: 1, w: w - 2 * TK,  h: 80,        t: TK, z: 'i' });
                var entCT = typeof materials.shelves === 'number' ? materials.shelves : 1;
                if (entCT > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: entCT, w: w - 2 * TK - 30, h: d - TK, t: TK, z: 'i' });
                }
                // Note piece for cut list
                pieces.push({ n: 'Nota: recorte parrilla', q: 0, w: 0, h: 0, t: 0, z: 'i' });

            } else if (moduleType === 'alacenaCampana') {
                // INSTRUCTIVO 3.10: hood module with central void + 2 lateral cabinets
                var huecoW = materials.anchoCampana || 600;
                var lateralW = Math.floor((w - huecoW) / 2);
                var innerLat = lateralW - (2 * TK);
                pieces.push({ n: 'Costado exterior',  q: 2, w: d,            h: h,  t: TK, z: 'i' });
                pieces.push({ n: 'Panel divisor',     q: 2, w: d,            h: h,  t: TK, z: 'i' });
                pieces.push({ n: 'Piso lateral',      q: 2, w: innerLat,     h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Techo corrido',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo HDF',         q: 2, w: innerLat,     h: h,  t: 3,  z: 'i' });

            } else if (moduleType === 'alacenaEsquinera') {
                // INSTRUCTIVO 3.11: corner wall cabinet
                var Wx = dimensions.widthX || w;
                var Wy = dimensions.widthY || w;
                var mainW2 = Math.max(Wx, Wy);
                var innerWE = mainW2 - (2 * TK);
                pieces.push({ n: 'Costado',   q: 2, w: d,       h: h,     t: TK, z: 'i' });
                pieces.push({ n: 'Piso',      q: 1, w: innerWE, h: d,     t: TK, z: 'i' });
                pieces.push({ n: 'Techo',     q: 1, w: innerWE, h: d,     t: TK, z: 'i' });
                pieces.push({ n: 'Fondo HDF', q: 1, w: innerWE, h: h,     t: 3,  z: 'i' });

            } else if (moduleType === 'alacenaProfunda') {
                // INSTRUCTIVO 3.12: deep wall cabinet (over fridge)  same as alacenaEstandar with different defaults
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                var entAP = typeof materials.shelves === 'number' ? materials.shelves : 1;
                if (entAP > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: entAP, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'torreMicroondas') {
                // INSTRUCTIVO 3.15: tower with single microwave niche + shelves
                var hMicro2 = materials.microHeight || 450;
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Sep. sup microondas', q: 1, w: w - 2 * TK, h: d - 30, t: TK, z: 'i' });
                pieces.push({ n: 'Sep. inf microondas', q: 1, w: w - 2 * TK, h: d - 30, t: TK, z: 'i' });
                pieces.push({ n: 'Fondo (ventilaci\u00f3n)', q: 1, w: w - 2 * TK, h: h, t: 3, z: 'i' });
                var entTM = typeof materials.shelves === 'number' ? materials.shelves : 3;
                if (entTM > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: entTM, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'torreRefrigerador') {
                // INSTRUCTIVO 3.16: fridge frame  no frentes (fridge is visible)
                pieces.push({ n: 'Costado',       q: 2, w: d,           h: h,  t: TK, z: 'i' });
                pieces.push({ n: 'Techo remate',  q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo HDF',     q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });

            } else if (moduleType === 'torreLimpieza') {
                // INSTRUCTIVO 3.17: broom closet  same as torreDespensa but no shelves, 1 door
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });

            } else if (moduleType === 'zocloMod') {
                // INSTRUCTIVO 3.18: zoclo as separate module  ml  altoZoclo
                var mlZ = materials.metrosLineales || 1;
                var altoZ = materials.altoZoclo || 120;
                pieces.push({ n: 'Zoclo', q: 1, w: Math.round(mlZ * 1000), h: altoZ, t: TK, z: 'f' });

            } else if (moduleType === 'isla') {
                // INSTRUCTIVO 3.18: island  closed box (with techo), accessible both sides
                pieces.push({ n: 'Costado',      q: 2, w: d,           h: h,         t: TK, z: 'i' });
                pieces.push({ n: 'Base',          q: 1, w: w - 2 * TK,  h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Techo',         q: 1, w: w - 2 * TK,  h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',         q: 1, w: w - 2 * TK,  h: h,         t: 3,  z: 'i' });
                pieces.push({ n: 'Amarre sup.',   q: 2, w: w - 2 * TK,  h: 80,        t: TK, z: 'i' });
                var entIsla = typeof materials.shelves === 'number' ? materials.shelves : 1;
                if (entIsla > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: entIsla, w: w - 2 * TK - 30, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'gabineteRemate') {
                // INSTRUCTIVO 3.18: over-fridge cap  same as alacenaProfunda
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                pieces.push({ n: 'Base',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });

            } else if (moduleType === 'vistaLateral') {
                // AUDIT: Vista lateral  exposed side panel, profundidad x alto casco, frente material
                pieces.push({ n: 'Vista Lateral', q: 1, w: d, h: h, t: TK, z: 'f' });

            } else if (moduleType === 'panelRelleno') {
                // AUDIT: Panel relleno  gap strip between module and wall, ancho=gap width, alto=casco height
                pieces.push({ n: 'Panel Relleno', q: 1, w: w, h: h, t: TK, z: 'f' });

            } else if (moduleType === 'cubierta') {
                // AUDIT: Cubierta  priced per m2, not by sheet; w=length, h=depth (d param)
                // isCubierta: true signals calc() to use m2-based pricing instead of sheet area
                pieces.push({ n: 'Cubierta', q: 1, w: w, h: d, t: 0, z: 'f', isCubierta: true });

            } else if (moduleType === 'puerta') {
                // Interior door  bastidor sandwich (INSTRUCTIVO 7.1)
                // Anatomy: 2 tapas MDF (exterior faces) + bastidor pino frame + relleno
                // AUDIT: w = door leaf width (typically 800-1000mm), h = door leaf height (2000-2100mm)

                // Bastidor pino frame (the internal wood skeleton)
                // AUDIT: Larguero  2 vertical pine frame members, full height, 80mm wide
                pieces.push({ n: 'Larguero bastidor',   q: 2, w: 80,      h: h,       t: 30, z: 'i', isBastidor: true });
                // AUDIT: Travesano  2 horizontal pine frame members, inner width (w - 2*80 = w-160), 80mm tall
                pieces.push({ n: 'Travesano bastidor',  q: 2, w: w - 160, h: 80,      t: 30, z: 'i', isBastidor: true });

                // Tapas MDF (the visible sandwich faces)
                // AUDIT: Tapa  2 full-size MDF panels (3mm), full w x h; zone='f' (premium visible material)
                pieces.push({ n: 'Tapa MDF',            q: 2, w: w,       h: h,       t: 3,  c: 0, z: 'f' });

                // Marco chambrana (frame covering the wall gap)
                if (materials.marco !== false) {
                    // AUDIT: Jamba  2 vertical frame pieces covering vano gap, 70mm wide; zone='f'
                    pieces.push({ n: 'Jamba chambrana',  q: 2, w: 70,      h: h,       t: TK, z: 'f' });
                    // AUDIT: Cabezal chambrana  horizontal top frame; w + 140mm to overlap both jambas
                    pieces.push({ n: 'Cabezal chambrana', q: 1, w: w + 140, h: 70,     t: TK, z: 'f' });
                    // AUDIT: Tope  the thin stop strip where the door contacts when closing; 3 pieces (2 vertical + 1 horizontal)
                    pieces.push({ n: 'Tope',             q: 3, w: 20,      h: h,       t: 10, z: 'f' });
                    // Note: Tope q=3 covers 2 vertical + 1 horizontal (cabezal tope); height approximation uses h for all 3
                }
                // Note: bisagra_libro and chapa_puerta are handled in assignHardware()

            } else if (moduleType === 'bajoLavabo') {
                // Bano: bajo lavabo flotante (INSTRUCTIVO 4.2)
                // AUDIT: Standard bano bajo h=500-600mm, d=450-500mm  wall-mounted flotante
                var iW = w - 2 * TK; // inner width: w minus 2 side panels
                var cajCount = materials.cajones || 2;
                var cajH = cajCount === 1
                    ? Math.round(h - TK) // single cajon: full inner height minus top amarre
                    : Math.round((h - 2 * TK) / 2); // 2-cajn: split height with techo amarre
                // Casco pieces
                pieces.push({ n: 'Costado',         q: 2, w: d,        h: h,   t: TK, z: 'i' }); // AUDIT: h x d full height
                pieces.push({ n: 'Piso',             q: 1, w: iW,       h: d,   t: TK, z: 'i' }); // AUDIT: iW = w - 2*TK
                pieces.push({ n: 'Amarre sup',       q: 1, w: iW,       h: 80,  t: TK, z: 'i' }); // AUDIT: 80mm structural top amarre
                pieces.push({ n: 'Fondo HDF',        q: 1, w: iW,       h: h,   t: 3,  z: 'i' }); // AUDIT: 3mm HDF fondo trasero
                // Cajon superior WITH saque en U for cespol
                pieces.push({ n: 'Costado cajon',   q: 2, w: cajH,     h: d - 80, t: TK, z: 'i' }); // AUDIT: cajH x (d-80) Blum Tandem depth
                pieces.push({ n: 'Frente int caj 1', q: 1, w: iW - 26,  h: cajH,   t: TK, z: 'i', saqueU: true }); // AUDIT: -26mm = 13mm per side clip; saqueU=true: 220x180mm centered notch for cespol
                pieces.push({ n: 'Fondo cajon HDF', q: 1, w: iW - 26,  h: d - 80, t: 3,  z: 'i' }); // AUDIT: HDF 3mm cajon base
                if (cajCount >= 2) {
                    // Bottom cajon  same dimensions WITHOUT saqueU
                    pieces.push({ n: 'Costado cajon 2', q: 2, w: cajH,    h: d - 80, t: TK, z: 'i' }); // AUDIT: same as top cajon costados
                    pieces.push({ n: 'Frente int caj 2', q: 1, w: iW - 26, h: cajH,   t: TK, z: 'i' }); // AUDIT: no saqueU on bottom cajon
                    pieces.push({ n: 'Fondo caj 2 HDF', q: 1, w: iW - 26, h: d - 80, t: 3,  z: 'i' });
                }
                // Frente pieces (z:'f')  exterior cajon fronts
                pieces.push({ n: 'Frente cajon', q: cajCount, w: iW - 4, h: cajH - 5, t: TK, z: 'f' }); // AUDIT: -4mm total gap; -5mm height gap

            } else if (moduleType === 'cajoneraBano') {
                // Bano: cajonera auxiliar (INSTRUCTIVO 4.2)
                // AUDIT: Auxiliary bano bajo h=500-600mm, d=450-500mm  same logic as cocina cajonera but shorter
                var iW = w - 2 * TK; // inner width: w minus 2 side panels
                var cajCount = materials.cajones || 2;
                // AUDIT: cajH = (h - TK) / cajCount  minus one TK for top amarre only
                var cajH = Math.round((h - TK) / cajCount);
                // Casco pieces
                pieces.push({ n: 'Costado',         q: 2, w: d,        h: h,   t: TK, z: 'i' }); // AUDIT: h x d full height
                pieces.push({ n: 'Piso',             q: 1, w: iW,       h: d,   t: TK, z: 'i' }); // AUDIT: iW = w - 2*TK
                pieces.push({ n: 'Amarre sup',       q: 1, w: iW,       h: 80,  t: TK, z: 'i' }); // AUDIT: 80mm top amarre
                pieces.push({ n: 'Fondo HDF',        q: 1, w: iW,       h: h,   t: 3,  z: 'i' }); // AUDIT: 3mm HDF fondo trasero
                // Per-cajon pieces
                for (var ci = 0; ci < cajCount; ci++) {
                    pieces.push({ n: 'Costado cajon', q: 2, w: cajH,     h: d - 80,  t: TK, z: 'i' }); // AUDIT: cajH x (d-80mm) Blum Tandem clip depth
                    pieces.push({ n: 'Frente int caj', q: 1, w: iW - 26,  h: cajH,    t: TK, z: 'i' }); // AUDIT: -26mm = 13mm per side for Blum Tandem clip
                    pieces.push({ n: 'Fondo cajon HDF', q: 1, w: iW - 26, h: d - 80,  t: 3,  z: 'i' }); // AUDIT: HDF 3mm cajon base
                }
                // Frente pieces (z:'f')  exterior cajon fronts
                pieces.push({ n: 'Frente cajon', q: cajCount, w: iW - 4, h: cajH - 5, t: TK, z: 'f' }); // AUDIT: -4mm total gap; -5mm height gap

            } else if (moduleType === 'botiquin') {
                // Bano: botiquin/espejo wall-mount thin module (INSTRUCTIVO 4.2)
                // AUDIT: d=100-150mm (thin wall cabinet), h=600-900mm, w=400-800mm
                var iW = w - 2 * TK; // inner width: w minus 2 side panels
                var doorCnt = w <= 500 ? 1 : 2;
                // Casco pieces
                pieces.push({ n: 'Costado',      q: 2, w: d,        h: h,       t: TK, z: 'i' }); // AUDIT: h x d full height
                pieces.push({ n: 'Piso',          q: 1, w: iW,       h: d,       t: TK, z: 'i' }); // AUDIT: iW = w - 2*TK
                pieces.push({ n: 'Techo',         q: 1, w: iW,       h: d,       t: TK, z: 'i' }); // AUDIT: same as piso
                pieces.push({ n: 'Fondo HDF',     q: 1, w: iW,       h: h,       t: 3,  z: 'i' }); // AUDIT: 3mm HDF fondo trasero
                pieces.push({ n: 'Entrepano',     q: 1, w: iW - 30,  h: d - 15,  t: TK, z: 'i' }); // AUDIT: -30mm = 15mm per side pin clearance; -15mm depth clearance
                // Frente pieces (z:'f')  door(s)
                if (doorCnt === 1) {
                    pieces.push({ n: 'Puerta', q: 1, w: iW - 4,        h: h - 10, t: TK, z: 'f' }); // AUDIT: -4mm total gap; -10mm height gap
                } else {
                    pieces.push({ n: 'Puerta', q: 2, w: Math.round(iW / 2) - 2, h: h - 10, t: TK, z: 'f' }); // AUDIT: iW/2 - 2mm per door gap
                }

            } else if (moduleType === 'librero') {
                // AUDIT: Tablered Arauco Librero KIRA  fixed catalog despiece (INSTRUCTIVO S.9)
                // Overall: 1385mm wide (1000 izq + 385 der), 400mm deep, 1800mm tall
                pieces.push({ label: 'A', n: 'Piso/Techo zona izq',         q: 2, w: 1000, h: 385,  cubrecanto: '3 lados', t: TK, z: 'i' });
                pieces.push({ label: 'B', n: 'Lateral exterior',              q: 2, w: 1770, h: 385,  cubrecanto: '2 lados', t: TK, z: 'i' });
                pieces.push({ label: 'C', n: 'Fondo trasero',                 q: 1, w: 1770, h: 970,  cubrecanto: 'no',      t: TK, z: 'i' });
                pieces.push({ label: 'D', n: 'Puerta media',                  q: 2, w: 745,  h: 335,  cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                pieces.push({ label: 'E', n: 'Puerta baja',                   q: 2, w: 385,  h: 335,  cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                pieces.push({ label: 'F', n: 'Repisa larga horizontal',       q: 2, w: 970,  h: 370,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'G', n: 'Paral vertical interno',        q: 4, w: 699,  h: 370,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'H', n: 'Repisa corta zona der',         q: 2, w: 310,  h: 370,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'I', n: 'Repisa media zona der',         q: 1, w: 645,  h: 370,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                // Cubrecanto total: 59.2 ml PVC 0.45mm KIRA  priced per ml in calc()
                pieces.push({ n: 'Cubrecanto PVC KIRA', q: 1, w: 59200, h: 0, mlTotal: 59.2, isCubrecanto: true, t: 0, z: 'i' });

            } else if (moduleType === 'credenzaTV') {
                // AUDIT: Tablered Arauco Credenza TV NERO  fixed catalog despiece (INSTRUCTIVO S.8)
                // Overall: 1600mm long, 450mm deep, 440mm tall (540mm with patas)
                pieces.push({ label: 'A', n: 'Piso/Techo',                   q: 2, w: 1600, h: 450,  cubrecanto: '3 lados', t: TK, z: 'i' });
                pieces.push({ label: 'B', n: 'Fondo trasero',                 q: 1, w: 1570, h: 435,  cubrecanto: 'no',      t: TK, z: 'i' });
                pieces.push({ label: 'C', n: 'Costado exterior',              q: 2, w: 410,  h: 450,  cubrecanto: '2 lados', t: TK, z: 'i' });
                pieces.push({ label: 'D', n: 'Paral interno vertical',        q: 3, w: 410,  h: 435,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'E', n: 'Repisa horizontal interna',     q: 4, w: 380,  h: 435,  cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'F', n: 'Puerta central',                q: 2, w: 400,  h: 390,  cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                pieces.push({ label: 'G', n: 'Puerta lateral',                q: 2, w: 320,  h: 405,  cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                // Cubrecanto total: 49 ml PVC 0.45mm NERO  priced per ml in calc()
                pieces.push({ n: 'Cubrecanto PVC NERO', q: 1, w: 49000, h: 0, mlTotal: 49, isCubrecanto: true, t: 0, z: 'i' });

            } else if (moduleType === 'mesaCentro') {
                // AUDIT: Tablered Arauco Mesa de Centro  bicolor KIRA+NERO (INSTRUCTIVO S.10)
                // Overall: 1000mm long, 600mm wide, 400mm tall (450-500mm with patas)
                // BLOQUE 1 = KIRA (tapa abatible), BLOQUE 2 = NERO (nicho abierto)
                // BLOQUE 1  KIRA
                pieces.push({ label: 'A', n: 'Tapa abatible',      q: 1, w: 600, h: 645, bloque: 'KIRA', cubrecanto: '4 lados', t: TK, z: 'f', isPuerta: true });
                pieces.push({ label: 'B', n: 'Costado',             q: 2, w: 385, h: 650, bloque: 'KIRA', cubrecanto: '2 lados', t: TK, z: 'i' });
                pieces.push({ label: 'C', n: 'Frente',              q: 1, w: 360, h: 570, bloque: 'KIRA', cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'D', n: 'Fondo interno',       q: 1, w: 385, h: 570, bloque: 'KIRA', cubrecanto: 'no',      t: TK, z: 'i' });
                pieces.push({ label: 'E', n: 'Piso interno',        q: 1, w: 570, h: 635, bloque: 'KIRA', cubrecanto: '1 lado',  t: TK, z: 'i' });
                // BLOQUE 2  NERO
                pieces.push({ label: 'F', n: 'Piso',                q: 1, w: 570, h: 350, bloque: 'NERO', cubrecanto: '1 lado',  t: TK, z: 'i' });
                pieces.push({ label: 'G', n: 'Techo/Cubierta',      q: 1, w: 600, h: 350, bloque: 'NERO', cubrecanto: '3 lados', t: TK, z: 'i' });
                pieces.push({ label: 'H', n: 'Costado',             q: 2, w: 385, h: 350, bloque: 'NERO', cubrecanto: '2 lados', t: TK, z: 'i' });
                pieces.push({ label: 'I', n: 'Fondo interno',       q: 1, w: 370, h: 570, bloque: 'NERO', cubrecanto: 'no',      t: TK, z: 'i' });
                // Cubrecanto totals: 12 ml KIRA + 9 ml NERO = 21 ml total
                pieces.push({ n: 'Cubrecanto PVC KIRA', q: 1, w: 12000, h: 0, mlTotal: 12, isCubrecanto: true, t: 0, z: 'i' });
                pieces.push({ n: 'Cubrecanto PVC NERO', q: 1, w: 9000,  h: 0, mlTotal: 9,  isCubrecanto: true, t: 0, z: 'i' });

            // --- TV modules (Phase 07) ---
            } else if (moduleType === 'consolaPatas') {
                // TV: consola con patas  standard casco (bajo TV) con patas metalicas (INSTRUCTIVO S.5)
                // AUDIT: Costados x2  full h x d; inner width = w - 2*TK
                pieces.push({ n: 'Costado',       q: 2, w: d,             h: h,         t: TK, z: 'i' });
                // AUDIT: Piso x1  (w - 2*TK) x d
                pieces.push({ n: 'Piso',           q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Techo x1  (w - 2*TK) x d
                pieces.push({ n: 'Techo',          q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Fondo HDF x1  (w - 2*TK) x h; t:3 = 3mm HDF backing
                pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: h,         t: 3,  z: 'i' });
                // AUDIT: Amarre frontal x1  (w - 2*TK) x 80mm structural rigidity brace at front top
                pieces.push({ n: 'Amarre frontal', q: 1, w: w - 2 * TK,   h: 80,        t: TK, z: 'i' });
                // AUDIT: Entrepao x1  (w - 2*TK - 2*TK) x (d - TK); 15mm holgura each side for pin clearance
                pieces.push({ n: 'Entrepa\u00f1o', q: 1, w: w - 4 * TK,   h: d - TK,    t: TK, z: 'i' });
                // Puertas NOT generated here  handled by calc() door block

            } else if (moduleType === 'consolaFlotante') {
                // TV: consola flotante  identical casco to consolaPatas; mounting via soporte_flotante brackets (INSTRUCTIVO S.5)
                // AUDIT: Costados x2  full h x d
                pieces.push({ n: 'Costado',       q: 2, w: d,             h: h,         t: TK, z: 'i' });
                // AUDIT: Piso x1  (w - 2*TK) x d
                pieces.push({ n: 'Piso',           q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Techo x1  (w - 2*TK) x d
                pieces.push({ n: 'Techo',          q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Fondo HDF x1  (w - 2*TK) x h; t:3 = 3mm HDF backing
                pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: h,         t: 3,  z: 'i' });
                // AUDIT: Amarre frontal x1  (w - 2*TK) x 80mm structural rigidity brace at front top
                pieces.push({ n: 'Amarre frontal', q: 1, w: w - 2 * TK,   h: 80,        t: TK, z: 'i' });
                // AUDIT: Entrepao x1  (w - 2*TK - 2*TK) x (d - TK); 15mm holgura each side for pin clearance
                pieces.push({ n: 'Entrepa\u00f1o', q: 1, w: w - 4 * TK,   h: d - TK,    t: TK, z: 'i' });
                // Puertas NOT generated here  handled by calc() door block

            } else if (moduleType === 'torreLateralTV') {
                // TV: torre lateral vertical  nichos abiertos con puerta opcional (INSTRUCTIVO S.5)
                // AUDIT: Costados x2  full tower height h x depth d (vertical panels)
                pieces.push({ n: 'Costado',       q: 2, w: d,             h: h,         t: TK, z: 'i' });
                // AUDIT: Piso x1  (w - 2*TK) x d (base of tower)
                pieces.push({ n: 'Piso',           q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Techo x1  (w - 2*TK) x d (top of tower)
                pieces.push({ n: 'Techo',          q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                // AUDIT: Fondo HDF x1  (w - 2*TK) x h; t:3 = 3mm HDF backing panel
                pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: h,         t: 3,  z: 'i' });
                // AUDIT: Entrepaos x2  2 shelves dividing tower into 3 sections; (w - 2*TK) x (d - TK) per INSTRUCTIVO 5.1
                pieces.push({ n: 'Entrepa\u00f1o', q: 2, w: w - 2 * TK,   h: d - TK,    t: TK, z: 'i' });
                // Door for tower handled by calc() door block (optional  user toggles m.doors)

            } else if (moduleType === 'repisaFlotante') {
                // TV: repisa flotante  two variants per INSTRUCTIVO S.5 (Metodo 1=hueca, Metodo 2=herraje)
                var variant = materials.variant || 'hueca';
                if (variant === 'hueca') {
                    // AUDIT: Variant hueca  hollow box; tapa superior + inferior + costados + HDF fondo for wall-mount
                    // tapa_superior x1  w x d (top face, full width)
                    pieces.push({ n: 'Tapa superior',  q: 1, w: w,             h: d,         t: TK, z: 'i' });
                    // tapa_inferior x1  w x d (bottom face, full width)
                    pieces.push({ n: 'Tapa inferior',  q: 1, w: w,             h: d,         t: TK, z: 'i' });
                    // costado_caja x2  (h - 2*TK) x d; box sides, h=box height (38-40mm nominal)
                    pieces.push({ n: 'Costado caja',   q: 2, w: h - 2 * TK,   h: d,         t: TK, z: 'i' });
                    // fondo HDF x1  (w - 2*TK) x d; t:3 hides wall mount bracket inside box
                    pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: d,         t: 3,  z: 'i' });
                } else {
                    // AUDIT: Variant herraje  hidden espigon bracket; single solid shelf minimum 38mm thick
                    // AUDIT: min 38mm for herraje oculto insertion (espigon bracket enters from back into shelf)
                    pieces.push({ n: 'Tablero repisa', q: 1, w: w,             h: d,         t: Math.max(TK, 38), z: 'i' });
                }

            } else if (moduleType === 'panelFondo') {
                // TV: panel de fondo (lambrin) con bastidor oculto de madera (INSTRUCTIVO S.5)
                // AUDIT: Panel principal x1  full w x h; material frente (premium visible face)
                pieces.push({ n: 'Panel',                  q: 1, w: w,         h: h,         t: TK, z: 'f' });
                // AUDIT: Bastidor horizontal x2  (w - 100) x 50; pine frame top + bottom (50mm from each edge)
                pieces.push({ n: 'Bastidor horizontal',    q: 2, w: w - 100,   h: 50,        t: 0,  z: 'i', isBastidor: true });
                // AUDIT: Bastidor vertical x2  (h - 100) x 50; pine frame left + right sides (50mm from each edge)
                pieces.push({ n: 'Bastidor vertical',      q: 2, w: h - 100,   h: 50,        t: 0,  z: 'i', isBastidor: true });
                // AUDIT: Bastidor travesano x1  (w - 100) x 50; center cross-brace for rigidity
                pieces.push({ n: 'Bastidor travesano',     q: 1, w: w - 100,   h: 50,        t: 0,  z: 'i', isBastidor: true });

            } else if (moduleType === 'torre') {
                // Cocina: full-height simplified tower with shelves
                var sh = typeof materials.shelves === 'number' ? materials.shelves : 3;
                pieces.push({ n: 'Costado',  q: 2, w: d,           h: h,  t: TK, z: 'i' });
                pieces.push({ n: 'Techo',    q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Piso',     q: 1, w: w - 2 * TK,  h: d,  t: TK, z: 'i' });
                pieces.push({ n: 'Fondo',    q: 1, w: w - 2 * TK,  h: h,  t: 3,  z: 'i' });
                if (sh > 0) {
                    pieces.push({ n: 'Entrepa\u00f1o', q: sh, w: w - 2 * TK, h: d - TK, t: TK, z: 'i' });
                }

            } else if (moduleType === 'credenzaBase') {
                // Credenza con patas/zoclo  standard casco + optional cubierta
                pieces.push({ n: 'Costado',        q: 2, w: d,           h: h,         t: TK, z: 'i' });
                pieces.push({ n: 'Techo',           q: 1, w: w - 2 * TK, h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Piso',            q: 1, w: w - 2 * TK, h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Fondo HDF',       q: 1, w: w - 2 * TK, h: h,         t: 3,  z: 'i' });
                pieces.push({ n: 'Entrepa\u00f1o',  q: 1, w: w - 2 * TK - 30, h: d - TK, t: TK, z: 'i' });
                pieces.push({ n: 'Amarre frontal',  q: 1, w: w - 2 * TK, h: 80,        t: TK, z: 'i' });
                if (materials.cubiertaSuperior) {
                    pieces.push({ n: 'Cubierta/Top', q: 1, w: w, h: d, t: TK, c: 4, z: 'f' });
                }

            } else if (moduleType === 'credenzaFlotante') {
                // Credenza flotante muro  same casco as credenzaBase + soporte_flotante
                pieces.push({ n: 'Costado',        q: 2, w: d,           h: h,         t: TK, z: 'i' });
                pieces.push({ n: 'Techo',           q: 1, w: w - 2 * TK, h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Piso',            q: 1, w: w - 2 * TK, h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Fondo HDF',       q: 1, w: w - 2 * TK, h: h,         t: 3,  z: 'i' });
                pieces.push({ n: 'Entrepa\u00f1o',  q: 1, w: w - 2 * TK - 30, h: d - TK, t: TK, z: 'i' });
                pieces.push({ n: 'Amarre frontal',  q: 1, w: w - 2 * TK, h: 80,        t: TK, z: 'i' });
                if (materials.cubiertaSuperior) {
                    pieces.push({ n: 'Cubierta/Top', q: 1, w: w, h: d, t: TK, c: 4, z: 'f' });
                }

            } else if (moduleType === 'gabineteTV') {
                // TV: floating TV cabinet  same structure as consolaFlotante
                pieces.push({ n: 'Costado',       q: 2, w: d,             h: h,         t: TK, z: 'i' });
                pieces.push({ n: 'Piso',           q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Techo',          q: 1, w: w - 2 * TK,   h: d,         t: TK, z: 'i' });
                pieces.push({ n: 'Fondo HDF',      q: 1, w: w - 2 * TK,   h: h,         t: 3,  z: 'i' });
                pieces.push({ n: 'Amarre frontal', q: 1, w: w - 2 * TK,   h: 80,        t: TK, z: 'i' });
                pieces.push({ n: 'Entrepa\u00f1o', q: 1, w: w - 4 * TK,   h: d - TK,    t: TK, z: 'i' });
            }

            return pieces;
        }

        // === assignHardware: Generic hardware auto-assignment engine ===
        // Called by calc() to get hardware items for any module type.
        // moduleType: string matching MODS keys
        // dimensions: { w: mm, h: mm, d: mm }
        // options: { cajones, corrTier, doors, tipon, doorCount, doorMaterial, materialType, shelves, heightCm, marco }
        // Returns: array of { key: string (HW_DEFAULTS key), q: number }
        function assignHardware(moduleType, dimensions, options) {
            var hw = [];
            var opts = options || {};

            if (moduleType === 'modulo') {
                // Closet module with internal zones  iterate zones for hardware
                var zones = opts.zones || [];
                zones.forEach(function(z) {
                    var qty = z.qty || 1;
                    if (z.type === 'colgador') {
                        hw.push({ key: 'tubo', q: 1 });
                        hw.push({ key: 'soporte', q: 2 });
                    } else if (z.type === 'colgadorDoble') {
                        hw.push({ key: 'tubo', q: 2 });
                        hw.push({ key: 'soporte', q: 4 });
                    } else if (z.type === 'cajones') {
                        var corrKey = z.corrTier || 'corr_eco';
                        hw.push({ key: corrKey, q: qty });
                        if (!opts.doors) {
                            hw.push({ key: 'jaladera', q: qty });
                        }
                    } else if (z.type === 'zapatero') {
                        hw.push({ key: 'corr_eco', q: qty });
                    }
                    // colgador, entrepa, maletero: no additional hardware
                });

            } else if (moduleType === 'esquinero') {
                hw.push({ key: 'tubo',    q: 1 });
                hw.push({ key: 'soporte', q: 2 });

            } else if (moduleType === 'cajonBase') {
                // Cocina base cabinet with drawers
                var caj = typeof opts.cajones === 'number' ? opts.cajones : 0;
                if (caj > 0) {
                    // AUDIT: Cocina base drawers use premium soft-close concealed slides
                    hw.push({ key: 'corr_oculta', q: caj });
                }

            } else if (moduleType === 'puerta') {
                // Interior door  bisagra libro count driven by relleno type (INSTRUCTIVO 7.4)
                // AUDIT: honeycomb/peinazos (lighter) = 3 bisagras; solida (heavy) = 4 bisagras
                var relleno = opts.relleno || 'honeycomb';
                var hinges = relleno === 'solida' ? 4 : 3;
                hw.push({ key: 'bisagra_libro', q: hinges });
                // AUDIT: 1 chapa (lock + handle set) per door
                hw.push({ key: 'chapa_puerta', q: 1 });

            } else if (moduleType === 'bajoEstandar') {
                // Cocina: standard base cabinet  patas + zoclo only (door hardware in calc())
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'fregadero') {
                // Cocina: sink module  patas + zoclo only (always 2 puertas, bisagras in calc())
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'cajonera') {
                // Cocina: drawer module  Blum Tandem correderas + patas + zoclo
                var caj = typeof opts.cajones === 'number' ? opts.cajones : 3;
                if (caj > 0) {
                    // AUDIT: 1 pair Blum Tandem soft-close per cajn per INSTRUCTIVO 3.3
                    hw.push({ key: 'corr_tandem', q: caj });
                    // AUDIT: 1 jaladera per cajn (drawer pulls)
                    hw.push({ key: 'jaladera', q: caj });
                }
                // patas + clips
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'esquineroCiego') {
                // Cocina: blind corner or L-corner  patas + zoclo (door bisagras in calc())
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'hornoBase') {
                // Cocina: oven base  1 pair Tandem for cajn inferior + patas + zoclo
                hw.push({ key: 'corr_tandem', q: 1 });
                hw.push({ key: 'jaladera', q: 1 });
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'alacenaEstandar') {
                // Cocina: standard wall cabinet  wall-mount brackets only (door bisagras in calc())
                // AUDIT: 2 soporte colgante brackets for wall mounting per INSTRUCTIVO
                hw.push({ key: 'soporte_alacena', q: 2 });

            } else if (moduleType === 'alacenaAventos') {
                // Cocina: aventos wall cabinet  specific aventos model + wall-mount brackets
                // AUDIT: 1 Aventos mechanism set (opts.aventosModel selects HK/HL/HS), default HK-S
                var aventosKey = 'aventos_' + (opts.aventosModel || 'hk');
                hw.push({ key: aventosKey, q: 1 });
                // AUDIT: 2 soporte colgante brackets for wall mounting
                hw.push({ key: 'soporte_alacena', q: 2 });

            } else if (moduleType === 'alacenaSobreCampana') {
                // Cocina: over-hood/fridge wall cabinet  wall-mount brackets only (same as standard alacena)
                // AUDIT: 2 soporte colgante brackets for wall mounting
                hw.push({ key: 'soporte_alacena', q: 2 });

            } else if (moduleType === 'torreHornos') {
                // Cocina: tower  Tandem + patas + zoclo
                hw.push({ key: 'corr_tandem', q: 1 });
                hw.push({ key: 'jaladera', q: 1 });
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'torreDespensa') {
                // Cocina: tall pantry tower  patas + zoclo (door bisagras in calc())
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            //  COCINAS: New hardware assignments per INSTRUCTIVO 4 

            } else if (moduleType === 'bajoCooktop') {
                // Same as bajoEstandar  patas + zoclo
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'alacenaCampana') {
                // INSTRUCTIVO 4.7: 2 lateral doors + 4 wall brackets (wider module)
                hw.push({ key: 'soporte_alacena', q: 4 });

            } else if (moduleType === 'alacenaEsquinera') {
                // INSTRUCTIVO 4.7: 1 door with 45 hinge + 2 wall brackets
                hw.push({ key: 'soporte_alacena', q: 2 });

            } else if (moduleType === 'alacenaProfunda') {
                // INSTRUCTIVO 4.7: heavier module, 4 wall brackets
                hw.push({ key: 'soporte_alacena', q: 4 });

            } else if (moduleType === 'torreMicroondas') {
                // Floor tower with microwave niche  patas + zoclo
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'torreRefrigerador') {
                // Frame only  patas + zoclo, no doors
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'torreLimpieza') {
                // Same as torreDespensa  patas + zoclo, doors in calc()
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'isla') {
                // Island  patas (dynamic) + zoclo clips
                hw.push({ key: 'pata', q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'gabineteRemate') {
                // Over-fridge cap  wall brackets
                hw.push({ key: 'soporte_alacena', q: 4 });

            } else if (moduleType === 'zocloMod' || moduleType === 'vistaLateral' || moduleType === 'panelRelleno' || moduleType === 'cubierta') {
                // Cocina extras: finishing pieces  no hardware required

            } else if (moduleType === 'bajoLavabo') {
                // Bano: bajo lavabo flotante  Blum Tandem per cajon + wall-mount brackets
                // AUDIT: no patas/zoclo_clip  flotante wall-mounted (INSTRUCTIVO 4.3)
                var cajCount = opts.cajones || 2;
                for (var ci = 0; ci < cajCount; ci++) {
                    hw.push({ key: 'corr_tandem', q: 1 });
                }
                hw.push({ key: 'soporte_bano', q: 2 });

            } else if (moduleType === 'cajoneraBano') {
                // Bano: cajonera auxiliar  Blum Tandem per cajon + wall-mount brackets (flotante)
                // AUDIT: no patas/zoclo_clip  flotante wall-mounted (INSTRUCTIVO 4.3)
                var cajCount = opts.cajones || 2;
                for (var ci = 0; ci < cajCount; ci++) {
                    hw.push({ key: 'corr_tandem', q: 1 });
                }
                hw.push({ key: 'soporte_bano', q: 2 });

            } else if (moduleType === 'botiquin') {
                // Bano: botiquin/espejo  wall-mount brackets only, bisagras handled in calc() door block
                // AUDIT: no patas/zoclo_clip  flotante wall-mounted (INSTRUCTIVO 4.3)
                hw.push({ key: 'soporte_bano', q: 2 });

            } else if (moduleType === 'librero') {
                // AUDIT: Tablered Librero KIRA  8 bisagras (4 puertas x 2), 6 regatones (INSTRUCTIVO S.9)
                // Bisagras are fixed here (puertas already in calculateParts with isPuerta, not in calc door block)
                hw.push({ key: 'bisagra', q: 8 });
                hw.push({ key: 'regaton', q: 6 });

            } else if (moduleType === 'credenzaTV') {
                // AUDIT: Tablered Credenza TV NERO  8 bisagras (4 puertas x 2), 4 patas metalicas 10cm (INSTRUCTIVO S.8)
                hw.push({ key: 'bisagra', q: 8 });
                hw.push({ key: 'pata_metalica', q: 4 });

            } else if (moduleType === 'mesaCentro') {
                // AUDIT: Tablered Mesa Centro  2 bisagras (tapa abatible), 1 piston 150N, 4 patas 5cm (INSTRUCTIVO S.10)
                hw.push({ key: 'bisagra', q: 2 });
                hw.push({ key: 'piston_150n', q: 1 });
                hw.push({ key: 'pata_niveladora', q: 4 });

            // --- TV modules (Phase 07) ---
            } else if (moduleType === 'consolaPatas') {
                // AUDIT: Consola con patas  4 patas regulables + 4 zoclo clips (floor-standing TV console)
                // Bisagras handled by calc() door block  NOT assigned here
                hw.push({ key: 'pata',       q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'consolaFlotante') {
                // AUDIT: Consola flotante  2 soportes muro (parallel to soporte_bano pattern for bano flotante)
                // Bisagras handled by calc() door block  NOT assigned here
                hw.push({ key: 'soporte_flotante', q: 2 });

            } else if (moduleType === 'torreLateralTV') {
                // AUDIT: Torre lateral TV  4 patas regulables (floor-standing tower, same pattern as cocina torres)
                // Bisagras for door option handled by calc() door block  NOT assigned here
                hw.push({ key: 'pata', q: 4 });

            } else if (moduleType === 'repisaFlotante') {
                // AUDIT: Repisa flotante  hardware depends on variant (hueca or herraje)
                // No bisagras, no jaladeras  open shelf (no doors)
                var variant = opts.variant || 'hueca';
                if (variant === 'hueca') {
                    // AUDIT: Hueca variant  2 soportes_flotante hidden inside box as internal wall brackets
                    hw.push({ key: 'soporte_flotante', q: 2 });
                } else {
                    // AUDIT: Herraje variant  1 pair of hidden espigon brackets (herraje_repisa counted per pair)
                    hw.push({ key: 'herraje_repisa', q: 1 });
                }

            } else if (moduleType === 'panelFondo') {
                // AUDIT: Panel fondo (lambrin)  no standard hardware; bastidor priced via isBastidor pieces in calculateParts
                // Panel attaches to bastidor with tornillos (absorbed in carpentry cost, not tracked separately)
                // Push nothing  empty hardware array for this module type

            // --- Iteration 11: new module types ---
            } else if (moduleType === 'alacenaAlta') {
                // Cocina: upper wall cabinet  wall-mount brackets (same pattern as alacenaEstandar)
                hw.push({ key: 'soporte_alacena', q: 2 });

            } else if (moduleType === 'gabineteBase') {
                // Cocina: base cabinet  patas + zoclo clips
                hw.push({ key: 'pata',       q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'torre') {
                // Cocina: simplified full-height tower  patas + zoclo clips
                hw.push({ key: 'pata',       q: kitchenPatas(dimensions.w) });
                hw.push({ key: 'zoclo_clip', q: kitchenClipsZoclo(dimensions.w) });

            } else if (moduleType === 'credenzaBase') {
                // Credenza con patas  patas + zoclo clips
                hw.push({ key: 'pata', q: 4 });
                hw.push({ key: 'zoclo_clip', q: 4 });

            } else if (moduleType === 'credenzaFlotante') {
                // Credenza flotante  wall-mount brackets
                hw.push({ key: 'soporte_flotante', q: 2 });

            } else if (moduleType === 'gabineteTV') {
                // TV: floating TV cabinet  wall-mount brackets (same as consolaFlotante)
                hw.push({ key: 'soporte_flotante', q: 2 });

            }
            // All other module types (entrepa, torreLateral, panelTV, moduloCentral, lateralAbierto,
            // despensa, espacioCampana, esquineroGiratorio):
            // AUDIT: These types get hardware only through doors (handled separately in calc) or manual assignment

            return hw;
        }

        // === CALC: Cost-based pricing engine ===
        // Migrate old standalone closet module types to modulo+zones
        function migrateModules(modules) {
            if (!modules) return;
            var typeMap = {
                colgador:     { preset: 'colgadorLargo', zones: [{ type: 'colgador', qty: 1 }] },
                colgadorCorto: { preset: 'colgadorDoble', zones: [{ type: 'colgadorDoble', qty: 1 }] },
                zapatero:     { preset: 'zapatero', zones: [{ type: 'zapatero', qty: 6 }] },
                entrepa:      { preset: 'torreEntrepanos', zones: [{ type: 'entrepa', qty: 5 }] },
                maletero:     { preset: 'maleteroColg', zones: [{ type: 'colgador', qty: 1 }], enableMaletero: true }
            };
            for (var i = 0; i < modules.length; i++) {
                var m = modules[i];
                var mapping = typeMap[m.type];
                if (mapping) {
                    m.type = 'modulo';
                    m.zones = mapping.zones.map(function(z) {
                        return { id: uid(), type: z.type, qty: z.qty, heightOverride: 0, corrTier: m.corrTier || 'corr_eco' };
                    });
                    // Carry over shelves count for entrepa
                    if (mapping.preset === 'torreEntrepanos' && typeof m.shelves === 'number') {
                        m.zones[0].qty = m.shelves;
                    }
                    // Enable module-level maletero for maletero migration
                    if (mapping.enableMaletero) {
                        m.maletero = { enabled: true, height: m.maletero && m.maletero.height ? m.maletero.height : 30 };
                    }
                }
            }
        }

        function calc() {
            var P = S.project,
                pieces = [],
                autoHW = [];
            var useDual = isDualType(P.type) && !P.sameMaterial;

            // Migrate old standalone closet types on first calc
            migrateModules(P.modules);

            // Generate pieces from modules
            var TK = P.thickness;
            P.modules.forEach(function(m) {
                var w = m.width * 10,
                    d = (P.sameDepth && m.type !== 'especial' ? (P.defaultDepth || 50) : (m.depth || P.defaultDepth || 50)) * 10,
                    h = (m.height || P.defaultHeight || 200) * 10;
                var qm = m.quoteMode || 'completo';
                // Auto-distribute zone heights before calculation
                if (m.type === 'modulo' && m.zones) {
                    autoDistributeZones(m.zones, (m.height || P.defaultHeight || 200));
                }
                if (qm !== 'solo_puertas') {
                    // Delegate piece generation to calculateParts()
                    var cPieces = calculateParts(m.type, {
                        w: w,
                        h: h,
                        d: d,
                        w2: m.width2 ? m.width2 * 10 : undefined
                    }, {
                        thickness: TK,
                        cajones: typeof m.cajones === 'number' ? m.cajones : undefined,
                        shelves: m.shelves,
                        zones: m.zones || undefined,
                        quoteMode: qm,
                        corrTier: m.corrTier,
                        marco: m.marco,
                        materialType: m.materialType,
                        doors: m.doors,
                        variant: m.variant,  // TV: repisaFlotante variant ('hueca' or 'herraje')
                        cubiertaSuperior: m.cubiertaSuperior || false
                    });
                    // Stamp module context onto each piece and push into the pieces array
                    cPieces.forEach(function(p) {
                        p.mid = m.id;
                        p.mn  = m.name;
                        p.mw  = m.width;
                        // Stamp cubiertaType for m2 pricing in area calculation
                        if (p.isCubierta) p.cubiertaType = m.cubiertaType || 'postformado';
                        pieces.push(p);
                    });
                    // Delegate hardware assignment to assignHardware()
                    var modHW = assignHardware(m.type, { w: w, h: h, d: d }, {
                        cajones: typeof m.cajones === 'number' ? m.cajones : undefined,
                        corrTier: m.corrTier,
                        doors: m.doors,
                        tipon: m.tipon,
                        shelves: m.shelves,
                        zones: m.zones || undefined,
                        heightCm: m.height || P.defaultHeight || 200,
                        materialType: m.materialType,
                        marco: m.marco,
                        aventosModel: m.aventosModel,
                        variant: m.variant,  // TV: repisaFlotante variant ('hueca' or 'herraje')
                        relleno: m.relleno || 'honeycomb'  // Puerta: relleno type drives bisagra count
                    });
                    modHW.forEach(function(hw) {
                        autoHW.push({ key: hw.key, q: hw.q, modId: m.id });
                    });
                    // Zoclo pieces for modules with zoclo toggle enabled (front + back strips)
                    if (m.zoclo && m.zoclo.enabled) {
                        var zocloH = (m.zoclo.height || 15) * 10; // cm to mm
                        pieces.push({ n: 'Zoclo frontal', q: 1, w: w - 2 * TK, h: zocloH, t: TK, c: 1, z: 'f', mid: m.id, mn: m.name, mw: m.width });
                        pieces.push({ n: 'Zoclo trasero', q: 1, w: w - 2 * TK, h: zocloH, t: TK, z: 'i', mid: m.id, mn: m.name, mw: m.width });
                    }
                    // Maletero pieces  independent box above the module
                    if (m.maletero && m.maletero.enabled) {
                        var malH = (m.maletero.height || 40) * 10; // cm to mm
                        pieces.push({ n: 'Mal. lateral',   q: 2, w: d,            h: malH,           t: TK, z: 'i', mid: m.id, mn: m.name, mw: m.width });
                        pieces.push({ n: 'Mal. techo',     q: 1, w: w - 2 * TK,   h: d,              t: TK, z: 'i', mid: m.id, mn: m.name, mw: m.width });
                        pieces.push({ n: 'Mal. piso',      q: 1, w: w - 2 * TK,   h: d,              t: TK, z: 'i', mid: m.id, mn: m.name, mw: m.width });
                        pieces.push({ n: 'Mal. fondo',     q: 1, w: w - 2 * TK,   h: malH - 2 * TK,  t: 3,  z: 'i', mid: m.id, mn: m.name, mw: m.width });
                    }
                } // end qm!=='solo_puertas'
                // Bridge m.puertas to legacy booleans before door block
                if (m.puertas && m.puertas.enabled) {
                    m.doors = true;
                    m.tipon = m.puertas.apertura === 'tipon';
                }
                // Door pieces
                if (m.doors || qm === 'solo_puertas') {
                    // Skip door generation for module types that have no doors (drawers/oven use their own frentes)
                    if (m.type === 'cajonera' || m.type === 'hornoBase' || m.type === 'torreHornos' || m.type === 'vistaLateral' || m.type === 'panelRelleno' || m.type === 'cubierta' || m.type === 'bajoLavabo' || m.type === 'cajoneraBano' || m.type === 'librero' || m.type === 'credenzaTV' || m.type === 'mesaCentro' || m.type === 'repisaFlotante' || m.type === 'panelFondo' || m.type === 'puerta' || m.type === 'panelTV' || (m.type === 'torreLateralTV' && m.noPuertas) || m.type === 'torreRefrigerador' || m.type === 'zocloMod') {
                        // cajonera: frentes are in calculateParts(); hornoBase: oven has its own door
                        // torreHornos: oven has its own door, cajn frente in calculateParts()
                        // vistaLateral/panelRelleno/cubierta: extras have no puertas
                        // librero/credenzaTV/mesaCentro: puertas already in calculateParts (isPuerta flag); bisagras in assignHardware()
                        // repisaFlotante: open shelf  no doors; panelFondo: flat panel  no doors
                        // puerta: tapas MDF ARE the door faces  no separate frente pieces needed; hardware in assignHardware()
                        // torreLateralTV with noPuertas: open nicho configuration  no doors
                        // Do nothing  skip door generation
                    } else {
                    var doorCnt;
                    if (m.puertas && m.puertas.enabled && m.puertas.cantidad) {
                        // Use explicit puertas.cantidad from new controls
                        doorCnt = m.puertas.cantidad;
                    } else if (m.type === 'fregadero') {
                        // AUDIT: Fregadero always has 2 puertas per INSTRUCTIVO_TECNICO
                        doorCnt = 2;
                    } else if (m.type === 'bajoEstandar') {
                        // AUDIT: 1 puerta for <=500mm width, 2 puertas for >500mm per INSTRUCTIVO_TECNICO 3.3
                        // m.width is in cm, so threshold is 50 (= 500mm)
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'esquineroCiego') {
                        // AUDIT: Ciego = 1 puerta, en L = 2 puertas with 165 bisagras
                        doorCnt = (m.esquineroTipo === 'enL') ? 2 : 1;
                    } else if (m.type === 'esquinero') {
                        doorCnt = 2;
                    } else if (m.type === 'alacenaAventos') {
                        // AUDIT: Aventos has 1 single elevating door (full width)
                        doorCnt = 1;
                    } else if (m.type === 'alacenaEstandar' || m.type === 'alacenaSobreCampana') {
                        // AUDIT: 1 puerta for <=500mm width, 2 puertas for >500mm (same threshold as bajoEstandar)
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'torreDespensa') {
                        // AUDIT: 2 puertas always  1 superior + 1 inferior per INSTRUCTIVO torre despensa
                        doorCnt = 2;
                    } else if (m.type === 'botiquin') {
                        // AUDIT: botiquin 1 puerta if <=500mm, 2 puertas if >500mm (same as bajoEstandar/alacenaEstandar pattern)
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'consolaPatas' || m.type === 'consolaFlotante') {
                        // AUDIT: TV consola  1 puerta if <=500mm (50cm), 2 puertas if >500mm per INSTRUCTIVO S.5
                        // m.width is in cm, threshold 50 = 500mm
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'torreLateralTV') {
                        // AUDIT: Torre lateral TV  always 1 puerta (narrow 300-500mm tower, single door)
                        // noPuertas case already handled in skip guard above
                        doorCnt = 1;
                    } else if (m.type === 'bajoCooktop' || m.type === 'alacenaProfunda' || m.type === 'gabineteRemate') {
                        // INSTRUCTIVO: same door logic as bajoEstandar/alacenaEstandar
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'alacenaCampana') {
                        // INSTRUCTIVO 3.10: 2 lateral doors always
                        doorCnt = 2;
                    } else if (m.type === 'alacenaEsquinera') {
                        // INSTRUCTIVO 3.11: 1 door with special 45 hinge
                        doorCnt = 1;
                    } else if (m.type === 'torreMicroondas' || m.type === 'torreLimpieza') {
                        // Microondas/Limpieza: 1 door for narrow towers
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'isla') {
                        // Island: front face doors
                        doorCnt = m.width <= 50 ? 1 : Math.ceil(m.width / 50);
                    } else if (m.type === 'gabineteBase' || m.type === 'alacenaAlta') {
                        // Iteration 11: simplified cocina modules  1 door <=50cm, 2 doors >50cm
                        doorCnt = m.width <= 50 ? 1 : 2;
                    } else if (m.type === 'torre') {
                        // Iteration 11: torre  2 doors (upper + lower, like torreDespensa)
                        doorCnt = 2;
                    } else if (m.type === 'credenzaBase' || m.type === 'credenzaFlotante' || m.type === 'gabineteTV') {
                        // Iteration 11: wide landscape modules  door count scales with width
                        doorCnt = Math.ceil(m.width / 50);
                    } else {
                        doorCnt = Math.ceil(m.width / 50);
                    }
                    var innerW = w - 2 * TK;
                    var doorW, doorH;
                    if (m.type === 'alacenaCampana') {
                        // INSTRUCTIVO 3.10: lateral doors  width = lateral cabinet inner width
                        var huecoWD = m.anchoCampana ? m.anchoCampana * 10 : 600;
                        var lateralWD = Math.floor((w - huecoWD) / 2);
                        doorW = lateralWD - 2 * TK - 4;
                        doorH = h - 10;
                    } else if (m.type === 'consolaPatas' || m.type === 'consolaFlotante') {
                        // AUDIT: TV consola door dims  doorH = h - 10 (10mm juego total); doorW per door
                        doorH = h - 10;
                        doorW = doorCnt === 1 ? (innerW - 4) : (Math.round(innerW / 2) - 2);
                    } else if (m.type === 'torreLateralTV') {
                        // AUDIT: Torre lateral TV door dims  doorH = h - 10; doorW = innerW - 4 (single door)
                        doorH = h - 10;
                        doorW = innerW - 4;
                    } else {
                        doorW = doorCnt === 1 ? (innerW - 4) : (Math.round(innerW / doorCnt) - 2);
                        doorH = h - 10;
                    }
                    // For tower types, doorH is half the tower (2 stacked doors) per INSTRUCTIVO
                    if (m.type === 'torreDespensa' || m.type === 'torre' || m.type === 'torreLimpieza') {
                        doorH = Math.round(h / 2) - 3;
                    }
                    // Resolve door material from puertas object or legacy doorMaterial
                    var _doorMat = (m.puertas && m.puertas.enabled) ? m.puertas.material : (m.doorMaterial || 'melamina');
                    if (_doorMat !== 'vidrio')
                        pieces.push({
                            mid: m.id,
                            mn: m.name,
                            mw: m.width,
                            n: 'Puerta',
                            q: doorCnt,
                            w: doorW,
                            h: doorH,
                            t: TK,
                            c: 4,
                            z: 'f'
                        });
                    var doorMatType = _doorMat;
                    if (m.type !== 'alacenaAventos') {
                        // Standard bisagra + base_clip push (aventos hardware is already in assignHardware  no bisagras needed)
                        // Use kitchenBisagrasPerDoor (mm-based, per INSTRUCTIVO): 1000mm2, 2000mm3, >2000mm4
                        var bisPerDoor = kitchenBisagrasPerDoor(doorH, doorMatType);
                        // AUDIT: esquineroCiego en L uses 165-degree bisagras; all other types use standard bisagra
                        var bisKey = (m.type === 'esquineroCiego' && m.esquineroTipo === 'enL') ? 'bisagra_165' : 'bisagra';
                        autoHW.push({
                            key: bisKey,
                            q: doorCnt * bisPerDoor,
                            modId: m.id
                        });
                        autoHW.push({
                            key: 'base_clip',
                            q: doorCnt * bisPerDoor,
                            modId: m.id
                        });
                    }
                    // Aventos doors have integrated handles  skip jaladera/tipon for alacenaAventos
                    if (m.type !== 'alacenaAventos') {
                        // Resolve apertura from puertas object or legacy tipon boolean
                        var _apertura = (m.puertas && m.puertas.enabled) ? m.puertas.apertura : (m.tipon ? 'tipon' : 'jaladera');
                        if (_apertura === 'tipon') {
                            autoHW.push({ key: 'tipon',       q: doorCnt, modId: m.id });
                            autoHW.push({ key: 'placa_tipon', q: doorCnt, modId: m.id });
                        } else if (_apertura === 'perfil_gola') {
                            autoHW.push({ key: 'perfil_gola', q: doorCnt, modId: m.id });
                        } else {
                            autoHW.push({ key: 'jaladera',    q: doorCnt, modId: m.id });
                        }
                    }
                    } // end else (not cajonera/hornoBase/torreHornos)
                }
            });

            // Calculate areas by zone  all pieces use project thickness
            // cubierta pieces (isCubierta: true) are excluded from sheet area and priced per m2 separately
            // cubrecanto pieces (isCubrecanto: true) are excluded from sheet area and priced per ml separately
            // bastidor pieces (isBastidor: true) are excluded from sheet area and priced per ml separately (TV panelFondo)
            var areaF = 0, areaI = 0, cantoF = 0, cantoI = 0;
            var cubiertaCost = 0, cubiertaM2 = 0;
            var cubrecantoCost = 0;
            var bastidorCost = 0;
            pieces.forEach(function(p) {
                if (p.isCubierta) {
                    // AUDIT: Cubierta priced per m2 from CONFIG.cubiertaPrices; apply mermaFactor
                    var cubArea = (p.w / 1000) * (p.h / 1000) * p.q;
                    cubiertaM2 += cubArea;
                    var cubType = (p.cubiertaType || 'postformado');
                    var cubPriceM2 = CONFIG.pricing.cubiertaPrices[cubType] || CONFIG.pricing.cubiertaPrices.postformado;
                    cubiertaCost += cubArea * CONFIG.pricing.mermaFactor * cubPriceM2;
                    return; // skip sheet area accumulation for cubierta
                }
                if (p.isCubrecanto) {
                    // AUDIT: Cubrecanto PVC 0.45mm  Tablered Arauco products use fixed ml totals from INSTRUCTIVO
                    // Priced per linear meter (not sheet area); cost rate from HW_DEFAULTS.cubrecanto_ml
                    var mlRate = HW_DEFAULTS.cubrecanto_ml ? HW_DEFAULTS.cubrecanto_ml.fallback : 15;
                    cubrecantoCost += (p.mlTotal || 0) * mlRate;
                    return; // skip sheet area accumulation for cubrecanto
                }
                if (p.isBastidor) {
                    // AUDIT: Bastidor pino 1x2  panelFondo TV; priced per linear meter via HW_DEFAULTS.bastidor_ml
                    // Piece w = length in mm; q = quantity; total ml = (w * q) / 1000
                    var bastRate = HW_DEFAULTS.bastidor_ml ? HW_DEFAULTS.bastidor_ml.fallback : 25;
                    bastidorCost += (p.w * p.q / 1000) * bastRate;
                    return; // skip sheet area accumulation for bastidor
                }
                var a = (p.w / 1000) * (p.h / 1000) * p.q;
                if (useDual && p.z === 'i') areaI += a;
                else areaF += a;
                var ml = 0;
                if (p.c) {
                    if (p.c === 4)
                        ml = ((p.w + p.h) * 2 / 1000) * p.q;
                    else if (p.c === 2)
                        ml = ((p.w + p.h) / 1000) * p.q;
                    else
                        ml = (Math.max(p.w, p.h) / 1000) * p.q;
                } else {
                    ml = (Math.max(p.w, p.h) / 1000) * p.q;
                }
                if (useDual && p.z === 'i')
                    cantoI += ml;
                else
                    cantoF += ml;
            });

            // Enchapado perimtrico  add extra edgebanding for exposed exterior faces
            P.modules.forEach(function(m) {
                if (!m.enchapado) return;
                var hMm = (m.height || P.defaultHeight || 200) * 10;
                var wMm = m.width * 10;
                var dMm = (P.sameDepth && m.type !== 'especial' ? (P.defaultDepth || 50) : (m.depth || P.defaultDepth || 50)) * 10;
                var extra = 0;
                // Lateral faces: exposed edge = height (vertical edge of the lateral panel)
                if (m.enchapado.latIzq) extra += hMm;
                if (m.enchapado.latDer) extra += hMm;
                // Techo/Piso faces: exposed edge = width (front edge of horizontal panel)
                if (m.enchapado.techo) extra += wMm;
                if (m.enchapado.piso) extra += wMm;
                if (extra > 0) cantoF += (extra / 1000); // mm to m
            });

            var SHEET = 1.22 * 2.44;
            var merma = CONFIG.pricing.mermaFactor;
            var totalSheetsF = Math.ceil(areaF * merma / SHEET);
            var totalSheetsI = Math.ceil(areaI * merma / SHEET);
            // sheetsF/sheetsI keyed by actual thickness for UI display
            var sheetsF = { 16: 0, 25: 0 }; sheetsF[TK] = totalSheetsF;
            var sheetsI = { 16: 0, 25: 0 }; sheetsI[TK] = totalSheetsI;
            cantoF = Math.ceil(cantoF);
            cantoI = Math.ceil(cantoI);
            var totalSheets = totalSheetsF + totalSheetsI;
            var totalCanto = cantoF + cantoI;

            // Material costs  use actual project thickness for price lookup
            var matPriceF = getMatPrice(P.matFrentes, TK);
            var matPriceI = getMatPrice(P.matInterior, TK);
            var matCostF = totalSheetsF * matPriceF;
            var matCostI = totalSheetsI * matPriceI;
            var chapCostF = cantoF * P.chapFrentesPrice;
            var chapCostI = cantoI * P.chapInteriorPrice;
            var corteCost = totalSheets * CONFIG.pricing.cuttingCostPerSheet;
            var enchapPrice = typeof P.enchapPrice === 'number' ? P.enchapPrice : 13;
            var enchapCost = totalCanto * enchapPrice;

            // Carpinteria total cost
            var carpCost = matCostF + matCostI + chapCostF + chapCostI + corteCost + enchapCost + P.laborCost + (P.freight ? P.freightCost : 0);

            // Hardware costs - combine auto + manual
            var hwConsolidated = {};
            autoHW.forEach(function(ah) {
                var def = HW_DEFAULTS[ah.key];
                if (!def)
                    return;
                var catItem = findCatItem(def.desc, def.marca);
                var price = catItem ? adjPrice(catItem) : def.fallback;
                var k = ah.key;
                if (!hwConsolidated[k])
                    hwConsolidated[k] = {
                        desc: def.desc,
                        marca: def.marca,
                        price: price,
                        qty: 0,
                        cat: def.cat,
                        catItem: catItem
                    };
                hwConsolidated[k].qty += ah.q;
            });
            // Manual hardware from project.hardware
            var manualHW = [];
            P.hardware.forEach(function(h) {
                manualHW.push({
                    desc: h.descripcion,
                    marca: h.marca,
                    price: adjPrice(h),
                    qty: h.qty,
                    cat: h.categoria,
                    codigo: h.codigo
                });
            });

            var hwCostCarpBucket = 0,
                hwCostPremium = 0;
            // Legacy brand-based accumulators (kept for backward compat in return object)
            var hwCostHerraxa = 0,
                hwCostHafele = 0,
                hwCostBlum = 0;
            var allHW = [];
            var hwThreshold = CONFIG.pricing.hardwareThreshold;
            for (var k in hwConsolidated) {
                var h = hwConsolidated[k];
                allHW.push(h);
                var cost = Math.ceil(h.qty) * h.price;
                // Threshold-based split: line item total <= threshold goes to carpentry bucket
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h._bucket = 'premium';
                }
                // Legacy brand tracking
                if (h.marca === 'BLUM') hwCostBlum += cost;
                else if (h.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            }
            manualHW.forEach(function(h) {
                allHW.push(h);
                var cost = Math.ceil(h.qty) * h.price;
                if (cost <= hwThreshold) {
                    hwCostCarpBucket += cost;
                    h._bucket = 'carp';
                } else {
                    hwCostPremium += cost;
                    h._bucket = 'premium';
                }
                if (h.marca === 'BLUM') hwCostBlum += cost;
                else if (h.marca === 'HAFELE') hwCostHafele += cost;
                else hwCostHerraxa += cost;
            });

            var hwStdCost = hwCostHerraxa + hwCostHafele;

            // Extras
            var extraCost = 0;
            // Include cubierta m2 cost in extras bucket
            extraCost += cubiertaCost;
            // Include cubrecanto ml cost (Tablered Arauco PVC edge banding, priced per linear meter)
            extraCost += cubrecantoCost;
            // Include bastidor ml cost (TV panelFondo pine frame, priced per linear meter)
            extraCost += bastidorCost;
            var ledBOM = calcLedBOM();
            if (ledBOM)
                extraCost += ledBOM.totalCost;
            if (P.glass && P.glassM2 > 0)
                extraCost += P.glassM2 * CONFIG.pricing.glassCostPerM2;
            // CUSTOMIZE: Paint calc  adjust coverage rates and paint cost logic here
            var paintCost = 0;
            P.modules.forEach(function(m2) {
                if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                    var pm2 = calcPaintM2(m2, {
                        mode: 'custom',
                        defaultHeight: P.defaultHeight,
                        defaultDepth: P.defaultDepth
                    });
                    var liters = calcPaintLiters(pm2, m2.paint.coats);
                    paintCost += liters * m2.paint.pricePerLiter;
                }
            });
            extraCost += paintCost;

            // Apply margins  threshold-based hardware pricing
            var carpMultiplier = CONFIG.pricing.carpentryMultiplier;
            var premiumMargin = CONFIG.pricing.premiumHardwareMargin;
            // Carpentry cost now includes the carpentry-bucket hardware (low-cost items)
            var carpSale = (carpCost + hwCostCarpBucket) * carpMultiplier;
            // Premium hardware (above threshold) gets margin-based pricing
            var hwPremiumSale = hwCostPremium / (1 - premiumMargin);
            // Legacy aliases for backward compat
            var hwStdSale = hwPremiumSale;
            var hwBlumSale = 0;
            var extrasSale = extraCost * CONFIG.pricing.extrasMultiplier;

            var subtotal = carpSale + hwPremiumSale + extrasSale;
            var iva = subtotal * CONFIG.pricing.iva;
            var total = subtotal + iva;
            var totalCost = carpCost + hwCostCarpBucket + hwCostPremium + extraCost;
            var profit = subtotal - totalCost;
            var margin = subtotal > 0 ? ((profit / subtotal) * 100).toFixed(1) : 0;

            return {
                pieces: pieces,
                autoHW: autoHW,
                allHW: allHW,
                hwConsolidated: hwConsolidated,
                manualHW: manualHW,
                sheetsF: sheetsF,
                sheetsI: sheetsI,
                cantoF: cantoF,
                cantoI: cantoI,
                totalSheetsF: totalSheetsF,
                totalSheetsI: totalSheetsI,
                totalSheets: totalSheets,
                totalCanto: totalCanto,
                matCostF: matCostF,
                matCostI: matCostI,
                chapCostF: chapCostF,
                chapCostI: chapCostI,
                corteCost: corteCost,
                enchapCost: enchapCost,
                carpCost: carpCost,
                hwCostCarpBucket: hwCostCarpBucket,
                hwCostPremium: hwCostPremium,
                hwCostHerraxa: hwCostHerraxa,
                hwCostHafele: hwCostHafele,
                hwCostBlum: hwCostBlum,
                hwStdCost: hwStdCost,
                extraCost: extraCost,
                cubiertaCost: cubiertaCost,
                cubiertaM2: cubiertaM2,
                cubrecantoCost: cubrecantoCost,
                bastidorCost: bastidorCost,
                cascoCost: matCostI + (useDual ? chapCostI : 0),
                frenteCost: matCostF + chapCostF,
                herrajesCost: hwCostCarpBucket + hwCostPremium,
                extrasCost: extraCost,
                ledBOM: ledBOM,
                paintCost: paintCost,
                carpSale: carpSale,
                hwPremiumSale: hwPremiumSale,
                hwStdSale: hwStdSale,
                hwBlumSale: hwBlumSale,
                extrasSale: extrasSale,
                subtotal: subtotal,
                iva: iva,
                total: total,
                totalCost: totalCost,
                profit: profit,
                margin: margin,
                useDual: useDual
            };
        }

        // === Sheet optimizer: calculates standard 1220x2440mm melamina sheets needed ===
        function calcSheets(pieces) {
            var SHEET_AREA = 1.22 * 2.44; // m2 per sheet (same as existing calc)
            var merma = CONFIG.pricing.mermaFactor || 1.20;
            var cascoArea = 0, frenteArea = 0;
            (pieces || []).forEach(function(p) {
                if (p.isCubierta || p.isCubrecanto || p.isBastidor) return; // priced separately
                if (p.t !== 15 && p.t !== 18 && p.t !== 16 && p.t !== 25) return; // only standard melamina sheets
                var a = (p.w / 1000) * (p.h / 1000) * (p.q || 1);
                if (p.z === 'f') frenteArea += a;
                else cascoArea += a;
            });
            return {
                casco: Math.ceil((cascoArea * merma) / SHEET_AREA),
                frente: Math.ceil((frenteArea * merma) / SHEET_AREA),
                total: Math.ceil((cascoArea * merma) / SHEET_AREA) + Math.ceil((frenteArea * merma) / SHEET_AREA)
            };
        }

        // === RENDER FUNCTIONS ===
        function renderTemplates() {
            var h = '<div class="tpl-grid">';
            h += '<div class="title"><h2>Plantillas</h2><p>Selecciona un diseno para cotizar</p></div>';
            h += '<button class="tpl-new" onclick="APP.newProject()">' + svg('plus') + 'Nuevo proyecto desde cero</button>';
            // Saved projects
            var saved = loadSavedProjects();
            if (saved.length > 0) {
                h += '<div class="saved-projects-section">';
                var cloudIcon = cloudProjects !== null ? '<span style="color:var(--color-success);font-size:11px;margin-left:8px">&#9729; En la nube</span>' : '<span style="color:#fbbf24;font-size:11px;margin-left:8px">&#9729; Sincronizando...</span>';
                h += '<div class="saved-projects-title">Proyectos Guardados (' + saved.length + ')' + cloudIcon + '</div>';
                saved.forEach(function(sp, idx) {
                    h += '<div class="saved-project-card">';
                    h += '<div class="saved-project-info">';
                    h += '<div class="sp-client">' + (sp.client || 'Sin nombre') + '</div>';
                    h += '<div class="sp-meta">' + sp.label + ' &middot; ' + (sp.savedAt ? new Date(sp.savedAt).toLocaleDateString('es-MX', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                    }) : '') + '</div>';
                    h += '</div>';
                    h += '<div class="saved-project-actions">';
                    h += '<button class="sp-load" onclick="APP.loadSavedProject(' + idx + ')">Cargar</button>';
                    h += '<button class="sp-del" onclick="APP.deleteSavedProject(' + idx + ')">&times;</button>';
                    h += '</div></div>';
                });
                h += '</div>';
            }
            /* TEMPLATES hidden
            TEMPLATES.forEach(function(t) {
                var typeName = TYPES.find(function(x) {
                    return x.id === t.type;
                });
                h += '<div class="tpl-card">';
                h += '<img class="tpl-card-img" src="' + t.photo + '" alt="' + t.name + '" onclick="APP.openImg(\'' + t.photo + '\')" onerror="this.outerHTML=\'<div style=height:180px;background:var(--color-bg-tertiary);display:flex;align-items:center;justify-content:center;font-size:48px>&#x1f4f7;</div>\'">';
                h += '<div class="tpl-card-body">';
                h += '<div class="tpl-card-name">' + t.name + '</div>';
                if (typeName)
                    h += '<span class="tpl-card-type">' + typeName.n + '</span>';
                h += '<div class="tpl-card-desc">' + t.desc + '</div>';
                h += '<div class="tpl-card-dims">' + (t.baseWidth / 100) + 'm ancho x ' + (t.baseHeight / 100) + 'm alto</div>';
                h += '<div class="tpl-card-price">' + fmt(t.basePrice) + '</div>';
                h += '<button class="tpl-card-btn" onclick="APP.selectTpl(\'' + t.id + '\')">Usar plantilla</button>';
                h += '</div></div>';
            });
            */
            h += '</div>';
            return h;
        }

        function renderQuickQuote() {
            var t = TEMPLATES.find(function(x) {
                return x.id === S.selTemplate;
            });
            if (!t)
                return '';
            var nw = S.quickWidth,
                nh = S.quickHeight;
            // CUSTOMIZE: Quick quote ratio logic  adjust pricing formula here
            var ratio = (nw * nh) / (t.baseWidth * t.baseHeight);
            var newPrice = Math.round(t.basePrice * ratio / 500) * 500;
            var iva = newPrice * CONFIG.pricing.iva;
            var total = newPrice + iva;
            var matName = S.quickMatName || t.matName;
            var matFinish = S.quickMatFinish || t.matFinish;
            var matDisplay = S.quickMatName ? matName + ' (' + matFinish + ')' : t.material;
            var h = '<img class="qq-img" src="' + t.photo + '" alt="' + t.name + '" onclick="APP.openImg(\'' + t.photo + '\')" style="cursor:pointer" onerror="this.style.display=\'none\'">';
            h += '<div class="qq-body">';
            h += '<div class="qq-name">' + t.name + '</div>';
            h += '<div class="qq-desc">' + t.desc + '</div>';
            h += '<div class="qq-section"><div class="qq-section-title">Ajustar medidas</div>';
            h += '<div class="qq-dim-row"><label>Ancho:</label><input class="qq-dim-input" type="number" value="' + (nw / 100) + '" step="0.1" min="0.5" max="8" onchange="APP.setQW(parseFloat(this.value)*100)"><span>m</span></div>';
            h += '<div class="qq-dim-row"><label>Alto:</label><input class="qq-dim-input" type="number" value="' + (nh / 100) + '" step="0.1" min="0.5" max="4" onchange="APP.setQH(parseFloat(this.value)*100)"><span>m</span></div>';
            h += '<div class="qq-base-ref" style="font-size:12px;color:var(--color-text-muted);text-align:center;margin-top:4px">Base: ' + (t.baseWidth / 100) + 'm x ' + (t.baseHeight / 100) + 'm = ' + fmt(t.basePrice) + '</div></div>';
            h += '<div class="qq-section"><div class="qq-section-title">Material</div>';
            h += '<select class="qq-mat-select" onchange="APP.setQMat(this.value)">';
            h += '<option value=""' + (S.quickMat === '' ? ' selected' : '') + '>' + t.material + ' (original)</option>';
            COLORS.forEach(function(c) {
                h += '<option value="' + c.c + '"' + (S.quickMat === c.c ? ' selected' : '') + '>' + c.c + ' - ' + c.n + ' (' + c.f + ')</option>';
            });
            h += '</select></div>';
            h += '<div class="qq-price-box"><div class="qq-price-label">Precio estimado</div><div class="qq-price">' + fmt(newPrice) + '</div><div class="qq-price-iva">+ IVA = ' + fmt(total) + '</div></div>';
            h += '<div class="qq-info"><div class="qq-info-item"><span>Material</span><strong>' + matDisplay + '</strong></div><div class="qq-info-item"><span>Entrega</span><strong>' + t.weeks + ' semanas</strong></div><div class="qq-info-item"><span>Anticipo</span><strong>60%</strong></div><div class="qq-info-item"><span>Medida</span><strong>' + (nw / 100) + 'm x ' + (nh / 100) + 'm</strong></div></div>';
            h += '<div class="pdf-actions" style="margin-top:16px">';
            h += '<button class="pdf-btn client" onclick="APP.genQuickPDF(\'client\')">&#x1f4c4; PDF Cliente</button>';
            h += '<button class="pdf-btn internal" onclick="APP.genQuickPDF(\'internal\')">&#x1f512; PDF Interno</button>';
            h += '<button class="pdf-btn despiece" onclick="APP.genQuickPDF(\'despiece\')">&#x1f4cb; PDF Despiece</button>';
            h += '</div>';
            h += '<button class="qq-full-btn" onclick="APP.fullQuote()">' + svg('edit') + 'Editar en cotizador completo</button></div>';
            return h;
        }

        function renderMaterialSelect(label, mat, onChange, badgeClass) {
            var araucoTabs = getAraucoTableros();
            var h = '<div class="mat-section">';
            h += '<div class="mat-section-label">' + label;
            if (badgeClass)
                h += ' <span class="badge ' + badgeClass + '">' + (badgeClass === 'vis' ? 'visible' : 'oculto') + '</span>';
            h += '</div>';
            h += '<select class="mat-select" onchange="' + onChange + '(this.value)">';
            h += '<optgroup label="FINSA (Melamina)">';
            COLORS.forEach(function(c) {
                var sel = (mat.brand === 'FINSA' && mat.code === c.c) ? ' selected' : '';
                h += '<option value="FINSA:' + c.c + '"' + sel + '>' + c.c + ' - ' + c.n + ' (' + c.f + ') - ' + fmt(FINSA_PRICES[16]) + '/hoja</option>';
            });
            h += '</optgroup>';
            if (araucoTabs.length > 0) {
                h += '<optgroup label="ARAUCO (Tableros)">';
                araucoTabs.forEach(function(item, idx) {
                    var sel = (mat.brand === 'ARAUCO' && mat.catItem && mat.catItem.codigo === item.codigo) ? ' selected' : '';
                    h += '<option value="ARAUCO:' + idx + '"' + sel + '>' + item.descripcion + ' - ' + fmtD(item.precio) + '</option>';
                });
                h += '</optgroup>';
            }
            var customSel = mat.brand === 'CUSTOM' ? ' selected' : '';
            h += '<option value="CUSTOM:0"' + customSel + '>\u2014 Material personalizado \u2014</option>';
            h += '</select>';
            if (mat.brand === 'CUSTOM') {
                h += '<div style="display:flex;gap:12px;margin-top:8px">';
                h += '<div style="flex:2"><span style="font-size:12px;color:var(--color-text-secondary)">Nombre</span><input type="text" value="' + (mat.name || '') + '" placeholder="Ej: MDF Nogal" onchange="' + onChange + '(\'CUSTOM_NAME:\'+this.value)" style="margin-top:4px"></div>';
                h += '<div style="flex:1"><span style="font-size:12px;color:var(--color-text-secondary)">Precio/hoja</span><input type="number" value="' + (mat.customPrice || 0) + '" min="0" step="50" onchange="' + onChange + '(\'CUSTOM_PRICE:\'+this.value)" style="margin-top:4px"></div>';
                h += '</div>';
            }
            var matInfoStr = mat.brand === 'CUSTOM' ? (mat.name || 'Personalizado') + ' - ' + fmt(mat.customPrice || 0) + '/hoja' : mat.brand + ': ' + (mat.brand === 'FINSA' ? mat.name + ' (' + mat.finish + ')' : mat.catItem ? mat.catItem.descripcion : '');
            h += '<div class="mat-info">' + matInfoStr + '</div>';
            h += '</div>';
            return h;
        }

        // SVG cross-section preview for closet modules with internal zones
        // 2D Wireframe preview  CSS Flexbox-based frontal view of a module
        // opts: { w: px, h: px } for container size (default 120x200)
        function renderModulePreview(m, opts) {
            opts = opts || {};
            var cW = opts.w || 120, cH = opts.h || 200;
            var P = S.project;
            var totalH = m.height || P.defaultHeight || 200; // cm
            var malH = (m.maletero && m.maletero.enabled) ? (m.maletero.height || 40) : 0;
            var zocH = (m.zoclo && m.zoclo.enabled) ? (m.zoclo.height || 10) : 0;
            var fullH = totalH + malH; // maletero adds to total, zoclo is inside
            // If module has zones, distribute them
            if (m.type === 'modulo' && m.zones) {
                autoDistributeZones(m.zones, totalH);
            }
            // Proportional height function: cm  px
            function hPx(cm) { return Math.max(1, Math.round(cm / fullH * (cH - 4))); }
            // Zone fill colors
            var zFills = {
                colgador: 'rgba(100,160,220,0.18)', colgadorDoble: 'rgba(100,160,220,0.18)',
                entrepa: 'rgba(120,180,120,0.18)', entrepa_esp: 'rgba(120,180,120,0.12)',
                cajones: 'rgba(200,160,80,0.18)', zapatero: 'rgba(180,120,160,0.18)'
            };
            var s = '<div style="display:flex;flex-direction:column;width:' + cW + 'px;height:' + cH + 'px;border:2px solid var(--color-border);border-radius:6px;background:var(--color-bg-elevated);position:relative;overflow:hidden;font-family:inherit;box-sizing:border-box">';

            // === Maletero (top) ===
            if (malH > 0) {
                s += '<div style="flex:0 0 ' + hPx(malH) + 'px;border-bottom:2px solid var(--color-border);background:repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(128,128,128,0.08) 3px,rgba(128,128,128,0.08) 6px);display:flex;align-items:center;justify-content:center">';
                if (cH >= 100) s += '<span style="font-size:8px;color:var(--color-text-muted);opacity:0.7">Maletero</span>';
                s += '</div>';
            }

            // === Main body ===
            var bodyH = totalH - zocH; // usable body height in cm (zoclo is inside totalH)
            s += '<div style="flex:1;display:flex;flex-direction:column;min-height:0;position:relative">';

            // Zone rendering (for modulo type with zones)
            if (m.type === 'modulo' && m.zones && m.zones.length > 0) {
                var totalZoneH = 0;
                m.zones.forEach(function(z) { totalZoneH += (z._h || 20); });
                m.zones.forEach(function(z, zi) {
                    var zh = z._h || 20;
                    var pct = totalZoneH > 0 ? (zh / totalZoneH * 100) : (100 / m.zones.length);
                    var fill = zFills[z.type] || 'rgba(128,128,128,0.08)';
                    var borderB = zi < m.zones.length - 1 ? 'border-bottom:1px solid rgba(128,128,128,0.25);' : '';
                    s += '<div style="flex:' + pct.toFixed(2) + ';min-height:2px;background:' + fill + ';' + borderB + 'position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden">';

                    if (z.type === 'colgador') {
                        // Horizontal rod line near top
                        s += '<div style="position:absolute;top:20%;left:12%;right:12%;height:0;border-top:2px solid var(--color-text-primary);opacity:0.5"></div>';
                        s += '<div style="position:absolute;top:20%;left:12%;width:5px;height:5px;border-radius:50%;background:var(--color-text-primary);opacity:0.5;transform:translate(-50%,-50%)"></div>';
                        s += '<div style="position:absolute;top:20%;right:12%;width:5px;height:5px;border-radius:50%;background:var(--color-text-primary);opacity:0.5;transform:translate(50%,-50%)"></div>';
                    } else if (z.type === 'colgadorDoble') {
                        // Two rods + divider
                        s += '<div style="position:absolute;top:18%;left:12%;right:12%;height:0;border-top:2px solid var(--color-text-primary);opacity:0.5"></div>';
                        s += '<div style="position:absolute;top:50%;left:0;right:0;height:0;border-top:1px solid var(--color-text-primary);opacity:0.25"></div>';
                        s += '<div style="position:absolute;top:65%;left:12%;right:12%;height:0;border-top:2px solid var(--color-text-primary);opacity:0.5"></div>';
                    } else if (z.type === 'entrepa' || z.type === 'entrepa_esp') {
                        // Horizontal shelf lines
                        var qty = z.qty || 3;
                        var isDash = z.type === 'entrepa_esp';
                        for (var si = 1; si <= qty; si++) {
                            var yPct = (si / (qty + 1) * 100).toFixed(1);
                            s += '<div style="position:absolute;top:' + yPct + '%;left:0;right:0;height:0;border-top:1.5px ' + (isDash ? 'dashed' : 'solid') + ' var(--color-text-primary);opacity:0.4"></div>';
                        }
                    } else if (z.type === 'cajones') {
                        // Stacked drawer boxes with handles
                        var qty = z.qty || 3;
                        s += '<div style="display:flex;flex-direction:column;width:100%;height:100%;padding:1px 2px;gap:1px;box-sizing:border-box">';
                        for (var ci = 0; ci < qty; ci++) {
                            s += '<div style="flex:1;border:1px solid rgba(128,128,128,0.4);border-radius:1px;display:flex;align-items:center;justify-content:center;min-height:0">';
                            s += '<div style="width:30%;height:0;border-top:1.5px solid var(--color-text-primary);opacity:0.4"></div>';
                            s += '</div>';
                        }
                        s += '</div>';
                    } else if (z.type === 'zapatero') {
                        // Angled tray lines
                        var qty = z.qty || 4;
                        s += '<div style="display:flex;flex-direction:column;width:100%;height:100%;padding:1px 3px;box-sizing:border-box">';
                        for (var zi2 = 0; zi2 < qty; zi2++) {
                            s += '<div style="flex:1;position:relative;min-height:0;overflow:hidden">';
                            s += '<div style="position:absolute;bottom:0;left:0;right:0;height:70%;border-bottom:1px solid rgba(128,128,128,0.4);transform:rotate(-8deg);transform-origin:bottom left"></div>';
                            s += '</div>';
                        }
                        s += '</div>';
                    }
                    s += '</div>';
                });
            } else {
                // Non-zone modules: simple interior representation
                if (m.type === 'torreLateral' || m.type === 'lateralAbierto' || m.type === 'despensa' || m.type === 'torreDespensa' || m.type === 'torre') {
                    // Shelves
                    var sh = typeof m.shelves === 'number' ? m.shelves : 3;
                    for (var si2 = 1; si2 <= sh; si2++) {
                        var yPct2 = (si2 / (sh + 1) * 100).toFixed(1);
                        s += '<div style="position:absolute;top:' + yPct2 + '%;left:0;right:0;height:0;border-top:1.5px solid var(--color-text-primary);opacity:0.4"></div>';
                    }
                } else if (m.type === 'panelTV') {
                    // Solid filled rectangle  flat panel, no internal components
                    s += '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(196,154,108,0.15);display:flex;align-items:center;justify-content:center">';
                    s += '<div style="width:70%;height:60%;border:1.5px dashed rgba(128,128,128,0.4);border-radius:3px"></div>';
                    s += '</div>';
                } else if (m.type === 'gabineteBase') {
                    // Base cabinet  dashed top edge to indicate open top (no techo), shelf line
                    s += '<div style="position:absolute;top:0;left:0;right:0;height:0;border-top:2px dashed rgba(196,154,108,0.5)"></div>';
                    s += '<div style="position:absolute;top:50%;left:0;right:0;height:0;border-top:1.5px solid var(--color-text-primary);opacity:0.4"></div>';
                } else if (m.type === 'alacenaAlta') {
                    // Wall cabinet  shelf line + small bracket indicators on sides
                    s += '<div style="position:absolute;top:50%;left:0;right:0;height:0;border-top:1.5px solid var(--color-text-primary);opacity:0.4"></div>';
                    s += '<div style="position:absolute;top:15%;left:-1px;width:4px;height:10px;background:rgba(128,128,128,0.4);border-radius:0 2px 2px 0"></div>';
                    s += '<div style="position:absolute;top:15%;right:-1px;width:4px;height:10px;background:rgba(128,128,128,0.4);border-radius:2px 0 0 2px"></div>';
                } else if (m.type === 'credenzaBase' || m.type === 'credenzaFlotante') {
                    // Landscape proportions  shelf line + accent top if cubiertaSuperior
                    if (m.cubiertaSuperior) {
                        s += '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:rgba(196,154,108,0.5);border-radius:3px 3px 0 0"></div>';
                    }
                    s += '<div style="position:absolute;top:50%;left:0;right:0;height:0;border-top:1.5px solid var(--color-text-primary);opacity:0.4"></div>';
                } else if (m.type === 'gabineteTV') {
                    // Landscape floating cabinet  shelf line
                    s += '<div style="position:absolute;top:50%;left:0;right:0;height:0;border-top:1.5px solid var(--color-text-primary);opacity:0.4"></div>';
                } else if (m.type === 'cajonBase' || m.type === 'cajonera' || m.type === 'cajoneraBano') {
                    // Drawers
                    var caj = typeof m.cajones === 'number' ? m.cajones : 3;
                    s += '<div style="display:flex;flex-direction:column;width:100%;height:100%;padding:2px 3px;gap:1px;box-sizing:border-box">';
                    for (var ci2 = 0; ci2 < caj; ci2++) {
                        s += '<div style="flex:1;border:1px solid rgba(128,128,128,0.4);border-radius:1px;display:flex;align-items:center;justify-content:center;min-height:0">';
                        s += '<div style="width:30%;height:0;border-top:1.5px solid var(--color-text-primary);opacity:0.4"></div>';
                        s += '</div>';
                    }
                    s += '</div>';
                } else if (m.type === 'bajoLavabo') {
                    var caj = typeof m.cajones === 'number' ? m.cajones : 2;
                    s += '<div style="display:flex;flex-direction:column;width:100%;height:100%;padding:2px 3px;gap:1px;box-sizing:border-box">';
                    for (var ci3 = 0; ci3 < caj; ci3++) {
                        s += '<div style="flex:1;border:1px solid rgba(128,128,128,0.4);border-radius:1px;display:flex;align-items:center;justify-content:center;min-height:0">';
                        s += '<div style="width:30%;height:0;border-top:1.5px solid var(--color-text-primary);opacity:0.4"></div>';
                        s += '</div>';
                    }
                    s += '</div>';
                } else {
                    // Generic: single shelf line
                    s += '<div style="position:absolute;top:50%;left:0;right:0;height:0;border-top:1px dashed rgba(128,128,128,0.3)"></div>';
                }
            }
            s += '</div>'; // close main body

            // === Zoclo (bottom) ===
            if (zocH > 0) {
                s += '<div style="flex:0 0 ' + hPx(zocH) + 'px;background:rgba(128,128,128,0.12);border-top:1px solid var(--color-border);display:flex;align-items:center;justify-content:center">';
                if (cH >= 100) s += '<span style="font-size:7px;color:var(--color-text-muted);opacity:0.6">Zoclo</span>';
                s += '</div>';
            }

            // === Puertas overlay (only at >=80px height to avoid clutter) ===
            if (cH >= 80 && m.puertas && m.puertas.enabled) {
                var pCnt = m.puertas.cantidad || 2;
                // Overlay covers the main body area (skip maletero top and zoclo bottom)
                var topOff = malH > 0 ? (hPx(malH) + 2) : 2;
                var botOff = zocH > 0 ? (hPx(zocH) + 2) : 2;
                s += '<div style="position:absolute;top:' + topOff + 'px;left:2px;right:2px;bottom:' + botOff + 'px;background:rgba(196,154,108,0.2);border:1.5px dashed #c49a6c;border-radius:2px;display:flex;pointer-events:none;z-index:1">';
                for (var pi = 0; pi < pCnt; pi++) {
                    s += '<div style="flex:1;' + (pi < pCnt - 1 ? 'border-right:1px dashed #c49a6c;' : '') + 'display:flex;align-items:center;justify-content:center">';
                    s += '<div style="width:3px;height:10px;border-radius:1px;background:rgba(196,154,108,0.5)"></div>';
                    s += '</div>';
                }
                s += '</div>';
            }

            // === Enchapado indicators (only at >=80px height) ===
            if (cH >= 80 && m.enchapado) {
                var eColor = '#c49a6c';
                if (m.enchapado.latIzq)
                    s += '<div style="position:absolute;top:0;left:0;width:3px;height:100%;background:' + eColor + ';opacity:0.5;border-radius:3px 0 0 3px;pointer-events:none"></div>';
                if (m.enchapado.latDer)
                    s += '<div style="position:absolute;top:0;right:0;width:3px;height:100%;background:' + eColor + ';opacity:0.5;border-radius:0 3px 3px 0;pointer-events:none"></div>';
                if (m.enchapado.techo)
                    s += '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:' + eColor + ';opacity:0.5;border-radius:3px 3px 0 0;pointer-events:none"></div>';
                if (m.enchapado.piso)
                    s += '<div style="position:absolute;bottom:0;left:0;right:0;height:3px;background:' + eColor + ';opacity:0.5;border-radius:0 0 3px 3px;pointer-events:none"></div>';
            }

            s += '</div>'; // close container
            return s;
        }
        // Legacy alias
        function renderModuleSVG(m) { return renderModulePreview(m); }

        function renderModuleLed(m) {
            var P = S.project;
            if (!m.led)
                m.led = {
                    enabled: false,
                    edges: {
                        top: false,
                        bottom: false,
                        left: false,
                        right: false,
                        shelves: false
                    },
                    shelfCount: 0,
                    ledMeters: 0,
                    segments: 0,
                    metersOverride: null,
                    segmentsOverride: null
                };
            var led = m.led;
            var h = '<div class="led-section">';
            h += '<div class="led-toggle-row"><span>&#x1f4a1; Iluminacion LED</span><button class="toggle' + (led.enabled ? ' on' : '') + '" onclick="APP.togModLed(\'' + m.id + '\')"></button></div>';
            if (!led.enabled) {
                h += '</div>';
                return h;
            }
            // Edge selector
            h += '<div class="led-edges">';
            h += '<div style="position:relative;padding:18px 34px">';
            h += '<div class="led-edge-box">';
            h += '<button class="led-edge top' + (led.edges.top ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'top\')"></button>';
            h += '<button class="led-edge bottom' + (led.edges.bottom ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'bottom\')"></button>';
            h += '<button class="led-edge left' + (led.edges.left ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'left\')"></button>';
            h += '<button class="led-edge right' + (led.edges.right ? ' on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'right\')"></button>';
            h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;color:var(--color-text-muted);pointer-events:none;text-align:center;white-space:nowrap">' + m.width + 'x' + (m.height || P.defaultHeight || 200) + '</div>';
            h += '</div></div>';
            h += '<div class="led-opts">';
            // Shelf LED toggle + count
            h += '<div class="led-shelf-row"><button class="' + (led.edges.shelves ? 'on' : '') + '" onclick="APP.togLedEdge(\'' + m.id + '\',\'shelves\')">' + (led.edges.shelves ? '&#10003;' : '') + ' Entrepaos</button>';
            if (led.edges.shelves)
                h += '<input type="number" value="' + led.shelfCount + '" min="0" max="10" onchange="APP.setLedShelves(\'' + m.id + '\',parseInt(this.value))">';
            h += '</div>';
            // Auto-calc display
            var auto = calcModuleLedMeters(m);
            var usedM = (led.metersOverride !== null && led.metersOverride >= 0) ? led.metersOverride : auto.meters;
            var usedS = (led.segmentsOverride !== null && led.segmentsOverride >= 0) ? led.segmentsOverride : auto.segments;
            h += '<div class="led-meters"><span>Metros:</span><input type="number" value="' + usedM.toFixed(2) + '" min="0" step="0.1" onchange="APP.setLedMeters(\'' + m.id + '\',parseFloat(this.value))">';
            h += '<span>Segmentos:</span><input type="number" value="' + usedS + '" min="0" step="1" onchange="APP.setLedSegments(\'' + m.id + '\',parseInt(this.value))">';
            if (led.metersOverride !== null || led.segmentsOverride !== null)
                h += '<button style="padding:2px 6px;border-radius:4px;border:1px solid #fbbf24;background:none;color:#fbbf24;font-size:10px;cursor:pointer" onclick="APP.resetLedOverride(\'' + m.id + '\')">Auto</button>';
            h += '</div>';
            h += '</div></div>';
            // Activation type (project-level)
            h += '<div style="font-size:11px;color:var(--color-text-muted);margin-bottom:4px">Activacion:</div>';
            h += '<div class="led-radio">';
            [{
                k: 'presion',
                l: 'Presion',
                p: LED_CATALOG.switches.presion.price
            }, {
                k: 'dimmer',
                l: 'Dimmer',
                p: LED_CATALOG.switches.dimmer.price
            }, {
                k: 'movimiento',
                l: 'Movimiento',
                p: LED_CATALOG.switches.movimiento.price
            }, {
                k: 'puerta',
                l: 'Puerta',
                p: LED_CATALOG.switches.puerta.price
            }].forEach(function(sw) {
                h += '<button class="' + (P.ledConfig.activation === sw.k ? 'sel' : '') + '" onclick="APP.setLedActivation(\'' + sw.k + '\')">' + sw.l + ' ' + fmtD(sw.p) + '</button>';
            });
            h += '</div>';
            // Light temperature (project-level)
            h += '<div style="font-size:11px;color:var(--color-text-muted);margin:4px 0">Temperatura:</div>';
            h += '<div class="led-radio">';
            h += '<button class="' + (P.ledConfig.lightTemp === 'calida' ? 'sel' : '') + '" onclick="APP.setLedTemp(\'calida\')">Calida 3000K</button>';
            h += '<button class="' + (P.ledConfig.lightTemp === 'fria' ? 'sel' : '') + '" onclick="APP.setLedTemp(\'fria\')">Fria 5000K</button>';
            h += '</div>';
            // Mini BOM preview (project-level, shown on first module with LED)
            var ledBOM = calcLedBOM();
            if (ledBOM) {
                h += '<div class="led-bom-preview">';
                h += '<div style="font-size:10px;color:var(--color-text-muted);margin-bottom:4px">Lista de Material LED (auto)</div>';
                ledBOM.items.forEach(function(it) {
                    h += '<div class="led-bom-row"><span>' + it.qty + 'x ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                });
                h += '<div class="led-bom-total"><span>Costo LED</span><strong>' + fmtD(ledBOM.totalCost) + '</strong></div>';
                h += '</div>';
            }
            h += '</div>';
            return h;
        }

        function renderModulePaint(m) {
            var P = S.project;
            if (!m.paint)
                m.paint = {
                    enabled: false,
                    name: '',
                    pricePerLiter: 0,
                    coats: 2,
                    scope: 'doors'
                };
            var paint = m.paint;
            var h = '<div style="margin-top:8px;padding:8px;background:var(--color-bg-card);border-radius:8px;border:1px solid var(--color-border)">';
            h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:13px;color:var(--color-text-secondary)">&#x1f3a8; Pintura</span><button class="toggle' + (paint.enabled ? ' on' : '') + '" onclick="APP.togPaint(\'' + m.id + '\')"></button></div>';
            if (!paint.enabled) {
                h += '</div>';
                return h;
            }
            var qm = m.quoteMode || 'completo';
            h += '<div style="display:flex;flex-direction:column;gap:6px">';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--color-text-muted);min-width:60px">Nombre:</span><input type="text" value="' + (paint.name || '') + '" placeholder="Ej: Laqueado blanco" style="flex:1;font-size:12px;padding:4px 8px;background:var(--color-bg-tertiary);border:1px solid var(--color-border);border-radius:4px;color:var(--color-text-primary)" onchange="APP.setPaintName(\'' + m.id + '\',this.value)"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--color-text-muted);min-width:60px">$/Litro:</span><input type="number" value="' + paint.pricePerLiter + '" min="0" step="50" style="width:90px;font-size:12px;padding:4px 8px;background:var(--color-bg-tertiary);border:1px solid var(--color-border);border-radius:4px;color:var(--color-text-primary)" onchange="APP.setPaintPrice(\'' + m.id + '\',parseFloat(this.value))"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--color-text-muted);min-width:60px">Manos:</span><input type="number" value="' + (paint.coats || 2) + '" min="1" max="5" step="1" style="width:60px;font-size:12px;padding:4px 8px;background:var(--color-bg-tertiary);border:1px solid var(--color-border);border-radius:4px;color:var(--color-text-primary)" onchange="APP.setPaintCoats(\'' + m.id + '\',parseInt(this.value))"></div>';
            h += '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;color:var(--color-text-muted);min-width:60px">Alcance:</span>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'doors' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'doors\')">Puertas</button>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'structure' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'structure\')">Estructura</button>';
            h += '<button class="opt-btn' + ((paint.scope || 'doors') === 'all' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setPaintScope(\'' + m.id + '\',\'all\')">Todo</button>';
            h += '</div>';
            var coats = paint.coats || 2;
            var pm2 = calcPaintM2(m, {
                mode: 'custom',
                defaultHeight: P.defaultHeight,
                defaultDepth: P.defaultDepth
            });
            var liters = calcPaintLiters(pm2, coats);
            var buyLiters = Math.ceil(liters);
            var cost = liters * paint.pricePerLiter;
            h += '<div style="font-size:12px;color:var(--color-info);padding:2px 0">' + pm2.toFixed(2) + ' m\u00b2 \u00d7 ' + coats + ' manos \u00f7 10 m\u00b2/L = ' + liters.toFixed(2) + ' L &rarr; ' + fmtD(Math.round(cost)) + '</div>';
            h += '<div style="font-size:11px;color:var(--color-text-muted);padding:1px 0">Comprar: ' + buyLiters + ' L</div>';
            if (pm2 === 0 && paint.scope === 'doors' && !m.doors && qm !== 'solo_puertas')
                h += '<div style="font-size:11px;color:var(--color-error)">Sin puertas \u2014 0 m\u00b2</div>';
            if (pm2 === 0 && paint.scope === 'structure' && qm === 'solo_puertas')
                h += '<div style="font-size:11px;color:var(--color-error)">Solo puertas \u2014 sin estructura</div>';
            h += '</div></div>';
            return h;
        }

        function step1() {
            var P = S.project;
            var h = '<div class="title"><h2>Nuevo Proyecto</h2><p>Informacion basica</p></div>';
            h += '<div class="field"><label>Nombre del Cliente</label><input type="text" id="client" value="' + P.client + '" placeholder="Ej: Juan Perez" oninput="APP.setClient(this.value)"></div>';
            h += '<div class="field"><label>Tipo de Proyecto</label><div class="grid2">';
            TYPES.forEach(function(t) {
                h += '<button class="type-btn' + (P.type === t.id ? ' sel' : '') + '" onclick="APP.setType(\'' + t.id + '\')"><span>' + t.i + '</span>' + t.n + '</button>';
            });
            h += '</div></div>';
            // Dual material toggle
            if (isDualType(P.type)) {
                h += '<div class="mat-toggle-row"><span>Usar mismo material para todo</span><button class="toggle' + (P.sameMaterial ? ' on' : '') + '" onclick="APP.togSameMat()"></button></div>';
            }
            // Material selection
            if (P.sameMaterial || !isDualType(P.type)) {
                h += renderMaterialSelect('Material', 'matFrentes' in P ? P.matFrentes : defaultMat(), 'APP.setMatFrentes', '');
            } else {
                h += renderMaterialSelect('Material Frentes', 'matFrentes' in P ? P.matFrentes : defaultMat(), 'APP.setMatFrentes', 'vis');
                h += renderMaterialSelect('Material Interior', 'matInterior' in P ? P.matInterior : defaultMat(), 'APP.setMatInterior', 'hid');
            }
            // Thickness
            var qqStdThicks = [16, 18, 25];
            var qqCustomThk = qqStdThicks.indexOf(P.thickness) === -1;
            h += '<div class="field"><label>Espesor Principal</label><div style="display:flex;gap:8px;flex-wrap:wrap">';
            qqStdThicks.forEach(function(t) {
                h += '<button class="thick-btn' + (P.thickness === t ? ' sel' : '') + '" onclick="APP.setThick(' + t + ')">' + t + 'mm</button>';
            });
            h += '<button class="thick-btn' + (qqCustomThk ? ' sel' : '') + '" onclick="APP.setCustomThick()">Otro</button>';
            h += '</div>';
            if (qqCustomThk) {
                h += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input type="number" value="' + P.thickness + '" min="3" max="50" step="1" style="width:80px" onchange="APP.setThick(parseInt(this.value))"><span style="color:var(--color-text-secondary)">mm</span></div>';
            }
            h += '<p class="hint">Todas las piezas usan el espesor seleccionado</p></div>';
            // Chapacanto
            h += '<div class="field"><label>Chapacanto ($/ml)</label>';
            if (P.sameMaterial || !isDualType(P.type)) {
                h += '<input type="number" value="' + P.chapFrentesPrice + '" step="0.1" onchange="APP.setChapF(parseFloat(this.value))" style="width:120px">';
            } else {
                h += '<div style="display:flex;gap:12px;margin-bottom:8px"><div style="flex:1"><span style="font-size:12px;color:var(--color-info)">Frentes</span><input type="number" value="' + P.chapFrentesPrice + '" step="0.1" onchange="APP.setChapF(parseFloat(this.value))"></div>';
                h += '<div style="flex:1"><span style="font-size:12px;color:var(--color-text-muted)">Interior</span><input type="number" value="' + P.chapInteriorPrice + '" step="0.1" onchange="APP.setChapI(parseFloat(this.value))"></div></div>';
            }
            h += '<div style="margin-top:8px"><span style="font-size:12px;color:var(--color-text-secondary)">Especificacion del canto</span><input type="text" value="' + (P.chapSpec || '') + '" placeholder="Ej: 1mm x 19mm ABS para refilar" oninput="APP.setChapSpec(this.value)" style="margin-top:4px"></div>';
            h += '</div>';
            // Enchapado price
            h += '<div class="field"><label>Enchapado ($/ml)</label>';
            h += '<input type="number" value="' + (typeof P.enchapPrice === 'number' ? P.enchapPrice : 13) + '" step="0.5" min="0" onchange="APP.setEnchapPrice(parseFloat(this.value))" style="width:120px">';
            h += '<p class="hint">Costo por metro lineal de enchapado</p></div>';
            // Default Height
            h += '<div class="field"><label>Alto por defecto (cm)</label>';
            h += '<input type="number" value="' + P.defaultHeight + '" min="50" max="400" step="1" onchange="APP.setDefaultHeight(parseInt(this.value))" placeholder="200" style="width:120px">';
            h += '<p class="hint">Aplica a todos los modulos sin alto propio</p></div>';
            // Depth  same for all or per-module
            h += '<div class="field"><label>Profundidad</label>';
            h += '<div class="mat-toggle-row" style="margin-bottom:8px"><span>Misma profundidad para todos</span><button class="toggle' + (P.sameDepth ? ' on' : '') + '" onclick="APP.togSameDepth()"></button></div>';
            if (P.sameDepth) {
                h += '<input type="number" value="' + P.defaultDepth + '" min="20" max="100" step="1" onchange="APP.setDefaultDepth(parseInt(this.value))" placeholder="50" style="width:120px">';
                h += '<span style="font-size:12px;color:var(--color-text-muted);margin-left:8px">cm  general para todo el proyecto</span>';
            } else {
                h += '<p class="hint">Cada modulo tendra su propia profundidad editable</p>';
            }
            h += '</div>';
            return h;
        }

        // CUSTOMIZE: Module type buttons  controls which module types appear in the add-module panel
        function step2() {
            var P = S.project;
            migrateModules(P.modules);
            var typeObj = TYPES.find(function(t) { return t.id === P.type; });
            var typeName = typeObj ? typeObj.i + ' ' + typeObj.n : 'Proyecto';
            var h = '<div class="title"><h2>' + typeName + '</h2><p>Configurar modulos del proyecto</p></div>';
            // Filter modules by project type using forType field
            var filteredKeys = [];
            for (var k in MODS) {
                var modDef = MODS[k];
                if (modDef.forType) {
                    if (modDef.forType.indexOf(P.type) !== -1) filteredKeys.push(k);
                } else {
                    if (!P.type || P.type === 'otro') filteredKeys.push(k);
                }
            }
            // Group filtered modules by cat field
            var groups = {};
            var groupOrder = [];
            filteredKeys.forEach(function(fk) {
                var c = MODS[fk].cat || '';
                if (!groups[c]) { groups[c] = []; groupOrder.push(c); }
                groups[c].push(fk);
            });
            // Category tabs
            if (!S.modCatTab || groupOrder.indexOf(S.modCatTab) === -1) S.modCatTab = groupOrder[0] || '';
            if (groupOrder.length > 1) {
                h += '<div class="cat-tabs">';
                groupOrder.forEach(function(gName) {
                    var col = BP_COLORS[gName] || BP_COLORS['_default'];
                    var isSel = S.modCatTab === gName;
                    h += '<button class="cat-tab' + (isSel ? ' sel' : '') + '" style="' + (isSel ? 'background:' + col.bg + ';border-color:' + col.bg : '') + '" onclick="APP.setModCatTab(\'' + gName + '\')">' + gName + ' (' + groups[gName].length + ')</button>';
                });
                h += '</div>';
            }
            // Render add buttons for active tab only
            h += '<div class="add-btns">';
            var activeGroup = groupOrder.length > 1 ? S.modCatTab : (groupOrder[0] || '');
            var activeKeys = groups[activeGroup] || [];
            activeKeys.forEach(function(mk) {
                var tip = (MODS[mk].d || '') + (MODS[mk].w ? ' | Anchos: ' + MODS[mk].w.join(', ') + 'cm' : '');
                h += '<button class="add-btn" title="' + tip + '" onclick="APP.addMod(\'' + mk + '\')">' + svg('plus') + MODS[mk].n + '</button>';
            });
            h += '</div>';
            if (P.modules.length === 0) {
                h += '<div class="empty">' + svg('pkg') + '<p>No hay modulos</p></div>';
            } else {
                // Horizontal module row with SVG silhouettes
                h += '<div class="mod-row">';
                P.modules.forEach(function(m, i) {
                    var col = getModCatColor(m.type);
                    var isSel = S.selectedModId === m.id;
                    var blockW = Math.max(72, Math.min(140, m.width * 0.9));
                    h += '<div class="mod-block' + (isSel ? ' sel' : '') + '" style="width:' + blockW + 'px;height:132px;background:' + col.light + ';border-color:' + (isSel ? col.border : 'transparent') + '" onclick="APP.selectMod(\'' + m.id + '\')">';
                    h += '<div class="mod-block-actions">';
                    if (i > 0) h += '<button onclick="event.stopPropagation();APP.moveMod(\'' + m.id + '\',-1)" title="Mover izquierda">\u2190</button>';
                    if (i < P.modules.length - 1) h += '<button onclick="event.stopPropagation();APP.moveMod(\'' + m.id + '\',1)" title="Mover derecha">\u2192</button>';
                    h += '<button class="del-btn" onclick="event.stopPropagation();APP.delMod(\'' + m.id + '\')" title="Eliminar">\u00d7</button>';
                    h += '</div>';
                    // Module preview  closet modules use full wireframe, others use modSvg icon
                    if (m.type === 'modulo' && m.zones) {
                        h += '<div style="width:40px;height:60px;flex-shrink:0">' + renderModulePreview(m, { w: 40, h: 60 }) + '</div>';
                    } else {
                        h += modSvg(m.type);
                    }
                    var _mLabel = MODS[m.type] ? MODS[m.type].n : m.name;
                    h += '<div class="mod-block-label" title="' + _mLabel + '">' + _mLabel + '</div>';
                    h += '<div class="mod-block-w">' + m.width + 'cm</div>';
                    h += '</div>';
                });
                h += '</div>';
                // Space usage bar  kitchen: separate bajos vs alacenas accumulation
                var targetW = P.targetWidth || 0;
                if (P.type === 'cocina') {
                    var _bajoCats = ['Bajos'];
                    var _alaCats = ['Alacenas'];
                    var twBajos = P.modules.reduce(function(a, m) { return a + (MODS[m.type] && _bajoCats.indexOf(MODS[m.type].cat) !== -1 ? m.width : 0); }, 0);
                    var twAlac = P.modules.reduce(function(a, m) { return a + (MODS[m.type] && _alaCats.indexOf(MODS[m.type].cat) !== -1 ? m.width : 0); }, 0);
                    h += '<div class="space-usage-bar" style="flex-direction:column;gap:6px">';
                    h += '<div class="space-usage-target" style="display:flex;align-items:center;gap:4px;white-space:nowrap"><span>Ancho muro:</span><input type="number" value="' + targetW + '" min="0" step="10" placeholder="0" onchange="APP.setTargetWidth(parseInt(this.value)||0)"><span>cm</span></div>';
                    // Bajos bar
                    h += '<div style="display:flex;align-items:center;gap:8px;width:100%">';
                    h += '<span style="font-size:12px;color:var(--color-text-muted);min-width:60px">Bajos:</span>';
                    h += '<strong style="white-space:nowrap;color:#2563eb;min-width:50px">' + twBajos + ' cm</strong>';
                    if (targetW > 0) {
                        var pctB = Math.min(100, Math.round(twBajos / targetW * 100));
                        var isOverB = twBajos > targetW;
                        var barColorB = pctB > 100 ? '#ef4444' : pctB >= 95 ? '#eab308' : '#2563eb';
                        h += '<div class="space-usage-track" style="flex:1"><div class="space-usage-fill" style="width:' + pctB + '%;background:' + barColorB + '"></div></div>';
                        h += '<span style="white-space:nowrap;font-size:11px;color:' + (isOverB ? '#ef4444' : 'var(--color-text-muted)') + '">' + (isOverB ? '+' + (twBajos - targetW) + 'cm' : (targetW - twBajos) + 'cm') + '</span>';
                    }
                    h += '</div>';
                    // Alacenas bar
                    h += '<div style="display:flex;align-items:center;gap:8px;width:100%">';
                    h += '<span style="font-size:12px;color:var(--color-text-muted);min-width:60px">Alacenas:</span>';
                    h += '<strong style="white-space:nowrap;color:#7c3aed;min-width:50px">' + twAlac + ' cm</strong>';
                    if (targetW > 0) {
                        var pctA = Math.min(100, Math.round(twAlac / targetW * 100));
                        var isOverA = twAlac > targetW;
                        var barColorA = pctA > 100 ? '#ef4444' : pctA >= 95 ? '#eab308' : '#7c3aed';
                        h += '<div class="space-usage-track" style="flex:1"><div class="space-usage-fill" style="width:' + pctA + '%;background:' + barColorA + '"></div></div>';
                        h += '<span style="white-space:nowrap;font-size:11px;color:' + (isOverA ? '#ef4444' : 'var(--color-text-muted)') + '">' + (isOverA ? '+' + (twAlac - targetW) + 'cm' : (targetW - twAlac) + 'cm') + '</span>';
                    }
                    h += '</div>';
                    h += '</div>';
                } else {
                    var tw = P.modules.reduce(function(a, m) { return a + m.width; }, 0);
                    h += '<div class="space-usage-bar">';
                    h += '<strong style="white-space:nowrap;color:var(--color-text-primary)">' + tw + ' cm</strong>';
                    if (targetW > 0) {
                        var pct = Math.min(100, Math.round(tw / targetW * 100));
                        var isOver = tw > targetW;
                        h += '<div class="space-usage-track"><div class="space-usage-fill' + (isOver ? ' over' : '') + '" style="width:' + pct + '%"></div></div>';
                        h += '<span style="white-space:nowrap;font-size:12px;color:' + (isOver ? '#ef4444' : 'var(--color-text-muted)') + '">' + (isOver ? '+' + (tw - targetW) + 'cm' : (targetW - tw) + 'cm libre') + '</span>';
                    }
                    h += '<div class="space-usage-target" style="display:flex;align-items:center;gap:4px;white-space:nowrap"><span>Meta:</span><input type="number" value="' + targetW + '" min="0" step="10" placeholder="0" onchange="APP.setTargetWidth(parseInt(this.value)||0)"><span>cm</span></div>';
                    h += '</div>';
                }

                // Selected module spec panel
                var selMod = S.selectedModId ? P.modules.find(function(m) { return m.id === S.selectedModId; }) : null;
                if (selMod) {
                    var m = selMod;
                    var i = P.modules.indexOf(m);
                    h += '<div class="mod-spec-panel">';
                    var specCol = getModCatColor(m.type);
                    h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:12px">';
                    h += '<div style="flex:1"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><strong style="font-size:14px">' + (i + 1) + '. ' + m.name + '</strong><button class="opt-btn" style="padding:2px 8px;color:var(--color-error)" onclick="APP.delMod(\'' + m.id + '\')">' + svg('trash') + '</button></div></div>';
                    // SVG visual on the right
                    h += '<div style="width:80px;height:70px;flex-shrink:0;background:' + specCol.light + ';border-radius:8px;display:flex;align-items:center;justify-content:center;padding:6px">';
                    if (m.type === 'modulo' && m.zones) {
                        h += renderModulePreview(m, { w: 60, h: 60 });
                    } else {
                        h += modSvg(m.type);
                    }
                    h += '</div></div>';
                    h += '<div class="module-row"><span>Ancho:</span><div style="display:flex;gap:8px;flex-wrap:wrap">';
                    MODS[m.type].w.forEach(function(w) {
                        h += '<button class="opt-btn' + (m.width === w ? ' sel' : '') + '" onclick="APP.setModW(\'' + m.id + '\',' + w + ')">' + w + 'cm</button>';
                    });
                    if (MODS[m.type].custom)
                        h += '<input type="number" value="' + m.width + '" style="width:64px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModW(\'' + m.id + '\',parseInt(this.value))">';
                    h += '</div></div>';
                    // Per-module height
                    h += '<div class="module-row"><span>Alto:</span><input type="number" value="' + (m.height || '') + '" placeholder="' + (P.defaultHeight || 200) + 'cm" style="width:100px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModH(\'' + m.id + '\',this.value?parseInt(this.value):0)"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">cm (vacio = ' + P.defaultHeight + 'cm)</span></div>';
                    // Per-module depth (when sameDepth is false, or always for especial)
                    if (!P.sameDepth || m.type === 'especial') {
                        h += '<div class="module-row"><span>Prof.:</span><input type="number" value="' + (m.depth || P.defaultDepth || 50) + '" min="20" max="120" step="1" style="width:100px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModDepth(\'' + m.id + '\',parseInt(this.value))"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">cm</span></div>';
                    }
                    // Espacio til indicator  for modules with structural interior
                    var _skipEU = ['puerta', 'vistaLateral', 'panelRelleno', 'cubierta'];
                    if (_skipEU.indexOf(m.type) === -1) {
                        var _euTk = (S.project.thickness || 16) / 10; // cm
                        var _euH = (m.height || P.defaultHeight || 200) - (2 * _euTk);
                        h += '<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;margin:4px 0 8px 0;background:rgba(196,154,108,0.1);border:1px solid rgba(196,154,108,0.25);border-radius:8px">';
                        h += '<span style="font-size:12px;color:#c49a6c;font-weight:600">Espacio \u00DAtil:</span>';
                        h += '<span style="font-size:14px;color:var(--color-text-primary);font-weight:700">' + _euH.toFixed(1) + ' cm</span>';
                        h += '<span style="font-size:10px;color:var(--color-text-muted)">(' + (m.height || P.defaultHeight || 200) + ' - 2\u00D7' + _euTk.toFixed(1) + 'cm tapas)</span>';
                        h += '</div>';
                    }
                    if (m.type === 'modulo' && m.zones) {
                        // Zone editor with SVG side-by-side
                        h += '<div style="display:flex;gap:12px;align-items:flex-start">';
                        // Zone list
                        h += '<div style="flex:1;min-width:0">';
                        var totalH = m.height || S.project.defaultHeight || 200;
                        autoDistributeZones(m.zones, totalH);
                        m.zones.forEach(function(z, zi) {
                            var zt = CLOSET_ZONE_TYPES[z.type] || {};
                            h += '<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--color-border)">';
                            h += '<span style="font-size:14px">' + (zt.icon || '') + '</span>';
                            h += '<span style="flex:1;font-size:12px">' + (zt.n || z.type) + '</span>';
                            // Qty control for types that use qty
                            if (z.type === 'cajones' || z.type === 'zapatero' || z.type === 'entrepa' || z.type === 'entrepa_esp') {
                                h += '<span style="font-size:11px;color:var(--color-text-muted)">x</span>';
                                h += '<input type="number" value="' + (z.qty || 1) + '" min="1" max="10" style="width:40px;padding:3px;background:var(--color-bg-tertiary);border:none;border-radius:4px;color:var(--color-text-primary);text-align:center;font-size:11px" onchange="APP.setZoneQty(\'' + m.id + '\',' + zi + ',parseInt(this.value))">';
                                // Per-unit height input (unitH)
                                if (!zt.flexible) {
                                    h += '<span style="font-size:10px;color:var(--color-text-muted)">alto c/u</span>';
                                    h += '<input type="number" value="' + (z.unitH || zt.fixedH || 20) + '" min="5" max="60" step="1" style="width:40px;padding:3px;background:var(--color-bg-tertiary);border:none;border-radius:4px;color:var(--color-text-primary);text-align:center;font-size:11px" onchange="APP.setZoneUnitH(\'' + m.id + '\',' + zi + ',parseInt(this.value))" title="Alto por unidad (cm)">';
                                }
                            }
                            // Height display
                            h += '<span style="font-size:10px;color:var(--color-text-muted);min-width:32px;text-align:right">' + (z._h || 0) + 'cm</span>';
                            // Height override (for flexible zones only)
                            if (zt.flexible) {
                                h += '<input type="number" value="' + (z.heightOverride || '') + '" placeholder="auto" style="width:44px;padding:3px;background:var(--color-bg-tertiary);border:none;border-radius:4px;color:var(--color-text-primary);text-align:center;font-size:10px" onchange="APP.setZoneHeight(\'' + m.id + '\',' + zi + ',parseInt(this.value)||0)" title="Alto manual (0=auto)">';
                            }
                            // Corredera tier for cajones
                            if (z.type === 'cajones') {
                                h += '<select style="padding:2px 4px;background:var(--color-bg-tertiary);border:none;border-radius:4px;color:var(--color-text-primary);font-size:10px" onchange="APP.setZoneCorrTier(\'' + m.id + '\',' + zi + ',this.value)">';
                                [['corr_eco','Eco'],['corr_prem','Prem'],['corr_oculta','Oculta']].forEach(function(t) {
                                    h += '<option value="' + t[0] + '"' + ((z.corrTier || 'corr_eco') === t[0] ? ' selected' : '') + '>' + t[1] + '</option>';
                                });
                                h += '</select>';
                            }
                            // Move and delete
                            h += '<button class="opt-btn" style="padding:2px 6px;font-size:11px" onclick="APP.moveZone(\'' + m.id + '\',' + zi + ',-1)" title="Subir">\u25B2</button>';
                            h += '<button class="opt-btn" style="padding:2px 6px;font-size:11px" onclick="APP.moveZone(\'' + m.id + '\',' + zi + ',1)" title="Bajar">\u25BC</button>';
                            h += '<button class="opt-btn" style="padding:2px 6px;font-size:11px;color:var(--color-error)" onclick="APP.removeZone(\'' + m.id + '\',' + zi + ')" title="Eliminar">\u2715</button>';
                            h += '</div>';
                        });
                        // Add zone buttons
                        h += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:6px">';
                        for (var ztk in CLOSET_ZONE_TYPES) {
                            var ztd = CLOSET_ZONE_TYPES[ztk];
                            h += '<button class="opt-btn" style="font-size:10px;padding:3px 6px" onclick="APP.addZone(\'' + m.id + '\',\'' + ztk + '\')" title="' + ztd.desc + '">' + ztd.icon + ' ' + ztd.n + '</button>';
                        }
                        h += '</div>';
                        h += '</div>';
                        // SVG cross-section
                        h += '<div style="flex-shrink:0;width:120px;height:200px">' + renderModulePreview(m, { w: 120, h: 200 }) + '</div>';
                        h += '</div>';
                    }
                    if (m.type === 'torreLateral' || m.type === 'lateralAbierto' || m.type === 'despensa') {
                        h += '<div class="module-row"><span>Estantes:</span><div style="display:flex;gap:8px">';
                        [2, 3, 4, 5, 6, 7].forEach(function(n) {
                            h += '<button class="opt-btn' + ((m.shelves || 3) === n ? ' sel' : '') + '" onclick="APP.setModS(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (m.type === 'cajonBase') {
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : 3;
                        h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [1, 2, 3, 4, 5].forEach(function(n) {
                            h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (m.type === 'cajonera') {
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : 3;
                        h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [2, 3, 4].forEach(function(n) {
                            h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (m.type === 'bajoLavabo') {
                        // Cajones selector: 1 or 2 (default 2) per INSTRUCTIVO Section 4
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : 2;
                        h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [1, 2].forEach(function(n) {
                            h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (m.type === 'cajoneraBano') {
                        // Cajones selector: 2 or 3 (default 2) per INSTRUCTIVO Section 4
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : 2;
                        h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [2, 3].forEach(function(n) {
                            h += '<button class="opt-btn' + (mcaj === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (m.type === 'alacenaAventos') {
                        var aventosM = m.aventosModel || 'hk';
                        h += '<div class="module-row"><span>Aventos:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [['hk', 'HK-S'], ['hl', 'HL'], ['hs', 'HS']].forEach(function(opt) {
                            h += '<button class="opt-btn' + (aventosM === opt[0] ? ' sel' : '') + '" onclick="APP.setModAventos(\'' + m.id + '\',\'' + opt[0] + '\')">' + opt[1] + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (P.type !== 'cocina' && (m.type === 'alacenaEstandar' || m.type === 'alacenaSobreCampana')) {
                        var entCnt = typeof m.shelves === 'number' ? m.shelves : 1;
                        h += '<div class="module-row"><span>Entrepa\u00f1os:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [0, 1, 2, 3].forEach(function(n) {
                            h += '<button class="opt-btn' + (entCnt === n ? ' sel' : '') + '" onclick="APP.setModShelves(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (P.type !== 'cocina' && m.type === 'torreDespensa') {
                        var entCnt = typeof m.shelves === 'number' ? m.shelves : 4;
                        h += '<div class="module-row"><span>Entrepa\u00f1os:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [2, 3, 4, 5, 6].forEach(function(n) {
                            h += '<button class="opt-btn' + (entCnt === n ? ' sel' : '') + '" onclick="APP.setModShelves(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                        });
                        h += '</div></div>';
                    }
                    if (m.type === 'esquineroGiratorio') {
                        h += '<div class="module-row"><span>Ancho 2:</span><input type="number" value="' + (m.width2 || m.width) + '" min="30" max="120" step="10" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModW2(\'' + m.id + '\',parseInt(this.value))"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">cm (segundo lado)</span></div>';
                    }
                    if (m.type === 'puerta') {
                        // Puerta-specific: relleno type selector (drives bisagra count) + marco toggle
                        var relleno = m.relleno || 'honeycomb';
                        h += '<div class="module-row"><span>Relleno:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        var rellenoOpts = [['honeycomb', 'Honey-comb (ligera)'], ['peinazos', 'Peinazos pino'], ['solida', 'Solida (pesada)']];
                        rellenoOpts.forEach(function(r) {
                            h += '<button class="opt-btn' + (relleno === r[0] ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'relleno\',\'' + r[0] + '\')">' + r[1] + '</button>';
                        });
                        h += '</div></div>';
                        var bisHint = relleno === 'solida' ? '4 bisagras (puerta pesada)' : '3 bisagras';
                        h += '<div style="font-size:11px;color:var(--color-text-muted);margin:2px 0 4px 0">Bisagras: ' + bisHint + '</div>';
                        // Marco chambrana toggle
                        h += '<div class="module-row"><span>Marco:</span><button class="opt-btn' + (m.marco !== false ? ' sel' : '') + '" onclick="APP.togModProp(\'' + m.id + '\',\'marco\')">' + svg(m.marco !== false ? 'check' : 'plus') + ' Con marco chambrana</button></div>';
                    }
                    if (m.type === 'cubierta') {
                        var cubT = m.cubiertaType || 'postformado';
                        h += '<div class="module-row"><span>Tipo:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [['postformado', 'Postformado'], ['cuarzo', 'Cuarzo'], ['granito', 'Granito'], ['acero', 'Acero inox']].forEach(function(opt) {
                            h += '<button class="opt-btn' + (cubT === opt[0] ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'cubiertaType\',\'' + opt[0] + '\')">' + opt[1] + '</button>';
                        });
                        h += '</div></div>';
                    }
                    //  COCINAS: Kitchen-specific controls per KITCHEN_MODULE_CONTROLS 
                    if (P.type === 'cocina') {
                      try {
                        var _ktKey = KITCHEN_TYPE_MAP_REV[m.type];
                        var _ktCtrl = _ktKey ? KITCHEN_MODULE_CONTROLS[_ktKey] : null;
                        if (_ktCtrl) {
                            // Puertas count (bajoEstandar, bajoCooktop, alacenaEstandar, alacenaProfunda)
                            if (_ktCtrl.puertas && _ktCtrl.puertas.type === 'button_group') {
                                var _pCnt = typeof m.kitchenDoors === 'number' ? m.kitchenDoors : _ktCtrl.puertas.auto ? _ktCtrl.puertas.auto(m.width * 10) : _ktCtrl.puertas.options[0];
                                h += '<div class="module-row"><span>Puertas:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                _ktCtrl.puertas.options.forEach(function(n) {
                                    h += '<button class="opt-btn' + (_pCnt === n ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'kitchenDoors\',' + n + ')">' + n + '</button>';
                                });
                                h += '</div></div>';
                            }
                            // Entrepanos stepper (bajoEstandar, alacenaEstandar, alacenaProfunda, torreDespensa, torreMicroondas, isla)
                            if (_ktCtrl.entrepanos && _ktCtrl.entrepanos.type === 'stepper') {
                                var _eCnt = typeof m.shelves === 'number' ? m.shelves : _ktCtrl.entrepanos.default;
                                h += '<div class="module-row"><span>Entrepa\u00f1os:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                for (var _ei = _ktCtrl.entrepanos.min; _ei <= _ktCtrl.entrepanos.max; _ei++) {
                                    h += '<button class="opt-btn' + (_eCnt === _ei ? ' sel' : '') + '" onclick="APP.setModShelves(\'' + m.id + '\',' + _ei + ')">' + _ei + '</button>';
                                }
                                h += '</div></div>';
                            }
                            // Cajones button_group or stepper (bajo_cajones, bajo_cooktop, isla)
                            if (_ktCtrl.cajones && (_ktCtrl.cajones.type === 'button_group' || _ktCtrl.cajones.type === 'stepper')) {
                                var _cCnt = typeof m.cajones === 'number' ? m.cajones : _ktCtrl.cajones.default;
                                var _cOpts = _ktCtrl.cajones.options || [];
                                if (_ktCtrl.cajones.type === 'stepper') {
                                    _cOpts = [];
                                    for (var _ci = _ktCtrl.cajones.min; _ci <= _ktCtrl.cajones.max; _ci++) _cOpts.push(_ci);
                                }
                                h += '<div class="module-row"><span>Cajones:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                _cOpts.forEach(function(n) {
                                    h += '<button class="opt-btn' + (_cCnt === n ? ' sel' : '') + '" onclick="APP.setModC(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                                });
                                h += '</div></div>';
                            }
                            // Corredera type (bajo_cajones, bajo_horno, bajo_cooktop, torre_hornos, isla)
                            if (_ktCtrl.corredera && _ktCtrl.corredera.type === 'button_group') {
                                var _showCorr = true;
                                if (_ktCtrl.corredera.showIf) _showCorr = _ktCtrl.corredera.showIf(m);
                                if (_showCorr) {
                                    var _corrVal = m.corrTier || _ktCtrl.corredera.default;
                                    h += '<div class="module-row"><span>Corredera:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                    _ktCtrl.corredera.options.forEach(function(opt, idx) {
                                        var lbl = _ktCtrl.corredera.labels ? _ktCtrl.corredera.labels[idx] : opt;
                                        h += '<button class="opt-btn' + (_corrVal === opt ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'corrTier\',\'' + opt + '\')">' + lbl + '</button>';
                                    });
                                    h += '</div></div>';
                                }
                            }
                            // Montaje toggle (alacena_estandar, alacena_aventos, alacena_profunda)
                            if (_ktCtrl.montaje) {
                                var _montVal = m.montaje || _ktCtrl.montaje.default;
                                h += '<div class="module-row"><span>Montaje:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                _ktCtrl.montaje.options.forEach(function(opt, idx) {
                                    var lbl = _ktCtrl.montaje.labels ? _ktCtrl.montaje.labels[idx] : opt;
                                    h += '<button class="opt-btn' + (_montVal === opt ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'montaje\',\'' + opt + '\')">' + lbl + '</button>';
                                });
                                h += '</div></div>';
                            }
                            // AventosHojas (alacena_aventos)
                            if (_ktCtrl.aventosHojas) {
                                var _ahVal = typeof m.aventosHojas === 'number' ? m.aventosHojas : _ktCtrl.aventosHojas.default;
                                h += '<div class="module-row"><span>Hojas:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                _ktCtrl.aventosHojas.options.forEach(function(opt, idx) {
                                    var lbl = _ktCtrl.aventosHojas.labels ? _ktCtrl.aventosHojas.labels[idx] : opt;
                                    h += '<button class="opt-btn' + (_ahVal === opt ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'aventosHojas\',' + opt + ')">' + lbl + '</button>';
                                });
                                h += '</div></div>';
                            }
                            // Alto hueco horno (bajo_horno)
                            if (_ktCtrl.altoHueco) {
                                var _ahv = m.altoHueco || _ktCtrl.altoHueco.default;
                                h += '<div class="module-row"><span>' + _ktCtrl.altoHueco.label + ':</span><input type="number" value="' + _ahv + '" min="300" max="900" step="10" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModProp(\'' + m.id + '\',\'altoHueco\',parseInt(this.value))"></div>';
                            }
                            // Cajon horno position (bajo_horno)
                            if (_ktCtrl.cajonHorno) {
                                var _chVal = m.cajonHorno || _ktCtrl.cajonHorno.default;
                                h += '<div class="module-row"><span>Caj\u00f3n:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                _ktCtrl.cajonHorno.options.forEach(function(opt, idx) {
                                    var lbl = _ktCtrl.cajonHorno.labels ? _ktCtrl.cajonHorno.labels[idx] : opt;
                                    h += '<button class="opt-btn' + (_chVal === opt ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'cajonHorno\',\'' + opt + '\')">' + lbl + '</button>';
                                });
                                h += '</div></div>';
                            }
                            // Ancho campana (alacena_campana)
                            if (_ktCtrl.anchoCampana) {
                                var _acv = m.anchoCampana || _ktCtrl.anchoCampana.default;
                                h += '<div class="module-row"><span>' + _ktCtrl.anchoCampana.label + ':</span><input type="number" value="' + _acv + '" min="300" max="1200" step="10" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModProp(\'' + m.id + '\',\'anchoCampana\',parseInt(this.value))"></div>';
                            }
                            // WidthX / WidthY (esquinero_bajo, alacena_esquinera)
                            if (_ktCtrl.widthX) {
                                var _wxv = m.widthX || _ktCtrl.widthX.default;
                                h += '<div class="module-row"><span>' + _ktCtrl.widthX.label + ':</span><input type="number" value="' + _wxv + '" min="300" max="1200" step="10" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModProp(\'' + m.id + '\',\'widthX\',parseInt(this.value))"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">mm</span></div>';
                            }
                            if (_ktCtrl.widthY) {
                                var _wyv = m.widthY || _ktCtrl.widthY.default;
                                h += '<div class="module-row"><span>' + _ktCtrl.widthY.label + ':</span><input type="number" value="' + _wyv + '" min="300" max="1200" step="10" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModProp(\'' + m.id + '\',\'widthY\',parseInt(this.value))"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">mm</span></div>';
                            }
                            // Esquinero tipo (esquinero_bajo, alacena_esquinera)
                            if (_ktCtrl.esquineroTipo) {
                                var _etVal = m.esquineroTipo || _ktCtrl.esquineroTipo.default;
                                h += '<div class="module-row"><span>Tipo esquina:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                _ktCtrl.esquineroTipo.options.forEach(function(opt, idx) {
                                    var lbl = _ktCtrl.esquineroTipo.labels ? _ktCtrl.esquineroTipo.labels[idx] : opt;
                                    h += '<button class="opt-btn' + (_etVal === opt ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'esquineroTipo\',\'' + opt + '\')">' + lbl + '</button>';
                                });
                                h += '</div></div>';
                            }
                            // Alto micro (torre_hornos, torre_microondas)
                            if (_ktCtrl.altoMicro) {
                                var _amv = m.altoMicro || _ktCtrl.altoMicro.default;
                                h += '<div class="module-row"><span>' + _ktCtrl.altoMicro.label + ':</span><input type="number" value="' + _amv + '" min="300" max="600" step="10" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModProp(\'' + m.id + '\',\'altoMicro\',parseInt(this.value))"></div>';
                            }
                            // Alto horno (torre_hornos)
                            if (_ktCtrl.altoHorno) {
                                var _ahov = m.altoHorno || _ktCtrl.altoHorno.default;
                                h += '<div class="module-row"><span>' + _ktCtrl.altoHorno.label + ':</span><input type="number" value="' + _ahov + '" min="400" max="800" step="10" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModProp(\'' + m.id + '\',\'altoHorno\',parseInt(this.value))"></div>';
                            }
                            // Cajones intermedios (torre_hornos)
                            if (_ktCtrl.cajonesIntermedios) {
                                var _ciVal = typeof m.cajonesIntermedios === 'number' ? m.cajonesIntermedios : _ktCtrl.cajonesIntermedios.default;
                                h += '<div class="module-row"><span>Cajones intermedios:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                for (var _cii = _ktCtrl.cajonesIntermedios.min; _cii <= _ktCtrl.cajonesIntermedios.max; _cii++) {
                                    h += '<button class="opt-btn' + (_ciVal === _cii ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'cajonesIntermedios\',' + _cii + ')">' + _cii + '</button>';
                                }
                                h += '</div></div>';
                            }
                            // Metros lineales (zoclo)
                            if (_ktCtrl.metrosLineales) {
                                var _mlv = m.metrosLineales || _ktCtrl.metrosLineales.default;
                                h += '<div class="module-row"><span>' + _ktCtrl.metrosLineales.label + ':</span><input type="number" value="' + _mlv + '" min="0.1" max="20" step="0.1" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModProp(\'' + m.id + '\',\'metrosLineales\',parseFloat(this.value))"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">ml</span></div>';
                            }
                            // Alto zoclo (zoclo)
                            if (_ktCtrl.altoZoclo) {
                                var _azv = m.altoZoclo || _ktCtrl.altoZoclo.default;
                                h += '<div class="module-row"><span>' + _ktCtrl.altoZoclo.label + ':</span><input type="number" value="' + _azv + '" min="60" max="200" step="10" style="width:80px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setModProp(\'' + m.id + '\',\'altoZoclo\',parseInt(this.value))"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">mm</span></div>';
                            }
                            // Cubierta type selector (cubierta module via KITCHEN_MODULE_CONTROLS)
                            if (_ktCtrl.tipoCubierta) {
                                var _tcVal = m.cubiertaType || _ktCtrl.tipoCubierta.default;
                                h += '<div class="module-row"><span>Cubierta:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                _ktCtrl.tipoCubierta.options.forEach(function(opt, idx) {
                                    var lbl = _ktCtrl.tipoCubierta.labels ? _ktCtrl.tipoCubierta.labels[idx] : opt;
                                    h += '<button class="opt-btn' + (_tcVal === opt ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'cubiertaType\',\'' + opt + '\')">' + lbl + '</button>';
                                });
                                h += '</div></div>';
                            }
                            // Notes/warnings
                            if (_ktCtrl.nota) {
                                h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-warning)">\u26a0 ' + _ktCtrl.nota + '</div>';
                            }
                        }
                      } catch(ktErr) { console.error('KITCHEN CONTROLS ERROR:', ktErr, m.type); h += '<div style="color:red;padding:8px">Error renderizando controles cocina: ' + ktErr.message + '</div>'; }
                    }
                    // Puerta and extras types don't need module controls
                    if (m.type !== 'puerta' && m.type !== 'vistaLateral' && m.type !== 'panelRelleno' && m.type !== 'cubierta') {
                        // Zoclo toggle (moved up  renders for any module with m.zoclo)
                        if (m.zoclo) {
                            h += '<div class="module-row"><span>Zoclo:</span><button class="toggle' + (m.zoclo.enabled ? ' on' : '') + '" onclick="APP.togZoclo(\'' + m.id + '\')"></button></div>';
                            if (m.zoclo.enabled) {
                                h += '<div class="module-row"><span>Alto zoclo:</span><input type="number" value="' + m.zoclo.height + '" min="5" max="25" step="1" style="width:60px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setZocloH(\'' + m.id + '\',parseInt(this.value))"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">cm</span></div>';
                            }
                        }
                        // Maletero toggle (closet only  never shown for kitchens)
                        if (m.maletero && P.type !== 'cocina') {
                            h += '<div class="module-row"><span>Maletero:</span><button class="toggle' + (m.maletero.enabled ? ' on' : '') + '" onclick="APP.togModMaletero(\'' + m.id + '\')"></button><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">superior</span></div>';
                            if (m.maletero.enabled) {
                                h += '<div class="module-row"><span>Alto maletero:</span><input type="number" value="' + m.maletero.height + '" min="15" max="80" step="5" style="width:60px;padding:6px;background:var(--color-bg-tertiary);border:none;border-radius:8px;color:var(--color-text-primary);text-align:center" onchange="APP.setMaleteroH(\'' + m.id + '\',parseInt(this.value))"><span style="font-size:12px;color:var(--color-text-muted);margin-left:4px">cm</span></div>';
                                h += '<div style="font-size:11px;color:var(--color-text-muted);margin:2px 0 4px 0;padding-left:4px">El maletero se suma a la altura total, no resta espacio \u00FAtil</div>';
                            }
                        }
                        // Puertas controls
                        if (m.puertas) {
                            h += '<div class="module-row"><span>Puertas:</span><button class="toggle' + (m.puertas.enabled ? ' on' : '') + '" onclick="APP.togModPuertas(\'' + m.id + '\')"></button></div>';
                            if (m.puertas.enabled) {
                                var _p = m.puertas;
                                h += '<div style="padding:6px 0 4px 8px;border-left:2px solid rgba(196,154,108,0.3)">';
                                // Tipo
                                h += '<div class="module-row"><span style="font-size:12px">Tipo:</span><div style="display:flex;gap:6px">';
                                h += '<button class="opt-btn' + (_p.tipo === 'completa' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setModPuertaTipo(\'' + m.id + '\',\'completa\')">Completa</button>';
                                h += '<button class="opt-btn' + (_p.tipo === 'por_zona' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setModPuertaTipo(\'' + m.id + '\',\'por_zona\')">Por zona</button>';
                                h += '</div></div>';
                                // Cantidad
                                h += '<div class="module-row"><span style="font-size:12px">Cantidad:</span><div style="display:flex;gap:6px">';
                                [1, 2, 3, 4].forEach(function(n) {
                                    h += '<button class="opt-btn' + ((_p.cantidad || 2) === n ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setModPuertaCant(\'' + m.id + '\',' + n + ')">' + n + '</button>';
                                });
                                h += '</div></div>';
                                // Material
                                h += '<div class="module-row"><span style="font-size:12px">Material:</span><div style="display:flex;gap:6px">';
                                h += '<button class="opt-btn' + (_p.material === 'melamina' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setModPuertaMat(\'' + m.id + '\',\'melamina\')">Melamina</button>';
                                h += '<button class="opt-btn' + (_p.material === 'vidrio' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setModPuertaMat(\'' + m.id + '\',\'vidrio\')">Vidrio</button>';
                                h += '</div></div>';
                                // Apertura
                                h += '<div class="module-row"><span style="font-size:12px">Apertura:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                                h += '<button class="opt-btn' + (_p.apertura === 'tipon' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setModPuertaApert(\'' + m.id + '\',\'tipon\')">Push (Tip-On)</button>';
                                h += '<button class="opt-btn' + (_p.apertura === 'jaladera' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setModPuertaApert(\'' + m.id + '\',\'jaladera\')">Jaladera</button>';
                                h += '<button class="opt-btn' + (_p.apertura === 'perfil_gola' ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.setModPuertaApert(\'' + m.id + '\',\'perfil_gola\')">Perfil Gola</button>';
                                h += '</div></div>';
                                h += '</div>';
                            }
                        }
                        // Enchapado checkboxes
                        if (m.enchapado) {
                            h += '<div style="margin-top:6px"><span style="font-size:12px;color:var(--color-text-muted);font-weight:600">Cantos / Enchapado Perim\u00E9trico</span>';
                            h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px">';
                            var _eSides = [['latIzq', 'Lat. Izq'], ['latDer', 'Lat. Der'], ['techo', 'Techo'], ['piso', 'Piso']];
                            _eSides.forEach(function(es) {
                                h += '<button class="opt-btn' + (m.enchapado[es[0]] ? ' sel' : '') + '" style="font-size:11px;padding:3px 8px" onclick="APP.togEnchapado(\'' + m.id + '\',\'' + es[0] + '\')">' + svg(m.enchapado[es[0]] ? 'check' : 'plus') + ' ' + es[1] + '</button>';
                            });
                            h += '</div></div>';
                        }
                        // Quote mode
                        var qmC = m.quoteMode || 'completo';
                        h += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 6px 0">';
                        h += '<button class="opt-btn' + (qmC === 'completo' ? ' sel' : '') + '" onclick="APP.setQuoteMode(\'' + m.id + '\',\'completo\')">Completo</button>';
                        h += '<button class="opt-btn' + (qmC === 'solo_puertas' ? ' sel' : '') + '" style="' + (qmC === 'solo_puertas' ? 'background:#fbbf24;color:#000;border-color:#fbbf24' : '') + '" onclick="APP.setQuoteMode(\'' + m.id + '\',\'solo_puertas\')">Solo puertas</button>';
                        h += '</div>';
                        if (qmC === 'solo_puertas') {
                            h += '<div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:6px;padding:6px 10px;margin-bottom:6px;font-size:12px;color:#fbbf24">Solo puertas: la estructura no se cotiza</div>';
                        }
                    }
                    // LED & Paint as collapsible chip pills
                    var ledOn = m.led && m.led.enabled;
                    var paintOn = m.paint && m.paint.enabled;
                    h += '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">';
                    h += '<button class="chip-btn' + (ledOn ? ' active' : '') + '" onclick="APP.togLedPanel(\'' + m.id + '\')">\uD83D\uDCA1 LED' + (ledOn ? ' \u2713' : '') + '</button>';
                    h += '<button class="chip-btn' + (paintOn ? ' active-paint' : '') + '" onclick="APP.togPaintPanel(\'' + m.id + '\')">\uD83C\uDFA8 Pintura' + (paintOn ? ' \u2713' : '') + '</button>';
                    h += '</div>';
                    if (S.ledPanelOpen[m.id]) {
                        h += '<div class="chip-panel">' + renderModuleLed(m) + '</div>';
                    }
                    if (S.paintPanelOpen[m.id]) {
                        h += '<div class="chip-panel">' + renderModulePaint(m) + '</div>';
                    }
                    // Cocina-specific validation warnings
                    if (m.type === 'hornoBase' || m.type === 'torreHornos' || m.type === 'torreMicroondas') {
                        h += '<div class="module-row"><span>Ventilacion:</span><button class="opt-btn' + (m.ventilacion !== false ? ' sel' : '') + '" onclick="APP.togModProp(\'' + m.id + '\',\'ventilacion\')">' + svg(m.ventilacion !== false ? 'check' : 'plus') + ' Saque trasero 100mm</button></div>';
                        if (m.ventilacion === false) {
                            h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-warning)">\u26a0 Horno/microondas sin ventilacion trasera \u2014 riesgo de sobrecalentamiento</div>';
                        }
                    }
                    //  COCINAS: Kitchen validations (1G.6) 
                    if (P.type === 'cocina') {
                        var _wMm = m.width * 10;
                        var _hMm = (m.height || P.defaultHeight || 200) * 10;
                        // Min width 200mm
                        if (_wMm < 200 && m.type !== 'panelRelleno') {
                            h += '<div style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-error)">\u274c Ancho minimo 200mm. Actual: ' + _wMm + 'mm</div>';
                        }
                        // Towers min height 1800mm
                        var _isTower = ['torreDespensa','torreHornos','torreMicroondas','torreRefrigerador','torreLimpieza'].indexOf(m.type) !== -1;
                        if (_isTower && _hMm < 1800) {
                            h += '<div style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-error)">\u274c Torres: alto minimo 1800mm. Actual: ' + _hMm + 'mm</div>';
                        }
                        // Esquinero: both widthX and widthY required
                        if ((m.type === 'esquineroCiego' || m.type === 'alacenaEsquinera') && (!m.widthX || !m.widthY)) {
                            h += '<div style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-error)">\u274c Esquinero: ambos anchos (X e Y) son obligatorios</div>';
                        }
                        // 1G.7: Non-blocking warnings
                        if ((m.type === 'fregadero' || m.type === 'hornoBase') && P.matInterior) {
                            var _matN = (P.matInterior.name || '').toUpperCase();
                            if (_matN.indexOf('RH') === -1 && _matN.indexOf('RESISTENTE') === -1) {
                                h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-warning)">\u26a0 Zona humeda/calor \u2014 considera MDF RH para el casco</div>';
                            }
                        }
                    }
                    // TV: repisaFlotante variant selector (hueca vs herraje)
                    if (m.type === 'repisaFlotante') {
                        var repVariant = m.variant || 'hueca';
                        h += '<div class="module-row"><span>Tipo de Repisa:</span><div style="display:flex;gap:6px;flex-wrap:wrap">';
                        [['hueca', 'Caja hueca'], ['herraje', 'Herraje oculto']].forEach(function(opt) {
                            h += '<button class="opt-btn' + (repVariant === opt[0] ? ' sel' : '') + '" onclick="APP.setModProp(\'' + m.id + '\',\'variant\',\'' + opt[0] + '\')">' + opt[1] + '</button>';
                        });
                        h += '</div></div>';
                        if (repVariant === 'herraje') {
                            h += '<div style="background:rgba(196,154,108,0.1);border:1px solid rgba(196,154,108,0.3);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:#c49a6c">Minimo 38mm de grosor para herraje oculto (espigon de metal)</div>';
                        }
                    }
                    // TV: torreLateralTV open/closed toggle (noPuertas = open nicho)
                    if (m.type === 'torreLateralTV') {
                        h += '<div class="module-row"><span>Configuracion:</span><button class="opt-btn' + (m.noPuertas ? ' sel' : '') + '" onclick="APP.togModProp(\'' + m.id + '\',\'noPuertas\')">' + svg(m.noPuertas ? 'check' : 'plus') + ' Sin puerta (nichos abiertos)</button></div>';
                    }
                    if (m.type === 'fregadero' || m.type === 'bajoLavabo' || m.type === 'cajoneraBano' || m.type === 'botiquin') {
                        var matI = P.matInterior || {};
                        var matF = P.matFrentes || {};
                        var matIName = (matI.name || '').toUpperCase();
                        var matFName = (matF.name || '').toUpperCase();
                        var isRH = (matIName.indexOf('RH') !== -1 || matIName.indexOf('RESISTENTE') !== -1)
                                && (matFName.indexOf('RH') !== -1 || matFName.indexOf('RESISTENTE') !== -1);
                        if (!isRH) {
                            h += '<div style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-error)">\uD83D\uDD34 Zona humeda \u2014 usar MDF RH (Resistente a Humedad) obligatorio. Material actual no es MDF-RH.</div>';
                        }
                    }
                    // Anti-vuelco warning for tall closet modules (>1,500mm = 150cm)
                    if (MODS[m.type] && MODS[m.type].forType && MODS[m.type].forType.indexOf('closet') !== -1 && m.height > 150) {
                        h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-warning)">\u26a0 Anti-vuelco: modulo > 1,500mm de alto. Anclar a pared con taquetes obligatorio.</div>';
                    }
                    if (MODS[m.type] && !MODS[m.type].custom && MODS[m.type].w && MODS[m.type].w.indexOf(m.width) === -1) {
                        h += '<div style="background:rgba(250,204,21,0.15);border:1px solid rgba(250,204,21,0.4);border-radius:6px;padding:6px 10px;margin:4px 0;font-size:12px;color:var(--color-warning)">\u26a0 Ancho ' + m.width + 'cm no es estandar para ' + MODS[m.type].n + ' (estandar: ' + MODS[m.type].w.join(', ') + 'cm)</div>';
                    }
                    h += '<p class="module-desc" style="color:var(--color-text-muted)">' + MODS[m.type].d + '</p>';
                    h += '</div>'; // close mod-spec-panel
                } // end if (selMod)
            }
            // Hardware section
            h += '<div class="hw-selected"><h4>' + svg('settings') + ' Herrajes <span style="font-size:12px;color:var(--color-text-muted);font-weight:400">(auto + manual)</span></h4>';
            var c = null;
            try { c = P.modules.length > 0 ? calc() : null; } catch(calcErr2) { console.error('CALC2 ERROR:', calcErr2); }
            if (c) {
                for (var k in c.hwConsolidated) {
                    var hw = c.hwConsolidated[k];
                    h += '<div class="hw-sel-item"><span class="hw-sel-marca ' + marcaClass(hw.marca) + '">' + hw.marca + '</span><span class="hw-sel-name">' + hw.desc + '</span><span style="color:var(--color-text-muted);font-size:12px">x' + Math.ceil(hw.qty) + '</span><span class="hw-sel-price">' + fmtD(Math.ceil(hw.qty) * hw.price) + '</span></div>';
                }
            }
            if (P.hardware.length > 0) {
                P.hardware.forEach(function(h2, idx) {
                    h += '<div class="hw-sel-item"><span class="hw-sel-marca ' + marcaClass(h2.marca) + '">' + h2.marca + '</span><span class="hw-sel-name">' + h2.descripcion + '</span>';
                    h += '<div class="hw-sel-qty"><button onclick="APP.hwQty(' + idx + ',-1)">-</button><strong>' + h2.qty + '</strong><button onclick="APP.hwQty(' + idx + ',1)">+</button></div>';
                    h += '<span class="hw-sel-price">' + fmtD(h2.qty * adjPrice(h2)) + '</span></div>';
                });
            }
            h += '<button class="hw-add-btn" onclick="APP.openHWPicker()">' + svg('plus') + ' Agregar herraje del catalogo</button>';
            h += '</div>';
            // Extras
            h += '<div class="extra-section"><label style="font-size:14px;color:var(--color-text-primary);display:block;margin-bottom:12px">Extras</label>';
            h += '<div class="extra-row"><div style="display:flex;align-items:center">' + svg('layers') + ' Vidrio Templado</div><button class="toggle' + (P.glass ? ' on' : '') + '" onclick="APP.togGlass()"></button></div>';
            if (P.glass)
                h += '<div class="extra-input"><span>Metros2 vidrio:</span><input type="number" value="' + P.glassM2 + '" min="0" step="0.1" onchange="APP.setGlassM2(parseFloat(this.value))"></div>';
            h += '</div>';
            return h;
        }

        function step3(c) {
            var P = S.project;
            var h = '<div class="title"><h2>Resumen de Costeo</h2><p>Carpinter\u00eda x' + CONFIG.pricing.carpentryMultiplier + ' | Herrajes premium ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%</p></div>';

            // Bento Grid
            h += '<div class="bento-grid">';

            // Carpinteria card
            h += '<div class="card"><div class="card-title">' + svg('layers') + ' Carpinteria</div>';
            if (c.totalSheetsF > 0) {
                h += '<div class="cost-row"><span>Material Frentes (' + c.totalSheetsF + ' hojas)</span><strong>' + fmt(c.matCostF) + '</strong></div>';
            }
            if (c.useDual && c.totalSheetsI > 0) {
                h += '<div class="cost-row"><span>Material Interior (' + c.totalSheetsI + ' hojas)</span><strong>' + fmt(c.matCostI) + '</strong></div>';
            }
            if (c.cantoF > 0)
                h += '<div class="cost-row"><span>Chapacanto' + (c.useDual ? ' Frentes' : '') + ' (' + c.cantoF + ' ml)</span><strong>' + fmt(c.chapCostF) + '</strong></div>';
            if (c.useDual && c.cantoI > 0)
                h += '<div class="cost-row"><span>Chapacanto Interior (' + c.cantoI + ' ml)</span><strong>' + fmt(c.chapCostI) + '</strong></div>';
            h += '<div class="cost-row"><span>Corte (' + c.totalSheets + ' hojas x $75)</span><strong>' + fmt(c.corteCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Enchapado (' + c.totalCanto + ' ml x $' + (typeof P.enchapPrice === 'number' ? P.enchapPrice : 13) + ')</span><strong>' + fmt(c.enchapCost) + '</strong></div>';
            h += '<div class="cost-row"><span>Mano de obra</span><strong>' + fmt(P.laborCost) + '</strong></div>';
            if (P.freight)
                h += '<div class="cost-row"><span>Flete</span><strong>' + fmt(P.freightCost) + '</strong></div>';
            h += '<div class="cost-total"><span>Costo Carpinteria</span><strong>' + fmt(c.carpCost) + '</strong></div>';
            h += '<div class="cost-row" style="margin-top:4px"><span>Venta (carp + hw std) x' + CONFIG.pricing.carpentryMultiplier + '</span><strong style="color:#ffffff">' + fmt(c.carpSale) + '</strong></div></div>';

            // Labor config card with pill presets
            h += '<div class="card"><div class="card-title">' + svg('users') + ' Mano de Obra</div>';
            h += '<div style="margin-bottom:12px"><span style="font-size:13px;color:#bbb">Costo:</span>';
            h += '<div class="labor-input"><span>$</span><input type="number" value="' + P.laborCost + '" min="0" step="500" onchange="APP.setLabor(parseFloat(this.value))"></div>';
            h += '<div class="labor-pills" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:6px">';
            [{l:'$3k',v:3000},{l:'$5k',v:5000},{l:'$8k',v:8000},{l:'$12k',v:12000},{l:'$15k',v:15000}].forEach(function(p) {
                h += '<button class="labor-pill' + (P.laborCost === p.v ? ' sel' : '') + '" style="padding:4px 10px;border-radius:6px;border:1px solid var(--color-border);background:' + (P.laborCost === p.v ? '#c49a6c' : 'none') + ';color:' + (P.laborCost === p.v ? '#000' : 'var(--color-text-secondary)') + ';font-size:12px;cursor:pointer" onclick="APP.setLabor(' + p.v + ')">' + p.l + '</button>';
            });
            h += '</div></div>';
            h += '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px"><span style="color:#bbb">Flete:</span>';
            if (P.freight)
                h += '<div class="labor-input" style="flex:1;max-width:120px"><span>$</span><input type="number" value="' + P.freightCost + '" min="0" step="100" onchange="APP.setFreightCost(parseFloat(this.value))"></div>';
            h += '<button class="toggle' + (P.freight ? ' on' : '') + '" onclick="APP.togFreight()"></button></div></div>';

            // Herrajes card  carpentry bucket
            if (c.hwCostCarpBucket > 0) {
                h += '<div class="card"><div class="card-title">' + svg('settings') + ' Herrajes (en carp. x' + CONFIG.pricing.carpentryMultiplier + ')</div>';
                h += '<div style="font-size:11px;color:#999;margin-bottom:6px">\u2264 $' + CONFIG.pricing.hardwareThreshold + '</div>';
                c.allHW.forEach(function(hw) {
                    if (hw._bucket !== 'carp') return;
                    h += '<div class="cost-row"><span class="' + marcaClass(hw.marca) + '">' + hw.desc + ' x' + Math.ceil(hw.qty) + '</span><strong>' + fmtD(Math.ceil(hw.qty) * hw.price) + '</strong></div>';
                });
                h += '<div class="cost-total"><span>Subtotal herrajes (en carp.)</span><strong>' + fmt(c.hwCostCarpBucket) + '</strong></div></div>';
            }

            // Premium hardware card
            if (c.hwCostPremium > 0) {
                h += '<div class="card"><div class="card-title">' + svg('lock') + ' Herrajes Premium <span style="font-size:11px;color:#999;font-weight:400">' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%</span></div>';
                h += '<div style="font-size:11px;color:#999;margin-bottom:6px">> $' + CONFIG.pricing.hardwareThreshold + '</div>';
                c.allHW.forEach(function(hw) {
                    if (hw._bucket !== 'premium') return;
                    h += '<div class="cost-row"><span class="' + marcaClass(hw.marca) + '">' + hw.desc + ' x' + Math.ceil(hw.qty) + '</span><strong>' + fmtD(Math.ceil(hw.qty) * hw.price) + '</strong></div>';
                });
                h += '<div class="cost-total"><span>Costo Premium</span><strong>' + fmt(c.hwCostPremium) + '</strong></div>';
                h += '<div class="cost-row" style="margin-top:4px"><span>Venta (' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong style="color:#ffffff">' + fmt(c.hwPremiumSale) + '</strong></div></div>';
            }

            // Extras card (spans full width if present)
            if (c.extraCost > 0) {
                h += '<div class="card span-2"><div class="card-title">' + svg('zap') + ' Extras (x' + CONFIG.pricing.extrasMultiplier + ')</div>';
                if (c.ledBOM) {
                    h += '<div style="font-size:12px;color:#fbbf24;font-weight:600;margin-bottom:4px">LED (' + c.ledBOM.totalMeters.toFixed(1) + 'm | ' + c.ledBOM.totalSegments + ' seg | ' + c.ledBOM.alimentadorW + 'W)</div>';
                    c.ledBOM.items.forEach(function(it) {
                        h += '<div class="cost-row"><span style="font-size:12px">' + it.qty + 'x ' + it.desc + '</span><strong>' + fmtD(it.total) + '</strong></div>';
                    });
                    h += '<div class="cost-row" style="border-top:1px solid #3a3a3a;padding-top:4px;margin-top:4px"><span style="color:#fbbf24">Subtotal LED</span><strong style="color:#fbbf24">' + fmtD(c.ledBOM.totalCost) + '</strong></div>';
                }
                if (c.cubiertaCost > 0)
                    h += '<div class="cost-row"><span>Cubierta (' + (c.cubiertaM2 || 0).toFixed(2) + ' m\u00b2)</span><strong>' + fmt(c.cubiertaCost) + '</strong></div>';
                if (P.glass)
                    h += '<div class="cost-row"><span>Vidrio (' + P.glassM2 + 'm2)</span><strong>' + fmt(P.glassM2 * CONFIG.pricing.glassCostPerM2) + '</strong></div>';
                if (c.paintCost > 0) {
                    P.modules.forEach(function(m2, mi2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'custom',
                                defaultHeight: P.defaultHeight,
                                defaultDepth: P.defaultDepth
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                h += '<div class="cost-row"><span>Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' ' + m2.name + ' (' + lit.toFixed(1) + 'L)</span><strong>' + fmtD(Math.round(lit * m2.paint.pricePerLiter)) + '</strong></div>';
                        }
                    });
                }
                h += '<div class="cost-total"><span>Costo Extras</span><strong>' + fmt(c.extraCost) + '</strong></div>';
                h += '<div class="cost-row" style="margin-top:4px"><span>Venta (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong style="color:#ffffff">' + fmt(c.extrasSale) + '</strong></div></div>';
            }

            // Subtotales por Categoria (cocina only)  spans full width
            if (P.type === 'cocina') {
                h += '<div class="card span-2"><div class="card-title">' + svg('layers') + ' Subtotales por Categoria</div>';
                h += '<div class="cost-row"><span>Casco (material interior + canto)</span><strong>' + fmt(c.cascoCost) + '</strong></div>';
                h += '<div class="cost-row"><span>Frente (material visible + canto)</span><strong>' + fmt(c.frenteCost) + '</strong></div>';
                h += '<div class="cost-row"><span>Herrajes (std + premium)</span><strong>' + fmt(c.herrajesCost) + '</strong></div>';
                if (c.extrasCost > 0)
                    h += '<div class="cost-row"><span>Extras (LED, vidrio, cubierta, pintura)</span><strong>' + fmt(c.extrasCost) + '</strong></div>';
                h += '</div>';
            }

            h += '</div>'; // close bento-grid

            // Profit Hero Card
            h += '<div class="profit-hero">';
            h += '<div class="hero-label">Resumen de Venta</div>';
            h += '<div class="hero-row"><span>Carpinter\u00eda (incl. herrajes std)</span><strong>' + fmt(c.carpSale) + '</strong></div>';
            if (c.hwCostPremium > 0)
                h += '<div class="hero-row"><span>Herrajes Premium</span><strong>' + fmt(c.hwPremiumSale) + '</strong></div>';
            if (c.extrasSale > 0)
                h += '<div class="hero-row"><span>Extras</span><strong>' + fmt(c.extrasSale) + '</strong></div>';
            h += '<div class="hero-row" style="padding-top:6px;border-top:1px solid rgba(255,255,255,0.08)"><span>SUBTOTAL</span><strong style="color:var(--color-text-primary)">' + fmt(c.subtotal) + '</strong></div>';
            h += '<div class="hero-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong style="color:var(--color-text-secondary)">' + fmt(c.iva) + '</strong></div>';
            h += '<div class="hero-row total"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div>';
            h += '<div style="display:flex;align-items:center;gap:12px;margin-top:8px">';
            h += '<div class="hero-row cost" style="flex:1"><span>Costo real</span><strong>' + fmt(c.totalCost) + '</strong></div>';
            h += '<div class="hero-row profit" style="flex:1"><span>Utilidad</span><strong>' + fmt(c.profit) + '</strong></div>';
            h += '<span class="hero-margin">' + c.margin + '%</span>';
            h += '</div></div>';

            // Sheet Gauge
            if (c.pieces && c.pieces.length > 0) {
                var sheets = calcSheets(c.pieces);
                if (sheets.total > 0) {
                    var pctCasco = Math.round((sheets.casco / sheets.total) * 100);
                    var pctFrente = 100 - pctCasco;
                    h += '<div class="sheet-gauge">';
                    h += '<div class="sheet-gauge-title">' + svg('layers') + ' Laminas Necesarias <span style="font-weight:400;color:#a0e0be">(1220\u00d72440mm, +20% merma)</span></div>';
                    h += '<div class="sheet-gauge-bar">';
                    if (sheets.casco > 0)
                        h += '<div class="sheet-gauge-seg casco" style="width:' + pctCasco + '%">' + sheets.casco + '</div>';
                    if (sheets.frente > 0)
                        h += '<div class="sheet-gauge-seg frente" style="width:' + pctFrente + '%">' + sheets.frente + '</div>';
                    h += '</div>';
                    h += '<div class="sheet-gauge-legend">';
                    h += '<span><span class="dot" style="background:#059669"></span> Casco <strong>' + sheets.casco + '</strong></span>';
                    h += '<span><span class="dot" style="background:#0d9488"></span> Frente <strong>' + sheets.frente + '</strong></span>';
                    h += '<span style="color:#4a9">Total <strong>' + sheets.total + '</strong> laminas</span>';
                    h += '</div></div>';
                }
            }

            // Internal Breakdown Accordion
            h += '<div class="cost-bd-accordion">';
            h += '<button class="cost-bd-toggle" onclick="APP.togCostBD()"><span><span class="lock-icon">\uD83D\uDD12</span>Desglose de Costos (Interno)</span> ' + svg(S.showCostBreakdown ? 'chevDown' : 'right') + '</button>';
            if (S.showCostBreakdown) {
                h += '<div class="cost-bd-lock">Solo para uso interno \u2014 no se comparte con el cliente</div>';
                h += '<div class="cost-bd-body">';
                h += '<div class="cost-bd-section"><h5>Carpinteria</h5>';
                if (c.totalSheetsF > 0)
                    h += '<div class="cost-bd-row"><span>Mat. Frentes ' + c.totalSheetsF + ' hojas</span><strong>' + fmt(c.matCostF) + '</strong></div>';
                if (c.useDual && c.totalSheetsI > 0)
                    h += '<div class="cost-bd-row"><span>Mat. Interior ' + c.totalSheetsI + ' hojas</span><strong>' + fmt(c.matCostI) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Chapacanto</span><strong>' + fmt(c.chapCostF + c.chapCostI) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Corte + Enchapado</span><strong>' + fmt(c.corteCost + c.enchapCost) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Mano de obra</span><strong>' + fmt(P.laborCost) + '</strong></div>';
                if (P.freight)
                    h += '<div class="cost-bd-row"><span>Flete</span><strong>' + fmt(P.freightCost) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Costo carp.</span><strong>' + fmt(c.carpCost) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Venta (carp + hw std) x' + CONFIG.pricing.carpentryMultiplier + '</span><strong>' + fmt(c.carpSale) + '</strong></div></div>';
                h += '<div class="cost-bd-section"><h5>Herrajes</h5>';
                h += '<div class="cost-bd-row"><span>En carpinter\u00eda (\u2264$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostCarpBucket) + '</strong></div>';
                h += '<div class="cost-bd-row"><span>Premium (>$' + CONFIG.pricing.hardwareThreshold + ')</span><strong>' + fmt(c.hwCostPremium) + '</strong></div>';
                h += '<div class="cost-bd-subtotal"><span>Venta premium (' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)</span><strong>' + fmt(c.hwPremiumSale) + '</strong></div></div>';
                if (c.extraCost > 0) {
                    h += '<div class="cost-bd-section"><h5>Extras</h5>';
                    if (c.ledBOM)
                        h += '<div class="cost-bd-row"><span>LED (' + c.ledBOM.totalMeters.toFixed(1) + 'm)</span><strong>' + fmtD(c.ledBOM.totalCost) + '</strong></div>';
                    if (P.glass)
                        h += '<div class="cost-bd-row"><span>Vidrio (' + P.glassM2 + 'm2)</span><strong>' + fmt(P.glassM2 * CONFIG.pricing.glassCostPerM2) + '</strong></div>';
                    if (c.paintCost > 0)
                        h += '<div class="cost-bd-row"><span>Pintura</span><strong>' + fmtD(c.paintCost) + '</strong></div>';
                    h += '<div class="cost-bd-subtotal"><span>Costo extras</span><strong>' + fmt(c.extraCost) + '</strong></div>';
                    h += '<div class="cost-bd-subtotal"><span>Venta (x' + CONFIG.pricing.extrasMultiplier + ')</span><strong>' + fmt(c.extrasSale) + '</strong></div></div>';
                }
                h += '<div class="cost-bd-grand">';
                h += '<div class="cost-bd-grand-row"><span>Subtotal</span><strong>' + fmt(c.subtotal) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
                h += '<div class="cost-bd-grand-row total"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div>';
                h += '<div class="cost-bd-grand-row" style="margin-top:8px;border-top:1px solid #3a3a3a;padding-top:8px"><span>Costo real</span><strong>' + fmt(c.totalCost) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>Utilidad real</span><strong>' + fmt(c.profit) + '</strong></div>';
                h += '<div class="cost-bd-grand-row"><span>Margen real</span><strong>' + c.margin + '%</strong></div>';
                h += '</div></div>';
            }
            h += '</div>';
            return h;
        }

        function step4(c) {
            var P = S.project,
                v = S.view;
            var h = '<div class="title"><h2>' + (v === 'quote' ? 'Cotizacion' : 'Despiece') + '</h2></div>';
            h += '<div class="tabs"><button class="tab' + (v === 'quote' ? ' sel' : '') + '" onclick="APP.setView(\'quote\')">' + svg('file') + ' Cotizacion</button>';
            h += '<button class="tab' + (v === 'cutlist' ? ' sel' : '') + '" onclick="APP.setView(\'cutlist\')">' + svg('clip') + ' Despiece</button></div>';
            if (v === 'quote') {
                var type = TYPES.find(function(t) {
                    return t.id === P.type;
                });
                h += '<div class="quote"><div class="quote-hdr"><h2>' + (BRANDS[S.brand] || BRANDS.primary).name + '</h2><p>' + (BRANDS[S.brand] || BRANDS.primary).tagline + '</p></div><div class="quote-body">';
                h += '<div class="quote-info"><div><span>Cliente:</span><p>' + (P.client || 'Sin nombre') + '</p></div><div><span>Fecha:</span><p>' + date() + '</p></div></div>';
                var matDesc = P.matFrentes.brand + ' ' + P.matFrentes.name;
                if (c.useDual)
                    matDesc += ' (frentes) + ' + P.matInterior.brand + ' ' + P.matInterior.name + ' (interior)';
                h += '<div class="quote-project"><span>Proyecto:</span><h3>' + (type ? type.n : '') + '</h3><p>Material: ' + matDesc + '</p></div>';
                h += '<div class="quote-mods"><h4>Modulos:</h4>';
                P.modules.forEach(function(m, i) {
                    var mInfo = m.width + 'cm';
                    if (m.height)
                        mInfo += ' x ' + m.height + 'cm';
                    var mcaj = typeof m.cajones === 'number' ? m.cajones : (m.type === 'modulo' ? 4 : 0);
                    if (m.type === 'modulo' && mcaj === 0)
                        mInfo += ' (' + (typeof m.shelves === 'number' ? m.shelves : 3) + ' ent.)';
                    else if (mcaj > 0)
                        mInfo += ' (' + mcaj + ' caj.)';
                    h += '<div class="quote-mod"><span>' + (i + 1) + '. ' + m.name + '</span><span>' + mInfo + '</span></div>';
                });
                h += '</div>';
                if (c.ledBOM || P.glass) {
                    h += '<div class="quote-extras"><h4>Extras:</h4>';
                    if (c.ledBOM)
                        h += '<p>- Iluminacion LED perimetral completa</p>';
                    if (P.glass)
                        h += '<p>- Vidrio templado 6mm</p>';
                    h += '</div>';
                }
                h += '<div class="quote-price"><div class="quote-price-row"><span>Subtotal</span><strong>' + fmt(c.subtotal) + '</strong></div>';
                h += '<div class="quote-price-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong>' + fmt(c.iva) + '</strong></div>';
                h += '<div class="quote-total"><span>TOTAL</span><strong>' + fmt(c.total) + '</strong></div></div>';
                var _ht = CONFIG.quoting.htmlTerms.map(function(t) { return t.replace('{anticipo}', CONFIG.quoting.defaultAnticipo).replace('{deliveryTime}', CONFIG.quoting.defaultDelivery); });
                h += '<div class="quote-terms"><h4>Condiciones:</h4>' + _ht.map(function(t) { return '<p>- ' + t + '</p>'; }).join('') + '</div>';
                h += '<div class="quote-contact"><p>&#x1f4de; ' + CONTACT.cell + '</p><p>&#x1f4e7; ' + CONTACT.email + '</p></div>';
                h += '</div></div>';
            } else {
                h += '<div class="quote"><div class="cut-hdr"><h2>DESPIECE PARA COMSA</h2><p>' + (P.client || 'Sin nombre') + ' - ' + date() + '</p>';
                h += '<p style="font-size:14px;opacity:0.85">Frentes: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '</p>';
                if (c.useDual)
                    h += '<p style="font-size:14px;opacity:0.6">Interior: ' + P.matInterior.brand + ' ' + P.matInterior.name + '</p>';
                if (P.chapSpec)
                    h += '<p style="font-size:13px;color:var(--color-accent, #c49a6c)">Chapacanto: ' + P.chapSpec + '</p>';
                h += '</div><div class="cut-body">';
                h += '<div class="cut-summary"><div class="cut-box"><strong>' + c.totalSheets + '</strong><span>Hojas Total</span></div><div class="cut-box"><strong>' + c.totalCanto + '</strong><span>ML Canto</span></div></div>';
                var tk = c.projThickness || 16;
                h += '<div style="padding:12px;background:var(--color-bg-card, rgba(40,40,40,0.5));border:1px solid var(--color-border);border-radius:8px;margin-bottom:16px"><h4 style="font-weight:700;margin-bottom:8px;color:var(--color-text-primary)">Hojas (' + tk + 'mm):</h4>';
                if (c.useDual) {
                    h += '<p style="font-size:12px;color:var(--color-info);margin-bottom:4px;font-weight:600">FRENTES:</p>';
                    if (c.totalSheetsF > 0)
                        h += '<p style="font-size:14px;color:var(--color-text-secondary)">  ' + tk + 'mm: ' + c.totalSheetsF + ' hojas</p>';
                    h += '<p style="font-size:12px;color:var(--color-text-muted);margin:8px 0 4px;font-weight:600">INTERIOR:</p>';
                    if (c.totalSheetsI > 0)
                        h += '<p style="font-size:14px;color:var(--color-text-secondary)">  ' + tk + 'mm: ' + c.totalSheetsI + ' hojas</p>';
                } else {
                    var sAll = c.totalSheetsF + c.totalSheetsI;
                    if (sAll > 0)
                        h += '<p style="font-size:14px;color:var(--color-text-secondary)">' + tk + 'mm: ' + sAll + ' hojas</p>';
                }
                h += '</div>';
                // Reset edits button (placed above tables)
                if (Object.keys(S.editedPieces).length > 0) {
                    h += '<button class="cut-reset-btn" onclick="APP.resetEdits()">Restaurar medidas calculadas</button>';
                }
                P.modules.forEach(function(m) {
                    var pcs = c.pieces.filter(function(p) {
                        return p.mid === m.id;
                    });
                    pcs.sort(function(a, b) {
                        var alA = anchoLargo(a.w, a.h),
                            alB = anchoLargo(b.w, b.h);
                        return alB.largo - alA.largo;
                    });
                    var mHdr = m.name + ' ' + m.width + 'cm';
                    if (m.height)
                        mHdr += ' x ' + m.height + 'cm';
                    h += '<div class="cut-module"><div class="cut-module-hdr">' + mHdr + '</div><div class="cut-module-body">';
                    // Table with sticky headers
                    h += '<table class="cut-table"><thead><tr>';
                    h += '<th>Pieza</th>';
                    h += '<th class="col-num">Cant</th>';
                    h += '<th class="col-num">Ancho</th>';
                    h += '<th class="col-num">Largo</th>';
                    h += '<th class="col-num">Esp.</th>';
                    if (c.useDual) h += '<th class="col-zone">Zona</th>';
                    h += '</tr></thead><tbody>';
                    pcs.forEach(function(p) {
                        var al = anchoLargo(p.w, p.h);
                        var eKey = m.id + ':' + p.n;
                        var ep = S.editedPieces[eKey] || {};
                        var isEdited = !!S.editedPieces[eKey];
                        var eq = typeof ep.q === 'number' ? ep.q : p.q;
                        var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                        var el = typeof ep.largo === 'number' ? ep.largo : al.largo;
                        var editedQty = typeof ep.q === 'number';
                        var editedA = typeof ep.ancho === 'number';
                        var editedL = typeof ep.largo === 'number';
                        h += '<tr' + (isEdited ? ' class="cut-row-edited"' : '') + '>';
                        h += '<td class="col-name">' + p.n + '</td>';
                        h += '<td class="col-num"><input type="number" class="cut-input cut-input-qty' + (editedQty ? ' cut-input-edited' : '') + '" value="' + eq + '" min="0" onchange="APP.editPiece(\'' + eKey + '\',\'q\',parseInt(this.value))"></td>';
                        h += '<td class="col-num"><input type="number" class="cut-input' + (editedA ? ' cut-input-edited' : '') + '" value="' + ea + '" min="0" onchange="APP.editPiece(\'' + eKey + '\',\'ancho\',parseInt(this.value))"></td>';
                        h += '<td class="col-num"><input type="number" class="cut-input' + (editedL ? ' cut-input-edited' : '') + '" value="' + el + '" min="0" onchange="APP.editPiece(\'' + eKey + '\',\'largo\',parseInt(this.value))"></td>';
                        h += '<td class="col-num" style="color:var(--color-text-muted)">' + p.t + 'mm</td>';
                        if (c.useDual)
                            h += '<td class="col-zone"><span class="cut-badge ' + (p.z === 'f' ? 'cut-badge-f' : 'cut-badge-i') + '">' + (p.z === 'f' ? 'Frentes' : 'Interior') + '</span></td>';
                        h += '</tr>';
                    });
                    h += '</tbody></table>';
                    h += '</div></div>';
                });
                h += '<div style="padding:12px;background:var(--color-bg-card, rgba(40,40,40,0.5));border:1px solid var(--color-border);border-radius:8px"><h4 style="font-weight:700;margin-bottom:8px;color:var(--color-text-primary)">Herrajes:</h4>';
                c.allHW.forEach(function(hw) {
                    h += '<p style="font-size:14px;color:var(--color-text-secondary)">- ' + hw.desc + ': ' + Math.ceil(hw.qty) + ' (' + hw.marca + ')</p>';
                });
                h += '</div></div></div>';
            }
            h += '';
            return h;
        }

        function buildHWListHTML(items, isSwap) {
            var h = '';
            if (items.length === 0) {
                h += '<div style="text-align:center;padding:32px;color:var(--color-text-muted)">Sin resultados</div>';
            } else {
                var lastCat = '';
                items.forEach(function(item) {
                    if (item.categoria !== lastCat) {
                        lastCat = item.categoria;
                        h += '<div class="hw-cat-hdr">' + item.categoria + '</div>';
                    }
                    var hwArr = S.project.hardware;
                    var inCart = hwArr.find(function(x) {
                        return x.codigo === item.codigo;
                    });
                    h += '<div class="hw-item"' + (isSwap ? ' style="flex-wrap:wrap"' : '') + '>';
                    h += '<div class="hw-item-info"><div class="hw-item-name">' + item.descripcion + '</div><div class="hw-item-meta"><span class="hw-sel-marca ' + marcaClass(item.marca) + '">' + item.marca + '</span> ' + item.codigo + ' | ' + item.unidad + '</div></div>';
                    h += '<div class="hw-item-price">' + fmtD(adjPrice(item)) + '</div>';
                    if (isSwap) {
                        h += '<button style="width:100%;margin-top:6px;padding:10px 12px;border-radius:8px;border:none;background:#c49a6c;color:var(--color-text-inverted);font-weight:700;cursor:pointer;font-size:14px" onclick="APP.hwCartAdd(\'' + item.codigo + '\')">Seleccionar</button>';
                    } else if (inCart) {
                        h += '<div class="hw-item-qty"><button onclick="APP.hwCartQty(\'' + item.codigo + '\',-1)">-</button><strong>' + inCart.qty + '</strong><button onclick="APP.hwCartQty(\'' + item.codigo + '\',1)">+</button></div>';
                    } else {
                        h += '<button style="padding:6px 12px;border-radius:6px;border:none;background:#ffffff;color:var(--color-text-inverted);font-weight:600;cursor:pointer;font-size:12px" onclick="APP.hwCartAdd(\'' + item.codigo + '\')">+ Agregar</button>';
                    }
                    h += '</div>';
                });
                if (items.length >= 60)
                    h += '<div style="text-align:center;padding:16px;color:var(--color-text-muted);font-size:13px">Mostrando primeros 60 resultados. Usa filtros para refinar.</div>';
            }
            return h;
        }

        function renderHWPicker() {
            if (!S.showHWPicker)
                return '';
            var items = filterHW();
            var cats = getHWCats();
            var marcas = getHWMarcas();
            var h = '<div class="hw-picker" onclick="APP.closeHWPicker(event)">';
            h += '<div class="hw-picker-content" onclick="event.stopPropagation()">';
            h += '<div class="hw-picker-hdr"><h3>' + svg('search') + ' Catalogo de Herrajes</h3><button class="modal-close" onclick="APP.closeHWPicker()">' + svg('x') + '</button></div>';
            h += '<input class="hw-search" type="text" placeholder="Buscar por nombre o codigo..." value="' + (S.hwFilter.q || '') + '" oninput="APP.hwSearch(this.value)" id="hwSearchInput">';
            // Marca filters (collapsed when selected)
            h += '<div class="hw-filters">';
            if (S.hwFilter.marca) {
                h += '<button class="hw-chip sel" onclick="APP.hwFilterMarca(\'\')">' + S.hwFilter.marca + ' &times;</button>';
            } else {
                h += '<span style="font-size:11px;color:var(--color-text-muted);white-space:nowrap">Marca:</span>';
                marcas.forEach(function(m) {
                    h += '<button class="hw-chip" onclick="APP.hwFilterMarca(\'' + m + '\')">' + m + '</button>';
                });
            }
            h += '</div>';
            // Category filters (collapsed when selected)
            h += '<div class="hw-filters">';
            if (S.hwFilter.cat) {
                h += '<button class="hw-chip sel" onclick="APP.hwFilterCat(\'\')">' + S.hwFilter.cat + ' &times;</button>';
            } else {
                h += '<span style="font-size:11px;color:var(--color-text-muted);white-space:nowrap">Categor\u00eda:</span>';
                cats.forEach(function(c2) {
                    h += '<button class="hw-chip" onclick="APP.hwFilterCat(\'' + c2 + '\')">' + c2 + '</button>';
                });
            }
            h += '</div>';
            h += '<div class="hw-list" id="hwListContainer">' + buildHWListHTML(items, false) + '</div></div></div>';
            return h;
        }

        function renderSettings() {
            if (!S.showSettings)
                return '';
            var s = S.settings;
            var h = '<div class="settings-overlay" onclick="APP.closeSettings(event)">';
            h += '<div class="settings-panel" onclick="event.stopPropagation()">';
            h += '<div class="settings-hdr"><h3>' + svg('settings') + ' Configuracion</h3><button class="modal-close" onclick="APP.closeSettings()">' + svg('x') + '</button></div>';
            h += '<div class="settings-body">';
            h += '<div class="settings-section"><h4>Ajuste Precio Proveedores</h4>';
            ['ARAUCO', 'HERRAXA', 'BLUM', 'HAFELE'].forEach(function(m) {
                h += '<div class="supplier-row"><span class="' + marcaClass(m) + '">' + m + '</span><input type="number" value="' + (s.supplierAdj[m] || 0) + '" onchange="APP.setSupplierAdj(\'' + m + '\',parseFloat(this.value))">%</div>';
            });
            h += '</div>';
            // Brand selector
            h += '<div class="settings-section"><h4>Marca Activa</h4>';
            h += '<div class="brand-toggle">';
            for (var bk in BRANDS) {
                var b = BRANDS[bk];
                h += '<button class="brand-btn' + (S.brand === bk ? ' sel' : '') + '" onclick="APP.setBrand(\'' + bk + '\')"><span class="mono">' + b.mono + '</span>' + b.name + '</button>';
            }
            h += '</div></div>';
            // Logo upload
            h += '<div class="settings-section"><h4>Logo de Empresa</h4>';
            h += '<div class="logo-section">';
            h += '<div class="logo-preview">';
            if (S.logoBase64)
                h += '<img src="' + S.logoBase64 + '">';
            else {
                var abr = BRANDS[S.brand] || BRANDS.primary;
                h += '<div style="font-size:24px;font-weight:700;color:#c49a6c">' + abr.mono + '</div>';
            }
            h += '</div>';
            h += '<div class="logo-btns"><button class="upload" onclick="APP.uploadLogo()">Subir logo</button>';
            if (S.logoBase64)
                h += '<button class="remove" onclick="APP.removeLogo()">Quitar</button>';
            h += '</div></div></div>';
            // Quote counter
            h += '<div class="settings-section"><h4>Numero de Cotizacion</h4>';
            h += '<div class="margin-row"><label>Siguiente #</label><input type="number" value="' + S.quoteCounter + '" min="1" onchange="APP.setQuoteCounter(parseInt(this.value))"></div>';
            h += '<p style="font-size:12px;color:var(--color-text-muted);margin-top:4px">El mismo n\u00famero se usa en PDF Cliente e Interno</p>';
            h += '</div>';
            h += '</div></div></div>';
            return h;
        }

        function nav() {
            var canNext = S.step === 1 ? S.project.type !== '' : S.step === 2 ? S.project.modules.length > 0 : true;
            var h = '<div class="nav">';
            if (S.step === 1)
                h += '<button class="nav-btn back" onclick="APP.goHome()">' + svg('left') + ' Plantillas</button>';
            else if (S.step > 1)
                h += '<button class="nav-btn back" onclick="APP.goStep(' + (S.step - 1) + ')">' + svg('left') + ' Atras</button>';
            if (S.step < 4)
                h += '<button class="nav-btn next" onclick="APP.next()"' + (canNext ? '' : ' disabled') + '>' + (S.step === 3 ? 'Ver Cotizacion' : 'Siguiente') + svg('right') + '</button>';
            if (S.step === 4)
                h += '<button class="nav-btn next" style="background:#c49a6c;color:var(--color-text-inverted)" onclick="APP.next()">Generar PDF ' + svg('right') + '</button>';
            h += '</div>';
            return h;
        }

        function step5(c) {
            var P = S.project,
                d = S.pdfData;
            if (!d) {
                APP.initPdfData();
                d = S.pdfData;
            }
            var br = BRANDS[S.brand] || BRANDS.primary;
            var h = '<div class="title"><h2>Generar Cotizacion</h2><p>Revisa y edita antes de generar</p></div>';
            // Brand selector
            h += '<div class="brand-toggle">';
            for (var bk in BRANDS) {
                var b = BRANDS[bk];
                h += '<button class="brand-btn' + (S.brand === bk ? ' sel' : '') + '" onclick="APP.setBrand(\'' + bk + '\')"><span class="mono">' + b.mono + '</span>' + b.name + '</button>';
            }
            h += '</div>';
            // Editable fields
            h += '<div class="pdf-field"><label>Cliente</label><input type="text" value="' + (d.client || '') + '" oninput="APP.setPdfField(\'client\',this.value)"></div>';
            h += '<div class="pdf-field"><label>Proyecto</label><input type="text" value="' + (d.projectName || '') + '" oninput="APP.setPdfField(\'projectName\',this.value)"></div>';
            h += '<div class="pdf-field"><label>Ubicacion</label><input type="text" value="' + (d.location || '') + '" placeholder="Ciudad, Estado" oninput="APP.setPdfField(\'location\',this.value)"></div>';
            h += '<div style="display:flex;gap:12px">';
            h += '<div class="pdf-field" style="flex:1"><label>No. Cotizacion</label><input type="text" value="' + (d.quoteNum || '') + '" oninput="APP.setPdfField(\'quoteNum\',this.value)"></div>';
            h += '<div class="pdf-field" style="flex:1"><label>Entrega</label><input type="text" value="' + (d.deliveryTime || '') + '" oninput="APP.setPdfField(\'deliveryTime\',this.value)"></div>';
            h += '</div>';
            h += '<div class="pdf-field"><label>Anticipo %</label><input type="number" value="' + (d.anticipo || CONFIG.quoting.defaultAnticipo) + '" min="0" max="100" onchange="APP.setPdfField(\'anticipo\',parseInt(this.value))"></div>';
            // Line items  one per module
            h += '<div class="pdf-items"><label style="font-size:14px;color:var(--color-text-primary);display:block;margin-bottom:4px">Modulos del proyecto (aparecen en el PDF)</label>';
            h += '<p style="font-size:12px;color:var(--color-text-muted);margin-bottom:12px">Cada modulo es una linea en la tabla de cotizacion. Edita descripcion y precio.</p>';
            d.items.forEach(function(item, i) {
                h += '<div class="pdf-item">';
                h += '<div class="pdf-item-hdr" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
                h += '<strong style="color:var(--color-info);font-size:13px">' + (item.name || 'Modulo ' + (i + 1)) + '</strong>';
                h += '<div style="display:flex;align-items:center;gap:4px"><span style="color:var(--color-text-secondary);font-size:12px">Precio:</span><span style="color:var(--color-text-secondary)">$</span><input class="pdf-item-price" type="number" value="' + item.price + '" onchange="APP.setPdfItemPrice(' + i + ',parseFloat(this.value))" style="width:100px"></div>';
                h += '</div>';
                h += '<textarea class="pdf-item-desc" oninput="APP.setPdfItemDesc(' + i + ',this.value)" rows="5">' + item.desc + '</textarea>';
                h += '<div style="font-size:12px;color:var(--color-text-muted);margin-top:4px">Medidas: ' + item.dims + '</div>';
                h += '</div>';
            });
            h += '</div>';
            // Totals
            var itemTotal = d.items.reduce(function(a, it) {
                return a + it.price;
            }, 0);
            var iva = itemTotal * CONFIG.pricing.iva;
            var total = itemTotal + iva;
            h += '<div class="pdf-totals">';
            h += '<div class="pdf-totals-row"><span>Subtotal</span><strong style="font-family:monospace">' + fmt(itemTotal) + '</strong></div>';
            h += '<div class="pdf-totals-row"><span>IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%</span><strong style="font-family:monospace">' + fmt(iva) + '</strong></div>';
            h += '<div class="pdf-totals-row grand"><span>TOTAL</span><strong style="font-family:monospace">' + fmt(total) + '</strong></div>';
            h += '</div>';
            // Notes
            h += '<div class="pdf-field"><label>Notas especiales</label><textarea oninput="APP.setPdfField(\'notes\',this.value)">' + (d.notes || '') + '</textarea></div>';
            // Action buttons
            h += '<div class="pdf-actions">';
            h += '<button class="pdf-btn client" onclick="APP.genClientPDF()">&#x1f4c4; PDF Cliente</button>';
            h += '<button class="pdf-btn internal" onclick="APP.genInternalPDF()">&#x1f512; PDF Interno</button>';
            h += '<button class="pdf-btn despiece" onclick="APP.genDespiece()">&#x1f4cb; PDF Despiece</button>';
            h += '</div>';
            return h;
        }

        // PDF generation helpers
        function getBrandSvgDataUrl(brandId) {
            var b = BRANDS[brandId] || BRANDS.primary;
            var svgStr = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 80"><rect width="200" height="80" rx="12" fill="#1a1a2e"/><text x="100" y="52" font-size="36" font-weight="bold" text-anchor="middle" font-family="Helvetica,Arial,sans-serif" fill="#c49a6c">' + b.mono + '</text></svg>';
            return 'data:image/svg+xml;base64,' + btoa(svgStr);
        }

        function getQuoteNum() {
            var yr = new Date().getFullYear();
            var num = S.pdfData ? S.pdfData.quoteNum : CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
            return num;
        }

        function fmtDatePDF() {
            var d = new Date();
            var months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return d.getDate() + '/' + months[d.getMonth()] + '/' + d.getFullYear();
        }

        function sanitize(s) {
            return (s || '').replace(/[<>&"']/g, '');
        }

        // Height/depth helpers for plano page rendering
        function planoModHeight(m) {
            return m && m.height || 200;
        }
        function planoEspacioUtil(m) {
            var tk = (S.project && S.project.thickness || 16);
            return planoModHeight(m) - (2 * tk / 10);
        }
        function planoCalcFixedHeight(m) {
            var tk = (S.project && S.project.thickness || 16) / 10;
            var h = 0;
            var numZones = m.zones ? m.zones.length : 0;
            var espHasColg = m.type === 'especial' && m.zones && m.zones.some(function(z) { return z.type === 'colgador'; });
            if (m.type === 'especial' && !espHasColg) return planoEspacioUtil(m);
            if (m.zones) m.zones.forEach(function(z) {
                if (z.type === 'cajones') h += (z.qty || z.count || 1) * (z.unitH || z.cajonHeight || 20);
                else if (z.type === 'zapatero') h += (z.qty || z.repisas || 3) * (z.unitH || z.repisaHeight || 15);
                else if (z.type === 'entrepa' || z.type === 'entrepa_esp') h += (z.qty || z.count || 2) * tk;
            });
            if (numZones > 1) h += (numZones - 1) * tk;
            return h;
        }
        function planoColgadorHeight(m, z) {
            var eu = planoEspacioUtil(m);
            var fixed = planoCalcFixedHeight(m);
            var numColg = m.zones ? m.zones.filter(function(x) { return x.type === 'colgador'; }).length : 0;
            if (numColg <= 0) return 0;
            return Math.max(0, Math.round((eu - fixed) / numColg));
        }
        function planoFreeSpace(m) {
            return planoEspacioUtil(m) - planoCalcFixedHeight(m);
        }
        function planoZoneDisplayHeight(m, z) {
            // Use z._h from autoDistributeZones if available (iteration-10 custom flow)
            if (z._h && z._h > 0) return z._h;
            if (z.type === 'cajones') return (z.qty || z.count || 1) * (z.unitH || z.cajonHeight || 20);
            if (z.type === 'colgador') return planoColgadorHeight(m, z);
            if (z.type === 'zapatero') return (z.qty || z.repisas || 3) * (z.unitH || z.repisaHeight || 15);
            if (z.type === 'entrepa' || z.type === 'entrepa_esp') {
                var espColg = m.type === 'especial' && m.zones && m.zones.some(function(x) { return x.type === 'colgador'; });
                if (m.type === 'especial' && !espColg) return planoEspacioUtil(m) / (z.qty || z.count || 2);
                var free = planoFreeSpace(m);
                if (free > 0) return free / ((z.qty || z.count || 2) + 1);
                return (z.qty || z.count || 2) * ((S.project && S.project.thickness || 16) / 10);
            }
            return 0;
        }

        function addPlanoPage(doc, margin) {
            var EP = S.project;
            if (!EP || !EP.modules || EP.modules.length === 0)
                return;
            var plano = EP.planoImage;
            doc.addPage('letter', 'l'); // landscape for more horizontal space
            var pw = 279.4,
                ph = 215.9; // letter landscape mm
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            // Header
            doc.setFillColor(accent[0], accent[1], accent[2]);
            doc.rect(0, 0, pw, 12, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('PLANO DEL PROYECTO', margin, 9);

            if (plano) {
                // User-uploaded image
                var maxW = pw - 2 * margin,
                    maxH = ph - 28;
                try {
                    var img = new Image();
                    img.src = plano;
                    var iw = img.naturalWidth || 1,
                        ih = img.naturalHeight || 1;
                    var ratio = Math.min(maxW / iw, maxH / ih);
                    var drawW = iw * ratio,
                        drawH = ih * ratio;
                    var cx = margin + (maxW - drawW) / 2;
                    var imgFmt = plano.indexOf('data:image/png') === 0 ? 'PNG' : 'JPEG';
                    doc.addImage(plano, imgFmt, cx, 18, drawW, drawH);
                } catch (e) {
                    doc.setFontSize(10);
                    doc.setTextColor(180, 0, 0);
                    doc.text('Error al cargar imagen del plano', margin, 30);
                }
            } else {
                // Draw module visuals
                var tk = (EP.thickness || 16) / 10;
                var modules = EP.modules;
                var totalW = 0;
                modules.forEach(function(m) {
                    totalW += m.width;
                });
                var nMods = modules.length;
                // Dynamic gap: smaller when many modules
                var modGap = nMods <= 3 ? 10 : nMods <= 5 ? 6 : 4;
                var totalGap = (nMods - 1) * modGap;
                var availW = pw - 2 * margin - totalGap;
                // Reserve space at bottom: module details list + legend + specs line
                var detailLines = nMods + 3; // nMods lines + header + legend + specs
                var reservedBottom = detailLines * 3.5 + 16;
                var availH = ph - 24 - reservedBottom; // 24 = top header area
                var maxModH = 0;
                modules.forEach(function(m) {
                    var mH = planoModHeight(m);
                    if (mH > maxModH)
                        maxModH = mH;
                });
                // Account for maletero/zoclo in max visual height
                var maxVisH = maxModH;
                modules.forEach(function(m) {
                    var vH = planoModHeight(m);
                    if (m.maletero && m.maletero.enabled)
                        vH += (m.maletero.height || 30);
                    if (m.zoclo && m.zoclo.enabled)
                        vH += (m.zoclo.height || 10);
                    if (vH > maxVisH)
                        maxVisH = vH;
                });
                var scale = Math.min(availW / totalW, availH / maxVisH);
                if (scale > 1.2)
                    scale = 1.2;

                // Check if we need 2 rows (very small scale)
                var useRows = 1;
                if (scale < 0.3 && nMods > 3) {
                    useRows = 2;
                    // Recalculate for 2 rows
                    var modsPerRow = Math.ceil(nMods / 2);
                    var row1W = 0,
                        row2W = 0;
                    modules.forEach(function(m, i) {
                        if (i < modsPerRow)
                            row1W += m.width;
                        else
                            row2W += m.width;
                    });
                    var maxRowW = Math.max(row1W, row2W);
                    var rowGaps = (modsPerRow - 1) * modGap;
                    var rowAvailW = pw - 2 * margin - rowGaps;
                    var rowAvailH = (availH - 15) / 2; // 15mm gap between rows
                    scale = Math.min(rowAvailW / maxRowW, rowAvailH / maxVisH);
                    if (scale > 1.2)
                        scale = 1.2;
                }

                var rowStartY = 24; // leave room for module number labels above visuals
                var modsPerRow = useRows > 1 ? Math.ceil(nMods / 2) : nMods;
                // Zone colors (RGB) for PDF
                var zColors = {
                    techo: [80, 80, 80],
                    piso: [80, 80, 80],
                    cajones: [196, 154, 108],
                    colgador: [96, 165, 250],
                    zapatero: [139, 92, 246],
                    entrepa: [120, 120, 120],
                    libre: [200, 200, 200],
                    maletero: [234, 179, 8],
                    zoclo: [139, 92, 60]
                };
                // Center modules horizontally: calculate total drawn width per row
                var row1W = 0,
                    row2W = 0;
                modules.forEach(function(m, i) {
                    var w = m.width * scale;
                    if (i < modsPerRow)
                        row1W += w;
                    else
                        row2W += w;
                });
                row1W += (Math.min(nMods, modsPerRow) - 1) * modGap;
                if (useRows > 1 && nMods > modsPerRow)
                    row2W += (nMods - modsPerRow - 1) * modGap;
                var contentArea = pw - 2 * margin;
                var curX = margin + (contentArea - row1W) / 2;
                // Track the bottom-most Y for legend placement
                var maxBottomY = 0;
                doc.setFontSize(8);
                modules.forEach(function(m, mi) {
                    // Ensure zone heights are computed
                    if (m.type === 'modulo' && m.zones) {
                        autoDistributeZones(m.zones, m.height || EP.defaultHeight || 200);
                    }
                    // Row management
                    if (useRows > 1 && mi === modsPerRow) {
                        curX = margin + (contentArea - row2W) / 2;
                        rowStartY = rowStartY + maxVisH * scale + 25;
                    }
                    var mH = planoModHeight(m);
                    var W = m.width * scale;
                    var H = mH * scale;
                    var eu = planoEspacioUtil(m);
                    var fixed = planoCalcFixedHeight(m);
                    var hasColg = m.zones && m.zones.some(function(z) {
                        return z.type === 'colgador';
                    });
                    var isEsp = m.type === 'especial';
                    var freeSpace = eu - fixed;
                    var barX = curX;
                    var barW = W;
                    var barH = H;
                    // Maletero above module body
                    var malObj = m.maletero || {
                        enabled: false,
                        height: 30
                    };
                    var malH2 = malObj.enabled ? (malObj.height || 30) * scale : 0;
                    // Module body starts after maletero
                    var bodyY = rowStartY + malH2;
                    // Draw maletero above the body
                    if (malObj.enabled) {
                        doc.setFillColor(zColors.maletero[0], zColors.maletero[1], zColors.maletero[2]);
                        doc.rect(barX, rowStartY, barW, malH2, 'F');
                        doc.setDrawColor(180, 150, 0);
                        doc.rect(barX, rowStartY, barW, malH2);
                        doc.setTextColor(80, 60, 0);
                        doc.setFontSize(6);
                        doc.text((malObj.height || 30) + 'cm', barX + barW / 2, rowStartY + malH2 / 2 + 1, {
                            align: 'center'
                        });
                    }
                    // Module body outline
                    doc.setDrawColor(150, 150, 150);
                    doc.setLineWidth(0.3);
                    if (m.type !== 'esquinero')
                        doc.rect(barX, bodyY, barW, barH);
                    // Techo (skip for fijo)
                    var segY = bodyY;
                    var tkH = tk * scale;
                    if (m.type !== 'fijo') {
                        doc.setFillColor(zColors.techo[0], zColors.techo[1], zColors.techo[2]);
                        doc.rect(barX, segY, barW, tkH, 'F');
                        doc.setFontSize(6);
                        doc.setTextColor(180, 180, 180);
                        doc.text('T', barX + barW / 2, segY + tkH - 0.5, {
                            align: 'center'
                        });
                        segY += tkH;
                    }
                    // Zones  array is already topbottom, draw in order
                    var hasDoors = false;
                    (m.zones || []).forEach(function(z) {
                        var zh = planoZoneDisplayHeight(m, z);
                        var segH2 = zh * scale;
                        var col = zColors[z.type] || [160, 160, 160];
                        var zoneStartY = segY; // track start for door lines
                        if ((z.type === 'entrepa' || z.type === 'entrepa_esp') && (isEsp || (!hasColg && freeSpace > 0))) {
                            var cnt = z.qty || z.count || 2;
                            var spaceForEnt = isEsp ? eu : freeSpace;
                            var totalSegH = spaceForEnt * scale;
                            var entLineH = tk * scale * 0.5;
                            var sectionH = (totalSegH - cnt * entLineH) / (cnt + 1);
                            for (var si = 0; si < cnt + 1; si++) {
                                doc.setFillColor(240, 240, 240);
                                doc.rect(barX + 0.5, segY, barW - 1, Math.max(1, sectionH), 'F');
                                segY += Math.max(1, sectionH);
                                if (si < cnt) {
                                    doc.setFillColor(col[0], col[1], col[2]);
                                    doc.rect(barX + 0.5, segY, barW - 1, Math.max(0.5, entLineH), 'F');
                                    segY += Math.max(0.5, entLineH);
                                }
                            }
                        } else if (z.type === 'colgador') {
                            doc.setFillColor(col[0], col[1], col[2]);
                            doc.setGState(new doc.GState({
                                opacity: 0.3
                            }));
                            doc.rect(barX + 0.5, segY, barW - 1, segH2, 'F');
                            doc.setGState(new doc.GState({
                                opacity: 1
                            }));
                            doc.setDrawColor(col[0], col[1], col[2]);
                            doc.setLineDashPattern([1, 1], 0);
                            doc.rect(barX + 0.5, segY, barW - 1, segH2);
                            doc.setLineDashPattern([], 0);
                            var tuboY2 = segY + Math.min(4, segH2 * 0.3);
                            doc.setDrawColor(col[0], col[1], col[2]);
                            doc.setLineWidth(0.5);
                            doc.line(barX + 3, tuboY2, barX + barW - 3, tuboY2);
                            doc.setLineWidth(0.3);
                            doc.setFontSize(6);
                            doc.setTextColor(col[0], col[1], col[2]);
                            doc.text(Math.round(zh) + 'cm', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else if (z.type === 'cajones') {
                            var cCnt = z.qty || z.count || 3;
                            var cUnitH = segH2 / cCnt;
                            for (var ci = 0; ci < cCnt; ci++) {
                                doc.setFillColor(col[0], col[1], col[2]);
                                doc.rect(barX + 0.5, segY + ci * cUnitH, barW - 1, Math.max(1, cUnitH - 0.5), 'F');
                            }
                            doc.setFontSize(6);
                            doc.setTextColor(255, 255, 255);
                            doc.text(cCnt + 'C', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else if (z.type === 'zapatero') {
                            var zCnt = z.qty || z.repisas || 3;
                            var zUnitH = segH2 / zCnt;
                            for (var zzi = 0; zzi < zCnt; zzi++) {
                                doc.setFillColor(col[0], col[1], col[2]);
                                doc.rect(barX + 0.5, segY + zzi * zUnitH, barW - 1, Math.max(1, zUnitH - 0.5), 'F');
                            }
                            doc.setFontSize(6);
                            doc.setTextColor(255, 255, 255);
                            doc.text(zCnt + 'Z', barX + barW / 2, segY + segH2 / 2 + 1, {
                                align: 'center'
                            });
                            segY += segH2;
                        } else {
                            doc.setFillColor(col[0], col[1], col[2]);
                            doc.rect(barX + 0.5, segY, barW - 1, segH2, 'F');
                            segY += segH2;
                        }
                        if (z.doors)
                            hasDoors = true;
                    });
                    // Check for puertas (new m.puertas object or legacy m.doors)
                    if (m.puertas && m.puertas.enabled) hasDoors = true;
                    var pdfDoorMode = (m.puertas && m.puertas.enabled) ? m.puertas.tipo : (m.doorMode || 'por_zona');
                    if (m.doors && pdfDoorMode === 'completa')
                        hasDoors = true;
                    // Piso (skip for fijo)
                    if (m.type !== 'fijo') {
                        doc.setFillColor(zColors.piso[0], zColors.piso[1], zColors.piso[2]);
                        doc.rect(barX, segY, barW, tkH, 'F');
                        doc.setFontSize(6);
                        doc.setTextColor(180, 180, 180);
                        doc.text('P', barX + barW / 2, segY + tkH - 0.5, {
                            align: 'center'
                        });
                        segY += tkH;
                    }
                    // Zoclo (below module body)
                    var zoc2 = m.zoclo || {
                        enabled: false,
                        height: 10
                    };
                    if (zoc2.enabled) {
                        var zocH2 = (zoc2.height || 10) * scale;
                        doc.setFillColor(zColors.zoclo[0], zColors.zoclo[1], zColors.zoclo[2]);
                        doc.rect(barX, segY, barW, zocH2, 'F');
                        doc.setFontSize(5);
                        doc.setTextColor(255, 255, 255);
                        doc.text('Z', barX + barW / 2, segY + zocH2 / 2 + 1, {
                            align: 'center'
                        });
                        segY += zocH2;
                    }
                    // Door indicator  spans full module body
                    if (hasDoors) {
                        var pdfDoorCnt = (m.puertas && m.puertas.enabled) ? (m.puertas.cantidad || 2) : ((m.doors && pdfDoorMode === 'completa') ? (m.doorCount || 2) : 2);
                        doc.setDrawColor(196, 154, 108);
                        doc.setLineWidth(0.4);
                        doc.line(barX, bodyY, barX, bodyY + barH);
                        doc.line(barX + barW, bodyY, barX + barW, bodyY + barH);
                        if (pdfDoorCnt >= 2) {
                            doc.line(barX + barW / 2, bodyY, barX + barW / 2, bodyY + barH);
                        }
                        doc.setLineWidth(0.3);
                    }
                    // Esquinero L-shape visual
                    if (m.type === 'esquinero') {
                        var esqArmW = Math.max(barW * 0.45, 6);
                        var esqTopH = Math.max(barH * 0.38, 6);
                        var esqMaskBot = Math.max(segY, bodyY + barH);
                        // Mask bottom-right notch area with white
                        doc.setFillColor(255, 255, 255);
                        doc.rect(barX + esqArmW, bodyY + esqTopH, barW - esqArmW + 1, esqMaskBot - bodyY - esqTopH + 1, 'F');
                        // Draw L-shaped outline
                        doc.setDrawColor(150, 150, 150);
                        doc.setLineWidth(0.3);
                        doc.lines([
                        [barW, 0], [0, esqTopH], [-(barW - esqArmW), 0], [0, barH - esqTopH], [-esqArmW, 0], [0, -barH]
                        ], barX, bodyY, [1, 1], 'S', true);
                        // Lado A / Lado B labels
                        doc.setFontSize(5);
                        doc.setTextColor(120, 120, 120);
                        doc.setFont('helvetica', 'normal');
                        doc.text('A:' + m.width + 'cm', barX + barW / 2, bodyY + esqTopH * 0.6, {
                            align: 'center'
                        });
                        doc.text('B:' + (m.width2 || m.width) + 'cm', barX + esqArmW / 2, bodyY + esqTopH + (barH - esqTopH) * 0.5, {
                            align: 'center'
                        });
                    }
                    // Module number label above the visual
                    var labelTopY = malObj.enabled ? rowStartY : bodyY;
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(60, 60, 60);
                    doc.text('M' + (mi + 1), barX + barW / 2, labelTopY - 1.5, {
                        align: 'center'
                    });
                    var thisBottom = segY + 2;
                    if (thisBottom > maxBottomY)
                        maxBottomY = thisBottom;
                    doc.setFontSize(8);
                    curX += W + modGap;
                });
                // Module names listed at the bottom of the sheet  always in reserved area
                var bottomY = ph - reservedBottom + 4;
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(60, 60, 60);
                doc.text('Detalle de M\u00f3dulos:', margin, bottomY);
                bottomY += 4;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6.5);
                modules.forEach(function(m, mi) {
                    var mLabel = m.width + 'cm';
                    if (m.type === 'esquinero')
                        mLabel = m.width + 'x' + (m.width2 || m.width) + 'cm';
                    else if (m.type === 'fijo')
                        mLabel = m.width + 'x' + m.height + 'cm';
                    var typeName = m.type === 'esquinero' ? 'Esquinero' : m.type === 'libre' ? 'M. Libre' : m.type === 'fijo' ? 'Fijo' : m.type === 'panelTV' ? 'Panel TV' : m.type === 'especial' ? 'Especial' : m.type === 'torreLateral' ? 'Torre Lat.' : 'M\u00f3dulo';
                    var zoneSummary = [];
                    (m.zones || []).forEach(function(z2) {
                        if (z2.type === 'cajones')
                            zoneSummary.push((z2.qty || z2.count || 3) + ' cajones');
                        else if (z2.type === 'colgador')
                            zoneSummary.push('colgador');
                        else if (z2.type === 'zapatero')
                            zoneSummary.push((z2.qty || z2.repisas || 3) + ' zapatero');
                        else if (z2.type === 'entrepa')
                            zoneSummary.push((z2.qty || z2.count || 2) + ' entrepa\u00f1os');
                        else if (z2.type === 'entrepa_esp')
                            zoneSummary.push((z2.qty || z2.count || 2) + ' entrepa\u00f1os esp.');
                    });
                    if (m.puertas && m.puertas.enabled) {
                        zoneSummary.push((m.puertas.cantidad || 2) + ' puertas ' + (m.puertas.tipo === 'completa' ? 'completas' : 'por zona'));
                    } else if (m.doors) {
                        var dm = m.doorMode || 'por_zona';
                        if (dm === 'completa')
                            zoneSummary.push((m.doorCount || 2) + ' puertas completas');
                        else
                            zoneSummary.push('puertas por zona');
                    }
                    var line = (mi + 1) + '. ' + typeName + ' \u2014 ' + mLabel;
                    if (zoneSummary.length > 0)
                        line += ' (' + zoneSummary.join(', ') + ')';
                    doc.setTextColor(40, 40, 40);
                    doc.setFont('helvetica', 'bold');
                    doc.text((mi + 1) + '. ' + typeName, margin, bottomY);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(80, 80, 80);
                    doc.text(' \u2014 ' + mLabel + (zoneSummary.length > 0 ? ' (' + zoneSummary.join(', ') + ')' : ''), margin + doc.getTextWidth((mi + 1) + '. ' + typeName), bottomY);
                    bottomY += 3.5;
                });
                // Legend
                bottomY += 2;
                doc.setFontSize(6);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);
                var legItems = [
                {
                    c: zColors.cajones,
                    l: 'Cajones'
                }, {
                    c: zColors.colgador,
                    l: 'Colgador'
                },
                {
                    c: zColors.zapatero,
                    l: 'Zapatero'
                }, {
                    c: zColors.entrepa,
                    l: 'Entrepa\u00f1os'
                },
                {
                    c: zColors.techo,
                    l: 'Techo/Piso'
                }, {
                    c: zColors.maletero,
                    l: 'Maletero'
                },
                {
                    c: zColors.zoclo,
                    l: 'Zoclo'
                }
                ];
                var legX = margin;
                legItems.forEach(function(li) {
                    doc.setFillColor(li.c[0], li.c[1], li.c[2]);
                    doc.rect(legX, bottomY - 2, 3, 2.5, 'F');
                    doc.text(li.l, legX + 4, bottomY);
                    legX += 25;
                });
                doc.text('Espesor: ' + EP.thickness + 'mm \u00b7 Prof: ' + (EP.defaultDepth || EP.projectDepth || 50) + 'cm \u00b7 Total: ' + modules.length + ' m\u00f3dulo' + (modules.length > 1 ? 's' : ''), margin, bottomY + 4);
            }
        }

        // CUSTOMIZE: Client PDF  black & white Excel-style layout
        function genClientPDF(optProject, optCalc) {
            if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado. Verifica tu conexion a internet.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                P = optProject || S.project,
                c = optCalc || calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var black = [0, 0, 0];
            var white = [255, 255, 255];
            var pw = 215.9, ph = 279.4, margin = 15, cw = pw - margin * 2;
            var y = margin;

            // === COVER PAGE (cocina only) ===
            if (P.type === 'cocina') {
                // Full-page dark background
                doc.setFillColor(13, 13, 13); // #0d0d0d matching client PDF dark theme
                doc.rect(0, 0, pw, ph, 'F');

                // Company logo centered at top
                var coverY = 50;
                if (S.logoBase64) {
                    try {
                        doc.addImage(S.logoBase64, 'PNG', (pw - 60) / 2, coverY, 60, 24);
                        coverY += 35;
                    } catch (e) { coverY += 10; }
                }

                // Company name
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(196, 154, 108); // #c49a6c gold accent
                doc.text(br.name.toUpperCase(), pw / 2, coverY, { align: 'center' });
                coverY += 15;

                // Decorative line
                doc.setDrawColor(196, 154, 108);
                doc.setLineWidth(0.5);
                doc.line(pw / 2 - 40, coverY, pw / 2 + 40, coverY);
                coverY += 20;

                // "COTIZACION DE COCINA" title
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('COTIZACION DE COCINA', pw / 2, coverY, { align: 'center' });
                coverY += 30;

                // Project info block
                doc.setFontSize(13);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(200, 200, 200);
                var infoLines = [
                    'Proyecto: ' + (P.name || 'Sin nombre'),
                    'Cliente: ' + (P.client || 'Sin cliente'),
                    'Fecha: ' + fmtDatePDF(),
                    'Cotizacion: ' + d.quoteNum,
                    'Modulos: ' + P.modules.length
                ];
                infoLines.forEach(function(ln) {
                    doc.text(ln, pw / 2, coverY, { align: 'center' });
                    coverY += 8;
                });

                // Footer with contact info
                doc.setFontSize(9);
                doc.setTextColor(120, 120, 120);
                var contactLine = br.contact || '';
                if (contactLine) {
                    doc.text(contactLine, pw / 2, ph - 20, { align: 'center' });
                }

                // Add new page for the actual quote content
                doc.addPage();
                y = margin; // Reset y position for quote page
            }

            // === PAGE 1: QUOTE ===

            // 1. Title bar  full-width black rect with brand name
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 14, 'F');
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            if (S.logoBase64) {
                try { doc.addImage(S.logoBase64, 'PNG', margin + 2, y + 1, 30, 12); } catch (e) {}
                doc.text(br.name.toUpperCase(), margin + 35, y + 10);
            } else {
                doc.text(br.name.toUpperCase(), margin + 6, y + 10);
            }
            y += 14;

            // 2. Info row  black bg: Fecha left, Cotizacion right
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('Fecha: ' + fmtDatePDF(), margin + 4, y + 5.5);
            doc.text('Cotizacion: ' + d.quoteNum, margin + cw - 4, y + 5.5, { align: 'right' });
            y += 8;

            // 3. Cliente row  white bg
            doc.setFillColor(white[0], white[1], white[2]);
            doc.setDrawColor(black[0], black[1], black[2]);
            doc.setLineWidth(0.3);
            doc.rect(margin, y, cw, 8, 'FD');
            doc.setFontSize(10);
            doc.setTextColor(black[0], black[1], black[2]);
            doc.setFont('helvetica', 'normal');
            doc.text('Cliente:', margin + 4, y + 5.5);
            doc.setFont('helvetica', 'bold');
            doc.text(d.client || '', margin + 28, y + 5.5);
            y += 8;

            // 4. Proyecto row  black bg
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(10);
            doc.setTextColor(white[0], white[1], white[2]);
            doc.setFont('helvetica', 'normal');
            doc.text('Proyecto:', margin + 4, y + 5.5);
            doc.setFont('helvetica', 'bold');
            doc.text(d.projectName || '', margin + 30, y + 5.5);
            y += 8;

            // 5. Intro text  black bg
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 8, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('A continuacion remito la propuesta economica para su proyecto de muebles a la medida.', margin + 4, y + 5.5);
            y += 10;

            // 6. Item table using autoTable
            var itemTotal = d.items.reduce(function(a, it) { return a + (it.price * (it.qty || 1)); }, 0);
            var tableBody = d.items.map(function(it) {
                var total = (it.price || 0) * (it.qty || 1);
                return [
                    it.desc || it.name || '',
                    '$' + Math.round(it.price || 0).toLocaleString('es-MX'),
                    String(it.qty || 1),
                    '$' + Math.round(total).toLocaleString('es-MX')
                ];
            });

            doc.autoTable({
                startY: y,
                margin: { left: margin, right: margin },
                head: [['DESCRIPCION', 'PRECIO', 'CANT.', 'TOTAL']],
                body: tableBody,
                foot: [['TOTAL', '', '', '$' + Math.round(itemTotal).toLocaleString('es-MX')]],
                theme: 'plain',
                styles: {
                    fontSize: 8.5,
                    cellPadding: 3,
                    lineColor: black,
                    lineWidth: 0.3,
                    textColor: black
                },
                headStyles: {
                    fillColor: black,
                    textColor: white,
                    fontStyle: 'bold',
                    fontSize: 9
                },
                footStyles: {
                    fillColor: black,
                    textColor: white,
                    fontStyle: 'bold',
                    fontSize: 9
                },
                columnStyles: {
                    0: { cellWidth: cw * 0.50 },
                    1: { cellWidth: cw * 0.18, halign: 'right' },
                    2: { cellWidth: cw * 0.10, halign: 'center' },
                    3: { cellWidth: cw * 0.22, halign: 'right' }
                },
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });
            y = doc.lastAutoTable.finalY + 4;

            // 7. Totals section  right-aligned
            var roundedTotal = Math.round(itemTotal / 100) * 100;
            var iva = Math.round(roundedTotal * CONFIG.pricing.iva);
            var grandTotal = roundedTotal + iva;
            var totalsW = 80;
            var totalsX = margin + cw - totalsW;
            // Subtotal row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('SUBTOTAL', totalsX + 4, y + 5);
            doc.text('$' + roundedTotal.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 5, { align: 'right' });
            y += 7;
            // IVA row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 7, 'F');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('IVA ' + Math.round(CONFIG.pricing.iva * 100) + '%', totalsX + 4, y + 5);
            doc.text('$' + iva.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 5, { align: 'right' });
            y += 7;
            // Grand total row
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(totalsX, y, totalsW, 9, 'F');
            doc.setFontSize(11);
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('TOTAL', totalsX + 4, y + 6.5);
            doc.text('$' + grandTotal.toLocaleString('es-MX'), totalsX + totalsW - 4, y + 6.5, { align: 'right' });
            y += 13;

            // 8. Legal terms
            if (y > 210) { doc.addPage(); y = margin; }
            var legalTerms = CONFIG.brand.legalTerms || CONFIG.quoting.terms.map(function(t) {
                return t.replace('{anticipo}', d.anticipo).replace('{deliveryTime}', d.deliveryTime);
            });
            doc.setTextColor(black[0], black[1], black[2]);
            legalTerms.forEach(function(t) {
                if (y > ph - 20) { doc.addPage(); y = margin; }
                if (!t || t.trim() === '') { y += 3; return; }
                if (t.trim().slice(-1) === ':') {
                    // Section header bar
                    y += 2;
                    doc.setFillColor(black[0], black[1], black[2]);
                    doc.rect(margin, y, cw, 7, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.setTextColor(white[0], white[1], white[2]);
                    doc.text(t, margin + 4, y + 5);
                    doc.setTextColor(black[0], black[1], black[2]);
                    y += 10;
                } else {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    var tLines = doc.splitTextToSize(t, cw - 8);
                    doc.text(tLines, margin + 4, y);
                    y += tLines.length * 3.8 + 2;
                }
            });
            if (d.notes) {
                y += 3;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('Nota: ' + d.notes, margin + 4, y);
                y += 6;
            }
            y += 6;

            // 9. Contact footer
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(margin, y, cw, 0.5, 'F');
            y += 4;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(black[0], black[1], black[2]);
            doc.text('Encargado del proyecto: ' + CONTACT.name, margin + 4, y);
            y += 3.5;
            doc.text('Contacto: ' + CONTACT.cell + '  |  ' + CONTACT.email, margin + 4, y);

            // === PAGE 2: MATERIALES ===
            doc.addPage();
            y = margin;
            var matMargin = margin;

            // Header
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 12, 'F');
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('MATERIALES', matMargin + 6, y + 8.5);
            y += 12;

            // Project/Vendedor info row
            doc.setFillColor(white[0], white[1], white[2]);
            doc.setDrawColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'FD');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(black[0], black[1], black[2]);
            doc.text('Proyecto: ' + (d.projectName || '') + '  |  Cliente: ' + (d.client || '') + '  |  ' + d.quoteNum, matMargin + 4, y + 4.8);
            y += 9;

            // CARPINTERIA section
            var carpMultiplier = CONFIG.pricing.carpentryMultiplier;
            var carpBody = [];
            if (c.totalSheetsF > 0) {
                var sheetSaleF = Math.round(getMatPrice(P.matFrentes, P.thickness) * carpMultiplier);
                carpBody.push([
                    String(c.totalSheetsF),
                    'Hoja',
                    'Melamina ' + P.matFrentes.name + (P.matFrentes.finish ? ' ' + P.matFrentes.finish : '') + ' ' + P.thickness + 'mm',
                    P.matFrentes.brand || 'FINSA',
                    '$' + Math.round(c.totalSheetsF * sheetSaleF).toLocaleString('es-MX')
                ]);
            }
            if (c.useDual && c.totalSheetsI > 0) {
                var sheetSaleI = Math.round(getMatPrice(P.matInterior, P.thickness) * carpMultiplier);
                carpBody.push([
                    String(c.totalSheetsI),
                    'Hoja',
                    'Melamina ' + P.matInterior.name + (P.matInterior.finish ? ' ' + P.matInterior.finish : '') + ' ' + P.thickness + 'mm (Interior)',
                    P.matInterior.brand || 'FINSA',
                    '$' + Math.round(c.totalSheetsI * sheetSaleI).toLocaleString('es-MX')
                ]);
            }
            if (c.totalCanto > 0) {
                var chapSale = Math.round((c.chapCostF + c.chapCostI) * carpMultiplier);
                carpBody.push([
                    String(c.totalCanto),
                    'ML',
                    'Chapacanto ' + (CONFIG.pricing.defaultChapSpec || ''),
                    '',
                    '$' + chapSale.toLocaleString('es-MX')
                ]);
            }
            if (c.totalSheets > 0) {
                carpBody.push([
                    String(c.totalSheets),
                    'Hoja',
                    'Corte CNC',
                    '',
                    '$' + Math.round(c.corteCost * carpMultiplier).toLocaleString('es-MX')
                ]);
            }
            if (c.totalCanto > 0) {
                carpBody.push([
                    String(c.totalCanto),
                    'ML',
                    'Enchapado',
                    '',
                    '$' + Math.round(c.enchapCost * carpMultiplier).toLocaleString('es-MX')
                ]);
            }

            // Section header for CARPINTERIA
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('CARPINTERIA', matMargin + 4, y + 4.8);
            y += 8;

            if (carpBody.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: { left: matMargin, right: margin },
                    tableWidth: cw,
                    head: [['CANT.', 'UNIDAD', 'DESCRIPCION', 'MARCA', 'TOTAL']],
                    body: carpBody,
                    foot: [['TOTAL CARPINTERIA', '', '', '', '$' + Math.round(c.carpSale).toLocaleString('es-MX')]],
                    theme: 'plain',
                    styles: { fontSize: 8, cellPadding: 2.5, lineColor: black, lineWidth: 0.2, textColor: black },
                    headStyles: { fillColor: [220, 220, 220], textColor: black, fontStyle: 'bold' },
                    footStyles: { fillColor: black, textColor: white, fontStyle: 'bold', fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 14, halign: 'center' },
                        1: { cellWidth: 16, halign: 'center' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 24 },
                        4: { cellWidth: 35, halign: 'right' }
                    },
                    didParseCell: function(data) {
                        if (data.section === 'foot' && data.column.index === 0) {
                            data.cell.colSpan = 4;
                        }
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            }

            // Check if HERRAJES section fits, otherwise new page
            if (y > ph - 50) { doc.addPage(); y = margin; }

            // HERRAJES section
            doc.setFillColor(black[0], black[1], black[2]);
            doc.rect(matMargin, y, cw, 7, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text('HERRAJES', matMargin + 4, y + 4.8);
            y += 8;

            var hwBody = [];
            c.allHW.forEach(function(hw) {
                var qty = Math.ceil(hw.qty);
                if (qty <= 0) return;
                var salePrice;
                if (hw._bucket === 'carp') {
                    salePrice = Math.round(hw.price * carpMultiplier);
                } else {
                    salePrice = Math.round(hw.price / (1 - CONFIG.pricing.premiumHardwareMargin));
                }
                hwBody.push([
                    String(qty),
                    'Pza',
                    hw.desc,
                    hw.marca || '',
                    '$' + Math.round(qty * salePrice).toLocaleString('es-MX')
                ]);
            });

            var hwSaleTotal = c.hwPremiumSale + (c.hwCostCarpBucket * carpMultiplier);
            if (hwBody.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: { left: matMargin, right: margin },
                    tableWidth: cw,
                    head: [['CANT.', 'UNIDAD', 'DESCRIPCION', 'MARCA', 'TOTAL']],
                    body: hwBody,
                    foot: [['TOTAL HERRAJES', '', '', '', '$' + Math.round(hwSaleTotal).toLocaleString('es-MX')]],
                    theme: 'plain',
                    styles: { fontSize: 8, cellPadding: 2.5, lineColor: black, lineWidth: 0.2, textColor: black },
                    headStyles: { fillColor: [220, 220, 220], textColor: black, fontStyle: 'bold' },
                    footStyles: { fillColor: black, textColor: white, fontStyle: 'bold', fontSize: 9 },
                    columnStyles: {
                        0: { cellWidth: 14, halign: 'center' },
                        1: { cellWidth: 16, halign: 'center' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 24 },
                        4: { cellWidth: 35, halign: 'right' }
                    },
                    didParseCell: function(data) {
                        if (data.section === 'foot' && data.column.index === 0) {
                            data.cell.colSpan = 4;
                        }
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            } else {
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(black[0], black[1], black[2]);
                doc.text('(Sin herrajes)', matMargin + 4, y + 4);
                y += 10;
            }


            // === COCINA-SPECIFIC PAGES (client PDF) ===
            if (P.type === 'cocina') {
                // Module index page
                doc.addPage();
                y = margin;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Detalle de Modulos', margin, y + 6);
                y += 12;

                var modRows = P.modules.map(function(m, i) {
                    var modDef = MODS[m.type] || {};
                    return [
                        (i + 1) + '',
                        modDef.n || m.name,
                        m.width + ' cm',
                        (m.height || P.defaultHeight || 200) + ' cm',
                        (P.sameDepth && m.type !== 'especial' ? (P.defaultDepth || 50) : (m.depth || P.defaultDepth || 50)) + ' cm',
                        (m.quantity || 1) + ''
                    ];
                });

                doc.autoTable({
                    startY: y,
                    head: [['#', 'Modulo', 'Ancho', 'Alto', 'Prof.', 'Cant.']],
                    body: modRows,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 9 },
                    bodyStyles: { fontSize: 8 },
                    columnStyles: { 0: { cellWidth: 10 } },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 8;

                // Despiece section
                if (y > ph - 60) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Despiece Completo', margin, y + 6);
                y += 12;

                var despRows = [];
                c.pieces.forEach(function(p) {
                    despRows.push([
                        p.mn || '',
                        p.n,
                        p.q + '',
                        p.w + ' mm',
                        p.h + ' mm',
                        (p.t || 15) + ' mm',
                        p.z === 'f' ? 'Frente' : 'Interior'
                    ]);
                });

                doc.autoTable({
                    startY: y,
                    head: [['Modulo', 'Pieza', 'Cant.', 'Ancho', 'Alto', 'Esp.', 'Material']],
                    body: despRows,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 8 },
                    bodyStyles: { fontSize: 7 },
                    columnStyles: { 0: { cellWidth: 30 }, 1: { cellWidth: 30 } },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 8;

                // Hardware summary
                if (y > ph - 60) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Resumen de Herrajes', margin, y + 6);
                y += 12;

                var hwRows = [];
                c.allHW.forEach(function(hw) {
                    hwRows.push([
                        hw.desc,
                        hw.marca || '',
                        Math.ceil(hw.qty) + '',
                        fmtD(hw.price),
                        fmtD(Math.ceil(hw.qty) * hw.price)
                    ]);
                });

                if (hwRows.length > 0) {
                    doc.autoTable({
                        startY: y,
                        head: [['Herraje', 'Marca', 'Cant.', 'Precio Unit.', 'Total']],
                        body: hwRows,
                        theme: 'grid',
                        headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 8 },
                        bodyStyles: { fontSize: 7 },
                        margin: { left: margin, right: margin }
                    });
                    y = doc.lastAutoTable.finalY + 8;
                }

                // Extras
                var hasExtras = P.modules.some(function(m) {
                    return m.type === 'vistaLateral' || m.type === 'panelRelleno' || m.type === 'cubierta';
                });
                if (hasExtras) {
                    if (y > ph - 50) { doc.addPage(); y = margin; }
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Extras y Acabados', margin, y + 6);
                    y += 12;

                    var extRows = [];
                    P.modules.forEach(function(m) {
                        if (m.type === 'vistaLateral' || m.type === 'panelRelleno' || m.type === 'cubierta') {
                            var desc = MODS[m.type] ? MODS[m.type].n : m.name;
                            if (m.type === 'cubierta') desc += ' (' + (m.cubiertaType || 'postformado') + ')';
                            extRows.push([desc, m.width + ' cm', (m.quantity || 1) + '']);
                        }
                    });

                    doc.autoTable({
                        startY: y,
                        head: [['Extra', 'Medida', 'Cant.']],
                        body: extRows,
                        theme: 'grid',
                        headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 9 },
                        bodyStyles: { fontSize: 8 },
                        margin: { left: margin, right: margin }
                    });
                    y = doc.lastAutoTable.finalY + 8;
                }

                // Technical note
                if (y > ph - 40) { doc.addPage(); y = margin; }
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Nota Tecnica', margin, y + 5);
                y += 8;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var techNote = 'Modulos fabricados en melamina 15mm con cantos sellados. Herrajes Blum importados con garantia. Instalacion incluye nivelacion con patas regulables, anclaje de alacenas a muro, y verificacion de escuadra. Cubierta cotizada por separado segun material seleccionado. Saque trasero de 100mm obligatorio en modulos de horno para ventilacion.';
                var splitNote = doc.splitTextToSize(techNote, cw);
                doc.text(splitNote, margin, y);
                y += splitNote.length * 4 + 4;
            } // end if cocina (client PDF)

            // Plano page
            addPlanoPage(doc, margin);

            // Save
            var fname = d.quoteNum + '-Cotizacion-' + (d.client || 'Cliente').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
            // Increment counter
            S.quoteCounter++;
            try {
                localStorage.setItem(CONFIG.storage.prefix + 'quote_counter', S.quoteCounter);
            } catch (e) {}
        }

        function genInternalPDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                c = calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            var red = [220, 38, 38];
            var pw = 215.9,
                margin = 20;
            var y = margin;

            // === COVER PAGE (cocina internal) ===
            if (S.project.type === 'cocina') {
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('COTIZACION INTERNA - COCINA', pw / 2, 30, { align: 'center' });
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Proyecto: ' + (S.project.name || ''), pw / 2, 42, { align: 'center' });
                doc.text('Cliente: ' + (S.project.client || ''), pw / 2, 50, { align: 'center' });
                doc.text('Fecha: ' + new Date().toLocaleDateString('es-MX'), pw / 2, 58, { align: 'center' });
                doc.text('Modulos: ' + S.project.modules.length, pw / 2, 66, { align: 'center' });
                doc.addPage();
                y = margin;
            }

            // Header
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text(br.name + ' - DESGLOSE DE COSTOS', margin, y + 6);
            y += 12;
            // Red banner
            doc.setFillColor(red[0], red[1], red[2]);
            doc.rect(margin, y, pw - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('CONFIDENCIAL - NO COMPARTIR CON CLIENTE', pw / 2, y + 5.5, {
                align: 'center'
            });
            y += 12;
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(d.quoteNum + ' | ' + fmtDatePDF() + ' | Cliente: ' + (d.client || ''), margin, y);
            y += 8;
            // Cost breakdown table
            var tableData = [];
            // Carpinteria section
            tableData.push([{
                content: 'CARPINTERIA (x' + CONFIG.pricing.carpentryMultiplier + ')',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            if (c.totalSheetsF > 0)
                tableData.push(['Mat. Frentes (' + c.totalSheetsF + ' hojas)', '', '$' + Math.round(c.matCostF).toLocaleString('es-MX'), '']);
            if (c.useDual && c.totalSheetsI > 0)
                tableData.push(['Mat. Interior (' + c.totalSheetsI + ' hojas)', '', '$' + Math.round(c.matCostI).toLocaleString('es-MX'), '']);
            tableData.push(['Chapacanto', c.totalCanto + ' ml', '$' + Math.round(c.chapCostF + c.chapCostI).toLocaleString('es-MX'), '']);
            tableData.push(['Corte', c.totalSheets + ' hojas', '$' + Math.round(c.corteCost).toLocaleString('es-MX'), '']);
            tableData.push(['Enchapado', c.totalCanto + ' ml', '$' + Math.round(c.enchapCost).toLocaleString('es-MX'), '']);
            tableData.push(['Mano de obra', '', '$' + Math.round(S.project.laborCost).toLocaleString('es-MX'), '']);
            tableData.push([{
                content: 'Subtotal carpinteria',
                styles: {
                    fontStyle: 'bold'
                }
            }, '', '$' + Math.round(c.carpCost).toLocaleString('es-MX'), '$' + Math.round(c.carpSale).toLocaleString('es-MX')]);
            // Herrajes  carpentry bucket
            tableData.push([{
                content: 'HERRAJES EN CARPINTERIA (\u2264$' + CONFIG.pricing.hardwareThreshold + ')',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            var hasCarpHW = false;
            c.allHW.forEach(function(hw) {
                if (hw._bucket !== 'carp') return;
                hasCarpHW = true;
                tableData.push([hw.desc + ' (' + hw.marca + ')', Math.ceil(hw.qty), '$' + Math.round(Math.ceil(hw.qty) * hw.price).toLocaleString('es-MX'), '']);
            });
            if (!hasCarpHW)
                tableData.push(['(ninguno)', '', '$0', '']);
            tableData.push([{
                content: 'Subtotal herrajes (en carp.)',
                styles: { fontStyle: 'bold' }
            }, '', '$' + Math.round(c.hwCostCarpBucket).toLocaleString('es-MX'), '(incl. en carp.)']);
            // Premium hardware
            tableData.push([{
                content: 'HERRAJES PREMIUM (>$' + CONFIG.pricing.hardwareThreshold + ', ' + Math.round(CONFIG.pricing.premiumHardwareMargin * 100) + '%)',
                colSpan: 4,
                styles: {
                    fillColor: [200, 200, 200],
                    fontStyle: 'bold',
                    fontSize: 9
                }
            }]);
            var hasPremHW = false;
            c.allHW.forEach(function(hw) {
                if (hw._bucket !== 'premium') return;
                hasPremHW = true;
                tableData.push([hw.desc + ' (' + hw.marca + ')', Math.ceil(hw.qty), '$' + Math.round(Math.ceil(hw.qty) * hw.price).toLocaleString('es-MX'), '']);
            });
            if (!hasPremHW)
                tableData.push(['(ninguno)', '', '$0', '$0']);
            tableData.push([{
                content: 'Subtotal premium',
                styles: { fontStyle: 'bold' }
            }, '', '$' + Math.round(c.hwCostPremium).toLocaleString('es-MX'), '$' + Math.round(c.hwPremiumSale).toLocaleString('es-MX')]);
            // Extras
            if (c.extraCost > 0) {
                tableData.push([{
                    content: 'EXTRAS',
                    colSpan: 4,
                    styles: {
                        fillColor: [200, 200, 200],
                        fontStyle: 'bold',
                        fontSize: 9
                    }
                }]);
                if (c.ledBOM) {
                    tableData.push([{
                        content: 'LED BOM (' + c.ledBOM.totalMeters.toFixed(1) + 'm, ' + c.ledBOM.totalSegments + ' seg, ' + c.ledBOM.alimentadorW + 'W)',
                        colSpan: 4,
                        styles: {
                            fontStyle: 'bold',
                            fontSize: 8,
                            textColor: [180, 140, 50]
                        }
                    }]);
                    c.ledBOM.items.forEach(function(it) {
                        tableData.push([it.desc, it.qty, '$' + Math.round(it.total).toLocaleString('es-MX'), '']);
                    });
                    tableData.push([{
                        content: 'Subtotal LED',
                        styles: {
                            fontStyle: 'bold'
                        }
                    }, '', '$' + Math.round(c.ledBOM.totalCost).toLocaleString('es-MX'), '']);
                }
                if (S.project.glass)
                    tableData.push(['Vidrio ' + S.project.glassM2 + 'm2', '', '$' + Math.round(S.project.glassM2 * CONFIG.pricing.glassCostPerM2).toLocaleString('es-MX'), '']);
                if (c.paintCost > 0) {
                    S.project.modules.forEach(function(m2) {
                        if (m2.paint && m2.paint.enabled && m2.paint.pricePerLiter > 0) {
                            var pm2 = calcPaintM2(m2, {
                                mode: 'custom',
                                defaultHeight: S.project.defaultHeight,
                                defaultDepth: S.project.defaultDepth
                            });
                            var lit = calcPaintLiters(pm2, m2.paint.coats);
                            if (pm2 > 0)
                                tableData.push(['Pintura' + (m2.paint.name ? ' ' + m2.paint.name : '') + ' (' + lit.toFixed(1) + 'L)', '', '$' + Math.round(lit * m2.paint.pricePerLiter).toLocaleString('es-MX'), '']);
                        }
                    });
                }
                tableData.push([{
                    content: 'Subtotal extras',
                    styles: {
                        fontStyle: 'bold'
                    }
                }, '', '$' + Math.round(c.extraCost).toLocaleString('es-MX'), '$' + Math.round(c.extrasSale).toLocaleString('es-MX')]);
            }
            doc.autoTable({
                startY: y,
                margin: {
                    left: margin,
                    right: margin
                },
                head: [['Concepto', 'Cant.', 'Costo', 'Venta']],
                body: tableData,
                headStyles: {
                    fillColor: dark,
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                bodyStyles: {
                    fontSize: 8,
                    textColor: dark
                },
                columnStyles: {
                    0: {
                        cellWidth: 80
                    },
                    1: {
                        cellWidth: 25
                    },
                    2: {
                        cellWidth: 35,
                        halign: 'right'
                    },
                    3: {
                        cellWidth: 35,
                        halign: 'right'
                    }
                },
                alternateRowStyles: {
                    fillColor: [250, 248, 245]
                }
            });
            y = doc.lastAutoTable.finalY + 8;

            // === COCINA-SPECIFIC PAGES (internal PDF) ===
            var intP = S.project;
            var intPh = 279.4;
            var intCw = pw - margin * 2;
            if (intP.type === 'cocina') {
                // Module index table with costs
                doc.addPage();
                y = margin;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(dark[0], dark[1], dark[2]);
                doc.text('Detalle de Modulos (Interno)', margin, y + 6);
                y += 12;

                var modRowsInt = intP.modules.map(function(m, i) {
                    var modDef = MODS[m.type] || {};
                    var modCost = 0;
                    if (c.perModule && c.perModule[m.id]) {
                        modCost = c.perModule[m.id].total || 0;
                    }
                    return [
                        (i + 1) + '',
                        modDef.n || m.name,
                        m.width + ' cm',
                        (m.height || intP.defaultHeight || 200) + ' cm',
                        (m.quantity || 1) + '',
                        fmtD(modCost),
                        fmtD(modCost * (CONFIG.pricing.margin || 0.30))
                    ];
                });

                doc.autoTable({
                    startY: y,
                    head: [['#', 'Modulo', 'Ancho', 'Alto', 'Cant.', 'Costo', 'Margen']],
                    body: modRowsInt,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 8 },
                    bodyStyles: { fontSize: 7 },
                    columnStyles: { 0: { cellWidth: 8 }, 5: { halign: 'right' }, 6: { halign: 'right' } },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 8;

                // Hardware detail (internal)
                if (y > intPh - 60) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(dark[0], dark[1], dark[2]);
                doc.text('Herrajes Detalle (Interno)', margin, y + 6);
                y += 12;

                var hwRowsInt = [];
                var hwTotalCost = 0;
                c.allHW.forEach(function(hw) {
                    var qty = Math.ceil(hw.qty);
                    var unitP = hw.price || 0;
                    var total = qty * unitP;
                    var bucket = (unitP <= (CONFIG.pricing.hwPremiumThreshold || 500)) ? 'Carpinteria' : 'Premium';
                    hwTotalCost += total;
                    hwRowsInt.push([
                        hw.desc,
                        hw.marca || '',
                        qty + '',
                        fmtD(unitP),
                        fmtD(total),
                        bucket
                    ]);
                });

                if (hwRowsInt.length > 0) {
                    doc.autoTable({
                        startY: y,
                        head: [['Herraje', 'Marca', 'Cant.', 'P. Unit.', 'Total', 'Tipo']],
                        body: hwRowsInt,
                        theme: 'grid',
                        headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 8 },
                        bodyStyles: { fontSize: 7 },
                        columnStyles: { 3: { halign: 'right' }, 4: { halign: 'right' } },
                        margin: { left: margin, right: margin }
                    });
                    y = doc.lastAutoTable.finalY + 4;

                    // Hardware total row
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(dark[0], dark[1], dark[2]);
                    doc.text('Total Herrajes: ' + fmtD(hwTotalCost), margin, y + 4);
                    y += 10;
                }

                // Category cost summary (internal)
                if (y > intPh - 50) { doc.addPage(); y = margin; }
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(dark[0], dark[1], dark[2]);
                doc.text('Resumen por Categoria (Interno)', margin, y + 6);
                y += 12;

                var catRows = [
                    ['Casco (interior + canto)', fmtD(c.cascoCost || 0)],
                    ['Frente (visible + canto)', fmtD(c.frenteCost || 0)],
                    ['Herrajes', fmtD(c.herrajesCost || 0)],
                    ['Extras', fmtD(c.extrasCost || 0)]
                ];

                doc.autoTable({
                    startY: y,
                    head: [['Categoria', 'Costo']],
                    body: catRows,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 30, 30], textColor: [255, 255, 255], fontSize: 9 },
                    bodyStyles: { fontSize: 8 },
                    columnStyles: { 1: { halign: 'right' } },
                    margin: { left: margin, right: margin }
                });
                y = doc.lastAutoTable.finalY + 8;
            } // end if cocina (internal PDF)

            // Summary box
            if (y > 230) {
                doc.addPage();
                y = margin;
            }
            doc.setFillColor(245, 240, 235);
            doc.rect(margin, y, pw - margin * 2, 40, 'F');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('RESUMEN DE RENTABILIDAD', margin + 5, y + 7);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Costo total:', margin + 5, y + 15);
            doc.text('$' + Math.round(c.totalCost).toLocaleString('es-MX'), margin + 70, y + 15);
            doc.text('Precio venta:', margin + 5, y + 21);
            doc.text('$' + Math.round(c.subtotal).toLocaleString('es-MX'), margin + 70, y + 21);
            doc.text('Utilidad bruta:', margin + 5, y + 27);
            doc.text('$' + Math.round(c.profit).toLocaleString('es-MX'), margin + 70, y + 27);
            doc.setFont('helvetica', 'bold');
            doc.text('Margen real:', margin + 5, y + 33);
            doc.text(c.margin + '%', margin + 70, y + 33);

            // Plano page
            addPlanoPage(doc, margin);

            // Save
            var fname = d.quoteNum + '-Desglose-' + (d.client || 'Interno').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
        }

        function genDespiece() {
            if (typeof window.jspdf === 'undefined') {
                alert('jsPDF no cargado.');
                return;
            }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF('p', 'mm', 'letter');
            var d = S.pdfData,
                P = S.project,
                c = calc(),
                br = BRANDS[S.brand] || BRANDS.primary;
            var accent = [196, 154, 108];
            var dark = [26, 26, 46];
            var blue = [30, 58, 95];
            var pw = 215.9,
                margin = 15;
            var y = margin;
            // Header
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text(br.name + ' - DESPIECE / LISTA DE CORTE', margin, y + 5);
            y += 10;
            // Blue banner
            doc.setFillColor(blue[0], blue[1], blue[2]);
            doc.rect(margin, y, pw - margin * 2, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('DOCUMENTO PARA PROVEEDOR / TALLER  NO INCLUYE PRECIOS DE VENTA', pw / 2, y + 5, {
                align: 'center'
            });
            y += 11;
            doc.setTextColor(dark[0], dark[1], dark[2]);
            // Info row
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            var qnum = d ? d.quoteNum : getQuoteNum();
            doc.text(qnum + ' | ' + fmtDatePDF() + ' | Cliente: ' + (d && d.client ? d.client : P.client || ''), margin, y);
            y += 5;
            doc.text('Proyecto: ' + (d && d.projectName ? d.projectName : ''), margin, y);
            y += 6;
            // Material info
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('MATERIALES', margin, y);
            y += 5;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Frentes: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + (P.matFrentes.finish ? ' (' + P.matFrentes.finish + ')' : ''), margin, y);
            y += 4;
            if (c.useDual) {
                doc.text('Interior: ' + P.matInterior.brand + ' ' + P.matInterior.name + (P.matInterior.finish ? ' (' + P.matInterior.finish + ')' : ''), margin, y);
                y += 4;
            }
            if (P.chapSpec) {
                doc.text('Chapacanto: ' + P.chapSpec, margin, y);
                y += 4;
            }
            y += 2;
            // Sheet summary
            doc.setFillColor(240, 238, 233);
            doc.rect(margin, y, pw - margin * 2, c.useDual ? 22 : 14, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            var sx = margin + 3;
            doc.text('RESUMEN HOJAS: ' + c.totalSheets + ' hojas | CANTO: ' + c.totalCanto + ' ml', sx, y + 5);
            if (c.useDual) {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var pTK = c.projThickness || 16;
                var fLine = 'FRENTES: ' + pTK + 'mm=' + c.totalSheetsF + ' | Canto: ' + c.cantoF + ' ml';
                doc.text(fLine, sx, y + 10);
                var iLine = 'INTERIOR: ' + pTK + 'mm=' + c.totalSheetsI + ' | Canto: ' + c.cantoI + ' ml';
                doc.text(iLine, sx, y + 15);
                y += 25;
            } else {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                var pTK2 = c.projThickness || 16;
                var sAllSheets = c.totalSheetsF + c.totalSheetsI;
                var aLine = pTK2 + 'mm: ' + sAllSheets + ' hojas  ';
                doc.text(aLine, sx, y + 10);
                y += 17;
            }
            // Cut list table per module
            P.modules.forEach(function(m) {
                var pcs = c.pieces.filter(function(p) {
                    return p.mid === m.id;
                });
                if (pcs.length === 0)
                    return;
                // Check page space
                if (y > 240) {
                    doc.addPage();
                    y = margin;
                }
                // Module header
                doc.setFillColor(accent[0], accent[1], accent[2]);
                doc.rect(margin, y, pw - margin * 2, 6, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                var mHdr = m.name + '  ' + m.width + ' cm';
                if (m.height)
                    mHdr += ' x ' + m.height + ' cm';
                doc.text(mHdr, margin + 3, y + 4.3);
                y += 8;
                doc.setTextColor(dark[0], dark[1], dark[2]);
                // Pieces table  ancho x largo format with edits applied
                var tData = [];
                pcs.sort(function(a, b) {
                    var alA = anchoLargo(a.w, a.h),
                        alB = anchoLargo(b.w, b.h);
                    return alB.largo - alA.largo;
                });
                pcs.forEach(function(p) {
                    var al = anchoLargo(p.w, p.h);
                    var eKey = m.id + ':' + p.n;
                    var ep = S.editedPieces[eKey] || {};
                    var eq = typeof ep.q === 'number' ? ep.q : p.q;
                    var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                    var el2 = typeof ep.largo === 'number' ? ep.largo : al.largo;
                    var row = [p.n, String(eq), String(ea), String(el2), p.t + 'mm'];
                    if (c.useDual)
                        row.push(p.z === 'f' ? 'FRENTE' : 'INTERIOR');
                    tData.push(row);
                });
                var cols = c.useDual ? ['Pieza', 'Cant.', 'Ancho (mm)', 'Largo (mm)', 'Espesor', 'Zona'] : ['Pieza', 'Cant.', 'Ancho (mm)', 'Largo (mm)', 'Espesor'];
                doc.autoTable({
                    startY: y,
                    margin: {
                        left: margin,
                        right: margin
                    },
                    head: [cols],
                    body: tData,
                    headStyles: {
                        fillColor: [80, 80, 80],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: dark
                    },
                    alternateRowStyles: {
                        fillColor: [250, 248, 245]
                    },
                    columnStyles: c.useDual ? {
                        0: {
                            cellWidth: 40
                        },
                        1: {
                            cellWidth: 13
                        },
                        2: {
                            cellWidth: 25
                        },
                        3: {
                            cellWidth: 25
                        },
                        4: {
                            cellWidth: 18
                        },
                        5: {
                            cellWidth: 22
                        }
                    } : {
                        0: {
                            cellWidth: 50
                        },
                        1: {
                            cellWidth: 15
                        },
                        2: {
                            cellWidth: 28
                        },
                        3: {
                            cellWidth: 28
                        },
                        4: {
                            cellWidth: 20
                        }
                    },
                    theme: 'grid',
                    styles: {
                        cellPadding: 1.5,
                        lineWidth: 0.2,
                        lineColor: [180, 180, 180]
                    }
                });
                y = doc.lastAutoTable.finalY + 4;
            });
            // Hardware list
            if (y > 230) {
                doc.addPage();
                y = margin;
            }
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(dark[0], dark[1], dark[2]);
            doc.text('HERRAJES', margin, y + 4);
            y += 7;
            var hwData = [];
            c.allHW.forEach(function(hw) {
                hwData.push([hw.desc, hw.marca, String(Math.ceil(hw.qty))]);
            });
            if (hwData.length > 0) {
                doc.autoTable({
                    startY: y,
                    margin: {
                        left: margin,
                        right: margin
                    },
                    head: [['Herraje', 'Marca', 'Cantidad']],
                    body: hwData,
                    headStyles: {
                        fillColor: [80, 80, 80],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: dark
                    },
                    alternateRowStyles: {
                        fillColor: [250, 248, 245]
                    },
                    columnStyles: {
                        0: {
                            cellWidth: 90
                        },
                        1: {
                            cellWidth: 30
                        },
                        2: {
                            cellWidth: 20
                        }
                    },
                    theme: 'grid',
                    styles: {
                        cellPadding: 1.5,
                        lineWidth: 0.2,
                        lineColor: [180, 180, 180]
                    }
                });
                y = doc.lastAutoTable.finalY + 6;
            } else {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('(Sin herrajes registrados)', margin, y);
                y += 6;
            }
            // Extras
            var dLedBOM = calcLedBOM();
            if (dLedBOM || P.glass) {
                if (y > 250) {
                    doc.addPage();
                    y = margin;
                }
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('EXTRAS', margin, y);
                y += 5;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                if (dLedBOM) {
                    doc.text('LED - ' + dLedBOM.totalMeters.toFixed(1) + 'm total, ' + dLedBOM.totalSegments + ' segmentos, ' + dLedBOM.alimentadorW + 'W', margin, y);
                    y += 4;
                    dLedBOM.items.forEach(function(it) {
                        doc.text('  ' + it.qty + 'x ' + it.desc, margin, y);
                        y += 3.5;
                    });
                    y += 1;
                }
                if (P.glass) {
                    doc.text('- Vidrio templado: ' + P.glassM2 + ' m2', margin, y);
                    y += 4;
                }
            }
            // Footer
            if (y > 255) {
                doc.addPage();
                y = margin;
            }
            y += 4;
            doc.setDrawColor(180, 180, 180);
            doc.line(margin, y, pw - margin, y);
            y += 5;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(120, 120, 120);
            doc.text('Generado por ' + br.name + ' | ' + CONTACT.name + ' | ' + CONTACT.cell + ' | ' + CONTACT.email, margin, y);
            // Save
            var fname = qnum + '-Despiece-' + (d && d.client ? d.client : 'Proveedor').replace(/\s+/g, '-') + '.pdf';
            doc.save(fname);
        }

        function render() {
          try {
            var el = $('content');
            if (el)
                scrollY = el.scrollTop;
            var br = BRANDS[S.brand] || BRANDS.primary;
            if (S.screen === 'templates') {
                var h = '<div class="hdr"><div style="display:flex;align-items:center"><div class="hdr-logo" style="background:var(--color-bg-elevated);color:#c49a6c;font-size:12px">' + br.mono + '</div><div class="hdr-txt"><h1>' + br.name + '</h1><p>Cotizador V2</p></div><span id="cloud-status" style="width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:8px;vertical-align:middle;background:var(--color-text-muted);flex-shrink:0" title="Sin conexion cloud"></span></div><div class="hdr-actions"><button class="hdr-btn" onclick="APP.toggleTheme()" title="Cambiar tema" style="font-size:16px;line-height:1">' + (S.darkMode ? '&#x2600;&#xFE0F;' : '&#x1F319;') + '</button><button class="hdr-btn" onclick="APP.showLicenseInfo()" title="Informacion de Licencia" style="font-size:16px;line-height:1;">&#x2139;&#xFE0F;</button></div></div>';
                h += '<div class="content" id="content">' + renderTemplates() + '</div>';
                if (S.imgModal)
                    h += '<div class="img-modal" onclick="APP.closeImg()"><button class="img-modal-close" onclick="APP.closeImg()">' + svg('x') + '</button><img src="' + S.imgModal + '" onclick="event.stopPropagation()"></div>';
                $('app').innerHTML = h;
                applyCloudStatus();
                return;
            }
            var c;
            try { c = calc(); } catch(calcErr) { console.error('CALC ERROR:', calcErr); c = { pieces:[], autoHW:[], sheets:{casco:[],frente:[]}, hwConsolidated:{}, totalSheets:0, totalArea:0, totalCost:0, hwCost:0, carpCost:0, extrasCost:0, grandTotal:0 }; }
            var h = '<div class="hdr"><div style="display:flex;align-items:center"><div class="hdr-logo" onclick="APP.goHome()" style="background:var(--color-bg-elevated);color:#c49a6c;font-size:12px">' + br.mono + '</div><div class="hdr-txt"><h1>' + br.name + '</h1><p>Cotizador V2</p></div><span id="cloud-status" style="width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:8px;vertical-align:middle;background:var(--color-text-muted);flex-shrink:0" title="Sin conexion cloud"></span></div>';
            h += '<div class="hdr-actions"><button class="hdr-btn" onclick="APP.toggleTheme()" title="Cambiar tema" style="font-size:16px;line-height:1">' + (S.darkMode ? '&#x2600;&#xFE0F;' : '&#x1F319;') + '</button><button class="hdr-btn" onclick="APP.showLicenseInfo()" title="Informacion de Licencia" style="font-size:16px;line-height:1;">&#x2139;&#xFE0F;</button><button class="hdr-btn" onclick="APP.openSettings()">' + svg('settings') + '</button></div></div>';
            h += '<div class="steps">';
            for (var i = 1; i <= 5; i++) {
                var cls = i === S.step ? 'active' : i < S.step ? 'done' : 'future';
                h += '<button class="step-dot ' + cls + '" onclick="APP.goStep(' + i + ')">' + i + '</button>';
                if (i < 5)
                    h += '<div class="step-line' + (i < S.step ? ' done' : '') + '"></div>';
            }
            h += '</div><div class="content" id="content">';
            if (S.step === 1)
                h += step1();
            else if (S.step === 2)
                h += step2();
            else if (S.step === 3)
                h += step3(c);
            else if (S.step === 4)
                h += step4(c);
            else
                h += step5(c);
            h += '</div>' + nav();
            h += renderHWPicker();
            h += renderSettings();
            $('app').innerHTML = h;
            applyCloudStatus();
            var el2 = $('content');
            if (el2)
                el2.scrollTop = scrollY;
          } catch(renderErr) {
            console.error('RENDER ERROR:', renderErr);
            var errDiv = document.createElement('div');
            errDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;padding:20px;background:red;color:white;z-index:99999;font-family:monospace;white-space:pre-wrap';
            errDiv.textContent = 'RENDER ERROR: ' + renderErr.message + '\n' + renderErr.stack;
            document.body.appendChild(errDiv);
            setTimeout(function(){ errDiv.remove(); }, 8000);
          }
        }

        // === APP METHODS ===
        window.APP = {
            goHome: function() {
                S.screen = 'templates';
                S.selTemplate = null;
                scrollY = 0;
                render();
            },
            selectTpl: function(id) {
                var t = TEMPLATES.find(function(x) {
                    return x.id === id;
                });
                if (!t)
                    return;
                // Convert template to old-flow project
                var matCode = t.matCode || '1AS';
                var matName = t.matName || 'Nogal Valentina';
                var matFinish = t.matFinish || 'Mesura';
                var matObj = {
                    brand: 'FINSA',
                    code: matCode,
                    name: matName,
                    finish: matFinish,
                    precio: FINSA_PRICES[16],
                    thickness: 16
                };
                S.project = {
                    client: '',
                    type: t.type || '',
                    sameMaterial: true,
                    matFrentes: matObj,
                    matInterior: JSON.parse(JSON.stringify(matObj)),
                    chapFrentesPrice: CONFIG.pricing.defaultChapPrice,
                    chapInteriorPrice: CONFIG.pricing.defaultChapPrice,
                    thickness: 16,
                    modules: t.preModules ? t.preModules.map(function(pm) {
                        return {
                            id: uid(),
                            type: pm.type || 'modulo',
                            name: pm.name || pm.type,
                            width: pm.width,
                            height: t.baseHeight || 200,
                            depth: 50,
                            cajones: pm.cajones || 0,
                            shelves: pm.shelves || 0,
                            doors: pm.doors || false,
                            tipon: pm.tipon || false
                        };
                    }) : [],
                    hardware: [],
                    ledConfig: { activation: 'dimmer', lightTemp: 'calida' },
                    glass: false,
                    glassM2: 0,
                    laborCost: t.laborCost || CONFIG.pricing.defaultLaborCost,
                    freight: true,
                    freightCost: CONFIG.pricing.defaultFreightCost,
                    defaultHeight: t.baseHeight || 200,
                    defaultDepth: 50,
                    sameDepth: true,
                    chapSpec: CONFIG.pricing.defaultChapSpec,
                    enchapPrice: typeof CONFIG.pricing.defaultEnchapPrice === 'number' ? CONFIG.pricing.defaultEnchapPrice : 13
                };
                S.screen = 'project';
                S.step = 1;
                S.pdfData = null;
                S.editedPieces = {};
                scrollY = 0;
                render();
            },
            openImg: function(src) {
                S.imgModal = src;
                render();
            },
            closeImg: function() {
                S.imgModal = null;
                render();
            },
            newProject: function() {
                S.screen = 'project';
                S.step = 1;
                S.project = {
                    client: '',
                    type: '',
                    sameMaterial: true,
                    matFrentes: defaultMat(),
                    matInterior: defaultMat(),
                    chapFrentesPrice: CONFIG.pricing.defaultChapPrice,
                    chapInteriorPrice: CONFIG.pricing.defaultChapPrice,
                    thickness: 16,
                    modules: [],
                    hardware: [],
                    ledConfig: { activation: 'dimmer', lightTemp: 'calida' },
                    glass: false,
                    glassM2: 0,
                    laborCost: CONFIG.pricing.defaultLaborCost,
                    freight: true,
                    freightCost: CONFIG.pricing.defaultFreightCost,
                    defaultHeight: 200,
                    defaultDepth: 50,
                    sameDepth: true,
                    chapSpec: CONFIG.pricing.defaultChapSpec,
                    enchapPrice: typeof CONFIG.pricing.defaultEnchapPrice === 'number' ? CONFIG.pricing.defaultEnchapPrice : 13
                };
                S.pdfData = null;
                S.editedPieces = {};
                scrollY = 0;
                render();
            },
            // Step navigation
            goStep: function(s) {
                if (s <= S.step) {
                    S.step = s;
                    scrollY = 0;
                    render();
                }
            },
            next: function() {
                var can = S.step === 1 ? S.project.type !== '' : S.step === 2 ? S.project.modules.length > 0 : true;
                if (can && S.step < 5) {
                    if (S.step === 4)
                        APP.initPdfData();
                    S.step++;
                    scrollY = 0;
                    render();
                }
            },
            // Step 1
            setClient: function(v) {
                S.project.client = v;
            },
            setType: function(t) {
                S.project.type = t;
                if (isDualType(t))
                    S.project.sameMaterial = false;
                else
                    S.project.sameMaterial = true;
                render();
            },
            togSameMat: function() {
                S.project.sameMaterial = !S.project.sameMaterial;
                if (S.project.sameMaterial)
                    S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                render();
            },
            setMatFrentes: function(val) {
                var parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    S.project.matFrentes.name = rest;
                    if (S.project.sameMaterial)
                        S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    S.project.matFrentes.customPrice = parseFloat(rest) || 0;
                    if (S.project.sameMaterial)
                        S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    S.project.matFrentes = {
                        brand: 'CUSTOM',
                        code: '',
                        name: S.project.matFrentes.brand === 'CUSTOM' ? S.project.matFrentes.name : '',
                        finish: '',
                        customPrice: S.project.matFrentes.brand === 'CUSTOM' ? S.project.matFrentes.customPrice : 0,
                        thickness: S.project.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        S.project.matFrentes = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[S.project.thickness],
                            thickness: S.project.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        S.project.matFrentes = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: S.project.thickness
                        };
                }
                if (S.project.sameMaterial)
                    S.project.matInterior = JSON.parse(JSON.stringify(S.project.matFrentes));
                render();
            },
            setMatInterior: function(val) {
                var parts = val.split(':'),
                    rest = val.substring(val.indexOf(':') + 1);
                if (parts[0] === 'CUSTOM_NAME') {
                    S.project.matInterior.name = rest;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM_PRICE') {
                    S.project.matInterior.customPrice = parseFloat(rest) || 0;
                    render();
                    return;
                }
                if (parts[0] === 'CUSTOM') {
                    S.project.matInterior = {
                        brand: 'CUSTOM',
                        code: '',
                        name: S.project.matInterior.brand === 'CUSTOM' ? S.project.matInterior.name : '',
                        finish: '',
                        customPrice: S.project.matInterior.brand === 'CUSTOM' ? S.project.matInterior.customPrice : 0,
                        thickness: S.project.thickness
                    };
                } else if (parts[0] === 'FINSA') {
                    var col = COLORS.find(function(x) {
                        return x.c === parts[1];
                    });
                    if (col)
                        S.project.matInterior = {
                            brand: 'FINSA',
                            code: col.c,
                            name: col.n,
                            finish: col.f,
                            precio: FINSA_PRICES[S.project.thickness],
                            thickness: S.project.thickness
                        };
                } else if (parts[0] === 'ARAUCO') {
                    var tabs = getAraucoTableros();
                    var item = tabs[parseInt(parts[1])];
                    if (item)
                        S.project.matInterior = {
                            brand: 'ARAUCO',
                            code: item.codigo,
                            name: item.descripcion,
                            finish: '',
                            precio: item.precio,
                            catItem: item,
                            thickness: S.project.thickness
                        };
                }
                render();
            },
            setThick: function(t) {
                S.project.thickness = t;
                render();
            },
            setCustomThick: function() {
                if ([16, 18, 25].indexOf(S.project.thickness) !== -1)
                    S.project.thickness = 12;
                render();
            },
            setChapF: function(v) {
                S.project.chapFrentesPrice = v || 0;
                if (S.project.sameMaterial)
                    S.project.chapInteriorPrice = v || 0;
                render();
            },
            setEnchapPrice: function(v) {
                S.project.enchapPrice = Math.max(0, v || 0);
                render();
            },
            setChapI: function(v) {
                S.project.chapInteriorPrice = v || 0;
                render();
            },
            setChapSpec: function(v) {
                S.project.chapSpec = v;
            },
            // Step 2 - Modules
            addMod: function(t) {
                var m = MODS[t];
                var newMod = {
                    id: uid(),
                    type: t,
                    name: m.n,
                    width: m.w[m.w.length > 1 ? 1 : 0],
                    doors: false,
                    tipon: false,
                    cajones: undefined,
                    shelves: t === 'torreLateral' ? 3 : undefined,
                    corrTier: 'corr_eco',
                    led: {
                        enabled: false,
                        edges: {
                            top: false,
                            bottom: false,
                            left: false,
                            right: false,
                            shelves: false
                        },
                        shelfCount: 0,
                        ledMeters: 0,
                        segments: 0,
                        metersOverride: null,
                        segmentsOverride: null
                    },
                    quoteMode: 'completo',
                    paint: {
                        enabled: false,
                        name: '',
                        pricePerLiter: 0,
                        coats: 2,
                        scope: 'doors'
                    },
                    maletero: { enabled: false, height: 40 },
                    puertas: {
                        enabled: false,
                        tipo: 'completa',
                        cantidad: 2,
                        material: 'melamina',
                        apertura: 'tipon'
                    },
                    enchapado: { latIzq: false, latDer: false, techo: false, piso: false }
                };
                // Initialize zones for closet modulo  default single colgador zone
                if (t === 'modulo') {
                    newMod.zones = [{ id: uid(), type: 'colgador', qty: 1, heightOverride: 0, corrTier: 'corr_eco' }];
                    newMod.zoclo = { enabled: false, height: 10 };
                    var totalH = S.project.defaultHeight || 200;
                    autoDistributeZones(newMod.zones, totalH);
                }
                // Initialize zoclo toggle for floor-standing modules
                var zocloTypes = ['bajoEstandar', 'fregadero', 'cajonera', 'esquineroCiego', 'hornoBase', 'bajoCooktop', 'torreDespensa', 'torreHornos', 'torreMicroondas', 'torreRefrigerador', 'torreLimpieza', 'isla'];
                if (zocloTypes.indexOf(t) !== -1) {
                    newMod.zoclo = { enabled: false, height: 15 };
                }
                // Dimension/property defaults for cocina, credenza, TV modules
                var modDefaults = {
                    gabineteBase:    { depth: 60, height: 85, zoclo: true, zocloH: 15 },
                    alacenaAlta:     { depth: 35, height: 70 },
                    torre:           { depth: 60, height: 220, zoclo: true, zocloH: 15, shelves: 3 },
                    bajoEstandar:    { depth: 58, height: 72 },
                    fregadero:       { depth: 58, height: 72 },
                    cajonera:        { depth: 58, height: 72 },
                    esquineroCiego:  { depth: 58, height: 72 },
                    hornoBase:       { depth: 58, height: 72 },
                    alacenaEstandar: { depth: 30, height: 70 },
                    alacenaAventos:  { depth: 35, height: 70 },
                    alacenaSobreCampana: { depth: 30, height: 40 },
                    torreHornos:     { depth: 58, height: 220 },
                    torreDespensa:   { depth: 58, height: 220 },
                    torreMicroondas: { depth: 58, height: 220 },
                    torreRefrigerador:{ depth: 65, height: 220 },
                    torreLimpieza:   { depth: 58, height: 220 },
                    bajoCooktop:     { depth: 58, height: 72 },
                    isla:            { depth: 60, height: 90 },
                    alacenaCampana:  { depth: 32, height: 70 },
                    alacenaEsquinera:{ depth: 32, height: 70 },
                    alacenaProfunda: { depth: 60, height: 35 },
                    gabineteRemate:  { depth: 35, height: 35 },
                    credenzaBase:    { depth: 40, height: 80, zoclo: true, zocloH: 10, cubiertaSuperior: true },
                    credenzaFlotante:{ depth: 40, height: 60, cubiertaSuperior: true },
                    panelTV:         { depth: 5 },
                    gabineteTV:      { depth: 35, height: 40 }
                };
                var _def = modDefaults[t];
                if (_def) {
                    if (_def.depth)  newMod.depth  = _def.depth;
                    if (_def.height) newMod.height = _def.height;
                    if (_def.shelves) newMod.shelves = _def.shelves;
                    if (_def.zoclo)  newMod.zoclo  = { enabled: true, height: _def.zocloH || 10 };
                    if (_def.cubiertaSuperior) newMod.cubiertaSuperior = true;
                }
                // panelTV has no puertas
                if (t === 'panelTV') newMod.puertas.enabled = false;
                S.project.modules.push(newMod);
                S.selectedModId = newMod.id;
                S.editedPieces = {};
                render();
            },
            // Zone management for closet modules
            addZone: function(modId, zoneType) {
                var m = findMod(modId);
                if (!m || !m.zones) return;
                var defQty = (zoneType === 'entrepa') ? 3 : (zoneType === 'cajones') ? 3 : (zoneType === 'zapatero') ? 4 : 1;
                var zt = CLOSET_ZONE_TYPES[zoneType];
                var defUnitH = (zoneType === 'cajones') ? 20 : (zoneType === 'zapatero') ? 15 : (zt && !zt.flexible) ? zt.fixedH : 0;
                m.zones.push({ id: uid(), type: zoneType, qty: defQty, heightOverride: 0, corrTier: 'corr_eco', unitH: defUnitH });
                autoDistributeZones(m.zones, m.height || S.project.defaultHeight || 200);
                S.editedPieces = {};
                render();
            },
            removeZone: function(modId, zoneIdx) {
                var m = findMod(modId);
                if (!m || !m.zones || zoneIdx < 0 || zoneIdx >= m.zones.length) return;
                m.zones.splice(zoneIdx, 1);
                autoDistributeZones(m.zones, m.height || S.project.defaultHeight || 200);
                S.editedPieces = {};
                render();
            },
            moveZone: function(modId, zoneIdx, dir) {
                var m = findMod(modId);
                if (!m || !m.zones) return;
                var newIdx = zoneIdx + dir;
                if (newIdx < 0 || newIdx >= m.zones.length) return;
                var tmp = m.zones[zoneIdx];
                m.zones[zoneIdx] = m.zones[newIdx];
                m.zones[newIdx] = tmp;
                S.editedPieces = {};
                render();
            },
            setZoneQty: function(modId, zoneIdx, qty) {
                var m = findMod(modId);
                if (!m || !m.zones || !m.zones[zoneIdx]) return;
                m.zones[zoneIdx].qty = Math.max(1, Math.min(10, qty));
                autoDistributeZones(m.zones, m.height || S.project.defaultHeight || 200);
                S.editedPieces = {};
                render();
            },
            setZoneHeight: function(modId, zoneIdx, h) {
                var m = findMod(modId);
                if (!m || !m.zones || !m.zones[zoneIdx]) return;
                m.zones[zoneIdx].heightOverride = Math.max(0, h);
                autoDistributeZones(m.zones, m.height || S.project.defaultHeight || 200);
                S.editedPieces = {};
                render();
            },
            setZoneCorrTier: function(modId, zoneIdx, tier) {
                var m = findMod(modId);
                if (!m || !m.zones || !m.zones[zoneIdx]) return;
                m.zones[zoneIdx].corrTier = tier;
                S.editedPieces = {};
                render();
            },
            delMod: function(id) {
                S.project.modules = S.project.modules.filter(function(m) {
                    return m.id !== id;
                });
                S.editedPieces = {};
                render();
            },
            moveMod: function(id, dir) {
                var mods = S.project.modules;
                var idx = mods.findIndex(function(m) { return m.id === id; });
                if (idx < 0) return;
                var newIdx = idx + dir;
                if (newIdx < 0 || newIdx >= mods.length) return;
                var tmp = mods[idx];
                mods[idx] = mods[newIdx];
                mods[newIdx] = tmp;
                S.editedPieces = {};
                render();
            },
            setDefaultHeight: function(v) {
                S.project.defaultHeight = Math.max(50, Math.min(400, v || 200));
                S.editedPieces = {};
                render();
            },
            setDefaultDepth: function(v) {
                S.project.defaultDepth = Math.max(20, Math.min(100, v || 50));
                S.editedPieces = {};
                render();
            },
            togSameDepth: function() {
                S.project.sameDepth = !S.project.sameDepth;
                S.editedPieces = {};
                render();
            },
            setModDepth: function(id, v) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) {
                    m.depth = Math.max(20, Math.min(120, v || 50));
                    S.editedPieces = {};
                    render();
                }
            },
            togZoclo: function(id) {
                var m = findMod(id);
                if (m && m.zoclo) { m.zoclo.enabled = !m.zoclo.enabled; S.editedPieces = {}; render(); }
            },
            setZocloH: function(id, h) {
                var m = findMod(id);
                if (m && m.zoclo) { m.zoclo.height = Math.max(5, Math.min(25, h || 15)); S.editedPieces = {}; render(); }
            },
            setModW: function(id, w) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.width = w;
                    S.editedPieces = {};
                    render();
                }
            },
            setModH: function(id, h) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.height = h || 0;
                    S.editedPieces = {};
                    render();
                }
            },
            setModC: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.cajones = n;
                    if (n === 0 && typeof m.shelves !== 'number')
                        m.shelves = 3;
                    S.editedPieces = {};
                    render();
                }
            },
            setModS: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.shelves = n;
                    S.editedPieces = {};
                    render();
                }
            },
            setModCorr: function(id, tier) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.corrTier = tier;
                    S.editedPieces = {};
                    render();
                }
            },
            setModW2: function(id, w) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m.width2 = w; S.editedPieces = {}; render(); }
            },
            setModAventos: function(id, model) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m.aventosModel = model; S.editedPieces = {}; render(); }
            },
            setModShelves: function(id, n) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m.shelves = n; S.editedPieces = {}; render(); }
            },
            togModProp: function(id, prop) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m[prop] = !m[prop]; S.editedPieces = {}; render(); }
            },
            setModProp: function(id, prop, val) {
                var m = S.project.modules.find(function(x) { return x.id === id; });
                if (m) { m[prop] = val; S.editedPieces = {}; render(); }
            },
            togDoor: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.doors = !m.doors;
                    if (!m.doors) {
                        m.tipon = false;
                        m.quoteMode = 'completo';
                    }
                    S.editedPieces = {};
                    render();
                }
            },
            togTipon: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.tipon = !m.tipon;
                    S.editedPieces = {};
                    render();
                }
            },
            // Maletero
            togModMaletero: function(id) {
                var m = findMod(id);
                if (m && m.maletero) { m.maletero.enabled = !m.maletero.enabled; S.editedPieces = {}; render(); }
            },
            setMaleteroH: function(id, h) {
                var m = findMod(id);
                if (m && m.maletero) { m.maletero.height = Math.max(15, Math.min(80, h || 40)); S.editedPieces = {}; render(); }
            },
            // Puertas
            togModPuertas: function(id) {
                var m = findMod(id);
                if (m && m.puertas) {
                    m.puertas.enabled = !m.puertas.enabled;
                    // Bridge to legacy booleans for calc() compat
                    m.doors = m.puertas.enabled;
                    m.tipon = m.puertas.enabled && m.puertas.apertura === 'tipon';
                    S.editedPieces = {};
                    render();
                }
            },
            setModPuertaTipo: function(id, v) {
                var m = findMod(id);
                if (m && m.puertas) { m.puertas.tipo = v; S.editedPieces = {}; render(); }
            },
            setModPuertaCant: function(id, v) {
                var m = findMod(id);
                if (m && m.puertas) { m.puertas.cantidad = Math.max(1, Math.min(4, v || 2)); S.editedPieces = {}; render(); }
            },
            setModPuertaMat: function(id, v) {
                var m = findMod(id);
                if (m && m.puertas) { m.puertas.material = v; S.editedPieces = {}; render(); }
            },
            setModPuertaApert: function(id, v) {
                var m = findMod(id);
                if (m && m.puertas) {
                    m.puertas.apertura = v;
                    // Bridge to legacy tipon boolean
                    m.tipon = v === 'tipon';
                    S.editedPieces = {};
                    render();
                }
            },
            // Enchapado
            togEnchapado: function(id, side) {
                var m = findMod(id);
                if (m && m.enchapado && m.enchapado.hasOwnProperty(side)) {
                    m.enchapado[side] = !m.enchapado[side];
                    S.editedPieces = {};
                    render();
                }
            },
            // Zone unitH
            setZoneUnitH: function(id, zi, h) {
                var m = findMod(id);
                if (!m || !m.zones || !m.zones[zi]) return;
                m.zones[zi].unitH = Math.max(5, Math.min(60, h || 20));
                autoDistributeZones(m.zones, m.height || S.project.defaultHeight || 200);
                S.editedPieces = {};
                render();
            },
            setQuoteMode: function(id, mode) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    m.quoteMode = mode;
                    if (mode === 'solo_puertas') {
                        m.doors = true;
                    }
                    S.editedPieces = {};
                    render();
                }
            },
            // Paint (custom mode)
            togPaint: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    if (!m.paint)
                        m.paint = {
                            enabled: false,
                            name: '',
                            pricePerLiter: 0,
                            coats: 2,
                            scope: 'doors'
                        };
                    m.paint.enabled = !m.paint.enabled;
                    render();
                }
            },
            setPaintName: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.name = v;
                }
            },
            setPaintPrice: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.pricePerLiter = Math.max(0, v || 0);
                    render();
                }
            },
            setPaintCoats: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.coats = Math.max(1, Math.min(5, v || 2));
                    render();
                }
            },
            setPaintScope: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.paint) {
                    m.paint.scope = v;
                    render();
                }
            },
            // Hardware picker
            openHWPicker: function() {
                S.showHWPicker = true;
                S.hwFilter = {
                    marca: '',
                    cat: '',
                    q: ''
                };
                render();
                setTimeout(function() {
                    var i = $('hwSearchInput');
                    if (i)
                        i.focus();
                }, 100);
            },
            closeHWPicker: function(e) {
                if (!e || e.target.classList.contains('hw-picker')) {
                    S.showHWPicker = false;
                    render();
                }
            },
            hwSearch: function(q) {
                S.hwFilter.q = q;
                var listEl = $('hwListContainer');
                if (listEl) {
                    listEl.innerHTML = buildHWListHTML(filterHW(), false);
                } else {
                    render();
                }
            },
            hwFilterMarca: function(m) {
                S.hwFilter.marca = m;
                render();
            },
            hwFilterCat: function(c) {
                S.hwFilter.cat = c;
                render();
            },
            hwCartAdd: function(codigo) {
                var item = getCatalog().find(function(x) {
                    return x.codigo === codigo;
                });
                if (!item)
                    return;
                var hwArr = S.project.hardware;
                hwArr.push({
                    codigo: item.codigo,
                    descripcion: item.descripcion,
                    unidad: item.unidad,
                    precio: item.precio,
                    marca: item.marca,
                    categoria: item.categoria,
                    qty: 1
                });
                // Partial re-render: update only the picker list to avoid close/reopen
                var listEl = $('hwListContainer');
                if (listEl) {
                    listEl.innerHTML = buildHWListHTML(filterHW(), false);
                } else {
                    render();
                }
            },
            hwCartQty: function(codigo, delta) {
                var hwArr = S.project.hardware;
                var idx = hwArr.findIndex(function(x) {
                    return x.codigo === codigo;
                });
                if (idx >= 0) {
                    hwArr[idx].qty += delta;
                    if (hwArr[idx].qty <= 0)
                        hwArr.splice(idx, 1);
                }
                // Partial re-render: update only the picker list to preserve scroll & state
                var listEl = $('hwListContainer');
                if (listEl) {
                    listEl.innerHTML = buildHWListHTML(filterHW(), false);
                } else {
                    render();
                }
            },
            hwQty: function(idx, delta) {
                if (S.project.hardware[idx]) {
                    S.project.hardware[idx].qty += delta;
                    if (S.project.hardware[idx].qty <= 0)
                        S.project.hardware.splice(idx, 1);
                }
                render();
            },
            // LED per-module
            togModLed: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m) {
                    if (!m.led)
                        m.led = {
                            enabled: false,
                            edges: {
                                top: false,
                                bottom: false,
                                left: false,
                                right: false,
                                shelves: false
                            },
                            shelfCount: 0,
                            ledMeters: 0,
                            segments: 0,
                            metersOverride: null,
                            segmentsOverride: null
                        };
                    m.led.enabled = !m.led.enabled;
                    render();
                }
            },
            togLedEdge: function(id, edge) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.edges[edge] = !m.led.edges[edge];
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedShelves: function(id, n) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.shelfCount = Math.max(0, n || 0);
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedMeters: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.metersOverride = Math.max(0, v || 0);
                    render();
                }
            },
            setLedSegments: function(id, v) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.segmentsOverride = Math.max(0, v || 0);
                    render();
                }
            },
            resetLedOverride: function(id) {
                var m = S.project.modules.find(function(x) {
                    return x.id === id;
                });
                if (m && m.led) {
                    m.led.metersOverride = null;
                    m.led.segmentsOverride = null;
                    render();
                }
            },
            setLedActivation: function(type) {
                S.project.ledConfig.activation = type;
                render();
            },
            setLedTemp: function(temp) {
                S.project.ledConfig.lightTemp = temp;
                render();
            },
            setTargetWidth: function(v) {
                S.project.targetWidth = Math.max(0, v || 0);
                render();
            },
            // Extras
            togGlass: function() {
                S.project.glass = !S.project.glass;
                render();
            },
            setGlassM2: function(v) {
                S.project.glassM2 = v || 0;
                render();
            },
            // Step 3
            setLabor: function(v) {
                S.project.laborCost = Math.max(0, v || 0);
                render();
            },
            togFreight: function() {
                S.project.freight = !S.project.freight;
                render();
            },
            togCostBD: function() {
                S.showCostBreakdown = !S.showCostBreakdown;
                render();
            },
            setView: function(v) {
                S.view = v;
                render();
            },
            // Settings
            openSettings: function() {
                S.showSettings = true;
                render();
            },
            closeSettings: function(e) {
                if (!e || e.target.classList.contains('settings-overlay')) {
                    S.showSettings = false;
                    render();
                }
            },
            setMarginPreset: function(p) {
                S.settings.marginPreset = p;
                if (p === 'estandar') {
                    S.settings.marginCarp = CONFIG.pricing.marginCarp;
                    S.settings.marginHwStd = CONFIG.pricing.marginHwStd;
                }
                else if (p === 'conservador') {
                    S.settings.marginCarp = 60;
                    S.settings.marginHwStd = 60;
                }
                render();
            },
            setMarginCarp: function(v) {
                S.settings.marginCarp = Math.max(0, Math.min(90, v || 0));
                S.settings.marginPreset = 'custom';
                render();
            },
            setMarginHwStd: function(v) {
                S.settings.marginHwStd = Math.max(0, Math.min(90, v || 0));
                S.settings.marginPreset = 'custom';
                render();
            },
            setSupplierAdj: function(marca, val) {
                S.settings.supplierAdj[marca] = val || 0;
                render();
            },
            // Brand
            setBrand: function(b) {
                S.brand = b;
                try {
                    localStorage.setItem(CONFIG.storage.prefix + 'brand', b);
                } catch (e) {}
                render();
            },
            // Logo
            uploadLogo: function() {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    var file = e.target.files[0];
                    if (!file)
                        return;
                    var reader = new FileReader();
                    reader.onload = function(ev) {
                        var img = new Image();
                        img.onload = function() {
                            var canvas = document.createElement('canvas');
                            var maxW = 300,
                                scale = Math.min(maxW / img.width, 1);
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            var ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            var b64 = canvas.toDataURL('image/png');
                            S.logoBase64 = b64;
                            try {
                                localStorage.setItem(CONFIG.storage.prefix + 'logo_base64', b64);
                            } catch (e2) {}
                            render();
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                };
                input.click();
            },
            removeLogo: function() {
                S.logoBase64 = null;
                try {
                    localStorage.removeItem(CONFIG.storage.prefix + 'logo_base64');
                } catch (e) {}
                render();
            },
            setQuoteCounter: function(v) {
                S.quoteCounter = Math.max(1, v || 1);
                try {
                    localStorage.setItem(CONFIG.storage.prefix + 'quote_counter', S.quoteCounter);
                } catch (e) {}
                render();
            },
            // PDF
            initPdfData: function() {
                var P = S.project,
                    c = calc(),
                    type = TYPES.find(function(t) {
                        return t.id === P.type;
                    });
                var yr = new Date().getFullYear();
                var qnum = CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
                // Round total price to nearest 500
                var totalPrice = Math.round(c.subtotal / 500) * 500;
                // Build one item per module with proportional price allocation
                var tw = P.modules.reduce(function(a, x) { return a + x.width; }, 0);
                var items = [];
                var priceAllocated = 0;
                P.modules.forEach(function(m, idx) {
                    var mh = (m.height || P.defaultHeight || 200);
                    // Proportional price by width
                    var proportion = tw > 0 ? m.width / tw : 1 / P.modules.length;
                    var mPrice;
                    if (idx === P.modules.length - 1) {
                        mPrice = totalPrice - priceAllocated; // last module gets remainder
                    } else {
                        mPrice = Math.round(totalPrice * proportion / 100) * 100;
                        priceAllocated += mPrice;
                    }
                    // Build description
                    var desc = m.name;
                    var matLine = P.matFrentes.name;
                    if (c.useDual) matLine += ' (frentes) / ' + P.matInterior.name + ' (interior)';
                    desc += '\nMaterial: ' + matLine;
                    if (m.type === 'modulo' && m.zones && m.zones.length > 0) {
                        m.zones.forEach(function(z) {
                            var zt = CLOSET_ZONE_TYPES[z.type];
                            if (zt) desc += '\n' + (zt.n) + (z.qty > 1 ? ' x' + z.qty : '');
                        });
                    } else {
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : 0;
                        if (mcaj > 0) desc += '\n' + mcaj + ' cajones';
                    }
                    if (m.doors) desc += m.tipon ? '\nPuertas con tip-on' : '\nCon puertas';
                    if (m.led && m.led.enabled) desc += '\nIluminacion LED';
                    desc += '\nHerrajes incluidos';
                    desc += '\nInstalacion incluida';
                    items.push({
                        name: m.name,
                        desc: desc,
                        dims: m.width + 'cm x ' + mh + 'cm',
                        price: mPrice,
                        qty: 1
                    });
                });
                S.pdfData = {
                    client: P.client || '',
                    projectName: (type ? type.n : 'Proyecto'),
                    location: '',
                    quoteNum: qnum,
                    deliveryTime: CONFIG.quoting.defaultDelivery,
                    anticipo: CONFIG.quoting.defaultAnticipo,
                    notes: '',
                    items: items
                };
            },
            setPdfField: function(key, val) {
                if (S.pdfData)
                    S.pdfData[key] = val;
            },
            setPdfItemPrice: function(idx, val) {
                if (S.pdfData && S.pdfData.items[idx])
                    S.pdfData.items[idx].price = val || 0;
                render();
            },
            setPdfItemDesc: function(idx, val) {
                if (S.pdfData && S.pdfData.items[idx])
                    S.pdfData.items[idx].desc = val;
            },
            editPiece: function(key, field, val) {
                if (!S.editedPieces[key])
                    S.editedPieces[key] = {};
                S.editedPieces[key][field] = val;
                render();
            },
            resetEdits: function() {
                S.editedPieces = {};
                render();
            },
            genClientPDF: function() {
                genClientPDF();
            },
            genInternalPDF: function() {
                genInternalPDF();
            },
            genDespiece: function() {
                genDespiece();
            },
            genQuickPDF: function(pdfType) {
                var t = TEMPLATES.find(function(x) {
                    return x.id === S.selTemplate;
                });
                if (!t)
                    return;
                var nw = S.quickWidth,
                    nh = S.quickHeight;
                var ratio = (nw * nh) / (t.baseWidth * t.baseHeight);
                var newPrice = Math.round(t.basePrice * ratio / 500) * 500;
                var matName = S.quickMatName || t.matName;
                var yr = new Date().getFullYear();
                var qnum = CONFIG.quoting.prefix + '-' + yr + '-' + String(S.quoteCounter).padStart(4, '0');
                var desc = t.name + '\nMaterial: Melamina ' + matName + ' 16mm\nMedida: ' + (nw / 100) + 'm x ' + (nh / 100) + 'm';
                if (t.preModules) {
                    desc += '\n\nIncluye:';
                    t.preModules.forEach(function(pm) {
                        var mod = MODS[pm.type] || { n: pm.type };
                        desc += '\n- ' + mod.n + ' ' + pm.width + 'cm';
                        if (pm.doors)
                            desc += pm.tipon ? ' con puertas tip-on' : ' con puertas';
                    });
                }
                if (t.hasLed)
                    desc += '\n- Iluminacion LED perimetral completa';
                if (t.hasGlass)
                    desc += '\n- Vidrio templado';
                desc += '\n- Herrajes incluidos\n- Instalacion incluida';
                S.pdfData = {
                    client: '',
                    projectName: t.name,
                    location: '',
                    quoteNum: qnum,
                    deliveryTime: t.weeks + ' semanas',
                    anticipo: CONFIG.quoting.defaultAnticipo,
                    notes: '',
                    items: [{
                        desc: desc,
                        dims: (nw / 100) + 'm x ' + (nh / 100) + 'm',
                        price: newPrice
                    }]
                };
                if (pdfType === 'client') {
                    genClientPDF();
                    return;
                }
                // For internal/despiece PDF, populate S.project from template so calc() works
                var savedProject = JSON.parse(JSON.stringify(S.project));
                try {
                    var widthRatio = nw / t.baseWidth;
                    var mat = {
                        brand: 'FINSA',
                        code: t.matCode || '74V',
                        name: matName,
                        finish: t.matFinish || 'Atlas',
                        precio: FINSA_PRICES[16],
                        thickness: 16
                    };
                    S.project.type = t.type || 'tv';
                    S.project.sameMaterial = true;
                    S.project.matFrentes = mat;
                    S.project.matInterior = mat;
                    S.project.defaultHeight = Math.round(nh / 10) * 10 || 200;
                    S.project.defaultDepth = 50;
                    S.project.laborCost = Math.round((t.laborCost || 5000) * ratio);
                    S.project.ledConfig = {
                        activation: 'dimmer',
                        lightTemp: 'calida'
                    };
                    S.project.glass = !!t.hasGlass;
                    S.project.glassM2 = t.hasGlass ? Math.round((nw / 100) * (nh / 100) * 0.3 * 10) / 10 : 0;
                    S.project.hardware = [];
                    S.project.modules = [];
                    if (t.preModules) {
                        t.preModules.forEach(function(pm) {
                            var scaledW = Math.round(pm.width * widthRatio / 10) * 10;
                            if (scaledW < 30)
                                scaledW = 30;
                            if (scaledW > 300)
                                scaledW = 300;
                            var ledObj = {
                                enabled: false,
                                edges: {
                                    top: false,
                                    bottom: false,
                                    left: false,
                                    right: false,
                                    shelves: false
                                },
                                shelfCount: 0,
                                ledMeters: 0,
                                segments: 0,
                                metersOverride: null,
                                segmentsOverride: null
                            };
                            if (t.hasLed) {
                                ledObj.enabled = true;
                                ledObj.edges.top = true;
                            }
                            S.project.modules.push({
                                id: uid(),
                                type: pm.type,
                                name: (MODS[pm.type] || { n: pm.type }).n,
                                width: scaledW,
                                cajones: pm.cajones || 4,
                                doors: !!pm.doors,
                                tipon: !!pm.tipon,
                                shelves: pm.shelves || 3,
                                corrTier: pm.corrTier || 'corr_eco',
                                led: ledObj
                            });
                        });
                    }
                    if (pdfType === 'despiece')
                        genDespiece();
                    else
                        genInternalPDF();
                } catch (e) {
                    alert('Error generando PDF: ' + e.message);
                }
                S.project = savedProject;
            },
            // Copy
            copy: function() {
                var P = S.project,
                    c = calc(),
                    type = TYPES.find(function(t) {
                        return t.id === P.type;
                    }),
                    br = BRANDS[S.brand] || BRANDS.primary,
                    txt = '';
                if (S.view === 'quote') {
                    txt = br.name + '\n' + br.tagline + '\n\n';
                    txt += 'Fecha: ' + date() + '\nCliente: ' + (P.client || 'Sin nombre') + '\nProyecto: ' + (type ? type.n : '') + '\n\n';
                    txt += 'MODULOS:\n';
                    P.modules.forEach(function(m, i) {
                        var mcaj = typeof m.cajones === 'number' ? m.cajones : (m.type === 'modulo' ? 4 : 0);
                        var extra = mcaj > 0 ? ' (' + mcaj + ' cajones)' : (m.type === 'modulo' ? ' (' + (typeof m.shelves === 'number' ? m.shelves : 3) + ' entrepaos)' : '');
                        txt += (i + 1) + '. ' + m.name + ' ' + m.width + 'cm' + (m.height ? ' x ' + m.height + 'cm' : '') + extra + (m.doors ? ' con puertas' : '') + '\n';
                    });
                    txt += '\nMaterial: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '\n';
                    if (c.ledBOM || P.glass) {
                        txt += '\nExtras:\n';
                        if (c.ledBOM)
                            txt += '- Iluminacion LED perimetral completa\n';
                        if (P.glass)
                            txt += '- Vidrio templado\n';
                    }
                    txt += '\nSubtotal: ' + fmt(c.subtotal) + '\nIVA ' + Math.round(CONFIG.pricing.iva * 100) + '%: ' + fmt(c.iva) + '\nTOTAL: ' + fmt(c.total) + '\n\n';
                    txt += CONFIG.quoting.defaultAnticipo + '% anticipo | Entrega ' + CONFIG.quoting.defaultDelivery + '\nIncluye instalacion\n\n' + CONTACT.cell + '\n' + CONTACT.email;
                } else {
                    txt = 'DESPIECE - ' + (BRANDS[S.brand] || BRANDS.primary).name + '\n\nFecha: ' + date() + '\nCliente: ' + (P.client || 'Sin nombre') + '\nMaterial: ' + P.matFrentes.brand + ' ' + P.matFrentes.name + '\n';
                    if (P.chapSpec)
                        txt += 'Chapacanto: ' + P.chapSpec + '\n';
                    txt += '\nHojas: ' + c.totalSheets + ' | Canto: ' + c.totalCanto + ' ml\n\n';
                    P.modules.forEach(function(m) {
                        var pcs = c.pieces.filter(function(p) {
                            return p.mid === m.id;
                        });
                        pcs.sort(function(a, b) {
                            var alA = anchoLargo(a.w, a.h),
                                alB = anchoLargo(b.w, b.h);
                            return alB.largo - alA.largo;
                        });
                        var mHdr = m.name + ' ' + m.width + 'cm';
                        if (m.height)
                            mHdr += ' x ' + m.height + 'cm';
                        txt += mHdr + '\n';
                        pcs.forEach(function(p) {
                            var al = anchoLargo(p.w, p.h);
                            var eKey = m.id + ':' + p.n;
                            var ep = S.editedPieces[eKey] || {};
                            var eq = typeof ep.q === 'number' ? ep.q : p.q;
                            var ea = typeof ep.ancho === 'number' ? ep.ancho : al.ancho;
                            var el2 = typeof ep.largo === 'number' ? ep.largo : al.largo;
                            txt += '  ' + p.n + ': ' + eq + 'x  Ancho:' + ea + ' Largo:' + el2 + 'mm (' + p.t + 'mm)\n';
                        });
                        txt += '\n';
                    });
                    txt += 'HERRAJES:\n';
                    c.allHW.forEach(function(hw) {
                        txt += '- ' + hw.desc + ': ' + Math.ceil(hw.qty) + ' (' + hw.marca + ')\n';
                    });
                }
                navigator.clipboard.writeText(txt).then(function() {
                    S.copied = true;
                    render();
                    setTimeout(function() {
                        S.copied = false;
                        render();
                    }, 2000);
                });
            },
            // Saved Projects
            saveProject: function(silent) {
                var P = S.project;
                var saved = loadSavedProjects();
                var clone = JSON.parse(JSON.stringify(P));
                delete clone._saveId;
                var entry = {
                    id: P._saveId || uid(),
                    savedAt: new Date().toISOString(),
                    client: P.client || 'Sin nombre',
                    label: 'Proyecto - ' + P.modules.length + ' m\u00f3dulo' + (P.modules.length !== 1 ? 's' : ''),
                    moduleCount: P.modules.length,
                    project: clone
                };
                P._saveId = entry.id;
                // Update local list
                var existIdx = -1;
                for (var i = 0; i < saved.length; i++) {
                    if (saved[i].id === entry.id) {
                        existIdx = i;
                        break;
                    }
                }
                if (existIdx >= 0) {
                    saved[existIdx] = entry;
                } else {
                    saved.unshift(entry);
                }
                if (saved.length > 20)
                    saved = saved.slice(0, 20);
                saveSavedProjects(saved);
                // Sync to cloud
                cloudSaveProject(entry);
                if (!silent)
                    alert('Proyecto guardado en la nube');
            },
            loadSavedProject: function(idx) {
                var saved = loadSavedProjects();
                if (!saved[idx])
                    return;
                var proj = JSON.parse(JSON.stringify(saved[idx].project));
                proj._saveId = saved[idx].id;
                S.project = proj;
                S.screen = 'project';
                S.step = 1;
                S.pdfData = null;
                scrollY = 0;
                render();
            },
            deleteSavedProject: function(idx) {
                var saved = loadSavedProjects();
                if (!saved[idx])
                    return;
                if (!confirm('\u00bfEliminar proyecto "' + saved[idx].client + '"?'))
                    return;
                var deletedId = saved[idx].id;
                saved.splice(idx, 1);
                saveSavedProjects(saved);
                cloudDeleteProject(deletedId);
                render();
            },
            // APP_CONFIG API  multi-tenant setup
            hasAppConfig:      function() { return hasAppConfig(); },
            saveAppConfig:     function(data) { return saveAppConfig(data); },
            loadAppConfig:     function() { return loadAppConfig(); },
            // License API
            generateLicenseKey: function(client, expDate) { return generateLicenseKey(client, expDate); },
            validateLicense:    function() { return validateLicense(); },
            showLicenseInfo:    function() { showLicenseInfo(); },
            toggleTheme: function() {
                S.darkMode = !S.darkMode;
                document.body.classList.toggle('light', !S.darkMode);
                try { localStorage.setItem('cot_darkMode', S.darkMode); } catch(e) {}
                render();
            },
            selectMod: function(id) {
                S.selectedModId = S.selectedModId === id ? null : id;
                render();
            },
            setModCatTab: function(tab) {
                S.modCatTab = tab;
                render();
            },
            togLedPanel: function(id) {
                S.ledPanelOpen[id] = !S.ledPanelOpen[id];
                render();
            },
            togPaintPanel: function(id) {
                S.paintPanelOpen[id] = !S.paintPanelOpen[id];
                render();
            }
        };

        // First-run check: show setup screen if no APP_CONFIG exists yet
        if (!hasAppConfig()) {
            showSetupScreen();
            return; // Do not render main app until setup is complete
        }

        // License check: only enforce if a licenseKey was provided
        var licResult = validateLicense();
        if (licResult.reason !== 'no_key' && !licResult.valid) {
            showLockScreen(licResult.reason, licResult);
            return;
        }

        render();

        // Dynamic title and favicon from CONFIG
        document.title = CONFIG.brand.name + ' - Cotizador';
        try {
            var fav = document.getElementById('dynamic-favicon');
            if (fav) fav.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text x='50' y='65' font-size='" + (CONFIG.brand.mono.length > 3 ? '30' : '40') + "' text-anchor='middle' fill='%23c49a6c'>" + encodeURIComponent(CONFIG.brand.mono) + "</text></svg>";
        } catch (e) {}

        // PWA: Inline manifest
        try {
            var manifest = {
                name: CONFIG.brand.name + ' Cotizador',
                short_name: CONFIG.brand.mono + ' Cotizador',
                start_url: window.location.href,
                display: 'standalone',
                background_color: '#1a1a2e',
                theme_color: '#c49a6c',
                icons: [{
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231a1a2e'/><text x='50' y='65' font-size='" + (CONFIG.brand.mono.length > 3 ? '30' : '40') + "' text-anchor='middle' fill='%23c49a6c'>" + encodeURIComponent(CONFIG.brand.mono) + "</text></svg>",
                    sizes: '192x192',
                    type: 'image/svg+xml'
                }]
            };
            var mBlob = new Blob([JSON.stringify(manifest)], {
                type: 'application/json'
            });
            var mLink = document.createElement('link');
            mLink.rel = 'manifest';
            mLink.href = URL.createObjectURL(mBlob);
            document.head.appendChild(mLink);
        } catch (e) {}

        // PWA: Service Worker
        if ('serviceWorker' in navigator) {
            try {
                var swCode = "var CACHE='" + CONFIG.pwa.cacheName + "';self.addEventListener('install',function(e){self.skipWaiting();e.waitUntil(caches.open(CACHE).then(function(c){return c.addAll([self.location.origin+self.location.pathname])}))});self.addEventListener('activate',function(e){e.waitUntil(caches.keys().then(function(ks){return Promise.all(ks.filter(function(k){return k!==CACHE}).map(function(k){return caches.delete(k)}))}));self.clients.claim()});self.addEventListener('fetch',function(e){e.respondWith(fetch(e.request).catch(function(){return caches.match(e.request)}))});";
                var swBlob = new Blob([swCode], {
                    type: 'application/javascript'
                });
                navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(function() {});
            } catch (e) {}
        }
    })();
    </script>
</body>
</html>
